<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<title>SATURNO MOVEMENT STUDIO - The Ableton of Movement</title>
<meta name="description" content="The Ableton of Movement. DAW-style workout composition with drag-drop exercises, BPM training modes, and music sync.">
<meta property="og:title" content="Saturno Movement Studio">
<meta property="og:description" content="The Ableton of Movement. Compose workouts like music.">
<meta property="og:type" content="website">
<link rel="icon" href="assets/planet-logo.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* SATURNO FORGE DESIGN LOCK V1.0 — Ableton of Movement */
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #050711;
  --surface: #0a0e1a;
  --surface2: #0d1117;
  --border: #2a3148;
  --border-hover: #ffffff;
  --text: #ffffff;
  --text-secondary: #8b94a5;
  --muted: #6b7280;
  --micro: #4a5568;
  --accent: #d97706;
  --accent-dim: rgba(217, 119, 6, 0.15);
  --blue: #3b82f6;
  --purple: #8b5cf6;
  --success: #22c55e;
  --error: #ef4444;
  --accent-cyan: #06b6d4;
  --accent-blue: #3b82f6;
  --accent-purple: #8b5cf6;
  --accent-green: #22c55e;
  --accent-orange: #f97316;
  --accent-red: #ef4444;
  --accent-pink: #ec4899;
  --gradient-titan: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #6d28d9 100%);
  --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-purple: 0 0 20px rgba(139, 92, 246, 0.3);
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
}

/* Layout */
.app { display: grid; grid-template-rows: auto 1fr 32px; height: 100vh; }

/* ===== HEADER ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(90deg, var(--surface) 0%, rgba(59, 130, 246, 0.04) 50%, rgba(139, 92, 246, 0.04) 100%);
}
.logo { display: flex; align-items: center; gap: 10px; }
.logo-icon {
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--border);
}
.logo-icon img { width: 18px; height: 18px; filter: brightness(0) invert(1); }
.logo-text {
  font-size: 12px; font-weight: 700; font-style: italic;
  letter-spacing: -0.02em;
}
.logo-sub {
  font-size: 9px; color: var(--micro); margin-top: 1px;
  text-transform: uppercase; letter-spacing: 0.15em;
}
.header-nav { display: flex; gap: 4px; align-items: center; }
.nav-btn {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 6px 12px; font-size: 9px; font-family: 'Sora', sans-serif;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text-secondary); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.1em;
  transition: border-color 0.15s, color 0.15s, background 0.15s;
}
.nav-btn:hover { background: var(--surface2); border-color: var(--border-hover); color: var(--text); }
.nav-btn.active {
  background: var(--gradient-titan); border-color: var(--blue);
  color: #fff; font-weight: 600;
}

/* ===== MAIN 3-PANEL ===== */
.main { display: grid; grid-template-columns: 220px 1fr 280px; overflow: hidden; }

/* ===== LEFT PANEL: MOVEMENT LIBRARY ===== */
.panel-left {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
}
.panel-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--text-secondary);
  display: flex; justify-content: space-between; align-items: center;
}
.lib-search {
  width: calc(100% - 24px); margin: 10px 12px;
  padding: 8px 10px; font-size: 11px; font-family: 'Sora', sans-serif;
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  transition: border-color 0.15s;
}
.lib-search:focus { outline: none; border-color: var(--border-hover); }
.lib-search::placeholder { color: var(--muted); }
.movement-category { border-bottom: 1px solid var(--border); }
.category-header {
  padding: 10px 16px; font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.15s, color 0.15s;
}
.category-header:hover { background: var(--surface2); color: var(--text); }
.category-header .arrow { font-size: 8px; transition: transform 0.2s; color: var(--muted); }
.category-header.collapsed .arrow { transform: rotate(-90deg); }
.category-color { width: 8px; height: 8px; }
.movement-list { padding: 4px 8px 8px; }
.movement-list.hidden { display: none; }
.movement-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px; margin-bottom: 4px;
  font-size: 11px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-left: 2px solid var(--border);
  cursor: grab;
  transition: border-color 0.15s, background 0.15s;
}
.movement-item:hover {
  border-left-color: var(--border-hover);
  background: var(--surface2);
}
.movement-item:active { cursor: grabbing; }
.movement-item .mv-icon {
  width: 22px; height: 22px;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; font-weight: 700; flex-shrink: 0;
}
.movement-item .mv-stage {
  font-size: 8px; color: var(--muted); margin-left: auto;
  text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== CENTER PANEL ===== */
.panel-center { display: flex; flex-direction: column; overflow: hidden; }

/* Transport Bar */
.transport {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 16px;
  background: linear-gradient(180deg, var(--surface2) 0%, var(--surface) 100%);
  border-bottom: 1px solid var(--border);
}
.transport-buttons { display: flex; gap: 2px; }
.transport-btn {
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg); border: 1px solid var(--border);
  color: var(--text-secondary); cursor: pointer; font-size: 13px;
  font-family: 'Sora', sans-serif;
  transition: border-color 0.15s, color 0.15s, background 0.15s;
}
.transport-btn:hover { border-color: var(--blue); color: var(--text); }
.transport-btn.active { background: var(--gradient-titan); border-color: var(--blue); color: #fff; }
.transport-btn.rec.active { background: var(--accent-red); border-color: var(--accent-red); color: #fff; }
.time-display {
  font-family: 'Sora', sans-serif;
  font-size: 18px; font-weight: 700;
  color: var(--text); padding: 0 12px;
  letter-spacing: 0.05em;
  font-variant-numeric: tabular-nums;
  min-width: 120px;
}
.bpm-section { display: flex; align-items: center; gap: 6px; margin-left: auto; }
.bpm-label {
  font-size: 9px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.bpm-input {
  width: 50px; padding: 5px 8px; text-align: center;
  font-size: 12px; font-family: 'Sora', sans-serif;
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  transition: border-color 0.15s;
}
.bpm-input:focus { outline: none; border-color: var(--border-hover); }
.bpm-mode {
  font-size: 9px; padding: 4px 10px;
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--blue);
  text-transform: uppercase; letter-spacing: 0.1em;
  font-family: 'Sora', sans-serif;
}
.tempo-link {
  font-size: 9px; color: var(--accent-orange); cursor: pointer;
  padding: 4px 8px; border: 1px solid transparent;
  text-transform: uppercase; letter-spacing: 0.1em;
  transition: border-color 0.15s, background 0.15s;
}
.tempo-link:hover { border-color: var(--accent-orange); }
.tempo-link.active { background: rgba(249,115,22,0.15); border-color: var(--accent-orange); }

/* Video Section */
.video-section {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  position: relative; min-height: 0; flex-shrink: 1; overflow: hidden;
}
.video-section.collapsed { height: 0; min-height: 0; border: none; }
.video-placeholder {
  display: flex; align-items: center; justify-content: center;
  height: 100%; min-height: 140px;
  color: var(--muted); font-size: 11px;
  flex-direction: column; gap: 8px;
  text-transform: uppercase; letter-spacing: 0.1em;
  border: 1px dashed var(--border);
  margin: 8px;
}
.video-placeholder .vp-icon { font-size: 24px; opacity: 0.3; }
.video-toggle {
  position: absolute; top: 6px; right: 6px;
  width: 20px; height: 20px;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  transition: border-color 0.15s, color 0.15s;
}
.video-toggle:hover { border-color: var(--blue); color: var(--text); }

/* Timeline */
.timeline-container { flex: 1; overflow: auto; background: var(--bg); }
.timeline-ruler {
  height: 24px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  display: flex; position: sticky; top: 0; z-index: 10;
}
.ruler-mark {
  flex: 0 0 80px;
  border-right: 1px solid var(--border);
  padding: 4px 8px; font-size: 9px;
  color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.ruler-mark:first-child { flex: 0 0 100px; }
.timeline-tracks { min-height: 200px; position: relative; }
.track {
  height: 64px;
  border-bottom: 1px solid var(--border);
  display: flex;
  background: var(--bg);
  border-left: 3px solid var(--blue);
  transition: background 0.15s;
}
.track:hover { background: var(--surface); }
.track:nth-child(3) { border-left-color: var(--accent-purple); }
.track:nth-child(4) { border-left-color: var(--accent-orange); }
.track:nth-child(5) { border-left-color: var(--accent-green); }
.track:nth-child(6) { border-left-color: var(--accent-cyan); }
.track:first-child { border-left-color: var(--accent-cyan); }
.track-header {
  width: 100px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 8px 10px;
  display: flex; flex-direction: column; justify-content: center;
  flex-shrink: 0;
}
.track-name {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
}
.track-info {
  font-size: 8px; color: var(--muted); margin-top: 2px;
  text-transform: uppercase; letter-spacing: 0.1em;
}
.track-controls { display: flex; gap: 2px; margin-top: 4px; }
.track-btn {
  width: 20px; height: 16px; font-size: 8px;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: border-color 0.15s, color 0.15s;
}
.track-btn:hover { border-color: var(--blue); color: var(--text); }
.track-btn.muted { background: var(--accent-orange); color: var(--bg); border-color: var(--accent-orange); }
.track-btn.soloed { background: var(--accent-cyan); color: var(--bg); border-color: var(--accent-cyan); }
.track-content {
  flex: 1; position: relative; min-width: 800px;
  background: repeating-linear-gradient(
    90deg,
    transparent 0px, transparent 59px,
    var(--border) 59px, var(--border) 60px
  );
}
.track-content.drag-over {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
}

/* Clips — Ableton-style blocks with top accent */
.clip {
  position: absolute; height: 48px; top: 8px;
  border: 1px solid rgba(255,255,255,0.1);
  border-top: 3px solid;
  cursor: move; display: flex; align-items: center;
  padding: 0 8px; font-size: 10px; font-weight: 600;
  user-select: none; overflow: hidden; white-space: nowrap;
  transition: opacity 0.15s;
}
.clip::after {
  content: '';
  position: absolute; bottom: 4px; left: 8px; right: 8px;
  height: 14px;
  background: repeating-linear-gradient(
    90deg,
    currentColor 0px, currentColor 2px,
    transparent 2px, transparent 6px
  );
  opacity: 0.15;
}
.clip:hover {
  box-shadow: var(--glow-blue);
}
.clip.selected {
  border-color: var(--accent-purple);
  border-top-color: var(--accent-purple);
  box-shadow: var(--glow-purple);
}
.clip .clip-info {
  font-size: 8px; opacity: 0.6; margin-left: 6px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.clip-resize {
  position: absolute; right: 0; top: 0; bottom: 0;
  width: 6px; cursor: ew-resize;
  background: rgba(255,255,255,0.08);
  opacity: 0; transition: opacity 0.15s;
}
.clip:hover .clip-resize { opacity: 1; }
.clip-resize:hover { background: var(--blue); }
.playhead {
  position: absolute; top: 0; bottom: 0;
  width: 2px; background: var(--blue);
  box-shadow: var(--glow-blue);
  z-index: 20; pointer-events: none; left: 100px;
}
.playhead::before {
  content: '';
  position: absolute; top: -4px; left: -4px;
  width: 10px; height: 10px;
  background: var(--blue);
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}

/* ===== RIGHT PANEL: MIXER + INSPECTOR ===== */
.panel-right {
  background: var(--surface);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
}
.mixer-section {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}
.mixer-title {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--text-secondary); margin-bottom: 12px;
}

/* Faders */
.fader-group { display: flex; gap: 12px; justify-content: center; }
.fader { display: flex; flex-direction: column; align-items: center; gap: 6px; }
.fader-label {
  font-size: 8px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted);
  text-align: center; max-width: 40px;
}
.fader-track {
  width: 8px; height: 80px;
  background: var(--surface2); border: 1px solid var(--border);
  position: relative; cursor: pointer;
}
.fader-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--gradient-titan);
  transition: height 0.1s;
}
.fader-handle {
  position: absolute; left: -4px; right: -4px;
  height: 10px;
  background: var(--text); border: 1px solid var(--border);
  cursor: grab;
  transition: background 0.15s;
}
.fader-handle:hover { background: var(--blue); }
.fader-value {
  font-size: 10px; font-family: 'Sora', sans-serif;
  color: var(--text-secondary); font-weight: 500;
  font-variant-numeric: tabular-nums;
}

/* Knobs */
.knob-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.knob { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.knob-dial {
  width: 36px; height: 36px;
  background: conic-gradient(
    from 225deg,
    var(--blue) 0deg,
    var(--accent-purple) calc(var(--knob-value, 0.5) * 270deg),
    var(--surface2) calc(var(--knob-value, 0.5) * 270deg),
    var(--surface2) 270deg
  );
  border: 2px solid var(--border);
  border-radius: 50%; position: relative; cursor: pointer;
  transition: border-color 0.15s;
}
.knob-dial:hover { border-color: var(--blue); box-shadow: var(--glow-blue); }
.knob-dial::before {
  content: '';
  position: absolute; top: 50%; left: 50%;
  width: 24px; height: 24px;
  background: var(--bg); border-radius: 50%;
  transform: translate(-50%, -50%);
}
.knob-indicator {
  position: absolute; width: 2px; height: 10px;
  background: var(--text); top: 3px; left: 50%;
  transform-origin: bottom center; transform: translateX(-50%);
}
.knob-label {
  font-size: 8px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted); text-align: center;
}
.knob-value {
  font-size: 9px; color: var(--blue);
  font-variant-numeric: tabular-nums;
}

/* Meters */
.meter-group {
  display: flex; gap: 2px; justify-content: center;
  height: 60px; align-items: flex-end;
}
.meter-bar {
  width: 4px; background: var(--accent-green);
  transition: height 0.1s;
}

/* Inspector */
.inspector-section {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--blue);
}
.inspector-title {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--blue); margin-bottom: 10px;
}
.inspector-field { margin-bottom: 8px; }
.inspector-field label {
  display: block; font-size: 9px;
  color: var(--muted); text-transform: uppercase;
  letter-spacing: 0.2em; margin-bottom: 4px;
}
.inspector-field .value { font-size: 12px; color: var(--text); }
.inspector-field input, .inspector-field select {
  width: 100%; padding: 6px 8px;
  font-size: 11px; font-family: 'Sora', sans-serif;
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  transition: border-color 0.15s;
}
.inspector-field input:focus, .inspector-field select:focus {
  outline: none; border-color: var(--border-hover);
}
.inspector-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.inspector-tag {
  font-size: 9px; padding: 2px 8px;
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 0.1em;
}

/* Music Player */
.music-section {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--accent-green);
}
.music-now-playing {
  font-size: 11px; color: var(--text-secondary);
  margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
}
.music-now-playing .eq { display: flex; gap: 1px; align-items: flex-end; height: 12px; }
.music-now-playing .eq span { width: 2px; background: var(--accent-green); animation: eqBounce 0.8s ease-in-out infinite alternate; }
.music-now-playing .eq span:nth-child(2) { animation-delay: 0.2s; }
.music-now-playing .eq span:nth-child(3) { animation-delay: 0.4s; }
@keyframes eqBounce { 0% { height: 3px; } 100% { height: 12px; } }
.music-controls { display: flex; gap: 4px; align-items: center; }
.music-btn {
  width: 30px; height: 30px;
  background: var(--bg); border: 1px solid var(--border);
  color: var(--text-secondary); cursor: pointer; font-size: 11px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Sora', sans-serif;
  transition: border-color 0.15s, color 0.15s;
}
.music-btn:hover { border-color: var(--accent-green); color: var(--text); }
.music-btn.playing { background: var(--accent-green); color: var(--bg); border-color: var(--accent-green); }
.music-volume {
  width: 60px; height: 3px;
  -webkit-appearance: none; appearance: none;
  background: var(--border); outline: none; cursor: pointer;
}
.music-volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 10px; height: 10px;
  background: var(--accent-green); border-radius: 50%; cursor: pointer;
}

/* Export Button */
.export-btn {
  padding: 8px 16px;
  background: var(--gradient-titan); border: 1px solid var(--blue);
  color: #fff; font-family: 'Sora', sans-serif;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  cursor: pointer; width: 100%;
  transition: box-shadow 0.15s;
}
.export-btn:hover { box-shadow: var(--glow-blue); }

/* ===== FOOTER ===== */
.footer {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 0 20px;
  display: flex; align-items: center; justify-content: space-between;
  font-size: 9px; color: var(--muted);
  letter-spacing: 0.05em;
}
.status-item { display: flex; align-items: center; gap: 5px; }
.status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent-green); }
.footer-quote { font-style: italic; opacity: 0.5; letter-spacing: 0.1em; }

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: 48px; right: 24px;
  background: var(--surface); border: 1px solid var(--border);
  border-left: 2px solid var(--blue);
  color: var(--text); padding: 10px 16px;
  font-size: 11px; z-index: 200;
  text-transform: uppercase; letter-spacing: 0.1em;
  opacity: 0; transition: opacity 0.3s;
  pointer-events: none; font-family: 'Sora', sans-serif;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}
.toast.show { opacity: 1; }
@media(prefers-reduced-motion:reduce) {
  .music-now-playing .eq span { animation: none; height: 6px; }
  .preset-card:hover { transform: none; }
}

/* ===== TABLET (768px) ===== */
@media(max-width:768px) {
  .main { grid-template-columns: 180px 1fr 220px; }
  .panel-header { font-size: 9px; padding: 10px 12px; }
  .movement-item { padding: 6px 8px; font-size: 10px; }
  .transport { padding: 6px 12px; gap: 6px; flex-wrap: wrap; }
  .time-display { font-size: 16px; min-width: 100px; }
  .bpm-input { width: 46px; font-size: 12px; }
  .fader-track { height: 60px; }
  .knob-dial { width: 30px; height: 30px; }
  .knob-indicator { height: 8px; }
  .preset-card { min-width: 140px; }
}

/* ===== MOBILE (480px) ===== */
@media(max-width:480px) {
  .main { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .panel-left { max-height: 200px; border-right: none; border-bottom: 1px solid var(--border); }
  .panel-right { border-left: none; border-top: 1px solid var(--border); max-height: 260px; }
  .header { padding: 0 10px; }
  .header-nav { gap: 3px; }
  .nav-btn { padding: 5px 8px; font-size: 8px; min-height: 36px; }
  .logo-text { font-size: 11px; }
  .transport-btn { width: 36px; height: 36px; font-size: 14px; min-height: 44px; }
  .music-btn { width: 36px; height: 36px; min-height: 44px; }
  .track-header { width: 80px; }
  .fader-group { gap: 8px; }
  .fader-track { height: 50px; }
  .preset-card { min-width: 120px; padding: 10px; }
  .presets-drawer { padding: 8px 12px; }
}

/* ===== SAVED WORKOUTS MODAL ===== */
.saved-modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(5, 7, 17, 0.85); align-items: center; justify-content: center;
}
.saved-modal.open { display: flex; }
.saved-modal-content {
  background: var(--surface); border: 1px solid var(--border);
  width: 90%; max-width: 420px; max-height: 70vh; overflow-y: auto;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}
.saved-modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px; border-bottom: 1px solid var(--border);
}
.saved-modal-header h3 {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
}
.saved-modal-close {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 14px;
  width: 28px; height: 28px;
  display: flex; align-items: center; justify-content: center;
  transition: border-color 0.15s, color 0.15s;
}
.saved-modal-close:hover { border-color: var(--border-hover); color: var(--text); }
.saved-item {
  padding: 12px 16px; cursor: pointer;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid transparent;
  transition: border-color 0.15s, background 0.15s;
}
.saved-item:hover {
  border-left-color: var(--blue);
  background: var(--surface2);
}
.saved-item-name { font-size: 12px; font-weight: 600; }
.saved-item-info {
  font-size: 9px; color: var(--muted); margin-top: 4px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.saved-item-delete {
  float: right; font-size: 9px; color: var(--accent-red);
  cursor: pointer; padding: 3px 8px;
  border: 1px solid transparent;
  text-transform: uppercase; letter-spacing: 0.1em;
  transition: border-color 0.15s;
}
.saved-item-delete:hover { border-color: var(--accent-red); }
.saved-empty {
  text-align: center; padding: 32px; color: var(--muted);
  font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== PRESETS DRAWER ===== */
.presets-drawer {
  display: none; position: absolute; top: 52px; left: 0; right: 0;
  background: var(--surface);
  border-bottom: 1px solid var(--blue);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
  z-index: 50; padding: 16px 24px;
}
.presets-drawer.open { display: flex; gap: 12px; flex-wrap: wrap; }
.preset-card {
  flex: 1; min-width: 160px; max-width: 220px;
  padding: 14px;
  background: var(--bg); border: 1px solid var(--border);
  border-left: 2px solid var(--border);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
}
.preset-card:hover {
  border-left-color: var(--blue);
  background: var(--surface2);
  box-shadow: var(--glow-blue);
}
.preset-card .pc-name {
  font-size: 12px; font-weight: 600; margin-bottom: 4px;
}
.preset-card .pc-bpm {
  font-size: 10px; color: var(--blue);
  font-variant-numeric: tabular-nums;
}
.preset-card .pc-desc {
  font-size: 9px; color: var(--muted); margin-top: 6px;
  line-height: 1.4;
}
.preset-card .pc-mode {
  font-size: 8px; padding: 2px 8px;
  display: inline-block; margin-top: 8px;
  text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

/* ===== FOCUS / SELECTION ===== */
a:focus-visible, button:focus-visible, input:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.6);
  outline-offset: 2px;
}
::selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
::-moz-selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon"><img src="assets/planet-logo.png" alt="" onerror="this.style.display='none'"></div>
      <div>
        <div class="logo-text">SATURNO MOVEMENT STUDIO</div>
        <div class="logo-sub">The Ableton of Movement</div>
      </div>
    </div>
    <nav class="header-nav">
      <button class="nav-btn" id="btn-presets" onclick="togglePresets()">PRESETS</button>
      <button class="nav-btn" onclick="clearTimeline()">CLEAR</button>
      <button class="nav-btn" onclick="saveNamedWorkout()">SAVE AS</button>
      <button class="nav-btn" onclick="showSavedWorkouts()">LOAD</button>
      <button class="nav-btn" onclick="exportWorkout()">EXPORT</button>
      <button class="nav-btn" id="btn-snap" onclick="toggleSnap()">SNAP</button>
      <button class="nav-btn" id="btn-video" onclick="toggleVideo()">VIDEO</button>
      <button class="nav-btn" onclick="toggleMusic()">MUSIC</button>
    </nav>
  </header>

  <!-- PRESETS DRAWER -->
  <div class="presets-drawer" id="presets-drawer">
    <div class="preset-card" onclick="loadPreset('monk')">
      <div class="pc-name">Monk Mode</div>
      <div class="pc-bpm">65 BPM</div>
      <div class="pc-desc">Meditative, slow, precise. Breath-led reps.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('beast')">
      <div class="pc-name">Beast Mode</div>
      <div class="pc-bpm">140 BPM</div>
      <div class="pc-desc">High intensity, explosive power.</div>
      <div class="pc-mode" style="background:rgba(239,68,68,0.2);color:#ef4444">Flow / Conditioning</div>
    </div>
    <div class="preset-card" onclick="loadPreset('flow')">
      <div class="pc-name">Flow Ritual</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Continuous movement, fluid transitions.</div>
      <div class="pc-mode" style="background:rgba(139,92,246,0.2);color:#8b5cf6">Standard Tempo</div>
    </div>
    <div class="preset-card" onclick="loadPreset('skill')">
      <div class="pc-name">Skill Ascension</div>
      <div class="pc-bpm">75 BPM</div>
      <div class="pc-desc">Technical practice, isometric holds.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('upper')">
      <div class="pc-name">Upper Day</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Push/Pull balanced upper body split.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('lower')">
      <div class="pc-name">Lower Day</div>
      <div class="pc-bpm">90 BPM</div>
      <div class="pc-desc">Squat patterns, hip hinges, mobility.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('ppl')">
      <div class="pc-name">Push / Pull / Legs</div>
      <div class="pc-bpm">110 BPM</div>
      <div class="pc-desc">Classic 3-way split, all patterns hit.</div>
      <div class="pc-mode" style="background:rgba(249,115,22,0.2);color:#f97316">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('fullbody')">
      <div class="pc-name">Full Body</div>
      <div class="pc-bpm">105 BPM</div>
      <div class="pc-desc">One compound per pattern, total coverage.</div>
      <div class="pc-mode" style="background:rgba(236,72,153,0.2);color:#ec4899">Standard</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Movement Library -->
    <aside class="panel-left">
      <div class="panel-header"><span>Movement Library</span><span id="lib-count">0</span></div>
      <input type="text" class="lib-search" id="lib-search" placeholder="Search movements..." oninput="filterLibrary()">
      <div id="library-container"></div>
    </aside>

    <!-- CENTER: Transport + Video + Timeline -->
    <section class="panel-center">
      <!-- Transport -->
      <div class="transport">
        <div class="transport-buttons">
          <button class="transport-btn" onclick="rewind()" title="Rewind 15s">&#9198;</button>
          <button class="transport-btn" id="play-btn" onclick="togglePlay()" title="Play / Pause">&#9654;</button>
          <button class="transport-btn" onclick="stopPlayback()" title="Stop">&#9632;</button>
          <button class="transport-btn" onclick="forward()" title="Forward 15s">&#9197;</button>
          <button class="transport-btn rec" id="rec-btn" onclick="toggleRec()" title="Record">&#9679;</button>
        </div>
        <div class="time-display" id="time-display">00:00:00</div>
        <div class="bpm-section">
          <span class="bpm-label">BPM</span>
          <input type="number" class="bpm-input" id="bpm-input" value="120" min="40" max="200" onchange="updateBPM()">
          <span class="bpm-mode" id="bpm-mode">Standard</span>
          <span class="tempo-link" id="tempo-link" onclick="toggleTempoLink()" title="Link BPM to exercise tempo">LINK</span>
        </div>
      </div>

      <!-- Video (collapsible) -->
      <div class="video-section" id="video-section">
        <div class="video-placeholder" id="video-placeholder">
          <div class="vp-icon">&#9654;</div>
          <span>Drop video here or click to load</span>
          <span style="font-size:9px;opacity:0.5">Landscape video plays in sync with timeline</span>
        </div>
        <video id="studio-video" style="width:100%;height:100%;object-fit:contain;display:none" controls></video>
        <button class="video-toggle" onclick="toggleVideo()" title="Toggle video">&#9660;</button>
      </div>

      <!-- Timeline -->
      <div class="timeline-container" id="timeline-container">
        <div class="timeline-ruler" id="timeline-ruler"></div>
        <div class="timeline-tracks" id="timeline-tracks">
          <div class="playhead" id="playhead"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Mixer + Inspector + Music -->
    <aside class="panel-right">
      <!-- Meter -->
      <div class="mixer-section">
        <div class="mixer-title">Output</div>
        <div class="meter-group" id="meters"></div>
      </div>

      <!-- Faders -->
      <div class="mixer-section">
        <div class="mixer-title">Master Faders</div>
        <div class="fader-group" id="fader-group"></div>
      </div>

      <!-- Knobs -->
      <div class="mixer-section">
        <div class="mixer-title">Blend Controls</div>
        <div class="knob-group" id="knob-group"></div>
      </div>

      <!-- Inspector -->
      <div class="inspector-section" id="inspector" style="display:none">
        <div class="inspector-title">Exercise DNA</div>
        <div class="inspector-field"><label>Movement</label><div class="value" id="insp-name">-</div></div>
        <div class="inspector-field"><label>Pattern</label><div class="value" id="insp-pattern">-</div></div>
        <div class="inspector-field"><label>Stage</label><div class="value" id="insp-stage">-</div></div>
        <div class="inspector-field"><label>Discipline</label><div class="value" id="insp-discipline">-</div></div>
        <div class="inspector-field">
          <label>Sets x Reps</label>
          <div style="display:flex;gap:4px">
            <input type="number" id="insp-sets" value="3" min="1" max="10" style="width:40px" onchange="updateClipDNA()">
            <span style="color:var(--text-muted);font-size:11px">x</span>
            <input type="number" id="insp-reps" value="8" min="1" max="50" style="width:40px" onchange="updateClipDNA()">
          </div>
        </div>
        <div class="inspector-field"><label>Tempo (seconds per rep)</label><input type="number" id="insp-tempo" value="3" min="1" max="20" step="0.5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>Rest (seconds)</label><input type="number" id="insp-rest" value="60" min="0" max="300" step="5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>RPE (1-10)</label><input type="range" id="insp-rpe" min="1" max="10" value="7" style="width:100%" oninput="updateClipDNA()"></div>
        <div class="inspector-tags" id="insp-tags"></div>
      </div>

      <!-- Music -->
      <div class="music-section" id="music-panel" style="display:none">
        <div class="mixer-title">Music</div>
        <div class="music-now-playing" id="music-np">
          <div class="eq" id="music-eq" style="display:none"><span></span><span></span><span></span></div>
          <span id="music-track-name">No track</span>
        </div>
        <div class="music-controls">
          <button class="music-btn" onclick="musicPrev()" title="Previous">&#9198;</button>
          <button class="music-btn" id="music-play-btn" onclick="musicToggle()" title="Play/Pause">&#9654;</button>
          <button class="music-btn" onclick="musicNext()" title="Next">&#9197;</button>
          <input type="range" class="music-volume" min="0" max="100" value="50" oninput="musicVolume(this.value)">
        </div>
      </div>

      <!-- Workout Summary -->
      <div class="mixer-section" id="workout-summary" style="display:none">
        <div class="mixer-title">Workout Summary</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:9px">
          <div><span style="color:var(--text-muted)">Total Sets</span><div id="sum-sets" style="font-size:14px;font-weight:600;color:var(--accent-cyan)">0</div></div>
          <div><span style="color:var(--text-muted)">Total Reps</span><div id="sum-reps" style="font-size:14px;font-weight:600;color:var(--accent-cyan)">0</div></div>
          <div><span style="color:var(--text-muted)">Est. Duration</span><div id="sum-duration" style="font-size:14px;font-weight:600;color:var(--accent-green)">0:00</div></div>
          <div><span style="color:var(--text-muted)">Exercises</span><div id="sum-exercises" style="font-size:14px;font-weight:600;color:var(--accent-orange)">0</div></div>
        </div>
        <div style="margin-top:8px">
          <div style="font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px">Balance</div>
          <div id="balance-bars" style="display:flex;gap:2px;height:20px;align-items:flex-end"></div>
          <div id="balance-labels" style="display:flex;gap:2px;margin-top:2px"></div>
        </div>
      </div>

      <!-- Export -->
      <div class="mixer-section" style="display:flex;gap:6px">
        <button class="export-btn" onclick="exportWorkout()" style="flex:1">Export JSON</button>
        <button class="export-btn" onclick="printWorkout()" style="flex:1;background:linear-gradient(135deg,#f97316 0%,#ef4444 100%)">Print</button>
      </div>
    </aside>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="status-item"><div class="status-dot"></div><span id="status-text">Ready</span></div>
    <div><span>Clips: <span id="clip-count">0</span></span> <span style="margin-left:12px">Duration: <span id="total-duration">0:00</span></span></div>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="footer-quote">"Design Your Workout. Design Your Life."</div>
      <a href="https://saturno-bonus-omega.vercel.app/vault" style="font-size:8px;color:var(--accent-cyan);text-decoration:none;padding:3px 8px;border:1px solid var(--border)">Back to Vault</a>
    </div>
  </footer>
</div>

<div class="saved-modal" id="saved-modal">
  <div class="saved-modal-content">
    <div class="saved-modal-header">
      <h3>Saved Workouts</h3>
      <button class="saved-modal-close" onclick="closeSavedWorkouts()">&times;</button>
    </div>
    <div id="saved-list"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== EXERCISE DATABASE (from Victory Belt CC Movement Matrix) ===== */
var EXERCISES = [
  /* Horizontal Push (Pattern 1) */
  {id:'P1-01',name:'Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-02',name:'Diamond Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-03',name:'Wide Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-04',name:'Decline Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-05',name:'Archer Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-06',name:'Pseudo Planche PU',pattern:'Horizontal Push',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-07',name:'Ring Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-08',name:'One Arm Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-09',name:'Planche Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Horizontal Pull (Pattern 2) */
  {id:'P2-01',name:'Inverted Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-02',name:'Ring Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-03',name:'Archer Row',pattern:'Horizontal Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-04',name:'Tuck Front Lever',pattern:'Horizontal Pull',stage:2,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-05',name:'Front Lever Row',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-06',name:'Front Lever',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Downward Press (Pattern 3) */
  {id:'P3-01',name:'Dip',pattern:'Downward Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-02',name:'Ring Dip',pattern:'Downward Press',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-03',name:'Korean Dip',pattern:'Downward Press',stage:2,discipline:'Freestyle',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-04',name:'Weighted Dip',pattern:'Downward Press',stage:2,discipline:'Street Lifting',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-05',name:'Tuck Planche',pattern:'Downward Press',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-06',name:'Full Planche',pattern:'Downward Press',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Vertical Pull (Pattern 4) */
  {id:'P4-01',name:'Dead Hang',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-02',name:'Pull Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-03',name:'Chin Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-04',name:'L-Sit Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-05',name:'Archer Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-06',name:'Muscle Up (Bar)',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-07',name:'Ring Muscle Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-08',name:'Weighted Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Street Lifting',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-09',name:'One Arm Pull Up',pattern:'Vertical Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Overhead Press (Pattern 5) */
  {id:'P5-01',name:'Pike Push Up',pattern:'Overhead Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P5-02',name:'Wall Handstand Hold',pattern:'Overhead Press',stage:1,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-03',name:'Wall HSPU',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-04',name:'Free Handstand',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-05',name:'Handstand Push Up',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-06',name:'Press to Handstand',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  /* Knee-Dominant (Pattern 6) */
  {id:'P6-01',name:'Bodyweight Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-02',name:'Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-03',name:'Bulgarian Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-04',name:'Pistol Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-05',name:'Shrimp Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-06',name:'Cossack Squat',pattern:'Knee-Dominant',stage:2,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-07',name:'Dragon Squat',pattern:'Knee-Dominant',stage:3,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  /* Hip-Dominant (Pattern 7) */
  {id:'P7-01',name:'Glute Bridge',pattern:'Hip-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-02',name:'Nordic Curl',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-03',name:'Wrestler Bridge',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-04',name:'Stand to Bridge',pattern:'Hip-Dominant',stage:3,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  /* Core */
  {id:'C-01',name:'Hollow Body Hold',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-02',name:'Plank',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-03',name:'L-Sit',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-04',name:'V-Sit',pattern:'Core',stage:3,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-05',name:'Dragon Flag',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-06',name:'Ab Wheel Rollout',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  /* Mobility */
  {id:'M-01',name:'Resting Squat',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-02',name:'Pancake Stretch',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-03',name:'Front Split',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-04',name:'Thoracic Bridge',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-05',name:'German Hang',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-06',name:'Hip CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-07',name:'Scapular CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'}
];

/* Movement family -> instrument role (from Composition Engine) */
var FAMILY_MAP = {
  'Push': {instrument:'Percussion',color:'#3b82f6'},
  'Pull': {instrument:'Bass',color:'#8b5cf6'},
  'Legs': {instrument:'Rhythm Guitar',color:'#22c55e'},
  'Core': {instrument:'Harmony',color:'#f97316'},
  'Skills': {instrument:'Lead Melody',color:'#06b6d4'},
  'Flow': {instrument:'Ambient Pad',color:'#ec4899'}
};

/* BPM -> Training Mode (from Composition Engine) */
var BPM_MODES = [
  {min:40,max:80,name:'Slow Strength',desc:'Control, holds, precision'},
  {min:80,max:120,name:'Standard',desc:'Tempo work, sets'},
  {min:120,max:160,name:'Flow State',desc:'Conditioning, flow'},
  {min:160,max:200,name:'Explosive',desc:'Power, speed, intensity'}
];

/* Track definitions */
var TRACKS = [
  {id:'music',name:'Music',family:'_music',info:'Audio',isMusic:true},
  {id:'push',name:'Push',family:'Push',info:'Percussion'},
  {id:'pull',name:'Pull',family:'Pull',info:'Bass'},
  {id:'core',name:'Core',family:'Core',info:'Harmony'},
  {id:'legs',name:'Legs',family:'Legs',info:'Rhythm'},
  {id:'skills',name:'Skills',family:'Skills',info:'Lead'}
];

/* Fader definitions */
var FADERS = [
  {id:'intensity',label:'Intensity',value:70,color:'var(--gradient-titan)'},
  {id:'volume',label:'Volume',value:50,color:'var(--gradient-titan)'},
  {id:'density',label:'Density',value:60,color:'var(--gradient-titan)'},
  {id:'rest',label:'Rest',value:40,color:'var(--gradient-titan)'}
];

/* Knob definitions */
var KNOBS = [
  {id:'str-mob',label:'Str / Mob',value:0.5},
  {id:'pwr-ctrl',label:'Pwr / Ctrl',value:0.5},
  {id:'sta-dyn',label:'Sta / Dyn',value:0.5}
];

/* Preset definitions */
var PRESETS = {
  monk: {
    name:'Monk Mode',bpm:65,
    clips:[
      {track:'core',name:'Hollow Body Hold',x:0,w:120},
      {track:'push',name:'Push Up',x:20,w:100},
      {track:'core',name:'L-Sit',x:140,w:100},
      {track:'pull',name:'Pull Up',x:140,w:100},
      {track:'skills',name:'Free Handstand',x:260,w:120},
      {track:'legs',name:'Resting Squat',x:260,w:80}
    ],
    faders:{intensity:40,volume:30,density:30,rest:70},
    knobs:{'str-mob':0.4,'pwr-ctrl':0.3,'sta-dyn':0.2}
  },
  beast: {
    name:'Beast Mode',bpm:140,
    clips:[
      {track:'push',name:'Diamond Push Up',x:0,w:100},
      {track:'pull',name:'Muscle Up (Bar)',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:120,w:80},
      {track:'push',name:'Dip',x:120,w:80},
      {track:'core',name:'Dragon Flag',x:120,w:80},
      {track:'pull',name:'Weighted Pull Up',x:220,w:100},
      {track:'legs',name:'Shrimp Squat',x:220,w:80},
      {track:'push',name:'Planche Push Up',x:340,w:100}
    ],
    faders:{intensity:90,volume:80,density:85,rest:20},
    knobs:{'str-mob':0.8,'pwr-ctrl':0.7,'sta-dyn':0.9}
  },
  flow: {
    name:'Flow Ritual',bpm:100,
    clips:[
      {track:'legs',name:'Hip CARs',x:0,w:80},
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'core',name:'Hollow Body Hold',x:100,w:80},
      {track:'pull',name:'Ring Row',x:100,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:200,w:100},
      {track:'legs',name:'Cossack Squat',x:200,w:80},
      {track:'core',name:'L-Sit',x:300,w:80},
      {track:'push',name:'Ring Push Up',x:300,w:100}
    ],
    faders:{intensity:55,volume:60,density:65,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.4,'sta-dyn':0.6}
  },
  skill: {
    name:'Skill Ascension',bpm:75,
    clips:[
      {track:'skills',name:'Free Handstand',x:0,w:160},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'pull',name:'Tuck Front Lever',x:180,w:140},
      {track:'push',name:'Tuck Planche',x:180,w:140},
      {track:'core',name:'V-Sit',x:180,w:80},
      {track:'skills',name:'Press to Handstand',x:340,w:160}
    ],
    faders:{intensity:60,volume:40,density:35,rest:80},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.3,'sta-dyn':0.15}
  },
  upper: {
    name:'Upper Day',bpm:100,
    clips:[
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'push',name:'Dip',x:120,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Inverted Row',x:120,w:100},
      {track:'push',name:'Ring Push Up',x:240,w:100},
      {track:'pull',name:'Chin Up',x:240,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'L-Sit',x:120,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:360,w:120}
    ],
    faders:{intensity:65,volume:60,density:55,rest:50},
    knobs:{'str-mob':0.7,'pwr-ctrl':0.5,'sta-dyn':0.4}
  },
  lower: {
    name:'Lower Day',bpm:90,
    clips:[
      {track:'legs',name:'Bodyweight Squat',x:0,w:100},
      {track:'legs',name:'Bulgarian Split Squat',x:120,w:100},
      {track:'legs',name:'Pistol Squat',x:240,w:100},
      {track:'legs',name:'Nordic Curl',x:360,w:100},
      {track:'legs',name:'Cossack Squat',x:480,w:80},
      {track:'core',name:'Dragon Flag',x:0,w:100},
      {track:'core',name:'Ab Wheel Rollout',x:120,w:80},
      {track:'legs',name:'Glute Bridge',x:600,w:80},
      {track:'skills',name:'Resting Squat',x:0,w:120}
    ],
    faders:{intensity:70,volume:55,density:60,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.6,'sta-dyn':0.5}
  },
  ppl: {
    name:'Push / Pull / Legs',bpm:110,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'push',name:'Pseudo Planche PU',x:120,w:100},
      {track:'push',name:'Pike Push Up',x:240,w:80},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Ring Row',x:120,w:80},
      {track:'pull',name:'Tuck Front Lever',x:220,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'legs',name:'Nordic Curl',x:120,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'Dragon Flag',x:100,w:80}
    ],
    faders:{intensity:75,volume:65,density:70,rest:35},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.6,'sta-dyn':0.6}
  },
  fullbody: {
    name:'Full Body',bpm:105,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'skills',name:'Free Handstand',x:0,w:120},
      {track:'push',name:'Ring Push Up',x:140,w:80},
      {track:'pull',name:'Archer Pull Up',x:140,w:80},
      {track:'legs',name:'Bulgarian Split Squat',x:140,w:80},
      {track:'core',name:'Ab Wheel Rollout',x:140,w:80}
    ],
    faders:{intensity:60,volume:55,density:50,rest:50},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.5,'sta-dyn':0.5}
  }
};

/* ===== STATE ===== */
var isPlaying = false, currentTime = 0, bpm = 120, playInterval = null;
var isRecording = false, tempoLinked = false;
var selectedClip = null, musicPlaying = false, musicIndex = 0;
var audioEl = null;
var meterInterval = null;
var undoStack = [], redoStack = [], maxUndo = 30;

/* Music tracks (from Vercel Blob CDN) */
var MUSIC_TRACKS = [
  {name:'Celestial Reverie',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Celestial%20Reverie.mp3'},
  {name:'Blue Phoenix',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Blue%20Phoenix.mp3'},
  {name:'Veil of Truth',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Veil%20of%20Truth.mp3'},
  {name:'Astral Shadows',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Astral%20Shadows.mp3'}
];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', function() {
  buildLibrary();
  buildTracks();
  buildRuler();
  buildFaders();
  buildKnobs();
  buildMeters();
  loadSession();
  updateBPMMode();
});

/* ===== LIBRARY ===== */
function buildLibrary() {
  var container = document.getElementById('library-container');
  var groups = {};
  EXERCISES.forEach(function(ex) {
    var g = ex.pattern;
    if (!groups[g]) groups[g] = [];
    groups[g].push(ex);
  });
  var html = '';
  var patterns = ['Horizontal Push','Horizontal Pull','Downward Press','Vertical Pull','Overhead Press','Knee-Dominant','Hip-Dominant','Core','Mobility'];
  patterns.forEach(function(p) {
    var exs = groups[p];
    if (!exs) return;
    var fam = exs[0].family;
    var fm = FAMILY_MAP[fam] || {color:'#666'};
    html += '<div class="movement-category" data-pattern="'+p+'">';
    html += '<div class="category-header" onclick="toggleCategory(this)"><span>'+p+' ('+exs.length+')</span><div style="display:flex;align-items:center;gap:6px"><div class="category-color" style="background:'+fm.color+'"></div><span class="arrow">&#9660;</span></div></div>';
    html += '<div class="movement-list">';
    exs.forEach(function(ex) {
      html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" data-family="'+ex.family+'">';
      html += '<div class="mv-icon" style="background:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
      html += '<span>'+ex.name+'</span>';
      html += '<span class="mv-stage">S'+ex.stage+'</span>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
  document.getElementById('lib-count').textContent = EXERCISES.length;
  initDragDrop();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  var list = header.nextElementSibling;
  list.classList.toggle('hidden');
}

function filterLibrary() {
  var q = document.getElementById('lib-search').value.toLowerCase();
  var items = document.querySelectorAll('.movement-item');
  var count = 0;
  items.forEach(function(item) {
    var show = item.textContent.toLowerCase().indexOf(q) !== -1;
    item.style.display = show ? '' : 'none';
    if (show) count++;
  });
  document.getElementById('lib-count').textContent = count;
  // Show all categories when searching
  if (q) {
    document.querySelectorAll('.movement-list').forEach(function(l) { l.classList.remove('hidden'); });
    document.querySelectorAll('.category-header').forEach(function(h) { h.classList.remove('collapsed'); });
  }
}

/* ===== TRACKS ===== */
function buildTracks() {
  var container = document.getElementById('timeline-tracks');
  var ph = container.querySelector('.playhead');
  var html = '';
  TRACKS.forEach(function(t) {
    if (t.isMusic) {
      html += '<div class="track" data-track="'+t.id+'" style="background:rgba(6,182,212,0.03)">';
      html += '<div class="track-header"><div class="track-name" style="color:var(--accent-cyan)">'+t.name+'</div>';
      html += '<select class="track-select" id="music-track-select" onchange="selectMusicTrack(this.value)" style="font-size:8px;padding:2px 4px;background:var(--bg);border:1px solid var(--border);color:var(--text);width:90px;font-family:Sora,sans-serif">';
      html += '<option value="">--</option>';
      MUSIC_TRACKS.forEach(function(mt,i) { html += '<option value="'+i+'">'+mt.name+'</option>'; });
      html += '</select></div>';
      html += '<div class="track-content" data-track="'+t.id+'" style="pointer-events:none"><span id="music-timeline-label" style="font-size:8px;color:var(--text-muted);padding:4px 8px;display:inline-block">Select a track</span></div></div>';
    } else {
      var fm = FAMILY_MAP[t.family] || {color:'#666'};
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-name" style="color:'+fm.color+'">'+t.name+'</div><div class="track-info">'+t.info+'</div>';
      html += '<div class="track-controls"><button class="track-btn" onclick="toggleMute(this)" title="Mute">M</button><button class="track-btn" onclick="toggleSolo(this)" title="Solo">S</button></div></div>';
      html += '<div class="track-content" data-track="'+t.id+'"></div></div>';
    }
  });
  container.innerHTML = html;
  container.insertBefore(ph, container.firstChild);
}

function selectMusicTrack(idx) {
  if (idx === '') {
    document.getElementById('music-timeline-label').textContent = 'Select a track';
    return;
  }
  musicIndex = parseInt(idx);
  var track = MUSIC_TRACKS[musicIndex];
  document.getElementById('music-timeline-label').textContent = track.name;
  document.getElementById('music-track-name').textContent = track.name;
  if (!audioEl) { audioEl = new Audio(); audioEl.volume = 0.5; audioEl.addEventListener('ended', function() { musicNext(); }); }
  audioEl.src = track.url;
  audioEl.load();
  toast('Music: ' + track.name);
}

function buildRuler() {
  var ruler = document.getElementById('timeline-ruler');
  var html = '<div class="ruler-mark" style="flex:0 0 100px">0:00</div>';
  for (var i = 15; i <= 300; i += 15) {
    var m = Math.floor(i / 60);
    var s = i % 60;
    html += '<div class="ruler-mark">'+m+':'+s.toString().padStart(2,'0')+'</div>';
  }
  ruler.innerHTML = html;
}

/* ===== DRAG & DROP ===== */
function initDragDrop() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.5';
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
  document.querySelectorAll('.track-content').forEach(function(track) {
    track.addEventListener('dragover', function(e) { e.preventDefault(); track.classList.add('drag-over'); });
    track.addEventListener('dragleave', function() { track.classList.remove('drag-over'); });
    track.addEventListener('drop', function(e) {
      e.preventDefault();
      track.classList.remove('drag-over');
      try {
        var ex = JSON.parse(e.dataTransfer.getData('text/plain'));
        var rect = track.getBoundingClientRect();
        var x = e.clientX - rect.left + track.parentElement.parentElement.scrollLeft;
        addClip(track, ex, x);
      } catch(err) {}
    });
  });
}

function getExercise(id) {
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].id === id) return EXERCISES[i];
  }
  return null;
}

/* ===== CLIPS ===== */
function createClipElement(exercise, left, width, dna) {
  var fm = FAMILY_MAP[exercise.family] || {color:'#666'};
  var clip = document.createElement('div');
  clip.className = 'clip';
  clip.style.background = fm.color;
  clip.style.left = (typeof left === 'string' ? left : Math.max(0, left) + 'px');
  clip.style.width = (typeof width === 'string' ? width : (width || 80) + 'px');
  clip.textContent = exercise.name;
  clip.dataset.exerciseId = exercise.id;
  clip.dataset.sets = (dna && dna.sets) || '3';
  clip.dataset.reps = (dna && dna.reps) || '8';
  clip.dataset.tempo = (dna && dna.tempo) || '3';
  clip.dataset.rest = (dna && dna.rest) || '60';
  clip.dataset.rpe = (dna && dna.rpe) || '7';

  var info = document.createElement('span');
  info.className = 'clip-info';
  info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps;
  clip.appendChild(info);

  var resize = document.createElement('div');
  resize.className = 'clip-resize';
  clip.appendChild(resize);

  // Drag clip
  clip.addEventListener('mousedown', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    e.preventDefault();
    selectClipEl(clip);
    var startX = e.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) {
      var newLeft = Math.max(0, startLeft + e.clientX - startX);
      clip.style.left = snapValue(newLeft) + 'px';
    }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Resize clip (stretching shows duration)
  resize.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      var newW = Math.max(40, startW + e.clientX - startX);
      newW = snapEnabled ? Math.max(40, snapValue(newW)) : newW;
      clip.style.width = newW + 'px';
      var durSec = Math.round(newW / 80 * 15);
      var durM = Math.floor(durSec / 60);
      var durS = durSec % 60;
      var durStr = durM > 0 ? durM + ':' + durS.toString().padStart(2,'0') : durSec + 's';
      clip.title = exercise.name + ' - ' + durStr;
      updateStats();
    }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Touch drag support
  clip.addEventListener('touchstart', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    selectClipEl(clip);
    var touch = e.touches[0];
    var startX = touch.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) { e.preventDefault(); clip.style.left = Math.max(0, startLeft + e.touches[0].clientX - startX) + 'px'; }
    function onEnd() { clip.removeEventListener('touchmove', onMove); clip.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    clip.addEventListener('touchmove', onMove, {passive: false});
    clip.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Touch resize support
  resize.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    var touch = e.touches[0];
    var startX = touch.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      e.preventDefault();
      var newW = Math.max(40, startW + e.touches[0].clientX - startX);
      clip.style.width = newW + 'px';
      updateStats();
    }
    function onEnd() { resize.removeEventListener('touchmove', onMove); resize.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    resize.addEventListener('touchmove', onMove, {passive: false});
    resize.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Double click / double tap to delete
  var lastTap = 0;
  clip.addEventListener('touchend', function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      clip.remove();
      if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      toast('Clip removed');
    }
    lastTap = now;
  });
  clip.addEventListener('dblclick', function() {
    pushUndo();
    clip.remove();
    if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
    updateStats(); saveSession();
    toast('Clip removed');
  });

  return clip;
}

function addClip(track, exercise, x) {
  pushUndo();
  var clip = createClipElement(exercise, x, 80);
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  toast(exercise.name + ' added');
}

function selectClipEl(clip) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  clip.classList.add('selected');
  selectedClip = clip;
  var ex = getExercise(clip.dataset.exerciseId);
  if (!ex) return;
  var insp = document.getElementById('inspector');
  insp.style.display = '';
  document.getElementById('insp-name').textContent = ex.name;
  document.getElementById('insp-pattern').textContent = ex.pattern;
  document.getElementById('insp-stage').textContent = 'Stage ' + ex.stage + ' - ' + ex.discipline;
  document.getElementById('insp-discipline').textContent = ex.discipline;
  document.getElementById('insp-sets').value = clip.dataset.sets || 3;
  document.getElementById('insp-reps').value = clip.dataset.reps || 8;
  document.getElementById('insp-tempo').value = clip.dataset.tempo || 3;
  document.getElementById('insp-rest').value = clip.dataset.rest || 60;
  document.getElementById('insp-rpe').value = clip.dataset.rpe || 7;
  var fm = FAMILY_MAP[ex.family] || {};
  document.getElementById('insp-tags').innerHTML =
    '<span class="inspector-tag" style="background:'+((FAMILY_MAP[ex.family]||{}).color||'#666')+'22;color:'+(FAMILY_MAP[ex.family]||{}).color+'">'+ex.family+'</span>' +
    '<span class="inspector-tag">'+(fm.instrument||'')+'</span>' +
    '<span class="inspector-tag">S'+ex.stage+'</span>';
}

function updateClipDNA() {
  if (!selectedClip) return;
  selectedClip.dataset.sets = document.getElementById('insp-sets').value;
  selectedClip.dataset.reps = document.getElementById('insp-reps').value;
  selectedClip.dataset.tempo = document.getElementById('insp-tempo').value;
  selectedClip.dataset.rest = document.getElementById('insp-rest').value;
  selectedClip.dataset.rpe = document.getElementById('insp-rpe').value;
  var info = selectedClip.querySelector('.clip-info');
  if (info) info.textContent = selectedClip.dataset.sets + 'x' + selectedClip.dataset.reps;
  // If tempo linked, update clip width based on exercise duration
  if (tempoLinked) {
    var sets = parseInt(selectedClip.dataset.sets) || 3;
    var reps = parseInt(selectedClip.dataset.reps) || 8;
    var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
    var rest = parseInt(selectedClip.dataset.rest) || 60;
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var pps = 80 / 15;
    selectedClip.style.width = Math.max(40, totalSec * pps) + 'px';
    updateStats();
  }
  saveSession();
}

function updateSummary() {
  var clips = document.querySelectorAll('.clip');
  var panel = document.getElementById('workout-summary');
  if (clips.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = '';
  var totalSets = 0, totalReps = 0, totalDur = 0, exerciseSet = {};
  var familyCounts = {};
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    totalSets += sets;
    totalReps += sets * reps;
    totalDur += (sets * reps * tempo) + ((sets - 1) * rest);
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exerciseSet[ex.id] = true;
      familyCounts[ex.family] = (familyCounts[ex.family] || 0) + 1;
    }
  });
  document.getElementById('sum-sets').textContent = totalSets;
  document.getElementById('sum-reps').textContent = totalReps;
  var durM = Math.floor(totalDur / 60);
  var durS = Math.floor(totalDur % 60);
  document.getElementById('sum-duration').textContent = durM + ':' + durS.toString().padStart(2, '0');
  document.getElementById('sum-exercises').textContent = Object.keys(exerciseSet).length;
  // Balance bars
  var maxCount = 1;
  var families = ['Push','Pull','Core','Legs','Skills','Flow'];
  families.forEach(function(f) { if ((familyCounts[f] || 0) > maxCount) maxCount = familyCounts[f]; });
  var barsHtml = '', labelsHtml = '';
  families.forEach(function(f) {
    var count = familyCounts[f] || 0;
    var fm = FAMILY_MAP[f] || {color:'#666'};
    var h = count > 0 ? Math.max(4, (count / maxCount) * 20) : 2;
    barsHtml += '<div style="flex:1;height:'+h+'px;background:'+fm.color+';border-radius:1px;opacity:'+(count > 0 ? 1 : 0.2)+'"></div>';
    labelsHtml += '<div style="flex:1;font-size:6px;color:var(--text-muted);text-align:center">'+f.charAt(0)+'</div>';
  });
  document.getElementById('balance-bars').innerHTML = barsHtml;
  document.getElementById('balance-labels').innerHTML = labelsHtml;
}

function updateStats() {
  var clips = document.querySelectorAll('.clip');
  document.getElementById('clip-count').textContent = clips.length;
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var secs = Math.round(maxRight / 80 * 15);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  document.getElementById('total-duration').textContent = m + ':' + s.toString().padStart(2, '0');
  updateSummary();
}

/* ===== TRANSPORT ===== */
function togglePlay() {
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) {
    btn.classList.add('active');
    btn.innerHTML = '&#9616;&#9616;';
    playInterval = setInterval(updatePlayhead, 50);
    startMeters();
    document.getElementById('status-text').textContent = 'Playing';
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#9654;';
    clearInterval(playInterval);
    stopMeters();
    document.getElementById('status-text').textContent = 'Paused';
  }
}

function stopPlayback() {
  isPlaying = false;
  currentTime = 0;
  var btn = document.getElementById('play-btn');
  btn.classList.remove('active');
  btn.innerHTML = '&#9654;';
  clearInterval(playInterval);
  stopMeters();
  updateTimeDisplay();
  updatePlayheadPosition();
  document.getElementById('status-text').textContent = 'Ready';
}

function rewind() { currentTime = Math.max(0, currentTime - 15); updateTimeDisplay(); updatePlayheadPosition(); }
function forward() { currentTime += 15; updateTimeDisplay(); updatePlayheadPosition(); }

function updatePlayhead() {
  currentTime += 0.05;
  updateTimeDisplay();
  updatePlayheadPosition();
}

function updateTimeDisplay() {
  var mins = Math.floor(currentTime / 60);
  var secs = Math.floor(currentTime % 60);
  var ms = Math.floor((currentTime % 1) * 100);
  document.getElementById('time-display').textContent =
    mins.toString().padStart(2, '0') + ':' +
    secs.toString().padStart(2, '0') + ':' +
    ms.toString().padStart(2, '0');
}

function updatePlayheadPosition() {
  var pps = 80 / 15;
  document.getElementById('playhead').style.left = (100 + currentTime * pps) + 'px';
}

function toggleRec() {
  isRecording = !isRecording;
  var btn = document.getElementById('rec-btn');
  btn.classList.toggle('active', isRecording);
  document.getElementById('status-text').textContent = isRecording ? 'Recording' : 'Ready';
}

/* ===== BPM ===== */
function updateBPM() {
  bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  updateBPMMode();
  saveSession();
  // If tempo-linked, adjust exercise tempos AND music playback rate
  if (tempoLinked) {
    var repTempo = 60 / bpm;
    document.getElementById('insp-tempo').value = repTempo.toFixed(1);
    if (selectedClip) {
      selectedClip.dataset.tempo = repTempo.toFixed(1);
      updateClipDNA();
    }
    // Adjust music playback rate: 120 BPM = 1.0x, scale proportionally
    if (audioEl) {
      var rate = Math.max(0.5, Math.min(2.0, bpm / 120));
      audioEl.playbackRate = rate;
    }
    toast('Tempo linked: ' + repTempo.toFixed(1) + 's/rep, music ' + (bpm / 120).toFixed(2) + 'x');
  } else {
    // Reset music to normal speed when unlinked
    if (audioEl) audioEl.playbackRate = 1.0;
  }
}

function updateBPMMode() {
  var mode = 'Standard';
  for (var i = 0; i < BPM_MODES.length; i++) {
    if (bpm >= BPM_MODES[i].min && bpm < BPM_MODES[i].max) {
      mode = BPM_MODES[i].name;
      break;
    }
  }
  if (bpm >= 200) mode = 'Explosive';
  document.getElementById('bpm-mode').textContent = mode;
}

function toggleTempoLink() {
  tempoLinked = !tempoLinked;
  var el = document.getElementById('tempo-link');
  el.classList.toggle('active', tempoLinked);
  if (tempoLinked) {
    toast('BPM linked to exercise tempo');
    updateBPM();
  } else {
    if (audioEl) audioEl.playbackRate = 1.0;
    toast('Tempo unlinked');
  }
}

/* ===== FADERS ===== */
function buildFaders() {
  var container = document.getElementById('fader-group');
  var html = '';
  FADERS.forEach(function(f) {
    html += '<div class="fader" data-fader="'+f.id+'">';
    html += '<div class="fader-label">'+f.label+'</div>';
    html += '<div class="fader-track" onmousedown="startFaderDrag(event,\''+f.id+'\')" ontouchstart="startFaderDrag(event,\''+f.id+'\')">';
    html += '<div class="fader-fill" style="height:'+f.value+'%;background:'+f.color+'"></div>';
    html += '<div class="fader-handle" style="bottom:'+(f.value-3)+'%"></div>';
    html += '</div>';
    html += '<div class="fader-value" id="fader-val-'+f.id+'">'+(f.value/10).toFixed(0)+'</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startFaderDrag(e, faderId) {
  e.preventDefault();
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  function updatePos(clientY) {
    var y = 1 - ((clientY - rect.top) / rect.height);
    y = Math.max(0, Math.min(1, y));
    var pct = y * 100;
    track.querySelector('.fader-fill').style.height = pct + '%';
    track.querySelector('.fader-handle').style.bottom = (pct - 3) + '%';
    document.getElementById('fader-val-' + faderId).textContent = (pct / 10).toFixed(0);
  }
  function onMouseMove(e) { updatePos(e.clientY); }
  function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updatePos(e.touches[0].clientY); }
  function onTouchEnd() { document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    updatePos(e.touches[0].clientY);
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    updatePos(e.clientY);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== KNOBS ===== */
function buildKnobs() {
  var container = document.getElementById('knob-group');
  var html = '';
  KNOBS.forEach(function(k) {
    var deg = (k.value - 0.5) * 270;
    html += '<div class="knob" data-knob="'+k.id+'">';
    html += '<div class="knob-dial" onmousedown="startKnobDrag(event,\''+k.id+'\')" ontouchstart="startKnobDrag(event,\''+k.id+'\')">';
    html += '<div class="knob-indicator" style="transform:translateX(-50%) rotate('+deg+'deg)"></div>';
    html += '</div>';
    html += '<div class="knob-label">'+k.label+'</div>';
    html += '<div class="knob-value" id="knob-val-'+k.id+'">'+(k.value*100).toFixed(0)+'%</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startKnobDrag(e, knobId) {
  e.preventDefault();
  var startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  var dial = e.currentTarget;
  var indicator = dial.querySelector('.knob-indicator');
  var startDeg = parseFloat(indicator.style.transform.match(/rotate\(([^)]+)deg\)/)[1]);
  function updateKnob(clientY) {
    var delta = (startY - clientY) * 1.5;
    var deg = Math.max(-135, Math.min(135, startDeg + delta));
    indicator.style.transform = 'translateX(-50%) rotate(' + deg + 'deg)';
    var val = ((deg + 135) / 270);
    document.getElementById('knob-val-' + knobId).textContent = (val * 100).toFixed(0) + '%';
  }
  function onMouseMove(e) { updateKnob(e.clientY); }
  function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updateKnob(e.touches[0].clientY); }
  function onTouchEnd() { document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== METERS ===== */
function buildMeters() {
  var container = document.getElementById('meters');
  var html = '';
  for (var i = 0; i < 12; i++) {
    html += '<div class="meter-bar" style="height:' + (10 + Math.random() * 30) + 'px"></div>';
  }
  container.innerHTML = html;
}

function startMeters() {
  if (meterInterval) return;
  meterInterval = setInterval(function() {
    document.querySelectorAll('.meter-bar').forEach(function(bar) {
      bar.style.height = (10 + Math.random() * 50) + 'px';
      var h = parseInt(bar.style.height);
      bar.style.background = h > 45 ? 'var(--accent-red)' : h > 30 ? 'var(--accent-orange)' : 'var(--accent-green)';
    });
  }, 100);
}

function stopMeters() {
  clearInterval(meterInterval);
  meterInterval = null;
  document.querySelectorAll('.meter-bar').forEach(function(bar) {
    bar.style.height = '5px';
    bar.style.background = 'var(--accent-green)';
  });
}

/* ===== TRACK CONTROLS ===== */
function toggleMute(btn) { btn.classList.toggle('muted'); }
function toggleSolo(btn) { btn.classList.toggle('soloed'); }

/* ===== VIDEO ===== */
function toggleVideo() {
  var sec = document.getElementById('video-section');
  sec.classList.toggle('collapsed');
  document.getElementById('btn-video').classList.toggle('active', !sec.classList.contains('collapsed'));
}

/* Video drop zone */
document.addEventListener('DOMContentLoaded', function() {
  var vp = document.getElementById('video-placeholder');
  if (!vp) return;
  vp.addEventListener('click', function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function() { loadVideoFile(input.files[0]); };
    input.click();
  });
  vp.addEventListener('dragover', function(e) { e.preventDefault(); vp.style.background = 'rgba(6,182,212,0.1)'; });
  vp.addEventListener('dragleave', function() { vp.style.background = ''; });
  vp.addEventListener('drop', function(e) {
    e.preventDefault();
    vp.style.background = '';
    if (e.dataTransfer.files.length) loadVideoFile(e.dataTransfer.files[0]);
  });
});

function loadVideoFile(file) {
  if (!file || !file.type.startsWith('video/')) return;
  var video = document.getElementById('studio-video');
  var placeholder = document.getElementById('video-placeholder');
  video.src = URL.createObjectURL(file);
  video.style.display = '';
  placeholder.style.display = 'none';
  toast('Video loaded: ' + file.name);
}

/* ===== MUSIC ===== */
function toggleMusic() {
  var panel = document.getElementById('music-panel');
  var visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : '';
  document.querySelector('[onclick="toggleMusic()"]').classList.toggle('active', !visible);
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.volume = 0.5;
    audioEl.addEventListener('ended', function() { musicNext(); });
  }
}

function musicToggle() {
  if (!audioEl) toggleMusic();
  if (musicPlaying) {
    audioEl.pause();
    musicPlaying = false;
    document.getElementById('music-play-btn').innerHTML = '&#9654;';
    document.getElementById('music-eq').style.display = 'none';
  } else {
    if (!audioEl.src || audioEl.ended) {
      audioEl.src = MUSIC_TRACKS[musicIndex].url;
    }
    audioEl.play().catch(function() {});
    musicPlaying = true;
    document.getElementById('music-play-btn').innerHTML = '&#9616;&#9616;';
    document.getElementById('music-play-btn').classList.add('playing');
    document.getElementById('music-eq').style.display = '';
    document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  }
}

function musicNext() {
  musicIndex = (musicIndex + 1) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicPrev() {
  musicIndex = (musicIndex - 1 + MUSIC_TRACKS.length) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicVolume(val) {
  if (audioEl) audioEl.volume = val / 100;
}

/* ===== PRESETS ===== */
function togglePresets() {
  var drawer = document.getElementById('presets-drawer');
  drawer.classList.toggle('open');
  document.getElementById('btn-presets').classList.toggle('active', drawer.classList.contains('open'));
}

function loadPreset(id) {
  var p = PRESETS[id];
  if (!p) return;
  pushUndo();
  // Clear timeline
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Set BPM
  bpm = p.bpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Add clips
  p.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    if (!track) return;
    var ex = null;
    for (var i = 0; i < EXERCISES.length; i++) {
      if (EXERCISES[i].name === c.name) { ex = EXERCISES[i]; break; }
    }
    if (!ex) return;
    var clip = createClipElement(ex, c.x, c.w || 80);
    track.appendChild(clip);
  });
  // Set faders
  if (p.faders) {
    Object.keys(p.faders).forEach(function(key) {
      var fader = document.querySelector('[data-fader="'+key+'"]');
      if (!fader) return;
      var v = p.faders[key];
      fader.querySelector('.fader-fill').style.height = v + '%';
      fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
      fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
    });
  }
  updateStats();
  saveSession();
  togglePresets();
  toast('Preset loaded: ' + p.name);
}

/* ===== CLEAR ===== */
function clearTimeline() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats();
  saveSession();
  toast('Timeline cleared');
}

/* ===== SAVE / LOAD ===== */
function saveSession() {
  try {
    var session = {bpm: bpm, clips: [], faders: {}, knobs: {}};
    document.querySelectorAll('.clip').forEach(function(clip) {
      session.clips.push({
        exerciseId: clip.dataset.exerciseId,
        track: clip.parentElement.dataset.track,
        left: clip.style.left,
        width: clip.style.width,
        sets: clip.dataset.sets,
        reps: clip.dataset.reps,
        tempo: clip.dataset.tempo,
        rest: clip.dataset.rest,
        rpe: clip.dataset.rpe
      });
    });
    document.querySelectorAll('[data-fader]').forEach(function(f) {
      var fill = f.querySelector('.fader-fill');
      session.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
    });
    localStorage.setItem('sms_session', JSON.stringify(session));
  } catch(e) {}
}

function loadSession() {
  try {
    var saved = localStorage.getItem('sms_session');
    if (!saved) return;
    var s = JSON.parse(saved);
    if (s.bpm) { bpm = s.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
    if (s.clips) {
      s.clips.forEach(function(c) {
        var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
        var ex = getExercise(c.exerciseId);
        if (!track || !ex) return;
        var clip = createClipElement(ex, c.left, c.width, {
          sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe
        });
        track.appendChild(clip);
      });
    }
    if (s.faders) {
      Object.keys(s.faders).forEach(function(key) {
        var fader = document.querySelector('[data-fader="'+key+'"]');
        if (!fader) return;
        var v = s.faders[key];
        fader.querySelector('.fader-fill').style.height = v + '%';
        fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
        fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
      });
    }
    updateStats();
  } catch(e) {}
}

/* ===== EXPORT ===== */
function exportWorkout() {
  var workout = {
    name: 'Saturno Movement Studio Export',
    timestamp: new Date().toISOString(),
    bpm: bpm,
    bpmMode: document.getElementById('bpm-mode').textContent,
    tracks: {}
  };
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    workout.tracks[t.id] = [];
  });
  document.querySelectorAll('.clip').forEach(function(clip) {
    var trackId = clip.parentElement.dataset.track;
    var ex = getExercise(clip.dataset.exerciseId);
    workout.tracks[trackId].push({
      movement: ex ? ex.name : clip.textContent,
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      startTime: parseInt(clip.style.left) / 80 * 15,
      duration: parseInt(clip.style.width) / 80 * 15,
      sets: parseInt(clip.dataset.sets) || 3,
      reps: parseInt(clip.dataset.reps) || 8,
      tempo: parseFloat(clip.dataset.tempo) || 3,
      rest: parseInt(clip.dataset.rest) || 60,
      rpe: parseInt(clip.dataset.rpe) || 7
    });
  });
  var blob = new Blob([JSON.stringify(workout, null, 2)], {type: 'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'workout-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('Workout exported');
}

/* ===== PRINT WORKOUT ===== */
function printWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.textContent,
      pattern: ex ? ex.pattern : '',
      sets: c.dataset.sets || 3,
      reps: c.dataset.reps || 8,
      tempo: c.dataset.tempo || 3,
      rest: c.dataset.rest || 60,
      rpe: c.dataset.rpe || 7,
      startTime: parseInt(c.style.left) / 80 * 15
    });
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Workout - Saturno Movement Studio</title>';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:24px;max-width:700px;margin:0 auto}';
  html += 'h1{font-size:18px;margin-bottom:4px}h2{font-size:14px;margin-top:16px;margin-bottom:8px;padding:4px 8px;background:#f0f0f0}';
  html += '.meta{font-size:11px;color:#666;margin-bottom:12px}table{width:100%;border-collapse:collapse;margin-bottom:8px;font-size:12px}';
  html += 'th,td{text-align:left;padding:4px 8px;border-bottom:1px solid #ddd}th{background:#f8f8f8;font-weight:600}';
  html += '.footer{margin-top:24px;font-size:10px;color:#999;text-align:center;border-top:1px solid #ddd;padding-top:8px}';
  html += '@media print{body{padding:12px}}</style></head><body>';
  html += '<h1>Saturno Movement Studio</h1>';
  html += '<div class="meta">' + bpm + ' BPM / ' + mode + ' / ' + new Date().toLocaleDateString() + '</div>';
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  Object.keys(groups).forEach(function(trackId) {
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.startTime - b.startTime; });
    html += '<h2>' + (trackNames[trackId] || trackId) + '</h2>';
    html += '<table><tr><th>#</th><th>Exercise</th><th>Sets</th><th>Reps</th><th>Tempo</th><th>Rest</th><th>RPE</th><th>Notes</th></tr>';
    exercises.forEach(function(ex, i) {
      html += '<tr><td>'+(i+1)+'</td><td>'+ex.name+'</td><td>'+ex.sets+'</td><td>'+ex.reps+'</td><td>'+ex.tempo+'s</td><td>'+ex.rest+'s</td><td>'+ex.rpe+'</td><td></td></tr>';
    });
    html += '</table>';
  });
  html += '<div class="footer">Generated by Saturno Movement Studio / saturnomovement.com</div>';
  html += '</body></html>';
  var win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.print();
}

/* ===== TOAST ===== */
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

/* ===== SAVED WORKOUTS ===== */
function getSavedWorkouts() {
  try { return JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) { return []; }
}

function saveNamedWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var name = prompt('Workout name:');
  if (!name || !name.trim()) return;
  var workout = {
    name: name.trim(),
    created: new Date().toISOString(),
    bpm: bpm,
    clipCount: clips.length,
    state: captureState()
  };
  var saved = getSavedWorkouts();
  saved.unshift(workout);
  if (saved.length > 20) saved = saved.slice(0, 20);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  toast('Saved: ' + name.trim());
}

function showSavedWorkouts() {
  var saved = getSavedWorkouts();
  var list = document.getElementById('saved-list');
  if (saved.length === 0) {
    list.innerHTML = '<div class="saved-empty">No saved workouts yet. Use SAVE AS to save one.</div>';
  } else {
    var html = '';
    saved.forEach(function(w, i) {
      var date = new Date(w.created).toLocaleDateString();
      html += '<div class="saved-item" onclick="loadSavedWorkout('+i+')">';
      html += '<span class="saved-item-delete" onclick="event.stopPropagation();deleteSavedWorkout('+i+')">delete</span>';
      html += '<div class="saved-item-name">'+w.name+'</div>';
      html += '<div class="saved-item-info">'+w.clipCount+' clips / '+w.bpm+' BPM / '+date+'</div>';
      html += '</div>';
    });
    list.innerHTML = html;
  }
  document.getElementById('saved-modal').classList.add('open');
}

function closeSavedWorkouts() {
  document.getElementById('saved-modal').classList.remove('open');
}

function loadSavedWorkout(index) {
  var saved = getSavedWorkouts();
  if (!saved[index]) return;
  pushUndo();
  var state = JSON.parse(saved[index].state);
  restoreState(state);
  closeSavedWorkouts();
  toast('Loaded: ' + saved[index].name);
}

function deleteSavedWorkout(index) {
  var saved = getSavedWorkouts();
  var name = saved[index] ? saved[index].name : '';
  saved.splice(index, 1);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  showSavedWorkouts();
  toast('Deleted: ' + name);
}

/* Close modal on overlay click */
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('saved-modal');
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeSavedWorkouts();
  });
});

/* ===== UNDO / REDO ===== */
function captureState() {
  var state = {bpm: bpm, clips: []};
  document.querySelectorAll('.clip').forEach(function(clip) {
    state.clips.push({
      exerciseId: clip.dataset.exerciseId,
      track: clip.parentElement.dataset.track,
      left: clip.style.left,
      width: clip.style.width,
      sets: clip.dataset.sets,
      reps: clip.dataset.reps,
      tempo: clip.dataset.tempo,
      rest: clip.dataset.rest,
      rpe: clip.dataset.rpe
    });
  });
  return JSON.stringify(state);
}

function pushUndo() {
  var state = captureState();
  if (undoStack.length > 0 && undoStack[undoStack.length - 1] === state) return;
  undoStack.push(state);
  if (undoStack.length > maxUndo) undoStack.shift();
  redoStack = [];
}

function undo() {
  if (undoStack.length === 0) { toast('Nothing to undo'); return; }
  redoStack.push(captureState());
  var state = JSON.parse(undoStack.pop());
  restoreState(state);
  toast('Undo');
}

function redo() {
  if (redoStack.length === 0) { toast('Nothing to redo'); return; }
  undoStack.push(captureState());
  var state = JSON.parse(redoStack.pop());
  restoreState(state);
  toast('Redo');
}

function restoreState(state) {
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  if (state.bpm) { bpm = state.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
  state.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    var ex = getExercise(c.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, c.left, c.width, {
      sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe
    });
    track.appendChild(clip);
  });
  updateStats();
  saveSession();
}

/* ===== DUPLICATE CLIP ===== */
function duplicateClip() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var track = selectedClip.parentElement;
  var newLeft = parseInt(selectedClip.style.left) + parseInt(selectedClip.style.width) + 4;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe
  });
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  toast('Duplicated: ' + ex.name);
}

/* ===== SNAP TO GRID ===== */
var snapEnabled = false;
var SNAP_SIZE = 80; // pixels per grid unit (15 seconds)

function toggleSnap() {
  snapEnabled = !snapEnabled;
  var btn = document.getElementById('btn-snap');
  if (btn) btn.classList.toggle('active', snapEnabled);
  toast(snapEnabled ? 'Snap ON' : 'Snap OFF');
}

function snapValue(val) {
  if (!snapEnabled) return val;
  return Math.round(val / SNAP_SIZE) * SNAP_SIZE;
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'Escape') {
    stopPlayback();
    closeSavedWorkouts();
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyZ') {
    e.preventDefault();
    if (e.shiftKey) { redo(); } else { undo(); }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyD') {
    e.preventDefault();
    duplicateClip();
    return;
  }
  if (e.code === 'KeyS' && !e.metaKey && !e.ctrlKey) {
    toggleSnap();
  }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    if (selectedClip) {
      pushUndo();
      selectedClip.remove();
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
      updateStats(); saveSession();
      toast('Clip deleted');
    }
  }
});
</script>
</body>
</html>
