<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<title>SATURNO MOVEMENT STUDIO - The Ableton of Movement</title>
<meta name="description" content="The Ableton of Movement. DAW-style workout composition with drag-drop exercises, BPM training modes, and music sync.">
<meta property="og:title" content="Saturno Movement Studio">
<meta property="og:description" content="The Ableton of Movement. Compose workouts like music.">
<meta property="og:type" content="website">
<link rel="icon" href="assets/planet-logo.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* SATURNO FORGE DESIGN LOCK V3.0 — Endel x Craft x Logic Pro */
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #050711;
  --bg-deep: #030509;
  --surface: #0a0e1a;
  --surface2: #0d1117;
  --surface3: #111827;
  --border: rgba(255,255,255,0.06);
  --border-hover: rgba(255,255,255,0.12);
  --border-active: #3b82f6;
  --text: #e2e8f0;
  --text-bright: #ffffff;
  --text-secondary: #8b94a5;
  --muted: #64748b;
  --micro: #475569;
  --accent: #d97706;
  --accent-dim: rgba(217, 119, 6, 0.15);
  --blue: #3b82f6;
  --purple: #8b5cf6;
  --success: #22c55e;
  --error: #ef4444;
  --accent-cyan: #06b6d4;
  --accent-blue: #3b82f6;
  --accent-purple: #8b5cf6;
  --accent-green: #22c55e;
  --accent-orange: #f97316;
  --accent-red: #ef4444;
  --accent-pink: #ec4899;
  --gradient-titan: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #6d28d9 100%);
  --gradient-header: linear-gradient(180deg, #0f1219 0%, #0a0e1a 100%);
  --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-purple: 0 0 20px rgba(139, 92, 246, 0.3);
  --glow-subtle: 0 0 1px rgba(59, 130, 246, 0.15);
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 8px;
  --glass: rgba(255,255,255,0.03);
  --glass-border: rgba(255,255,255,0.05);
  --shadow-soft: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-deep: 0 8px 32px rgba(0,0,0,0.4);
  --transition-fast: 0.12s;
  --transition-normal: 0.2s;
  --transition-slow: 0.3s;
}

body {
  background: var(--bg);
  background-image: radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.03) 0%, transparent 60%);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
}

/* Layout */
.app { display: grid; grid-template-rows: 40px 1fr 24px; height: 100vh; }

/* ===== HEADER — Endel/Craft Toolbar ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  height: 40px;
  border-bottom: 1px solid var(--border);
  background: var(--gradient-header);
  position: relative;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.header::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(59,130,246,0.2) 30%, rgba(139,92,246,0.15) 70%, transparent 95%);
}
/* Global progress bar — thin line at bottom of header showing playback position */
.header-progress {
  position: absolute; bottom: 0; left: 0;
  height: 2px; width: 0%;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
  z-index: 5;
  transition: width 0.1s linear;
  opacity: 0;
}
.header-progress.active { opacity: 1; }
.logo { display: flex; align-items: center; gap: 8px; }
.logo-icon {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
}
.logo-icon img {
  width: 16px; height: 16px; filter: brightness(0) invert(1); opacity: 0.8;
  transition: filter 0.3s, opacity 0.3s;
}
.logo:hover .logo-icon img {
  opacity: 1;
  filter: brightness(0) invert(1) drop-shadow(0 0 4px rgba(59, 130, 246, 0.5));
}
.logo-text {
  font-size: 11px; font-weight: 700;
  letter-spacing: 0.08em; color: var(--text);
}
.logo-sub {
  font-size: 8px; color: var(--micro); margin-top: 0;
  text-transform: uppercase; letter-spacing: 0.15em;
}
.header-nav { display: flex; gap: 1px; align-items: center; }
.nav-btn {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 5px 10px; font-size: 9px; font-family: 'Sora', sans-serif;
  background: transparent; border: 1px solid transparent;
  color: var(--muted); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.2s, background 0.2s, border-color 0.2s;
  height: 26px;
  border-radius: var(--radius-sm);
}
.nav-btn:hover { background: var(--glass); color: var(--text); }
.nav-btn.active {
  background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.15);
  color: var(--blue); font-weight: 600;
}
.header-nav .nav-sep {
  width: 1px; height: 16px; background: var(--border); margin: 0 4px;
}

/* ===== MAIN 3-PANEL ===== */
.main { display: grid; grid-template-columns: 220px 1fr 280px; overflow: hidden; }

/* ===== LEFT PANEL: MOVEMENT LIBRARY ===== */
.panel-left {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.panel-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro);
  display: flex; justify-content: space-between; align-items: center;
  height: 32px;
  background: rgba(10,14,26,0.6);
  position: relative;
}
.panel-header::after {
  content: '';
  position: absolute; bottom: 0; left: 10%; right: 10%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
}
.panel-header span:last-child {
  font-size: 8px; color: var(--micro);
  background: rgba(3,5,9,0.4); padding: 1px 5px;
  border-radius: var(--radius-sm);
}
.lib-search {
  width: calc(100% - 16px); margin: 6px 8px;
  padding: 6px 10px; font-size: 10px; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border); color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
  border-radius: var(--radius-md);
}
.lib-search:focus { outline: none; border-color: rgba(59,130,246,0.3); box-shadow: 0 0 12px rgba(59,130,246,0.08); }
.lib-search::placeholder { color: var(--micro); }
.movement-category { border-bottom: 1px solid rgba(255,255,255,0.04); }
.category-header {
  padding: 7px 12px; font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s;
}
.category-header:hover { background: var(--glass); }
.category-header .arrow { font-size: 7px; transition: transform 0.15s; color: var(--micro); }
.category-header.collapsed .arrow { transform: rotate(-90deg); }
.category-color { width: 6px; height: 6px; border-radius: 1px; }
.movement-list { padding: 2px 6px 6px; }
.movement-list.hidden { display: none; }
.movement-item {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 8px; margin-bottom: 1px;
  font-size: 10px;
  background: transparent;
  border: none;
  border-left: 2px solid transparent;
  cursor: grab;
  transition: background 0.15s, border-color 0.15s, transform 0.1s;
  border-radius: var(--radius-sm);
}
.movement-item:hover {
  background: var(--glass);
  border-left-color: rgba(255,255,255,0.15);
}
.movement-item:active {
  cursor: grabbing;
  background: rgba(59,130,246,0.06);
  border-left-color: rgba(59,130,246,0.4);
  transform: scale(0.98);
}
.movement-item .mv-icon {
  width: 18px; height: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; flex-shrink: 0;
  border-radius: 2px;
}
.movement-item .mv-stage {
  font-size: 7px; color: var(--micro); margin-left: auto;
  text-transform: uppercase; letter-spacing: 0.08em;
}
.movement-item .mv-detail {
  display: none; position: absolute; left: 100%; top: 0;
  background: var(--surface2); border: 1px solid var(--border);
  padding: 6px 10px; white-space: nowrap; z-index: 100;
  font-size: 8px; color: var(--text-secondary);
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  border-radius: 2px; pointer-events: none;
}
.movement-item { position: relative; }
.movement-item:hover .mv-detail { display: block; }
/* Clip stage dots */
.clip-stage-dots {
  position: absolute; top: 3px; right: 6px;
  display: flex; gap: 2px; z-index: 2;
}
.clip-stage-dot {
  width: 3px; height: 3px; border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transition: background 0.15s, box-shadow 0.15s;
}
.clip-stage-dot.filled { background: rgba(255,255,255,0.85); box-shadow: 0 0 4px rgba(255,255,255,0.3); }

/* ===== CENTER PANEL ===== */
.panel-center { display: flex; flex-direction: column; overflow: hidden; }

/* Transport Bar — Endel/Craft Style */
.transport {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  background: linear-gradient(180deg, rgba(15,18,25,0.95) 0%, rgba(10,14,26,0.98) 100%);
  border-bottom: 1px solid var(--border);
  height: 44px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.transport-buttons { display: flex; gap: 1px; }
.transport-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 12px;
  font-family: 'Sora', sans-serif;
  transition: color 0.2s, background 0.2s, border-color 0.2s, box-shadow 0.2s;
}
.transport-btn:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
.transport-btn:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
.transport-btn + .transport-btn { border-left: none; }
.transport-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }
.transport-btn.active { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: var(--blue); box-shadow: 0 0 12px rgba(59,130,246,0.15); }
.transport-btn.rec.active { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: var(--accent-red); box-shadow: 0 0 12px rgba(239,68,68,0.15); }
.transport-sep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }

/* BPM breathing pulse — syncs with current tempo */
@keyframes bpmBreath {
  0%, 100% { opacity: 0; }
  15% { opacity: 1; }
}
.bpm-pulse {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--accent-green);
  box-shadow: 0 0 6px rgba(34,197,94,0.4);
  animation: bpmBreath var(--bpm-duration, 0.5s) ease-out infinite;
  margin-left: 2px;
}
.time-display {
  font-family: 'Sora', sans-serif;
  font-size: 18px; font-weight: 700;
  color: var(--accent-green); padding: 0 10px;
  letter-spacing: 0.02em;
  font-variant-numeric: tabular-nums;
  min-width: 130px;
  display: flex; align-items: center;
  background: rgba(3,5,9,0.6);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  height: 30px;
  padding: 0 8px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
}
.td-seg {
  text-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
}
.td-colon { color: var(--micro); font-size: 14px; margin: 0 1px; }
.td-ms { color: var(--muted); font-size: 14px; }
.bpm-section { display: flex; align-items: center; gap: 4px; margin-left: auto; }
.bpm-label {
  font-size: 8px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.bpm-input {
  width: 48px; padding: 4px 6px; text-align: center;
  font-size: 13px; font-weight: 600; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.6); border: 1px solid var(--glass-border); color: var(--accent-orange);
  transition: border-color 0.15s;
  border-radius: var(--radius-sm);
}
.bpm-input:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 8px rgba(249,115,22,0.15); }
.bpm-mode {
  font-size: 8px; padding: 3px 8px;
  background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.15);
  color: var(--blue);
  text-transform: uppercase; letter-spacing: 0.1em;
  font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm);
}
.tempo-link {
  font-size: 8px; color: var(--muted); cursor: pointer;
  padding: 3px 6px; border: 1px solid transparent;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  border-radius: var(--radius-sm);
}
.tempo-link:hover { color: var(--accent-orange); border-color: rgba(249,115,22,0.2); background: rgba(249,115,22,0.05); }
.tempo-link.active { background: rgba(249,115,22,0.12); border-color: rgba(249,115,22,0.25); color: var(--accent-orange); box-shadow: 0 0 8px rgba(249,115,22,0.1); }

/* Video Section — Premiere Pro Source Monitor */
.video-section {
  background: var(--bg-deep);
  border-bottom: 1px solid var(--border);
  position: relative; min-height: 0; flex-shrink: 1; overflow: hidden;
}
.video-section.collapsed { height: 0; min-height: 0; border: none; }
.video-placeholder {
  display: flex; align-items: center; justify-content: center;
  height: 100%; min-height: 120px;
  color: var(--micro); font-size: 9px;
  flex-direction: column; gap: 6px;
  text-transform: uppercase; letter-spacing: 0.1em;
  border: 1px dashed rgba(255,255,255,0.06);
  margin: 6px;
  border-radius: var(--radius-md);
}
.video-placeholder .vp-icon { font-size: 20px; opacity: 0.2; }
.video-toggle {
  position: absolute; top: 4px; right: 4px;
  width: 18px; height: 18px;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer; font-size: 9px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.video-toggle:hover { color: var(--text); }

/* Mini-map overview */
.timeline-minimap {
  height: 16px;
  background: rgba(3,5,9,0.6);
  border-bottom: 1px solid rgba(255,255,255,0.03);
  position: sticky; top: 22px; z-index: 9;
  overflow: hidden; cursor: pointer;
}
.minimap-viewport {
  position: absolute; top: 0; bottom: 0;
  background: rgba(59, 130, 246, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.2);
  pointer-events: none;
  min-width: 20px;
}
.minimap-clip {
  position: absolute; height: 3px;
  border-radius: 1px; opacity: 0.7;
}

/* Timeline — Logic Pro Grid */
.timeline-container {
  flex: 1; overflow: auto; background: var(--bg-deep);
  position: relative;
}
.timeline-container::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 60px;
  background: linear-gradient(180deg, rgba(59,130,246,0.02) 0%, transparent 100%);
  pointer-events: none; z-index: 0;
}
.timeline-ruler {
  height: 22px;
  background: rgba(10,14,26,0.8);
  border-bottom: 1px solid var(--border);
  display: flex; position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.ruler-mark {
  flex: 0 0 80px;
  border-right: 1px solid rgba(255,255,255,0.04);
  padding: 3px 8px; font-size: 9px;
  color: var(--micro);
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.05em;
}
.ruler-mark:first-child { flex: 0 0 100px; }
.ruler-mark:nth-child(4n+1) { color: var(--muted); }
.timeline-tracks { min-height: 200px; position: relative; }
.track {
  height: 60px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  display: flex;
  background: var(--bg-deep);
  transition: background 0.15s, height 0.2s ease;
  overflow: hidden;
}
.track.track-collapsed {
  height: 24px;
}
.track.track-collapsed .track-controls,
.track.track-collapsed .track-info,
.track.track-collapsed .track-clip-count { opacity: 0; pointer-events: none; }
.track.track-collapsed .clip { height: 18px; top: 3px; font-size: 7px; padding: 1px 4px 0; }
.track.track-collapsed .clip canvas { display: none; }
.track.track-collapsed .clip .beat-markers { display: none; }
.track.track-collapsed .clip .clip-info { display: none; }
.track.track-collapsed .clip .clip-progress { display: none; }
.track.track-collapsed .clip .clip-fade { display: none; }
.track.track-collapsed .clip .clip-stage-dots { display: none; }
.track.track-collapsed .clip .clip-resize,
.track.track-collapsed .clip .clip-resize-left { display: none; }
.track:hover { background: rgba(10,14,26,0.8); }
.track:nth-child(even) { background: rgba(10,14,26,0.3); }
.track:nth-child(even):hover { background: rgba(10,14,26,0.6); }
/* Track grip dots (reorder indicator) */
.track-grip {
  display: flex; flex-direction: column; gap: 2px;
  position: absolute; left: 4px; top: 50%;
  transform: translateY(-50%);
  opacity: 0; transition: opacity 0.15s;
}
.track-header:hover .track-grip { opacity: 0.4; }
.track-grip-dot {
  width: 2px; height: 2px;
  background: var(--muted);
  border-radius: 50%;
}
.track-header {
  width: 100px;
  background: rgba(10,14,26,0.6);
  border-right: 1px solid rgba(255,255,255,0.04);
  padding: 6px 8px;
  display: flex; flex-direction: column; justify-content: center;
  flex-shrink: 0;
  position: relative;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.track-header::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px;
}
.track[data-track="music"] .track-header::before { background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.3)); }
.track[data-track="push"] .track-header::before { background: linear-gradient(180deg, var(--accent-blue), rgba(59,130,246,0.3)); }
.track[data-track="pull"] .track-header::before { background: linear-gradient(180deg, var(--accent-purple), rgba(139,92,246,0.3)); }
.track[data-track="core"] .track-header::before { background: linear-gradient(180deg, var(--accent-orange), rgba(249,115,22,0.3)); }
.track[data-track="legs"] .track-header::before { background: linear-gradient(180deg, var(--accent-green), rgba(34,197,94,0.3)); }
.track[data-track="skills"] .track-header::before { background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.3)); }
.track-name {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-info {
  font-size: 7px; color: var(--micro); margin-top: 1px;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-controls { display: flex; gap: 1px; margin-top: 4px; padding-left: 6px; }
.track-btn {
  width: 18px; height: 14px; font-size: 7px; font-weight: 700;
  background: rgba(3,5,9,0.4); border: 1px solid var(--glass-border);
  color: var(--micro); cursor: pointer; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
  border-radius: 2px;
}
.track-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.track-btn.muted { background: var(--accent-orange); color: var(--bg); border-color: var(--accent-orange); }
.track-btn.soloed { background: var(--accent-cyan); color: var(--bg); border-color: var(--accent-cyan); }
.track-content {
  flex: 1; position: relative; min-width: 800px;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
}
/* 16th note grid subdivision — visible at higher zoom */
.track-content.grid-16th {
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 4px, rgba(255,255,255,0.01) 4px, rgba(255,255,255,0.01) 5px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
}
.track-content.drag-over {
  background:
    linear-gradient(90deg, rgba(59, 130, 246, 0.06) 0%, transparent 50%),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
  box-shadow: inset 0 0 20px rgba(59,130,246,0.04);
}
.track-clip-count {
  font-size: 7px; color: var(--micro);
  background: rgba(3,5,9,0.4);
  padding: 0 4px; border-radius: var(--radius-sm);
  margin-top: 2px; display: inline-block;
  padding-left: 6px;
}

/* Clips — Logic Pro Audio Region Style */
@keyframes clipInsert {
  0% { transform: scaleX(0); opacity: 0; }
  100% { transform: scaleX(1); opacity: 1; }
}
.clip {
  position: absolute; height: 44px; top: 8px;
  border: 1px solid rgba(255,255,255,0.06);
  border-top: 2px solid;
  border-radius: var(--radius-sm);
  cursor: move; display: flex; align-items: flex-start;
  padding: 3px 8px 0; font-size: 9px; font-weight: 600;
  user-select: none; overflow: hidden; white-space: nowrap;
  transition: box-shadow 0.2s, opacity 0.15s, border-color 0.15s;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04), var(--shadow-soft);
  animation: clipInsert 0.15s ease-out;
  transform-origin: left center;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}
.clip::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 8px;
  background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.25) 100%);
  pointer-events: none;
}
.clip canvas.clip-waveform {
  position: absolute; bottom: 2px; left: 4px; right: 4px;
  height: 20px; width: calc(100% - 8px);
  pointer-events: none;
}
.clip .beat-markers {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
}
.clip .beat-markers span {
  position: absolute; top: 0; bottom: 0; width: 1px;
  background: rgba(255,255,255,0.06);
}
/* Clip fade handles */
.clip .clip-fade {
  position: absolute; top: 0; width: 0; height: 100%;
  cursor: ew-resize; z-index: 2;
}
.clip .clip-fade-in { left: 0; }
.clip .clip-fade-out { right: 0; }
.clip .clip-fade::after {
  content: '';
  position: absolute; top: 0;
  width: 0; height: 0;
  border-style: solid;
  opacity: 0;
  transition: opacity 0.15s;
}
.clip:hover .clip-fade-in::after {
  opacity: 0.4;
  border-width: 44px 12px 0 0;
  border-color: rgba(0,0,0,0.5) transparent transparent transparent;
  left: 0; top: 0;
}
.clip:hover .clip-fade-out::after {
  opacity: 0.4;
  border-width: 0 0 44px 12px;
  border-color: transparent transparent rgba(0,0,0,0.5) transparent;
  right: 0; bottom: 0; top: auto;
  position: absolute;
}
.clip .clip-fade-in.has-fade::after {
  opacity: 0.5 !important;
}
.clip .clip-fade-out.has-fade::after {
  opacity: 0.5 !important;
}
/* Muted track clips */
.track.track-muted .clip { opacity: 0.3; filter: grayscale(0.6); }
.clip:hover {
  box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 4px 16px rgba(0,0,0,0.3);
  border-color: rgba(255,255,255,0.12);
}
.clip.selected {
  border-color: rgba(255,255,255,0.5);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.3), 0 0 16px rgba(255,255,255,0.08);
}
.clip .clip-name {
  overflow: hidden; text-overflow: ellipsis;
  max-width: calc(100% - 30px); white-space: nowrap;
  display: inline-block; vertical-align: top;
}
.clip .clip-info {
  font-size: 7px; opacity: 0.5; margin-left: 4px;
  text-transform: uppercase; letter-spacing: 0.05em;
  font-weight: 400;
}
.clip.clip-playing {
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.06),
              0 0 12px rgba(255,255,255,0.15), 0 0 4px currentColor;
  border-color: rgba(255,255,255,0.2);
}
.clip-resize {
  position: absolute; right: 0; top: 0; bottom: 0;
  width: 5px; cursor: ew-resize;
  background: transparent;
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize, .clip:hover .clip-resize-left { opacity: 1; background: rgba(255,255,255,0.2); }
.clip-resize:hover, .clip-resize-left:hover { background: rgba(255,255,255,0.4) !important; }
.clip-resize::before {
  content: ''; position: absolute;
  top: 50%; transform: translateY(-50%);
  right: 1px; width: 1px; height: 12px;
  background: rgba(255,255,255,0.4);
  box-shadow: -2px 0 0 rgba(255,255,255,0.4);
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize::before { opacity: 1; }
.playhead {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: var(--text-bright);
  box-shadow: 0 0 8px rgba(255,255,255,0.4), 1px 0 0 rgba(255,255,255,0.08), -1px 0 0 rgba(255,255,255,0.08);
  z-index: 20; pointer-events: none; left: 100px;
}
.playhead.playing {
  box-shadow: 0 0 12px rgba(59,130,246,0.5), 0 0 4px rgba(255,255,255,0.3);
  background: #60a5fa;
  /* Gradient trail behind the playhead */
  border-image: linear-gradient(to right, rgba(59,130,246,0.02), rgba(59,130,246,0.15), transparent) 1;
}
.playhead.playing::after {
  width: 40px; left: -40px; height: 100%; bottom: auto; top: 0;
  background: linear-gradient(to right, transparent, rgba(59,130,246,0.04));
  border-radius: 0; opacity: 1;
}
.playhead::before {
  content: '';
  position: absolute; top: -2px; left: -5px;
  width: 11px; height: 9px;
  background: var(--text-bright);
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}
.playhead.playing::before {
  background: #60a5fa;
}
.playhead::after {
  content: '';
  position: absolute; bottom: 0; left: -2px;
  width: 5px; height: 3px;
  background: var(--text-bright);
  border-radius: 3px 3px 0 0;
  opacity: 0.5;
}

/* Armed track pulsing left border */
@keyframes armPulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}
.track-btn.armed {
  background: var(--error); color: var(--bg); border-color: var(--error);
  animation: armPulse 1.5s ease-in-out infinite;
}
/* Track-level armed glow — entire track gets subtle red tint */
.track:has(.track-btn.armed) .track-header {
  background: rgba(239,68,68,0.04);
  border-left: 2px solid rgba(239,68,68,0.3);
}
.track:has(.track-btn.armed) .track-content {
  background: rgba(239,68,68,0.01);
}

/* Metronome active pulse */
@keyframes metroPulse {
  0%, 100% { background: var(--accent-orange); }
  50% { background: var(--accent-green); }
}
.transport-btn.metro-active {
  background: var(--accent-orange); color: var(--bg); border-color: var(--accent-orange);
}

/* ===== RIGHT PANEL: MIXER + INSPECTOR ===== */
.panel-right {
  background: var(--surface);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.mixer-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.mixer-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
}
.mixer-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro); margin-bottom: 10px;
}

/* Faders — Channel Strip Style */
.fader-group { display: flex; gap: 10px; justify-content: center; }
.fader { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.fader-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--micro);
  text-align: center; max-width: 40px;
}
.fader-track {
  width: 6px; height: 80px;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border);
  position: relative; cursor: pointer;
  border-radius: var(--radius-sm);
}
.fader-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--gradient-titan);
  transition: height 0.1s;
  border-radius: 0 0 3px 3px;
}
.fader-handle {
  position: absolute; left: -5px; right: -5px;
  height: 12px;
  background: linear-gradient(180deg, rgba(100,116,139,0.6) 0%, rgba(45,55,72,0.6) 100%);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  cursor: grab;
  transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.4);
}
.fader-handle:hover { background: linear-gradient(180deg, rgba(100,116,139,0.8) 0%, rgba(71,85,105,0.7) 100%); border-color: rgba(255,255,255,0.15); box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
.fader-value {
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--muted); font-weight: 500;
  font-variant-numeric: tabular-nums;
}

/* Knobs — Pro Tools Style */
.knob-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.knob { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.knob-dial {
  width: 34px; height: 34px;
  background: conic-gradient(
    from 225deg,
    var(--blue) 0deg,
    var(--accent-purple) calc(var(--knob-value, 0.5) * 270deg),
    rgba(255,255,255,0.04) calc(var(--knob-value, 0.5) * 270deg),
    rgba(255,255,255,0.04) 270deg
  );
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 50%; position: relative; cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.knob-dial:hover { border-color: rgba(59,130,246,0.3); box-shadow: 0 0 12px rgba(59,130,246,0.1); }
.knob-dial::before {
  content: '';
  position: absolute; top: 50%; left: 50%;
  width: 22px; height: 22px;
  background: radial-gradient(circle, rgba(17,24,39,0.9) 0%, rgba(3,5,9,0.9) 100%);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  border: 1px solid rgba(255,255,255,0.05);
}
.knob-indicator {
  position: absolute; width: 2px; height: 9px;
  background: var(--text); top: 3px; left: 50%;
  transform-origin: bottom center; transform: translateX(-50%);
  border-radius: 1px;
}
.knob-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--micro); text-align: center;
}
.knob-value {
  font-size: 8px; color: var(--muted);
  font-variant-numeric: tabular-nums;
}

/* Meters — VU Meter Style */
.meter-group {
  display: flex; gap: 1px; justify-content: center;
  height: 50px; align-items: flex-end;
  background: rgba(3,5,9,0.5);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  padding: 3px;
}
.meter-bar {
  width: 3px; background: var(--accent-green);
  transition: height 0.08s;
  border-radius: 1px 1px 0 0;
  position: relative;
}
.meter-bar .peak-hold {
  position: absolute; top: -2px; left: 0; right: 0;
  height: 1px; background: var(--text-bright);
  opacity: 0.6;
}

/* Channel Meters — per track mini VU */
.channel-meters {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;
  padding: 4px 0;
}
.channel-meter {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
}
.channel-meter-bar {
  width: 100%; height: 4px;
  background: rgba(3,5,9,0.5);
  border: 1px solid var(--glass-border);
  border-radius: 2px;
  overflow: hidden;
}
.channel-meter-fill {
  height: 100%;
  background: var(--accent-green);
  transition: width 0.08s;
}
.channel-meter-label {
  font-size: 6px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* Clip playback progress overlay */
.clip .clip-progress {
  position: absolute; top: 0; left: 0; bottom: 0;
  background: rgba(255,255,255,0.06);
  pointer-events: none; width: 0;
  border-right: 1px solid rgba(255,255,255,0.15);
}

/* Active track highlight */
.track.track-active {
  background: rgba(59, 130, 246, 0.04) !important;
}
.track.track-active .track-header {
  border-right-color: rgba(59, 130, 246, 0.3);
}
.track.track-active .track-header::before {
  box-shadow: 0 0 8px currentColor;
}

/* Empty Timeline State */
.timeline-empty {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center; pointer-events: none;
  z-index: 5; opacity: 1;
  transition: opacity 0.3s;
}
.timeline-empty.hidden { opacity: 0; pointer-events: none; }
.timeline-empty-icon {
  font-size: 32px; opacity: 0.1; margin-bottom: 12px;
  line-height: 1;
}
.timeline-empty-title {
  font-size: 12px; font-weight: 600; color: var(--text-secondary);
  margin-bottom: 6px; letter-spacing: 0.05em;
}
.timeline-empty-desc {
  font-size: 9px; color: var(--micro); max-width: 280px;
  line-height: 1.6; letter-spacing: 0.03em;
}
.timeline-empty-steps {
  display: flex; gap: 24px; margin-top: 16px; justify-content: center;
}
.timeline-empty-step {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.timeline-empty-step-num {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; color: var(--muted);
  background: var(--glass);
}
.timeline-empty-step-text {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.1em;
  max-width: 60px; text-align: center;
}
@keyframes emptyPulse {
  0%, 100% { opacity: 0.08; }
  50% { opacity: 0.15; }
}
.timeline-empty-icon { animation: emptyPulse 3s ease-in-out infinite; }

/* Right Panel Tabs */
.panel-tabs {
  display: flex; border-bottom: 1px solid var(--border);
  background: rgba(10,14,26,0.6);
  flex-shrink: 0;
}
.panel-tab {
  flex: 1; padding: 6px 0;
  font-size: 8px; font-weight: 600; font-family: 'Sora', sans-serif;
  text-transform: uppercase; letter-spacing: 0.12em;
  background: none; border: none; border-bottom: 2px solid transparent;
  color: var(--micro); cursor: pointer;
  transition: color 0.2s, border-color 0.2s, background 0.2s;
}
.panel-tab:hover { color: var(--text-secondary); background: var(--glass); }
.panel-tab.active {
  color: var(--text); border-bottom-color: var(--blue);
}
.panel-tab-content { display: none; opacity: 0; }
.panel-tab-content.active { display: block; opacity: 1; animation: panelFadeIn 0.15s ease; }
@keyframes panelFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* Custom Clip Tooltip */
.clip-tip {
  position: fixed; z-index: 300;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  padding: 8px 12px;
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--text); pointer-events: none;
  box-shadow: var(--shadow-deep);
  white-space: nowrap;
  opacity: 0; transition: opacity 0.15s;
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.clip-tip.show { opacity: 1; }
.clip-tip-name {
  font-weight: 600; font-size: 10px;
  margin-bottom: 3px; letter-spacing: 0.02em;
}
.clip-tip-detail {
  font-size: 8px; color: var(--text-secondary);
  display: flex; gap: 8px; letter-spacing: 0.03em;
}
.clip-tip-detail span { color: var(--muted); }

/* Track Header Context Menu */
.track-ctx {
  position: fixed; z-index: 200;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  min-width: 140px; padding: 4px 0;
  box-shadow: var(--shadow-deep);
  font-family: 'Sora', sans-serif;
  border-radius: var(--radius-md);
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.track-ctx.open { display: block; }
.track-ctx-item {
  padding: 6px 14px; font-size: 9px;
  color: var(--text-secondary); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.06em;
  transition: background 0.1s, color 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.track-ctx-item:hover { background: rgba(59,130,246,0.08); color: var(--text); }
.track-ctx-item.danger { color: var(--error); }
.track-ctx-item.danger:hover { background: rgba(239,68,68,0.08); }
.track-ctx-sep { height: 1px; background: rgba(255,255,255,0.04); margin: 3px 4px; }

/* Snap grid indicator */
.snap-indicator {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: rgba(59, 130, 246, 0.3);
  pointer-events: none; z-index: 15;
  opacity: 0; transition: opacity 0.1s;
}
.snap-indicator.visible { opacity: 1; }

/* Inspector — Properties Panel */
.inspector-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--blue);
  position: relative;
}
.inspector-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, rgba(59,130,246,0.1), transparent 80%);
}
.inspector-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--blue); margin-bottom: 8px;
}
.inspector-field { margin-bottom: 6px; }
.inspector-field label {
  display: block; font-size: 8px;
  color: var(--micro); text-transform: uppercase;
  letter-spacing: 0.15em; margin-bottom: 3px;
}
.inspector-field .value { font-size: 11px; color: var(--text); }
.inspector-field input, .inspector-field select {
  width: 100%; padding: 5px 8px;
  font-size: 11px; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border); color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
  border-radius: var(--radius-sm);
}
.inspector-field input:focus, .inspector-field select:focus {
  outline: none; border-color: rgba(59,130,246,0.3); box-shadow: 0 0 8px rgba(59,130,246,0.1);
}
.inspector-tags { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 6px; }
.inspector-tag {
  font-size: 8px; padding: 2px 6px;
  background: var(--glass); border: 1px solid var(--glass-border);
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 0.08em;
  border-radius: var(--radius-sm);
}

/* Music Player — Minimal Waveform Style */
.music-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--accent-green);
  position: relative;
}
.music-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, rgba(34,197,94,0.1), transparent 80%);
}
.music-now-playing {
  font-size: 10px; color: var(--text-secondary);
  margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
}
.music-now-playing .eq { display: flex; gap: 1px; align-items: flex-end; height: 10px; }
.music-now-playing .eq span { width: 2px; background: var(--accent-green); animation: eqBounce 0.8s ease-in-out infinite alternate; }
.music-now-playing .eq span:nth-child(2) { animation-delay: 0.2s; }
.music-now-playing .eq span:nth-child(3) { animation-delay: 0.4s; }
@keyframes eqBounce { 0% { height: 2px; } 100% { height: 10px; } }
.music-controls { display: flex; gap: 2px; align-items: center; }
.music-btn {
  width: 26px; height: 26px;
  background: rgba(3,5,9,0.4); border: 1px solid var(--glass-border);
  color: var(--muted); cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Sora', sans-serif;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
  border-radius: var(--radius-sm);
}
.music-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.music-btn.playing { background: var(--accent-green); color: var(--bg); border-color: var(--accent-green); }
.music-volume {
  width: 60px; height: 2px; margin-left: 4px;
  -webkit-appearance: none; appearance: none;
  background: var(--border); outline: none; cursor: pointer;
}
.music-volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 8px; height: 8px;
  background: var(--accent-green); border-radius: 50%; cursor: pointer;
}

/* Export Button */
.export-btn {
  padding: 7px 12px;
  background: var(--glass); border: 1px solid var(--glass-border);
  color: var(--text-secondary); font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  cursor: pointer; width: 100%;
  transition: color 0.15s, border-color 0.15s, background 0.15s, box-shadow 0.15s;
  border-radius: var(--radius-sm);
}
.export-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); box-shadow: var(--shadow-soft); }

/* ===== FOOTER — Status Bar ===== */
.footer {
  background: rgba(10,14,26,0.8);
  border-top: 1px solid var(--border);
  padding: 0 16px;
  display: flex; align-items: center; justify-content: space-between;
  font-size: 9px; color: var(--micro);
  letter-spacing: 0.03em;
  height: 24px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  position: relative;
}
.footer::before {
  content: '';
  position: absolute; top: 0; left: 5%; right: 5%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
}
.status-item { display: flex; align-items: center; gap: 4px; }
.status-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--accent-green);
  box-shadow: 0 0 4px rgba(34,197,94,0.3);
  transition: background 0.2s, box-shadow 0.2s;
}
.status-dot.playing {
  background: var(--accent-blue);
  box-shadow: 0 0 6px rgba(59,130,246,0.4);
  animation: bpmBreath var(--bpm-duration, 0.5s) ease-out infinite;
}
.status-dot.recording {
  background: var(--accent-red);
  box-shadow: 0 0 6px rgba(239,68,68,0.4);
  animation: recPulse 1s ease-in-out infinite;
}
.footer-quote { font-style: italic; opacity: 0.3; letter-spacing: 0.05em; font-size: 8px; }

/* Global Range Inputs — Pro DAW sliders */
input[type="range"] {
  -webkit-appearance: none; appearance: none;
  height: 3px; background: var(--border); outline: none;
  cursor: pointer; border-radius: 1px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 10px; height: 10px;
  background: var(--text-secondary);
  border-radius: 50%; cursor: pointer;
  border: 1px solid var(--border);
  transition: background 0.15s, transform 0.1s;
}
input[type="range"]::-webkit-slider-thumb:hover {
  background: var(--text); transform: scale(1.2);
}
input[type="range"]:focus::-webkit-slider-thumb {
  background: var(--blue); border-color: var(--blue);
}

/* Global Number Inputs — DAW Style */
input[type="number"] {
  -moz-appearance: textfield;
  font-variant-numeric: tabular-nums;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  opacity: 0; height: 100%;
}
input[type="number"]:hover::-webkit-inner-spin-button,
input[type="number"]:hover::-webkit-outer-spin-button {
  opacity: 0.4;
}

/* Track solo/mute state indicators */
.track.track-muted .track-header { opacity: 0.4; }
.track.track-muted .track-name { text-decoration: line-through; }

/* Snap indicator in transport */
.snap-badge {
  font-size: 7px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; padding: 2px 6px;
  border-radius: var(--radius-sm); color: var(--micro);
  background: transparent; border: 1px solid transparent;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
}
.snap-badge.active {
  color: var(--accent-cyan); background: rgba(6,182,212,0.1);
  border-color: rgba(6,182,212,0.2);
}

/* Focus visible for keyboard accessibility */
:focus-visible {
  outline: 1px solid var(--blue);
  outline-offset: 1px;
}
button:focus-visible, .transport-btn:focus-visible {
  outline: 1px solid var(--blue);
  outline-offset: -1px;
}

/* Rubber band selection box */
.select-box {
  position: absolute; z-index: 30;
  border: 1px solid rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  pointer-events: none;
  border-radius: 1px;
}

/* Solo track highlight — non-soloed tracks dim when any is soloed */
.track-btn.soloed ~ .track-btn { opacity: 0.5; }
.track.track-soloed .track-header::before {
  box-shadow: 0 0 10px var(--accent-cyan);
}
.track.track-soloed .track-header {
  background: rgba(6,182,212,0.06);
}
/* Dim non-soloed tracks when solo is active */
.track:not(.track-soloed) { transition: opacity 0.2s, filter 0.2s; }
.timeline-tracks.has-solo .track:not(.track-soloed) {
  opacity: 0.35; filter: saturate(0.4);
}
.timeline-tracks.has-solo .track.track-soloed {
  opacity: 1; filter: none;
}

/* Active track — left accent glow when selected via number key or header click */
.track.track-active .track-header {
  border-left: 2px solid var(--accent-blue);
  background: rgba(59,130,246,0.04);
}
.track.track-active .track-content {
  background: rgba(59,130,246,0.015);
}

/* Marquee rubber-band selection */
.marquee-selection {
  position: absolute;
  border: 1px solid rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  border-radius: var(--radius-sm);
  pointer-events: none;
  z-index: 20;
}

/* Snap line flash */
@keyframes snapFlash {
  0% { opacity: 0.6; }
  100% { opacity: 0; }
}
.snap-line {
  position: absolute;
  top: 0; bottom: 0;
  width: 1px;
  background: var(--accent-blue);
  pointer-events: none;
  z-index: 15;
  animation: snapFlash 0.3s ease-out forwards;
}

/* Clip overlap warning — pulsing border when clips overlap */
.clip.clip-overlap {
  border: 1px solid rgba(239,68,68,0.4);
  box-shadow: inset 0 0 6px rgba(239,68,68,0.1);
}

/* Clip shimmer — animated gradient sweep on playing clips */
@keyframes clipShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}
.clip.clip-playing::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
  animation: clipShimmer 2s ease-in-out infinite;
  pointer-events: none; z-index: 1;
}

/* Track resize handle — drag between tracks */
.track-resize-handle {
  height: 3px; cursor: ns-resize;
  background: transparent;
  position: relative; z-index: 5;
  transition: background 0.15s;
}
.track-resize-handle:hover {
  background: rgba(59,130,246,0.15);
}
.track-resize-handle::after {
  content: '';
  position: absolute; left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  width: 20px; height: 1px;
  background: rgba(255,255,255,0.08);
  border-radius: 1px;
  opacity: 0;
  transition: opacity 0.15s;
}
.track-resize-handle:hover::after { opacity: 1; }

/* Focus mode — hide panels for full-width timeline */
.panel-left, .panel-right { transition: width 0.2s, opacity 0.2s, padding 0.2s; }
.main.focus-mode .panel-left { width: 0; overflow: hidden; opacity: 0; padding: 0; border: none; }
.main.focus-mode .panel-right { width: 0; overflow: hidden; opacity: 0; padding: 0; border: none; }
.main.focus-mode { grid-template-columns: 0fr 1fr 0fr; }
.focus-indicator {
  display: none; position: fixed; top: 44px; right: 8px;
  font-size: 7px; color: var(--accent-cyan); background: rgba(6,182,212,0.1);
  border: 1px solid rgba(6,182,212,0.2); padding: 2px 8px;
  border-radius: var(--radius-sm); z-index: 60;
  text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer;
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
}
.focus-indicator.visible { display: block; }

/* ===== COMMAND PALETTE ===== */
.cmd-palette {
  display: none; position: fixed; inset: 0; z-index: 250;
  background: rgba(3, 5, 9, 0.7); align-items: flex-start;
  justify-content: center; padding-top: 20vh;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.cmd-palette.open { display: flex; }
.cmd-palette-box {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  width: 90%; max-width: 420px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
  border-radius: var(--radius-lg); overflow: hidden;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.cmd-palette-input {
  width: 100%; padding: 14px 18px;
  background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.06);
  color: var(--text); font-family: 'Sora', sans-serif;
  font-size: 13px; outline: none;
}
.cmd-palette-input::placeholder { color: var(--micro); }
.cmd-palette-results {
  max-height: 280px; overflow-y: auto;
  padding: 4px 0;
}
.cmd-result {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 16px; cursor: pointer;
  transition: background 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.cmd-result:hover, .cmd-result.active {
  background: rgba(59, 130, 246, 0.06);
}
.cmd-result-icon {
  width: 20px; text-align: center;
  font-size: 10px; color: var(--muted);
}
.cmd-result-text {
  font-size: 11px; color: var(--text);
}
.cmd-result-key {
  margin-left: auto; font-size: 8px;
  color: var(--micro); letter-spacing: 0.08em;
}

/* ===== TOAST — Notification ===== */
.toast {
  position: fixed; bottom: 36px; right: 16px;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.06);
  border-left: 2px solid var(--blue);
  color: var(--text-secondary); padding: 8px 14px;
  font-size: 10px; z-index: 200;
  text-transform: uppercase; letter-spacing: 0.08em;
  opacity: 0; transition: opacity 0.2s;
  pointer-events: none; font-family: 'Sora', sans-serif;
  box-shadow: var(--shadow-deep);
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.toast.show { opacity: 1; }
@media(prefers-reduced-motion:reduce) {
  .music-now-playing .eq span { animation: none; height: 6px; }
  .preset-card:hover { transform: none; }
  .clip { animation: none; }
  .clip.clip-playing::before { animation: none; }
  .bpm-pulse { animation: none; opacity: 0.5; }
  .track-btn.armed { animation: none; }
  @keyframes emptyPulse { 0%, 100% { opacity: 0.1; } }
  @keyframes panelFadeIn { from, to { opacity: 1; transform: none; } }
  .snap-line { animation: none; }
  .toast { transition: none; }
  .playhead { transition: none; }
  .cmd-palette { backdrop-filter: none; }
  .saved-modal { backdrop-filter: none; }
  .shortcuts-overlay { backdrop-filter: none; }
}

/* ===== TABLET (768px) ===== */
@media(max-width:768px) {
  .app { grid-template-rows: 36px 1fr 22px; }
  .main { grid-template-columns: 160px 1fr 220px; }
  .header { padding: 0 10px; }
  .logo-text { font-size: 10px; }
  .nav-btn { padding: 4px 8px; font-size: 8px; }
  .nav-sep { display: none; }
  .transport { padding: 4px 10px; height: 40px; }
  .time-display { font-size: 16px; min-width: 100px; }
  .bpm-input { width: 44px; font-size: 12px; }
  .fader-track { height: 60px; }
  .knob-dial { width: 28px; height: 28px; }
  .knob-indicator { height: 7px; }
  .preset-card { min-width: 130px; padding: 8px; }
}

/* ===== MOBILE (480px) ===== */
@media(max-width:480px) {
  .app { grid-template-rows: 36px 1fr 20px; }
  .main { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .panel-left { max-height: 180px; border-right: none; border-bottom: 1px solid var(--border); }
  .panel-right { border-left: none; border-top: 1px solid var(--border); max-height: 240px; }
  .header { padding: 0 8px; }
  .header-nav { gap: 0; overflow-x: auto; }
  .nav-btn { padding: 4px 6px; font-size: 7px; min-height: 32px; white-space: nowrap; }
  .nav-sep { display: none; }
  .logo-text { font-size: 9px; }
  .logo-sub { display: none; }
  .transport { height: auto; padding: 4px 8px; flex-wrap: wrap; }
  .transport-btn { width: 34px; height: 34px; font-size: 13px; min-height: 40px; }
  .music-btn { width: 32px; height: 32px; min-height: 40px; }
  .track-header { width: 70px; padding: 4px 6px; }
  .track-name { font-size: 8px; padding-left: 4px; }
  .track-info { display: none; }
  .fader-group { gap: 6px; }
  .fader-track { height: 50px; }
  .preset-card { min-width: 120px; padding: 8px; }
  .presets-drawer { padding: 8px 10px; }
  .shortcuts-panel { width: 280px; }
}

/* ===== SAVED WORKOUTS MODAL ===== */
.saved-modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(3, 5, 9, 0.7); align-items: center; justify-content: center;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.saved-modal.open { display: flex; }
.saved-modal-content {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.saved-modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 14px; border-bottom: 1px solid var(--border);
}
.saved-modal-header h3 {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--text-secondary);
}
.saved-modal-close {
  background: transparent; border: 1px solid transparent;
  color: var(--micro); cursor: pointer; font-size: 14px;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.saved-modal-close:hover { color: var(--text); }
.saved-item {
  padding: 10px 14px; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: background 0.15s;
}
.saved-item:hover {
  background: var(--glass);
}
.saved-item-name { font-size: 11px; font-weight: 600; }
.saved-item-info {
  font-size: 8px; color: var(--micro); margin-top: 3px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.saved-item-delete {
  float: right; font-size: 8px; color: var(--micro);
  cursor: pointer; padding: 2px 6px;
  border: none; background: none;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.1s;
}
.saved-item-delete:hover { color: var(--accent-red); }
.saved-empty {
  text-align: center; padding: 28px; color: var(--micro);
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== PRESETS DRAWER ===== */
.presets-drawer {
  display: none; position: absolute; top: 40px; left: 0; right: 0;
  background: rgba(10,14,26,0.95);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7);
  z-index: 50; padding: 12px 16px;
  opacity: 0; transform: translateY(-8px);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.presets-drawer.open {
  display: flex; gap: 8px; flex-wrap: wrap;
  opacity: 1; transform: translateY(0);
  animation: drawerSlide 0.15s ease-out;
}
@keyframes drawerSlide {
  0% { opacity: 0; transform: translateY(-8px); }
  100% { opacity: 1; transform: translateY(0); }
}
.preset-card {
  flex: 1; min-width: 140px; max-width: 200px;
  padding: 10px;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s, box-shadow 0.15s, transform 0.15s;
  border-radius: var(--radius-md);
}
.preset-card:hover {
  border-color: rgba(255,255,255,0.1);
  background: rgba(255,255,255,0.03);
  box-shadow: var(--shadow-soft);
  transform: translateY(-1px);
}
.preset-card .pc-name {
  font-size: 11px; font-weight: 600; margin-bottom: 2px;
}
.preset-card .pc-bpm {
  font-size: 9px; color: var(--accent-orange);
  font-variant-numeric: tabular-nums;
}
.preset-card .pc-desc {
  font-size: 8px; color: var(--micro); margin-top: 4px;
  line-height: 1.4;
}
.preset-card .pc-mode {
  font-size: 7px; padding: 2px 8px;
  display: inline-block; margin-top: 6px;
  text-transform: uppercase; letter-spacing: 0.08em;
  border-radius: var(--radius-sm);
}

/* ===== CONTEXT MENU — Endel/Craft Right-Click ===== */
.clip-context-menu {
  position: fixed; z-index: 250;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  box-shadow: var(--shadow-deep);
  min-width: 160px;
  border-radius: var(--radius-md);
  padding: 4px 0;
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.clip-context-menu.open { display: block; }
.ctx-item {
  padding: 6px 14px; font-size: 10px;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s, color 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.ctx-item:hover { background: rgba(59,130,246,0.08); color: var(--text); }
.ctx-item .ctx-key {
  font-size: 8px; color: var(--micro);
  margin-left: 16px;
}
.ctx-sep { height: 1px; background: rgba(255,255,255,0.04); margin: 3px 4px; }
.ctx-item.danger:hover { background: rgba(239,68,68,0.08); color: var(--accent-red); }

/* ===== PLAYHEAD GLOW ANIMATION ===== */
@keyframes playheadPulse {
  0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.4); }
  50% { box-shadow: 0 0 14px rgba(255,255,255,0.6); }
}
.playhead.playing {
  animation: playheadPulse 1s ease-in-out infinite;
}

/* ===== RECORDING PULSE ===== */
@keyframes recPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.transport-btn.rec.active {
  animation: recPulse 1s ease-in-out infinite;
}

/* ===== SHORTCUTS OVERLAY — Endel/Craft Style ===== */
.shortcuts-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(3,5,9,0.6);
  align-items: center; justify-content: center;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.shortcuts-overlay.open { display: flex; }
.shortcuts-panel {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  padding: 18px 22px; width: 320px;
  border-radius: var(--radius-lg);
  box-shadow: 0 25px 80px rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.shortcuts-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 14px;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-secondary);
}
.shortcuts-grid { display: flex; flex-direction: column; gap: 6px; }
.shortcut-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 0;
}
.shortcut-item kbd {
  font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  background: rgba(3,5,9,0.5); border: 1px solid rgba(255,255,255,0.08);
  padding: 3px 8px; color: var(--text);
  border-radius: var(--radius-sm);
  min-width: 28px; text-align: center;
}
.shortcut-item span {
  font-size: 10px; color: var(--muted);
}

/* ===== MARKERS ===== */
.marker {
  position: absolute; z-index: 15;
  top: 0; cursor: pointer;
}
.marker-flag {
  width: auto; min-width: 8px; height: 14px;
  background: var(--accent-orange);
  padding: 0 4px;
  font-size: 7px; font-weight: 600;
  color: var(--bg); display: flex; align-items: center;
  white-space: nowrap; border-radius: 0 2px 2px 0;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.marker-line {
  width: 1px; height: 100%;
  background: var(--accent-orange); opacity: 0.3;
  position: absolute; top: 14px; left: 0;
}
.marker:hover .marker-flag { filter: brightness(1.2); }

/* ===== LOOP REGION ===== */
.loop-region {
  position: absolute; top: 0; bottom: 0;
  background: rgba(59, 130, 246, 0.06);
  border-left: 1px solid rgba(59, 130, 246, 0.4);
  border-right: 1px solid rgba(59, 130, 246, 0.4);
  z-index: 5; pointer-events: none;
  display: none;
}
.loop-region.active { display: block; }
.loop-region::before, .loop-region::after {
  content: '';
  position: absolute; top: 0;
  width: 6px; height: 6px;
  background: rgba(59, 130, 246, 0.6);
  border-radius: 0 0 2px 2px;
}
.loop-region::before { left: -3px; }
.loop-region::after { right: -3px; }

/* ===== SCROLLBAR — Craft Style (barely visible) ===== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.06);
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.12); }
::-webkit-scrollbar-corner { background: transparent; }
.timeline-container::-webkit-scrollbar { height: 6px; }
.timeline-container::-webkit-scrollbar-track { background: transparent; }
.timeline-container::-webkit-scrollbar-thumb {
  background: rgba(59,130,246,0.12);
  border-radius: 3px;
}
.timeline-container::-webkit-scrollbar-thumb:hover {
  background: rgba(59,130,246,0.25);
}
.panel-left::-webkit-scrollbar-track { background: var(--surface); }
.panel-right::-webkit-scrollbar-track { background: var(--surface); }

/* ===== FOCUS / SELECTION ===== */
a:focus-visible, button:focus-visible, input:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.6);
  outline-offset: 2px;
}
::selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
::-moz-selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-progress" id="header-progress"></div>
    <div class="logo">
      <div class="logo-icon"><img src="assets/planet-logo.png" alt="" onerror="this.style.display='none'"></div>
      <div>
        <div class="logo-text">SATURNO MOVEMENT STUDIO</div>
        <div class="logo-sub">The Ableton of Movement</div>
      </div>
    </div>
    <nav class="header-nav">
      <button class="nav-btn" id="btn-presets" onclick="togglePresets()">PRESETS</button>
      <button class="nav-btn" onclick="clearTimeline()">CLEAR</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="saveNamedWorkout()">SAVE</button>
      <button class="nav-btn" onclick="showSavedWorkouts()">LOAD</button>
      <button class="nav-btn" onclick="exportWorkout()">EXPORT</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" id="btn-snap" onclick="toggleSnap()">SNAP</button>
      <button class="nav-btn" id="btn-video" onclick="toggleVideo()">VID</button>
      <button class="nav-btn" onclick="toggleMusic()">MUS</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="undo()" title="Undo (Cmd+Z)" style="font-size:11px">&#8617;</button>
      <button class="nav-btn" onclick="redo()" title="Redo (Cmd+Shift+Z)" style="font-size:11px">&#8618;</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="toggleShortcuts()" title="Keyboard shortcuts (?)" style="font-size:10px;font-weight:700">?</button>
    </nav>
  </header>

  <!-- PRESETS DRAWER -->
  <div class="presets-drawer" id="presets-drawer">
    <div class="preset-card" onclick="loadPreset('monk')">
      <div class="pc-name">Monk Mode</div>
      <div class="pc-bpm">65 BPM</div>
      <div class="pc-desc">Meditative, slow, precise. Breath-led reps.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('beast')">
      <div class="pc-name">Beast Mode</div>
      <div class="pc-bpm">140 BPM</div>
      <div class="pc-desc">High intensity, explosive power.</div>
      <div class="pc-mode" style="background:rgba(239,68,68,0.2);color:#ef4444">Flow / Conditioning</div>
    </div>
    <div class="preset-card" onclick="loadPreset('flow')">
      <div class="pc-name">Flow Ritual</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Continuous movement, fluid transitions.</div>
      <div class="pc-mode" style="background:rgba(139,92,246,0.2);color:#8b5cf6">Standard Tempo</div>
    </div>
    <div class="preset-card" onclick="loadPreset('skill')">
      <div class="pc-name">Skill Ascension</div>
      <div class="pc-bpm">75 BPM</div>
      <div class="pc-desc">Technical practice, isometric holds.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('upper')">
      <div class="pc-name">Upper Day</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Push/Pull balanced upper body split.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('lower')">
      <div class="pc-name">Lower Day</div>
      <div class="pc-bpm">90 BPM</div>
      <div class="pc-desc">Squat patterns, hip hinges, mobility.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('ppl')">
      <div class="pc-name">Push / Pull / Legs</div>
      <div class="pc-bpm">110 BPM</div>
      <div class="pc-desc">Classic 3-way split, all patterns hit.</div>
      <div class="pc-mode" style="background:rgba(249,115,22,0.2);color:#f97316">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('fullbody')">
      <div class="pc-name">Full Body</div>
      <div class="pc-bpm">105 BPM</div>
      <div class="pc-desc">One compound per pattern, total coverage.</div>
      <div class="pc-mode" style="background:rgba(236,72,153,0.2);color:#ec4899">Standard</div>
    </div>
    <div class="preset-card" onclick="generateRandom()" style="border:1px dashed var(--border)">
      <div class="pc-name" style="color:var(--accent-cyan)">Random</div>
      <div class="pc-bpm" style="color:var(--accent-cyan)">? BPM</div>
      <div class="pc-desc">Auto-generate a random balanced workout.</div>
      <div class="pc-mode" style="background:rgba(6,182,212,0.2);color:#06b6d4">Surprise</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Movement Library -->
    <aside class="panel-left">
      <div class="panel-header"><span>Movement Library</span><span id="lib-count">0</span></div>
      <input type="text" class="lib-search" id="lib-search" placeholder="Search movements... (Enter to add)" oninput="filterLibrary()" onkeydown="if(event.key==='Enter')addFirstMatch()">
      <div id="library-container"></div>
    </aside>

    <!-- CENTER: Transport + Video + Timeline -->
    <section class="panel-center">
      <!-- Transport -->
      <div class="transport">
        <div class="transport-buttons">
          <button class="transport-btn" onclick="rewind()" title="Rewind 15s">&#9198;</button>
          <button class="transport-btn" id="play-btn" onclick="togglePlay()" title="Play / Pause">&#9654;</button>
          <button class="transport-btn" onclick="stopPlayback()" title="Stop">&#9632;</button>
          <button class="transport-btn" onclick="forward()" title="Forward 15s">&#9197;</button>
          <button class="transport-btn rec" id="rec-btn" onclick="toggleRec()" title="Record" style="border-radius:0 3px 3px 0">&#9679;</button>
        </div>
        <span id="playback-state" style="font-size:7px;font-weight:700;text-transform:uppercase;letter-spacing:0.15em;color:var(--micro);min-width:30px;text-align:center">STOP</span>
        <span class="snap-badge" id="snap-badge" onclick="toggleSnap()" title="Snap to grid (S)">SNAP</span>
        <div class="transport-sep"></div>
        <div class="transport-buttons">
          <button class="transport-btn" id="metro-btn" onclick="toggleMetronome()" title="Metronome" style="font-size:8px;letter-spacing:0.04em;border-radius:3px 0 0 3px;width:auto;padding:0 8px">MET</button>
          <button class="transport-btn" id="loop-btn" onclick="toggleLoop()" title="Loop region (L)" style="font-size:8px;letter-spacing:0.04em;border-radius:0 3px 3px 0;width:auto;padding:0 8px;border-left:none">LOOP</button>
        </div>
        <div class="time-display" id="time-display">
          <span class="td-seg" id="td-min">00</span><span class="td-colon">:</span><span class="td-seg" id="td-sec">00</span><span class="td-colon">:</span><span class="td-seg td-ms" id="td-ms">00</span>
        </div>
        <div id="bars-display" style="font-size:10px;font-weight:600;color:var(--muted);padding:0 6px;font-variant-numeric:tabular-nums;min-width:50px;text-align:center">1.1.1</div>
        <div id="beat-indicator" style="display:flex;gap:2px;padding:0 4px" title="Beat position">
          <div class="beat-dot" id="beat-1" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-2" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-3" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-4" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
        </div>
        <div class="bpm-section">
          <span class="bpm-label">BPM</span>
          <div class="bpm-pulse" id="bpm-pulse" title="Tempo pulse"></div>
          <input type="number" class="bpm-input" id="bpm-input" value="120" min="40" max="200" onchange="updateBPM()">
          <span class="bpm-mode" id="bpm-mode">Standard</span>
          <span class="tempo-link" id="tempo-link" onclick="toggleTempoLink()" title="Link BPM to exercise tempo">LINK</span>
          <span class="tempo-link" id="tap-tempo" onclick="tapTempo()" title="Tap rhythm to set BPM (or press T)">TAP</span>
          <span id="time-sig" style="font-size:8px;font-weight:700;color:var(--micro);padding:0 4px;letter-spacing:0.04em;cursor:pointer;font-variant-numeric:tabular-nums" onclick="cycleTimeSig()" title="Time signature">4/4</span>
          <div class="transport-sep"></div>
          <span class="bpm-label">Zoom</span>
          <button class="transport-btn" onclick="zoomOut()" title="Zoom out" style="width:22px;height:22px;font-size:10px;border-radius:2px">-</button>
          <span id="zoom-level" style="font-size:8px;color:var(--muted);min-width:28px;text-align:center">100%</span>
          <button class="transport-btn" onclick="zoomIn()" title="Zoom in" style="width:22px;height:22px;font-size:10px;border-radius:2px">+</button>
          <button class="transport-btn" onclick="zoomToFit()" title="Zoom to fit all clips" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em">FIT</button>
        </div>
      </div>

      <!-- Video (collapsible) -->
      <div class="video-section" id="video-section">
        <div class="video-placeholder" id="video-placeholder">
          <div class="vp-icon">&#9654;</div>
          <span>Drop video here or click to load</span>
          <span style="font-size:9px;opacity:0.5">Landscape video plays in sync with timeline</span>
        </div>
        <video id="studio-video" style="width:100%;height:100%;object-fit:contain;display:none" controls></video>
        <button class="video-toggle" onclick="toggleVideo()" title="Toggle video">&#9660;</button>
      </div>

      <!-- Timeline -->
      <div class="timeline-container" id="timeline-container">
        <div class="timeline-ruler" id="timeline-ruler"></div>
        <div class="timeline-minimap" id="timeline-minimap"><div class="minimap-viewport" id="minimap-viewport"></div></div>
        <div class="timeline-tracks" id="timeline-tracks">
          <div class="loop-region" id="loop-region"></div>
          <div class="playhead" id="playhead"></div>
          <div class="timeline-empty" id="timeline-empty">
            <div class="timeline-empty-icon">&#9835;</div>
            <div class="timeline-empty-title">Compose Your Movement</div>
            <div class="timeline-empty-desc">Drag exercises from the library onto any track to begin building your workout.</div>
            <div class="timeline-empty-steps">
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">1</div><div class="timeline-empty-step-text">Browse the library</div></div>
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">2</div><div class="timeline-empty-step-text">Drag to track or double-click</div></div>
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">3</div><div class="timeline-empty-step-text">Press space to play</div></div>
            </div>
          </div>
          <div class="snap-indicator" id="snap-indicator"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Mixer + Inspector + Music -->
    <aside class="panel-right">
      <div class="panel-tabs">
        <button class="panel-tab active" data-tab="mixer" onclick="switchPanelTab('mixer')">Mixer</button>
        <button class="panel-tab" data-tab="inspector-tab" onclick="switchPanelTab('inspector-tab')">Inspector</button>
        <button class="panel-tab" data-tab="settings" onclick="switchPanelTab('settings')">Settings</button>
      </div>

      <!-- MIXER TAB -->
      <div class="panel-tab-content active" id="tab-mixer">
        <!-- Meter -->
        <div class="mixer-section">
          <div class="mixer-title">Output</div>
          <div class="meter-group" id="meters"></div>
          <div class="channel-meters" id="channel-meters" style="margin-top:6px"></div>
        </div>

        <!-- Faders -->
        <div class="mixer-section">
          <div class="mixer-title">Master Faders</div>
          <div class="fader-group" id="fader-group"></div>
        </div>

        <!-- Knobs -->
        <div class="mixer-section">
          <div class="mixer-title">Blend Controls</div>
          <div class="knob-group" id="knob-group"></div>
        </div>
      </div>

      <!-- INSPECTOR TAB -->
      <div class="panel-tab-content" id="tab-inspector-tab">
      <!-- Inspector -->
      <div class="inspector-section" id="inspector" style="display:none">
        <div class="inspector-title">Exercise DNA</div>
        <div class="inspector-field"><label>Movement</label><div class="value" id="insp-name">-</div></div>
        <div class="inspector-field"><label>Pattern</label><div class="value" id="insp-pattern">-</div></div>
        <div class="inspector-field"><label>Stage</label><div class="value" id="insp-stage">-</div></div>
        <div class="inspector-field"><label>Discipline</label><div class="value" id="insp-discipline">-</div></div>
        <div class="inspector-field">
          <label>Sets x Reps</label>
          <div style="display:flex;gap:4px">
            <input type="number" id="insp-sets" value="3" min="1" max="10" style="width:40px" onchange="updateClipDNA()">
            <span style="color:var(--micro);font-size:11px">x</span>
            <input type="number" id="insp-reps" value="8" min="1" max="50" style="width:40px" onchange="updateClipDNA()">
          </div>
        </div>
        <div class="inspector-field"><label>Tempo (seconds per rep)</label><input type="number" id="insp-tempo" value="3" min="1" max="20" step="0.5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>Rest (seconds)</label><input type="number" id="insp-rest" value="60" min="0" max="300" step="5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>RPE (1-10)</label><input type="range" id="insp-rpe" min="1" max="10" value="7" style="width:100%" oninput="updateClipDNA()"></div>
        <div class="inspector-tags" id="insp-tags"></div>
      </div>
      <div class="mixer-section" id="inspector-empty" style="padding:30px 14px;text-align:center">
        <div style="font-size:9px;color:var(--micro);text-transform:uppercase;letter-spacing:0.1em">Select a clip to inspect</div>
        <div style="font-size:7px;color:var(--micro);margin-top:4px;opacity:0.5">Click a clip on the timeline or press Tab</div>
      </div>

      <!-- Music -->
      <div class="music-section" id="music-panel" style="display:none">
        <div class="mixer-title">Music</div>
        <div class="music-now-playing" id="music-np">
          <div class="eq" id="music-eq" style="display:none"><span></span><span></span><span></span></div>
          <span id="music-track-name">No track</span>
        </div>
        <div class="music-controls">
          <button class="music-btn" onclick="musicPrev()" title="Previous">&#9198;</button>
          <button class="music-btn" id="music-play-btn" onclick="musicToggle()" title="Play/Pause">&#9654;</button>
          <button class="music-btn" onclick="musicNext()" title="Next">&#9197;</button>
          <input type="range" class="music-volume" min="0" max="100" value="50" oninput="musicVolume(this.value)">
        </div>
      </div>

      <!-- Workout Summary — KPI Style -->
      <div class="mixer-section" id="workout-summary" style="display:none;border-left:2px solid var(--accent-purple)">
        <div class="mixer-title">Session Overview</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="text-align:center;padding:8px 0">
            <div id="sum-sets" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Sets</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-reps" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Reps</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-duration" style="font-size:1.5rem;font-weight:700;color:var(--accent-green)">0:00</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Duration</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-exercises" style="font-size:1.5rem;font-weight:700;color:var(--accent-orange)">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Exercises</div>
          </div>
        </div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:6px">Movement Balance</div>
          <div id="balance-bars" style="display:flex;gap:2px;height:24px;align-items:flex-end"></div>
          <div id="balance-labels" style="display:flex;gap:2px;margin-top:3px"></div>
        </div>
      </div>
      </div><!-- end tab-inspector-tab -->

      <!-- SETTINGS TAB -->
      <div class="panel-tab-content" id="tab-settings">
        <div class="mixer-section">
          <div class="mixer-title">Timeline</div>
          <div class="inspector-field">
            <label>Snap to Grid</label>
            <div style="display:flex;align-items:center;gap:8px">
              <button id="settings-snap" class="export-btn" onclick="toggleSnap()" style="width:auto;padding:4px 12px">OFF</button>
              <span style="font-size:8px;color:var(--micro)">S key</span>
            </div>
          </div>
          <div class="inspector-field">
            <label>Grid Resolution</label>
            <select id="settings-grid" onchange="setGridRes(this.value)" style="width:100%;padding:4px 6px;font-size:10px;font-family:Sora,sans-serif;background:var(--bg-deep);border:1px solid var(--border);color:var(--text)">
              <option value="1">1 Beat</option>
              <option value="2">2 Beats</option>
              <option value="4" selected>1 Bar (4 Beats)</option>
              <option value="8">2 Bars</option>
            </select>
          </div>
          <div class="inspector-field">
            <label>Auto-scroll during playback</label>
            <button id="settings-autoscroll" class="export-btn" onclick="toggleAutoScroll()" style="width:auto;padding:4px 12px">ON</button>
          </div>
        </div>
        <div class="mixer-section">
          <div class="mixer-title">Audio</div>
          <div class="inspector-field">
            <label>UI Sounds</label>
            <button id="settings-sfx" class="export-btn" onclick="toggleSFXSetting()" style="width:auto;padding:4px 12px">ON</button>
          </div>
          <div class="inspector-field">
            <label>Metronome Volume</label>
            <input type="range" id="settings-metro-vol" min="0" max="100" value="50" style="width:100%" oninput="metroVolume=this.value/100">
          </div>
        </div>
        <div class="mixer-section">
          <div class="mixer-title">Session</div>
          <div class="inspector-field">
            <label>Clear All Clips</label>
            <button class="export-btn" onclick="clearAllClips()" style="width:auto;padding:4px 12px;color:var(--error);border-color:rgba(239,68,68,0.3)">Clear</button>
          </div>
          <div class="inspector-field">
            <label>Reset to Default</label>
            <button class="export-btn" onclick="resetSession()" style="width:auto;padding:4px 12px;color:var(--error);border-color:rgba(239,68,68,0.3)">Reset</button>
          </div>
        </div>
      </div>

      <!-- Export / Import (always visible) -->
      <div class="mixer-section" style="display:flex;flex-wrap:wrap;gap:4px;padding:10px 14px;margin-top:auto">
        <button class="export-btn" onclick="exportWorkout()" style="flex:1;min-width:70px">Export</button>
        <button class="export-btn" onclick="printWorkout()" style="flex:1;min-width:70px">Print</button>
        <button class="export-btn" onclick="importWorkout()" style="flex:1;min-width:70px">Import</button>
      </div>
    </aside>
  </main>
  <div class="focus-indicator" id="focus-indicator" onclick="toggleFocusMode()" title="Exit focus mode (F)">FOCUS</div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="status-item"><div class="status-dot"></div><span id="status-text">Ready</span></div>
    <span id="undo-count" style="font-size:7px;color:var(--micro);opacity:0.5;letter-spacing:0.06em" title="Undo / Redo history"></span>
    <div style="display:flex;gap:12px;font-size:9px">
      <span>Clips: <span id="clip-count" style="color:var(--text-secondary)">0</span></span>
      <span style="color:var(--border)">|</span>
      <span>Duration: <span id="total-duration" style="color:var(--text-secondary)">0:00</span></span>
      <span style="color:var(--border)">|</span>
      <span id="footer-bars" style="color:var(--muted)">0 bars</span>
      <span style="color:var(--border)">|</span>
      <span id="footer-pos" style="color:var(--muted);cursor:pointer" onclick="toggleFooterMode()" title="Click to switch format">1.1.1</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div id="footer-balance" style="display:flex;gap:1px;height:4px;width:60px;border-radius:2px;overflow:hidden" title="Family balance"></div>
      <span id="save-indicator" style="color:var(--accent-green);opacity:0;transition:opacity 0.3s;font-size:7px;text-transform:uppercase;letter-spacing:0.1em">Saved</span>
      <span id="workout-name" style="font-size:8px;color:var(--text-secondary);font-weight:500;letter-spacing:0.03em;cursor:pointer" onclick="renameWorkout()" title="Click to rename">Untitled</span>
      <span style="color:var(--border)">|</span>
      <div class="footer-quote">Saturno Movement Studio</div>
      <input type="range" id="zoom-slider" min="0" max="5" value="2" style="width:60px;height:2px;margin:0 4px" oninput="setZoomFromSlider(this.value)" title="Zoom level">
      <span id="zoom-pct" style="font-size:7px;color:var(--micro);opacity:0.5;min-width:22px;text-align:center;font-variant-numeric:tabular-nums">100%</span>
      <span style="font-size:7px;color:var(--micro);opacity:0.5;letter-spacing:0.06em;font-variant-numeric:tabular-nums">v1.0</span>
      <a href="https://saturno-bonus-omega.vercel.app/vault" style="font-size:7px;color:var(--micro);text-decoration:none;text-transform:uppercase;letter-spacing:0.08em">Vault</a>
    </div>
  </footer>
</div>

<div class="saved-modal" id="saved-modal">
  <div class="saved-modal-content">
    <div class="saved-modal-header">
      <h3>Saved Workouts</h3>
      <button class="saved-modal-close" onclick="closeSavedWorkouts()">&times;</button>
    </div>
    <div id="saved-list"></div>
  </div>
</div>

<div class="clip-context-menu" id="clip-context-menu">
  <div class="ctx-item" data-action="duplicate">Duplicate<span class="ctx-key">Cmd+D</span></div>
  <div class="ctx-item" data-action="inspect">Inspect</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="split">Split at Playhead<span class="ctx-key">B</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="snap-start">Snap to Start</div>
  <div class="ctx-item" data-action="snap-next">Snap After Previous</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="move-push" style="font-size:8px;color:var(--accent-blue)">Move to Push</div>
  <div class="ctx-item" data-action="move-pull" style="font-size:8px;color:var(--accent-purple)">Move to Pull</div>
  <div class="ctx-item" data-action="move-core" style="font-size:8px;color:var(--accent-orange)">Move to Core</div>
  <div class="ctx-item" data-action="move-legs" style="font-size:8px;color:var(--accent-green)">Move to Legs</div>
  <div class="ctx-item" data-action="move-skills" style="font-size:8px;color:var(--accent-cyan)">Move to Skills</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" data-action="delete">Delete<span class="ctx-key">Del</span></div>
</div>
<div class="shortcuts-overlay" id="shortcuts-overlay">
  <div class="shortcuts-panel">
    <div class="shortcuts-header">
      <span>Keyboard Shortcuts</span>
      <button onclick="toggleShortcuts()" style="background:none;border:none;color:var(--micro);cursor:pointer;font-size:14px">&times;</button>
    </div>
    <div class="shortcuts-grid">
      <div class="shortcut-item"><kbd>Space</kbd><span>Play / Pause</span></div>
      <div class="shortcut-item"><kbd>Esc</kbd><span>Stop</span></div>
      <div class="shortcut-item"><kbd>S</kbd><span>Toggle Snap</span></div>
      <div class="shortcut-item"><kbd>Del</kbd><span>Delete Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Z</kbd><span>Undo</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+Z</kbd><span>Redo</span></div>
      <div class="shortcut-item"><kbd>Cmd+C</kbd><span>Copy Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+V</kbd><span>Paste Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+D</kbd><span>Duplicate</span></div>
      <div class="shortcut-item"><kbd>B</kbd><span>Split Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+D</kbd><span>Dup Track</span></div>
      <div class="shortcut-item"><kbd>&#8592; &#8594;</kbd><span>Nudge Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd++</kbd><span>Zoom In</span></div>
      <div class="shortcut-item"><kbd>Cmd+-</kbd><span>Zoom Out</span></div>
      <div class="shortcut-item"><kbd>Cmd+0</kbd><span>Zoom Reset</span></div>
      <div class="shortcut-item"><kbd>L</kbd><span>Toggle Loop</span></div>
      <div class="shortcut-item"><kbd>M</kbd><span>Add Marker</span></div>
      <div class="shortcut-item"><kbd>Cmd+A</kbd><span>Select All</span></div>
      <div class="shortcut-item"><kbd>Shift+Click</kbd><span>Multi-Select</span></div>
      <div class="shortcut-item"><kbd>Tab</kbd><span>Cycle Clips</span></div>
      <div class="shortcut-item"><kbd>Enter</kbd><span>Add from Search</span></div>
      <div class="shortcut-item"><kbd>Q</kbd><span>Quantize All</span></div>
      <div class="shortcut-item"><kbd>R</kbd><span>Record Toggle</span></div>
      <div class="shortcut-item"><kbd>F</kbd><span>Focus Mode</span></div>
      <div class="shortcut-item"><kbd>T</kbd><span>Tap Tempo</span></div>
      <div class="shortcut-item"><kbd>Dbl-Click</kbd><span>Add Random Clip</span></div>
      <div class="shortcut-item"><kbd>Drag</kbd><span>Marquee Select</span></div>
      <div class="shortcut-item"><kbd>Cmd+S</kbd><span>Save Session</span></div>
      <div class="shortcut-item"><kbd>Cmd+K</kbd><span>Command Palette</span></div>
      <div class="shortcut-item"><kbd>1-6</kbd><span>Select Track</span></div>
      <div class="shortcut-item"><kbd>?</kbd><span>This Panel</span></div>
    </div>
    <div style="font-size:8px;color:var(--micro);text-align:center;margin-top:10px;text-transform:uppercase;letter-spacing:0.1em">Drag exercises from library to timeline</div>
  </div>
</div>
<div class="cmd-palette" id="cmd-palette">
  <div class="cmd-palette-box">
    <input type="text" class="cmd-palette-input" id="cmd-input" placeholder="Type a command..." oninput="filterCommands()">
    <div class="cmd-palette-results" id="cmd-results"></div>
  </div>
</div>
<div class="clip-tip" id="clip-tip">
  <div class="clip-tip-name" id="tip-name"></div>
  <div class="clip-tip-detail">
    <span id="tip-pattern"></span>
    <span id="tip-stage"></span>
    <span id="tip-discipline" style="font-style:italic"></span>
  </div>
  <div class="clip-tip-detail" style="margin-top:2px">
    <span id="tip-dna"></span>
    <span id="tip-instrument" style="opacity:0.5"></span>
  </div>
</div>
<div class="track-ctx" id="track-ctx">
  <div class="track-ctx-item" data-action="solo">Solo Track</div>
  <div class="track-ctx-item" data-action="mute">Mute Track</div>
  <div class="track-ctx-sep"></div>
  <div class="track-ctx-item" data-action="select-all">Select All Clips</div>
  <div class="track-ctx-item" data-action="collapse">Toggle Collapse</div>
  <div class="track-ctx-item" data-action="collapse-all">Collapse All Tracks</div>
  <div class="track-ctx-sep"></div>
  <div class="track-ctx-item danger" data-action="clear">Clear Track</div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ===== SFX ENGINE — DAW Sound Design ===== */
var sfxCtx = null;
function initSFX() {
  if (sfxCtx) return;
  try { sfxCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
}
function sfx(type) {
  if (typeof sfxEnabled !== 'undefined' && !sfxEnabled) return;
  if (!sfxCtx) initSFX();
  if (!sfxCtx) return;
  try {
    if (sfxCtx.state === 'suspended') sfxCtx.resume();
    var now = sfxCtx.currentTime;
    var osc, gain;
    switch(type) {
      case 'click': // UI click — short, crisp
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        osc.frequency.exponentialRampToValueAtTime(800, now + 0.05);
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.06);
        break;
      case 'snap': // Snap to grid
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(2000, now);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.03);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.04);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.04);
        break;
      case 'play': // Transport play — rising tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'stop': // Transport stop — falling tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(660, now);
        osc.frequency.exponentialRampToValueAtTime(220, now + 0.12);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'drop': // Clip dropped — soft thud
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(180, now);
        osc.frequency.exponentialRampToValueAtTime(80, now + 0.08);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'delete': // Clip deleted — descending sweep
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
        gain.gain.setValueAtTime(0.06, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'preset': // Preset loaded — chord
        [440, 554, 659].forEach(function(freq, i) {
          var o = sfxCtx.createOscillator();
          var g = sfxCtx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(freq, now + i * 0.04);
          g.gain.setValueAtTime(0.06, now + i * 0.04);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
          o.connect(g); g.connect(sfxCtx.destination);
          o.start(now + i * 0.04); o.stop(now + 0.3);
        });
        break;
      case 'undo': // Undo — quick reverse
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(300, now + 0.08);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'rec': // Record — pulsing tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.setValueAtTime(0.02, now + 0.05);
        gain.gain.setValueAtTime(0.1, now + 0.1);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.2);
        break;
      case 'metronome': // Metronome tick
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1000, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.02);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.02);
        break;
    }
  } catch(e) {}
}

/* Init SFX on first user interaction */
document.addEventListener('click', function() { initSFX(); }, {once: true});
document.addEventListener('touchstart', function() { initSFX(); }, {once: true});

/* ===== EXERCISE DATABASE (from Victory Belt CC Movement Matrix) ===== */
var EXERCISES = [
  /* Horizontal Push (Pattern 1) */
  {id:'P1-01',name:'Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-02',name:'Diamond Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-03',name:'Wide Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-04',name:'Decline Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-05',name:'Archer Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-06',name:'Pseudo Planche PU',pattern:'Horizontal Push',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-07',name:'Ring Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-08',name:'One Arm Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-09',name:'Planche Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Horizontal Pull (Pattern 2) */
  {id:'P2-01',name:'Inverted Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-02',name:'Ring Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-03',name:'Archer Row',pattern:'Horizontal Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-04',name:'Tuck Front Lever',pattern:'Horizontal Pull',stage:2,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-05',name:'Front Lever Row',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-06',name:'Front Lever',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Downward Press (Pattern 3) */
  {id:'P3-01',name:'Dip',pattern:'Downward Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-02',name:'Ring Dip',pattern:'Downward Press',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-03',name:'Korean Dip',pattern:'Downward Press',stage:2,discipline:'Freestyle',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-04',name:'Weighted Dip',pattern:'Downward Press',stage:2,discipline:'Street Lifting',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-05',name:'Tuck Planche',pattern:'Downward Press',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-06',name:'Full Planche',pattern:'Downward Press',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Vertical Pull (Pattern 4) */
  {id:'P4-01',name:'Dead Hang',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-02',name:'Pull Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-03',name:'Chin Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-04',name:'L-Sit Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-05',name:'Archer Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-06',name:'Muscle Up (Bar)',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-07',name:'Ring Muscle Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-08',name:'Weighted Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Street Lifting',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-09',name:'One Arm Pull Up',pattern:'Vertical Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Overhead Press (Pattern 5) */
  {id:'P5-01',name:'Pike Push Up',pattern:'Overhead Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P5-02',name:'Wall Handstand Hold',pattern:'Overhead Press',stage:1,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-03',name:'Wall HSPU',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-04',name:'Free Handstand',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-05',name:'Handstand Push Up',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-06',name:'Press to Handstand',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  /* Knee-Dominant (Pattern 6) */
  {id:'P6-01',name:'Bodyweight Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-02',name:'Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-03',name:'Bulgarian Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-04',name:'Pistol Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-05',name:'Shrimp Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-06',name:'Cossack Squat',pattern:'Knee-Dominant',stage:2,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-07',name:'Dragon Squat',pattern:'Knee-Dominant',stage:3,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  /* Hip-Dominant (Pattern 7) */
  {id:'P7-01',name:'Glute Bridge',pattern:'Hip-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-02',name:'Nordic Curl',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-03',name:'Wrestler Bridge',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-04',name:'Stand to Bridge',pattern:'Hip-Dominant',stage:3,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  /* Core */
  {id:'C-01',name:'Hollow Body Hold',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-02',name:'Plank',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-03',name:'L-Sit',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-04',name:'V-Sit',pattern:'Core',stage:3,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-05',name:'Dragon Flag',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-06',name:'Ab Wheel Rollout',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  /* Mobility */
  {id:'M-01',name:'Resting Squat',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-02',name:'Pancake Stretch',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-03',name:'Front Split',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-04',name:'Thoracic Bridge',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-05',name:'German Hang',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-06',name:'Hip CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-07',name:'Scapular CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'}
];

/* Movement family -> instrument role (from Composition Engine) */
var FAMILY_MAP = {
  'Push': {instrument:'Percussion',color:'#3b82f6'},
  'Pull': {instrument:'Bass',color:'#8b5cf6'},
  'Legs': {instrument:'Rhythm Guitar',color:'#22c55e'},
  'Core': {instrument:'Harmony',color:'#f97316'},
  'Skills': {instrument:'Lead Melody',color:'#06b6d4'},
  'Flow': {instrument:'Ambient Pad',color:'#ec4899'}
};

/* BPM -> Training Mode (from Composition Engine) */
var BPM_MODES = [
  {min:40,max:80,name:'Slow Strength',desc:'Control, holds, precision'},
  {min:80,max:120,name:'Standard',desc:'Tempo work, sets'},
  {min:120,max:160,name:'Flow State',desc:'Conditioning, flow'},
  {min:160,max:200,name:'Explosive',desc:'Power, speed, intensity'}
];

/* Track definitions */
var TRACKS = [
  {id:'music',name:'Music',family:'_music',info:'Audio',isMusic:true},
  {id:'push',name:'Push',family:'Push',info:'Percussion'},
  {id:'pull',name:'Pull',family:'Pull',info:'Bass'},
  {id:'core',name:'Core',family:'Core',info:'Harmony'},
  {id:'legs',name:'Legs',family:'Legs',info:'Rhythm'},
  {id:'skills',name:'Skills',family:'Skills',info:'Lead'}
];

/* Fader definitions */
var FADERS = [
  {id:'intensity',label:'Intensity',value:70,color:'var(--gradient-titan)'},
  {id:'volume',label:'Volume',value:50,color:'var(--gradient-titan)'},
  {id:'density',label:'Density',value:60,color:'var(--gradient-titan)'},
  {id:'rest',label:'Rest',value:40,color:'var(--gradient-titan)'}
];

/* Knob definitions */
var KNOBS = [
  {id:'str-mob',label:'Str / Mob',value:0.5},
  {id:'pwr-ctrl',label:'Pwr / Ctrl',value:0.5},
  {id:'sta-dyn',label:'Sta / Dyn',value:0.5}
];

/* Preset definitions */
var PRESETS = {
  monk: {
    name:'Monk Mode',bpm:65,
    clips:[
      {track:'core',name:'Hollow Body Hold',x:0,w:120},
      {track:'push',name:'Push Up',x:20,w:100},
      {track:'core',name:'L-Sit',x:140,w:100},
      {track:'pull',name:'Pull Up',x:140,w:100},
      {track:'skills',name:'Free Handstand',x:260,w:120},
      {track:'legs',name:'Resting Squat',x:260,w:80}
    ],
    faders:{intensity:40,volume:30,density:30,rest:70},
    knobs:{'str-mob':0.4,'pwr-ctrl':0.3,'sta-dyn':0.2}
  },
  beast: {
    name:'Beast Mode',bpm:140,
    clips:[
      {track:'push',name:'Diamond Push Up',x:0,w:100},
      {track:'pull',name:'Muscle Up (Bar)',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:120,w:80},
      {track:'push',name:'Dip',x:120,w:80},
      {track:'core',name:'Dragon Flag',x:120,w:80},
      {track:'pull',name:'Weighted Pull Up',x:220,w:100},
      {track:'legs',name:'Shrimp Squat',x:220,w:80},
      {track:'push',name:'Planche Push Up',x:340,w:100}
    ],
    faders:{intensity:90,volume:80,density:85,rest:20},
    knobs:{'str-mob':0.8,'pwr-ctrl':0.7,'sta-dyn':0.9}
  },
  flow: {
    name:'Flow Ritual',bpm:100,
    clips:[
      {track:'legs',name:'Hip CARs',x:0,w:80},
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'core',name:'Hollow Body Hold',x:100,w:80},
      {track:'pull',name:'Ring Row',x:100,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:200,w:100},
      {track:'legs',name:'Cossack Squat',x:200,w:80},
      {track:'core',name:'L-Sit',x:300,w:80},
      {track:'push',name:'Ring Push Up',x:300,w:100}
    ],
    faders:{intensity:55,volume:60,density:65,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.4,'sta-dyn':0.6}
  },
  skill: {
    name:'Skill Ascension',bpm:75,
    clips:[
      {track:'skills',name:'Free Handstand',x:0,w:160},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'pull',name:'Tuck Front Lever',x:180,w:140},
      {track:'push',name:'Tuck Planche',x:180,w:140},
      {track:'core',name:'V-Sit',x:180,w:80},
      {track:'skills',name:'Press to Handstand',x:340,w:160}
    ],
    faders:{intensity:60,volume:40,density:35,rest:80},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.3,'sta-dyn':0.15}
  },
  upper: {
    name:'Upper Day',bpm:100,
    clips:[
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'push',name:'Dip',x:120,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Inverted Row',x:120,w:100},
      {track:'push',name:'Ring Push Up',x:240,w:100},
      {track:'pull',name:'Chin Up',x:240,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'L-Sit',x:120,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:360,w:120}
    ],
    faders:{intensity:65,volume:60,density:55,rest:50},
    knobs:{'str-mob':0.7,'pwr-ctrl':0.5,'sta-dyn':0.4}
  },
  lower: {
    name:'Lower Day',bpm:90,
    clips:[
      {track:'legs',name:'Bodyweight Squat',x:0,w:100},
      {track:'legs',name:'Bulgarian Split Squat',x:120,w:100},
      {track:'legs',name:'Pistol Squat',x:240,w:100},
      {track:'legs',name:'Nordic Curl',x:360,w:100},
      {track:'legs',name:'Cossack Squat',x:480,w:80},
      {track:'core',name:'Dragon Flag',x:0,w:100},
      {track:'core',name:'Ab Wheel Rollout',x:120,w:80},
      {track:'legs',name:'Glute Bridge',x:600,w:80},
      {track:'skills',name:'Resting Squat',x:0,w:120}
    ],
    faders:{intensity:70,volume:55,density:60,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.6,'sta-dyn':0.5}
  },
  ppl: {
    name:'Push / Pull / Legs',bpm:110,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'push',name:'Pseudo Planche PU',x:120,w:100},
      {track:'push',name:'Pike Push Up',x:240,w:80},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Ring Row',x:120,w:80},
      {track:'pull',name:'Tuck Front Lever',x:220,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'legs',name:'Nordic Curl',x:120,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'Dragon Flag',x:100,w:80}
    ],
    faders:{intensity:75,volume:65,density:70,rest:35},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.6,'sta-dyn':0.6}
  },
  fullbody: {
    name:'Full Body',bpm:105,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'skills',name:'Free Handstand',x:0,w:120},
      {track:'push',name:'Ring Push Up',x:140,w:80},
      {track:'pull',name:'Archer Pull Up',x:140,w:80},
      {track:'legs',name:'Bulgarian Split Squat',x:140,w:80},
      {track:'core',name:'Ab Wheel Rollout',x:140,w:80}
    ],
    faders:{intensity:60,volume:55,density:50,rest:50},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.5,'sta-dyn':0.5}
  }
};

/* ===== STATE ===== */
var isPlaying = false, currentTime = 0, bpm = 120, playInterval = null;
var isRecording = false, tempoLinked = false;
var selectedClip = null, musicPlaying = false, musicIndex = 0;
var audioEl = null;
var meterInterval = null;
var undoStack = [], redoStack = [], maxUndo = 30;
var metronomeEnabled = false, lastBeatTime = 0, beatCounter = 0;
var loopEnabled = false, loopStart = 0, loopEnd = 60;
var markers = [], markerCounter = 0;

/* Music tracks (from Vercel Blob CDN) */
var MUSIC_TRACKS = [
  {name:'Celestial Reverie',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Celestial%20Reverie.mp3'},
  {name:'Blue Phoenix',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Blue%20Phoenix.mp3'},
  {name:'Veil of Truth',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Veil%20of%20Truth.mp3'},
  {name:'Astral Shadows',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Astral%20Shadows.mp3'}
];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', function() {
  buildLibrary();
  buildTracks();
  buildRuler();
  buildFaders();
  buildKnobs();
  buildMeters();
  loadSession();
  updateBPMMode();
  updateEmptyState();
});

/* ===== LIBRARY ===== */
function buildLibrary() {
  var container = document.getElementById('library-container');
  var groups = {};
  EXERCISES.forEach(function(ex) {
    var g = ex.pattern;
    if (!groups[g]) groups[g] = [];
    groups[g].push(ex);
  });
  var html = '';
  var patterns = ['Horizontal Push','Horizontal Pull','Downward Press','Vertical Pull','Overhead Press','Knee-Dominant','Hip-Dominant','Core','Mobility'];
  patterns.forEach(function(p) {
    var exs = groups[p];
    if (!exs) return;
    var fam = exs[0].family;
    var fm = FAMILY_MAP[fam] || {color:'#666'};
    html += '<div class="movement-category" data-pattern="'+p+'">';
    html += '<div class="category-header" onclick="toggleCategory(this)"><span>'+p+' ('+exs.length+')</span><div style="display:flex;align-items:center;gap:6px"><div class="category-color" style="background:'+fm.color+'"></div><span class="arrow">&#9660;</span></div></div>';
    html += '<div class="movement-list">';
    exs.forEach(function(ex) {
      html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" data-family="'+ex.family+'">';
      html += '<div class="mv-icon" style="background:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
      html += '<span>'+ex.name+'</span>';
      html += '<span class="mv-stage">S'+ex.stage+'</span>';
      html += '<div class="mv-detail">'+ex.discipline+' | '+ex.family+' | Stage '+ex.stage+'</div>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
  document.getElementById('lib-count').textContent = EXERCISES.length;
  initDragDrop();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  var list = header.nextElementSibling;
  list.classList.toggle('hidden');
}

function filterLibrary() {
  var q = document.getElementById('lib-search').value.toLowerCase();
  var items = document.querySelectorAll('.movement-item');
  var count = 0;
  items.forEach(function(item) {
    var show = item.textContent.toLowerCase().indexOf(q) !== -1;
    item.style.display = show ? '' : 'none';
    if (show) count++;
  });
  document.getElementById('lib-count').textContent = count;
  // Show all categories when searching
  if (q) {
    document.querySelectorAll('.movement-list').forEach(function(l) { l.classList.remove('hidden'); });
    document.querySelectorAll('.category-header').forEach(function(h) { h.classList.remove('collapsed'); });
  }
}

function addFirstMatch() {
  var q = document.getElementById('lib-search').value.toLowerCase().trim();
  if (!q) return;
  // Find first matching exercise
  var match = null;
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].name.toLowerCase().indexOf(q) !== -1) {
      match = EXERCISES[i]; break;
    }
  }
  if (!match) { toast('No match found'); return; }
  // Find active track or matching family track
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) {
    // Find track by family
    var familyToTrack = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
    var trackId = familyToTrack[match.family] || 'push';
    activeTrack = document.querySelector('.track-content[data-track="'+trackId+'"]');
  }
  if (!activeTrack || activeTrack.dataset.track === 'music') {
    var familyToTrack = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
    activeTrack = document.querySelector('.track-content[data-track="'+(familyToTrack[match.family] || 'push')+'"]');
  }
  // Place after last clip in that track
  var clips = activeTrack.querySelectorAll('.clip');
  var x = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > x) x = r;
  });
  addClip(activeTrack, match, x + 4);
  document.getElementById('lib-search').value = '';
  filterLibrary();
}

/* ===== TRACKS ===== */
function buildTracks() {
  var container = document.getElementById('timeline-tracks');
  var ph = container.querySelector('.playhead');
  var html = '';
  TRACKS.forEach(function(t) {
    if (t.isMusic) {
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-name" style="color:var(--accent-cyan)">'+t.name+'</div>';
      html += '<select class="track-select" id="music-track-select" onchange="selectMusicTrack(this.value)" style="font-size:8px;padding:2px 4px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text);width:88px;font-family:Sora,sans-serif;border-radius:2px">';
      html += '<option value="">--</option>';
      MUSIC_TRACKS.forEach(function(mt,i) { html += '<option value="'+i+'">'+mt.name+'</option>'; });
      html += '</select></div>';
      html += '<div class="track-content" data-track="'+t.id+'" style="pointer-events:none;position:relative"><canvas id="music-waveform-canvas" style="position:absolute;top:8px;left:100px;right:0;height:44px;opacity:0.3"></canvas><span id="music-timeline-label" style="font-size:8px;color:var(--micro);padding:4px 8px;display:inline-block;position:relative;z-index:1">Select a track</span></div></div>';
    } else {
      var fm = FAMILY_MAP[t.family] || {color:'#666'};
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-grip"><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div></div><div class="track-name" style="color:'+fm.color+'">'+t.name+'</div><div class="track-info">'+t.info+'</div>';
      html += '<div class="track-controls"><button class="track-btn" onclick="toggleMute(this)" title="Mute">M</button><button class="track-btn" onclick="toggleSolo(this)" title="Solo">S</button><button class="track-btn" onclick="toggleArm(this)" title="Arm" style="color:var(--micro)">R</button></div>';
      html += '<div class="track-clip-count" id="track-count-'+t.id+'">0 clips</div>';
      html += '</div>';
      html += '<div class="track-content" data-track="'+t.id+'"></div></div>';
    }
  });
  container.innerHTML = html;
  container.insertBefore(ph, container.firstChild);
}

function selectMusicTrack(idx) {
  if (idx === '') {
    document.getElementById('music-timeline-label').textContent = 'Select a track';
    return;
  }
  musicIndex = parseInt(idx);
  var track = MUSIC_TRACKS[musicIndex];
  document.getElementById('music-timeline-label').textContent = track.name;
  document.getElementById('music-track-name').textContent = track.name;
  if (!audioEl) { audioEl = new Audio(); audioEl.volume = 0.5; audioEl.addEventListener('ended', function() { musicNext(); }); }
  audioEl.src = track.url;
  audioEl.load();
  drawMusicWaveform(track.name);
  toast('Music: ' + track.name);
}

function buildRuler() {
  var ruler = document.getElementById('timeline-ruler');
  var beatDuration = 60 / bpm;
  var barDuration = beatDuration * 4;
  var html = '<div class="ruler-mark" style="flex:0 0 100px"><span style="color:var(--muted)">1</span></div>';
  for (var i = 15; i <= 300; i += 15) {
    var m = Math.floor(i / 60);
    var s = i % 60;
    var barNum = Math.floor(i / barDuration) + 1;
    html += '<div class="ruler-mark">'+m+':'+s.toString().padStart(2,'0')+' <span style="color:var(--micro);font-size:7px">|'+barNum+'</span></div>';
  }
  ruler.innerHTML = html;
}

/* ===== DRAG & DROP ===== */
function initDragDrop() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.4';
      // Custom drag image — looks like a mini clip
      var ghost = document.createElement('div');
      ghost.textContent = ex.name;
      ghost.style.cssText = 'position:absolute;top:-999px;left:-999px;padding:4px 10px;font-size:9px;font-weight:600;font-family:Sora,sans-serif;background:' + (FAMILY_MAP[ex.family] || {color:'#666'}).color + ';color:rgba(255,255,255,0.9);border-radius:3px;white-space:nowrap;border-top:2px solid rgba(255,255,255,0.3)';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 0, 0);
      setTimeout(function() { document.body.removeChild(ghost); }, 0);
      sfx('click');
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
  document.querySelectorAll('.track-content').forEach(function(track) {
    var ghostPreview = null;
    track.addEventListener('dragover', function(e) {
      e.preventDefault();
      track.classList.add('drag-over');
      // Show ghost clip preview at cursor position
      if (!ghostPreview) {
        ghostPreview = document.createElement('div');
        ghostPreview.className = 'clip';
        ghostPreview.style.cssText = 'width:80px;opacity:0.3;pointer-events:none;z-index:10;border:1px dashed rgba(255,255,255,0.2);background:rgba(255,255,255,0.03)';
        track.appendChild(ghostPreview);
      }
      var rect = track.getBoundingClientRect();
      var x = e.clientX - rect.left + (track.parentElement.parentElement ? track.parentElement.parentElement.scrollLeft : 0);
      ghostPreview.style.left = snapValue(x) + 'px';
    });
    track.addEventListener('dragleave', function() {
      track.classList.remove('drag-over');
      if (ghostPreview && ghostPreview.parentNode) { ghostPreview.remove(); ghostPreview = null; }
    });
    track.addEventListener('drop', function(e) {
      e.preventDefault();
      track.classList.remove('drag-over');
      if (ghostPreview && ghostPreview.parentNode) { ghostPreview.remove(); ghostPreview = null; }
      try {
        var ex = JSON.parse(e.dataTransfer.getData('text/plain'));
        var rect = track.getBoundingClientRect();
        var x = e.clientX - rect.left + track.parentElement.parentElement.scrollLeft;
        addClip(track, ex, x);
      } catch(err) {}
    });
    // Double-click empty area to add random exercise matching this track's family
    track.addEventListener('dblclick', function(e) {
      if (e.target.closest('.clip')) return; // ignore clicks on existing clips
      var trackId = track.dataset.track;
      if (trackId === 'music') return;
      var trackDef = TRACKS.find(function(t) { return t.id === trackId; });
      if (!trackDef) return;
      var familyExercises = EXERCISES.filter(function(ex) { return ex.family === trackDef.family; });
      if (familyExercises.length === 0) return;
      var ex = familyExercises[Math.floor(Math.random() * familyExercises.length)];
      var rect = track.getBoundingClientRect();
      var x = e.clientX - rect.left + (track.parentElement.parentElement ? track.parentElement.parentElement.scrollLeft : 0);
      addClip(track, ex, snapValue(x));
    });
    // Marquee rubber-band selection on empty area
    track.addEventListener('mousedown', function(e) {
      if (e.target.closest('.clip') || e.button !== 0) return;
      var trackId = track.dataset.track;
      if (trackId === 'music') return;
      var rect = track.getBoundingClientRect();
      var startX = e.clientX - rect.left;
      var startY = e.clientY - rect.top;
      var marquee = document.createElement('div');
      marquee.className = 'marquee-selection';
      track.style.position = 'relative';
      track.appendChild(marquee);
      function onMove(ev) {
        var curX = ev.clientX - rect.left;
        var curY = ev.clientY - rect.top;
        var left = Math.min(startX, curX);
        var top = Math.min(startY, curY);
        var w = Math.abs(curX - startX);
        var h = Math.abs(curY - startY);
        marquee.style.left = left + 'px';
        marquee.style.top = top + 'px';
        marquee.style.width = w + 'px';
        marquee.style.height = h + 'px';
        // Highlight clips that intersect marquee
        var mLeft = left; var mRight = left + w;
        track.querySelectorAll('.clip').forEach(function(c) {
          var cLeft = parseInt(c.style.left) || 0;
          var cRight = cLeft + (parseInt(c.style.width) || 80);
          if (cRight > mLeft && cLeft < mRight) {
            c.classList.add('selected');
          } else if (!ev.shiftKey) {
            c.classList.remove('selected');
          }
        });
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (marquee.parentNode) marquee.remove();
        var sel = track.querySelectorAll('.clip.selected');
        if (sel.length === 1) selectClipEl(sel[0]);
        else if (sel.length > 1) toast(sel.length + ' clips selected');
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
}

function getExercise(id) {
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].id === id) return EXERCISES[i];
  }
  return null;
}

/* ===== CLIPS ===== */
function drawClipWaveform(canvas, color, width, opacity) {
  if (!canvas || !canvas.getContext) return;
  var w = parseInt(width) || 80;
  canvas.width = w - 8;
  canvas.height = 20;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = color;
  ctx.globalAlpha = opacity || 0.35;
  var mid = canvas.height / 2;
  var seed = w * 7 + canvas.width;
  for (var x = 0; x < canvas.width; x += 1) {
    var v = Math.sin(x * 0.15 + seed * 0.01) * 0.4 +
            Math.sin(x * 0.08 + seed * 0.02) * 0.3 +
            Math.sin(x * 0.3 + seed * 0.005) * 0.2 +
            Math.sin(x * 0.5 + seed * 0.03) * 0.1;
    var amp = (mid - 2) * Math.abs(v);
    ctx.fillRect(x, mid - amp, 1, amp * 2);
  }
}

/* Add beat marker dividers inside clips based on BPM */
function addBeatMarkers(clipEl, widthPx) {
  var existing = clipEl.querySelector('.beat-markers');
  if (existing) existing.remove();
  var w = parseInt(widthPx) || parseInt(clipEl.style.width) || 80;
  var pps = 80 / 15; // pixels per second
  var beatSec = 60 / bpm;
  var beatPx = beatSec * pps;
  if (beatPx < 8) return; // Too dense to show
  var container = document.createElement('div');
  container.className = 'beat-markers';
  for (var px = beatPx; px < w; px += beatPx) {
    var marker = document.createElement('span');
    marker.style.left = px + 'px';
    container.appendChild(marker);
  }
  clipEl.appendChild(container);
}

function createClipElement(exercise, left, width, dna) {
  var fm = FAMILY_MAP[exercise.family] || {color:'#666'};
  var clip = document.createElement('div');
  clip.className = 'clip';
  var baseColor = fm.color;
  // Stage-based opacity + RPE intensity for visual differentiation
  var rpeVal = parseInt((dna && dna.rpe) || '7');
  var stageBase = exercise.stage === 1 ? 170 : exercise.stage === 2 ? 200 : 230;
  var rpeBoost = Math.round((rpeVal / 10) * 25);
  var alphaTop = Math.min(255, stageBase + rpeBoost).toString(16).padStart(2, '0');
  var alphaBot = Math.min(255, 130 + rpeBoost).toString(16).padStart(2, '0');
  clip.style.background = 'linear-gradient(180deg, ' + baseColor + alphaTop + ' 0%, ' + baseColor + alphaBot + ' 100%)';
  clip.style.borderTopColor = baseColor;
  // Discipline bottom-border accent (subtle visual coding)
  var discColors = {'Calisthenics':'#3b82f6','Power-Free':'#f97316','Bodybuilding':'#ef4444','Street Lifting':'#a855f7','Hand-Balancing':'#06b6d4','Freestyle':'#ec4899','Mobility':'#22c55e'};
  var discColor = discColors[exercise.discipline] || baseColor;
  clip.style.borderBottom = '1px solid ' + discColor + '40';
  clip.style.left = (typeof left === 'string' ? left : Math.max(0, left) + 'px');
  clip.style.width = (typeof width === 'string' ? width : (width || 80) + 'px');
  clip.style.color = 'rgba(255,255,255,0.9)';
  clip.dataset.exerciseId = exercise.id;
  clip.dataset.sets = (dna && dna.sets) || '3';
  clip.dataset.reps = (dna && dna.reps) || '8';
  clip.dataset.tempo = (dna && dna.tempo) || '3';
  clip.dataset.rest = (dna && dna.rest) || '60';
  clip.dataset.rpe = (dna && dna.rpe) || '7';

  var label = document.createElement('span');
  label.className = 'clip-name';
  label.textContent = exercise.name;
  label.style.position = 'relative';
  label.style.zIndex = '1';
  clip.appendChild(label);

  var info = document.createElement('span');
  info.className = 'clip-info';
  info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps;
  info.style.position = 'relative';
  info.style.zIndex = '1';
  clip.appendChild(info);

  // Stage dots (S1=1dot, S2=2dots, S3=3dots)
  var dotsEl = document.createElement('div');
  dotsEl.className = 'clip-stage-dots';
  for (var di = 0; di < 3; di++) {
    var dot = document.createElement('div');
    dot.className = 'clip-stage-dot' + (di < exercise.stage ? ' filled' : '');
    dotsEl.appendChild(dot);
  }
  clip.appendChild(dotsEl);

  var canvas = document.createElement('canvas');
  canvas.className = 'clip-waveform';
  clip.appendChild(canvas);
  // Waveform: family color + stage-based density
  var waveOpacity = exercise.stage === 1 ? 0.35 : exercise.stage === 2 ? 0.5 : 0.65;
  var waveColor = baseColor || '#fff';
  setTimeout(function() {
    drawClipWaveform(canvas, waveColor, clip.style.width, waveOpacity);
    addBeatMarkers(clip, clip.style.width);
  }, 10);

  var progress = document.createElement('div');
  progress.className = 'clip-progress';
  clip.appendChild(progress);

  var fadeIn = document.createElement('div');
  fadeIn.className = 'clip-fade clip-fade-in';
  clip.appendChild(fadeIn);
  var fadeOut = document.createElement('div');
  fadeOut.className = 'clip-fade clip-fade-out';
  clip.appendChild(fadeOut);

  // Fade handle drag (visual only — shows fade triangle)
  function setupFadeDrag(fadeEl, isIn) {
    fadeEl.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      var startX = e.clientX;
      function onMove(e) {
        var delta = Math.abs(e.clientX - startX);
        fadeEl.style.width = Math.min(delta, parseInt(clip.style.width) / 2) + 'px';
        fadeEl.classList.add('has-fade');
      }
      function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  }
  setupFadeDrag(fadeIn, true);
  setupFadeDrag(fadeOut, false);

  var resize = document.createElement('div');
  resize.className = 'clip-resize';
  clip.appendChild(resize);

  // Left resize handle
  var resizeL = document.createElement('div');
  resizeL.className = 'clip-resize-left';
  resizeL.style.cssText = 'position:absolute;left:0;top:0;bottom:0;width:5px;cursor:ew-resize;background:transparent;opacity:0;transition:opacity 0.1s;z-index:3';
  clip.appendChild(resizeL);
  resizeL.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startLeft = parseInt(clip.style.left), startW = parseInt(clip.style.width);
    function onMove(e) {
      var delta = e.clientX - startX;
      var newLeft = Math.max(0, startLeft + delta);
      var newW = Math.max(40, startW - delta);
      clip.style.left = newLeft + 'px';
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, 'rgba(255,255,255,' + waveOpacity + ')', newW + 'px');
      addBeatMarkers(clip, newW);
      updateStats();
    }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Drag clip
  clip.addEventListener('mousedown', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize') || e.target === resizeL || e.target.classList.contains('clip-resize-left')) return;
    e.preventDefault();
    selectClipEl(clip, e.shiftKey);
    var startX = e.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) {
      var newLeft = Math.max(0, startLeft + e.clientX - startX);
      clip.style.left = snapValue(newLeft) + 'px';
    }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Resize clip (stretching shows duration + redraws waveform)
  resize.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      var newW = Math.max(40, startW + e.clientX - startX);
      newW = snapEnabled ? Math.max(40, snapValue(newW)) : newW;
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, 'rgba(255,255,255,0.6)', newW + 'px');
      addBeatMarkers(clip, newW);
      var durSec = Math.round(newW / 80 * 15);
      var durM = Math.floor(durSec / 60);
      var durS = durSec % 60;
      var durStr = durM > 0 ? durM + ':' + durS.toString().padStart(2,'0') : durSec + 's';
      clip.title = exercise.name + ' - ' + durStr;
      info.textContent = durStr;
      updateStats();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps;
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Right-click context menu (Premiere Pro style)
  clip.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    selectClipEl(clip);
    showClipContextMenu(e.clientX, e.clientY, clip, exercise);
  });

  // Touch drag support
  clip.addEventListener('touchstart', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    selectClipEl(clip);
    var touch = e.touches[0];
    var startX = touch.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) { e.preventDefault(); clip.style.left = Math.max(0, startLeft + e.touches[0].clientX - startX) + 'px'; }
    function onEnd() { clip.removeEventListener('touchmove', onMove); clip.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    clip.addEventListener('touchmove', onMove, {passive: false});
    clip.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Touch resize support
  resize.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    var touch = e.touches[0];
    var startX = touch.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      e.preventDefault();
      var newW = Math.max(40, startW + e.touches[0].clientX - startX);
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, 'rgba(255,255,255,0.6)', newW + 'px');
      addBeatMarkers(clip, newW);
      updateStats();
    }
    function onEnd() { resize.removeEventListener('touchmove', onMove); resize.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    resize.addEventListener('touchmove', onMove, {passive: false});
    resize.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Double click / double tap to delete
  var lastTap = 0;
  clip.addEventListener('touchend', function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      clip.remove();
      if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      toast('Clip removed');
    }
    lastTap = now;
  });
  clip.addEventListener('dblclick', function() {
    pushUndo();
    clip.remove();
    if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
    updateStats(); saveSession();
    sfx('delete');
    toast('Clip removed');
  });

  return clip;
}

function addClip(track, exercise, x) {
  pushUndo();
  var clip = createClipElement(exercise, x, 80);
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  sfx('drop');
  toast(exercise.name + ' added');
}

function selectClipEl(clip, addToSelection) {
  if (!addToSelection) {
    document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  }
  clip.classList.add('selected');
  selectedClip = clip;
  var ex = getExercise(clip.dataset.exerciseId);
  if (!ex) return;
  var insp = document.getElementById('inspector');
  insp.style.display = '';
  // Auto-switch to inspector tab
  switchPanelTab('inspector-tab');
  document.getElementById('insp-name').textContent = ex.name;
  document.getElementById('insp-pattern').textContent = ex.pattern;
  document.getElementById('insp-stage').textContent = 'Stage ' + ex.stage + ' - ' + ex.discipline;
  document.getElementById('insp-discipline').textContent = ex.discipline;
  document.getElementById('insp-sets').value = clip.dataset.sets || 3;
  document.getElementById('insp-reps').value = clip.dataset.reps || 8;
  document.getElementById('insp-tempo').value = clip.dataset.tempo || 3;
  document.getElementById('insp-rest').value = clip.dataset.rest || 60;
  document.getElementById('insp-rpe').value = clip.dataset.rpe || 7;
  var fm = FAMILY_MAP[ex.family] || {};
  document.getElementById('insp-tags').innerHTML =
    '<span class="inspector-tag" style="background:'+((FAMILY_MAP[ex.family]||{}).color||'#666')+'22;color:'+(FAMILY_MAP[ex.family]||{}).color+'">'+ex.family+'</span>' +
    '<span class="inspector-tag">'+(fm.instrument||'')+'</span>' +
    '<span class="inspector-tag">S'+ex.stage+'</span>';
}

function updateClipDNA() {
  if (!selectedClip) return;
  selectedClip.dataset.sets = document.getElementById('insp-sets').value;
  selectedClip.dataset.reps = document.getElementById('insp-reps').value;
  selectedClip.dataset.tempo = document.getElementById('insp-tempo').value;
  selectedClip.dataset.rest = document.getElementById('insp-rest').value;
  selectedClip.dataset.rpe = document.getElementById('insp-rpe').value;
  var info = selectedClip.querySelector('.clip-info');
  if (info) info.textContent = selectedClip.dataset.sets + 'x' + selectedClip.dataset.reps;
  // If tempo linked, update clip width based on exercise duration
  if (tempoLinked) {
    var sets = parseInt(selectedClip.dataset.sets) || 3;
    var reps = parseInt(selectedClip.dataset.reps) || 8;
    var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
    var rest = parseInt(selectedClip.dataset.rest) || 60;
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var pps = 80 / 15;
    selectedClip.style.width = Math.max(40, totalSec * pps) + 'px';
    updateStats();
  }
  saveSession();
}

function updateSummary() {
  var clips = document.querySelectorAll('.clip');
  var panel = document.getElementById('workout-summary');
  if (clips.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = '';
  var totalSets = 0, totalReps = 0, totalDur = 0, exerciseSet = {};
  var familyCounts = {};
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    totalSets += sets;
    totalReps += sets * reps;
    totalDur += (sets * reps * tempo) + ((sets - 1) * rest);
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exerciseSet[ex.id] = true;
      familyCounts[ex.family] = (familyCounts[ex.family] || 0) + 1;
    }
  });
  document.getElementById('sum-sets').textContent = totalSets;
  document.getElementById('sum-reps').textContent = totalReps;
  var durM = Math.floor(totalDur / 60);
  var durS = Math.floor(totalDur % 60);
  document.getElementById('sum-duration').textContent = durM + ':' + durS.toString().padStart(2, '0');
  document.getElementById('sum-exercises').textContent = Object.keys(exerciseSet).length;
  // Balance bars
  var maxCount = 1;
  var families = ['Push','Pull','Core','Legs','Skills','Flow'];
  families.forEach(function(f) { if ((familyCounts[f] || 0) > maxCount) maxCount = familyCounts[f]; });
  var barsHtml = '', labelsHtml = '';
  families.forEach(function(f) {
    var count = familyCounts[f] || 0;
    var fm = FAMILY_MAP[f] || {color:'#666'};
    var h = count > 0 ? Math.max(4, (count / maxCount) * 20) : 2;
    barsHtml += '<div style="flex:1;height:'+h+'px;background:'+fm.color+';border-radius:1px;opacity:'+(count > 0 ? 1 : 0.2)+'"></div>';
    labelsHtml += '<div style="flex:1;font-size:6px;color:var(--micro);text-align:center">'+f.charAt(0)+'</div>';
  });
  document.getElementById('balance-bars').innerHTML = barsHtml;
  document.getElementById('balance-labels').innerHTML = labelsHtml;
  // Footer family balance minibar
  var footerBar = document.getElementById('footer-balance');
  if (footerBar) {
    var total = clips.length || 1;
    var fbHtml = '';
    families.forEach(function(f) {
      var count = familyCounts[f] || 0;
      var pct = (count / total) * 100;
      if (pct > 0) {
        fbHtml += '<div style="flex:' + pct + ';background:' + (FAMILY_MAP[f] || {color:'#666'}).color + '"></div>';
      }
    });
    footerBar.innerHTML = fbHtml || '<div style="flex:1;background:var(--border)"></div>';
  }
}

function updateStats() {
  var clips = document.querySelectorAll('.clip');
  document.getElementById('clip-count').textContent = clips.length;
  var maxRight = 0;
  var trackCounts = {};
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
    var tid = c.parentElement.dataset.track;
    trackCounts[tid] = (trackCounts[tid] || 0) + 1;
  });
  var secs = Math.round(maxRight / 80 * 15);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  document.getElementById('total-duration').textContent = m + ':' + s.toString().padStart(2, '0');
  // Update total bars in footer
  var totalBars = Math.ceil(secs / (60 / bpm * 4));
  var barsEl = document.getElementById('footer-bars');
  if (barsEl) barsEl.textContent = totalBars + ' bar' + (totalBars !== 1 ? 's' : '');
  // Update per-track clip counts
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    var el = document.getElementById('track-count-' + t.id);
    var count = trackCounts[t.id] || 0;
    if (el) {
      el.textContent = count + ' clip' + (count !== 1 ? 's' : '');
      el.style.color = count === 0 ? 'var(--micro)' : count >= 3 ? 'var(--text-secondary)' : 'var(--muted)';
    }
  });
  // Detect clip overlaps per track
  document.querySelectorAll('.track-content').forEach(function(tc) {
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    trackClips.forEach(function(c) { c.classList.remove('clip-overlap'); });
    for (var i = 0; i < trackClips.length; i++) {
      var aL = parseInt(trackClips[i].style.left) || 0;
      var aR = aL + (parseInt(trackClips[i].style.width) || 80);
      for (var j = i + 1; j < trackClips.length; j++) {
        var bL = parseInt(trackClips[j].style.left) || 0;
        var bR = bL + (parseInt(trackClips[j].style.width) || 80);
        if (aR > bL && bR > aL) {
          trackClips[i].classList.add('clip-overlap');
          trackClips[j].classList.add('clip-overlap');
        }
      }
    }
  });
  updateSummary();
  updateMinimap();
  updateEmptyState();
}

/* ===== MINI-MAP ===== */
function updateMinimap() {
  var minimap = document.getElementById('timeline-minimap');
  var mapW = minimap.clientWidth;
  if (mapW === 0) return;
  // Calculate total timeline width from clips
  var maxRight = 600; // minimum extent
  var clips = document.querySelectorAll('.clip');
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var totalW = maxRight + 200; // padding
  var scale = mapW / totalW;
  // Draw mini clips
  var trackOffsets = {push:0,pull:1,core:2,legs:3,skills:4};
  var trackH = 3;
  var html = '';
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    var row = trackOffsets[tid];
    if (row === undefined) return;
    var x = parseInt(c.style.left) * scale;
    var w = Math.max(2, parseInt(c.style.width) * scale);
    var top = 1 + row * (trackH + 1);
    var ex = getExercise(c.dataset.exerciseId);
    var color = ex ? (FAMILY_MAP[ex.family] || {color:'#666'}).color : '#666';
    html += '<div class="minimap-clip" style="left:'+x+'px;width:'+w+'px;top:'+top+'px;background:'+color+'"></div>';
  });
  // Keep viewport indicator
  var container = document.getElementById('timeline-container');
  var vpLeft = container.scrollLeft * scale;
  var vpW = container.clientWidth * scale;
  html += '<div class="minimap-viewport" style="left:'+vpLeft+'px;width:'+vpW+'px"></div>';
  // Minimap playhead
  var pps = 80 / 15;
  var phX = (100 + currentTime * pps) * scale;
  html += '<div style="position:absolute;left:'+phX+'px;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.6);z-index:3;pointer-events:none"></div>';
  // Remove old viewport element since we're regenerating
  var oldVp = document.getElementById('minimap-viewport');
  if (oldVp) oldVp.remove();
  minimap.innerHTML = html;
}

/* Click/drag on minimap to scroll */
document.addEventListener('DOMContentLoaded', function() {
  var minimap = document.getElementById('timeline-minimap');
  function minimapScrollTo(clientX) {
    var rect = minimap.getBoundingClientRect();
    var clickX = clientX - rect.left;
    var ratio = Math.max(0, Math.min(1, clickX / rect.width));
    var maxRight = 600;
    document.querySelectorAll('.clip').forEach(function(c) {
      var r = parseInt(c.style.left) + parseInt(c.style.width);
      if (r > maxRight) maxRight = r;
    });
    var totalW = maxRight + 200;
    var container = document.getElementById('timeline-container');
    container.scrollLeft = ratio * totalW - container.clientWidth / 2;
    updateMinimap();
  }
  minimap.addEventListener('mousedown', function(e) {
    e.preventDefault();
    minimap.style.cursor = 'grabbing';
    minimapScrollTo(e.clientX);
    function onMove(ev) { minimapScrollTo(ev.clientX); }
    function onUp() {
      minimap.style.cursor = '';
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Update minimap on scroll */
  document.getElementById('timeline-container').addEventListener('scroll', function() {
    updateMinimap();
  });
});

/* ===== TRANSPORT ===== */
function togglePlay() {
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) {
    btn.classList.add('active');
    btn.innerHTML = '&#9616;&#9616;';
    playInterval = setInterval(updatePlayhead, 50);
    startMeters();
    document.getElementById('status-text').textContent = 'Playing';
    document.getElementById('playback-state').textContent = 'PLAY';
    document.getElementById('playback-state').style.color = 'var(--accent-green)';
    updatePlayheadClass();
    updateStatusDot();
    sfx('play');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#9654;';
    clearInterval(playInterval);
    stopMeters();
    document.getElementById('status-text').textContent = 'Paused';
    document.getElementById('playback-state').textContent = 'PAUSE';
    document.getElementById('playback-state').style.color = 'var(--accent-orange)';
    updatePlayheadClass();
    updateStatusDot();
    sfx('click');
  }
}

function stopPlayback() {
  isPlaying = false;
  currentTime = 0;
  var btn = document.getElementById('play-btn');
  btn.classList.remove('active');
  btn.innerHTML = '&#9654;';
  clearInterval(playInterval);
  stopMeters();
  updateTimeDisplay();
  updatePlayheadPosition();
  updatePlayheadClass();
  // Clear all clip playing states and progress
  document.querySelectorAll('.clip').forEach(function(c) {
    c.classList.remove('clip-playing');
    var p = c.querySelector('.clip-progress');
    if (p) p.style.width = '0';
  });
  document.getElementById('status-text').textContent = 'Ready';
  document.getElementById('playback-state').textContent = 'STOP';
  document.getElementById('playback-state').style.color = 'var(--micro)';
  updateStatusDot();
  sfx('stop');
}

function rewind() { currentTime = Math.max(0, currentTime - 15); updateTimeDisplay(); updatePlayheadPosition(); }
function forward() { currentTime += 15; updateTimeDisplay(); updatePlayheadPosition(); }

function updatePlayhead() {
  currentTime += 0.05;
  // Loop boundary check
  if (loopEnabled && currentTime >= loopEnd) {
    currentTime = loopStart;
    beatCounter = Math.floor(currentTime / (60 / bpm));
  }
  updateTimeDisplay();
  updatePlayheadPosition();
  // Metronome tick on the beat
  if (metronomeEnabled) {
    var beatInterval = 60 / bpm;
    var currentBeat = Math.floor(currentTime / beatInterval);
    if (currentBeat > beatCounter) {
      beatCounter = currentBeat;
      sfx('metronome');
    }
  }
}

function updateTimeDisplay() {
  var mins = Math.floor(currentTime / 60);
  var secs = Math.floor(currentTime % 60);
  var ms = Math.floor((currentTime % 1) * 100);
  document.getElementById('td-min').textContent = mins.toString().padStart(2, '0');
  document.getElementById('td-sec').textContent = secs.toString().padStart(2, '0');
  document.getElementById('td-ms').textContent = ms.toString().padStart(2, '0');
  // Update bars:beats:ticks in footer and transport
  var beatDuration = 60 / bpm;
  var totalBeats = currentTime / beatDuration;
  var bar = Math.floor(totalBeats / 4) + 1;
  var beat = Math.floor(totalBeats % 4) + 1;
  var tick = Math.floor((totalBeats % 1) * 4) + 1;
  var bbStr = bar + '.' + beat + '.' + tick;
  var posEl = document.getElementById('footer-pos');
  if (posEl) {
    if (typeof footerMode !== 'undefined' && footerMode === 'time') {
      var tm = Math.floor(currentTime / 60);
      var ts = Math.floor(currentTime % 60);
      var tms = Math.floor((currentTime % 1) * 100);
      posEl.textContent = tm + ':' + ts.toString().padStart(2,'0') + '.' + tms.toString().padStart(2,'0');
    } else {
      posEl.textContent = bbStr;
    }
  }
  var barsDisp = document.getElementById('bars-display');
  if (barsDisp) barsDisp.textContent = bbStr;
  // Update beat indicator dots (1-4)
  for (var bi = 1; bi <= 4; bi++) {
    var dot = document.getElementById('beat-' + bi);
    if (dot) {
      if (bi === beat && isPlaying) {
        dot.style.background = bi === 1 ? 'var(--accent-green)' : 'var(--accent-blue)';
        dot.style.boxShadow = '0 0 4px ' + (bi === 1 ? 'rgba(34,197,94,0.4)' : 'rgba(59,130,246,0.4)');
      } else {
        dot.style.background = 'rgba(255,255,255,0.1)';
        dot.style.boxShadow = 'none';
      }
    }
  }
}

function updatePlayheadPosition() {
  var pps = 80 / 15;
  var pos = 100 + currentTime * pps;
  document.getElementById('playhead').style.left = pos + 'px';
  // Auto-scroll timeline during playback (respects settings)
  if (isPlaying) {
    if (typeof autoScrollEnabled === 'undefined' || autoScrollEnabled) {
      var container = document.getElementById('timeline-container');
      var visibleRight = container.scrollLeft + container.clientWidth;
      if (pos > visibleRight - 60) {
        container.scrollLeft = pos - 200;
      }
    }
    // Update clip progress overlays and playing state
    document.querySelectorAll('.clip').forEach(function(clip) {
      var clipLeft = parseInt(clip.style.left) + 100;
      var clipW = parseInt(clip.style.width);
      var clipRight = clipLeft + clipW;
      var progressEl = clip.querySelector('.clip-progress');
      if (pos >= clipLeft && pos <= clipRight) {
        if (progressEl) {
          var pct = ((pos - clipLeft) / clipW) * 100;
          progressEl.style.width = pct + '%';
        }
        clip.classList.add('clip-playing');
      } else {
        if (progressEl) {
          progressEl.style.width = pos > clipRight ? '100%' : '0';
        }
        clip.classList.remove('clip-playing');
      }
    });
  }
  // Update header progress bar
  var hpBar = document.getElementById('header-progress');
  if (hpBar) {
    if (isPlaying) {
      var maxRight = 600;
      document.querySelectorAll('.clip').forEach(function(c) {
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      var pct = Math.min(100, ((pos - 100) / maxRight) * 100);
      hpBar.style.width = pct + '%';
      hpBar.classList.add('active');
    } else {
      hpBar.classList.remove('active');
    }
  }
}

function toggleRec() {
  isRecording = !isRecording;
  var btn = document.getElementById('rec-btn');
  btn.classList.toggle('active', isRecording);
  document.getElementById('status-text').textContent = isRecording ? 'Recording' : 'Ready';
  if (isRecording) {
    document.getElementById('playback-state').textContent = 'REC';
    document.getElementById('playback-state').style.color = 'var(--error)';
  } else {
    document.getElementById('playback-state').textContent = isPlaying ? 'PLAY' : 'STOP';
    document.getElementById('playback-state').style.color = isPlaying ? 'var(--accent-green)' : 'var(--micro)';
  }
  updateStatusDot();
  sfx(isRecording ? 'rec' : 'click');
}

/* ===== BPM ===== */
function updateBPM() {
  bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  updateBPMMode();
  buildRuler();
  saveSession();
  // Update BPM pulse animation speed
  var pulseDuration = (60 / bpm).toFixed(3);
  var pulse = document.getElementById('bpm-pulse');
  if (pulse) pulse.style.setProperty('--bpm-duration', pulseDuration + 's');
  // If tempo-linked, adjust exercise tempos AND music playback rate
  if (tempoLinked) {
    var repTempo = 60 / bpm;
    document.getElementById('insp-tempo').value = repTempo.toFixed(1);
    if (selectedClip) {
      selectedClip.dataset.tempo = repTempo.toFixed(1);
      updateClipDNA();
    }
    // Adjust music playback rate: 120 BPM = 1.0x, scale proportionally
    if (audioEl) {
      var rate = Math.max(0.5, Math.min(2.0, bpm / 120));
      audioEl.playbackRate = rate;
    }
    toast('Tempo linked: ' + repTempo.toFixed(1) + 's/rep, music ' + (bpm / 120).toFixed(2) + 'x');
  } else {
    // Reset music to normal speed when unlinked
    if (audioEl) audioEl.playbackRate = 1.0;
  }
}

function updateBPMMode() {
  var mode = 'Standard';
  for (var i = 0; i < BPM_MODES.length; i++) {
    if (bpm >= BPM_MODES[i].min && bpm < BPM_MODES[i].max) {
      mode = BPM_MODES[i].name;
      break;
    }
  }
  if (bpm >= 200) mode = 'Explosive';
  var el = document.getElementById('bpm-mode');
  el.textContent = mode;
  // Dynamic color by mode
  var modeColors = {'Slow Strength':['59,130,246','#3b82f6'],'Standard':['139,92,246','#8b5cf6'],'Flow State':['249,115,22','#f97316'],'Explosive':['239,68,68','#ef4444']};
  var mc = modeColors[mode] || ['139,92,246','#8b5cf6'];
  el.style.background = 'rgba(' + mc[0] + ',0.08)';
  el.style.borderColor = 'rgba(' + mc[0] + ',0.15)';
  el.style.color = mc[1];
}

function toggleTempoLink() {
  tempoLinked = !tempoLinked;
  var el = document.getElementById('tempo-link');
  el.classList.toggle('active', tempoLinked);
  if (tempoLinked) {
    sfx('click');
    toast('BPM linked to exercise tempo');
    updateBPM();
  } else {
    if (audioEl) audioEl.playbackRate = 1.0;
    sfx('click');
    toast('Tempo unlinked');
  }
}

/* Tap Tempo — tap rhythm to set BPM */
var tapTimes = [];
function tapTempo() {
  var now = Date.now();
  tapTimes.push(now);
  // Keep only last 8 taps (last 3 seconds)
  tapTimes = tapTimes.filter(function(t) { return now - t < 3000; });
  if (tapTimes.length >= 2) {
    var intervals = [];
    for (var i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    var avg = intervals.reduce(function(a, b) { return a + b; }, 0) / intervals.length;
    var tapBpm = Math.round(60000 / avg);
    tapBpm = Math.max(40, Math.min(200, tapBpm));
    bpm = tapBpm;
    document.getElementById('bpm-input').value = bpm;
    updateBPM();
  }
  sfx('metronome');
  // Visual feedback on tap button
  var btn = document.getElementById('tap-tempo');
  if (btn) {
    btn.classList.add('active');
    setTimeout(function() { btn.classList.remove('active'); }, 100);
  }
}

var timeSigOptions = ['4/4', '3/4', '6/8', '5/4', '7/8'];
var timeSigIdx = 0;
function cycleTimeSig() {
  timeSigIdx = (timeSigIdx + 1) % timeSigOptions.length;
  document.getElementById('time-sig').textContent = timeSigOptions[timeSigIdx];
  sfx('click');
  toast('Time signature: ' + timeSigOptions[timeSigIdx]);
}

function toggleMetronome() {
  metronomeEnabled = !metronomeEnabled;
  beatCounter = Math.floor(currentTime / (60 / bpm));
  var btn = document.getElementById('metro-btn');
  if (btn) {
    btn.classList.toggle('active', metronomeEnabled);
    btn.classList.toggle('metro-active', metronomeEnabled);
  }
  sfx(metronomeEnabled ? 'metronome' : 'click');
  toast(metronomeEnabled ? 'Metronome ON' : 'Metronome OFF');
}

function toggleLoop() {
  loopEnabled = !loopEnabled;
  var btn = document.getElementById('loop-btn');
  if (btn) btn.classList.toggle('active', loopEnabled);
  var region = document.getElementById('loop-region');
  region.classList.toggle('active', loopEnabled);
  if (loopEnabled) {
    updateLoopRegion();
    sfx('click');
    toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
  } else {
    sfx('click');
    toast('Loop OFF');
  }
}

function updateLoopRegion() {
  var pps = 80 / 15;
  var region = document.getElementById('loop-region');
  region.style.left = (100 + loopStart * pps) + 'px';
  region.style.width = ((loopEnd - loopStart) * pps) + 'px';
}

function formatTime(sec) {
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + s.toString().padStart(2, '0');
}

/* ===== FADERS ===== */
function buildFaders() {
  var container = document.getElementById('fader-group');
  var html = '';
  FADERS.forEach(function(f) {
    html += '<div class="fader" data-fader="'+f.id+'">';
    html += '<div class="fader-label">'+f.label+'</div>';
    html += '<div class="fader-track" onmousedown="startFaderDrag(event,\''+f.id+'\')" ontouchstart="startFaderDrag(event,\''+f.id+'\')">';
    html += '<div class="fader-fill" style="height:'+f.value+'%;background:'+f.color+'"></div>';
    html += '<div class="fader-handle" style="bottom:'+(f.value-3)+'%"></div>';
    html += '</div>';
    html += '<div class="fader-value" id="fader-val-'+f.id+'">'+(f.value/10).toFixed(0)+'</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startFaderDrag(e, faderId) {
  e.preventDefault();
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  function updatePos(clientY) {
    var y = 1 - ((clientY - rect.top) / rect.height);
    y = Math.max(0, Math.min(1, y));
    var pct = y * 100;
    track.querySelector('.fader-fill').style.height = pct + '%';
    track.querySelector('.fader-handle').style.bottom = (pct - 3) + '%';
    document.getElementById('fader-val-' + faderId).textContent = (pct / 10).toFixed(0);
  }
  function onMouseMove(e) { updatePos(e.clientY); }
  function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updatePos(e.touches[0].clientY); }
  function onTouchEnd() { document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    updatePos(e.touches[0].clientY);
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    updatePos(e.clientY);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== KNOBS ===== */
function buildKnobs() {
  var container = document.getElementById('knob-group');
  var html = '';
  KNOBS.forEach(function(k) {
    var deg = (k.value - 0.5) * 270;
    html += '<div class="knob" data-knob="'+k.id+'">';
    html += '<div class="knob-dial" onmousedown="startKnobDrag(event,\''+k.id+'\')" ontouchstart="startKnobDrag(event,\''+k.id+'\')">';
    html += '<div class="knob-indicator" style="transform:translateX(-50%) rotate('+deg+'deg)"></div>';
    html += '</div>';
    html += '<div class="knob-label">'+k.label+'</div>';
    html += '<div class="knob-value" id="knob-val-'+k.id+'">'+(k.value*100).toFixed(0)+'%</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startKnobDrag(e, knobId) {
  e.preventDefault();
  var startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  var dial = e.currentTarget;
  var indicator = dial.querySelector('.knob-indicator');
  var startDeg = parseFloat(indicator.style.transform.match(/rotate\(([^)]+)deg\)/)[1]);
  function updateKnob(clientY) {
    var delta = (startY - clientY) * 1.5;
    var deg = Math.max(-135, Math.min(135, startDeg + delta));
    indicator.style.transform = 'translateX(-50%) rotate(' + deg + 'deg)';
    var val = ((deg + 135) / 270);
    document.getElementById('knob-val-' + knobId).textContent = (val * 100).toFixed(0) + '%';
  }
  function onMouseMove(e) { updateKnob(e.clientY); }
  function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updateKnob(e.touches[0].clientY); }
  function onTouchEnd() { document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== METERS ===== */
function buildMeters() {
  var container = document.getElementById('meters');
  var html = '';
  for (var i = 0; i < 12; i++) {
    html += '<div class="meter-bar" style="height:' + (10 + Math.random() * 30) + 'px"><div class="peak-hold"></div></div>';
  }
  container.innerHTML = html;
  // Build per-channel meters
  var chContainer = document.getElementById('channel-meters');
  var chHtml = '';
  var trackColors = {push:'var(--accent-blue)',pull:'var(--accent-purple)',core:'var(--accent-orange)',legs:'var(--accent-green)',skills:'var(--accent-cyan)'};
  var trackNames = {push:'P',pull:'PL',core:'C',legs:'L',skills:'SK'};
  Object.keys(trackColors).forEach(function(tid) {
    chHtml += '<div class="channel-meter"><div class="channel-meter-bar"><div class="channel-meter-fill" id="ch-meter-'+tid+'" style="width:0%;background:'+trackColors[tid]+'"></div></div><div class="channel-meter-label">'+trackNames[tid]+'</div></div>';
  });
  chContainer.innerHTML = chHtml;
}

function startMeters() {
  if (meterInterval) return;
  meterInterval = setInterval(function() {
    document.querySelectorAll('.meter-bar').forEach(function(bar) {
      var newH = 10 + Math.random() * 50;
      bar.style.height = newH + 'px';
      bar.style.background = newH > 45 ? 'var(--accent-red)' : newH > 30 ? 'var(--accent-orange)' : 'var(--accent-green)';
    });
    // Animate channel meters
    ['push','pull','core','legs','skills'].forEach(function(tid) {
      var el = document.getElementById('ch-meter-' + tid);
      if (el) {
        var trackClips = document.querySelectorAll('.track-content[data-track="'+tid+'"] .clip');
        var level = trackClips.length > 0 ? (30 + Math.random() * 70) : 0;
        el.style.width = level + '%';
      }
    });
  }, 100);
}

function stopMeters() {
  clearInterval(meterInterval);
  meterInterval = null;
  document.querySelectorAll('.meter-bar').forEach(function(bar) {
    bar.style.height = '5px';
    bar.style.background = 'var(--accent-green)';
  });
}

/* ===== TRACK CONTROLS ===== */
function toggleMute(btn) {
  btn.classList.toggle('muted');
  var track = btn.closest('.track');
  track.classList.toggle('track-muted', btn.classList.contains('muted'));
  sfx('click');
}
function toggleSolo(btn) {
  btn.classList.toggle('soloed');
  sfx('click');
  // Solo logic: if any track is soloed, mute all others visually
  var anysoloed = document.querySelector('.track-btn.soloed');
  document.querySelectorAll('.track').forEach(function(t) {
    if (t.dataset.track === 'music') return;
    var hasSolo = t.querySelector('.track-btn.soloed');
    var hasMute = t.querySelector('.track-btn.muted');
    if (anysoloed && !hasSolo && !hasMute) {
      t.classList.add('track-muted');
    } else if (!anysoloed && !hasMute) {
      t.classList.remove('track-muted');
    }
    t.classList.toggle('track-soloed', !!hasSolo);
  });
  // Toggle has-solo class on timeline-tracks for CSS dimming
  var tl = document.getElementById('timeline-tracks');
  if (tl) tl.classList.toggle('has-solo', !!anysoloed);
}
function toggleArm(btn) {
  btn.classList.toggle('armed');
  sfx('click');
}

/* ===== VIDEO ===== */
function toggleVideo() {
  var sec = document.getElementById('video-section');
  sec.classList.toggle('collapsed');
  document.getElementById('btn-video').classList.toggle('active', !sec.classList.contains('collapsed'));
}

/* Video drop zone */
document.addEventListener('DOMContentLoaded', function() {
  var vp = document.getElementById('video-placeholder');
  if (!vp) return;
  vp.addEventListener('click', function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function() { loadVideoFile(input.files[0]); };
    input.click();
  });
  vp.addEventListener('dragover', function(e) { e.preventDefault(); vp.style.background = 'rgba(6,182,212,0.1)'; });
  vp.addEventListener('dragleave', function() { vp.style.background = ''; });
  vp.addEventListener('drop', function(e) {
    e.preventDefault();
    vp.style.background = '';
    if (e.dataTransfer.files.length) loadVideoFile(e.dataTransfer.files[0]);
  });
});

function loadVideoFile(file) {
  if (!file || !file.type.startsWith('video/')) return;
  var video = document.getElementById('studio-video');
  var placeholder = document.getElementById('video-placeholder');
  video.src = URL.createObjectURL(file);
  video.style.display = '';
  placeholder.style.display = 'none';
  toast('Video loaded: ' + file.name);
}

/* ===== MUSIC ===== */
function toggleMusic() {
  var panel = document.getElementById('music-panel');
  var visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : '';
  document.querySelector('[onclick="toggleMusic()"]').classList.toggle('active', !visible);
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.volume = 0.5;
    audioEl.addEventListener('ended', function() { musicNext(); });
  }
}

function musicToggle() {
  if (!audioEl) toggleMusic();
  if (musicPlaying) {
    audioEl.pause();
    musicPlaying = false;
    document.getElementById('music-play-btn').innerHTML = '&#9654;';
    document.getElementById('music-eq').style.display = 'none';
  } else {
    if (!audioEl.src || audioEl.ended) {
      audioEl.src = MUSIC_TRACKS[musicIndex].url;
    }
    audioEl.play().catch(function() {});
    musicPlaying = true;
    document.getElementById('music-play-btn').innerHTML = '&#9616;&#9616;';
    document.getElementById('music-play-btn').classList.add('playing');
    document.getElementById('music-eq').style.display = '';
    document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  }
}

function musicNext() {
  musicIndex = (musicIndex + 1) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicPrev() {
  musicIndex = (musicIndex - 1 + MUSIC_TRACKS.length) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicVolume(val) {
  if (audioEl) audioEl.volume = val / 100;
}

/* Draw static waveform in music track when a song is selected */
function drawMusicWaveform(trackName) {
  var canvas = document.getElementById('music-waveform-canvas');
  if (!canvas || !canvas.getContext) return;
  var parent = canvas.parentElement;
  canvas.width = parent.clientWidth - 100;
  canvas.height = 44;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#06b6d4';
  var mid = canvas.height / 2;
  var seed = 0;
  for (var i = 0; i < trackName.length; i++) seed += trackName.charCodeAt(i);
  for (var x = 0; x < canvas.width; x += 2) {
    var v = Math.sin(x * 0.02 + seed * 0.1) * 0.5 +
            Math.sin(x * 0.07 + seed * 0.05) * 0.3 +
            Math.sin(x * 0.15 + seed * 0.02) * 0.15 +
            Math.random() * 0.05;
    var amp = (mid - 4) * Math.abs(v);
    ctx.fillRect(x, mid - amp, 1, amp * 2);
  }
}

/* ===== PRESETS ===== */
function togglePresets() {
  var drawer = document.getElementById('presets-drawer');
  drawer.classList.toggle('open');
  document.getElementById('btn-presets').classList.toggle('active', drawer.classList.contains('open'));
}

function loadPreset(id) {
  var p = PRESETS[id];
  if (!p) return;
  pushUndo();
  // Clear timeline
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Set BPM
  bpm = p.bpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Add clips
  p.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    if (!track) return;
    var ex = null;
    for (var i = 0; i < EXERCISES.length; i++) {
      if (EXERCISES[i].name === c.name) { ex = EXERCISES[i]; break; }
    }
    if (!ex) return;
    var clip = createClipElement(ex, c.x, c.w || 80);
    track.appendChild(clip);
  });
  // Set faders
  if (p.faders) {
    Object.keys(p.faders).forEach(function(key) {
      var fader = document.querySelector('[data-fader="'+key+'"]');
      if (!fader) return;
      var v = p.faders[key];
      fader.querySelector('.fader-fill').style.height = v + '%';
      fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
      fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
    });
  }
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  setWorkoutName(p.name);
  toast('Preset loaded: ' + p.name);
}

/* ===== RANDOM WORKOUT ===== */
function generateRandom() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Random BPM between 70-130
  bpm = 70 + Math.floor(Math.random() * 60);
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Pick random exercises per family track
  var families = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackIds = Object.keys(families);
  trackIds.forEach(function(tid) {
    var fam = families[tid];
    var familyExs = EXERCISES.filter(function(ex) { return ex.family === fam || (fam === 'Skills' && ex.family === 'Skills') || (fam === 'Legs' && ex.family === 'Flow'); });
    if (familyExs.length === 0) return;
    // 1-3 clips per track
    var numClips = 1 + Math.floor(Math.random() * 3);
    var track = document.querySelector('.track-content[data-track="'+tid+'"]');
    if (!track) return;
    var xPos = 0;
    for (var i = 0; i < numClips; i++) {
      var ex = familyExs[Math.floor(Math.random() * familyExs.length)];
      var w = 60 + Math.floor(Math.random() * 80);
      var clip = createClipElement(ex, xPos, w);
      track.appendChild(clip);
      xPos += w + Math.floor(Math.random() * 40);
    }
  });
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  setWorkoutName('Random ' + bpm + ' BPM');
  toast('Random workout generated at ' + bpm + ' BPM');
}

/* ===== CLEAR ===== */
function clearTimeline() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats();
  saveSession();
  sfx('delete');
  toast('Timeline cleared');
}

/* ===== SAVE / LOAD ===== */
function saveSession() {
  try {
    var session = {bpm: bpm, clips: [], faders: {}, knobs: {}};
    document.querySelectorAll('.clip').forEach(function(clip) {
      session.clips.push({
        exerciseId: clip.dataset.exerciseId,
        track: clip.parentElement.dataset.track,
        left: clip.style.left,
        width: clip.style.width,
        sets: clip.dataset.sets,
        reps: clip.dataset.reps,
        tempo: clip.dataset.tempo,
        rest: clip.dataset.rest,
        rpe: clip.dataset.rpe
      });
    });
    document.querySelectorAll('[data-fader]').forEach(function(f) {
      var fill = f.querySelector('.fader-fill');
      session.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
    });
    localStorage.setItem('sms_session', JSON.stringify(session));
    // Flash save indicator
    var si = document.getElementById('save-indicator');
    if (si) {
      si.style.opacity = '1';
      setTimeout(function() { si.style.opacity = '0'; }, 1200);
    }
  } catch(e) {}
}

function loadSession() {
  try {
    var saved = localStorage.getItem('sms_session');
    if (!saved) return;
    var s = JSON.parse(saved);
    if (s.bpm) { bpm = s.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
    if (s.clips) {
      s.clips.forEach(function(c) {
        var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
        var ex = getExercise(c.exerciseId);
        if (!track || !ex) return;
        var clip = createClipElement(ex, c.left, c.width, {
          sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe
        });
        track.appendChild(clip);
      });
    }
    if (s.faders) {
      Object.keys(s.faders).forEach(function(key) {
        var fader = document.querySelector('[data-fader="'+key+'"]');
        if (!fader) return;
        var v = s.faders[key];
        fader.querySelector('.fader-fill').style.height = v + '%';
        fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
        fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
      });
    }
    updateStats();
  } catch(e) {}
}

/* ===== EXPORT ===== */
function exportWorkout() {
  var workout = {
    name: workoutName || 'Saturno Movement Studio Export',
    timestamp: new Date().toISOString(),
    bpm: bpm,
    bpmMode: document.getElementById('bpm-mode').textContent,
    tracks: {}
  };
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    workout.tracks[t.id] = [];
  });
  document.querySelectorAll('.clip').forEach(function(clip) {
    var trackId = clip.parentElement.dataset.track;
    var ex = getExercise(clip.dataset.exerciseId);
    workout.tracks[trackId].push({
      movement: ex ? ex.name : clip.textContent,
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      startTime: parseInt(clip.style.left) / 80 * 15,
      duration: parseInt(clip.style.width) / 80 * 15,
      sets: parseInt(clip.dataset.sets) || 3,
      reps: parseInt(clip.dataset.reps) || 8,
      tempo: parseFloat(clip.dataset.tempo) || 3,
      rest: parseInt(clip.dataset.rest) || 60,
      rpe: parseInt(clip.dataset.rpe) || 7
    });
  });
  var blob = new Blob([JSON.stringify(workout, null, 2)], {type: 'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('Workout exported');
}

/* ===== IMPORT WORKOUT ===== */
function importWorkout() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function() {
    if (!input.files[0]) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var workout = JSON.parse(e.target.result);
        if (!workout.tracks) { toast('Invalid workout file'); return; }
        pushUndo();
        document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
        selectedClip = null;
        document.getElementById('inspector').style.display = 'none';
        if (workout.bpm) {
          bpm = workout.bpm;
          document.getElementById('bpm-input').value = bpm;
          updateBPMMode();
          buildRuler();
        }
        var pps = 80 / 15;
        Object.keys(workout.tracks).forEach(function(trackId) {
          var track = document.querySelector('.track-content[data-track="'+trackId+'"]');
          if (!track) return;
          workout.tracks[trackId].forEach(function(item) {
            var ex = null;
            for (var i = 0; i < EXERCISES.length; i++) {
              if (EXERCISES[i].name === item.movement) { ex = EXERCISES[i]; break; }
            }
            if (!ex) return;
            var left = (item.startTime || 0) * pps;
            var width = (item.duration || 15) * pps;
            var clip = createClipElement(ex, left, width, {
              sets: item.sets, reps: item.reps, tempo: item.tempo,
              rest: item.rest, rpe: item.rpe
            });
            track.appendChild(clip);
          });
        });
        updateStats();
        saveSession();
        sfx('preset');
        setWorkoutName(workout.name || 'Imported Workout');
        toast('Imported: ' + (workout.name || 'workout'));
      } catch(err) {
        toast('Error importing file');
      }
    };
    reader.readAsText(input.files[0]);
  };
  input.click();
}

/* ===== PRINT WORKOUT ===== */
function printWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.textContent,
      pattern: ex ? ex.pattern : '',
      sets: c.dataset.sets || 3,
      reps: c.dataset.reps || 8,
      tempo: c.dataset.tempo || 3,
      rest: c.dataset.rest || 60,
      rpe: c.dataset.rpe || 7,
      startTime: parseInt(c.style.left) / 80 * 15
    });
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var totalClips = clips.length;
  var totalSets = 0, totalReps = 0;
  clips.forEach(function(c) { totalSets += parseInt(c.dataset.sets) || 3; totalReps += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8); });
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Workout - Saturno Movement Studio</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Sora,sans-serif;padding:32px;max-width:700px;margin:0 auto;background:#050711;color:#e2e8f0}';
  html += 'h1{font-size:20px;font-weight:700;letter-spacing:0.05em;margin-bottom:2px}';
  html += '.subtitle{font-size:9px;color:#64748b;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:16px}';
  html += '.stats{display:flex;gap:16px;margin-bottom:20px;padding:12px;background:#0a0e1a;border:1px solid #1e293b;border-radius:4px}';
  html += '.stat{text-align:center;flex:1}.stat-val{font-size:20px;font-weight:700;background:linear-gradient(135deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat-label{font-size:7px;color:#64748b;text-transform:uppercase;letter-spacing:0.2em;margin-top:2px}';
  html += 'h2{font-size:11px;font-weight:600;margin-top:20px;margin-bottom:8px;padding:6px 10px;background:#0a0e1a;border-left:3px solid;text-transform:uppercase;letter-spacing:0.1em;border-radius:2px}';
  html += '.meta{font-size:10px;color:#64748b;margin-bottom:16px;display:flex;gap:12px}';
  html += 'table{width:100%;border-collapse:collapse;margin-bottom:8px;font-size:11px}';
  html += 'th,td{text-align:left;padding:6px 10px;border-bottom:1px solid #1e293b}th{background:#0d1117;font-weight:600;font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:#64748b}';
  html += 'td{color:#8b94a5}td:nth-child(2){color:#e2e8f0;font-weight:500}';
  html += '.footer{margin-top:32px;font-size:8px;color:#475569;text-align:center;border-top:1px solid #1e293b;padding-top:12px;text-transform:uppercase;letter-spacing:0.15em}';
  html += '@media print{body{padding:16px;background:#fff;color:#111}h2{background:#f0f0f0;border-left-width:3px}th{background:#f8f8f8;color:#333}td{color:#555}td:nth-child(2){color:#111}.stat-val{background:none;-webkit-text-fill-color:#111;color:#111}.stats{background:#f8f8f8;border-color:#ddd}.footer{color:#999;border-top-color:#ddd}}</style></head><body>';
  html += '<h1>' + (workoutName && workoutName !== 'Untitled' ? workoutName.toUpperCase() : 'SATURNO MOVEMENT STUDIO') + '</h1>';
  html += '<div class="subtitle">' + (workoutName && workoutName !== 'Untitled' ? 'Saturno Movement Studio' : 'The Ableton of Movement') + '</div>';
  html += '<div class="meta"><span>' + bpm + ' BPM</span><span>' + mode + '</span><span>' + new Date().toLocaleDateString() + '</span></div>';
  html += '<div class="stats"><div class="stat"><div class="stat-val">' + totalClips + '</div><div class="stat-label">Exercises</div></div>';
  html += '<div class="stat"><div class="stat-val">' + totalSets + '</div><div class="stat-label">Sets</div></div>';
  html += '<div class="stat"><div class="stat-val">' + totalReps + '</div><div class="stat-label">Reps</div></div></div>';
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackColors = {push:'#3b82f6',pull:'#8b5cf6',core:'#f97316',legs:'#22c55e',skills:'#06b6d4'};
  Object.keys(groups).forEach(function(trackId) {
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.startTime - b.startTime; });
    html += '<h2 style="border-left-color:' + (trackColors[trackId] || '#3b82f6') + ';color:' + (trackColors[trackId] || '#e2e8f0') + '">' + (trackNames[trackId] || trackId) + '</h2>';
    html += '<table><tr><th>#</th><th>Exercise</th><th>Sets</th><th>Reps</th><th>Tempo</th><th>Rest</th><th>RPE</th><th>Notes</th></tr>';
    exercises.forEach(function(ex, i) {
      html += '<tr><td>'+(i+1)+'</td><td>'+ex.name+'</td><td>'+ex.sets+'</td><td>'+ex.reps+'</td><td>'+ex.tempo+'s</td><td>'+ex.rest+'s</td><td>'+ex.rpe+'</td><td></td></tr>';
    });
    html += '</table>';
  });
  html += '<div class="footer">Generated by Saturno Movement Studio / saturnomovement.com</div>';
  html += '</body></html>';
  var win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.print();
}

/* ===== TOAST ===== */
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

/* ===== SAVED WORKOUTS ===== */
function getSavedWorkouts() {
  try { return JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) { return []; }
}

function saveNamedWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var name = prompt('Workout name:');
  if (!name || !name.trim()) return;
  var workout = {
    name: name.trim(),
    created: new Date().toISOString(),
    bpm: bpm,
    clipCount: clips.length,
    state: captureState()
  };
  var saved = getSavedWorkouts();
  saved.unshift(workout);
  if (saved.length > 20) saved = saved.slice(0, 20);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  setWorkoutName(name.trim());
  toast('Saved: ' + name.trim());
}

function showSavedWorkouts() {
  var saved = getSavedWorkouts();
  var list = document.getElementById('saved-list');
  if (saved.length === 0) {
    list.innerHTML = '<div class="saved-empty">No saved workouts yet. Use SAVE AS to save one.</div>';
  } else {
    var html = '';
    saved.forEach(function(w, i) {
      var date = new Date(w.created).toLocaleDateString();
      var timeAgo = '';
      var diff = Date.now() - new Date(w.created).getTime();
      var hours = Math.floor(diff / 3600000);
      var days = Math.floor(diff / 86400000);
      if (days > 0) timeAgo = days + 'd ago';
      else if (hours > 0) timeAgo = hours + 'h ago';
      else timeAgo = 'just now';
      html += '<div class="saved-item" onclick="loadSavedWorkout('+i+')">';
      html += '<span class="saved-item-delete" onclick="event.stopPropagation();deleteSavedWorkout('+i+')">delete</span>';
      html += '<div class="saved-item-name">'+w.name+'</div>';
      html += '<div class="saved-item-info" style="display:flex;gap:8px;flex-wrap:wrap">';
      html += '<span>'+w.clipCount+' clips</span>';
      html += '<span style="color:var(--accent-orange)">'+w.bpm+' BPM</span>';
      html += '<span>'+timeAgo+'</span>';
      html += '</div></div>';
    });
    list.innerHTML = html;
  }
  document.getElementById('saved-modal').classList.add('open');
}

function closeSavedWorkouts() {
  document.getElementById('saved-modal').classList.remove('open');
}

function loadSavedWorkout(index) {
  var saved = getSavedWorkouts();
  if (!saved[index]) return;
  pushUndo();
  var state = JSON.parse(saved[index].state);
  restoreState(state);
  closeSavedWorkouts();
  setWorkoutName(saved[index].name);
  toast('Loaded: ' + saved[index].name);
}

function deleteSavedWorkout(index) {
  var saved = getSavedWorkouts();
  var name = saved[index] ? saved[index].name : '';
  saved.splice(index, 1);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  showSavedWorkouts();
  toast('Deleted: ' + name);
}

/* Close modal on overlay click */
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('saved-modal');
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeSavedWorkouts();
  });
});

/* ===== UNDO / REDO ===== */
function captureState() {
  var state = {bpm: bpm, clips: []};
  document.querySelectorAll('.clip').forEach(function(clip) {
    state.clips.push({
      exerciseId: clip.dataset.exerciseId,
      track: clip.parentElement.dataset.track,
      left: clip.style.left,
      width: clip.style.width,
      sets: clip.dataset.sets,
      reps: clip.dataset.reps,
      tempo: clip.dataset.tempo,
      rest: clip.dataset.rest,
      rpe: clip.dataset.rpe
    });
  });
  return JSON.stringify(state);
}

function updateUndoCount() {
  var el = document.getElementById('undo-count');
  if (el) el.textContent = undoStack.length > 0 || redoStack.length > 0 ? 'U:' + undoStack.length + ' R:' + redoStack.length : '';
}

function pushUndo() {
  var state = captureState();
  if (undoStack.length > 0 && undoStack[undoStack.length - 1] === state) return;
  undoStack.push(state);
  if (undoStack.length > maxUndo) undoStack.shift();
  redoStack = [];
  updateUndoCount();
}

function undo() {
  if (undoStack.length === 0) { toast('Nothing to undo'); return; }
  redoStack.push(captureState());
  var state = JSON.parse(undoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Undo');
  updateUndoCount();
}

function redo() {
  if (redoStack.length === 0) { toast('Nothing to redo'); return; }
  undoStack.push(captureState());
  var state = JSON.parse(redoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Redo');
  updateUndoCount();
}

function restoreState(state) {
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  if (state.bpm) { bpm = state.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
  state.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    var ex = getExercise(c.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, c.left, c.width, {
      sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe
    });
    track.appendChild(clip);
  });
  updateStats();
  saveSession();
}

/* ===== DUPLICATE CLIP ===== */
function duplicateClip() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var track = selectedClip.parentElement;
  var newLeft = parseInt(selectedClip.style.left) + parseInt(selectedClip.style.width) + 4;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe
  });
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  sfx('drop');
  toast('Duplicated: ' + ex.name);
}

/* ===== SNAP TO GRID ===== */
var snapEnabled = false;
var SNAP_SIZE = 80; // pixels per grid unit (15 seconds)

function toggleSnap() {
  snapEnabled = !snapEnabled;
  var btn = document.getElementById('btn-snap');
  if (btn) btn.classList.toggle('active', snapEnabled);
  var settingsBtn = document.getElementById('settings-snap');
  if (settingsBtn) settingsBtn.textContent = snapEnabled ? 'ON' : 'OFF';
  var snapBadge = document.getElementById('snap-badge');
  if (snapBadge) snapBadge.classList.toggle('active', snapEnabled);
  sfx('snap');
  toast(snapEnabled ? 'Snap ON' : 'Snap OFF');
}

function snapValue(val) {
  if (!snapEnabled) return val;
  var snapped = Math.round(val / SNAP_SIZE) * SNAP_SIZE;
  if (snapped !== val) showSnapLine(snapped);
  return snapped;
}
function showSnapLine(x) {
  var container = document.getElementById('timeline-tracks');
  if (!container) return;
  var line = document.createElement('div');
  line.className = 'snap-line';
  line.style.left = x + 'px';
  container.appendChild(line);
  setTimeout(function() { if (line.parentNode) line.remove(); }, 300);
}

/* ===== ZOOM ===== */
var zoomLevel = 100;
var ZOOM_STEPS = [50, 75, 100, 125, 150, 200];

function zoomIn() {
  var idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx < ZOOM_STEPS.length - 1) {
    zoomLevel = ZOOM_STEPS[idx + 1];
    applyZoom();
  }
}

function zoomOut() {
  var idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx > 0) {
    zoomLevel = ZOOM_STEPS[idx - 1];
    applyZoom();
  }
}

function zoomToFit() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to fit'); return; }
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  maxRight += 120; // padding for track headers + margin
  var containerW = document.getElementById('timeline-container').clientWidth;
  var targetZoom = Math.round(containerW / maxRight * 100);
  // Clamp to zoom steps
  var bestStep = ZOOM_STEPS[0];
  for (var i = 0; i < ZOOM_STEPS.length; i++) {
    if (ZOOM_STEPS[i] <= targetZoom) bestStep = ZOOM_STEPS[i];
  }
  zoomLevel = bestStep;
  applyZoom();
  document.getElementById('timeline-container').scrollLeft = 0;
  toast('Zoom to fit: ' + zoomLevel + '%');
}

function applyZoom() {
  var scale = zoomLevel / 100;
  var tracks = document.getElementById('timeline-tracks');
  var ruler = document.getElementById('timeline-ruler');
  tracks.style.transform = 'scaleX(' + scale + ')';
  tracks.style.transformOrigin = 'left top';
  ruler.style.transform = 'scaleX(' + scale + ')';
  ruler.style.transformOrigin = 'left top';
  document.getElementById('zoom-level').textContent = zoomLevel + '%';
  // Sync footer zoom slider
  var sliderIdx = ZOOM_STEPS.indexOf(zoomLevel);
  if (sliderIdx >= 0) {
    var slider = document.getElementById('zoom-slider');
    if (slider) slider.value = sliderIdx;
  }
  var pct = document.getElementById('zoom-pct');
  if (pct) pct.textContent = zoomLevel + '%';
  // Toggle 16th note grid at higher zoom levels
  var trackContents = document.querySelectorAll('.track-content');
  trackContents.forEach(function(tc) {
    if (zoomLevel >= 125) {
      tc.classList.add('grid-16th');
    } else {
      tc.classList.remove('grid-16th');
    }
  });
  sfx('click');
}

function setZoomFromSlider(val) {
  var idx = parseInt(val);
  if (idx >= 0 && idx < ZOOM_STEPS.length) {
    zoomLevel = ZOOM_STEPS[idx];
    applyZoom();
  }
}

/* ===== CONTEXT MENU ===== */
var ctxClip = null, ctxExercise = null;
function showClipContextMenu(x, y, clip, exercise) {
  ctxClip = clip;
  ctxExercise = exercise;
  var menu = document.getElementById('clip-context-menu');
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.add('open');
  // Adjust if overflows viewport
  var rect = menu.getBoundingClientRect();
  if (rect.right > window.innerWidth) menu.style.left = (x - rect.width) + 'px';
  if (rect.bottom > window.innerHeight) menu.style.top = (y - rect.height) + 'px';
}

function hideContextMenu() {
  document.getElementById('clip-context-menu').classList.remove('open');
  ctxClip = null;
  ctxExercise = null;
}

document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.clip-context-menu')) hideContextMenu();
  });
  document.getElementById('clip-context-menu').addEventListener('click', function(e) {
    var item = e.target.closest('.ctx-item');
    if (!item || !ctxClip) return;
    var action = item.dataset.action;
    if (action === 'duplicate') {
      selectClipEl(ctxClip);
      duplicateClip();
    } else if (action === 'inspect') {
      selectClipEl(ctxClip);
    } else if (action === 'split') {
      selectClipEl(ctxClip);
      splitClipAtPlayhead();
    } else if (action === 'snap-start') {
      pushUndo();
      ctxClip.style.left = '0px';
      saveSession(); updateStats();
      toast('Snapped to start');
    } else if (action === 'snap-next') {
      pushUndo();
      var track = ctxClip.parentElement;
      var clips = track.querySelectorAll('.clip');
      var maxRight = 0;
      clips.forEach(function(c) {
        if (c === ctxClip) return;
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      ctxClip.style.left = (maxRight + 2) + 'px';
      saveSession(); updateStats();
      toast('Snapped after previous');
    } else if (action.indexOf('move-') === 0) {
      var targetTrackId = action.replace('move-', '');
      var targetTrack = document.querySelector('.track-content[data-track="'+targetTrackId+'"]');
      if (targetTrack && ctxClip.parentElement !== targetTrack) {
        pushUndo();
        targetTrack.appendChild(ctxClip);
        updateStats(); saveSession();
        sfx('drop');
        toast('Moved to ' + targetTrackId);
      }
    } else if (action === 'delete') {
      pushUndo();
      ctxClip.remove();
      if (selectedClip === ctxClip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      sfx('delete');
      toast('Clip deleted');
    }
    hideContextMenu();
  });
});

/* ===== CLICK-TO-SEEK ON RULER ===== */
document.addEventListener('DOMContentLoaded', function() {
  var ruler = document.getElementById('timeline-ruler');
  ruler.style.cursor = 'pointer';
  ruler.addEventListener('click', function(e) {
    var rect = ruler.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = 80 / 15;
    currentTime = Math.max(0, (x - 100) / pps);
    updateTimeDisplay();
    updatePlayheadPosition();
    sfx('click');
  });
  /* Click track header to highlight active track, double-click to collapse */
  document.querySelectorAll('.track-header').forEach(function(header) {
    header.addEventListener('click', function() {
      document.querySelectorAll('.track.track-active').forEach(function(t) { t.classList.remove('track-active'); });
      header.closest('.track').classList.add('track-active');
    });
    header.addEventListener('dblclick', function() {
      header.closest('.track').classList.toggle('track-collapsed');
    });
    header.addEventListener('contextmenu', function(e) {
      showTrackCtx(e, header.closest('.track'));
    });
  });
  /* Timecode scrub — drag on time display to scrub */
  var timeDisp = document.getElementById('time-display');
  timeDisp.style.cursor = 'ew-resize';
  timeDisp.addEventListener('mousedown', function(e) {
    e.preventDefault();
    var startX = e.clientX;
    var startTime = currentTime;
    function onMove(e) {
      var delta = (e.clientX - startX) * 0.5; // 0.5s per pixel
      currentTime = Math.max(0, startTime + delta);
      updateTimeDisplay();
      updatePlayheadPosition();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Click on empty timeline area to seek */
  var tracks = document.getElementById('timeline-tracks');
  tracks.addEventListener('click', function(e) {
    if (e.target.closest('.clip') || e.target.closest('.track-header')) return;
    var rect = tracks.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = 80 / 15;
    var scale = zoomLevel / 100;
    currentTime = Math.max(0, (x / scale - 100) / pps);
    updateTimeDisplay();
    updatePlayheadPosition();
  });
  /* Rubber band selection on timeline */
  tracks.addEventListener('mousedown', function(e) {
    if (e.target.closest('.clip') || e.target.closest('.track-header') || e.button !== 0) return;
    var container = document.getElementById('timeline-container');
    var rect = tracks.getBoundingClientRect();
    var startX = e.clientX - rect.left + container.scrollLeft;
    var startY = e.clientY - rect.top + container.scrollTop;
    var box = document.createElement('div');
    box.className = 'select-box';
    tracks.appendChild(box);
    function onMove(e) {
      var curX = e.clientX - rect.left + container.scrollLeft;
      var curY = e.clientY - rect.top + container.scrollTop;
      var x1 = Math.min(startX, curX), x2 = Math.max(startX, curX);
      var y1 = Math.min(startY, curY), y2 = Math.max(startY, curY);
      box.style.left = x1 + 'px';
      box.style.top = y1 + 'px';
      box.style.width = (x2 - x1) + 'px';
      box.style.height = (y2 - y1) + 'px';
      // Highlight clips inside selection box
      document.querySelectorAll('.clip').forEach(function(c) {
        var cl = parseInt(c.style.left) || 0;
        var cw = parseInt(c.style.width) || 0;
        var ct = c.closest('.track');
        var tOff = ct ? ct.offsetTop : 0;
        var ch = ct ? ct.offsetHeight : 60;
        var inX = cl + cw > x1 && cl < x2;
        var inY = tOff + ch > y1 && tOff < y2;
        if (inX && inY) {
          c.classList.add('selected');
        } else if (!e.shiftKey) {
          c.classList.remove('selected');
        }
      });
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      box.remove();
      var sel = document.querySelectorAll('.clip.selected');
      if (sel.length > 0) {
        selectedClip = sel[sel.length - 1];
        toast(sel.length + ' clip' + (sel.length > 1 ? 's' : '') + ' selected');
      }
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
});

/* ===== MOUSE WHEEL ZOOM on Timeline ===== */
document.addEventListener('DOMContentLoaded', function() {
  var container = document.getElementById('timeline-container');
  container.addEventListener('wheel', function(e) {
    if (e.metaKey || e.ctrlKey) {
      e.preventDefault();
      if (e.deltaY < 0) { zoomIn(); } else { zoomOut(); }
    }
  }, { passive: false });
});

/* ===== TRACK RESIZE HANDLES ===== */
document.addEventListener('DOMContentLoaded', function() {
  var allTracks = document.querySelectorAll('.track');
  allTracks.forEach(function(track, i) {
    if (i === allTracks.length - 1) return; // no handle on last track
    var handle = document.createElement('div');
    handle.className = 'track-resize-handle';
    track.parentElement.insertBefore(handle, track.nextSibling);
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      var startY = e.clientY;
      var startH = track.offsetHeight;
      function onMove(e) {
        var newH = Math.max(24, Math.min(200, startH + (e.clientY - startY)));
        track.style.height = newH + 'px';
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
});

/* ===== PLAYHEAD ANIMATION ===== */
function updatePlayheadClass() {
  var ph = document.getElementById('playhead');
  if (isPlaying) { ph.classList.add('playing'); } else { ph.classList.remove('playing'); }
}

var focusMode = false;
function toggleFocusMode() {
  focusMode = !focusMode;
  var main = document.querySelector('.main');
  var indicator = document.getElementById('focus-indicator');
  if (focusMode) {
    main.classList.add('focus-mode');
    indicator.classList.add('visible');
    toast('Focus mode — press F to exit');
  } else {
    main.classList.remove('focus-mode');
    indicator.classList.remove('visible');
    toast('Focus mode off');
  }
  sfx('click');
}

function updateStatusDot() {
  var dot = document.querySelector('.status-dot');
  if (!dot) return;
  dot.classList.remove('playing', 'recording');
  if (isRecording) { dot.classList.add('recording'); }
  else if (isPlaying) { dot.classList.add('playing'); }
  // Sync BPM pulse timing
  var d = (60 / bpm).toFixed(3);
  dot.style.setProperty('--bpm-duration', d + 's');
}

/* ===== MARKERS ===== */
function addMarker() {
  markerCounter++;
  var pps = 80 / 15;
  var pos = 100 + currentTime * pps;
  var marker = {id: markerCounter, time: currentTime, label: 'M' + markerCounter};
  markers.push(marker);
  renderMarker(marker);
  sfx('click');
  toast('Marker ' + markerCounter + ' at ' + formatTime(currentTime));
}

function renderMarker(marker) {
  var pps = 80 / 15;
  var pos = 100 + marker.time * pps;
  var el = document.createElement('div');
  el.className = 'marker';
  el.dataset.markerId = marker.id;
  el.style.left = pos + 'px';
  el.innerHTML = '<div class="marker-flag">' + marker.label + '</div><div class="marker-line"></div>';
  el.addEventListener('click', function(e) {
    e.stopPropagation();
    currentTime = marker.time;
    updateTimeDisplay();
    updatePlayheadPosition();
    sfx('click');
  });
  el.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    el.remove();
    markers = markers.filter(function(m) { return m.id !== marker.id; });
    sfx('delete');
    toast('Marker removed');
  });
  document.getElementById('timeline-tracks').appendChild(el);
}

function renderAllMarkers() {
  document.querySelectorAll('.marker').forEach(function(m) { m.remove(); });
  markers.forEach(function(m) { renderMarker(m); });
}

/* ===== FOOTER MODE TOGGLE ===== */
var footerMode = 'bars'; // 'bars' or 'time'
function toggleFooterMode() {
  footerMode = footerMode === 'bars' ? 'time' : 'bars';
  updateTimeDisplay();
  toast('Position: ' + (footerMode === 'bars' ? 'Bars.Beats.Ticks' : 'Time'));
}

/* ===== COMMAND PALETTE ===== */
var CMD_ACTIONS = [
  {label:'Play / Pause', key:'Space', icon:'\u25B6', action: function() { togglePlay(); }},
  {label:'Stop', key:'Esc', icon:'\u25A0', action: function() { stopPlayback(); }},
  {label:'Toggle Snap', key:'S', icon:'\u2593', action: function() { toggleSnap(); }},
  {label:'Toggle Loop', key:'L', icon:'\u21BB', action: function() { toggleLoop(); }},
  {label:'Toggle Metronome', key:'', icon:'\u266A', action: function() { toggleMetronome(); }},
  {label:'Add Marker', key:'M', icon:'\u2691', action: function() { addMarker(); }},
  {label:'Split Clip', key:'B', icon:'\u2702', action: function() { splitClipAtPlayhead(); }},
  {label:'Copy Clips', key:'Cmd+C', icon:'\u2398', action: function() { copyClips(); }},
  {label:'Paste Clips', key:'Cmd+V', icon:'\u2398', action: function() { pasteClips(); }},
  {label:'Duplicate Clip', key:'Cmd+D', icon:'\u2398', action: function() { duplicateClip(); }},
  {label:'Duplicate Track', key:'Cmd+Shift+D', icon:'\u2398', action: function() { duplicateTrackClips(); }},
  {label:'Zoom to Fit', key:'', icon:'\u2922', action: function() { zoomToFit(); }},
  {label:'Zoom In', key:'Cmd++', icon:'+', action: function() { zoomIn(); }},
  {label:'Zoom Out', key:'Cmd+-', icon:'-', action: function() { zoomOut(); }},
  {label:'Zoom Reset (100%)', key:'Cmd+0', icon:'1:1', action: function() { zoomLevel = 100; applyZoom(); toast('Zoom reset: 100%'); }},
  {label:'Toggle Focus Mode', key:'F', icon:'\u2B1C', action: function() { toggleFocusMode(); }},
  {label:'Tap Tempo', key:'T', icon:'\u266A', action: function() { tapTempo(); }},
  {label:'Select All Clips', key:'Cmd+A', icon:'\u2610', action: function() { document.querySelectorAll('.clip').forEach(function(c){c.classList.add('selected')}); toast('All selected'); }},
  {label:'Quantize All Clips', key:'Q', icon:'\u2593', action: function() { quantizeClips(); }},
  {label:'Auto-Arrange Clips', key:'', icon:'\u21F6', action: function() { autoArrange(); }},
  {label:'Clear All Clips', key:'', icon:'\u2716', action: function() { clearAllClips(); }},
  {label:'Save Session', key:'Cmd+S', icon:'\u2913', action: function() { saveSession(); sfx('click'); toast('Session saved'); }},
  {label:'Save as Named Workout', key:'', icon:'\u2913', action: function() { saveNamedWorkout(); }},
  {label:'Load Workout', key:'', icon:'\u2912', action: function() { showSavedWorkouts(); }},
  {label:'Export JSON', key:'', icon:'\u21A6', action: function() { exportWorkout(); }},
  {label:'Import Workout', key:'', icon:'\u21A4', action: function() { importWorkout(); }},
  {label:'Print Sheet', key:'', icon:'\u2399', action: function() { printWorkout(); }},
  {label:'Generate Random', key:'', icon:'\u2684', action: function() { generateRandom(); }},
  {label:'Rename Workout', key:'', icon:'\u270E', action: function() { renameWorkout(); }},
  {label:'Toggle Presets', key:'', icon:'\u2630', action: function() { togglePresets(); }},
  {label:'Keyboard Shortcuts', key:'?', icon:'\u2328', action: function() { toggleShortcuts(); }},
  {label:'Reset Session', key:'', icon:'\u21BA', action: function() { resetSession(); }},
];

function openCmdPalette() {
  var pal = document.getElementById('cmd-palette');
  pal.classList.add('open');
  var input = document.getElementById('cmd-input');
  input.value = '';
  input.focus();
  renderCommands('');
}

function closeCmdPalette() {
  document.getElementById('cmd-palette').classList.remove('open');
}

function filterCommands() {
  renderCommands(document.getElementById('cmd-input').value.toLowerCase());
}

function renderCommands(q) {
  var results = document.getElementById('cmd-results');
  var filtered = CMD_ACTIONS.filter(function(a) {
    return !q || a.label.toLowerCase().indexOf(q) !== -1;
  });
  var html = '';
  filtered.forEach(function(a, i) {
    html += '<div class="cmd-result' + (i === 0 ? ' active' : '') + '" data-idx="' + CMD_ACTIONS.indexOf(a) + '">';
    html += '<span class="cmd-result-icon">' + a.icon + '</span>';
    html += '<span class="cmd-result-text">' + a.label + '</span>';
    if (a.key) html += '<span class="cmd-result-key">' + a.key + '</span>';
    html += '</div>';
  });
  results.innerHTML = html || '<div style="padding:12px 16px;font-size:10px;color:var(--micro)">No commands found</div>';
  // Click handlers
  results.querySelectorAll('.cmd-result').forEach(function(el) {
    el.addEventListener('click', function() {
      var idx = parseInt(el.dataset.idx);
      closeCmdPalette();
      CMD_ACTIONS[idx].action();
    });
  });
}

// Cmd+K to open, Escape to close
document.getElementById('cmd-palette').addEventListener('click', function(e) {
  if (e.target === document.getElementById('cmd-palette')) closeCmdPalette();
});
document.getElementById('cmd-input').addEventListener('keydown', function(e) {
  if (e.code === 'Escape') { closeCmdPalette(); e.stopPropagation(); return; }
  if (e.code === 'Enter') {
    var active = document.querySelector('.cmd-result.active');
    if (active) {
      closeCmdPalette();
      var idx = parseInt(active.dataset.idx);
      CMD_ACTIONS[idx].action();
    }
    return;
  }
  if (e.code === 'ArrowDown' || e.code === 'ArrowUp') {
    e.preventDefault();
    var items = Array.from(document.querySelectorAll('.cmd-result'));
    var cur = items.findIndex(function(el) { return el.classList.contains('active'); });
    items.forEach(function(el) { el.classList.remove('active'); });
    if (e.code === 'ArrowDown') cur = (cur + 1) % items.length;
    else cur = (cur - 1 + items.length) % items.length;
    if (items[cur]) { items[cur].classList.add('active'); items[cur].scrollIntoView({block:'nearest'}); }
  }
});

/* ===== WORKOUT NAME ===== */
var workoutName = 'Untitled';
function setWorkoutName(name) {
  workoutName = name;
  document.getElementById('workout-name').textContent = name;
}
function renameWorkout() {
  var name = prompt('Workout name:', workoutName);
  if (name && name.trim()) {
    setWorkoutName(name.trim());
    saveSession();
    toast('Renamed: ' + workoutName);
  }
}

/* ===== CLIP SPLIT ===== */
function splitClipAtPlayhead() {
  if (!selectedClip) { toast('Select a clip to split'); return; }
  var pps = 80 / 15;
  var clipLeft = parseInt(selectedClip.style.left);
  var clipW = parseInt(selectedClip.style.width);
  var splitPos = 100 + currentTime * pps;
  // Check if playhead is within the clip
  if (splitPos <= clipLeft || splitPos >= clipLeft + clipW) {
    toast('Move playhead inside clip to split');
    return;
  }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var leftW = splitPos - clipLeft;
  var rightW = clipW - leftW;
  // Resize current clip to left portion
  selectedClip.style.width = leftW + 'px';
  var canvas = selectedClip.querySelector('.clip-waveform');
  if (canvas) drawClipWaveform(canvas, 'rgba(255,255,255,0.55)', leftW + 'px');
  addBeatMarkers(selectedClip, leftW);
  // Create right portion
  var dna = {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe
  };
  var rightClip = createClipElement(ex, splitPos, rightW, dna);
  selectedClip.parentElement.appendChild(rightClip);
  updateStats(); saveSession();
  sfx('click');
  toast('Clip split at ' + formatTime(currentTime));
}

/* ===== DUPLICATE TRACK CLIPS ===== */
function duplicateTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = activeTrack.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in track'); return; }
  pushUndo();
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var offset = maxRight + 8;
  var count = 0;
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var newLeft = parseInt(c.style.left) + offset;
    var dna = {
      sets: c.dataset.sets, reps: c.dataset.reps,
      tempo: c.dataset.tempo, rest: c.dataset.rest, rpe: c.dataset.rpe
    };
    var dup = createClipElement(ex, newLeft, parseInt(c.style.width), dna);
    activeTrack.appendChild(dup);
    count++;
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(count + ' clips duplicated');
}

/* ===== CUSTOM CLIP TOOLTIP ===== */
var tipTimer = null;
document.addEventListener('mouseover', function(e) {
  var clipEl = e.target.closest('.clip');
  if (!clipEl) return;
  clearTimeout(tipTimer);
  tipTimer = setTimeout(function() {
    var ex = getExercise(clipEl.dataset.exerciseId);
    if (!ex) return;
    var tip = document.getElementById('clip-tip');
    document.getElementById('tip-name').textContent = ex.name;
    document.getElementById('tip-pattern').textContent = ex.pattern;
    document.getElementById('tip-stage').textContent = 'Stage ' + ex.stage;
    document.getElementById('tip-discipline').textContent = ex.discipline;
    document.getElementById('tip-dna').textContent = clipEl.dataset.sets + 'x' + clipEl.dataset.reps + ' @ RPE ' + clipEl.dataset.rpe;
    var fm = FAMILY_MAP[ex.family] || {};
    document.getElementById('tip-instrument').textContent = fm.instrument || '';
    var rect = clipEl.getBoundingClientRect();
    tip.style.left = (rect.left + rect.width / 2) + 'px';
    tip.style.top = (rect.top - 40) + 'px';
    tip.style.transform = 'translateX(-50%)';
    tip.classList.add('show');
  }, 400);
});
document.addEventListener('mouseout', function(e) {
  if (e.target.closest('.clip')) {
    clearTimeout(tipTimer);
    document.getElementById('clip-tip').classList.remove('show');
  }
});

/* ===== TRACK HEADER CONTEXT MENU ===== */
var trackCtxTarget = null;
function showTrackCtx(e, trackEl) {
  e.preventDefault();
  trackCtxTarget = trackEl;
  var ctx = document.getElementById('track-ctx');
  ctx.style.left = e.clientX + 'px';
  ctx.style.top = e.clientY + 'px';
  ctx.classList.add('open');
}
function hideTrackCtx() {
  document.getElementById('track-ctx').classList.remove('open');
  trackCtxTarget = null;
}
document.addEventListener('click', function() { hideTrackCtx(); });
document.getElementById('track-ctx').addEventListener('click', function(e) {
  var item = e.target.closest('.track-ctx-item');
  if (!item || !trackCtxTarget) return;
  var action = item.dataset.action;
  var content = trackCtxTarget.querySelector('.track-content');
  if (action === 'solo') {
    var btn = trackCtxTarget.querySelector('.track-btn:nth-child(2)');
    if (btn) toggleSolo(btn);
  } else if (action === 'mute') {
    var btn = trackCtxTarget.querySelector('.track-btn:nth-child(1)');
    if (btn) toggleMute(btn);
  } else if (action === 'select-all') {
    if (content) content.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
    toast('Track clips selected');
  } else if (action === 'collapse') {
    trackCtxTarget.classList.toggle('track-collapsed');
  } else if (action === 'collapse-all') {
    var allCollapsed = true;
    document.querySelectorAll('.track').forEach(function(t) { if (!t.classList.contains('track-collapsed') && t.dataset.track !== 'music') allCollapsed = false; });
    document.querySelectorAll('.track').forEach(function(t) { if (t.dataset.track !== 'music') t.classList.toggle('track-collapsed', !allCollapsed); });
    toast(allCollapsed ? 'Tracks expanded' : 'Tracks collapsed');
  } else if (action === 'clear') {
    if (content) {
      var clips = content.querySelectorAll('.clip');
      if (clips.length === 0) { toast('Track is empty'); hideTrackCtx(); return; }
      pushUndo();
      clips.forEach(function(c) { c.remove(); });
      updateStats(); saveSession();
      sfx('delete');
      toast(clips.length + ' clips cleared');
    }
  }
  hideTrackCtx();
});

/* ===== RIGHT PANEL TABS ===== */
function switchPanelTab(tabId) {
  document.querySelectorAll('.panel-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.panel-tab-content').forEach(function(c) { c.classList.remove('active'); });
  document.querySelector('.panel-tab[data-tab="'+tabId+'"]').classList.add('active');
  document.getElementById('tab-'+tabId).classList.add('active');
}

/* ===== EMPTY TIMELINE STATE ===== */
function updateEmptyState() {
  var clips = document.querySelectorAll('.clip');
  var el = document.getElementById('timeline-empty');
  if (!el) return;
  if (clips.length > 0) {
    el.classList.add('hidden');
  } else {
    el.classList.remove('hidden');
  }
}

/* ===== SETTINGS FUNCTIONS ===== */
var gridRes = 4;
var autoScrollEnabled = true;
var sfxEnabled = true;
var metroVolume = 0.5;

function setGridRes(val) {
  gridRes = parseInt(val);
  toast('Grid: ' + gridRes + ' beat' + (gridRes > 1 ? 's' : ''));
}

function toggleAutoScroll() {
  autoScrollEnabled = !autoScrollEnabled;
  document.getElementById('settings-autoscroll').textContent = autoScrollEnabled ? 'ON' : 'OFF';
  toast('Auto-scroll ' + (autoScrollEnabled ? 'on' : 'off'));
}

function toggleSFXSetting() {
  sfxEnabled = !sfxEnabled;
  document.getElementById('settings-sfx').textContent = sfxEnabled ? 'ON' : 'OFF';
  toast('UI sounds ' + (sfxEnabled ? 'on' : 'off'));
}

/* ===== QUANTIZE — Snap All Clips to Grid ===== */
function quantizeClips() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to quantize'); return; }
  pushUndo();
  var beatPx = 80 / 4; // pixels per beat at standard zoom
  clips.forEach(function(c) {
    var left = parseInt(c.style.left) || 0;
    c.style.left = Math.round(left / beatPx) * beatPx + 'px';
  });
  saveSession();
  sfx('snap');
  toast(clips.length + ' clips quantized');
}

/* ===== CLIPBOARD — Copy/Paste Clips ===== */
var clipboardData = [];

function copyClips() {
  var selected = document.querySelectorAll('.clip.selected');
  if (selected.length === 0) { toast('No clips selected'); return; }
  clipboardData = [];
  selected.forEach(function(c) {
    clipboardData.push({
      exerciseId: c.dataset.exerciseId,
      left: parseInt(c.style.left),
      width: parseInt(c.style.width),
      track: c.parentElement.dataset.track,
      sets: c.dataset.sets,
      reps: c.dataset.reps,
      tempo: c.dataset.tempo,
      rest: c.dataset.rest,
      rpe: c.dataset.rpe
    });
  });
  sfx('click');
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' copied');
}

function pasteClips() {
  if (clipboardData.length === 0) { toast('Nothing to paste'); return; }
  pushUndo();
  var offset = 40; // paste slightly offset from original
  clipboardData.forEach(function(cd) {
    var track = document.querySelector('.track-content[data-track="'+cd.track+'"]');
    var ex = getExercise(cd.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, cd.left + offset, cd.width, {
      sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe
    });
    track.appendChild(clip);
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' pasted');
}

/* ===== AUTO-ARRANGE — Lay Out Clips Sequentially ===== */
function autoArrange() {
  var tracks = document.querySelectorAll('.track-content');
  var totalMoved = 0;
  pushUndo();
  tracks.forEach(function(track) {
    if (track.dataset.track === 'music') return;
    var clips = Array.from(track.querySelectorAll('.clip'));
    if (clips.length === 0) return;
    clips.sort(function(a, b) { return (parseInt(a.style.left) || 0) - (parseInt(b.style.left) || 0); });
    var pos = 0;
    var gap = 2;
    clips.forEach(function(c) {
      var old = parseInt(c.style.left) || 0;
      c.style.left = pos + 'px';
      if (old !== pos) totalMoved++;
      pos += (parseInt(c.style.width) || 80) + gap;
    });
  });
  saveSession(); updateStats();
  sfx('snap');
  toast(totalMoved + ' clips arranged');
}

function clearAllClips() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to clear'); return; }
  pushUndo();
  clips.forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession(); updateEmptyState();
  sfx('delete');
  toast(clips.length + ' clips cleared');
}

function resetSession() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  bpm = 120;
  document.getElementById('bpm-input').value = 120;
  updateBPMMode(); buildRuler();
  updateStats(); updateEmptyState();
  try { localStorage.removeItem('saturno-studio-session'); } catch(e) {}
  sfx('delete');
  toast('Session reset');
}

/* ===== SHORTCUTS OVERLAY ===== */
function toggleShortcuts() {
  var overlay = document.getElementById('shortcuts-overlay');
  overlay.classList.toggle('open');
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'Escape') {
    stopPlayback();
    closeSavedWorkouts();
    var so = document.getElementById('shortcuts-overlay');
    if (so.classList.contains('open')) so.classList.remove('open');
  }
  if (e.key === '?' || e.code === 'Slash') {
    toggleShortcuts();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyZ') {
    e.preventDefault();
    if (e.shiftKey) { redo(); } else { undo(); }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyS') {
    e.preventDefault();
    saveSession();
    sfx('click');
    toast('Session saved');
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyK') {
    e.preventDefault();
    openCmdPalette();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyD') {
    e.preventDefault();
    duplicateTrackClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyC') {
    e.preventDefault();
    copyClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyV') {
    e.preventDefault();
    pasteClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyD') {
    e.preventDefault();
    duplicateClip();
    return;
  }
  if (e.code === 'KeyB' && !e.metaKey && !e.ctrlKey) {
    splitClipAtPlayhead();
  }
  // Arrow keys to nudge selected clip
  if ((e.code === 'ArrowLeft' || e.code === 'ArrowRight') && selectedClip && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var pps = 80 / 15;
    var beatSec = 60 / bpm;
    var nudge = e.shiftKey ? (beatSec * 4 * pps) : (beatSec * pps); // bar or beat
    var curLeft = parseInt(selectedClip.style.left);
    if (e.code === 'ArrowLeft') curLeft = Math.max(0, curLeft - nudge);
    if (e.code === 'ArrowRight') curLeft = curLeft + nudge;
    selectedClip.style.left = Math.round(curLeft) + 'px';
    saveSession(); updateStats();
  }
  if (e.code === 'KeyS' && !e.metaKey && !e.ctrlKey) {
    toggleSnap();
  }
  if (e.code === 'KeyL' && !e.metaKey && !e.ctrlKey) {
    toggleLoop();
  }
  if (e.code === 'KeyM' && !e.metaKey && !e.ctrlKey) {
    addMarker();
  }
  if (e.code === 'KeyR' && !e.metaKey && !e.ctrlKey) {
    toggleRec();
  }
  if (e.code === 'KeyQ' && !e.metaKey && !e.ctrlKey) {
    quantizeClips();
  }
  if (e.code === 'KeyF' && !e.metaKey && !e.ctrlKey) {
    toggleFocusMode();
  }
  if (e.code === 'KeyT' && !e.metaKey && !e.ctrlKey) {
    tapTempo();
  }
  if (e.code === 'Equal' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomIn(); return;
  }
  if (e.code === 'Minus' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomOut(); return;
  }
  if (e.code === 'Digit0' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomLevel = 100; applyZoom(); toast('Zoom reset: 100%'); return;
  }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    var selectedClips = document.querySelectorAll('.clip.selected');
    if (selectedClips.length > 0) {
      pushUndo();
      var count = selectedClips.length;
      selectedClips.forEach(function(c) { c.remove(); });
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
      updateStats(); saveSession();
      sfx('delete');
      toast(count + ' clip' + (count > 1 ? 's' : '') + ' deleted');
    }
  }
  // Select all clips with Cmd+A
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyA') {
    e.preventDefault();
    document.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
    toast('All clips selected');
  }
  // Number keys 1-6 to select track
  if (e.key >= '1' && e.key <= '6' && !e.metaKey && !e.ctrlKey && !e.altKey) {
    var trackIds = ['music','push','pull','core','legs','skills'];
    var idx = parseInt(e.key) - 1;
    if (idx < trackIds.length) {
      document.querySelectorAll('.track.track-active').forEach(function(t) { t.classList.remove('track-active'); });
      var target = document.querySelector('.track[data-track="'+trackIds[idx]+'"]');
      if (target) {
        target.classList.add('track-active');
        toast('Track: ' + trackIds[idx].charAt(0).toUpperCase() + trackIds[idx].slice(1));
      }
    }
  }
  // Tab to cycle through clips
  if (e.code === 'Tab' && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var allClips = Array.from(document.querySelectorAll('.clip'));
    if (allClips.length === 0) return;
    var currentIdx = selectedClip ? allClips.indexOf(selectedClip) : -1;
    var nextIdx = e.shiftKey ? (currentIdx - 1 + allClips.length) % allClips.length : (currentIdx + 1) % allClips.length;
    selectClipEl(allClips[nextIdx]);
    sfx('click');
  }
});

/* Autosave every 30 seconds */
setInterval(function() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length > 0) saveSession();
}, 30000);
</script>
</body>
</html>
