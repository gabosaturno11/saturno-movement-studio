<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<title>SATURNO MOVEMENT STUDIO - The Ableton of Movement</title>
<meta name="description" content="The Ableton of Movement. DAW-style workout composition with drag-drop exercises, BPM training modes, and music sync.">
<meta property="og:title" content="Saturno Movement Studio">
<meta property="og:description" content="The Ableton of Movement. Compose workouts like music.">
<meta property="og:type" content="website">
<link rel="icon" href="assets/planet-logo.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050711;--bg-panel:#0a0e1a;--bg-card:#0d1117;--bg-hover:#111827;
  --border:rgba(255,255,255,0.08);--border-hover:rgba(6,182,212,0.4);
  --text:#fff;--text-secondary:rgba(255,255,255,0.7);--text-muted:rgba(255,255,255,0.4);
  --accent-cyan:#06b6d4;--accent-blue:#3b82f6;--accent-purple:#8b5cf6;
  --accent-green:#22c55e;--accent-orange:#f97316;--accent-red:#ef4444;
  --accent-amber:#f59e0b;--accent-pink:#ec4899;
  --gradient:linear-gradient(135deg,#06b6d4 0%,#8b5cf6 100%);
  --gradient-warm:linear-gradient(135deg,#f97316 0%,#ef4444 100%);
}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
.app{display:grid;grid-template-rows:52px 1fr 44px;height:100vh}

/* ===== HEADER ===== */
.header{background:var(--bg-panel);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:28px;height:28px;border-radius:50%;background:var(--gradient);display:flex;align-items:center;justify-content:center}
.logo-icon img{width:18px;height:18px;filter:brightness(0) invert(1)}
.logo-text{font-size:13px;font-weight:700;letter-spacing:-0.02em;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo-sub{font-size:9px;color:var(--text-muted);letter-spacing:0.05em;text-transform:uppercase}
.header-nav{display:flex;gap:6px;align-items:center}
.nav-btn{padding:6px 12px;font-size:10px;font-family:'Sora',sans-serif;background:transparent;border:1px solid var(--border);color:var(--text-secondary);cursor:pointer;transition:border-color 0.15s,color 0.15s,background 0.15s;letter-spacing:0.02em}
.nav-btn:hover{border-color:var(--accent-cyan);color:var(--accent-cyan)}
.nav-btn.active{background:rgba(6,182,212,0.15);border-color:var(--accent-cyan);color:var(--accent-cyan)}
.preset-select{padding:6px 10px;font-size:10px;font-family:'Sora',sans-serif;background:var(--bg-card);border:1px solid var(--border);color:var(--text);cursor:pointer}

/* ===== MAIN 3-PANEL ===== */
.main{display:grid;grid-template-columns:200px 1fr 240px;overflow:hidden}

/* ===== LEFT PANEL: MOVEMENT LIBRARY ===== */
.panel-left{background:var(--bg-panel);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}
.panel-header{padding:10px 12px;border-bottom:1px solid var(--border);font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);display:flex;justify-content:space-between;align-items:center}
.lib-search{width:100%;padding:6px 10px;font-size:11px;font-family:'Sora',sans-serif;background:var(--bg);border:1px solid var(--border);color:var(--text);margin:8px;width:calc(100% - 16px)}
.lib-search:focus{outline:none;border-color:var(--accent-cyan)}
.movement-category{border-bottom:1px solid var(--border)}
.category-header{padding:8px 12px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background 0.15s}
.category-header:hover{background:var(--bg-hover)}
.category-header .arrow{font-size:8px;transition:transform 0.2s}
.category-header.collapsed .arrow{transform:rotate(-90deg)}
.category-color{width:8px;height:8px;border-radius:2px}
.movement-list{padding:2px 6px 6px}
.movement-list.hidden{display:none}
.movement-item{padding:6px 8px;margin:1px 0;font-size:10px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:border-color 0.15s,background 0.15s;display:flex;align-items:center;gap:6px}
.movement-item:hover{border-color:var(--accent-cyan);background:var(--bg-hover)}
.movement-item:active{cursor:grabbing}
.movement-item .mv-icon{width:20px;height:20px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;flex-shrink:0}
.movement-item .mv-stage{font-size:7px;color:var(--text-muted);margin-left:auto}

/* ===== CENTER PANEL ===== */
.panel-center{display:flex;flex-direction:column;overflow:hidden}

/* Transport Bar */
.transport{background:var(--bg-panel);border-bottom:1px solid var(--border);padding:8px 16px;display:flex;align-items:center;gap:12px}
.transport-buttons{display:flex;gap:3px}
.transport-btn{width:30px;height:30px;background:var(--bg-card);border:1px solid var(--border);color:var(--text);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:border-color 0.15s,background 0.15s,color 0.15s;font-family:'Sora',sans-serif}
.transport-btn:hover{border-color:var(--accent-cyan)}
.transport-btn.active{background:var(--accent-green);border-color:var(--accent-green);color:#000}
.transport-btn.rec.active{background:var(--accent-red);border-color:var(--accent-red);color:#fff}
.time-display{font-size:20px;font-weight:500;font-variant-numeric:tabular-nums;min-width:120px;font-family:'Sora',sans-serif;letter-spacing:0.02em}
.bpm-section{display:flex;align-items:center;gap:6px;margin-left:auto}
.bpm-label{font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em}
.bpm-input{width:52px;padding:5px 6px;background:var(--bg-card);border:1px solid var(--border);color:var(--text);font-family:'Sora',sans-serif;font-size:13px;text-align:center}
.bpm-input:focus{outline:none;border-color:var(--accent-cyan)}
.bpm-mode{font-size:9px;padding:4px 8px;background:var(--bg-card);border:1px solid var(--border);color:var(--accent-cyan);font-family:'Sora',sans-serif;cursor:default}
.tempo-link{font-size:9px;color:var(--accent-orange);cursor:pointer;padding:3px 6px;border:1px solid transparent}
.tempo-link:hover{border-color:var(--accent-orange)}
.tempo-link.active{background:rgba(249,115,22,0.15);border-color:var(--accent-orange)}

/* Video Section */
.video-section{background:#000;border-bottom:1px solid var(--border);position:relative;min-height:0;flex-shrink:1;overflow:hidden}
.video-section.collapsed{height:0;min-height:0;border:none}
.video-placeholder{display:flex;align-items:center;justify-content:center;height:100%;min-height:160px;color:var(--text-muted);font-size:11px;flex-direction:column;gap:8px}
.video-placeholder .vp-icon{font-size:28px;opacity:0.4}
.video-toggle{position:absolute;top:6px;right:6px;width:20px;height:20px;background:rgba(255,255,255,0.1);border:none;color:var(--text-muted);cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center}
.video-toggle:hover{background:rgba(255,255,255,0.2);color:var(--text)}

/* Timeline */
.timeline-container{flex:1;overflow:auto;background:var(--bg)}
.timeline-ruler{height:22px;background:var(--bg-panel);border-bottom:1px solid var(--border);display:flex;position:sticky;top:0;z-index:10}
.ruler-mark{flex:0 0 80px;border-right:1px solid var(--border);padding:3px 6px;font-size:8px;color:var(--text-muted)}
.ruler-mark:first-child{flex:0 0 100px}
.timeline-tracks{min-height:200px;position:relative}
.track{height:56px;border-bottom:1px solid var(--border);display:flex}
.track-header{width:100px;background:var(--bg-panel);border-right:1px solid var(--border);padding:6px 8px;display:flex;flex-direction:column;justify-content:center;flex-shrink:0}
.track-name{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.04em}
.track-info{font-size:7px;color:var(--text-muted);margin-top:2px}
.track-controls{display:flex;gap:3px;margin-top:3px}
.track-btn{width:18px;height:14px;font-size:7px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-muted);cursor:pointer;font-family:'Sora',sans-serif}
.track-btn:hover{border-color:var(--text);color:var(--text)}
.track-btn.muted{background:var(--accent-orange);color:#000;border-color:var(--accent-orange)}
.track-btn.soloed{background:var(--accent-cyan);color:#000;border-color:var(--accent-cyan)}
.track-content{flex:1;position:relative;background:repeating-linear-gradient(90deg,transparent,transparent 79px,var(--border) 79px,var(--border) 80px);min-width:800px}
.track-content.drag-over{background:rgba(6,182,212,0.06)}

/* Clips */
.clip{position:absolute;height:44px;top:6px;border:1px solid rgba(255,255,255,0.15);cursor:move;display:flex;align-items:center;padding:0 8px;font-size:9px;font-weight:500;user-select:none;transition:opacity 0.1s;overflow:hidden;white-space:nowrap}
.clip:hover{filter:brightness(1.15)}
.clip.selected{border:2px solid var(--accent-cyan);box-shadow:0 0 8px rgba(6,182,212,0.3)}
.clip .clip-info{font-size:7px;opacity:0.7;margin-left:6px}
.clip-resize{position:absolute;right:0;top:0;bottom:0;width:6px;cursor:ew-resize;background:rgba(255,255,255,0.15)}
.clip-resize:hover{background:rgba(255,255,255,0.3)}
.playhead{position:absolute;top:0;bottom:0;width:2px;background:var(--accent-cyan);z-index:20;pointer-events:none;left:100px;transition:none}
.playhead::before{content:'';position:absolute;top:0;left:-4px;width:10px;height:8px;background:var(--accent-cyan);clip-path:polygon(50% 100%,0 0,100% 0)}

/* ===== RIGHT PANEL: MIXER + INSPECTOR ===== */
.panel-right{background:var(--bg-panel);border-left:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}
.mixer-section{padding:10px 12px;border-bottom:1px solid var(--border)}
.mixer-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:10px}

/* Faders */
.fader-group{display:flex;gap:10px;justify-content:center}
.fader{display:flex;flex-direction:column;align-items:center;gap:6px}
.fader-label{font-size:7px;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-muted);text-align:center;max-width:36px}
.fader-track{width:6px;height:80px;background:var(--bg);border-radius:3px;position:relative;cursor:pointer}
.fader-fill{position:absolute;bottom:0;left:0;right:0;border-radius:3px;transition:height 0.1s}
.fader-handle{position:absolute;left:-5px;width:16px;height:6px;background:var(--text);border-radius:2px;cursor:ns-resize;transition:bottom 0.1s}
.fader-value{font-size:10px;font-weight:500;font-variant-numeric:tabular-nums}

/* Knobs */
.knob-group{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.knob{display:flex;flex-direction:column;align-items:center;gap:4px}
.knob-dial{width:36px;height:36px;background:var(--bg);border:2px solid var(--border);border-radius:50%;position:relative;cursor:pointer;transition:border-color 0.15s}
.knob-dial:hover{border-color:var(--accent-cyan)}
.knob-indicator{position:absolute;width:2px;height:10px;background:var(--accent-cyan);top:4px;left:50%;transform-origin:bottom center;transform:translateX(-50%)}
.knob-label{font-size:7px;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-muted);text-align:center}
.knob-value{font-size:8px;color:var(--accent-cyan)}

/* Meters */
.meter-group{display:flex;gap:3px;justify-content:center;height:60px;align-items:flex-end}
.meter-bar{width:4px;background:var(--accent-green);border-radius:1px;transition:height 0.1s}

/* Inspector */
.inspector-section{padding:10px 12px;border-bottom:1px solid var(--border)}
.inspector-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent-cyan);margin-bottom:8px}
.inspector-field{margin-bottom:6px}
.inspector-field label{display:block;font-size:8px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:2px}
.inspector-field .value{font-size:11px;color:var(--text)}
.inspector-field input,.inspector-field select{width:100%;padding:4px 6px;font-size:10px;font-family:'Sora',sans-serif;background:var(--bg);border:1px solid var(--border);color:var(--text)}
.inspector-field input:focus,.inspector-field select:focus{outline:none;border-color:var(--accent-cyan)}
.inspector-tags{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px}
.inspector-tag{font-size:8px;padding:2px 6px;background:rgba(6,182,212,0.15);color:var(--accent-cyan);border-radius:2px}

/* Music Player */
.music-section{padding:10px 12px;border-bottom:1px solid var(--border)}
.music-now-playing{font-size:10px;color:var(--text-secondary);margin-bottom:6px;display:flex;align-items:center;gap:6px}
.music-now-playing .eq{display:flex;gap:1px;align-items:flex-end;height:12px}
.music-now-playing .eq span{width:2px;background:var(--accent-cyan);animation:eqBounce 0.8s ease-in-out infinite alternate}
.music-now-playing .eq span:nth-child(2){animation-delay:0.2s}
.music-now-playing .eq span:nth-child(3){animation-delay:0.4s}
@keyframes eqBounce{0%{height:3px}100%{height:12px}}
.music-controls{display:flex;gap:4px;align-items:center}
.music-btn{width:28px;height:28px;background:var(--bg-card);border:1px solid var(--border);color:var(--text);cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif}
.music-btn:hover{border-color:var(--accent-cyan)}
.music-btn.playing{background:var(--accent-cyan);color:#000;border-color:var(--accent-cyan)}
.music-volume{width:60px;height:3px;-webkit-appearance:none;appearance:none;background:var(--border);outline:none;cursor:pointer}
.music-volume::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;background:var(--accent-cyan);border-radius:50%;cursor:pointer}

/* Export Button */
.export-btn{padding:8px 16px;background:var(--gradient);border:none;color:white;font-family:'Sora',sans-serif;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.04em;cursor:pointer;width:100%}
.export-btn:hover{opacity:0.9}

/* ===== FOOTER ===== */
.footer{background:var(--bg-panel);border-top:1px solid var(--border);padding:0 16px;display:flex;align-items:center;justify-content:space-between;font-size:9px;color:var(--text-muted)}
.status-item{display:flex;align-items:center;gap:5px}
.status-dot{width:5px;height:5px;border-radius:50%;background:var(--accent-green)}
.footer-quote{font-style:italic;opacity:0.6}

/* ===== TOAST ===== */
.toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--accent-cyan);color:var(--text);padding:8px 16px;font-size:11px;z-index:100;opacity:0;transition:opacity 0.3s;pointer-events:none;font-family:'Sora',sans-serif}
.toast.show{opacity:1}
@media(prefers-reduced-motion:reduce){.music-now-playing .eq span{animation:none;height:6px}.preset-card:hover{transform:none}}

/* ===== PRESETS DRAWER ===== */
.presets-drawer{display:none;position:absolute;top:52px;left:0;right:0;background:var(--bg-panel);border-bottom:2px solid var(--accent-cyan);z-index:50;padding:12px 20px}
.presets-drawer.open{display:flex;gap:12px;flex-wrap:wrap}
.preset-card{flex:1;min-width:180px;max-width:250px;padding:12px;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;transition:border-color 0.15s,transform 0.15s}
.preset-card:hover{border-color:var(--accent-cyan);transform:translateY(-2px)}
.preset-card .pc-name{font-size:12px;font-weight:600;margin-bottom:4px}
.preset-card .pc-bpm{font-size:10px;color:var(--accent-cyan)}
.preset-card .pc-desc{font-size:9px;color:var(--text-muted);margin-top:4px}
.preset-card .pc-mode{font-size:8px;padding:2px 6px;display:inline-block;margin-top:6px;border-radius:2px}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon"><img src="assets/planet-logo.png" alt="" onerror="this.style.display='none'"></div>
      <div>
        <div class="logo-text">SATURNO MOVEMENT STUDIO</div>
        <div class="logo-sub">The Ableton of Movement</div>
      </div>
    </div>
    <nav class="header-nav">
      <button class="nav-btn" id="btn-presets" onclick="togglePresets()">PRESETS</button>
      <button class="nav-btn" onclick="clearTimeline()">CLEAR</button>
      <button class="nav-btn" onclick="saveSession()">SAVE</button>
      <button class="nav-btn" onclick="exportWorkout()">EXPORT</button>
      <button class="nav-btn" id="btn-video" onclick="toggleVideo()">VIDEO</button>
      <button class="nav-btn" onclick="toggleMusic()">MUSIC</button>
    </nav>
  </header>

  <!-- PRESETS DRAWER -->
  <div class="presets-drawer" id="presets-drawer">
    <div class="preset-card" onclick="loadPreset('monk')">
      <div class="pc-name">Monk Mode</div>
      <div class="pc-bpm">65 BPM</div>
      <div class="pc-desc">Meditative, slow, precise. Breath-led reps.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('beast')">
      <div class="pc-name">Beast Mode</div>
      <div class="pc-bpm">140 BPM</div>
      <div class="pc-desc">High intensity, explosive power.</div>
      <div class="pc-mode" style="background:rgba(239,68,68,0.2);color:#ef4444">Flow / Conditioning</div>
    </div>
    <div class="preset-card" onclick="loadPreset('flow')">
      <div class="pc-name">Flow Ritual</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Continuous movement, fluid transitions.</div>
      <div class="pc-mode" style="background:rgba(139,92,246,0.2);color:#8b5cf6">Standard Tempo</div>
    </div>
    <div class="preset-card" onclick="loadPreset('skill')">
      <div class="pc-name">Skill Ascension</div>
      <div class="pc-bpm">75 BPM</div>
      <div class="pc-desc">Technical practice, isometric holds.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Slow Strength</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Movement Library -->
    <aside class="panel-left">
      <div class="panel-header"><span>Movement Library</span><span id="lib-count">0</span></div>
      <input type="text" class="lib-search" id="lib-search" placeholder="Search movements..." oninput="filterLibrary()">
      <div id="library-container"></div>
    </aside>

    <!-- CENTER: Transport + Video + Timeline -->
    <section class="panel-center">
      <!-- Transport -->
      <div class="transport">
        <div class="transport-buttons">
          <button class="transport-btn" onclick="rewind()" title="Rewind 15s">&#9198;</button>
          <button class="transport-btn" id="play-btn" onclick="togglePlay()" title="Play / Pause">&#9654;</button>
          <button class="transport-btn" onclick="stopPlayback()" title="Stop">&#9632;</button>
          <button class="transport-btn" onclick="forward()" title="Forward 15s">&#9197;</button>
          <button class="transport-btn rec" id="rec-btn" onclick="toggleRec()" title="Record">&#9679;</button>
        </div>
        <div class="time-display" id="time-display">00:00:00</div>
        <div class="bpm-section">
          <span class="bpm-label">BPM</span>
          <input type="number" class="bpm-input" id="bpm-input" value="120" min="40" max="200" onchange="updateBPM()">
          <span class="bpm-mode" id="bpm-mode">Standard</span>
          <span class="tempo-link" id="tempo-link" onclick="toggleTempoLink()" title="Link BPM to exercise tempo">LINK</span>
        </div>
      </div>

      <!-- Video (collapsible) -->
      <div class="video-section" id="video-section">
        <div class="video-placeholder" id="video-placeholder">
          <div class="vp-icon">&#9654;</div>
          <span>Drop video here or click to load</span>
          <span style="font-size:9px;opacity:0.5">Landscape video plays in sync with timeline</span>
        </div>
        <video id="studio-video" style="width:100%;height:100%;object-fit:contain;display:none" controls></video>
        <button class="video-toggle" onclick="toggleVideo()" title="Toggle video">&#9660;</button>
      </div>

      <!-- Timeline -->
      <div class="timeline-container" id="timeline-container">
        <div class="timeline-ruler" id="timeline-ruler"></div>
        <div class="timeline-tracks" id="timeline-tracks">
          <div class="playhead" id="playhead"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Mixer + Inspector + Music -->
    <aside class="panel-right">
      <!-- Meter -->
      <div class="mixer-section">
        <div class="mixer-title">Output</div>
        <div class="meter-group" id="meters"></div>
      </div>

      <!-- Faders -->
      <div class="mixer-section">
        <div class="mixer-title">Master Faders</div>
        <div class="fader-group" id="fader-group"></div>
      </div>

      <!-- Knobs -->
      <div class="mixer-section">
        <div class="mixer-title">Blend Controls</div>
        <div class="knob-group" id="knob-group"></div>
      </div>

      <!-- Inspector -->
      <div class="inspector-section" id="inspector" style="display:none">
        <div class="inspector-title">Exercise DNA</div>
        <div class="inspector-field"><label>Movement</label><div class="value" id="insp-name">-</div></div>
        <div class="inspector-field"><label>Pattern</label><div class="value" id="insp-pattern">-</div></div>
        <div class="inspector-field"><label>Stage</label><div class="value" id="insp-stage">-</div></div>
        <div class="inspector-field"><label>Discipline</label><div class="value" id="insp-discipline">-</div></div>
        <div class="inspector-field">
          <label>Sets x Reps</label>
          <div style="display:flex;gap:4px">
            <input type="number" id="insp-sets" value="3" min="1" max="10" style="width:40px" onchange="updateClipDNA()">
            <span style="color:var(--text-muted);font-size:11px">x</span>
            <input type="number" id="insp-reps" value="8" min="1" max="50" style="width:40px" onchange="updateClipDNA()">
          </div>
        </div>
        <div class="inspector-field"><label>Tempo (seconds per rep)</label><input type="number" id="insp-tempo" value="3" min="1" max="20" step="0.5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>Rest (seconds)</label><input type="number" id="insp-rest" value="60" min="0" max="300" step="5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>RPE (1-10)</label><input type="range" id="insp-rpe" min="1" max="10" value="7" style="width:100%" oninput="updateClipDNA()"></div>
        <div class="inspector-tags" id="insp-tags"></div>
      </div>

      <!-- Music -->
      <div class="music-section" id="music-panel" style="display:none">
        <div class="mixer-title">Music</div>
        <div class="music-now-playing" id="music-np">
          <div class="eq" id="music-eq" style="display:none"><span></span><span></span><span></span></div>
          <span id="music-track-name">No track</span>
        </div>
        <div class="music-controls">
          <button class="music-btn" onclick="musicPrev()" title="Previous">&#9198;</button>
          <button class="music-btn" id="music-play-btn" onclick="musicToggle()" title="Play/Pause">&#9654;</button>
          <button class="music-btn" onclick="musicNext()" title="Next">&#9197;</button>
          <input type="range" class="music-volume" min="0" max="100" value="50" oninput="musicVolume(this.value)">
        </div>
      </div>

      <!-- Export -->
      <div class="mixer-section">
        <button class="export-btn" onclick="exportWorkout()">Export Workout</button>
      </div>
    </aside>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="status-item"><div class="status-dot"></div><span id="status-text">Ready</span></div>
    <div><span>Clips: <span id="clip-count">0</span></span> <span style="margin-left:12px">Duration: <span id="total-duration">0:00</span></span></div>
    <div class="footer-quote">"Design Your Workout. Design Your Life."</div>
  </footer>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== EXERCISE DATABASE (from Victory Belt CC Movement Matrix) ===== */
var EXERCISES = [
  /* Horizontal Push (Pattern 1) */
  {id:'P1-01',name:'Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-02',name:'Diamond Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-03',name:'Wide Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-04',name:'Decline Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-05',name:'Archer Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-06',name:'Pseudo Planche PU',pattern:'Horizontal Push',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-07',name:'Ring Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-08',name:'One Arm Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-09',name:'Planche Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Horizontal Pull (Pattern 2) */
  {id:'P2-01',name:'Inverted Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-02',name:'Ring Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-03',name:'Archer Row',pattern:'Horizontal Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-04',name:'Tuck Front Lever',pattern:'Horizontal Pull',stage:2,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-05',name:'Front Lever Row',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-06',name:'Front Lever',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Downward Press (Pattern 3) */
  {id:'P3-01',name:'Dip',pattern:'Downward Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-02',name:'Ring Dip',pattern:'Downward Press',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-03',name:'Korean Dip',pattern:'Downward Press',stage:2,discipline:'Freestyle',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-04',name:'Weighted Dip',pattern:'Downward Press',stage:2,discipline:'Street Lifting',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-05',name:'Tuck Planche',pattern:'Downward Press',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-06',name:'Full Planche',pattern:'Downward Press',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Vertical Pull (Pattern 4) */
  {id:'P4-01',name:'Dead Hang',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-02',name:'Pull Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-03',name:'Chin Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-04',name:'L-Sit Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-05',name:'Archer Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-06',name:'Muscle Up (Bar)',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-07',name:'Ring Muscle Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-08',name:'Weighted Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Street Lifting',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-09',name:'One Arm Pull Up',pattern:'Vertical Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Overhead Press (Pattern 5) */
  {id:'P5-01',name:'Pike Push Up',pattern:'Overhead Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P5-02',name:'Wall Handstand Hold',pattern:'Overhead Press',stage:1,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-03',name:'Wall HSPU',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-04',name:'Free Handstand',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-05',name:'Handstand Push Up',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-06',name:'Press to Handstand',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  /* Knee-Dominant (Pattern 6) */
  {id:'P6-01',name:'Bodyweight Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-02',name:'Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-03',name:'Bulgarian Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-04',name:'Pistol Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-05',name:'Shrimp Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-06',name:'Cossack Squat',pattern:'Knee-Dominant',stage:2,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-07',name:'Dragon Squat',pattern:'Knee-Dominant',stage:3,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  /* Hip-Dominant (Pattern 7) */
  {id:'P7-01',name:'Glute Bridge',pattern:'Hip-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-02',name:'Nordic Curl',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-03',name:'Wrestler Bridge',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-04',name:'Stand to Bridge',pattern:'Hip-Dominant',stage:3,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  /* Core */
  {id:'C-01',name:'Hollow Body Hold',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-02',name:'Plank',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-03',name:'L-Sit',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-04',name:'V-Sit',pattern:'Core',stage:3,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-05',name:'Dragon Flag',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-06',name:'Ab Wheel Rollout',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  /* Mobility */
  {id:'M-01',name:'Resting Squat',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-02',name:'Pancake Stretch',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-03',name:'Front Split',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-04',name:'Thoracic Bridge',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-05',name:'German Hang',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-06',name:'Hip CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-07',name:'Scapular CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'}
];

/* Movement family -> instrument role (from Composition Engine) */
var FAMILY_MAP = {
  'Push': {instrument:'Percussion',color:'#3b82f6'},
  'Pull': {instrument:'Bass',color:'#8b5cf6'},
  'Legs': {instrument:'Rhythm Guitar',color:'#22c55e'},
  'Core': {instrument:'Harmony',color:'#f97316'},
  'Skills': {instrument:'Lead Melody',color:'#06b6d4'},
  'Flow': {instrument:'Ambient Pad',color:'#ec4899'}
};

/* BPM -> Training Mode (from Composition Engine) */
var BPM_MODES = [
  {min:40,max:80,name:'Slow Strength',desc:'Control, holds, precision'},
  {min:80,max:120,name:'Standard',desc:'Tempo work, sets'},
  {min:120,max:160,name:'Flow State',desc:'Conditioning, flow'},
  {min:160,max:200,name:'Explosive',desc:'Power, speed, intensity'}
];

/* Track definitions */
var TRACKS = [
  {id:'push',name:'Push',family:'Push',info:'Percussion'},
  {id:'pull',name:'Pull',family:'Pull',info:'Bass'},
  {id:'core',name:'Core',family:'Core',info:'Harmony'},
  {id:'legs',name:'Legs',family:'Legs',info:'Rhythm'},
  {id:'skills',name:'Skills',family:'Skills',info:'Lead'}
];

/* Fader definitions */
var FADERS = [
  {id:'intensity',label:'Intensity',value:70,color:'var(--gradient)'},
  {id:'volume',label:'Volume',value:50,color:'var(--gradient)'},
  {id:'density',label:'Density',value:60,color:'var(--gradient)'},
  {id:'rest',label:'Rest',value:40,color:'var(--gradient)'}
];

/* Knob definitions */
var KNOBS = [
  {id:'str-mob',label:'Str / Mob',value:0.5},
  {id:'pwr-ctrl',label:'Pwr / Ctrl',value:0.5},
  {id:'sta-dyn',label:'Sta / Dyn',value:0.5}
];

/* Preset definitions */
var PRESETS = {
  monk: {
    name:'Monk Mode',bpm:65,
    clips:[
      {track:'core',name:'Hollow Body Hold',x:0,w:120},
      {track:'push',name:'Push Up',x:20,w:100},
      {track:'core',name:'L-Sit',x:140,w:100},
      {track:'pull',name:'Pull Up',x:140,w:100},
      {track:'skills',name:'Free Handstand',x:260,w:120},
      {track:'legs',name:'Resting Squat',x:260,w:80}
    ],
    faders:{intensity:40,volume:30,density:30,rest:70},
    knobs:{'str-mob':0.4,'pwr-ctrl':0.3,'sta-dyn':0.2}
  },
  beast: {
    name:'Beast Mode',bpm:140,
    clips:[
      {track:'push',name:'Diamond Push Up',x:0,w:100},
      {track:'pull',name:'Muscle Up (Bar)',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:120,w:80},
      {track:'push',name:'Dip',x:120,w:80},
      {track:'core',name:'Dragon Flag',x:120,w:80},
      {track:'pull',name:'Weighted Pull Up',x:220,w:100},
      {track:'legs',name:'Shrimp Squat',x:220,w:80},
      {track:'push',name:'Planche Push Up',x:340,w:100}
    ],
    faders:{intensity:90,volume:80,density:85,rest:20},
    knobs:{'str-mob':0.8,'pwr-ctrl':0.7,'sta-dyn':0.9}
  },
  flow: {
    name:'Flow Ritual',bpm:100,
    clips:[
      {track:'legs',name:'Hip CARs',x:0,w:80},
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'core',name:'Hollow Body Hold',x:100,w:80},
      {track:'pull',name:'Ring Row',x:100,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:200,w:100},
      {track:'legs',name:'Cossack Squat',x:200,w:80},
      {track:'core',name:'L-Sit',x:300,w:80},
      {track:'push',name:'Ring Push Up',x:300,w:100}
    ],
    faders:{intensity:55,volume:60,density:65,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.4,'sta-dyn':0.6}
  },
  skill: {
    name:'Skill Ascension',bpm:75,
    clips:[
      {track:'skills',name:'Free Handstand',x:0,w:160},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'pull',name:'Tuck Front Lever',x:180,w:140},
      {track:'push',name:'Tuck Planche',x:180,w:140},
      {track:'core',name:'V-Sit',x:180,w:80},
      {track:'skills',name:'Press to Handstand',x:340,w:160}
    ],
    faders:{intensity:60,volume:40,density:35,rest:80},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.3,'sta-dyn':0.15}
  }
};

/* ===== STATE ===== */
var isPlaying = false, currentTime = 0, bpm = 120, playInterval = null;
var isRecording = false, tempoLinked = false;
var selectedClip = null, musicPlaying = false, musicIndex = 0;
var audioEl = null;
var meterInterval = null;

/* Music tracks (from Vercel Blob CDN) */
var MUSIC_TRACKS = [
  {name:'Celestial Reverie',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Celestial%20Reverie.mp3'},
  {name:'Blue Phoenix',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Blue%20Phoenix.mp3'},
  {name:'Veil of Truth',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Veil%20of%20Truth.mp3'},
  {name:'Astral Shadows',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Astral%20Shadows.mp3'}
];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', function() {
  buildLibrary();
  buildTracks();
  buildRuler();
  buildFaders();
  buildKnobs();
  buildMeters();
  loadSession();
  updateBPMMode();
});

/* ===== LIBRARY ===== */
function buildLibrary() {
  var container = document.getElementById('library-container');
  var groups = {};
  EXERCISES.forEach(function(ex) {
    var g = ex.pattern;
    if (!groups[g]) groups[g] = [];
    groups[g].push(ex);
  });
  var html = '';
  var patterns = ['Horizontal Push','Horizontal Pull','Downward Press','Vertical Pull','Overhead Press','Knee-Dominant','Hip-Dominant','Core','Mobility'];
  patterns.forEach(function(p) {
    var exs = groups[p];
    if (!exs) return;
    var fam = exs[0].family;
    var fm = FAMILY_MAP[fam] || {color:'#666'};
    html += '<div class="movement-category" data-pattern="'+p+'">';
    html += '<div class="category-header" onclick="toggleCategory(this)"><span>'+p+' ('+exs.length+')</span><div style="display:flex;align-items:center;gap:6px"><div class="category-color" style="background:'+fm.color+'"></div><span class="arrow">&#9660;</span></div></div>';
    html += '<div class="movement-list">';
    exs.forEach(function(ex) {
      html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" data-family="'+ex.family+'">';
      html += '<div class="mv-icon" style="background:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
      html += '<span>'+ex.name+'</span>';
      html += '<span class="mv-stage">S'+ex.stage+'</span>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
  document.getElementById('lib-count').textContent = EXERCISES.length;
  initDragDrop();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  var list = header.nextElementSibling;
  list.classList.toggle('hidden');
}

function filterLibrary() {
  var q = document.getElementById('lib-search').value.toLowerCase();
  var items = document.querySelectorAll('.movement-item');
  var count = 0;
  items.forEach(function(item) {
    var show = item.textContent.toLowerCase().indexOf(q) !== -1;
    item.style.display = show ? '' : 'none';
    if (show) count++;
  });
  document.getElementById('lib-count').textContent = count;
  // Show all categories when searching
  if (q) {
    document.querySelectorAll('.movement-list').forEach(function(l) { l.classList.remove('hidden'); });
    document.querySelectorAll('.category-header').forEach(function(h) { h.classList.remove('collapsed'); });
  }
}

/* ===== TRACKS ===== */
function buildTracks() {
  var container = document.getElementById('timeline-tracks');
  var ph = container.querySelector('.playhead');
  var html = '';
  TRACKS.forEach(function(t) {
    var fm = FAMILY_MAP[t.family] || {color:'#666'};
    html += '<div class="track" data-track="'+t.id+'">';
    html += '<div class="track-header"><div class="track-name" style="color:'+fm.color+'">'+t.name+'</div><div class="track-info">'+t.info+'</div>';
    html += '<div class="track-controls"><button class="track-btn" onclick="toggleMute(this)" title="Mute">M</button><button class="track-btn" onclick="toggleSolo(this)" title="Solo">S</button></div></div>';
    html += '<div class="track-content" data-track="'+t.id+'"></div></div>';
  });
  container.innerHTML = html;
  container.insertBefore(ph, container.firstChild);
}

function buildRuler() {
  var ruler = document.getElementById('timeline-ruler');
  var html = '<div class="ruler-mark" style="flex:0 0 100px">0:00</div>';
  for (var i = 15; i <= 300; i += 15) {
    var m = Math.floor(i / 60);
    var s = i % 60;
    html += '<div class="ruler-mark">'+m+':'+s.toString().padStart(2,'0')+'</div>';
  }
  ruler.innerHTML = html;
}

/* ===== DRAG & DROP ===== */
function initDragDrop() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.5';
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
  document.querySelectorAll('.track-content').forEach(function(track) {
    track.addEventListener('dragover', function(e) { e.preventDefault(); track.classList.add('drag-over'); });
    track.addEventListener('dragleave', function() { track.classList.remove('drag-over'); });
    track.addEventListener('drop', function(e) {
      e.preventDefault();
      track.classList.remove('drag-over');
      try {
        var ex = JSON.parse(e.dataTransfer.getData('text/plain'));
        var rect = track.getBoundingClientRect();
        var x = e.clientX - rect.left + track.parentElement.parentElement.scrollLeft;
        addClip(track, ex, x);
      } catch(err) {}
    });
  });
}

function getExercise(id) {
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].id === id) return EXERCISES[i];
  }
  return null;
}

/* ===== CLIPS ===== */
function addClip(track, exercise, x) {
  var clip = document.createElement('div');
  var fm = FAMILY_MAP[exercise.family] || {color:'#666'};
  clip.className = 'clip';
  clip.style.background = fm.color;
  clip.style.left = Math.max(0, x) + 'px';
  clip.style.width = '80px';
  clip.textContent = exercise.name;
  clip.dataset.exerciseId = exercise.id;
  clip.dataset.sets = '3';
  clip.dataset.reps = '8';
  clip.dataset.tempo = '3';
  clip.dataset.rest = '60';
  clip.dataset.rpe = '7';

  var info = document.createElement('span');
  info.className = 'clip-info';
  info.textContent = '3x8';
  clip.appendChild(info);

  var resize = document.createElement('div');
  resize.className = 'clip-resize';
  clip.appendChild(resize);

  // Drag clip
  clip.addEventListener('mousedown', function(e) {
    if (e.target === resize) return;
    e.preventDefault();
    selectClipEl(clip);
    var startX = e.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) { clip.style.left = Math.max(0, startLeft + e.clientX - startX) + 'px'; }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Resize clip
  resize.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startW = parseInt(clip.style.width);
    function onMove(e) { clip.style.width = Math.max(40, startW + e.clientX - startX) + 'px'; }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Double click to delete
  clip.addEventListener('dblclick', function() {
    clip.remove();
    if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
    updateStats();
    saveSession();
    toast('Clip removed');
  });

  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  toast(exercise.name + ' added');
}

function selectClipEl(clip) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  clip.classList.add('selected');
  selectedClip = clip;
  var ex = getExercise(clip.dataset.exerciseId);
  if (!ex) return;
  var insp = document.getElementById('inspector');
  insp.style.display = '';
  document.getElementById('insp-name').textContent = ex.name;
  document.getElementById('insp-pattern').textContent = ex.pattern;
  document.getElementById('insp-stage').textContent = 'Stage ' + ex.stage + ' - ' + ex.discipline;
  document.getElementById('insp-discipline').textContent = ex.discipline;
  document.getElementById('insp-sets').value = clip.dataset.sets || 3;
  document.getElementById('insp-reps').value = clip.dataset.reps || 8;
  document.getElementById('insp-tempo').value = clip.dataset.tempo || 3;
  document.getElementById('insp-rest').value = clip.dataset.rest || 60;
  document.getElementById('insp-rpe').value = clip.dataset.rpe || 7;
  var fm = FAMILY_MAP[ex.family] || {};
  document.getElementById('insp-tags').innerHTML =
    '<span class="inspector-tag" style="background:'+((FAMILY_MAP[ex.family]||{}).color||'#666')+'22;color:'+(FAMILY_MAP[ex.family]||{}).color+'">'+ex.family+'</span>' +
    '<span class="inspector-tag">'+(fm.instrument||'')+'</span>' +
    '<span class="inspector-tag">S'+ex.stage+'</span>';
}

function updateClipDNA() {
  if (!selectedClip) return;
  selectedClip.dataset.sets = document.getElementById('insp-sets').value;
  selectedClip.dataset.reps = document.getElementById('insp-reps').value;
  selectedClip.dataset.tempo = document.getElementById('insp-tempo').value;
  selectedClip.dataset.rest = document.getElementById('insp-rest').value;
  selectedClip.dataset.rpe = document.getElementById('insp-rpe').value;
  var info = selectedClip.querySelector('.clip-info');
  if (info) info.textContent = selectedClip.dataset.sets + 'x' + selectedClip.dataset.reps;
  // If tempo linked, update clip width based on exercise duration
  if (tempoLinked) {
    var sets = parseInt(selectedClip.dataset.sets) || 3;
    var reps = parseInt(selectedClip.dataset.reps) || 8;
    var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
    var rest = parseInt(selectedClip.dataset.rest) || 60;
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var pps = 80 / 15;
    selectedClip.style.width = Math.max(40, totalSec * pps) + 'px';
    updateStats();
  }
  saveSession();
}

function updateStats() {
  var clips = document.querySelectorAll('.clip');
  document.getElementById('clip-count').textContent = clips.length;
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var secs = Math.round(maxRight / 80 * 15);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  document.getElementById('total-duration').textContent = m + ':' + s.toString().padStart(2, '0');
}

/* ===== TRANSPORT ===== */
function togglePlay() {
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) {
    btn.classList.add('active');
    btn.innerHTML = '&#9616;&#9616;';
    playInterval = setInterval(updatePlayhead, 50);
    startMeters();
    document.getElementById('status-text').textContent = 'Playing';
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#9654;';
    clearInterval(playInterval);
    stopMeters();
    document.getElementById('status-text').textContent = 'Paused';
  }
}

function stopPlayback() {
  isPlaying = false;
  currentTime = 0;
  var btn = document.getElementById('play-btn');
  btn.classList.remove('active');
  btn.innerHTML = '&#9654;';
  clearInterval(playInterval);
  stopMeters();
  updateTimeDisplay();
  updatePlayheadPosition();
  document.getElementById('status-text').textContent = 'Ready';
}

function rewind() { currentTime = Math.max(0, currentTime - 15); updateTimeDisplay(); updatePlayheadPosition(); }
function forward() { currentTime += 15; updateTimeDisplay(); updatePlayheadPosition(); }

function updatePlayhead() {
  currentTime += 0.05;
  updateTimeDisplay();
  updatePlayheadPosition();
}

function updateTimeDisplay() {
  var mins = Math.floor(currentTime / 60);
  var secs = Math.floor(currentTime % 60);
  var ms = Math.floor((currentTime % 1) * 100);
  document.getElementById('time-display').textContent =
    mins.toString().padStart(2, '0') + ':' +
    secs.toString().padStart(2, '0') + ':' +
    ms.toString().padStart(2, '0');
}

function updatePlayheadPosition() {
  var pps = 80 / 15;
  document.getElementById('playhead').style.left = (100 + currentTime * pps) + 'px';
}

function toggleRec() {
  isRecording = !isRecording;
  var btn = document.getElementById('rec-btn');
  btn.classList.toggle('active', isRecording);
  document.getElementById('status-text').textContent = isRecording ? 'Recording' : 'Ready';
}

/* ===== BPM ===== */
function updateBPM() {
  bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  updateBPMMode();
  saveSession();
  // If tempo-linked, adjust exercise tempos AND music playback rate
  if (tempoLinked) {
    var repTempo = 60 / bpm;
    document.getElementById('insp-tempo').value = repTempo.toFixed(1);
    if (selectedClip) {
      selectedClip.dataset.tempo = repTempo.toFixed(1);
      updateClipDNA();
    }
    // Adjust music playback rate: 120 BPM = 1.0x, scale proportionally
    if (audioEl) {
      var rate = Math.max(0.5, Math.min(2.0, bpm / 120));
      audioEl.playbackRate = rate;
    }
    toast('Tempo linked: ' + repTempo.toFixed(1) + 's/rep, music ' + (bpm / 120).toFixed(2) + 'x');
  } else {
    // Reset music to normal speed when unlinked
    if (audioEl) audioEl.playbackRate = 1.0;
  }
}

function updateBPMMode() {
  var mode = 'Standard';
  for (var i = 0; i < BPM_MODES.length; i++) {
    if (bpm >= BPM_MODES[i].min && bpm < BPM_MODES[i].max) {
      mode = BPM_MODES[i].name;
      break;
    }
  }
  if (bpm >= 200) mode = 'Explosive';
  document.getElementById('bpm-mode').textContent = mode;
}

function toggleTempoLink() {
  tempoLinked = !tempoLinked;
  var el = document.getElementById('tempo-link');
  el.classList.toggle('active', tempoLinked);
  if (tempoLinked) {
    toast('BPM linked to exercise tempo');
    updateBPM();
  } else {
    if (audioEl) audioEl.playbackRate = 1.0;
    toast('Tempo unlinked');
  }
}

/* ===== FADERS ===== */
function buildFaders() {
  var container = document.getElementById('fader-group');
  var html = '';
  FADERS.forEach(function(f) {
    html += '<div class="fader" data-fader="'+f.id+'">';
    html += '<div class="fader-label">'+f.label+'</div>';
    html += '<div class="fader-track" onmousedown="startFaderDrag(event,\''+f.id+'\')">';
    html += '<div class="fader-fill" style="height:'+f.value+'%;background:'+f.color+'"></div>';
    html += '<div class="fader-handle" style="bottom:'+(f.value-3)+'%"></div>';
    html += '</div>';
    html += '<div class="fader-value" id="fader-val-'+f.id+'">'+(f.value/10).toFixed(0)+'</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startFaderDrag(e, faderId) {
  e.preventDefault();
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  function update(e) {
    var y = 1 - ((e.clientY - rect.top) / rect.height);
    y = Math.max(0, Math.min(1, y));
    var pct = y * 100;
    track.querySelector('.fader-fill').style.height = pct + '%';
    track.querySelector('.fader-handle').style.bottom = (pct - 3) + '%';
    document.getElementById('fader-val-' + faderId).textContent = (pct / 10).toFixed(0);
  }
  function onUp() {
    document.removeEventListener('mousemove', update);
    document.removeEventListener('mouseup', onUp);
    saveSession();
  }
  update(e);
  document.addEventListener('mousemove', update);
  document.addEventListener('mouseup', onUp);
}

/* ===== KNOBS ===== */
function buildKnobs() {
  var container = document.getElementById('knob-group');
  var html = '';
  KNOBS.forEach(function(k) {
    var deg = (k.value - 0.5) * 270;
    html += '<div class="knob" data-knob="'+k.id+'">';
    html += '<div class="knob-dial" onmousedown="startKnobDrag(event,\''+k.id+'\')">';
    html += '<div class="knob-indicator" style="transform:translateX(-50%) rotate('+deg+'deg)"></div>';
    html += '</div>';
    html += '<div class="knob-label">'+k.label+'</div>';
    html += '<div class="knob-value" id="knob-val-'+k.id+'">'+(k.value*100).toFixed(0)+'%</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startKnobDrag(e, knobId) {
  e.preventDefault();
  var startY = e.clientY;
  var dial = e.currentTarget;
  var indicator = dial.querySelector('.knob-indicator');
  var startDeg = parseFloat(indicator.style.transform.match(/rotate\(([^)]+)deg\)/)[1]);
  function update(e) {
    var delta = (startY - e.clientY) * 1.5;
    var deg = Math.max(-135, Math.min(135, startDeg + delta));
    indicator.style.transform = 'translateX(-50%) rotate(' + deg + 'deg)';
    var val = ((deg + 135) / 270);
    document.getElementById('knob-val-' + knobId).textContent = (val * 100).toFixed(0) + '%';
  }
  function onUp() {
    document.removeEventListener('mousemove', update);
    document.removeEventListener('mouseup', onUp);
    saveSession();
  }
  document.addEventListener('mousemove', update);
  document.addEventListener('mouseup', onUp);
}

/* ===== METERS ===== */
function buildMeters() {
  var container = document.getElementById('meters');
  var html = '';
  for (var i = 0; i < 12; i++) {
    html += '<div class="meter-bar" style="height:' + (10 + Math.random() * 30) + 'px"></div>';
  }
  container.innerHTML = html;
}

function startMeters() {
  if (meterInterval) return;
  meterInterval = setInterval(function() {
    document.querySelectorAll('.meter-bar').forEach(function(bar) {
      bar.style.height = (10 + Math.random() * 50) + 'px';
      var h = parseInt(bar.style.height);
      bar.style.background = h > 45 ? 'var(--accent-red)' : h > 30 ? 'var(--accent-orange)' : 'var(--accent-green)';
    });
  }, 100);
}

function stopMeters() {
  clearInterval(meterInterval);
  meterInterval = null;
  document.querySelectorAll('.meter-bar').forEach(function(bar) {
    bar.style.height = '5px';
    bar.style.background = 'var(--accent-green)';
  });
}

/* ===== TRACK CONTROLS ===== */
function toggleMute(btn) { btn.classList.toggle('muted'); }
function toggleSolo(btn) { btn.classList.toggle('soloed'); }

/* ===== VIDEO ===== */
function toggleVideo() {
  var sec = document.getElementById('video-section');
  sec.classList.toggle('collapsed');
  document.getElementById('btn-video').classList.toggle('active', !sec.classList.contains('collapsed'));
}

/* Video drop zone */
document.addEventListener('DOMContentLoaded', function() {
  var vp = document.getElementById('video-placeholder');
  if (!vp) return;
  vp.addEventListener('click', function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function() { loadVideoFile(input.files[0]); };
    input.click();
  });
  vp.addEventListener('dragover', function(e) { e.preventDefault(); vp.style.background = 'rgba(6,182,212,0.1)'; });
  vp.addEventListener('dragleave', function() { vp.style.background = ''; });
  vp.addEventListener('drop', function(e) {
    e.preventDefault();
    vp.style.background = '';
    if (e.dataTransfer.files.length) loadVideoFile(e.dataTransfer.files[0]);
  });
});

function loadVideoFile(file) {
  if (!file || !file.type.startsWith('video/')) return;
  var video = document.getElementById('studio-video');
  var placeholder = document.getElementById('video-placeholder');
  video.src = URL.createObjectURL(file);
  video.style.display = '';
  placeholder.style.display = 'none';
  toast('Video loaded: ' + file.name);
}

/* ===== MUSIC ===== */
function toggleMusic() {
  var panel = document.getElementById('music-panel');
  var visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : '';
  document.querySelector('[onclick="toggleMusic()"]').classList.toggle('active', !visible);
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.volume = 0.5;
    audioEl.addEventListener('ended', function() { musicNext(); });
  }
}

function musicToggle() {
  if (!audioEl) toggleMusic();
  if (musicPlaying) {
    audioEl.pause();
    musicPlaying = false;
    document.getElementById('music-play-btn').innerHTML = '&#9654;';
    document.getElementById('music-eq').style.display = 'none';
  } else {
    if (!audioEl.src || audioEl.ended) {
      audioEl.src = MUSIC_TRACKS[musicIndex].url;
    }
    audioEl.play().catch(function() {});
    musicPlaying = true;
    document.getElementById('music-play-btn').innerHTML = '&#9616;&#9616;';
    document.getElementById('music-play-btn').classList.add('playing');
    document.getElementById('music-eq').style.display = '';
    document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  }
}

function musicNext() {
  musicIndex = (musicIndex + 1) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicPrev() {
  musicIndex = (musicIndex - 1 + MUSIC_TRACKS.length) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicVolume(val) {
  if (audioEl) audioEl.volume = val / 100;
}

/* ===== PRESETS ===== */
function togglePresets() {
  var drawer = document.getElementById('presets-drawer');
  drawer.classList.toggle('open');
  document.getElementById('btn-presets').classList.toggle('active', drawer.classList.contains('open'));
}

function loadPreset(id) {
  var p = PRESETS[id];
  if (!p) return;
  // Clear timeline
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Set BPM
  bpm = p.bpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Add clips
  p.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    if (!track) return;
    var ex = null;
    for (var i = 0; i < EXERCISES.length; i++) {
      if (EXERCISES[i].name === c.name) { ex = EXERCISES[i]; break; }
    }
    if (!ex) return;
    var clip = document.createElement('div');
    var fm = FAMILY_MAP[ex.family] || {color:'#666'};
    clip.className = 'clip';
    clip.style.background = fm.color;
    clip.style.left = c.x + 'px';
    clip.style.width = (c.w || 80) + 'px';
    clip.textContent = ex.name;
    clip.dataset.exerciseId = ex.id;
    clip.dataset.sets = '3';
    clip.dataset.reps = '8';
    clip.dataset.tempo = '3';
    clip.dataset.rest = '60';
    clip.dataset.rpe = '7';
    var info = document.createElement('span');
    info.className = 'clip-info';
    info.textContent = '3x8';
    clip.appendChild(info);
    var resize = document.createElement('div');
    resize.className = 'clip-resize';
    clip.appendChild(resize);
    clip.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('clip-resize')) return;
      e.preventDefault();
      selectClipEl(clip);
      var startX = e.clientX, startLeft = parseInt(clip.style.left);
      function onMove(e) { clip.style.left = Math.max(0, startLeft + e.clientX - startX) + 'px'; }
      function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
    resize.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      var startX = e.clientX, startW = parseInt(clip.style.width);
      function onMove(e) { clip.style.width = Math.max(40, startW + e.clientX - startX) + 'px'; }
      function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
    clip.addEventListener('dblclick', function() {
      clip.remove();
      if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats();
      saveSession();
    });
    track.appendChild(clip);
  });
  // Set faders
  if (p.faders) {
    Object.keys(p.faders).forEach(function(key) {
      var fader = document.querySelector('[data-fader="'+key+'"]');
      if (!fader) return;
      var v = p.faders[key];
      fader.querySelector('.fader-fill').style.height = v + '%';
      fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
      fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
    });
  }
  updateStats();
  saveSession();
  togglePresets();
  toast('Preset loaded: ' + p.name);
}

/* ===== CLEAR ===== */
function clearTimeline() {
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats();
  saveSession();
  toast('Timeline cleared');
}

/* ===== SAVE / LOAD ===== */
function saveSession() {
  try {
    var session = {bpm: bpm, clips: [], faders: {}, knobs: {}};
    document.querySelectorAll('.clip').forEach(function(clip) {
      session.clips.push({
        exerciseId: clip.dataset.exerciseId,
        track: clip.parentElement.dataset.track,
        left: clip.style.left,
        width: clip.style.width,
        sets: clip.dataset.sets,
        reps: clip.dataset.reps,
        tempo: clip.dataset.tempo,
        rest: clip.dataset.rest,
        rpe: clip.dataset.rpe
      });
    });
    document.querySelectorAll('[data-fader]').forEach(function(f) {
      var fill = f.querySelector('.fader-fill');
      session.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
    });
    localStorage.setItem('sms_session', JSON.stringify(session));
  } catch(e) {}
}

function loadSession() {
  try {
    var saved = localStorage.getItem('sms_session');
    if (!saved) return;
    var s = JSON.parse(saved);
    if (s.bpm) { bpm = s.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
    if (s.clips) {
      s.clips.forEach(function(c) {
        var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
        var ex = getExercise(c.exerciseId);
        if (!track || !ex) return;
        var fm = FAMILY_MAP[ex.family] || {color:'#666'};
        var clip = document.createElement('div');
        clip.className = 'clip';
        clip.style.background = fm.color;
        clip.style.left = c.left;
        clip.style.width = c.width;
        clip.textContent = ex.name;
        clip.dataset.exerciseId = c.exerciseId;
        clip.dataset.sets = c.sets || '3';
        clip.dataset.reps = c.reps || '8';
        clip.dataset.tempo = c.tempo || '3';
        clip.dataset.rest = c.rest || '60';
        clip.dataset.rpe = c.rpe || '7';
        var info = document.createElement('span');
        info.className = 'clip-info';
        info.textContent = (c.sets||3)+'x'+(c.reps||8);
        clip.appendChild(info);
        var resize = document.createElement('div');
        resize.className = 'clip-resize';
        clip.appendChild(resize);
        clip.addEventListener('mousedown', function(e) {
          if (e.target.classList.contains('clip-resize')) return;
          e.preventDefault();
          selectClipEl(clip);
          var startX = e.clientX, startLeft = parseInt(clip.style.left);
          function onMove(e) { clip.style.left = Math.max(0, startLeft + e.clientX - startX) + 'px'; }
          function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        });
        resize.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          var startX = e.clientX, startW = parseInt(clip.style.width);
          function onMove(e) { clip.style.width = Math.max(40, startW + e.clientX - startX) + 'px'; }
          function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        });
        clip.addEventListener('dblclick', function() {
          clip.remove();
          if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
          updateStats(); saveSession();
        });
        track.appendChild(clip);
      });
    }
    if (s.faders) {
      Object.keys(s.faders).forEach(function(key) {
        var fader = document.querySelector('[data-fader="'+key+'"]');
        if (!fader) return;
        var v = s.faders[key];
        fader.querySelector('.fader-fill').style.height = v + '%';
        fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
        fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
      });
    }
    updateStats();
  } catch(e) {}
}

/* ===== EXPORT ===== */
function exportWorkout() {
  var workout = {
    name: 'Saturno Movement Studio Export',
    timestamp: new Date().toISOString(),
    bpm: bpm,
    bpmMode: document.getElementById('bpm-mode').textContent,
    tracks: {}
  };
  TRACKS.forEach(function(t) {
    workout.tracks[t.id] = [];
  });
  document.querySelectorAll('.clip').forEach(function(clip) {
    var trackId = clip.parentElement.dataset.track;
    var ex = getExercise(clip.dataset.exerciseId);
    workout.tracks[trackId].push({
      movement: ex ? ex.name : clip.textContent,
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      startTime: parseInt(clip.style.left) / 80 * 15,
      duration: parseInt(clip.style.width) / 80 * 15,
      sets: parseInt(clip.dataset.sets) || 3,
      reps: parseInt(clip.dataset.reps) || 8,
      tempo: parseFloat(clip.dataset.tempo) || 3,
      rest: parseInt(clip.dataset.rest) || 60,
      rpe: parseInt(clip.dataset.rpe) || 7
    });
  });
  var blob = new Blob([JSON.stringify(workout, null, 2)], {type: 'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'workout-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('Workout exported');
}

/* ===== TOAST ===== */
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'Escape') { stopPlayback(); }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    if (selectedClip) {
      selectedClip.remove();
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
      updateStats(); saveSession();
      toast('Clip deleted');
    }
  }
});
</script>
</body>
</html>
