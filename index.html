<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<title>SATURNO MOVEMENT STUDIO - The Ableton of Movement</title>
<meta name="description" content="The Ableton of Movement. DAW-style workout composition with drag-drop exercises, BPM training modes, and music sync.">
<meta property="og:title" content="Saturno Movement Studio">
<meta property="og:description" content="The Ableton of Movement. Compose workouts like music.">
<meta property="og:type" content="website">
<link rel="icon" href="assets/planet-logo.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* SATURNO FORGE DESIGN LOCK V3.0 — Endel x Craft x Logic Pro */
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #050711;
  --bg-deep: #030509;
  --surface: #0a0e1a;
  --surface2: #0d1117;
  --surface3: #111827;
  --border: rgba(255,255,255,0.06);
  --border-hover: rgba(255,255,255,0.12);
  --border-active: #3b82f6;
  --text: #e2e8f0;
  --text-bright: #ffffff;
  --text-secondary: #8b94a5;
  --muted: #64748b;
  --micro: #475569;
  --accent: #d97706;
  --accent-dim: rgba(217, 119, 6, 0.15);
  --blue: #3b82f6;
  --purple: #8b5cf6;
  --success: #22c55e;
  --error: #ef4444;
  --accent-cyan: #06b6d4;
  --accent-blue: #3b82f6;
  --accent-purple: #8b5cf6;
  --accent-green: #22c55e;
  --accent-orange: #f97316;
  --accent-red: #ef4444;
  --accent-pink: #ec4899;
  --gradient-titan: linear-gradient(135deg, #06b6d4 0%, #3b82f6 35%, #8b5cf6 65%, #6d28d9 100%);
  --gradient-header: linear-gradient(180deg, #0f1219 0%, #0a0e1a 100%);
  --gradient-cosmic: radial-gradient(ellipse at 50% 0%, rgba(6,182,212,0.04) 0%, rgba(59,130,246,0.03) 30%, transparent 60%);
  --gradient-cosmic-surface: radial-gradient(ellipse at 50% 0%, rgba(6,182,212,0.03) 0%, transparent 50%);
  --gradient-cosmic-panel: linear-gradient(180deg, rgba(6,182,212,0.02) 0%, transparent 100%);
  --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-purple: 0 0 20px rgba(139, 92, 246, 0.3);
  --glow-cyan: 0 0 20px rgba(6, 182, 212, 0.3);
  --glow-subtle: 0 0 1px rgba(59, 130, 246, 0.15);
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 8px;
  --glass: rgba(255,255,255,0.03);
  --glass-border: rgba(255,255,255,0.05);
  --shadow-soft: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-deep: 0 8px 32px rgba(0,0,0,0.4);
  --transition-fast: 0.12s;
  --transition-normal: 0.2s;
  --transition-slow: 0.3s;
}

body {
  background: var(--bg);
  background-image: var(--gradient-cosmic);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
}

/* Layout */
.app { display: grid; grid-template-rows: 40px 1fr 24px; height: 100vh; }

/* ===== HEADER — Endel/Craft Toolbar ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  height: 40px;
  border-bottom: 1px solid var(--border);
  background: var(--gradient-header);
  position: relative;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.header::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(6,182,212,0.15) 25%, rgba(59,130,246,0.2) 50%, rgba(139,92,246,0.15) 75%, transparent 95%);
}
/* Global progress bar — thin line at bottom of header showing playback position */
.header-progress {
  position: absolute; bottom: 0; left: 0;
  height: 2px; width: 0%;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
  z-index: 5;
  transition: width 0.1s linear;
  opacity: 0;
}
.header-progress.active { opacity: 1; }
.logo { display: flex; align-items: center; gap: 8px; }
.logo-icon {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
}
.logo-icon img {
  width: 16px; height: 16px; filter: brightness(0) invert(1); opacity: 0.8;
  transition: filter 0.3s, opacity 0.3s;
}
.logo:hover .logo-icon img {
  opacity: 1;
  filter: brightness(0) invert(1) drop-shadow(0 0 4px rgba(59, 130, 246, 0.5));
}
.logo-text {
  font-size: 11px; font-weight: 700;
  letter-spacing: 0.08em; color: var(--text);
}
.logo-sub {
  font-size: 8px; color: var(--micro); margin-top: 0;
  text-transform: uppercase; letter-spacing: 0.15em;
}
.header-nav { display: flex; gap: 1px; align-items: center; }
.nav-btn {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 5px 10px; font-size: 9px; font-family: 'Sora', sans-serif;
  background: transparent; border: none;
  color: var(--muted); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.2s;
  height: 26px;
}
.nav-btn:hover { color: var(--text); }
.nav-btn.active {
  color: var(--text); font-weight: 600;
}
.header-nav .nav-sep {
  width: 1px; height: 16px; background: var(--border); margin: 0 4px;
}

/* ===== MAIN 3-PANEL ===== */
.main { display: grid; grid-template-columns: 220px 3px 1fr 280px; overflow: hidden; }

/* ===== LEFT PANEL: MOVEMENT LIBRARY ===== */
.panel-left {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.panel-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro);
  display: flex; justify-content: space-between; align-items: center;
  height: 32px;
  background: rgba(10,14,26,0.6);
  position: relative;
}
.panel-header::after {
  content: '';
  position: absolute; bottom: 0; left: 10%; right: 10%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
}
.panel-header span:last-child {
  font-size: 8px; color: var(--micro);
  background: rgba(3,5,9,0.4); padding: 1px 5px;
  border-radius: var(--radius-sm);
}
.lib-search {
  width: calc(100% - 16px); margin: 6px 8px;
  padding: 6px 10px; font-size: 10px; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border); color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
  border-radius: var(--radius-md);
}
.lib-search:focus { outline: none; border-color: rgba(59,130,246,0.3); box-shadow: 0 0 12px rgba(59,130,246,0.08); }
.lib-search::placeholder { color: var(--micro); }
.movement-category { border-bottom: 1px solid rgba(255,255,255,0.04); }
.category-header {
  padding: 7px 12px; font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s;
}
.category-header:hover { background: var(--glass); }
.category-header .arrow { font-size: 7px; transition: transform 0.15s; color: var(--micro); }
.category-header.collapsed .arrow { transform: rotate(-90deg); }
.category-color { width: 6px; height: 6px; border-radius: 1px; }
.movement-list { padding: 2px 6px 6px; }
.movement-list.hidden { display: none; }
.movement-item {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 8px; margin-bottom: 1px;
  font-size: 10px;
  background: transparent;
  border: none;
  border-left: 2px solid transparent;
  cursor: grab;
  transition: background 0.15s, border-color 0.15s, transform 0.1s;
  border-radius: var(--radius-sm);
}
.movement-item:hover {
  background: var(--glass);
  border-left-color: rgba(255,255,255,0.15);
}
.movement-item:active {
  cursor: grabbing;
  background: rgba(59,130,246,0.06);
  border-left-color: rgba(59,130,246,0.4);
  transform: scale(0.98);
}
.movement-item .mv-icon {
  width: 18px; height: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; flex-shrink: 0;
  border-radius: 2px;
}
.movement-item .mv-stage {
  font-size: 7px; color: var(--micro); margin-left: auto;
  text-transform: uppercase; letter-spacing: 0.08em;
}
.movement-item .mv-detail {
  display: none; position: absolute; left: 100%; top: 0;
  background: var(--surface2); border: 1px solid var(--border);
  padding: 6px 10px; white-space: nowrap; z-index: 100;
  font-size: 8px; color: var(--text-secondary);
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  border-radius: 2px; pointer-events: none;
}
.movement-item { position: relative; }
.movement-item:hover .mv-detail { display: block; }
/* Clip stage dots */
.clip-rpe-badge {
  position: absolute; bottom: 2px; right: 4px;
  font-size: 7px; font-weight: 600; color: rgba(255,255,255,0.35);
  z-index: 2; pointer-events: none; line-height: 1;
}
.clip-stage-dots {
  position: absolute; top: 3px; right: 6px;
  display: flex; gap: 2px; z-index: 2;
}
.clip-stage-dot {
  width: 3px; height: 3px; border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transition: background 0.15s, box-shadow 0.15s;
}
.clip-stage-dot.filled { background: rgba(255,255,255,0.85); box-shadow: 0 0 4px rgba(255,255,255,0.3); }

/* ===== CENTER PANEL ===== */
.panel-center { display: flex; flex-direction: column; overflow: hidden; }

/* Transport Bar — Endel/Craft Style */
.transport {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  background: linear-gradient(180deg, rgba(15,18,25,0.95) 0%, rgba(10,14,26,0.98) 100%);
  border-bottom: 1px solid var(--border);
  height: 44px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.transport-buttons { display: flex; gap: 1px; }
.transport-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 12px;
  font-family: 'Sora', sans-serif;
  transition: color 0.2s, background 0.2s, border-color 0.2s, box-shadow 0.2s;
}
.transport-btn:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
.transport-btn:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
.transport-btn + .transport-btn { border-left: none; }
.transport-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }
.transport-btn.active { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: var(--blue); box-shadow: 0 0 12px rgba(59,130,246,0.15); }
.transport-btn.rec.active { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: var(--accent-red); box-shadow: 0 0 12px rgba(239,68,68,0.15); }
.transport-sep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }

/* BPM breathing pulse — syncs with current tempo */
@keyframes bpmBreath {
  0%, 100% { opacity: 0; }
  15% { opacity: 1; }
}
.bpm-pulse {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--accent-green);
  box-shadow: 0 0 6px rgba(34,197,94,0.4);
  animation: bpmBreath var(--bpm-duration, 0.5s) ease-out infinite;
  margin-left: 2px;
}
.time-display {
  font-family: 'Sora', sans-serif;
  font-size: 18px; font-weight: 700;
  color: var(--accent-green); padding: 0 10px;
  letter-spacing: 0.02em;
  font-variant-numeric: tabular-nums;
  min-width: 130px;
  display: flex; align-items: center;
  background: rgba(3,5,9,0.6);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  height: 30px;
  padding: 0 8px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
}
.td-seg {
  text-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
}
.td-colon { color: var(--micro); font-size: 14px; margin: 0 1px; }
.td-ms { color: var(--muted); font-size: 14px; }
.bpm-section { display: flex; align-items: center; gap: 4px; margin-left: auto; }
.bpm-label {
  font-size: 8px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.bpm-input {
  width: 48px; padding: 4px 6px; text-align: center;
  font-size: 13px; font-weight: 600; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.6); border: 1px solid var(--glass-border); color: var(--accent-orange);
  transition: border-color 0.15s;
  border-radius: var(--radius-sm);
}
.bpm-input:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 8px rgba(249,115,22,0.15); }
@keyframes bpmFlash {
  0% { box-shadow: 0 0 12px rgba(249,115,22,0.3), inset 0 0 4px rgba(249,115,22,0.1); }
  100% { box-shadow: none; }
}
.bpm-input.flash { animation: bpmFlash 0.4s ease-out; }
.bpm-mode {
  font-size: 8px; padding: 3px 8px;
  background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.15);
  color: var(--blue);
  text-transform: uppercase; letter-spacing: 0.1em;
  font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm);
}
.tempo-link {
  font-size: 8px; color: var(--muted); cursor: pointer;
  padding: 3px 6px; border: 1px solid transparent;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  border-radius: var(--radius-sm);
}
.tempo-link:hover { color: var(--accent-orange); border-color: rgba(249,115,22,0.2); background: rgba(249,115,22,0.05); }
.tempo-link.active { background: rgba(249,115,22,0.12); border-color: rgba(249,115,22,0.25); color: var(--accent-orange); box-shadow: 0 0 8px rgba(249,115,22,0.1); }

/* Transport state pill — colored indicator for PLAY/STOP/REC */
.transport-state {
  font-size: 7px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.15em;
  min-width: 34px; text-align: center;
  padding: 2px 6px; border-radius: var(--radius-sm);
  transition: color 0.15s, background 0.15s;
}
.transport-state.state-stop { color: var(--micro); background: transparent; }
.transport-state.state-play { color: var(--accent-green); background: rgba(34,197,94,0.08); }
.transport-state.state-rec { color: var(--accent-red); background: rgba(239,68,68,0.08); }

/* Video Section — Premiere Pro Source Monitor */
.video-section {
  background: var(--bg-deep);
  border-bottom: 1px solid var(--border);
  position: relative; min-height: 0; flex-shrink: 1; overflow: hidden;
}
.video-section.collapsed { height: 0; min-height: 0; border: none; }
.video-placeholder {
  display: flex; align-items: center; justify-content: center;
  height: 100%; min-height: 120px;
  color: var(--micro); font-size: 9px;
  flex-direction: column; gap: 6px;
  text-transform: uppercase; letter-spacing: 0.1em;
  border: 1px dashed rgba(255,255,255,0.06);
  margin: 6px;
  border-radius: var(--radius-md);
}
.video-placeholder .vp-icon { font-size: 20px; opacity: 0.2; }
.video-toggle {
  position: absolute; top: 4px; right: 4px;
  width: 18px; height: 18px;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer; font-size: 9px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.video-toggle:hover { color: var(--text); }

/* Mini-map overview */
.timeline-minimap {
  height: 16px;
  background: rgba(3,5,9,0.6);
  border-bottom: 1px solid rgba(255,255,255,0.03);
  position: sticky; top: 22px; z-index: 9;
  overflow: hidden; cursor: pointer;
}
.minimap-viewport {
  position: absolute; top: 0; bottom: 0;
  background: rgba(59, 130, 246, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.2);
  pointer-events: none;
  min-width: 20px;
}
.minimap-clip {
  position: absolute; height: 3px;
  border-radius: 1px; opacity: 0.7;
}

/* Timeline — Logic Pro Grid */
.timeline-container {
  flex: 1; overflow: auto; background: var(--bg-deep);
  position: relative;
}
.timeline-container::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 60px;
  background: var(--gradient-cosmic-panel);
  pointer-events: none; z-index: 0;
}
.timeline-ruler {
  height: 22px;
  background: rgba(10,14,26,0.8);
  border-bottom: 1px solid var(--border);
  display: flex; position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(4px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 1px 0 rgba(255,255,255,0.02);
  -webkit-backdrop-filter: blur(4px);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.ruler-mark {
  flex: 0 0 80px;
  border-right: 1px solid rgba(255,255,255,0.04);
  padding: 3px 8px; font-size: 9px;
  color: var(--micro);
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.05em;
}
.ruler-mark:first-child { flex: 0 0 100px; }
.ruler-mark:nth-child(4n+1) { color: var(--muted); }
.ruler-downbeat {
  border-right-color: rgba(255,255,255,0.08);
  color: var(--text-secondary);
}
.timeline-tracks { min-height: 200px; position: relative; }
.track {
  height: 60px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  display: flex;
  background: var(--bg-deep);
  transition: background 0.15s, height 0.2s ease;
  overflow: hidden;
}
.track.track-collapsed {
  height: 24px;
}
.track.track-collapsed .track-controls,
.track.track-collapsed .track-info,
.track.track-collapsed .track-clip-count { opacity: 0; pointer-events: none; }
.track.track-collapsed .clip { height: 18px; top: 3px; font-size: 7px; padding: 1px 4px 0; }
.track.track-collapsed .clip canvas { display: none; }
.track.track-collapsed .clip .beat-markers { display: none; }
.track.track-collapsed .clip .clip-info { display: none; }
.track.track-collapsed .clip .clip-progress { display: none; }
.track.track-collapsed .clip .clip-fade { display: none; }
.track.track-collapsed .clip .clip-stage-dots { display: none; }
.track.track-collapsed .clip .clip-rpe-badge { display: none; }
.track.track-collapsed .clip .clip-resize,
.track.track-collapsed .clip .clip-resize-left { display: none; }
.track:hover { background: rgba(10,14,26,0.8); }
.track:nth-child(even) { background: rgba(10,14,26,0.3); }
.track:nth-child(even):hover { background: rgba(10,14,26,0.6); }
/* Track grip dots (reorder indicator) — 6-dot matrix like Ableton */
.track-grip {
  display: grid; grid-template-columns: 2px 2px; gap: 2px;
  position: absolute; left: 4px; top: 50%;
  transform: translateY(-50%);
  opacity: 0; transition: opacity 0.15s;
  cursor: grab;
}
.track-header:hover .track-grip { opacity: 0.4; }
.track-grip:active { cursor: grabbing; opacity: 0.7 !important; }
.track-grip-dot {
  width: 2px; height: 2px;
  background: var(--muted);
  border-radius: 50%;
}
.track-header {
  width: 100px;
  background: rgba(10,14,26,0.6);
  border-right: 1px solid rgba(255,255,255,0.04);
  padding: 6px 8px;
  display: flex; flex-direction: column; justify-content: center;
  flex-shrink: 0;
  position: relative;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.track-header::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px;
}
.track[data-track="music"] .track-header::before { background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.3)); }
.track[data-track="push"] .track-header::before { background: linear-gradient(180deg, var(--accent-blue), rgba(59,130,246,0.3)); }
.track[data-track="pull"] .track-header::before { background: linear-gradient(180deg, var(--accent-purple), rgba(139,92,246,0.3)); }
.track[data-track="core"] .track-header::before { background: linear-gradient(180deg, var(--accent-orange), rgba(249,115,22,0.3)); }
.track[data-track="legs"] .track-header::before { background: linear-gradient(180deg, var(--accent-green), rgba(34,197,94,0.3)); }
.track[data-track="skills"] .track-header::before { background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.3)); }
.track-name {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-info {
  font-size: 7px; color: var(--micro); margin-top: 1px;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-controls { display: flex; gap: 1px; margin-top: 4px; padding-left: 6px; }
.track-btn {
  width: 18px; height: 14px; font-size: 7px; font-weight: 700;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.15s;
  border-radius: 0;
}
.track-btn:hover { color: var(--text); }
.track-btn.muted { color: var(--accent-orange); }
.track-btn.soloed { color: var(--accent-cyan); }
.track-content {
  flex: 1; position: relative; min-width: 800px;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
}
/* 16th note grid subdivision — visible at higher zoom */
.track-content.grid-16th {
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 4px, rgba(255,255,255,0.01) 4px, rgba(255,255,255,0.01) 5px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
}
.track-content.grid-hidden { background: none !important; }
.track-content.drag-over {
  background:
    linear-gradient(90deg, rgba(59, 130, 246, 0.06) 0%, transparent 50%),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
  box-shadow: inset 0 0 20px rgba(59,130,246,0.04);
}
.track-clip-count {
  font-size: 7px; color: var(--micro);
  background: rgba(3,5,9,0.4);
  padding: 0 4px; border-radius: var(--radius-sm);
  margin-top: 2px; display: inline-block;
  padding-left: 6px;
}

/* Track header tiny VU meter — 5 dots showing activity level */
.track-vu {
  display: flex; gap: 1px; position: absolute; right: 6px; top: 50%;
  transform: translateY(-50%);
}
.track-vu-dot {
  width: 2px; height: 6px; border-radius: 1px;
  background: rgba(255,255,255,0.06);
  transition: background 0.08s, height 0.08s;
}
.track-vu-dot.on-low { background: var(--accent-green); }
.track-vu-dot.on-mid { background: var(--accent-orange); }
.track-vu-dot.on-high { background: var(--accent-red); }

/* Clips — Logic Pro Audio Region Style */
@keyframes clipInsert {
  0% { transform: scaleX(0); opacity: 0; }
  100% { transform: scaleX(1); opacity: 1; }
}
.clip {
  position: absolute; height: 44px; top: 8px;
  border: 1px solid rgba(255,255,255,0.06);
  border-top: 2px solid;
  border-radius: var(--radius-sm);
  cursor: move; display: flex; align-items: flex-start;
  padding: 3px 8px 0; font-size: 9px; font-weight: 600;
  user-select: none; overflow: hidden; white-space: nowrap;
  transition: box-shadow 0.2s, opacity 0.15s, border-color 0.15s, transform 0.15s, filter 0.15s;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04), var(--shadow-soft);
  animation: clipInsert 0.15s ease-out;
  transform-origin: left center;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}
.clip::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 8px;
  background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.25) 100%);
  pointer-events: none;
}
.clip canvas.clip-waveform {
  position: absolute; bottom: 2px; left: 4px; right: 4px;
  height: 20px; width: calc(100% - 8px);
  pointer-events: none;
}
.clip .beat-markers {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
}
.clip .beat-markers span {
  position: absolute; top: 0; bottom: 0; width: 1px;
  background: rgba(255,255,255,0.06);
}
/* Clip fade handles */
.clip .clip-fade {
  position: absolute; top: 0; width: 0; height: 100%;
  cursor: ew-resize; z-index: 2;
}
.clip .clip-fade-in { left: 0; }
.clip .clip-fade-out { right: 0; }
.clip .clip-fade::after {
  content: '';
  position: absolute; top: 0;
  width: 0; height: 0;
  border-style: solid;
  opacity: 0;
  transition: opacity 0.15s;
}
.clip:hover .clip-fade-in::after {
  opacity: 0.4;
  border-width: 44px 12px 0 0;
  border-color: rgba(0,0,0,0.5) transparent transparent transparent;
  left: 0; top: 0;
}
.clip:hover .clip-fade-out::after {
  opacity: 0.4;
  border-width: 0 0 44px 12px;
  border-color: transparent transparent rgba(0,0,0,0.5) transparent;
  right: 0; bottom: 0; top: auto;
  position: absolute;
}
.clip .clip-fade-in.has-fade::after {
  opacity: 0.5 !important;
}
.clip .clip-fade-out.has-fade::after {
  opacity: 0.5 !important;
}
/* Muted track clips */
.track.track-muted .clip { opacity: 0.3; filter: grayscale(0.6); }
.clip:hover {
  box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 4px 16px rgba(0,0,0,0.3);
  border-color: rgba(255,255,255,0.12);
  transform: translateY(-1px);
  filter: brightness(1.04);
}
.clip.clip-dragging {
  transform: translateY(-2px) scale(1.01);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.15), 0 8px 24px rgba(0,0,0,0.4);
  filter: brightness(1.08);
  z-index: 100;
}
.clip.selected {
  border-color: rgba(255,255,255,0.5);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.3), 0 0 16px rgba(255,255,255,0.08), 0 0 24px rgba(59,130,246,0.06);
  filter: brightness(1.08);
  animation: clip-select-flash 0.3s ease-out;
}
@keyframes clip-select-flash {
  0% { box-shadow: 0 0 0 2px rgba(59,130,246,0.6), 0 0 20px rgba(59,130,246,0.3); }
  100% { box-shadow: 0 0 0 1px rgba(255,255,255,0.3), 0 0 16px rgba(255,255,255,0.08), 0 0 24px rgba(59,130,246,0.06); }
}
.clip .clip-name {
  overflow: hidden; white-space: nowrap;
  max-width: calc(100% - 30px);
  display: inline-block; vertical-align: top;
  -webkit-mask-image: linear-gradient(90deg, #000 70%, transparent 100%);
  mask-image: linear-gradient(90deg, #000 70%, transparent 100%);
}
.clip .clip-info {
  font-size: 7px; opacity: 0.5; margin-left: 4px;
  text-transform: uppercase; letter-spacing: 0.05em;
  font-weight: 400;
}
.clip.clip-playing {
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.06),
              0 0 12px rgba(255,255,255,0.15), 0 0 4px currentColor;
  border-color: rgba(255,255,255,0.2);
  filter: brightness(1.12);
}
.clip.clip-locked { opacity: 0.7; cursor: default; }
.clip.clip-locked .clip-resize, .clip.clip-locked .clip-resize-left { display: none; }
.clip.clip-locked::before { content: ''; position: absolute; top: 2px; left: 2px; width: 6px; height: 6px; border: 1px solid rgba(255,255,255,0.3); border-radius: 1px; z-index: 3; }
/* Playback progress overlay — subtle fill from left to show elapsed */
.clip-progress-fill {
  position: absolute; top: 0; left: 0; bottom: 0;
  background: rgba(255,255,255,0.02);
  pointer-events: none; z-index: 0;
  width: 0%; transition: width 0.08s linear;
}
.clip-resize {
  position: absolute; right: 0; top: 0; bottom: 0;
  width: 5px; cursor: ew-resize;
  background: transparent;
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize, .clip:hover .clip-resize-left { opacity: 1; background: rgba(255,255,255,0.2); }
.clip-resize:hover, .clip-resize-left:hover { background: rgba(255,255,255,0.4) !important; }
.clip-resize::before {
  content: ''; position: absolute;
  top: 50%; transform: translateY(-50%);
  right: 1px; width: 1px; height: 12px;
  background: rgba(255,255,255,0.4);
  box-shadow: -2px 0 0 rgba(255,255,255,0.4);
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize::before { opacity: 1; }
.playhead {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: var(--text-bright);
  box-shadow: 0 0 8px rgba(255,255,255,0.4), 1px 0 0 rgba(255,255,255,0.08), -1px 0 0 rgba(255,255,255,0.08);
  z-index: 20; pointer-events: none; left: 100px;
}
.playhead.playing {
  box-shadow: 0 0 12px rgba(59,130,246,0.5), 0 0 4px rgba(255,255,255,0.3);
  background: #60a5fa;
  /* Gradient trail behind the playhead */
  border-image: linear-gradient(to right, rgba(59,130,246,0.02), rgba(59,130,246,0.15), transparent) 1;
}
.playhead.playing::after {
  content: '';
  position: absolute;
  width: 60px; left: -60px; height: 100%; bottom: auto; top: 0;
  background: linear-gradient(to right, transparent, rgba(59,130,246,0.06));
  border-radius: 0; opacity: 1;
  pointer-events: none;
}
.playhead::before {
  content: '';
  position: absolute; top: -2px; left: -5px;
  width: 11px; height: 9px;
  background: var(--text-bright);
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}
.playhead.playing::before {
  background: #60a5fa;
}
.playhead::after {
  content: '';
  position: absolute; bottom: 0; left: -2px;
  width: 5px; height: 3px;
  background: var(--text-bright);
  border-radius: 3px 3px 0 0;
  opacity: 0.5;
}

/* Armed track pulsing left border */
@keyframes armPulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}
.track-btn.armed {
  background: var(--error); color: var(--bg); border-color: var(--error);
  animation: armPulse 1.5s ease-in-out infinite;
}
/* Track-level armed glow — entire track gets subtle red tint */
.track:has(.track-btn.armed) .track-header {
  background: rgba(239,68,68,0.04);
  border-left: 2px solid rgba(239,68,68,0.3);
}
.track:has(.track-btn.armed) .track-content {
  background: rgba(239,68,68,0.01);
}

/* Metronome active pulse */
@keyframes metroPulse {
  0%, 100% { background: var(--accent-orange); }
  50% { background: var(--accent-green); }
}
.transport-btn.metro-active {
  background: var(--accent-orange); color: var(--bg); border-color: var(--accent-orange);
}

/* ===== RIGHT PANEL: MIXER + INSPECTOR ===== */
.panel-right {
  background: var(--surface);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.mixer-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.mixer-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
}
.mixer-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro); margin-bottom: 10px;
}

/* Faders — Channel Strip Style */
.fader-group { display: flex; gap: 10px; justify-content: center; }
.fader { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.fader-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--micro);
  text-align: center; max-width: 40px;
}
.fader-track {
  width: 6px; height: 80px;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border);
  position: relative; cursor: pointer;
  border-radius: var(--radius-sm);
}
.fader-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--gradient-titan);
  transition: height 0.1s;
  border-radius: 0 0 3px 3px;
}
.fader-handle {
  position: absolute; left: -5px; right: -5px;
  height: 12px;
  background: linear-gradient(180deg, rgba(100,116,139,0.6) 0%, rgba(45,55,72,0.6) 100%);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  cursor: grab;
  transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.4);
}
.fader-handle:hover { background: linear-gradient(180deg, rgba(100,116,139,0.8) 0%, rgba(71,85,105,0.7) 100%); border-color: rgba(255,255,255,0.15); box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
.fader-value {
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--muted); font-weight: 500;
  font-variant-numeric: tabular-nums;
}

/* Knobs — Pro Tools Style */
.knob-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.knob { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.knob-dial {
  width: 34px; height: 34px;
  background: conic-gradient(
    from 225deg,
    var(--accent-cyan) 0deg,
    var(--blue) calc(var(--knob-value, 0.5) * 135deg),
    var(--accent-purple) calc(var(--knob-value, 0.5) * 270deg),
    rgba(255,255,255,0.04) calc(var(--knob-value, 0.5) * 270deg),
    rgba(255,255,255,0.04) 270deg
  );
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 50%; position: relative; cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.knob-dial:hover { border-color: rgba(59,130,246,0.3); box-shadow: 0 0 12px rgba(59,130,246,0.1); }
.knob-dial::before {
  content: '';
  position: absolute; top: 50%; left: 50%;
  width: 22px; height: 22px;
  background: radial-gradient(circle, rgba(17,24,39,0.9) 0%, rgba(3,5,9,0.9) 100%);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  border: 1px solid rgba(255,255,255,0.05);
}
.knob-indicator {
  position: absolute; width: 2px; height: 9px;
  background: var(--text); top: 3px; left: 50%;
  transform-origin: bottom center; transform: translateX(-50%);
  border-radius: 1px;
}
.knob-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--micro); text-align: center;
}
.knob-value {
  font-size: 8px; color: var(--muted);
  font-variant-numeric: tabular-nums;
}

/* Meters — VU Meter Style */
.meter-group {
  display: flex; gap: 1px; justify-content: center;
  height: 50px; align-items: flex-end;
  background: rgba(3,5,9,0.5);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  padding: 3px;
}
.meter-bar {
  width: 3px; background: var(--accent-green);
  transition: height 0.08s;
  border-radius: 1px 1px 0 0;
  position: relative;
}
.meter-bar .peak-hold {
  position: absolute; top: -2px; left: 0; right: 0;
  height: 1px; background: var(--text-bright);
  opacity: 0.6;
}

/* Channel Meters — per track mini VU */
.channel-meters {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;
  padding: 4px 0;
}
.channel-meter {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
}
.channel-meter-bar {
  width: 100%; height: 4px;
  background: rgba(3,5,9,0.5);
  border: 1px solid var(--glass-border);
  border-radius: 2px;
  overflow: hidden;
}
.channel-meter-fill {
  height: 100%;
  background: var(--accent-green);
  transition: width 0.08s;
}
.channel-meter-label {
  font-size: 6px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* Clip playback progress overlay */
.clip .clip-progress {
  position: absolute; top: 0; left: 0; bottom: 0;
  background: rgba(255,255,255,0.06);
  pointer-events: none; width: 0;
  border-right: 1px solid rgba(255,255,255,0.15);
}

/* Active track highlight */
.track.track-active {
  background: rgba(59, 130, 246, 0.04) !important;
}
.track.track-active .track-header {
  border-right-color: rgba(59, 130, 246, 0.3);
}
.track.track-active .track-header::before {
  box-shadow: 0 0 8px currentColor;
}

/* Empty Timeline State */
.timeline-empty {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center; pointer-events: none;
  z-index: 5; opacity: 1;
  transition: opacity 0.3s;
}
.timeline-empty.hidden { opacity: 0; pointer-events: none; }
.timeline-empty-icon {
  font-size: 32px; opacity: 0.1; margin-bottom: 12px;
  line-height: 1;
}
.timeline-empty-title {
  font-size: 12px; font-weight: 600; color: var(--text-secondary);
  margin-bottom: 6px; letter-spacing: 0.05em;
}
.timeline-empty-desc {
  font-size: 9px; color: var(--micro); max-width: 280px;
  line-height: 1.6; letter-spacing: 0.03em;
}
.timeline-empty-steps {
  display: flex; gap: 24px; margin-top: 16px; justify-content: center;
}
.timeline-empty-step {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.timeline-empty-step-num {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; color: var(--muted);
  background: var(--glass);
}
.timeline-empty-step-text {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.1em;
  max-width: 60px; text-align: center;
}
@keyframes emptyPulse {
  0%, 100% { opacity: 0.08; }
  50% { opacity: 0.15; }
}
.timeline-empty-icon { animation: emptyPulse 3s ease-in-out infinite; }

/* Right Panel Tabs */
.panel-tabs {
  display: flex; border-bottom: 1px solid var(--border);
  background: rgba(10,14,26,0.6);
  flex-shrink: 0;
}
.panel-tab {
  flex: 1; padding: 6px 0;
  font-size: 8px; font-weight: 600; font-family: 'Sora', sans-serif;
  text-transform: uppercase; letter-spacing: 0.12em;
  background: none; border: none; border-bottom: 2px solid transparent;
  color: var(--micro); cursor: pointer;
  transition: color 0.2s, border-color 0.2s, background 0.2s;
}
.panel-tab:hover { color: var(--text-secondary); background: var(--glass); }
.panel-tab.active {
  color: var(--text); border-bottom-color: var(--blue);
}
.panel-tab-content { display: none; opacity: 0; }
.panel-tab-content.active { display: block; opacity: 1; animation: panelFadeIn 0.15s ease; }
@keyframes panelFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* Custom Clip Tooltip */
.clip-tip {
  position: fixed; z-index: 300;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  padding: 8px 12px;
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--text); pointer-events: none;
  box-shadow: var(--shadow-deep);
  white-space: nowrap;
  opacity: 0; transition: opacity 0.15s;
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.clip-tip.show { opacity: 1; }
.clip-tip-name {
  font-weight: 600; font-size: 10px;
  margin-bottom: 3px; letter-spacing: 0.02em;
}
.clip-tip-detail {
  font-size: 8px; color: var(--text-secondary);
  display: flex; gap: 8px; letter-spacing: 0.03em;
}
.clip-tip-detail span { color: var(--muted); }

/* Track Header Context Menu */
.track-ctx {
  position: fixed; z-index: 200;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  min-width: 140px; padding: 4px 0;
  box-shadow: var(--shadow-deep);
  font-family: 'Sora', sans-serif;
  border-radius: var(--radius-md);
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.track-ctx.open { display: block; }
.track-ctx-item {
  padding: 6px 14px; font-size: 9px;
  color: var(--text-secondary); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.06em;
  transition: background 0.1s, color 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.track-ctx-item:hover { background: rgba(59,130,246,0.08); color: var(--text); }
.track-ctx-item.danger { color: var(--error); }
.track-ctx-item.danger:hover { background: rgba(239,68,68,0.08); }
.track-ctx-sep { height: 1px; background: rgba(255,255,255,0.04); margin: 3px 4px; }

/* Snap grid indicator */
.snap-indicator {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: rgba(59, 130, 246, 0.3);
  pointer-events: none; z-index: 15;
  opacity: 0; transition: opacity 0.1s;
}
.snap-indicator.visible { opacity: 1; }

/* Inspector — Properties Panel */
.inspector-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--blue);
  position: relative;
}
.inspector-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, rgba(6,182,212,0.08), rgba(59,130,246,0.06), transparent 80%);
}
.inspector-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--blue); margin-bottom: 8px;
}
.inspector-field { margin-bottom: 6px; }
.inspector-field label {
  display: block; font-size: 8px;
  color: var(--micro); text-transform: uppercase;
  letter-spacing: 0.15em; margin-bottom: 3px;
}
.inspector-field .value { font-size: 11px; color: var(--text); }
.inspector-field input, .inspector-field select {
  width: 100%; padding: 5px 8px;
  font-size: 11px; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border); color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
  border-radius: var(--radius-sm);
}
.inspector-field input:focus, .inspector-field select:focus {
  outline: none; border-color: rgba(59,130,246,0.3); box-shadow: 0 0 8px rgba(59,130,246,0.1);
}
.inspector-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; }
.inspector-tag {
  font-size: 8px; padding: 0;
  background: none; border: none;
  color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* Music Player — Minimal Waveform Style */
.music-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--accent-green);
  position: relative;
}
.music-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, rgba(34,197,94,0.1), transparent 80%);
}
.music-now-playing {
  font-size: 10px; color: var(--text-secondary);
  margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
}
.music-now-playing .eq { display: flex; gap: 1px; align-items: flex-end; height: 10px; }
.music-now-playing .eq span { width: 2px; background: var(--accent-green); animation: eqBounce 0.8s ease-in-out infinite alternate; }
.music-now-playing .eq span:nth-child(2) { animation-delay: 0.2s; }
.music-now-playing .eq span:nth-child(3) { animation-delay: 0.4s; }
@keyframes eqBounce { 0% { height: 2px; } 100% { height: 10px; } }
.music-controls { display: flex; gap: 2px; align-items: center; }
.music-btn {
  width: 26px; height: 26px;
  background: rgba(3,5,9,0.4); border: 1px solid var(--glass-border);
  color: var(--muted); cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Sora', sans-serif;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
  border-radius: var(--radius-sm);
}
.music-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.music-btn.playing { background: var(--accent-green); color: var(--bg); border-color: var(--accent-green); }
.music-volume {
  width: 60px; height: 2px; margin-left: 4px;
  -webkit-appearance: none; appearance: none;
  background: var(--border); outline: none; cursor: pointer;
}
.music-volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 8px; height: 8px;
  background: var(--accent-green); border-radius: 50%; cursor: pointer;
}

/* Export Button */
.export-btn {
  padding: 7px 12px;
  background: var(--glass); border: 1px solid var(--glass-border);
  color: var(--text-secondary); font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  cursor: pointer; width: 100%;
  transition: color 0.15s, border-color 0.15s, background 0.15s, box-shadow 0.15s;
  border-radius: var(--radius-sm);
}
.export-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); box-shadow: var(--shadow-soft); }

/* ===== FOOTER — Status Bar ===== */
.footer {
  background: rgba(10,14,26,0.8);
  border-top: 1px solid var(--border);
  padding: 0 16px;
  display: flex; align-items: center; justify-content: space-between;
  font-size: 9px; color: var(--micro);
  letter-spacing: 0.03em;
  height: 24px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  position: relative;
}
.footer::before {
  content: '';
  position: absolute; top: 0; left: 5%; right: 5%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(6,182,212,0.08), rgba(59,130,246,0.06), transparent);
}
.status-item { display: flex; align-items: center; gap: 4px; }
.status-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--accent-green);
  box-shadow: 0 0 4px rgba(34,197,94,0.3);
  transition: background 0.2s, box-shadow 0.2s;
}
.status-dot.playing {
  background: var(--accent-blue);
  box-shadow: 0 0 6px rgba(59,130,246,0.4);
  animation: bpmBreath var(--bpm-duration, 0.5s) ease-out infinite;
}
.status-dot.recording {
  background: var(--accent-red);
  box-shadow: 0 0 6px rgba(239,68,68,0.4);
  animation: recPulse 1s ease-in-out infinite;
}
.footer-quote {
  font-style: italic; opacity: 0.3; letter-spacing: 0.05em; font-size: 8px;
  min-width: 160px; text-align: center;
  transition: opacity 0.3s;
}
.footer-quote.fade { opacity: 0; }

/* Mixer section collapse toggle */
.mixer-collapse {
  position: absolute; top: 10px; right: 10px;
  width: 14px; height: 14px;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer;
  font-size: 7px; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.15s, transform 0.15s;
  border-radius: 2px;
}
.mixer-collapse:hover { color: var(--text-secondary); }
.mixer-collapse.collapsed { transform: rotate(-90deg); }
.mixer-section-body { transition: max-height 0.2s ease, opacity 0.15s; overflow: hidden; }
.mixer-section-body.hidden { max-height: 0 !important; opacity: 0; padding: 0; margin: 0; }

/* Selection count badge — floating indicator when multiple clips selected */
.selection-badge {
  position: fixed; bottom: 36px; left: 50%;
  transform: translateX(-50%) translateY(8px);
  display: flex; align-items: center; gap: 8px;
  font-size: 9px; font-weight: 600;
  color: var(--text); background: rgba(10,14,26,0.92);
  border: 1px solid rgba(59,130,246,0.25);
  padding: 4px 6px 4px 12px; z-index: 100;
  text-transform: uppercase; letter-spacing: 0.06em;
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  opacity: 0; transition: opacity 0.2s, transform 0.2s;
  pointer-events: none;
}
.selection-badge.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
.selection-badge .sel-count { color: var(--accent-cyan); margin-right: 4px; }
.selection-badge .sel-action {
  font-size: 8px; padding: 3px 8px; border: none; background: rgba(255,255,255,0.05);
  color: var(--muted); cursor: pointer; font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm); text-transform: uppercase; letter-spacing: 0.05em;
  transition: color 0.15s, background 0.15s;
}
.selection-badge .sel-action:hover { color: var(--text); background: rgba(255,255,255,0.08); }
.selection-badge .sel-action.danger:hover { color: var(--accent-red); }

/* Global Range Inputs — Pro DAW sliders */
input[type="range"] {
  -webkit-appearance: none; appearance: none;
  height: 3px; background: var(--border); outline: none;
  cursor: pointer; border-radius: 1px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 10px; height: 10px;
  background: var(--text-secondary);
  border-radius: 50%; cursor: pointer;
  border: 1px solid var(--border);
  transition: background 0.15s, transform 0.1s;
}
input[type="range"]::-webkit-slider-thumb:hover {
  background: var(--text); transform: scale(1.2);
}
input[type="range"]:focus::-webkit-slider-thumb {
  background: var(--blue); border-color: var(--blue);
}

/* Global Number Inputs — DAW Style */
input[type="number"] {
  -moz-appearance: textfield;
  font-variant-numeric: tabular-nums;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  opacity: 0; height: 100%;
}
input[type="number"]:hover::-webkit-inner-spin-button,
input[type="number"]:hover::-webkit-outer-spin-button {
  opacity: 0.4;
}

/* Track solo/mute state indicators */
.track.track-muted .track-header { opacity: 0.4; }
.track.track-muted .track-name { text-decoration: line-through; }

/* Snap indicator in transport */
.snap-badge {
  font-size: 7px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; padding: 2px 6px;
  border-radius: var(--radius-sm); color: var(--micro);
  background: transparent; border: 1px solid transparent;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
}
.snap-badge.active {
  color: var(--accent-cyan); background: transparent;
  border-color: transparent;
}

/* Focus visible for keyboard accessibility */
:focus-visible {
  outline: 1px solid var(--blue);
  outline-offset: 1px;
}
button:focus-visible, .transport-btn:focus-visible {
  outline: 1px solid var(--blue);
  outline-offset: -1px;
}

/* Rubber band selection box */
.select-box {
  position: absolute; z-index: 30;
  border: 1px solid rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  pointer-events: none;
  border-radius: 1px;
}

/* Solo track highlight — non-soloed tracks dim when any is soloed */
.track-btn.soloed ~ .track-btn { opacity: 0.5; }
.track.track-soloed .track-header::before {
  box-shadow: 0 0 10px var(--accent-cyan);
}
.track.track-soloed .track-header {
  background: rgba(6,182,212,0.06);
}
/* Dim non-soloed tracks when solo is active */
.track:not(.track-soloed) { transition: opacity 0.2s, filter 0.2s; }
.timeline-tracks.has-solo .track:not(.track-soloed) {
  opacity: 0.35; filter: saturate(0.4);
}
.timeline-tracks.has-solo .track.track-soloed {
  opacity: 1; filter: none;
}

/* Active track — left accent glow when selected via number key or header click */
.track.track-active .track-header {
  border-left: 2px solid var(--accent-blue);
  background: rgba(59,130,246,0.04);
}
.track.track-active .track-content {
  background: rgba(59,130,246,0.015);
}

/* Marquee rubber-band selection */
.marquee-selection {
  position: absolute;
  border: 1px solid rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  border-radius: var(--radius-sm);
  pointer-events: none;
  z-index: 20;
}

/* Snap line flash */
@keyframes snapFlash {
  0% { opacity: 0.6; }
  100% { opacity: 0; }
}
.snap-line {
  position: absolute;
  top: 0; bottom: 0;
  width: 1px;
  background: var(--accent-blue);
  pointer-events: none;
  z-index: 15;
  animation: snapFlash 0.3s ease-out forwards;
}

/* Clip overlap warning — pulsing border when clips overlap */
.clip.clip-superset::after {
  content: 'SS'; position: absolute; top: 1px; right: 2px;
  font-size: 6px; font-weight: 700; color: rgba(168,85,247,0.7);
  letter-spacing: 0.04em; pointer-events: none; z-index: 3;
}
.clip.clip-overlap {
  border: 1px solid rgba(239,68,68,0.4);
  box-shadow: inset 0 0 6px rgba(239,68,68,0.1);
}
.clip.clip-overlap-flash {
  animation: overlapPulse 0.6s ease-out;
}
@keyframes overlapPulse {
  0% { box-shadow: inset 0 0 12px rgba(239,68,68,0.3), 0 0 8px rgba(239,68,68,0.2); }
  100% { box-shadow: inset 0 0 6px rgba(239,68,68,0.1); }
}

/* Locate / scroll-to-playhead button in transport */
.locate-btn {
  padding: 0 8px; height: 22px; font-size: 7px;
  font-weight: 700; letter-spacing: 0.06em;
  text-transform: uppercase;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: var(--micro); cursor: pointer; font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm);
  transition: color 0.15s, background 0.15s, border-color 0.15s;
}
.locate-btn:hover { color: var(--text-secondary); background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }

/* Panel section gradient dividers — frosted glass separators */
.panel-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(6,182,212,0.06) 25%, rgba(59,130,246,0.08) 50%, rgba(139,92,246,0.06) 75%, transparent 95%);
  margin: 0;
}

/* Track number badge — large watermark number in header */
.track-num {
  position: absolute; right: 6px; bottom: 2px;
  font-size: 18px; font-weight: 800;
  color: rgba(255,255,255,0.025);
  line-height: 1; pointer-events: none;
  font-variant-numeric: tabular-nums;
}

/* Clip RPE velocity strip — thin gradient at top showing intensity */
.clip-velocity {
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px; z-index: 1; pointer-events: none;
  border-radius: 3px 3px 0 0;
}

/* Timeline crosshair cursor */
.track-content { cursor: crosshair; }
.track-content .clip { cursor: move; }

/* Minimap playhead — thin line with glow during playback */
.minimap-playhead {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: rgba(255,255,255,0.5);
  z-index: 3; pointer-events: none;
  transition: box-shadow 0.2s;
}
.minimap-playhead.playing {
  background: rgba(96,165,250,0.8);
  box-shadow: 0 0 4px rgba(59,130,246,0.6), 0 0 8px rgba(59,130,246,0.3);
}

/* Fader handle active state — glow when dragging */
.fader-handle.dragging {
  background: linear-gradient(180deg, rgba(100,116,139,0.9) 0%, rgba(71,85,105,0.8) 100%);
  border-color: rgba(59,130,246,0.4);
  box-shadow: 0 0 8px rgba(59,130,246,0.3), 0 2px 8px rgba(0,0,0,0.5);
}

/* Knob dial active state */
.knob-dial.dragging {
  border-color: rgba(59,130,246,0.4);
  box-shadow: 0 0 12px rgba(59,130,246,0.2);
}

/* Track header subtle scale on hover */
.track-header {
  transition: background 0.15s;
}
.track-name {
  transition: letter-spacing 0.2s;
}
.track-header:hover .track-name {
  letter-spacing: 0.13em;
}

/* Panel resize divider — draggable border between left panel and timeline */
.panel-resize {
  width: 3px; cursor: col-resize;
  background: transparent;
  position: relative; z-index: 10;
  flex-shrink: 0;
  transition: background 0.15s;
}
.panel-resize:hover, .panel-resize.dragging {
  background: rgba(59,130,246,0.2);
}
.panel-resize::after {
  content: '';
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 1px; height: 20px;
  background: rgba(255,255,255,0.06);
  border-radius: 1px;
  opacity: 0;
  transition: opacity 0.15s;
}
.panel-resize:hover::after { opacity: 1; }

/* Clip dragging state — semi-transparent while being moved */
.clip.clip-dragging {
  opacity: 0.7;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
  z-index: 25;
}

/* Music track special styling — waveform decoration */
.track[data-track="music"] .track-content {
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(6,182,212,0.015) 19px, rgba(6,182,212,0.015) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(6,182,212,0.03) 79px, rgba(6,182,212,0.03) 80px);
}
.track[data-track="music"] .track-content::after {
  content: '';
  position: absolute; bottom: 4px; left: 104px; right: 20px;
  height: 16px;
  background: repeating-linear-gradient(90deg,
    rgba(6,182,212,0.04) 0px, rgba(6,182,212,0.02) 2px,
    transparent 2px, transparent 6px
  );
  mask-image: linear-gradient(90deg, transparent, rgba(0,0,0,0.4) 5%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.4) 95%, transparent);
  -webkit-mask-image: linear-gradient(90deg, transparent, rgba(0,0,0,0.4) 5%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.4) 95%, transparent);
  pointer-events: none; opacity: 0.5;
}

/* Clip shimmer — animated gradient sweep on playing clips */
@keyframes clipShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}
.clip.clip-playing::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
  animation: clipShimmer 2s ease-in-out infinite;
  pointer-events: none; z-index: 1;
}

/* Track resize handle — drag between tracks */
.track-resize-handle {
  height: 3px; cursor: ns-resize;
  background: transparent;
  position: relative; z-index: 5;
  transition: background 0.15s;
}
.track-resize-handle:hover {
  background: rgba(59,130,246,0.15);
}
.track-resize-handle::after {
  content: '';
  position: absolute; left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  width: 20px; height: 1px;
  background: rgba(255,255,255,0.08);
  border-radius: 1px;
  opacity: 0;
  transition: opacity 0.15s;
}
.track-resize-handle:hover::after { opacity: 1; }

/* Focus mode — hide panels for full-width timeline */
.panel-left, .panel-right { transition: width 0.2s, opacity 0.2s, padding 0.2s; }
.main.focus-mode .panel-left { width: 0; overflow: hidden; opacity: 0; padding: 0; border: none; }
.main.focus-mode .panel-right { width: 0; overflow: hidden; opacity: 0; padding: 0; border: none; }
.main.focus-mode { grid-template-columns: 0fr 0fr 1fr 0fr; }
.focus-indicator {
  display: none; position: fixed; top: 44px; right: 8px;
  font-size: 7px; color: var(--accent-cyan); background: rgba(6,182,212,0.1);
  border: 1px solid rgba(6,182,212,0.2); padding: 2px 8px;
  border-radius: var(--radius-sm); z-index: 60;
  text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer;
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
}
.focus-indicator.visible { display: block; }

/* ===== COMMAND PALETTE ===== */
.cmd-palette {
  display: none; position: fixed; inset: 0; z-index: 250;
  background: rgba(3, 5, 9, 0.7); align-items: flex-start;
  justify-content: center; padding-top: 20vh;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.cmd-palette.open { display: flex; }
.cmd-palette-box {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  width: 90%; max-width: 420px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
  border-radius: var(--radius-lg); overflow: hidden;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.cmd-palette-input {
  width: 100%; padding: 14px 18px;
  background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.06);
  color: var(--text); font-family: 'Sora', sans-serif;
  font-size: 13px; outline: none;
}
.cmd-palette-input::placeholder { color: var(--micro); }
.cmd-palette-results {
  max-height: 280px; overflow-y: auto;
  padding: 4px 0;
}
.cmd-result {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 16px; cursor: pointer;
  transition: background 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.cmd-result:hover, .cmd-result.active {
  background: rgba(59, 130, 246, 0.06);
}
.cmd-result-icon {
  width: 20px; text-align: center;
  font-size: 10px; color: var(--muted);
}
.cmd-result-text {
  font-size: 11px; color: var(--text);
}
.cmd-result-key {
  margin-left: auto; font-size: 8px;
  color: var(--micro); letter-spacing: 0.08em;
}

/* ===== TOAST — Notification ===== */
.toast {
  position: fixed; bottom: 36px; right: 16px;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.06);
  border-left: 2px solid var(--blue);
  color: var(--text-secondary); padding: 8px 14px;
  font-size: 10px; z-index: 200;
  text-transform: uppercase; letter-spacing: 0.08em;
  opacity: 0; transform: translateY(8px);
  transition: opacity 0.2s, transform 0.2s;
  pointer-events: none; font-family: 'Sora', sans-serif;
  box-shadow: var(--shadow-deep);
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.toast.show { opacity: 1; transform: translateY(0); }
@media(prefers-reduced-motion:reduce) {
  .music-now-playing .eq span { animation: none; height: 6px; }
  .preset-card:hover { transform: none; }
  .clip { animation: none; transition: opacity 0.15s; }
  .clip:hover, .clip.clip-dragging { transform: none; filter: none; }
  .clip.clip-playing::before { animation: none; }
  .bpm-pulse { animation: none; opacity: 0.5; }
  .track-btn.armed { animation: none; }
  @keyframes emptyPulse { 0%, 100% { opacity: 0.1; } }
  @keyframes panelFadeIn { from, to { opacity: 1; transform: none; } }
  .snap-line { animation: none; }
  .bpm-input.flash { animation: none; }
  .toast { transition: none; }
  .playhead { transition: none; }
  .cmd-palette { backdrop-filter: none; }
  .saved-modal { backdrop-filter: none; }
  .shortcuts-overlay { backdrop-filter: none; }
}

/* ===== TABLET (768px) ===== */
@media(max-width:768px) {
  .app { grid-template-rows: 36px 1fr 22px; }
  .main { grid-template-columns: 160px 3px 1fr 220px; }
  .header { padding: 0 10px; }
  .logo-text { font-size: 10px; }
  .nav-btn { padding: 4px 8px; font-size: 8px; }
  .nav-sep { display: none; }
  .transport { padding: 4px 10px; height: 40px; }
  .time-display { font-size: 16px; min-width: 100px; }
  .bpm-input { width: 44px; font-size: 12px; }
  .fader-track { height: 60px; }
  .knob-dial { width: 28px; height: 28px; }
  .knob-indicator { height: 7px; }
  .preset-card { min-width: 130px; padding: 8px; }
}

/* ===== MOBILE (480px) ===== */
@media(max-width:480px) {
  .app { grid-template-rows: 36px 1fr 20px; }
  .main { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .panel-resize { display: none; }
  .panel-left { max-height: 180px; border-right: none; border-bottom: 1px solid var(--border); }
  .panel-right { border-left: none; border-top: 1px solid var(--border); max-height: 240px; }
  .header { padding: 0 8px; }
  .header-nav { gap: 0; overflow-x: auto; }
  .nav-btn { padding: 4px 6px; font-size: 7px; min-height: 32px; white-space: nowrap; }
  .nav-sep { display: none; }
  .logo-text { font-size: 9px; }
  .logo-sub { display: none; }
  .transport { height: auto; padding: 4px 8px; flex-wrap: wrap; }
  .transport-btn { width: 34px; height: 34px; font-size: 13px; min-height: 40px; }
  .music-btn { width: 32px; height: 32px; min-height: 40px; }
  .track-header { width: 70px; padding: 4px 6px; }
  .track-name { font-size: 8px; padding-left: 4px; }
  .track-info { display: none; }
  .fader-group { gap: 6px; }
  .fader-track { height: 50px; }
  .preset-card { min-width: 120px; padding: 8px; }
  .presets-drawer { padding: 8px 10px; }
  .shortcuts-panel { width: 280px; }
}

/* ===== SAVED WORKOUTS MODAL ===== */
.saved-modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(3, 5, 9, 0.7); align-items: center; justify-content: center;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.saved-modal.open { display: flex; }
.saved-modal-content {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.saved-modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 14px; border-bottom: 1px solid var(--border);
}
.saved-modal-header h3 {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--text-secondary);
}
.saved-modal-close {
  background: transparent; border: 1px solid transparent;
  color: var(--micro); cursor: pointer; font-size: 14px;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.saved-modal-close:hover { color: var(--text); }
.saved-item {
  padding: 10px 14px; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: background 0.15s;
}
.saved-item:hover {
  background: var(--glass);
}
.saved-item-name { font-size: 11px; font-weight: 600; }
.saved-item-info {
  font-size: 8px; color: var(--micro); margin-top: 3px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.saved-item-delete {
  float: right; font-size: 8px; color: var(--micro);
  cursor: pointer; padding: 2px 6px;
  border: none; background: none;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.1s;
}
.saved-item-delete:hover { color: var(--accent-red); }
.saved-empty {
  text-align: center; padding: 28px; color: var(--micro);
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== PRESETS DRAWER ===== */
.presets-drawer {
  display: none; position: absolute; top: 40px; left: 0; right: 0;
  background: rgba(10,14,26,0.95);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7);
  z-index: 50; padding: 12px 16px;
  opacity: 0; transform: translateY(-8px);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.presets-drawer.open {
  display: flex; gap: 8px; flex-wrap: wrap;
  opacity: 1; transform: translateY(0);
  animation: drawerSlide 0.15s ease-out;
}
@keyframes drawerSlide {
  0% { opacity: 0; transform: translateY(-8px); }
  100% { opacity: 1; transform: translateY(0); }
}
.preset-card {
  flex: 1; min-width: 140px; max-width: 200px;
  padding: 10px 12px;
  background: transparent; border: none;
  border-left: 1px solid rgba(255,255,255,0.04);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
  border-radius: 0;
}
.preset-card:first-child { border-left: none; }
.preset-card:hover {
  border-left-color: rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.02);
}
.preset-card .pc-name {
  font-size: 11px; font-weight: 600; margin-bottom: 2px;
}
.preset-card .pc-bpm {
  font-size: 9px; color: var(--accent-orange);
  font-variant-numeric: tabular-nums;
}
.preset-card .pc-desc {
  font-size: 8px; color: var(--micro); margin-top: 4px;
  line-height: 1.4;
}
.preset-card .pc-mode {
  font-size: 7px; padding: 0;
  display: inline-block; margin-top: 6px;
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* ===== WORKOUT SUMMARY PANEL — Craft/Endel minimalism ===== */
.summary-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(2,4,8,0.85);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  overflow-y: auto; overflow-x: hidden;
  animation: summaryIn 0.2s ease-out;
}
.summary-overlay.open { display: block; }
@keyframes summaryIn {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
.summary-inner {
  max-width: 600px; margin: 0 auto;
  padding: 48px 32px 80px;
}
.summary-close {
  position: fixed; top: 16px; right: 20px;
  font-size: 9px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.15em;
  cursor: pointer; padding: 8px 16px;
  transition: color 0.15s;
  z-index: 301;
}
.summary-close:hover { color: var(--text); }
.summary-header {
  margin-bottom: 40px;
}
.summary-title {
  font-size: 22px; font-weight: 300; letter-spacing: 0.06em;
  color: var(--text); margin-bottom: 4px;
}
.summary-subtitle {
  font-size: 9px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.summary-meta {
  display: flex; gap: 24px; margin-top: 20px;
  font-size: 10px; color: var(--muted);
  letter-spacing: 0.04em;
}
.summary-meta-val {
  font-weight: 600; color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}
.summary-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
  margin: 32px 0;
}
.summary-group-label {
  font-size: 8px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.2em;
  margin-bottom: 20px;
}
.summary-exercise {
  display: flex; gap: 16px; align-items: flex-start;
  padding: 16px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.summary-exercise:last-child { border-bottom: none; }
.summary-ex-index {
  font-size: 11px; font-weight: 300;
  color: var(--micro); min-width: 28px;
  font-variant-numeric: tabular-nums;
  padding-top: 1px; letter-spacing: 0.04em;
}
.summary-ex-body { flex: 1; }
.summary-ex-name {
  font-size: 14px; font-weight: 500;
  color: var(--text); letter-spacing: 0.02em;
  margin-bottom: 8px; line-height: 1.2;
}
.summary-ex-params {
  display: flex; flex-wrap: wrap; gap: 16px;
  font-size: 11px; color: var(--muted);
  letter-spacing: 0.02em;
}
.summary-ex-param {
  display: flex; align-items: baseline; gap: 4px;
}
.summary-param-val {
  font-weight: 500; font-variant-numeric: tabular-nums;
}
.summary-param-label {
  font-size: 8px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.08em;
}
.summary-ex-prog {
  margin-top: 10px;
  font-size: 8px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.15em;
  cursor: pointer; transition: color 0.15s;
  user-select: none;
}
.summary-ex-prog:hover { color: var(--muted); }
.summary-prog-chain {
  display: none; margin-top: 12px; padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.03);
}
.summary-prog-chain.open { display: block; }
.summary-prog-stage {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.15em;
  margin-bottom: 6px; margin-top: 10px;
}
.summary-prog-stage:first-child { margin-top: 0; }
.summary-prog-item {
  font-size: 11px; color: var(--muted);
  padding: 3px 0; display: flex; align-items: center; gap: 8px;
}
.summary-prog-item.current {
  color: var(--text); font-weight: 500;
}
.summary-prog-item .prog-disc {
  font-size: 8px; color: var(--micro);
  font-weight: 300;
}
.summary-footer {
  text-align: center; margin-top: 48px;
  font-size: 8px; color: rgba(255,255,255,0.15);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.summary-stats {
  display: flex; gap: 32px; justify-content: center;
  margin-top: 24px;
}
.summary-stat {
  text-align: center;
}
.summary-stat-val {
  font-size: 28px; font-weight: 200;
  background: linear-gradient(135deg, #06b6d4, #3b82f6, #8b5cf6);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; font-variant-numeric: tabular-nums;
  line-height: 1;
}
.summary-stat-label {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.2em;
  margin-top: 4px;
}
@media (max-width: 600px) {
  .summary-inner { padding: 32px 20px 60px; }
  .summary-title { font-size: 18px; }
  .summary-ex-params { gap: 12px; }
  .summary-stats { gap: 20px; }
  .summary-stat-val { font-size: 22px; }
}

/* ===== CONTEXT MENU — Endel/Craft Right-Click ===== */
.clip-context-menu {
  position: fixed; z-index: 250;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  box-shadow: var(--shadow-deep);
  min-width: 160px;
  border-radius: var(--radius-md);
  padding: 4px 0;
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.clip-context-menu.open { display: block; }
.ctx-item {
  padding: 6px 14px; font-size: 10px;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s, color 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.ctx-item:hover { background: rgba(255,255,255,0.03); color: var(--text); }
.ctx-item .ctx-key {
  font-size: 8px; color: var(--micro);
  margin-left: 16px;
}
.ctx-sep { height: 1px; background: rgba(255,255,255,0.04); margin: 3px 4px; }
.ctx-color-swatch {
  width: 10px; height: 10px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.15);
  cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
  display: inline-block;
}
.ctx-color-swatch:hover { transform: scale(1.3); box-shadow: 0 0 6px rgba(255,255,255,0.2); }
.ctx-color-swatch[data-color=""] { background: transparent; }
.ctx-item.danger:hover { background: rgba(239,68,68,0.08); color: var(--accent-red); }

/* ===== PLAYHEAD GLOW ANIMATION ===== */
@keyframes playheadPulse {
  0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.4); }
  50% { box-shadow: 0 0 14px rgba(255,255,255,0.6); }
}
.playhead.playing {
  animation: playheadPulse 1s ease-in-out infinite;
}

/* ===== RECORDING PULSE ===== */
@keyframes recPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.transport-btn.rec.active {
  animation: recPulse 1s ease-in-out infinite;
}

/* ===== SHORTCUTS OVERLAY — Endel/Craft Style ===== */
.shortcuts-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(3,5,9,0.6);
  align-items: center; justify-content: center;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.shortcuts-overlay.open { display: flex; }
.shortcuts-panel {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  padding: 18px 22px; width: 320px;
  border-radius: var(--radius-lg);
  box-shadow: 0 25px 80px rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.shortcuts-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 14px;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-secondary);
}
.shortcuts-grid { display: flex; flex-direction: column; gap: 6px; }
.shortcut-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 0;
}
.shortcut-item kbd {
  font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  background: rgba(3,5,9,0.5); border: 1px solid rgba(255,255,255,0.08);
  padding: 3px 8px; color: var(--text);
  border-radius: var(--radius-sm);
  min-width: 28px; text-align: center;
}
.shortcut-item span {
  font-size: 10px; color: var(--muted);
}

/* ===== MARKERS ===== */
.marker {
  position: absolute; z-index: 15;
  top: 0; cursor: pointer;
}
.marker-flag {
  width: auto; min-width: 8px; height: 14px;
  background: var(--accent-orange);
  padding: 0 4px;
  font-size: 7px; font-weight: 600;
  color: var(--bg); display: flex; align-items: center;
  white-space: nowrap; border-radius: 0 2px 2px 0;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.marker-line {
  width: 1px; height: 100%;
  background: var(--accent-orange); opacity: 0.3;
  position: absolute; top: 14px; left: 0;
}
.marker:hover .marker-flag { filter: brightness(1.2); }

/* ===== LOOP REGION ===== */
.loop-region {
  position: absolute; top: 0; bottom: 0;
  background: rgba(59, 130, 246, 0.06);
  border-left: 1px solid rgba(59, 130, 246, 0.4);
  border-right: 1px solid rgba(59, 130, 246, 0.4);
  z-index: 5; pointer-events: none;
  display: none;
}
.loop-region.active { display: block; pointer-events: auto; }
.loop-region .loop-handle {
  position: absolute; top: 0; bottom: 0; width: 6px;
  cursor: ew-resize; z-index: 6;
}
.loop-handle-left { left: -3px; }
.loop-handle-right { right: -3px; }
.loop-handle::after {
  content: '';
  position: absolute; top: 0; left: 50%; transform: translateX(-50%);
  width: 6px; height: 8px;
  background: rgba(59, 130, 246, 0.6);
  border-radius: 0 0 2px 2px;
  transition: background 0.15s;
}
.loop-handle:hover::after { background: rgba(59, 130, 246, 0.9); }
.loop-region .loop-body {
  position: absolute; top: 0; bottom: 0; left: 6px; right: 6px;
  cursor: grab;
}
.loop-region .loop-body:active { cursor: grabbing; }

/* ===== INLINE PROMPT — Craft-style modal input ===== */
.inline-prompt {
  display: none; position: fixed; inset: 0; z-index: 350;
  background: rgba(2,4,8,0.7);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  align-items: flex-start; justify-content: center;
  padding-top: 28vh;
}
.inline-prompt.open { display: flex; }
.inline-prompt-box {
  background: rgba(10,14,26,0.95);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-md);
  padding: 16px 20px;
  width: 280px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
.inline-prompt-label {
  font-size: 9px; color: var(--micro); text-transform: uppercase;
  letter-spacing: 0.1em; margin-bottom: 8px;
}
.inline-prompt-input {
  width: 100%; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-sm); padding: 8px 10px;
  color: var(--text); font-family: 'Sora', sans-serif;
  font-size: 13px; font-weight: 500; outline: none;
}
.inline-prompt-input:focus { border-color: rgba(59,130,246,0.4); }
.inline-prompt-actions {
  display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px;
}
.inline-prompt-actions button {
  font-family: 'Sora', sans-serif; font-size: 9px;
  padding: 4px 12px; border: none; border-radius: var(--radius-sm);
  cursor: pointer; text-transform: uppercase; letter-spacing: 0.06em;
}
.inline-prompt-cancel {
  background: transparent; color: var(--muted);
}
.inline-prompt-cancel:hover { color: var(--text); }
.inline-prompt-ok {
  background: rgba(59,130,246,0.15); color: var(--accent-blue);
}
.inline-prompt-ok:hover { background: rgba(59,130,246,0.25); }

/* ===== TOOLTIP — Craft-style hover tip ===== */
[data-tip] { position: relative; }
[data-tip]::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%) translateY(4px);
  background: rgba(13,17,23,0.95);
  color: var(--text-secondary);
  font-size: 9px; font-weight: 400;
  padding: 4px 8px;
  white-space: nowrap;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  opacity: 0; pointer-events: none;
  transition: opacity 0.15s, transform 0.15s;
  z-index: 400;
  letter-spacing: 0.02em;
  font-family: 'Sora', sans-serif;
}
[data-tip]:hover::after {
  opacity: 1; transform: translateX(-50%) translateY(0);
}
@media(prefers-reduced-motion:reduce) {
  [data-tip]::after { transition: none; }
}

/* ===== SCROLLBAR — Craft Style (barely visible) ===== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.06);
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.12); }
::-webkit-scrollbar-corner { background: transparent; }
.timeline-container::-webkit-scrollbar { height: 6px; }
.timeline-container::-webkit-scrollbar-track { background: transparent; }
.timeline-container::-webkit-scrollbar-thumb {
  background: rgba(6,182,212,0.12);
  border-radius: 3px;
}
.timeline-container::-webkit-scrollbar-thumb:hover {
  background: rgba(6,182,212,0.25);
}
.panel-left::-webkit-scrollbar-track { background: var(--surface); }
.panel-right::-webkit-scrollbar-track { background: var(--surface); }

/* ===== FOCUS / SELECTION ===== */
a:focus-visible, button:focus-visible, input:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.6);
  outline-offset: 2px;
}
::selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
::-moz-selection { background: rgba(59, 130, 246, 0.3); color: #fff; }

/* ===== MOBILE RESPONSIVE — DAW ADAPTED FOR TOUCH ===== */

/* Mobile drawer overlay */
.mobile-overlay {
  display: none; position: fixed; inset: 0; z-index: 89;
  background: rgba(3,5,9,0.6);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  opacity: 0; transition: opacity 0.25s;
}
.mobile-overlay.visible { opacity: 1; }

/* Mobile nav toggle button */
.mobile-nav-toggle {
  display: none; background: none; border: none;
  color: var(--text-secondary); cursor: pointer;
  width: 32px; height: 32px;
  align-items: center; justify-content: center;
  font-size: 16px; padding: 0;
}

/* Mobile panel toggles (fixed bottom bar) */
.mobile-panel-bar {
  display: none; position: fixed; bottom: 0; left: 0; right: 0;
  height: 48px; z-index: 90;
  background: rgba(10,14,26,0.95);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  align-items: center; justify-content: space-around;
  padding: 0 8px;
}
.mobile-panel-btn {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
  background: none; border: none; color: var(--micro);
  font-family: 'Sora', sans-serif; font-size: 7px;
  text-transform: uppercase; letter-spacing: 0.08em;
  cursor: pointer; padding: 4px 12px;
  transition: color 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.mobile-panel-btn .mpb-icon { font-size: 18px; line-height: 1; }
.mobile-panel-btn.active { color: var(--accent-cyan); }

/* Tablet breakpoint (768px) — shrink panels, bigger touch targets */
@media (max-width: 768px) {
  .app { grid-template-rows: 36px 1fr 22px; }
  .main { grid-template-columns: 160px 3px 1fr 220px; }
  .header { padding: 0 10px; }
  .logo-text { font-size: 10px; }
  .nav-btn { padding: 4px 8px; font-size: 8px; min-height: 36px; }
  .nav-sep { display: none; }
  .transport { padding: 4px 10px; height: 40px; }
  .time-display { font-size: 16px; min-width: 100px; }
  .bpm-input { width: 44px; font-size: 12px; }
  .fader-track { height: 60px; }
  .knob-dial { width: 28px; height: 28px; }
  .knob-indicator { height: 7px; }
  .preset-card { min-width: 130px; padding: 8px; }
  .transport-btn { min-height: 36px; }
}

/* Mobile breakpoint (640px) — drawer layout */
@media (max-width: 640px) {
  .app { grid-template-rows: 44px 1fr; }
  .footer { display: none; }
  .mobile-panel-bar { display: flex; }
  .mobile-nav-toggle { display: flex; }
  .panel-resize { display: none; }

  /* Header mobile */
  .header { height: 44px; padding: 0 8px; gap: 4px; }
  .header-nav { display: none; }
  .header-nav.mobile-open {
    display: flex; flex-direction: column;
    position: fixed; top: 44px; left: 0; right: 0;
    background: rgba(10,14,26,0.98);
    border-bottom: 1px solid var(--border);
    padding: 8px; gap: 4px; z-index: 91;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    max-height: 60vh; overflow-y: auto;
  }
  .header-nav.mobile-open .nav-btn {
    width: 100%; text-align: left; padding: 10px 12px;
    font-size: 10px; min-height: 44px;
    display: flex; align-items: center;
  }
  .header-nav.mobile-open .nav-sep { display: none; }
  .logo-text { font-size: 10px; }
  .logo-sub { display: none; }

  /* Main — single column, panels are drawers */
  .main {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
    overflow: hidden;
  }

  /* Library becomes slide-out left drawer */
  .panel-left {
    position: fixed; top: 44px; left: 0; bottom: 48px;
    width: 280px; max-width: 85vw;
    z-index: 90; border-right: 1px solid var(--border);
    transform: translateX(-100%);
    transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
    background: rgba(10,14,26,0.98);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
  .panel-left.drawer-open { transform: translateX(0); }

  /* Inspector becomes bottom sheet */
  .panel-right {
    position: fixed; left: 0; right: 0; bottom: 48px;
    max-height: 60vh; z-index: 90;
    border-top: 1px solid var(--border);
    border-left: none;
    transform: translateY(100%);
    transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
    background: rgba(10,14,26,0.98);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 12px 12px 0 0;
    overflow-y: auto;
  }
  .panel-right.drawer-open { transform: translateY(0); }
  .panel-right::before {
    content: '';
    display: block; width: 36px; height: 4px;
    background: rgba(255,255,255,0.15); border-radius: 2px;
    margin: 8px auto 4px;
    flex-shrink: 0;
  }

  /* Center panel takes full space */
  .panel-center {
    grid-column: 1; grid-row: 1;
    padding-bottom: 48px;
  }

  /* Transport — 2-row wrap for mobile */
  .transport {
    height: auto; min-height: 44px;
    padding: 6px 8px;
    flex-wrap: wrap; gap: 6px;
    justify-content: center;
  }
  .transport-btn {
    width: 38px; height: 38px;
    font-size: 14px; min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }
  .transport-sep { display: none; }
  .time-display { font-size: 18px; min-width: 90px; order: -1; }
  .bpm-section {
    display: flex; flex-wrap: wrap; gap: 4px;
    align-items: center; justify-content: center;
    width: 100%;
  }
  .bpm-input { width: 48px; font-size: 13px; height: 32px; }
  #bars-display { display: none; }
  #remaining-time { display: none; }
  #beat-indicator { display: none; }
  .locate-btn { min-height: 38px; padding: 0 10px; }
  .snap-badge { min-height: 32px; padding: 0 10px; font-size: 9px; }

  /* Zoom controls — single row */
  .bpm-section .transport-btn { width: 32px; height: 32px; min-height: 36px; }

  /* Track headers — wider for touch */
  .track-header { width: 60px; padding: 4px; min-height: 48px; }
  .track-name { font-size: 8px; padding-left: 2px; }
  .track-btns button { width: 18px; height: 18px; font-size: 7px; min-height: 22px; }
  .track-info { display: none; }
  .track-vol-bar { display: none; }

  /* Clips — larger touch targets */
  .clip { min-height: 40px; }
  .clip-name { font-size: 9px; }
  .clip-rpe-badge { font-size: 8px; }
  .clip-stage-dots { top: 4px; right: 4px; }
  .clip-stage-dot { width: 4px; height: 4px; }

  /* Presets drawer */
  .presets-drawer { padding: 8px; }
  .preset-card { min-width: 120px; padding: 10px; }

  /* Library search — bigger */
  .lib-search { font-size: 13px; padding: 10px 12px; min-height: 44px; }

  /* Movement items — bigger touch targets */
  .movement-item { padding: 8px 12px; min-height: 44px; }
  .movement-item .mv-name { font-size: 11px; }
  .movement-item .mv-stage { font-size: 8px; }
  .movement-item .mv-detail { display: none !important; }

  /* Inspector inputs — touch-friendly */
  .inspector-field input, .inspector-field select {
    font-size: 14px; min-height: 36px; padding: 6px 8px;
  }
  .inspector-field input[type="range"] { min-height: 24px; }

  /* Context menu — bigger for touch */
  .clip-context-menu { min-width: 200px; }
  .ctx-item { padding: 10px 16px; font-size: 12px; min-height: 44px; }

  /* Command palette — full width */
  .cmd-palette {
    width: 95vw !important; max-width: 95vw !important;
    left: 2.5vw !important; margin-left: 0 !important;
  }
  .cmd-input { font-size: 14px !important; min-height: 44px !important; }
  .cmd-item { min-height: 44px !important; font-size: 11px !important; }

  /* Shortcuts panel — full width */
  .shortcuts-panel { width: 95vw; left: 2.5vw; }

  /* Summary panel — mobile padding */
  .summary-inner { padding: 24px 16px 64px; }
  .summary-close { width: 44px; height: 44px; font-size: 20px; }

  /* Saved modal */
  .saved-modal-content { width: 95%; }
  .saved-item { padding: 12px 14px; min-height: 44px; }

  /* Toast — above mobile bar */
  .toast { bottom: 60px !important; }

  /* Video section */
  .video-section { max-height: 30vh; }

  /* Minimap */
  .timeline-minimap { height: 20px; }

  /* Ruler */
  .timeline-ruler { height: 22px; }

  /* Timeline scroll momentum */
  .timeline-container { -webkit-overflow-scrolling: touch; }

  /* Selection badge */
  .selection-badge { bottom: 56px; }

  /* Focus indicator */
  .focus-indicator { top: 48px; }
}

/* Small phone (380px) */
@media (max-width: 380px) {
  .transport-btn { width: 36px; height: 36px; min-height: 40px; }
  .time-display { font-size: 16px; min-width: 80px; }
  .bpm-input { width: 44px; }
  .track-header { width: 50px; }
  .track-name { font-size: 7px; }
  .panel-left { width: 260px; }
}

/* Landscape mobile hint */
.landscape-hint {
  display: none; position: fixed; inset: 0; z-index: 500;
  background: rgba(5,7,17,0.95);
  align-items: center; justify-content: center;
  flex-direction: column; gap: 12px;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.landscape-hint.visible { display: flex; }
.landscape-hint-icon {
  font-size: 48px; color: var(--accent-cyan);
  animation: rotateSuggest 2s ease-in-out infinite;
}
@keyframes rotateSuggest {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(90deg); }
}
.landscape-hint-text {
  font-size: 14px; color: var(--text-secondary);
  text-align: center; max-width: 240px; line-height: 1.5;
}
.landscape-hint-dismiss {
  font-size: 10px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.1em;
  cursor: pointer; padding: 8px 16px;
  border: 1px solid var(--border); border-radius: 4px;
  background: none; font-family: 'Sora', sans-serif;
  margin-top: 8px;
  -webkit-tap-highlight-color: transparent;
}

/* Swipe-delete indicator */
.clip-swipe-indicator {
  position: absolute; right: -60px; top: 0; bottom: 0;
  width: 60px; display: flex; align-items: center; justify-content: center;
  background: rgba(239,68,68,0.9); color: #fff;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.08em; border-radius: 0 4px 4px 0;
  opacity: 0; transition: opacity 0.15s;
  pointer-events: none;
}
.clip-swipe-indicator.visible { opacity: 1; }

/* Mobile presets as full-screen modal */
@media (max-width: 640px) {
  .presets-drawer {
    position: fixed; inset: 0; z-index: 95;
    padding: 60px 16px 64px;
    background: rgba(5,7,17,0.95);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .presets-drawer .preset-card {
    min-width: unset; width: 100%;
    padding: 14px; margin-bottom: 8px;
  }
  .presets-drawer .pc-name { font-size: 13px; }
  .presets-drawer .pc-desc { font-size: 10px; }

  /* Clip context menu — position near bottom on mobile */
  .clip-context-menu {
    position: fixed !important;
    bottom: 56px !important; left: 4px !important; right: 4px !important;
    top: auto !important; width: auto !important;
    max-height: 50vh; overflow-y: auto;
    border-radius: 12px 12px 0 0;
  }

  /* Summary mobile optimization */
  .summary-inner { padding: 20px 12px 64px; }
  .summary-title { font-size: 16px; }
  .summary-stats { gap: 16px; flex-wrap: wrap; }
  .summary-stat { min-width: 80px; }
  .summary-stat-val { font-size: 20px; }

  /* Saved modal — near-fullscreen */
  .saved-modal-content { width: 98%; max-height: 80vh; }

  /* Inline prompt modal — wider */
  .prompt-modal { width: 95vw !important; }
  .prompt-modal input { font-size: 14px !important; min-height: 44px !important; }
}

/* Landscape mobile — full width timeline */
@media (max-width: 640px) and (orientation: landscape) {
  .app { grid-template-rows: 36px 1fr; }
  .header { height: 36px; }
  .transport { min-height: 36px; padding: 4px 8px; }
  .transport-btn { width: 32px; height: 32px; min-height: 34px; }
  .mobile-panel-bar { height: 36px; }
  .mobile-panel-btn .mpb-icon { font-size: 14px; }
  .mobile-panel-btn span:last-child { display: none; }
  .panel-center { padding-bottom: 36px; }
  .panel-right { bottom: 36px; max-height: 50vh; }
  .panel-left { bottom: 36px; }
}
</style>
</head>
<body>
<!-- Loading Splash -->
<div id="splash" style="position:fixed;inset:0;z-index:9999;background:#050711;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;transition:opacity 0.4s">
  <img src="assets/planet-logo.png" alt="" style="width:48px;height:48px;opacity:0.8" onerror="this.style.display='none'">
  <div style="font-family:Sora,sans-serif;font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.5)">Saturno Movement Studio</div>
  <div style="width:120px;height:2px;background:rgba(255,255,255,0.06);border-radius:1px;overflow:hidden"><div id="splash-bar" style="width:0%;height:100%;background:linear-gradient(90deg,#3b82f6,#06b6d4);transition:width 0.8s ease"></div></div>
</div>
<script>
setTimeout(function(){var b=document.getElementById('splash-bar');if(b)b.style.width='100%'},50);
setTimeout(function(){var s=document.getElementById('splash');if(s){s.style.opacity='0';setTimeout(function(){s.remove()},400)}},1200);
</script>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-progress" id="header-progress"></div>
    <div class="logo">
      <div class="logo-icon"><img src="assets/planet-logo.png" alt="" onerror="this.style.display='none'"></div>
      <div>
        <div class="logo-text">SATURNO MOVEMENT STUDIO</div>
        <div class="logo-sub">The Ableton of Movement</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:4px;margin-left:8px">
      <span style="font-size:8px;color:var(--micro)">/</span>
      <span id="header-workout-name" style="font-size:9px;color:var(--text-secondary);font-weight:500;letter-spacing:0.03em;cursor:pointer;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" onclick="renameWorkout()" data-tip="Click to rename">Untitled</span>
    </div>
    <button class="mobile-nav-toggle" id="mobile-nav-toggle" onclick="toggleMobileNav()" data-tip="Menu">&#9776;</button>
    <nav class="header-nav" id="header-nav">
      <button class="nav-btn" id="btn-presets" onclick="togglePresets()">PRESETS</button>
      <button class="nav-btn" onclick="clearTimeline()">CLEAR</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="saveNamedWorkout()">SAVE</button>
      <button class="nav-btn" onclick="showSavedWorkouts()">LOAD</button>
      <button class="nav-btn" onclick="exportWorkout()">EXPORT</button>
      <button class="nav-btn" onclick="showSummary()">SUMMARY</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" id="btn-snap" onclick="toggleSnap()">SNAP</button>
      <button class="nav-btn" id="btn-video" onclick="toggleVideo()">VID</button>
      <button class="nav-btn" onclick="toggleMusic()">MUS</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="undo()" data-tip="Undo (Cmd+Z)" style="font-size:11px">&#8617;</button>
      <button class="nav-btn" onclick="redo()" data-tip="Redo (Cmd+Shift+Z)" style="font-size:11px">&#8618;</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="toggleShortcuts()" data-tip="Shortcuts (?)" style="font-size:10px;font-weight:700">?</button>
    </nav>
  </header>

  <!-- PRESETS DRAWER -->
  <div class="presets-drawer" id="presets-drawer">
    <div class="preset-card" onclick="loadPreset('monk')">
      <div class="pc-name">Monk Mode</div>
      <div class="pc-bpm">65 BPM</div>
      <div class="pc-desc">Meditative, slow, precise. Breath-led reps.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('beast')">
      <div class="pc-name">Beast Mode</div>
      <div class="pc-bpm">140 BPM</div>
      <div class="pc-desc">High intensity, explosive power.</div>
      <div class="pc-mode" style="background:rgba(239,68,68,0.2);color:#ef4444">Flow / Conditioning</div>
    </div>
    <div class="preset-card" onclick="loadPreset('flow')">
      <div class="pc-name">Flow Ritual</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Continuous movement, fluid transitions.</div>
      <div class="pc-mode" style="background:rgba(139,92,246,0.2);color:#8b5cf6">Standard Tempo</div>
    </div>
    <div class="preset-card" onclick="loadPreset('skill')">
      <div class="pc-name">Skill Ascension</div>
      <div class="pc-bpm">75 BPM</div>
      <div class="pc-desc">Technical practice, isometric holds.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('upper')">
      <div class="pc-name">Upper Day</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Push/Pull balanced upper body split.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('lower')">
      <div class="pc-name">Lower Day</div>
      <div class="pc-bpm">90 BPM</div>
      <div class="pc-desc">Squat patterns, hip hinges, mobility.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('ppl')">
      <div class="pc-name">Push / Pull / Legs</div>
      <div class="pc-bpm">110 BPM</div>
      <div class="pc-desc">Classic 3-way split, all patterns hit.</div>
      <div class="pc-mode" style="background:rgba(249,115,22,0.2);color:#f97316">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('fullbody')">
      <div class="pc-name">Full Body</div>
      <div class="pc-bpm">105 BPM</div>
      <div class="pc-desc">One compound per pattern, total coverage.</div>
      <div class="pc-mode" style="background:rgba(236,72,153,0.2);color:#ec4899">Standard</div>
    </div>
    <div class="preset-card" onclick="generateRandom()" style="border:1px dashed var(--border)">
      <div class="pc-name" style="color:var(--accent-cyan)">Random</div>
      <div class="pc-bpm" style="color:var(--accent-cyan)">? BPM</div>
      <div class="pc-desc">Auto-generate a random balanced workout.</div>
      <div class="pc-mode" style="background:rgba(6,182,212,0.2);color:#06b6d4">Surprise</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Movement Library -->
    <aside class="panel-left">
      <div class="panel-header"><span>Movement Library</span><span id="lib-count">0</span></div>
      <input type="text" class="lib-search" id="lib-search" placeholder="Search movements... (Enter to add)" oninput="filterLibrary()" onkeydown="if(event.key==='Enter')addFirstMatch()">
      <div style="display:flex;gap:3px;padding:4px 10px;align-items:center">
        <span style="font-size:7px;color:var(--micro);text-transform:uppercase;letter-spacing:0.1em;margin-right:2px">Stage</span>
        <button class="lib-stage-btn active" data-stage="all" onclick="filterByStage('all')" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.06);color:var(--text-secondary);font-family:Sora,sans-serif" data-tip="Show all stages">All</button>
        <button class="lib-stage-btn" data-stage="1" onclick="filterByStage(1)" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif" data-tip="Beginner exercises">S1</button>
        <button class="lib-stage-btn" data-stage="2" onclick="filterByStage(2)" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif" data-tip="Intermediate exercises">S2</button>
        <button class="lib-stage-btn" data-stage="3" onclick="filterByStage(3)" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif" data-tip="Advanced exercises">S3</button>
        <select id="lib-disc-filter" onchange="filterByDiscipline(this.value)" style="font-size:7px;padding:1px 4px;border:1px solid rgba(255,255,255,0.06);border-radius:2px;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif;cursor:pointer;margin-left:auto" data-tip="Filter by discipline">
          <option value="all">All Disc.</option>
          <option value="Calisthenics">Calisthenics</option>
          <option value="Power-Free">Power-Free</option>
          <option value="Bodybuilding">Bodybuilding</option>
          <option value="Street Lifting">Street Lift.</option>
          <option value="Hand-Balancing">Hand-Bal.</option>
          <option value="Freestyle">Freestyle</option>
          <option value="Mobility">Mobility</option>
        </select>
      </div>
      <div class="movement-category" style="display:none">
        <div class="category-header" style="font-size:8px;color:var(--accent-cyan);padding:5px 12px"><span>Recent</span></div>
        <div class="movement-list" id="recent-exercises"></div>
      </div>
      <div id="library-container"></div>
    </aside>

    <!-- Panel resize divider -->
    <div class="panel-resize" id="panel-resize-left"></div>

    <!-- CENTER: Transport + Video + Timeline -->
    <section class="panel-center">
      <!-- Transport -->
      <div class="transport">
        <div class="transport-buttons">
          <button class="transport-btn" onclick="rewind()" data-tip="Rewind 15s">&#9198;</button>
          <button class="transport-btn" id="play-btn" onclick="togglePlay()" data-tip="Play / Pause (Space)">&#9654;</button>
          <button class="transport-btn" onclick="stopPlayback()" data-tip="Stop">&#9632;</button>
          <button class="transport-btn" onclick="forward()" data-tip="Forward 15s">&#9197;</button>
          <button class="transport-btn rec" id="rec-btn" onclick="toggleRec()" data-tip="Record (R)" style="border-radius:0 3px 3px 0">&#9679;</button>
        </div>
        <span id="playback-state" class="transport-state state-stop">STOP</span>
        <span class="snap-badge" id="snap-badge" onclick="toggleSnap()" data-tip="Snap to grid (S)">SNAP</span>
        <div class="transport-sep"></div>
        <div class="transport-buttons">
          <button class="transport-btn" id="metro-btn" onclick="toggleMetronome()" data-tip="Metronome" style="font-size:8px;letter-spacing:0.04em;border-radius:3px 0 0 3px;width:auto;padding:0 8px">MET</button>
          <button class="transport-btn" id="loop-btn" onclick="toggleLoop()" data-tip="Loop (L)" style="font-size:8px;letter-spacing:0.04em;border-radius:0 3px 3px 0;width:auto;padding:0 8px;border-left:none">LOOP</button>
        </div>
        <button class="locate-btn" onclick="scrollToPlayhead()" data-tip="Scroll to playhead">LOC</button>
        <div class="time-display" id="time-display">
          <span class="td-seg" id="td-min">00</span><span class="td-colon">:</span><span class="td-seg" id="td-sec">00</span><span class="td-colon">:</span><span class="td-seg td-ms" id="td-ms">00</span>
        </div>
        <div id="bars-display" style="font-size:10px;font-weight:600;color:var(--muted);padding:0 6px;font-variant-numeric:tabular-nums;min-width:50px;text-align:center">1.1.1</div>
        <div id="remaining-time" style="font-size:8px;color:var(--micro);font-variant-numeric:tabular-nums;min-width:30px;opacity:0" data-tip="Time remaining"></div>
        <div id="beat-indicator" style="display:flex;gap:2px;padding:0 4px" data-tip="Beat position">
          <div class="beat-dot" id="beat-1" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-2" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-3" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-4" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
        </div>
        <div class="bpm-section">
          <span class="bpm-label">BPM</span>
          <div class="bpm-pulse" id="bpm-pulse" data-tip="Tempo pulse"></div>
          <input type="number" class="bpm-input" id="bpm-input" value="120" min="40" max="200" onchange="updateBPM()">
          <span class="bpm-mode" id="bpm-mode">Standard</span>
          <span class="tempo-link" id="tempo-link" onclick="toggleTempoLink()" data-tip="Link BPM to tempo">LINK</span>
          <span class="tempo-link" id="tap-tempo" onclick="tapTempo()" data-tip="Tap tempo (T)">TAP</span>
          <span id="time-sig" style="font-size:8px;font-weight:700;color:var(--micro);padding:0 4px;letter-spacing:0.04em;cursor:pointer;font-variant-numeric:tabular-nums" onclick="cycleTimeSig()" data-tip="Time signature">4/4</span>
          <div class="transport-sep"></div>
          <span class="bpm-label">Zoom</span>
          <button class="transport-btn" onclick="zoomOut()" data-tip="Zoom out (Cmd+-)" style="width:22px;height:22px;font-size:10px;border-radius:2px">-</button>
          <span id="zoom-level" style="font-size:8px;color:var(--muted);min-width:28px;text-align:center">100%</span>
          <button class="transport-btn" onclick="zoomIn()" data-tip="Zoom in (Cmd+=)" style="width:22px;height:22px;font-size:10px;border-radius:2px">+</button>
          <button class="transport-btn" onclick="zoomToFit()" data-tip="Zoom to fit" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em">FIT</button>
          <div class="transport-sep"></div>
          <button class="transport-btn" id="auto-scroll-btn" onclick="toggleAutoScrollFromTransport()" data-tip="Auto-scroll" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em">FOLLOW</button>
          <div class="transport-sep"></div>
          <button class="transport-btn" id="speed-btn" onclick="cyclePlaybackSpeed()" data-tip="Playback speed" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em;font-variant-numeric:tabular-nums">1.0x</button>
        </div>
      </div>

      <!-- Video (collapsible) -->
      <div class="video-section" id="video-section">
        <div class="video-placeholder" id="video-placeholder">
          <div class="vp-icon">&#9654;</div>
          <span>Drop video here or click to load</span>
          <span style="font-size:9px;opacity:0.5">Landscape video plays in sync with timeline</span>
        </div>
        <video id="studio-video" style="width:100%;height:100%;object-fit:contain;display:none" controls></video>
        <button class="video-toggle" onclick="toggleVideo()" data-tip="Toggle video">&#9660;</button>
      </div>

      <!-- Timeline -->
      <div class="timeline-container" id="timeline-container">
        <div class="timeline-ruler" id="timeline-ruler"></div>
        <div class="timeline-minimap" id="timeline-minimap"><div class="minimap-viewport" id="minimap-viewport"></div></div>
        <div class="timeline-tracks" id="timeline-tracks">
          <div class="loop-region" id="loop-region"><div class="loop-handle loop-handle-left" data-side="left"></div><div class="loop-body"></div><div class="loop-handle loop-handle-right" data-side="right"></div></div>
          <div class="playhead" id="playhead"></div>
          <div class="timeline-empty" id="timeline-empty">
            <div class="timeline-empty-icon">&#9835;</div>
            <div class="timeline-empty-title">Compose Your Movement</div>
            <div class="timeline-empty-desc">Drag exercises from the library onto any track to begin building your workout.</div>
            <div class="timeline-empty-steps">
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">1</div><div class="timeline-empty-step-text">Browse the library</div></div>
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">2</div><div class="timeline-empty-step-text">Drag to track or double-click</div></div>
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">3</div><div class="timeline-empty-step-text">Press space to play</div></div>
            </div>
            <div style="margin-top:12px;display:flex;gap:12px;justify-content:center;opacity:0.4">
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">P</kbd> Presets</span>
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">G</kbd> Random</span>
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">Cmd+K</kbd> Commands</span>
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">?</kbd> Shortcuts</span>
            </div>
          </div>
          <div class="snap-indicator" id="snap-indicator"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Mixer + Inspector + Music -->
    <aside class="panel-right">
      <div class="panel-tabs">
        <button class="panel-tab active" data-tab="mixer" onclick="switchPanelTab('mixer')">Mixer</button>
        <button class="panel-tab" data-tab="inspector-tab" onclick="switchPanelTab('inspector-tab')">Inspector</button>
        <button class="panel-tab" data-tab="settings" onclick="switchPanelTab('settings')">Settings</button>
      </div>

      <!-- MIXER TAB -->
      <div class="panel-tab-content active" id="tab-mixer">
        <!-- Meter -->
        <div class="mixer-section">
          <div class="mixer-title">Output</div>
          <button class="mixer-collapse" onclick="toggleMixerSection(this)" data-tip="Collapse section">&#9660;</button>
          <div class="mixer-section-body" style="max-height:200px">
            <div class="meter-group" id="meters"></div>
            <div class="channel-meters" id="channel-meters" style="margin-top:6px"></div>
          </div>
        </div>
        <div class="panel-divider"></div>

        <!-- Faders -->
        <div class="mixer-section">
          <div class="mixer-title">Master Faders</div>
          <button class="mixer-collapse" onclick="toggleMixerSection(this)" data-tip="Collapse section">&#9660;</button>
          <div class="mixer-section-body" style="max-height:200px">
            <div class="fader-group" id="fader-group"></div>
          </div>
        </div>
        <div class="panel-divider"></div>

        <!-- Knobs -->
        <div class="mixer-section">
          <div class="mixer-title">Blend Controls</div>
          <button class="mixer-collapse" onclick="toggleMixerSection(this)" data-tip="Collapse section">&#9660;</button>
          <div class="mixer-section-body" style="max-height:200px">
            <div class="knob-group" id="knob-group"></div>
          </div>
        </div>
      </div>

      <!-- INSPECTOR TAB -->
      <div class="panel-tab-content" id="tab-inspector-tab">
      <!-- Inspector -->
      <div class="inspector-section" id="inspector" style="display:none">
        <div class="inspector-title">Exercise DNA</div>
        <div class="inspector-field"><label>Movement</label><div class="value" id="insp-name" style="cursor:pointer" onclick="searchLibraryForInspected()" data-tip="Click to find in library">-</div></div>
        <div class="inspector-field"><label>Pattern</label><div class="value" id="insp-pattern">-</div></div>
        <div class="inspector-field"><label>Stage</label><div class="value" id="insp-stage">-</div></div>
        <div class="inspector-field"><label>Discipline</label><div class="value" id="insp-discipline">-</div></div>
        <div class="inspector-field">
          <label>Sets x Reps</label>
          <div style="display:flex;gap:4px">
            <input type="number" id="insp-sets" value="3" min="1" max="10" style="width:40px" onchange="updateClipDNA()">
            <span style="color:var(--micro);font-size:11px">x</span>
            <input type="number" id="insp-reps" value="8" min="1" max="50" style="width:40px" onchange="updateClipDNA()">
          </div>
        </div>
        <div class="inspector-field"><label>Tempo (seconds per rep)</label><input type="number" id="insp-tempo" value="3" min="1" max="20" step="0.5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>Rest (seconds)</label><input type="number" id="insp-rest" value="60" min="0" max="300" step="5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>RPE <span id="insp-rpe-val" style="font-weight:500">7</span></label><input type="range" id="insp-rpe" min="1" max="10" value="7" style="width:100%" oninput="updateClipDNA();updateRpeColor()"></div>
        <div class="inspector-tags" id="insp-tags"></div>
        <div id="insp-progression" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);display:none"></div>
        <div id="insp-time" style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border);font-size:8px;color:var(--muted);display:flex;justify-content:space-between">
          <span>Est. time: <span id="insp-est-time" style="color:var(--text-secondary)">-</span></span>
          <span>TUT: <span id="insp-tut" style="color:var(--accent-cyan)">-</span></span>
        </div>
        <div class="inspector-field" style="margin-top:8px">
          <label>Notes</label>
          <textarea id="insp-notes" placeholder="Cues, focus points, modifications..." rows="2" style="width:100%;padding:5px 8px;font-size:10px;font-family:Sora,sans-serif;background:rgba(3,5,9,0.5);border:1px solid var(--glass-border);color:var(--text);resize:vertical;min-height:32px;border-radius:var(--radius-sm);transition:border-color 0.2s" onfocus="this.style.borderColor='rgba(59,130,246,0.3)'" onblur="this.style.borderColor='';updateClipNotes()"></textarea>
        </div>
        <div style="display:flex;gap:6px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
          <button class="nav-btn" onclick="duplicateClip()" data-tip="Duplicate (Cmd+D)" style="font-size:8px;padding:4px 8px;flex:1">DUP</button>
          <button class="nav-btn" onclick="splitClipAtPlayhead()" data-tip="Split at playhead (B)" style="font-size:8px;padding:4px 8px;flex:1">SPLIT</button>
          <button class="nav-btn" id="insp-lock-btn" onclick="toggleInspectorLock()" data-tip="Lock/Unlock (Cmd+L)" style="font-size:8px;padding:4px 8px;flex:1">LOCK</button>
          <button class="nav-btn" onclick="deleteSelectedClips()" data-tip="Delete (Del)" style="font-size:8px;padding:4px 8px;flex:1;color:var(--accent-red)">DEL</button>
        </div>
      </div>
      <div class="mixer-section" id="inspector-empty" style="padding:30px 14px;text-align:center">
        <div style="font-size:9px;color:var(--micro);text-transform:uppercase;letter-spacing:0.1em">Select a clip to inspect</div>
        <div style="font-size:7px;color:var(--micro);margin-top:4px;opacity:0.5">Click a clip on the timeline or press Tab</div>
      </div>

      <!-- Music -->
      <div class="music-section" id="music-panel" style="display:none">
        <div class="mixer-title">Music</div>
        <div class="music-now-playing" id="music-np">
          <div class="eq" id="music-eq" style="display:none"><span></span><span></span><span></span></div>
          <span id="music-track-name">No track</span>
        </div>
        <div class="music-controls">
          <button class="music-btn" onclick="musicPrev()" data-tip="Previous">&#9198;</button>
          <button class="music-btn" id="music-play-btn" onclick="musicToggle()" data-tip="Play/Pause">&#9654;</button>
          <button class="music-btn" onclick="musicNext()" data-tip="Next">&#9197;</button>
          <input type="range" class="music-volume" min="0" max="100" value="50" oninput="musicVolume(this.value)">
        </div>
        <select id="music-track-select" onchange="musicSelectTrack(this.selectedIndex)" style="width:100%;margin-top:6px;padding:4px 6px;font-size:9px;font-family:Sora,sans-serif;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-secondary);border-radius:var(--radius-sm)">
          <option value="0">Celestial Reverie</option>
          <option value="1">Blue Phoenix</option>
          <option value="2">Veil of Truth</option>
          <option value="3">Astral Shadows</option>
        </select>
        <div style="margin-top:6px;font-size:7px;color:var(--micro);display:flex;justify-content:space-between">
          <span id="music-time">0:00</span>
          <span>ASTRA Collection</span>
        </div>
      </div>

      <!-- Workout Summary — KPI Style -->
      <div class="mixer-section" id="workout-summary" style="display:none;border-left:2px solid var(--accent-purple)">
        <div class="mixer-title">Session Overview</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="text-align:center;padding:8px 0">
            <div id="sum-sets" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Sets</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-reps" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Reps</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-duration" style="font-size:1.5rem;font-weight:700;color:var(--accent-green)">0:00</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Duration</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-exercises" style="font-size:1.5rem;font-weight:700;color:var(--accent-orange)">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Exercises</div>
          </div>
        </div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:6px">Movement Balance</div>
          <div id="balance-bars" style="display:flex;gap:2px;height:24px;align-items:flex-end"></div>
          <div id="balance-labels" style="display:flex;gap:2px;margin-top:3px"></div>
        </div>
      </div>
      </div><!-- end tab-inspector-tab -->

      <!-- SETTINGS TAB -->
      <div class="panel-tab-content" id="tab-settings">
        <div class="mixer-section">
          <div class="mixer-title">Timeline</div>
          <div class="inspector-field">
            <label>Snap to Grid</label>
            <div style="display:flex;align-items:center;gap:8px">
              <button id="settings-snap" class="export-btn" onclick="toggleSnap()" style="width:auto;padding:4px 12px">OFF</button>
              <span style="font-size:8px;color:var(--micro)">S key</span>
            </div>
          </div>
          <div class="inspector-field">
            <label>Grid Resolution</label>
            <select id="settings-grid" onchange="setGridRes(this.value)" style="width:100%;padding:4px 6px;font-size:10px;font-family:Sora,sans-serif;background:var(--bg-deep);border:1px solid var(--border);color:var(--text)">
              <option value="1">1 Beat</option>
              <option value="2">2 Beats</option>
              <option value="4" selected>1 Bar (4 Beats)</option>
              <option value="8">2 Bars</option>
            </select>
          </div>
          <div class="inspector-field">
            <label>Auto-scroll during playback</label>
            <button id="settings-autoscroll" class="export-btn" onclick="toggleAutoScrollFromSettings()" style="width:auto;padding:4px 12px">ON</button>
          </div>
        </div>
        <div class="mixer-section">
          <div class="mixer-title">Audio</div>
          <div class="inspector-field">
            <label>UI Sounds</label>
            <button id="settings-sfx" class="export-btn" onclick="toggleSFXSetting()" style="width:auto;padding:4px 12px">ON</button>
          </div>
          <div class="inspector-field">
            <label>Metronome Volume</label>
            <input type="range" id="settings-metro-vol" min="0" max="100" value="50" style="width:100%" oninput="metroVolume=this.value/100">
          </div>
        </div>
        <div class="mixer-section">
          <div class="mixer-title">Session</div>
          <div class="inspector-field">
            <label>Clear All Clips</label>
            <button class="export-btn" onclick="clearAllClips()" style="width:auto;padding:4px 12px;color:var(--error);border-color:rgba(239,68,68,0.3)">Clear</button>
          </div>
          <div class="inspector-field">
            <label>Reset to Default</label>
            <button class="export-btn" onclick="resetSession()" style="width:auto;padding:4px 12px;color:var(--error);border-color:rgba(239,68,68,0.3)">Reset</button>
          </div>
        </div>
      </div>

      <!-- Export / Import (always visible) -->
      <div class="mixer-section" style="display:flex;flex-wrap:wrap;gap:4px;padding:10px 14px;margin-top:auto">
        <button class="export-btn" onclick="exportWorkout()" style="flex:1;min-width:70px">Export</button>
        <button class="export-btn" onclick="printWorkout()" style="flex:1;min-width:70px">Print</button>
        <button class="export-btn" onclick="importWorkout()" style="flex:1;min-width:70px">Import</button>
      </div>
    </aside>
  </main>
  <div class="focus-indicator" id="focus-indicator" onclick="toggleFocusMode()" data-tip="Exit focus mode (F)">FOCUS</div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="status-item"><div class="status-dot"></div><span id="status-text">Ready</span></div>
    <span id="undo-count" style="font-size:7px;color:var(--micro);opacity:0.5;letter-spacing:0.06em" data-tip="Undo / Redo history"></span>
    <div style="display:flex;gap:12px;font-size:9px">
      <span>Clips: <span id="clip-count" style="color:var(--text-secondary)">0</span></span>
      <span style="color:var(--border)">|</span>
      <span>Duration: <span id="total-duration" style="color:var(--text-secondary)">0:00</span></span>
      <span style="color:var(--border)">|</span>
      <span id="footer-bars" style="color:var(--muted)">0 bars</span>
      <span style="color:var(--border)">|</span>
      <span data-tip="Est. workout time (sets x reps x tempo + rest)" style="color:var(--muted)">Est: <span id="footer-est-time" style="color:var(--muted)">0:00</span></span>
      <span style="color:var(--border)">|</span>
      <span data-tip="Workout intensity score (0-100)" style="color:var(--muted)">Int: <span id="footer-intensity" style="font-variant-numeric:tabular-nums">0</span></span>
      <span id="footer-supersets" data-tip="Cross-track supersets" style="color:rgba(168,85,247,0.8);font-size:8px;font-weight:600"></span>
      <span id="footer-difficulty" data-tip="Avg exercise difficulty" style="font-size:7px;font-weight:600;letter-spacing:0.04em"></span>
      <span id="footer-selection" data-tip="Selected clips" style="color:var(--accent-cyan);font-size:8px;font-weight:500"></span>
      <span id="footer-locked" data-tip="Locked clips" style="color:rgba(239,68,68,0.7);font-size:7px;font-weight:500"></span>
      <span id="footer-clipboard" data-tip="Clipboard contents" style="color:rgba(234,179,8,0.7);font-size:7px;font-weight:500"></span>
      <span id="footer-track-state" data-tip="Track mute/solo status" style="font-size:7px;font-weight:500"></span>
      <span style="color:var(--border)">|</span>
      <span id="footer-pos" style="color:var(--muted);cursor:pointer;font-variant-numeric:tabular-nums" onclick="toggleFooterMode()" data-tip="Click to switch format">1.1.1</span>
      <span style="color:var(--border)">|</span>
      <span data-tip="Session elapsed time" style="color:var(--micro);font-variant-numeric:tabular-nums">Session: <span id="session-timer" style="color:var(--muted)">0:00</span></span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div id="footer-balance" style="display:flex;gap:1px;height:4px;width:60px;border-radius:2px;overflow:hidden" data-tip="Family balance"></div>
      <span id="save-indicator" style="color:var(--accent-green);opacity:0;transition:opacity 0.3s;font-size:7px;text-transform:uppercase;letter-spacing:0.1em">Saved</span>
      <span id="workout-name" style="font-size:8px;color:var(--text-secondary);font-weight:500;letter-spacing:0.03em;cursor:pointer" onclick="renameWorkout()" data-tip="Click to rename">Untitled</span>
      <span style="color:var(--border)">|</span>
      <div class="footer-quote" id="footer-hint">Saturno Movement Studio</div>
      <input type="range" id="zoom-slider" min="0" max="5" value="2" style="width:60px;height:2px;margin:0 4px" oninput="setZoomFromSlider(this.value)" data-tip="Zoom level">
      <span id="zoom-pct" style="font-size:7px;color:var(--micro);opacity:0.5;min-width:22px;text-align:center;font-variant-numeric:tabular-nums">100%</span>
      <span id="footer-version" data-tip="Workout save version" style="font-size:7px;color:var(--micro);opacity:0.4;font-variant-numeric:tabular-nums">v1</span>
      <span style="font-size:7px;color:var(--micro);opacity:0.5;letter-spacing:0.06em;font-variant-numeric:tabular-nums">v3.0</span>
      <a href="https://saturno-bonus-omega.vercel.app/vault" style="font-size:7px;color:var(--micro);text-decoration:none;text-transform:uppercase;letter-spacing:0.08em">Vault</a>
    </div>
  </footer>
</div>

<!-- Landscape hint (shows once on portrait mobile) -->
<div class="landscape-hint" id="landscape-hint">
  <div class="landscape-hint-icon">&#8635;</div>
  <div class="landscape-hint-text">For the best DAW experience, rotate your device to landscape mode.</div>
  <button class="landscape-hint-dismiss" onclick="dismissLandscapeHint()">Got it</button>
</div>

<!-- Mobile overlay (closes drawers) -->
<div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileDrawers()"></div>

<!-- Mobile bottom panel bar -->
<div class="mobile-panel-bar" id="mobile-panel-bar">
  <button class="mobile-panel-btn" id="mpb-library" onclick="toggleMobileLibrary()" data-tip="Movement Library">
    <span class="mpb-icon">&#9835;</span>
    <span>Library</span>
  </button>
  <button class="mobile-panel-btn" id="mpb-play" onclick="togglePlay()" data-tip="Play/Pause">
    <span class="mpb-icon" id="mpb-play-icon">&#9654;</span>
    <span>Play</span>
  </button>
  <button class="mobile-panel-btn" id="mpb-cmd" onclick="toggleCommandPalette()" data-tip="Commands">
    <span class="mpb-icon">&#8984;</span>
    <span>Cmd</span>
  </button>
  <button class="mobile-panel-btn" id="mpb-mixer" onclick="toggleMobileInspector()" data-tip="Mixer + Inspector">
    <span class="mpb-icon">&#9776;</span>
    <span>Mixer</span>
  </button>
  <button class="mobile-panel-btn" id="mpb-more" onclick="toggleMobileNav()" data-tip="More actions">
    <span class="mpb-icon">&#8943;</span>
    <span>More</span>
  </button>
</div>

<div class="selection-badge" id="selection-badge">
  <span class="sel-count" id="sel-count">0</span> <span id="sel-label">clips</span>
  <button class="sel-action" onclick="copyClips()">Copy</button>
  <button class="sel-action" onclick="duplicateClip()">Dup</button>
  <button class="sel-action" onclick="quantizeClips()">Quantize</button>
  <button class="sel-action danger" onclick="deleteSelectedClips()">Delete</button>
</div>

<!-- WORKOUT SUMMARY OVERLAY -->
<div class="summary-overlay" id="summary-overlay">
  <div style="display:flex;justify-content:space-between;padding:0 24px">
    <button onclick="copyWorkoutText()" style="font-size:8px;padding:4px 12px;border:1px solid rgba(255,255,255,0.08);border-radius:3px;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer;font-family:Sora,sans-serif;letter-spacing:0.05em" data-tip="Copy workout as plain text">COPY TEXT</button>
    <div class="summary-close" onclick="closeSummary()">ESC / CLOSE</div>
  </div>
  <div class="summary-inner" id="summary-content"></div>
</div>

<div class="inline-prompt" id="inline-prompt">
  <div class="inline-prompt-box">
    <div class="inline-prompt-label" id="inline-prompt-label">Name</div>
    <input type="text" class="inline-prompt-input" id="inline-prompt-input" maxlength="60" autocomplete="off">
    <div class="inline-prompt-actions">
      <button class="inline-prompt-cancel" onclick="closeInlinePrompt(null)">Cancel</button>
      <button class="inline-prompt-ok" onclick="confirmInlinePrompt()">OK</button>
    </div>
  </div>
</div>

<div class="saved-modal" id="saved-modal">
  <div class="saved-modal-content">
    <div class="saved-modal-header">
      <h3>Saved Workouts</h3>
      <button class="saved-modal-close" onclick="closeSavedWorkouts()">&times;</button>
    </div>
    <div id="saved-list"></div>
  </div>
</div>

<div class="clip-context-menu" id="clip-context-menu">
  <div class="ctx-item" data-action="duplicate">Duplicate<span class="ctx-key">Cmd+D</span></div>
  <div class="ctx-item" data-action="inspect">Inspect</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="split">Split at Playhead<span class="ctx-key">B</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="snap-start">Snap to Start</div>
  <div class="ctx-item" data-action="snap-next">Snap After Previous</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="rpe-up">RPE + 1<span class="ctx-key">&#9650;</span></div>
  <div class="ctx-item" data-action="rpe-down">RPE - 1<span class="ctx-key">&#9660;</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="stage-up">Stage Up</div>
  <div class="ctx-item" data-action="stage-down">Stage Down</div>
  <div class="ctx-item" data-action="reset-fades">Reset Fades</div>
  <div class="ctx-item" data-action="toggle-lock">Lock / Unlock</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="group">Group<span class="ctx-key">Cmd+G</span></div>
  <div class="ctx-item" data-action="ungroup">Ungroup<span class="ctx-key">Cmd+Shift+G</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item ctx-color-row" data-action="color">Color<span style="display:inline-flex;gap:3px;margin-left:auto"><span class="ctx-color-swatch" data-color="" title="Default"></span><span class="ctx-color-swatch" data-color="#ef4444" style="background:#ef4444"></span><span class="ctx-color-swatch" data-color="#f97316" style="background:#f97316"></span><span class="ctx-color-swatch" data-color="#eab308" style="background:#eab308"></span><span class="ctx-color-swatch" data-color="#22c55e" style="background:#22c55e"></span><span class="ctx-color-swatch" data-color="#06b6d4" style="background:#06b6d4"></span><span class="ctx-color-swatch" data-color="#8b5cf6" style="background:#8b5cf6"></span><span class="ctx-color-swatch" data-color="#ec4899" style="background:#ec4899"></span></span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="move-push" style="font-size:8px;color:var(--accent-blue)">Move to Push</div>
  <div class="ctx-item" data-action="move-pull" style="font-size:8px;color:var(--accent-purple)">Move to Pull</div>
  <div class="ctx-item" data-action="move-core" style="font-size:8px;color:var(--accent-orange)">Move to Core</div>
  <div class="ctx-item" data-action="move-legs" style="font-size:8px;color:var(--accent-green)">Move to Legs</div>
  <div class="ctx-item" data-action="move-skills" style="font-size:8px;color:var(--accent-cyan)">Move to Skills</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" data-action="delete">Delete<span class="ctx-key">Del</span></div>
</div>
<div class="shortcuts-overlay" id="shortcuts-overlay">
  <div class="shortcuts-panel">
    <div class="shortcuts-header">
      <span>Keyboard Shortcuts</span>
      <button onclick="toggleShortcuts()" style="background:none;border:none;color:var(--micro);cursor:pointer;font-size:14px">&times;</button>
    </div>
    <div class="shortcuts-grid">
      <div class="shortcut-item"><kbd>Space</kbd><span>Play / Pause</span></div>
      <div class="shortcut-item"><kbd>Esc</kbd><span>Deselect / Stop</span></div>
      <div class="shortcut-item"><kbd>S</kbd><span>Toggle Snap</span></div>
      <div class="shortcut-item"><kbd>Del</kbd><span>Delete Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Z</kbd><span>Undo</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+Z</kbd><span>Redo</span></div>
      <div class="shortcut-item"><kbd>Cmd+C</kbd><span>Copy Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+V</kbd><span>Paste Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+D</kbd><span>Duplicate</span></div>
      <div class="shortcut-item"><kbd>B</kbd><span>Split Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+D</kbd><span>Dup Track</span></div>
      <div class="shortcut-item"><kbd>Cmd+G</kbd><span>Group Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+G</kbd><span>Ungroup</span></div>
      <div class="shortcut-item"><kbd>&#8592; &#8594;</kbd><span>Nudge (beat)</span></div>
      <div class="shortcut-item"><kbd>Shift+&#8592; &#8594;</kbd><span>Nudge (bar)</span></div>
      <div class="shortcut-item"><kbd>Alt+&#8592; &#8594;</kbd><span>Resize (beat)</span></div>
      <div class="shortcut-item"><kbd>Alt+Drag</kbd><span>Dup & Move</span></div>
      <div class="shortcut-item"><kbd>&#8593; &#8595;</kbd><span>Move Track</span></div>
      <div class="shortcut-item"><kbd>Alt+Drag Ruler</kbd><span>Set Loop Region</span></div>
      <div class="shortcut-item"><kbd>Cmd++</kbd><span>Zoom In</span></div>
      <div class="shortcut-item"><kbd>Cmd+-</kbd><span>Zoom Out</span></div>
      <div class="shortcut-item"><kbd>Cmd+0</kbd><span>Zoom Reset</span></div>
      <div class="shortcut-item"><kbd>L</kbd><span>Toggle Loop</span></div>
      <div class="shortcut-item"><kbd>M</kbd><span>Add Marker</span></div>
      <div class="shortcut-item"><kbd>Cmd+A</kbd><span>Select All</span></div>
      <div class="shortcut-item"><kbd>Shift+Click</kbd><span>Multi-Select</span></div>
      <div class="shortcut-item"><kbd>Tab</kbd><span>Cycle Clips</span></div>
      <div class="shortcut-item"><kbd>Enter</kbd><span>Add from Search</span></div>
      <div class="shortcut-item"><kbd>Q</kbd><span>Quantize All</span></div>
      <div class="shortcut-item"><kbd>R</kbd><span>Record Toggle</span></div>
      <div class="shortcut-item"><kbd>F</kbd><span>Focus Mode</span></div>
      <div class="shortcut-item"><kbd>T</kbd><span>Tap Tempo</span></div>
      <div class="shortcut-item"><kbd>G</kbd><span>Generate Random</span></div>
      <div class="shortcut-item"><kbd>P</kbd><span>Presets</span></div>
      <div class="shortcut-item"><kbd>Dbl-Click</kbd><span>Add Random Clip</span></div>
      <div class="shortcut-item"><kbd>Drag</kbd><span>Marquee Select</span></div>
      <div class="shortcut-item"><kbd>Cmd+S</kbd><span>Save Session</span></div>
      <div class="shortcut-item"><kbd>Cmd+K</kbd><span>Command Palette</span></div>
      <div class="shortcut-item"><kbd>1-6</kbd><span>Select Track</span></div>
      <div class="shortcut-item"><kbd>Cmd+L</kbd><span>Lock / Unlock</span></div>
      <div class="shortcut-item"><kbd>Shift+&#8593;&#8595;</kbd><span>Adjust RPE</span></div>
      <div class="shortcut-item"><kbd>[ ]</kbd><span>Nudge Sets</span></div>
      <div class="shortcut-item"><kbd>Shift+[ ]</kbd><span>Nudge Reps</span></div>
      <div class="shortcut-item"><kbd>, .</kbd><span>Nudge Tempo</span></div>
      <div class="shortcut-item"><kbd>Shift+, .</kbd><span>Nudge Rest</span></div>
      <div class="shortcut-item"><kbd>Alt+&#8593;&#8595;</kbd><span>Dup to Track</span></div>
      <div class="shortcut-item"><kbd>C</kbd><span>Collapse Track</span></div>
      <div class="shortcut-item"><kbd>Shift+C</kbd><span>Collapse All</span></div>
      <div class="shortcut-item"><kbd>N</kbd><span>Next Marker</span></div>
      <div class="shortcut-item"><kbd>Shift+N</kbd><span>Prev Marker</span></div>
      <div class="shortcut-item"><kbd>Home</kbd><span>Jump to Start</span></div>
      <div class="shortcut-item"><kbd>End</kbd><span>Jump to End</span></div>
      <div class="shortcut-item"><kbd>PgUp</kbd><span>Stage Up</span></div>
      <div class="shortcut-item"><kbd>PgDn</kbd><span>Stage Down</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+V</kbd><span>Paste @ Head</span></div>
      <div class="shortcut-item"><kbd>Cmd+I</kbd><span>Invert Select</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+A</kbd><span>Track Clips</span></div>
      <div class="shortcut-item"><kbd>0</kbd><span>Playhead Zero</span></div>
      <div class="shortcut-item"><kbd>/</kbd><span>Search Library</span></div>
      <div class="shortcut-item"><kbd>?</kbd><span>This Panel</span></div>
      <div class="shortcut-item"><kbd>J</kbd><span>Next Clip</span></div>
      <div class="shortcut-item"><kbd>K</kbd><span>Prev Clip</span></div>
    </div>
    <div style="font-size:8px;color:var(--micro);text-align:center;margin-top:10px;text-transform:uppercase;letter-spacing:0.1em">Drag exercises from library to timeline</div>
  </div>
</div>
<div class="cmd-palette" id="cmd-palette">
  <div class="cmd-palette-box">
    <input type="text" class="cmd-palette-input" id="cmd-input" placeholder="Type a command..." oninput="filterCommands()">
    <div id="cmd-count" style="font-size:7px;color:var(--micro);padding:2px 16px 4px;letter-spacing:0.06em"></div>
    <div class="cmd-palette-results" id="cmd-results"></div>
  </div>
</div>
<div class="clip-tip" id="clip-tip">
  <div class="clip-tip-name" id="tip-name"></div>
  <div class="clip-tip-detail">
    <span id="tip-pattern"></span>
    <span id="tip-stage"></span>
    <span id="tip-discipline" style="font-style:italic"></span>
  </div>
  <div class="clip-tip-detail" style="margin-top:2px">
    <span id="tip-dna"></span>
    <span id="tip-instrument" style="opacity:0.5"></span>
  </div>
  <div class="clip-tip-detail" style="margin-top:2px;color:var(--micro);font-size:7px">
    <span id="tip-time"></span>
    <span id="tip-tut" style="color:var(--accent-cyan)"></span>
  </div>
</div>
<div class="track-ctx" id="track-ctx">
  <div class="track-ctx-item" data-action="solo">Solo Track</div>
  <div class="track-ctx-item" data-action="mute">Mute Track</div>
  <div class="track-ctx-sep"></div>
  <div class="track-ctx-item" data-action="select-all">Select All Clips</div>
  <div class="track-ctx-item" data-action="collapse">Toggle Collapse</div>
  <div class="track-ctx-item" data-action="collapse-all">Collapse All Tracks</div>
  <div class="track-ctx-sep"></div>
  <div class="track-ctx-item danger" data-action="clear">Clear Track</div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ===== SFX ENGINE — DAW Sound Design ===== */
var sfxCtx = null;
function initSFX() {
  if (sfxCtx) return;
  try { sfxCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
}
function sfx(type) {
  if (typeof sfxEnabled !== 'undefined' && !sfxEnabled) return;
  if (!sfxCtx) initSFX();
  if (!sfxCtx) return;
  try {
    if (sfxCtx.state === 'suspended') sfxCtx.resume();
    var now = sfxCtx.currentTime;
    var osc, gain;
    switch(type) {
      case 'click': // UI click — short, crisp
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        osc.frequency.exponentialRampToValueAtTime(800, now + 0.05);
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.06);
        break;
      case 'snap': // Snap to grid
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(2000, now);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.03);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.04);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.04);
        break;
      case 'play': // Transport play — rising tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'stop': // Transport stop — falling tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(660, now);
        osc.frequency.exponentialRampToValueAtTime(220, now + 0.12);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'drop': // Clip dropped — soft thud
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(180, now);
        osc.frequency.exponentialRampToValueAtTime(80, now + 0.08);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'delete': // Clip deleted — descending sweep
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
        gain.gain.setValueAtTime(0.06, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'preset': // Preset loaded — chord
        [440, 554, 659].forEach(function(freq, i) {
          var o = sfxCtx.createOscillator();
          var g = sfxCtx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(freq, now + i * 0.04);
          g.gain.setValueAtTime(0.06, now + i * 0.04);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
          o.connect(g); g.connect(sfxCtx.destination);
          o.start(now + i * 0.04); o.stop(now + 0.3);
        });
        break;
      case 'undo': // Undo — quick reverse
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(300, now + 0.08);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'rec': // Record — pulsing tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.setValueAtTime(0.02, now + 0.05);
        gain.gain.setValueAtTime(0.1, now + 0.1);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.2);
        break;
      case 'metronome': // Metronome tick — downbeat accent
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
        var isDownbeat = (beatCounter % bpb === 0);
        osc.frequency.setValueAtTime(isDownbeat ? 1500 : 1000, now);
        var vol = (typeof metroVolume !== 'undefined' ? metroVolume : 0.5) * (isDownbeat ? 0.15 : 0.08);
        gain.gain.setValueAtTime(vol, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.03);
        break;
    }
  } catch(e) {}
}

/* Init SFX on first user interaction */
document.addEventListener('click', function() { initSFX(); }, {once: true});
document.addEventListener('touchstart', function() { initSFX(); }, {once: true});

/* ===== EXERCISE DATABASE (from Victory Belt CC Movement Matrix) ===== */
var EXERCISES = [
  /* Horizontal Push (Pattern 1) */
  {id:'P1-01',name:'Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-02',name:'Diamond Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-03',name:'Wide Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-04',name:'Decline Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-05',name:'Archer Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-06',name:'Pseudo Planche PU',pattern:'Horizontal Push',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-07',name:'Ring Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-08',name:'One Arm Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-09',name:'Planche Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Horizontal Pull (Pattern 2) */
  {id:'P2-01',name:'Inverted Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-02',name:'Ring Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-03',name:'Archer Row',pattern:'Horizontal Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-04',name:'Tuck Front Lever',pattern:'Horizontal Pull',stage:2,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-05',name:'Front Lever Row',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-06',name:'Front Lever',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Downward Press (Pattern 3) */
  {id:'P3-01',name:'Dip',pattern:'Downward Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-02',name:'Ring Dip',pattern:'Downward Press',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-03',name:'Korean Dip',pattern:'Downward Press',stage:2,discipline:'Freestyle',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-04',name:'Weighted Dip',pattern:'Downward Press',stage:2,discipline:'Street Lifting',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-05',name:'Tuck Planche',pattern:'Downward Press',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-06',name:'Full Planche',pattern:'Downward Press',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Vertical Pull (Pattern 4) */
  {id:'P4-01',name:'Dead Hang',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-02',name:'Pull Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-03',name:'Chin Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-04',name:'L-Sit Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-05',name:'Archer Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-06',name:'Muscle Up (Bar)',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-07',name:'Ring Muscle Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-08',name:'Weighted Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Street Lifting',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-09',name:'One Arm Pull Up',pattern:'Vertical Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Overhead Press (Pattern 5) */
  {id:'P5-01',name:'Pike Push Up',pattern:'Overhead Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P5-02',name:'Wall Handstand Hold',pattern:'Overhead Press',stage:1,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-03',name:'Wall HSPU',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-04',name:'Free Handstand',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-05',name:'Handstand Push Up',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-06',name:'Press to Handstand',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  /* Knee-Dominant (Pattern 6) */
  {id:'P6-01',name:'Bodyweight Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-02',name:'Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-03',name:'Bulgarian Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-04',name:'Pistol Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-05',name:'Shrimp Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-06',name:'Cossack Squat',pattern:'Knee-Dominant',stage:2,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-07',name:'Dragon Squat',pattern:'Knee-Dominant',stage:3,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  /* Hip-Dominant (Pattern 7) */
  {id:'P7-01',name:'Glute Bridge',pattern:'Hip-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-02',name:'Nordic Curl',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-03',name:'Wrestler Bridge',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-04',name:'Stand to Bridge',pattern:'Hip-Dominant',stage:3,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  /* Core */
  {id:'C-01',name:'Hollow Body Hold',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-02',name:'Plank',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-03',name:'L-Sit',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-04',name:'V-Sit',pattern:'Core',stage:3,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-05',name:'Dragon Flag',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-06',name:'Ab Wheel Rollout',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  /* Mobility */
  {id:'M-01',name:'Resting Squat',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-02',name:'Pancake Stretch',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-03',name:'Front Split',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-04',name:'Thoracic Bridge',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-05',name:'German Hang',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-06',name:'Hip CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-07',name:'Scapular CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'}
];

/* Movement family -> instrument role (from Composition Engine) */
var FAMILY_MAP = {
  'Push': {instrument:'Percussion',color:'#3b82f6'},
  'Pull': {instrument:'Bass',color:'#8b5cf6'},
  'Legs': {instrument:'Rhythm Guitar',color:'#22c55e'},
  'Core': {instrument:'Harmony',color:'#f97316'},
  'Skills': {instrument:'Lead Melody',color:'#06b6d4'},
  'Flow': {instrument:'Ambient Pad',color:'#ec4899'}
};

/* BPM -> Training Mode (from Composition Engine) */
var BPM_MODES = [
  {min:40,max:80,name:'Slow Strength',desc:'Control, holds, precision'},
  {min:80,max:120,name:'Standard',desc:'Tempo work, sets'},
  {min:120,max:160,name:'Flow State',desc:'Conditioning, flow'},
  {min:160,max:200,name:'Explosive',desc:'Power, speed, intensity'}
];

/* Track definitions */
var TRACKS = [
  {id:'music',name:'Music',family:'_music',info:'Audio',isMusic:true},
  {id:'push',name:'Push',family:'Push',info:'Percussion'},
  {id:'pull',name:'Pull',family:'Pull',info:'Bass'},
  {id:'core',name:'Core',family:'Core',info:'Harmony'},
  {id:'legs',name:'Legs',family:'Legs',info:'Rhythm'},
  {id:'skills',name:'Skills',family:'Skills',info:'Lead'}
];

/* Fader definitions */
var FADERS = [
  {id:'intensity',label:'Intensity',value:70,color:'var(--gradient-titan)'},
  {id:'volume',label:'Volume',value:50,color:'var(--gradient-titan)'},
  {id:'density',label:'Density',value:60,color:'var(--gradient-titan)'},
  {id:'rest',label:'Rest',value:40,color:'var(--gradient-titan)'}
];

/* Knob definitions */
var KNOBS = [
  {id:'str-mob',label:'Str / Mob',value:0.5},
  {id:'pwr-ctrl',label:'Pwr / Ctrl',value:0.5},
  {id:'sta-dyn',label:'Sta / Dyn',value:0.5}
];

/* Preset definitions */
var PRESETS = {
  monk: {
    name:'Monk Mode',bpm:65,
    clips:[
      {track:'core',name:'Hollow Body Hold',x:0,w:120},
      {track:'push',name:'Push Up',x:20,w:100},
      {track:'core',name:'L-Sit',x:140,w:100},
      {track:'pull',name:'Pull Up',x:140,w:100},
      {track:'skills',name:'Free Handstand',x:260,w:120},
      {track:'legs',name:'Resting Squat',x:260,w:80}
    ],
    faders:{intensity:40,volume:30,density:30,rest:70},
    knobs:{'str-mob':0.4,'pwr-ctrl':0.3,'sta-dyn':0.2}
  },
  beast: {
    name:'Beast Mode',bpm:140,
    clips:[
      {track:'push',name:'Diamond Push Up',x:0,w:100},
      {track:'pull',name:'Muscle Up (Bar)',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:120,w:80},
      {track:'push',name:'Dip',x:120,w:80},
      {track:'core',name:'Dragon Flag',x:120,w:80},
      {track:'pull',name:'Weighted Pull Up',x:220,w:100},
      {track:'legs',name:'Shrimp Squat',x:220,w:80},
      {track:'push',name:'Planche Push Up',x:340,w:100}
    ],
    faders:{intensity:90,volume:80,density:85,rest:20},
    knobs:{'str-mob':0.8,'pwr-ctrl':0.7,'sta-dyn':0.9}
  },
  flow: {
    name:'Flow Ritual',bpm:100,
    clips:[
      {track:'legs',name:'Hip CARs',x:0,w:80},
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'core',name:'Hollow Body Hold',x:100,w:80},
      {track:'pull',name:'Ring Row',x:100,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:200,w:100},
      {track:'legs',name:'Cossack Squat',x:200,w:80},
      {track:'core',name:'L-Sit',x:300,w:80},
      {track:'push',name:'Ring Push Up',x:300,w:100}
    ],
    faders:{intensity:55,volume:60,density:65,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.4,'sta-dyn':0.6}
  },
  skill: {
    name:'Skill Ascension',bpm:75,
    clips:[
      {track:'skills',name:'Free Handstand',x:0,w:160},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'pull',name:'Tuck Front Lever',x:180,w:140},
      {track:'push',name:'Tuck Planche',x:180,w:140},
      {track:'core',name:'V-Sit',x:180,w:80},
      {track:'skills',name:'Press to Handstand',x:340,w:160}
    ],
    faders:{intensity:60,volume:40,density:35,rest:80},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.3,'sta-dyn':0.15}
  },
  upper: {
    name:'Upper Day',bpm:100,
    clips:[
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'push',name:'Dip',x:120,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Inverted Row',x:120,w:100},
      {track:'push',name:'Ring Push Up',x:240,w:100},
      {track:'pull',name:'Chin Up',x:240,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'L-Sit',x:120,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:360,w:120}
    ],
    faders:{intensity:65,volume:60,density:55,rest:50},
    knobs:{'str-mob':0.7,'pwr-ctrl':0.5,'sta-dyn':0.4}
  },
  lower: {
    name:'Lower Day',bpm:90,
    clips:[
      {track:'legs',name:'Bodyweight Squat',x:0,w:100},
      {track:'legs',name:'Bulgarian Split Squat',x:120,w:100},
      {track:'legs',name:'Pistol Squat',x:240,w:100},
      {track:'legs',name:'Nordic Curl',x:360,w:100},
      {track:'legs',name:'Cossack Squat',x:480,w:80},
      {track:'core',name:'Dragon Flag',x:0,w:100},
      {track:'core',name:'Ab Wheel Rollout',x:120,w:80},
      {track:'legs',name:'Glute Bridge',x:600,w:80},
      {track:'skills',name:'Resting Squat',x:0,w:120}
    ],
    faders:{intensity:70,volume:55,density:60,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.6,'sta-dyn':0.5}
  },
  ppl: {
    name:'Push / Pull / Legs',bpm:110,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'push',name:'Pseudo Planche PU',x:120,w:100},
      {track:'push',name:'Pike Push Up',x:240,w:80},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Ring Row',x:120,w:80},
      {track:'pull',name:'Tuck Front Lever',x:220,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'legs',name:'Nordic Curl',x:120,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'Dragon Flag',x:100,w:80}
    ],
    faders:{intensity:75,volume:65,density:70,rest:35},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.6,'sta-dyn':0.6}
  },
  fullbody: {
    name:'Full Body',bpm:105,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'skills',name:'Free Handstand',x:0,w:120},
      {track:'push',name:'Ring Push Up',x:140,w:80},
      {track:'pull',name:'Archer Pull Up',x:140,w:80},
      {track:'legs',name:'Bulgarian Split Squat',x:140,w:80},
      {track:'core',name:'Ab Wheel Rollout',x:140,w:80}
    ],
    faders:{intensity:60,volume:55,density:50,rest:50},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.5,'sta-dyn':0.5}
  }
};

/* ===== STATE ===== */
var isPlaying = false, currentTime = 0, bpm = 120, playInterval = null;
var isRecording = false, tempoLinked = false, playbackSpeed = 1, _userSelectedDuringPlayback = false;
var selectedClip = null, musicPlaying = false, musicIndex = 0;
var audioEl = null;
var meterInterval = null;
var undoStack = [], redoStack = [], maxUndo = 30;
var metronomeEnabled = false, lastBeatTime = 0, beatCounter = 0;
var loopEnabled = false, loopStart = 0, loopEnd = 60;
var markers = [], markerCounter = 0;

/* Music tracks (from Vercel Blob CDN) */
var MUSIC_TRACKS = [
  {name:'Celestial Reverie',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Celestial%20Reverie.mp3'},
  {name:'Blue Phoenix',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Blue%20Phoenix.mp3'},
  {name:'Veil of Truth',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Veil%20of%20Truth.mp3'},
  {name:'Astral Shadows',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Astral%20Shadows.mp3'}
];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', function() {
  buildLibrary();
  restoreCategoryState();
  buildTracks();
  buildRuler();
  buildFaders();
  buildKnobs();
  buildMeters();
  loadSession();
  loadFromHash();
  updateBPMMode();
  updateEmptyState();
});

/* ===== LIBRARY ===== */
function buildLibrary() {
  var container = document.getElementById('library-container');
  var groups = {};
  EXERCISES.forEach(function(ex) {
    var g = ex.pattern;
    if (!groups[g]) groups[g] = [];
    groups[g].push(ex);
  });
  var html = '';
  var patterns = ['Horizontal Push','Horizontal Pull','Downward Press','Vertical Pull','Overhead Press','Knee-Dominant','Hip-Dominant','Core','Mobility'];
  patterns.forEach(function(p) {
    var exs = groups[p];
    if (!exs) return;
    var fam = exs[0].family;
    var fm = FAMILY_MAP[fam] || {color:'#666'};
    html += '<div class="movement-category" data-pattern="'+p+'">';
    html += '<div class="category-header" onclick="toggleCategory(this)"><span>'+p+' ('+exs.length+')</span><div style="display:flex;align-items:center;gap:6px"><div class="category-color" style="background:'+fm.color+'"></div><span class="arrow">&#9660;</span></div></div>';
    html += '<div class="movement-list">';
    exs.forEach(function(ex) {
      html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" data-family="'+ex.family+'">';
      html += '<div class="mv-icon" style="background:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
      html += '<span>'+ex.name+'</span>';
      html += '<span class="mv-stage">S'+ex.stage+'</span>';
      html += '<div class="mv-detail">'+ex.discipline+' | '+ex.family+' | Stage '+ex.stage+'</div>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
  document.getElementById('lib-count').textContent = EXERCISES.length;
  initDragDrop();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  var list = header.nextElementSibling;
  list.classList.toggle('hidden');
  saveCategoryState();
}

function saveCategoryState() {
  try {
    var state = {};
    document.querySelectorAll('.movement-category[data-pattern]').forEach(function(cat) {
      var h = cat.querySelector('.category-header');
      if (h && h.classList.contains('collapsed')) {
        state[cat.dataset.pattern] = true;
      }
    });
    localStorage.setItem('sms_lib_collapsed', JSON.stringify(state));
  } catch(e) {}
}

function restoreCategoryState() {
  try {
    var saved = localStorage.getItem('sms_lib_collapsed');
    if (!saved) return;
    var state = JSON.parse(saved);
    document.querySelectorAll('.movement-category[data-pattern]').forEach(function(cat) {
      if (state[cat.dataset.pattern]) {
        var h = cat.querySelector('.category-header');
        var l = cat.querySelector('.movement-list');
        if (h) h.classList.add('collapsed');
        if (l) l.classList.add('hidden');
      }
    });
  } catch(e) {}
}

var _libStageFilter = 'all';
var _libDiscFilter = 'all';
function filterByStage(stage) {
  _libStageFilter = stage;
  document.querySelectorAll('.lib-stage-btn').forEach(function(btn) {
    var isActive = btn.dataset.stage === String(stage);
    btn.style.background = isActive ? 'rgba(255,255,255,0.06)' : 'rgba(255,255,255,0.03)';
    btn.style.color = isActive ? 'var(--text-secondary)' : 'var(--muted)';
  });
  filterLibrary();
}
function filterByDiscipline(disc) {
  _libDiscFilter = disc;
  filterLibrary();
}
function filterLibrary() {
  var q = document.getElementById('lib-search').value.toLowerCase();
  var items = document.querySelectorAll('.movement-item');
  var count = 0;
  items.forEach(function(item) {
    var ex = getExercise(item.dataset.id);
    var matchText = item.textContent.toLowerCase().indexOf(q) !== -1;
    var matchStage = _libStageFilter === 'all' || (ex && ex.stage === _libStageFilter);
    var matchDisc = _libDiscFilter === 'all' || (ex && ex.discipline === _libDiscFilter);
    var show = matchText && matchStage && matchDisc;
    item.style.display = show ? '' : 'none';
    if (show) count++;
  });
  document.getElementById('lib-count').textContent = count;
  if (q || _libStageFilter !== 'all' || _libDiscFilter !== 'all') {
    document.querySelectorAll('.movement-list').forEach(function(l) { l.classList.remove('hidden'); });
    document.querySelectorAll('.category-header').forEach(function(h) { h.classList.remove('collapsed'); });
  }
}

function addFirstMatch() {
  var q = document.getElementById('lib-search').value.toLowerCase().trim();
  if (!q) return;
  // Find first matching exercise
  var match = null;
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].name.toLowerCase().indexOf(q) !== -1) {
      match = EXERCISES[i]; break;
    }
  }
  if (!match) { toast('No match found'); return; }
  // Find active track or matching family track
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) {
    // Find track by family
    var familyToTrack = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
    var trackId = familyToTrack[match.family] || 'push';
    activeTrack = document.querySelector('.track-content[data-track="'+trackId+'"]');
  }
  if (!activeTrack || activeTrack.dataset.track === 'music') {
    var familyToTrack = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
    activeTrack = document.querySelector('.track-content[data-track="'+(familyToTrack[match.family] || 'push')+'"]');
  }
  // Place after last clip in that track
  var clips = activeTrack.querySelectorAll('.clip');
  var x = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > x) x = r;
  });
  addClip(activeTrack, match, x + 4);
  document.getElementById('lib-search').value = '';
  filterLibrary();
}

/* ===== TRACKS ===== */
function buildTracks() {
  var container = document.getElementById('timeline-tracks');
  var ph = container.querySelector('.playhead');
  var html = '';
  TRACKS.forEach(function(t, ti) {
    if (t.isMusic) {
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-num">1</div><div class="track-name" style="color:var(--accent-cyan)">'+t.name+'</div>';
      html += '<select class="track-select" id="music-track-select" onchange="selectMusicTrack(this.value)" style="font-size:8px;padding:2px 4px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text);width:88px;font-family:Sora,sans-serif;border-radius:2px">';
      html += '<option value="">--</option>';
      MUSIC_TRACKS.forEach(function(mt,i) { html += '<option value="'+i+'">'+mt.name+'</option>'; });
      html += '</select></div>';
      html += '<div class="track-content" data-track="'+t.id+'" style="pointer-events:none;position:relative"><canvas id="music-waveform-canvas" style="position:absolute;top:8px;left:100px;right:0;height:44px;opacity:0.3"></canvas><span id="music-timeline-label" style="font-size:8px;color:var(--micro);padding:4px 8px;display:inline-block;position:relative;z-index:1">Select a track</span></div></div>';
    } else {
      var fm = FAMILY_MAP[t.family] || {color:'#666'};
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-num">'+(ti+1)+'</div><div class="track-grip"><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div></div><div class="track-name" style="color:'+fm.color+'">'+t.name+'</div><div class="track-info">'+t.info+' <span style="color:'+fm.color+';opacity:0.5">| '+(fm.instrument||'')+'</span></div>';
      html += '<div class="track-controls"><button class="track-btn" onclick="toggleMute(this)" data-tip="Mute">M</button><button class="track-btn" onclick="toggleSolo(this)" data-tip="Solo">S</button><button class="track-btn" onclick="toggleArm(this)" data-tip="Arm" style="color:var(--micro)">R</button></div>';
      html += '<div class="track-clip-count" id="track-count-'+t.id+'">0 clips</div>';
      html += '<div class="track-vu" id="vu-'+t.id+'"><div class="track-vu-dot"></div><div class="track-vu-dot"></div><div class="track-vu-dot"></div><div class="track-vu-dot"></div><div class="track-vu-dot"></div></div>';
      html += '</div>';
      html += '<div class="track-content" data-track="'+t.id+'"></div></div>';
    }
  });
  container.innerHTML = html;
  container.insertBefore(ph, container.firstChild);
}

function selectMusicTrack(idx) {
  if (idx === '') {
    document.getElementById('music-timeline-label').textContent = 'Select a track';
    return;
  }
  musicIndex = parseInt(idx);
  var track = MUSIC_TRACKS[musicIndex];
  document.getElementById('music-timeline-label').textContent = track.name;
  document.getElementById('music-track-name').textContent = track.name;
  if (!audioEl) { audioEl = new Audio(); audioEl.volume = 0.5; audioEl.addEventListener('ended', function() { musicNext(); }); }
  audioEl.src = track.url;
  audioEl.load();
  drawMusicWaveform(track.name);
  toast('Music: ' + track.name);
}

function buildRuler() {
  var ruler = document.getElementById('timeline-ruler');
  var beatDuration = 60 / bpm;
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barDuration = beatDuration * bpb;
  var html = '<div class="ruler-mark" style="flex:0 0 100px"><span style="color:var(--muted)">1</span></div>';
  for (var i = 15; i <= 300; i += 15) {
    var m = Math.floor(i / 60);
    var s = i % 60;
    var barNum = Math.floor(i / barDuration) + 1;
    var isDownbeat = barNum % 4 === 1;
    var barColor = isDownbeat ? 'var(--text-secondary)' : 'var(--micro)';
    var barWeight = isDownbeat ? 'font-weight:600' : '';
    html += '<div class="ruler-mark'+(isDownbeat?' ruler-downbeat':'')+'">'+m+':'+s.toString().padStart(2,'0')+' <span style="color:'+barColor+';font-size:7px;'+barWeight+'">|'+barNum+'</span></div>';
  }
  ruler.innerHTML = html;
}

/* ===== DRAG & DROP ===== */
function initDragDrop() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.4';
      // Custom drag image — looks like a mini clip
      var ghost = document.createElement('div');
      ghost.textContent = ex.name;
      ghost.style.cssText = 'position:absolute;top:-999px;left:-999px;padding:4px 10px;font-size:9px;font-weight:600;font-family:Sora,sans-serif;background:' + (FAMILY_MAP[ex.family] || {color:'#666'}).color + ';color:rgba(255,255,255,0.9);border-radius:3px;white-space:nowrap;border-top:2px solid rgba(255,255,255,0.3)';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 0, 0);
      setTimeout(function() { document.body.removeChild(ghost); }, 0);
      sfx('click');
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
  document.querySelectorAll('.track-content').forEach(function(track) {
    var ghostPreview = null;
    track.addEventListener('dragover', function(e) {
      e.preventDefault();
      track.classList.add('drag-over');
      // Show ghost clip preview at cursor position
      if (!ghostPreview) {
        ghostPreview = document.createElement('div');
        ghostPreview.className = 'clip';
        ghostPreview.style.cssText = 'width:80px;opacity:0.3;pointer-events:none;z-index:10;border:1px dashed rgba(255,255,255,0.2);background:rgba(255,255,255,0.03)';
        track.appendChild(ghostPreview);
      }
      var rect = track.getBoundingClientRect();
      var x = e.clientX - rect.left + (track.parentElement.parentElement ? track.parentElement.parentElement.scrollLeft : 0);
      ghostPreview.style.left = snapValue(x) + 'px';
    });
    track.addEventListener('dragleave', function() {
      track.classList.remove('drag-over');
      if (ghostPreview && ghostPreview.parentNode) { ghostPreview.remove(); ghostPreview = null; }
    });
    track.addEventListener('drop', function(e) {
      e.preventDefault();
      track.classList.remove('drag-over');
      if (ghostPreview && ghostPreview.parentNode) { ghostPreview.remove(); ghostPreview = null; }
      try {
        var ex = JSON.parse(e.dataTransfer.getData('text/plain'));
        var rect = track.getBoundingClientRect();
        var x = e.clientX - rect.left + track.parentElement.parentElement.scrollLeft;
        addClip(track, ex, x);
      } catch(err) {}
    });
    // Double-click empty area to add random exercise matching this track's family
    track.addEventListener('dblclick', function(e) {
      if (e.target.closest('.clip')) return; // ignore clicks on existing clips
      var trackId = track.dataset.track;
      if (trackId === 'music') return;
      var trackDef = TRACKS.find(function(t) { return t.id === trackId; });
      if (!trackDef) return;
      var familyExercises = EXERCISES.filter(function(ex) { return ex.family === trackDef.family; });
      if (familyExercises.length === 0) return;
      var ex = familyExercises[Math.floor(Math.random() * familyExercises.length)];
      var rect = track.getBoundingClientRect();
      var x = e.clientX - rect.left + (track.parentElement.parentElement ? track.parentElement.parentElement.scrollLeft : 0);
      addClip(track, ex, snapValue(x));
    });
    // Marquee rubber-band selection on empty area
    track.addEventListener('mousedown', function(e) {
      if (e.target.closest('.clip') || e.button !== 0) return;
      var trackId = track.dataset.track;
      if (trackId === 'music') return;
      var rect = track.getBoundingClientRect();
      var startX = e.clientX - rect.left;
      var startY = e.clientY - rect.top;
      var marquee = document.createElement('div');
      marquee.className = 'marquee-selection';
      track.style.position = 'relative';
      track.appendChild(marquee);
      function onMove(ev) {
        var curX = ev.clientX - rect.left;
        var curY = ev.clientY - rect.top;
        var left = Math.min(startX, curX);
        var top = Math.min(startY, curY);
        var w = Math.abs(curX - startX);
        var h = Math.abs(curY - startY);
        marquee.style.left = left + 'px';
        marquee.style.top = top + 'px';
        marquee.style.width = w + 'px';
        marquee.style.height = h + 'px';
        // Highlight clips that intersect marquee
        var mLeft = left; var mRight = left + w;
        track.querySelectorAll('.clip').forEach(function(c) {
          var cLeft = parseInt(c.style.left) || 0;
          var cRight = cLeft + (parseInt(c.style.width) || 80);
          if (cRight > mLeft && cLeft < mRight) {
            c.classList.add('selected');
          } else if (!ev.shiftKey) {
            c.classList.remove('selected');
          }
        });
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (marquee.parentNode) marquee.remove();
        var sel = track.querySelectorAll('.clip.selected');
        if (sel.length === 1) selectClipEl(sel[0]);
        else if (sel.length > 1) toast(sel.length + ' clips selected');
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
}

function getExercise(id) {
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].id === id) return EXERCISES[i];
  }
  return null;
}

/* ===== CLIPS ===== */
function drawClipWaveform(canvas, color, width, opacity, rpeScale) {
  if (!canvas || !canvas.getContext) return;
  var w = parseInt(width) || 80;
  canvas.width = w - 8;
  canvas.height = 20;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = color;
  ctx.globalAlpha = opacity || 0.35;
  var mid = canvas.height / 2;
  var seed = w * 7 + canvas.width;
  var intensityScale = rpeScale ? (0.5 + (rpeScale / 10) * 0.5) : 1;
  for (var x = 0; x < canvas.width; x += 1) {
    var v = Math.sin(x * 0.15 + seed * 0.01) * 0.4 +
            Math.sin(x * 0.08 + seed * 0.02) * 0.3 +
            Math.sin(x * 0.3 + seed * 0.005) * 0.2 +
            Math.sin(x * 0.5 + seed * 0.03) * 0.1;
    var amp = (mid - 2) * Math.abs(v) * intensityScale;
    ctx.fillRect(x, mid - amp, 1, amp * 2);
  }
}

/* Add beat marker dividers inside clips based on BPM */
function addBeatMarkers(clipEl, widthPx) {
  var existing = clipEl.querySelector('.beat-markers');
  if (existing) existing.remove();
  var w = parseInt(widthPx) || parseInt(clipEl.style.width) || 80;
  var pps = 80 / 15; // pixels per second
  var beatSec = 60 / bpm;
  var beatPx = beatSec * pps;
  if (beatPx < 8) return; // Too dense to show
  var container = document.createElement('div');
  container.className = 'beat-markers';
  for (var px = beatPx; px < w; px += beatPx) {
    var marker = document.createElement('span');
    marker.style.left = px + 'px';
    container.appendChild(marker);
  }
  clipEl.appendChild(container);
}

function createClipElement(exercise, left, width, dna) {
  var fm = FAMILY_MAP[exercise.family] || {color:'#666'};
  var clip = document.createElement('div');
  clip.className = 'clip';
  var baseColor = fm.color;
  // Stage-based opacity + RPE intensity for visual differentiation
  var rpeVal = parseInt((dna && dna.rpe) || '7');
  var stageBase = exercise.stage === 1 ? 170 : exercise.stage === 2 ? 200 : 230;
  var rpeBoost = Math.round((rpeVal / 10) * 25);
  var alphaTop = Math.min(255, stageBase + rpeBoost).toString(16).padStart(2, '0');
  var alphaBot = Math.min(255, 130 + rpeBoost).toString(16).padStart(2, '0');
  clip.style.background = 'linear-gradient(180deg, ' + baseColor + alphaTop + ' 0%, ' + baseColor + alphaBot + ' 100%)';
  clip.style.borderTopColor = baseColor;
  // Discipline bottom-border accent (subtle visual coding)
  var discColors = {'Calisthenics':'#3b82f6','Power-Free':'#f97316','Bodybuilding':'#ef4444','Street Lifting':'#a855f7','Hand-Balancing':'#06b6d4','Freestyle':'#ec4899','Mobility':'#22c55e'};
  var discColor = discColors[exercise.discipline] || baseColor;
  clip.style.borderBottom = '1px solid ' + discColor + '40';
  clip.setAttribute('data-tip', exercise.name + ' | ' + exercise.family + ' | S' + exercise.stage + ' | ' + exercise.discipline);
  clip.style.left = (typeof left === 'string' ? left : Math.max(0, left) + 'px');
  clip.style.width = (typeof width === 'string' ? width : (width || 80) + 'px');
  clip.style.color = 'rgba(255,255,255,0.9)';
  clip.dataset.exerciseId = exercise.id;
  clip.dataset.sets = (dna && dna.sets) || '3';
  clip.dataset.reps = (dna && dna.reps) || '8';
  clip.dataset.tempo = (dna && dna.tempo) || '3';
  clip.dataset.rest = (dna && dna.rest) || '60';
  clip.dataset.rpe = (dna && dna.rpe) || '7';

  // RPE velocity strip — color-coded intensity bar at top
  var velocity = document.createElement('div');
  velocity.className = 'clip-velocity';
  var rpeN = parseInt(clip.dataset.rpe);
  var velColor = rpeN >= 9 ? '#ef4444' : rpeN >= 7 ? '#f97316' : rpeN >= 5 ? '#eab308' : '#22c55e';
  var velAlpha = 0.3 + (rpeN / 10) * 0.5;
  velocity.style.background = 'linear-gradient(90deg, ' + velColor + Math.round(velAlpha * 255).toString(16).padStart(2,'0') + ', transparent)';
  clip.appendChild(velocity);

  var label = document.createElement('span');
  label.className = 'clip-name';
  label.textContent = exercise.name;
  label.style.position = 'relative';
  label.style.zIndex = '1';
  clip.appendChild(label);

  var info = document.createElement('span');
  info.className = 'clip-info';
  var clipSec = Math.round(parseInt(clip.style.width) / 80 * 15);
  info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps + ' ' + clipSec + 's';
  info.style.position = 'relative';
  info.style.zIndex = '1';
  clip.appendChild(info);

  // Stage dots (S1=1dot, S2=2dots, S3=3dots)
  var dotsEl = document.createElement('div');
  dotsEl.className = 'clip-stage-dots';
  for (var di = 0; di < 3; di++) {
    var dot = document.createElement('div');
    dot.className = 'clip-stage-dot' + (di < exercise.stage ? ' filled' : '');
    dotsEl.appendChild(dot);
  }
  clip.appendChild(dotsEl);

  var rpeBadge = document.createElement('div');
  rpeBadge.className = 'clip-rpe-badge';
  rpeBadge.textContent = clip.dataset.rpe || 7;
  clip.appendChild(rpeBadge);

  var canvas = document.createElement('canvas');
  canvas.className = 'clip-waveform';
  clip.appendChild(canvas);
  // Waveform: family color + stage-based density
  var waveOpacity = exercise.stage === 1 ? 0.35 : exercise.stage === 2 ? 0.5 : 0.65;
  var waveColor = baseColor || '#fff';
  var waveRpe = parseInt(clip.dataset.rpe) || 7;
  setTimeout(function() {
    drawClipWaveform(canvas, waveColor, clip.style.width, waveOpacity, waveRpe);
    addBeatMarkers(clip, clip.style.width);
  }, 10);

  var progress = document.createElement('div');
  progress.className = 'clip-progress';
  clip.appendChild(progress);

  var progressFill = document.createElement('div');
  progressFill.className = 'clip-progress-fill';
  clip.appendChild(progressFill);

  var fadeIn = document.createElement('div');
  fadeIn.className = 'clip-fade clip-fade-in';
  clip.appendChild(fadeIn);
  var fadeOut = document.createElement('div');
  fadeOut.className = 'clip-fade clip-fade-out';
  clip.appendChild(fadeOut);

  // Fade handle drag — visual fade overlay + persist width
  function setupFadeDrag(fadeEl, isIn) {
    fadeEl.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      var startX = e.clientX;
      function onMove(e) {
        var delta = Math.abs(e.clientX - startX);
        var maxFade = parseInt(clip.style.width) / 2;
        var w = Math.min(Math.max(0, delta), maxFade);
        fadeEl.style.width = w + 'px';
        fadeEl.classList.toggle('has-fade', w > 2);
        clip.dataset[isIn ? 'fadeIn' : 'fadeOut'] = Math.round(w);
        updateFadeOverlay(clip);
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        saveSession();
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  }
  setupFadeDrag(fadeIn, true);
  setupFadeDrag(fadeOut, false);
  // Restore fade widths from DNA
  if (dna && dna.fadeIn && parseInt(dna.fadeIn) > 0) {
    fadeIn.style.width = dna.fadeIn + 'px';
    fadeIn.classList.add('has-fade');
    clip.dataset.fadeIn = dna.fadeIn;
  }
  if (dna && dna.fadeOut && parseInt(dna.fadeOut) > 0) {
    fadeOut.style.width = dna.fadeOut + 'px';
    fadeOut.classList.add('has-fade');
    clip.dataset.fadeOut = dna.fadeOut;
  }
  if (dna && (dna.fadeIn || dna.fadeOut)) updateFadeOverlay(clip);

  var resize = document.createElement('div');
  resize.className = 'clip-resize';
  clip.appendChild(resize);

  // Left resize handle
  var resizeL = document.createElement('div');
  resizeL.className = 'clip-resize-left';
  resizeL.style.cssText = 'position:absolute;left:0;top:0;bottom:0;width:5px;cursor:ew-resize;background:transparent;opacity:0;transition:opacity 0.1s;z-index:3';
  clip.appendChild(resizeL);
  resizeL.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startLeft = parseInt(clip.style.left), startW = parseInt(clip.style.width);
    function onMove(e) {
      var delta = e.clientX - startX;
      var newLeft = Math.max(0, startLeft + delta);
      var newW = Math.max(40, startW - delta);
      clip.style.left = newLeft + 'px';
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, waveColor, newW + 'px', waveOpacity, parseInt(clip.dataset.rpe) || 7);
      addBeatMarkers(clip, newW);
      updateStats();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      var rSec = Math.round(parseInt(clip.style.width) / 80 * 15);
      var rInfo = clip.querySelector('.clip-info');
      if (rInfo) rInfo.textContent = clip.dataset.sets + 'x' + clip.dataset.reps + ' ' + rSec + 's';
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Drag clip (with group support + Alt to duplicate)
  clip.addEventListener('mousedown', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize') || e.target === resizeL || e.target.classList.contains('clip-resize-left')) return;
    e.preventDefault();
    if (clip.classList.contains('clip-locked')) { selectClipEl(clip, e.shiftKey); return; }
    if (isPlaying) _userSelectedDuringPlayback = true;
    var altDup = e.altKey;
    var dragClip = clip;
    if (altDup) {
      pushUndo();
      var ex = getExercise(clip.dataset.exerciseId);
      if (ex) {
        var clone = createClipElement(ex, clip.style.left, clip.style.width, {
          sets: clip.dataset.sets, reps: clip.dataset.reps, tempo: clip.dataset.tempo,
          rest: clip.dataset.rest, rpe: clip.dataset.rpe,
          fadeIn: clip.dataset.fadeIn || '0', fadeOut: clip.dataset.fadeOut || '0'
        });
        if (clip.dataset.notes) clone.dataset.notes = clip.dataset.notes;
        if (clip.dataset.customColor) {
          clone.dataset.customColor = clip.dataset.customColor;
          clone.style.background = 'linear-gradient(180deg, ' + clip.dataset.customColor + '44 0%, ' + clip.dataset.customColor + '22 100%)';
          clone.style.borderTopColor = clip.dataset.customColor;
        }
        clip.parentElement.appendChild(clone);
        dragClip = clone;
        selectClipEl(clone, false);
      }
    } else {
      selectClipEl(clip, e.shiftKey);
    }
    var startX = e.clientX, startLeft = parseInt(dragClip.style.left);
    var groupSibs = altDup ? [] : getGroupSiblings(dragClip);
    var sibStarts = groupSibs.map(function(s) { return {el: s, left: parseInt(s.style.left) || 0}; });
    dragClip.classList.add('clip-dragging');
    function onMove(e) {
      var delta = e.clientX - startX;
      var newLeft = Math.max(0, startLeft + delta);
      newLeft = snapValue(newLeft);
      if (snapEnabled) {
        var clipW = parseInt(dragClip.style.width) || 80;
        var rightEdge = newLeft + clipW;
        var threshold = 6;
        var neighbors = dragClip.parentElement.querySelectorAll('.clip');
        for (var si = 0; si < neighbors.length; si++) {
          if (neighbors[si] === dragClip || groupSibs.indexOf(neighbors[si]) !== -1) continue;
          var sL = parseInt(neighbors[si].style.left) || 0;
          var sR = sL + (parseInt(neighbors[si].style.width) || 80);
          if (Math.abs(newLeft - sR) < threshold) { newLeft = sR; break; }
          if (Math.abs(rightEdge - sL) < threshold) { newLeft = sL - clipW; break; }
          if (Math.abs(newLeft - sL) < threshold) { newLeft = sL; break; }
          if (Math.abs(rightEdge - sR) < threshold) { newLeft = sR - clipW; break; }
        }
      }
      dragClip.style.left = Math.max(0, newLeft) + 'px';
      var actualDelta = (parseInt(dragClip.style.left) || 0) - startLeft;
      sibStarts.forEach(function(s) {
        if (s.el === dragClip) return;
        s.el.style.left = Math.max(0, s.left + actualDelta) + 'px';
      });
    }
    function onUp() {
      dragClip.classList.remove('clip-dragging');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      if (altDup) toast('Duplicated');
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Resize clip (stretching shows duration + redraws waveform)
  resize.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      var newW = Math.max(40, startW + e.clientX - startX);
      newW = snapEnabled ? Math.max(40, snapValue(newW)) : newW;
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, waveColor, newW + 'px', waveOpacity, parseInt(clip.dataset.rpe) || 7);
      addBeatMarkers(clip, newW);
      var durSec = Math.round(newW / 80 * 15);
      var durM = Math.floor(durSec / 60);
      var durS = durSec % 60;
      var durStr = durM > 0 ? durM + ':' + durS.toString().padStart(2,'0') : durSec + 's';
      clip.title = exercise.name + ' - ' + durStr;
      info.textContent = durStr;
      updateStats();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      var finSec = Math.round(parseInt(clip.style.width) / 80 * 15);
      info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps + ' ' + finSec + 's';
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Right-click context menu (Premiere Pro style)
  clip.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    selectClipEl(clip);
    showClipContextMenu(e.clientX, e.clientY, clip, exercise);
  });

  // Touch drag support
  clip.addEventListener('touchstart', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    selectClipEl(clip);
    var touch = e.touches[0];
    var startX = touch.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) { e.preventDefault(); clip.style.left = Math.max(0, startLeft + e.touches[0].clientX - startX) + 'px'; }
    function onEnd() { clip.removeEventListener('touchmove', onMove); clip.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    clip.addEventListener('touchmove', onMove, {passive: false});
    clip.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Touch resize support
  resize.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    var touch = e.touches[0];
    var startX = touch.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      e.preventDefault();
      var newW = Math.max(40, startW + e.touches[0].clientX - startX);
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, waveColor, newW + 'px', waveOpacity, parseInt(clip.dataset.rpe) || 7);
      addBeatMarkers(clip, newW);
      updateStats();
    }
    function onEnd() { resize.removeEventListener('touchmove', onMove); resize.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    resize.addEventListener('touchmove', onMove, {passive: false});
    resize.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Double click / double tap to delete
  var lastTap = 0;
  clip.addEventListener('touchend', function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      clip.remove();
      if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      toast('Clip removed');
    }
    lastTap = now;
  });
  clip.addEventListener('dblclick', function() {
    pushUndo();
    clip.remove();
    if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
    updateStats(); saveSession();
    sfx('delete');
    toast('Clip removed');
  });

  if (typeof showClipDetail === 'function') showClipDetail(clip);
  return clip;
}

function addClip(track, exercise, x) {
  pushUndo();
  var clip = createClipElement(exercise, x, 80);
  track.appendChild(clip);
  selectClipEl(clip);
  if (typeof addToRecent === 'function') addToRecent(exercise.id);
  updateStats();
  saveSession();
  sfx('drop');
  toast(exercise.name + ' added');
}

function selectClipEl(clip, addToSelection) {
  if (!addToSelection) {
    document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  }
  clip.classList.add('selected');
  selectedClip = clip;
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  var ex = getExercise(clip.dataset.exerciseId);
  if (!ex) return;
  var insp = document.getElementById('inspector');
  insp.style.display = '';
  // Auto-switch to inspector tab
  switchPanelTab('inspector-tab');
  document.getElementById('insp-name').textContent = ex.name;
  document.getElementById('insp-pattern').textContent = ex.pattern;
  document.getElementById('insp-stage').textContent = 'Stage ' + ex.stage + ' - ' + ex.discipline;
  document.getElementById('insp-discipline').textContent = ex.discipline;
  document.getElementById('insp-sets').value = clip.dataset.sets || 3;
  document.getElementById('insp-reps').value = clip.dataset.reps || 8;
  document.getElementById('insp-tempo').value = clip.dataset.tempo || 3;
  document.getElementById('insp-rest').value = clip.dataset.rest || 60;
  document.getElementById('insp-rpe').value = clip.dataset.rpe || 7;
  var fm = FAMILY_MAP[ex.family] || {};
  var tagHtml =
    '<span class="inspector-tag" style="background:'+((FAMILY_MAP[ex.family]||{}).color||'#666')+'22;color:'+(FAMILY_MAP[ex.family]||{}).color+'">'+ex.family+'</span>' +
    '<span class="inspector-tag">'+(fm.instrument||'')+'</span>' +
    '<span class="inspector-tag">S'+ex.stage+'</span>' +
    (ex.discipline ? '<span class="inspector-tag" style="background:rgba(59,130,246,0.1);color:rgba(147,197,253,0.8)">'+ex.discipline+'</span>' : '') +
    (ex.pattern ? '<span class="inspector-tag" style="background:rgba(168,85,247,0.1);color:rgba(196,181,253,0.7)">'+ex.pattern+'</span>' : '');
  if (clip.classList.contains('clip-locked')) {
    tagHtml += '<span class="inspector-tag" style="background:rgba(239,68,68,0.12);color:#ef4444">LOCKED</span>';
  }
  document.getElementById('insp-tags').innerHTML = tagHtml;
  document.getElementById('insp-notes').value = clip.dataset.notes || '';
  updateInspectorTime();
  updateProgressionChain(ex);
  syncInspectorLockBtn();
  updateRpeColor();
  // Auto-scroll timeline to show selected clip
  scrollToClip(clip);
}

function scrollToClip(clip) {
  var container = document.getElementById('timeline-container');
  if (!container) return;
  var clipLeft = parseInt(clip.style.left) || 0;
  var clipW = parseInt(clip.style.width) || 80;
  var scale = zoomLevel / 100;
  var clipMid = clipLeft * scale;
  var vpLeft = container.scrollLeft;
  var vpW = container.clientWidth;
  // Only scroll if clip is out of view
  if (clipMid < vpLeft + 120 || clipMid + clipW * scale > vpLeft + vpW - 20) {
    container.scrollLeft = Math.max(0, clipMid - vpW / 3);
  }
}

function updateProgressionChain(exercise) {
  var container = document.getElementById('insp-progression');
  if (!container) return;
  // Find same pattern, different stages
  var siblings = EXERCISES.filter(function(e) {
    return e.pattern === exercise.pattern && e.name !== exercise.name;
  });
  if (siblings.length === 0) { container.style.display = 'none'; return; }
  container.style.display = '';
  var all = [exercise].concat(siblings).sort(function(a, b) { return a.stage - b.stage; });
  var html = '<div style="font-size:7px;color:var(--micro);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px">Progression</div>';
  html += '<div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">';
  all.forEach(function(e, i) {
    var isCurrent = (e.id === exercise.id);
    var fm = FAMILY_MAP[e.family] || {color:'#666'};
    html += '<div style="font-size:8px;padding:2px 6px;border-radius:3px;cursor:'+(isCurrent?'default':'pointer')+';' +
      'background:'+(isCurrent ? fm.color+'33' : 'rgba(255,255,255,0.03)')+';' +
      'color:'+(isCurrent ? fm.color : 'var(--muted)')+';' +
      'border:1px solid '+(isCurrent ? fm.color+'44' : 'var(--border)')+';' +
      'font-weight:'+(isCurrent ? '600' : '400')+'"' +
      (isCurrent ? '' : ' onclick="swapClipExercise(\''+e.id+'\')"') +
      ' data-tip="'+e.name+' (S'+e.stage+')">' +
      'S' + e.stage + '</div>';
    if (i < all.length - 1) html += '<span style="font-size:7px;color:var(--micro)">&rarr;</span>';
  });
  html += '</div>';
  container.innerHTML = html;
}

function swapClipExercise(newExId) {
  if (!selectedClip) return;
  var ex = getExercise(newExId);
  if (!ex) return;
  pushUndo();
  selectedClip.dataset.exerciseId = ex.id;
  var label = selectedClip.querySelector('.clip-name');
  if (label) label.textContent = ex.name;
  var fm = FAMILY_MAP[ex.family] || {color:'#666'};
  selectedClip.style.borderTopColor = fm.color;
  // Update background unless custom color
  if (!selectedClip.dataset.customColor) {
    var rpeVal = parseInt(selectedClip.dataset.rpe || '7');
    var stageBase = ex.stage === 1 ? 170 : ex.stage === 2 ? 200 : 230;
    var rpeBoost = Math.round((rpeVal / 10) * 25);
    var alphaTop = Math.min(255, stageBase + rpeBoost).toString(16).padStart(2, '0');
    var alphaBot = Math.min(255, 130 + rpeBoost).toString(16).padStart(2, '0');
    selectedClip.style.background = 'linear-gradient(180deg, ' + fm.color + alphaTop + ' 0%, ' + fm.color + alphaBot + ' 100%)';
  }
  // Update stage dots
  var dotsEl = selectedClip.querySelector('.clip-stage-dots');
  if (dotsEl) {
    var dots = dotsEl.querySelectorAll('.clip-stage-dot');
    dots.forEach(function(d, i) { d.classList.toggle('filled', i < ex.stage); });
  }
  // Re-draw waveform
  var canvas = selectedClip.querySelector('.clip-waveform');
  if (canvas) {
    var waveOpacity = ex.stage === 1 ? 0.35 : ex.stage === 2 ? 0.5 : 0.65;
    drawClipWaveform(canvas, fm.color, selectedClip.style.width, waveOpacity, parseInt(selectedClip.dataset.rpe) || 7);
  }
  // Update velocity strip
  updateClipVisuals(selectedClip, parseInt(selectedClip.dataset.rpe) || 7);
  // Re-populate inspector
  selectClipEl(selectedClip);
  saveSession();
  sfx('click');
  toast('Swapped to ' + ex.name + ' (S' + ex.stage + ')');
}

function updateInspectorTime() {
  if (!selectedClip) return;
  var sets = parseInt(selectedClip.dataset.sets) || 3;
  var reps = parseInt(selectedClip.dataset.reps) || 8;
  var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
  var rest = parseInt(selectedClip.dataset.rest) || 60;
  var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
  var tut = sets * reps * tempo;
  var m = Math.floor(totalSec / 60);
  var s = Math.floor(totalSec % 60);
  var etEl = document.getElementById('insp-est-time');
  if (etEl) etEl.textContent = m + ':' + s.toString().padStart(2, '0');
  var tutEl = document.getElementById('insp-tut');
  if (tutEl) tutEl.textContent = tut + 's';
}

function updateClipDNA() {
  if (!selectedClip) return;
  selectedClip.dataset.sets = document.getElementById('insp-sets').value;
  selectedClip.dataset.reps = document.getElementById('insp-reps').value;
  selectedClip.dataset.tempo = document.getElementById('insp-tempo').value;
  selectedClip.dataset.rest = document.getElementById('insp-rest').value;
  selectedClip.dataset.rpe = document.getElementById('insp-rpe').value;
  var info = selectedClip.querySelector('.clip-info');
  if (info) {
    var infoSec = Math.round(parseInt(selectedClip.style.width) / 80 * 15);
    info.textContent = selectedClip.dataset.sets + 'x' + selectedClip.dataset.reps + ' ' + infoSec + 's';
  }
  // If tempo linked, update clip width based on exercise duration
  if (tempoLinked) {
    var sets = parseInt(selectedClip.dataset.sets) || 3;
    var reps = parseInt(selectedClip.dataset.reps) || 8;
    var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
    var rest = parseInt(selectedClip.dataset.rest) || 60;
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var pps = 80 / 15;
    selectedClip.style.width = Math.max(40, totalSec * pps) + 'px';
    updateStats();
  }
  var rpeBadge = selectedClip.querySelector('.clip-rpe-badge');
  if (rpeBadge) rpeBadge.textContent = selectedClip.dataset.rpe;
  updateInspectorTime();
  saveSession();
}

function updateClipNotes() {
  if (!selectedClip) return;
  selectedClip.dataset.notes = document.getElementById('insp-notes').value;
  saveSession();
}

function updateRpeColor() {
  var rpe = parseInt(document.getElementById('insp-rpe').value) || 7;
  var valEl = document.getElementById('insp-rpe-val');
  if (valEl) {
    valEl.textContent = rpe;
    var colors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
    valEl.style.color = colors[rpe - 1] || '#eab308';
  }
}

function toggleInspectorLock() {
  if (!selectedClip) return;
  pushUndo();
  selectedClip.classList.toggle('clip-locked');
  selectedClip.dataset.locked = selectedClip.classList.contains('clip-locked') ? '1' : '';
  saveSession();
  syncInspectorLockBtn();
  toast(selectedClip.classList.contains('clip-locked') ? 'Clip locked' : 'Clip unlocked');
}

function syncInspectorLockBtn() {
  var btn = document.getElementById('insp-lock-btn');
  if (!btn || !selectedClip) return;
  var locked = selectedClip.classList.contains('clip-locked');
  btn.textContent = locked ? 'UNLOCK' : 'LOCK';
  btn.style.color = locked ? 'var(--accent-red)' : '';
}

function updateSummary() {
  var clips = document.querySelectorAll('.clip');
  var panel = document.getElementById('workout-summary');
  if (clips.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = '';
  var totalSets = 0, totalReps = 0, totalDur = 0, exerciseSet = {};
  var familyCounts = {};
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    totalSets += sets;
    totalReps += sets * reps;
    totalDur += (sets * reps * tempo) + ((sets - 1) * rest);
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exerciseSet[ex.id] = true;
      familyCounts[ex.family] = (familyCounts[ex.family] || 0) + 1;
    }
  });
  document.getElementById('sum-sets').textContent = totalSets;
  document.getElementById('sum-reps').textContent = totalReps;
  var durM = Math.floor(totalDur / 60);
  var durS = Math.floor(totalDur % 60);
  document.getElementById('sum-duration').textContent = durM + ':' + durS.toString().padStart(2, '0');
  document.getElementById('sum-exercises').textContent = Object.keys(exerciseSet).length;
  // Balance bars
  var maxCount = 1;
  var families = ['Push','Pull','Core','Legs','Skills','Flow'];
  families.forEach(function(f) { if ((familyCounts[f] || 0) > maxCount) maxCount = familyCounts[f]; });
  var barsHtml = '', labelsHtml = '';
  families.forEach(function(f) {
    var count = familyCounts[f] || 0;
    var fm = FAMILY_MAP[f] || {color:'#666'};
    var h = count > 0 ? Math.max(4, (count / maxCount) * 20) : 2;
    barsHtml += '<div style="flex:1;height:'+h+'px;background:'+fm.color+';border-radius:1px;opacity:'+(count > 0 ? 1 : 0.2)+'"></div>';
    labelsHtml += '<div style="flex:1;font-size:6px;color:var(--micro);text-align:center">'+f.charAt(0)+'</div>';
  });
  document.getElementById('balance-bars').innerHTML = barsHtml;
  document.getElementById('balance-labels').innerHTML = labelsHtml;
  // Footer family balance minibar
  var footerBar = document.getElementById('footer-balance');
  if (footerBar) {
    var total = clips.length || 1;
    var fbHtml = '';
    families.forEach(function(f) {
      var count = familyCounts[f] || 0;
      var pct = (count / total) * 100;
      if (pct > 0) {
        fbHtml += '<div style="flex:' + pct + ';background:' + (FAMILY_MAP[f] || {color:'#666'}).color + '"></div>';
      }
    });
    footerBar.innerHTML = fbHtml || '<div style="flex:1;background:var(--border)"></div>';
  }
}

function updateClipInfo(clip) {
  if (!clip) return;
  var infoEl = clip.querySelector('.clip-info');
  if (!infoEl) return;
  var sets = clip.dataset.sets || 3;
  var reps = clip.dataset.reps || 8;
  var clipSec = Math.round(parseInt(clip.style.width) / 80 * 15);
  infoEl.textContent = sets + 'x' + reps + ' ' + clipSec + 's';
}

function updateStats() {
  var clips = document.querySelectorAll('.clip');
  document.getElementById('clip-count').textContent = clips.length;
  var maxRight = 0;
  var trackCounts = {};
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
    var tid = c.parentElement.dataset.track;
    trackCounts[tid] = (trackCounts[tid] || 0) + 1;
  });
  var secs = Math.round(maxRight / 80 * 15);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  document.getElementById('total-duration').textContent = m + ':' + s.toString().padStart(2, '0');
  // Estimated workout time (sets x reps x tempo + rest between sets)
  var estTotalSec = 0;
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    estTotalSec += sets * (reps * tempo + rest) - rest;
  });
  var estMin = Math.floor(estTotalSec / 60);
  var estSec = Math.round(estTotalSec % 60);
  document.getElementById('footer-est-time').textContent = estMin + ':' + estSec.toString().padStart(2, '0');
  // Workout intensity score (0-100)
  var intensityEl = document.getElementById('footer-intensity');
  if (clips.length > 0 && intensityEl) {
    var avgRpe = 0; var totalVolume = 0;
    clips.forEach(function(c) {
      avgRpe += parseInt(c.dataset.rpe) || 7;
      totalVolume += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8);
    });
    avgRpe = avgRpe / clips.length;
    var volScore = Math.min(40, totalVolume / 8);
    var rpeScore = (avgRpe / 10) * 40;
    var familyCount = 0;
    var fams = {};
    clips.forEach(function(c) { var ex = getExercise(c.dataset.exerciseId); if (ex) fams[ex.family] = true; });
    familyCount = Object.keys(fams).length;
    var diversityScore = Math.min(20, familyCount * 4);
    var score = Math.min(100, Math.round(volScore + rpeScore + diversityScore));
    intensityEl.textContent = score;
    intensityEl.style.color = score >= 80 ? '#ef4444' : score >= 60 ? '#f97316' : score >= 40 ? '#eab308' : '#22c55e';
  } else if (intensityEl) {
    intensityEl.textContent = '0';
    intensityEl.style.color = 'var(--muted)';
  }
  // Update total bars in footer
  var bpbF = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var totalBars = Math.ceil(secs / (60 / bpm * bpbF));
  var barsEl = document.getElementById('footer-bars');
  if (barsEl) barsEl.textContent = totalBars + ' bar' + (totalBars !== 1 ? 's' : '');
  // Workout difficulty badge
  var diffEl = document.getElementById('footer-difficulty');
  if (diffEl) {
    if (clips.length > 0) {
      var avgStage = 0;
      clips.forEach(function(c) { var ex = getExercise(c.dataset.exerciseId); avgStage += ex ? ex.stage : 1; });
      avgStage = avgStage / clips.length;
      var diffLabel = avgStage < 1.5 ? 'BEGINNER' : avgStage < 2.5 ? 'INTERMEDIATE' : 'ADVANCED';
      var diffColor = avgStage < 1.5 ? '#22c55e' : avgStage < 2.5 ? '#eab308' : '#ef4444';
      diffEl.textContent = diffLabel;
      diffEl.style.color = diffColor;
    } else {
      diffEl.textContent = '';
    }
  }
  // Locked clips count
  var lockedEl = document.getElementById('footer-locked');
  if (lockedEl) {
    var lockedCount = document.querySelectorAll('.clip.clip-locked').length;
    lockedEl.textContent = lockedCount > 0 ? lockedCount + ' locked' : '';
  }
  // Track mute/solo indicator
  var tsEl = document.getElementById('footer-track-state');
  if (tsEl) {
    var mutedTracks = document.querySelectorAll('.track.track-muted').length;
    var soloedTracks = document.querySelectorAll('.track.track-soloed').length;
    var parts = [];
    if (soloedTracks > 0) parts.push(soloedTracks + ' solo');
    if (mutedTracks > 0) parts.push(mutedTracks + ' muted');
    tsEl.textContent = parts.join(' ');
    tsEl.style.color = soloedTracks > 0 ? 'rgba(234,179,8,0.8)' : mutedTracks > 0 ? 'rgba(239,68,68,0.6)' : '';
  }
  // Update per-track clip counts
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    var el = document.getElementById('track-count-' + t.id);
    var count = trackCounts[t.id] || 0;
    if (el) {
      el.textContent = count + ' clip' + (count !== 1 ? 's' : '');
      el.style.color = count === 0 ? 'var(--micro)' : count >= 3 ? 'var(--text-secondary)' : 'var(--muted)';
    }
  });
  // Detect clip overlaps per track
  var prevOverlapCount = document.querySelectorAll('.clip.clip-overlap').length;
  document.querySelectorAll('.track-content').forEach(function(tc) {
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    trackClips.forEach(function(c) { c.classList.remove('clip-overlap'); c.classList.remove('clip-overlap-flash'); });
    for (var i = 0; i < trackClips.length; i++) {
      var aL = parseInt(trackClips[i].style.left) || 0;
      var aR = aL + (parseInt(trackClips[i].style.width) || 80);
      for (var j = i + 1; j < trackClips.length; j++) {
        var bL = parseInt(trackClips[j].style.left) || 0;
        var bR = bL + (parseInt(trackClips[j].style.width) || 80);
        if (aR > bL && bR > aL) {
          trackClips[i].classList.add('clip-overlap');
          trackClips[j].classList.add('clip-overlap');
        }
      }
    }
  });
  var newOverlapCount = document.querySelectorAll('.clip.clip-overlap').length;
  if (newOverlapCount > 0 && newOverlapCount > prevOverlapCount) {
    document.querySelectorAll('.clip.clip-overlap').forEach(function(c) { c.classList.add('clip-overlap-flash'); });
    toast('Overlapping clips detected (' + newOverlapCount + ')');
  }
  // Cross-track superset detection
  var allClipEls = Array.from(document.querySelectorAll('.clip'));
  allClipEls.forEach(function(c) { c.classList.remove('clip-superset'); });
  var supersetCount = 0;
  for (var si = 0; si < allClipEls.length; si++) {
    var aTrack = allClipEls[si].parentElement.dataset.track;
    var aL = parseInt(allClipEls[si].style.left) || 0;
    var aR = aL + (parseInt(allClipEls[si].style.width) || 80);
    for (var sj = si + 1; sj < allClipEls.length; sj++) {
      var bTrack = allClipEls[sj].parentElement.dataset.track;
      if (bTrack === aTrack) continue;
      var bL = parseInt(allClipEls[sj].style.left) || 0;
      var bR = bL + (parseInt(allClipEls[sj].style.width) || 80);
      if (aR > bL && bR > aL) {
        allClipEls[si].classList.add('clip-superset');
        allClipEls[sj].classList.add('clip-superset');
        supersetCount++;
      }
    }
  }
  var ssEl = document.getElementById('footer-supersets');
  if (ssEl) ssEl.textContent = supersetCount > 0 ? supersetCount + ' SS' : '';
  updateSummary();
  updateMinimap();
  updateEmptyState();
  if (typeof updateTrackVolumeBars === 'function') updateTrackVolumeBars();
}

/* ===== MINI-MAP ===== */
function updateMinimap() {
  var minimap = document.getElementById('timeline-minimap');
  var mapW = minimap.clientWidth;
  if (mapW === 0) return;
  // Calculate total timeline width from clips
  var maxRight = 600; // minimum extent
  var clips = document.querySelectorAll('.clip');
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var totalW = maxRight + 200; // padding
  var scale = mapW / totalW;
  // Draw mini clips
  var trackOffsets = {push:0,pull:1,core:2,legs:3,skills:4};
  var trackH = 3;
  var html = '';
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    var row = trackOffsets[tid];
    if (row === undefined) return;
    var x = parseInt(c.style.left) * scale;
    var w = Math.max(2, parseInt(c.style.width) * scale);
    var top = 1 + row * (trackH + 1);
    var ex = getExercise(c.dataset.exerciseId);
    var color = ex ? (FAMILY_MAP[ex.family] || {color:'#666'}).color : '#666';
    html += '<div class="minimap-clip" style="left:'+x+'px;width:'+w+'px;top:'+top+'px;background:'+color+'"></div>';
  });
  // Loop region overlay on minimap
  if (loopEnabled) {
    var ppsM = 80 / 15;
    var lLeft = (100 + loopStart * ppsM) * scale;
    var lWidth = (loopEnd - loopStart) * ppsM * scale;
    html += '<div style="position:absolute;top:0;bottom:0;left:'+lLeft+'px;width:'+lWidth+'px;background:rgba(59,130,246,0.12);border-left:1px solid rgba(59,130,246,0.4);border-right:1px solid rgba(59,130,246,0.4);pointer-events:none;z-index:1"></div>';
  }
  // Marker dots on minimap
  markers.forEach(function(m) {
    var mX = (100 + m.time * (80 / 15)) * scale;
    html += '<div style="position:absolute;top:0;width:1px;height:100%;background:rgba(249,115,22,0.5);left:'+mX+'px;pointer-events:none;z-index:2"></div>';
  });
  // Keep viewport indicator
  var container = document.getElementById('timeline-container');
  var vpLeft = container.scrollLeft * scale;
  var vpW = container.clientWidth * scale;
  html += '<div class="minimap-viewport" style="left:'+vpLeft+'px;width:'+vpW+'px"></div>';
  // Minimap playhead with glow during playback
  var pps = 80 / 15;
  var phX = (100 + currentTime * pps) * scale;
  html += '<div class="minimap-playhead'+(isPlaying?' playing':'')+'" style="left:'+phX+'px"></div>';
  // Remove old viewport element since we're regenerating
  var oldVp = document.getElementById('minimap-viewport');
  if (oldVp) oldVp.remove();
  minimap.innerHTML = html;
}

/* Click/drag on minimap to scroll */
document.addEventListener('DOMContentLoaded', function() {
  var minimap = document.getElementById('timeline-minimap');
  function minimapScrollTo(clientX) {
    var rect = minimap.getBoundingClientRect();
    var clickX = clientX - rect.left;
    var ratio = Math.max(0, Math.min(1, clickX / rect.width));
    var maxRight = 600;
    document.querySelectorAll('.clip').forEach(function(c) {
      var r = parseInt(c.style.left) + parseInt(c.style.width);
      if (r > maxRight) maxRight = r;
    });
    var totalW = maxRight + 200;
    var container = document.getElementById('timeline-container');
    container.scrollLeft = ratio * totalW - container.clientWidth / 2;
    // Also seek playhead to this position
    var pps = 80 / 15;
    currentTime = Math.max(0, (ratio * totalW) / pps);
    updateTimeDisplay();
    updatePlayheadPosition();
    updateMinimap();
  }
  minimap.addEventListener('mousedown', function(e) {
    e.preventDefault();
    minimap.style.cursor = 'grabbing';
    minimapScrollTo(e.clientX);
    function onMove(ev) { minimapScrollTo(ev.clientX); }
    function onUp() {
      minimap.style.cursor = '';
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Update minimap on scroll */
  document.getElementById('timeline-container').addEventListener('scroll', function() {
    updateMinimap();
  });
});

/* ===== TRANSPORT ===== */
var playStartTime = 0; /* Where playback began, for return-to-start */
function togglePlay() {
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) {
    playStartTime = currentTime;
    _userSelectedDuringPlayback = false;
    btn.classList.add('active');
    btn.innerHTML = '&#9616;&#9616;';
    playInterval = setInterval(updatePlayhead, 50);
    startMeters();
    document.getElementById('status-text').textContent = 'Playing';
    var psEl = document.getElementById('playback-state');
    psEl.textContent = 'PLAY';
    psEl.className = 'transport-state state-play';
    updatePlayheadClass();
    updateStatusDot();
    sfx('play');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#9654;';
    clearInterval(playInterval);
    stopMeters();
    document.getElementById('status-text').textContent = 'Paused';
    var psEl2 = document.getElementById('playback-state');
    psEl2.textContent = 'PAUSE';
    psEl2.className = 'transport-state state-stop';
    updatePlayheadClass();
    updateStatusDot();
    sfx('click');
  }
}

var _lastStopTime = 0;
function stopPlayback() {
  isPlaying = false;
  var now = Date.now();
  // Double-stop: if stopped within 400ms and already at start, go to 0
  if (currentTime === (playStartTime || 0) && now - _lastStopTime < 400) {
    currentTime = 0;
    playStartTime = 0;
  } else {
    currentTime = playStartTime || 0;
  }
  _lastStopTime = now;
  var btn = document.getElementById('play-btn');
  btn.classList.remove('active');
  btn.innerHTML = '&#9654;';
  clearInterval(playInterval);
  stopMeters();
  updateTimeDisplay();
  updatePlayheadPosition();
  updatePlayheadClass();
  // Clear all clip playing states and progress
  document.querySelectorAll('.clip').forEach(function(c) {
    c.classList.remove('clip-playing');
    var p = c.querySelector('.clip-progress');
    if (p) p.style.width = '0';
    var pf = c.querySelector('.clip-progress-fill');
    if (pf) pf.style.width = '0';
  });
  document.getElementById('status-text').textContent = 'Ready';
  var psStop = document.getElementById('playback-state');
  psStop.textContent = 'STOP';
  psStop.className = 'transport-state state-stop';
  updateStatusDot();
  // Reset beat dots
  for (var d = 1; d <= 4; d++) {
    var dot = document.getElementById('beat-' + d);
    if (dot) dot.style.background = 'rgba(255,255,255,0.1)';
  }
  sfx('stop');
}

function rewind() { currentTime = Math.max(0, currentTime - 15); updateTimeDisplay(); updatePlayheadPosition(); }
function forward() { currentTime += 15; updateTimeDisplay(); updatePlayheadPosition(); }

function updatePlayhead() {
  currentTime += 0.05 * playbackSpeed;
  // Loop boundary check
  if (loopEnabled && currentTime >= loopEnd) {
    currentTime = loopStart;
    beatCounter = Math.floor(currentTime / (60 / bpm));
  }
  updateTimeDisplay();
  updatePlayheadPosition();
  // Beat tracking — visual dots + metronome
  var beatInterval = 60 / bpm;
  var currentBeat = Math.floor(currentTime / beatInterval);
  if (currentBeat > beatCounter) {
    beatCounter = currentBeat;
    if (metronomeEnabled) sfx('metronome');
    // Animate beat dots (1-4, wraps with time sig)
    var bpbDots = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
    var dotIdx = (beatCounter % bpbDots) + 1;
    for (var d = 1; d <= 4; d++) {
      var dot = document.getElementById('beat-' + d);
      if (dot) {
        if (d <= bpbDots) {
          dot.style.background = (d === dotIdx) ? 'var(--accent-cyan)' : 'rgba(255,255,255,0.1)';
          dot.style.display = '';
        } else {
          dot.style.display = 'none';
        }
      }
    }
  }
}

function updateTimeDisplay() {
  var mins = Math.floor(currentTime / 60);
  var secs = Math.floor(currentTime % 60);
  var ms = Math.floor((currentTime % 1) * 100);
  document.getElementById('td-min').textContent = mins.toString().padStart(2, '0');
  document.getElementById('td-sec').textContent = secs.toString().padStart(2, '0');
  document.getElementById('td-ms').textContent = ms.toString().padStart(2, '0');
  // Update bars:beats:ticks in footer and transport
  var beatDuration = 60 / bpm;
  var totalBeats = currentTime / beatDuration;
  var bar = Math.floor(totalBeats / 4) + 1;
  var beat = Math.floor(totalBeats % 4) + 1;
  var tick = Math.floor((totalBeats % 1) * 4) + 1;
  var bbStr = bar + '.' + beat + '.' + tick;
  var posEl = document.getElementById('footer-pos');
  if (posEl) {
    if (typeof footerMode !== 'undefined' && footerMode === 'time') {
      var tm = Math.floor(currentTime / 60);
      var ts = Math.floor(currentTime % 60);
      var tms = Math.floor((currentTime % 1) * 100);
      posEl.textContent = tm + ':' + ts.toString().padStart(2,'0') + '.' + tms.toString().padStart(2,'0');
    } else {
      posEl.textContent = bbStr;
    }
  }
  var barsDisp = document.getElementById('bars-display');
  if (barsDisp) barsDisp.textContent = bbStr;
  // Update beat indicator dots (1-4)
  for (var bi = 1; bi <= 4; bi++) {
    var dot = document.getElementById('beat-' + bi);
    if (dot) {
      if (bi === beat && isPlaying) {
        dot.style.background = bi === 1 ? 'var(--accent-green)' : 'var(--accent-blue)';
        dot.style.boxShadow = '0 0 4px ' + (bi === 1 ? 'rgba(34,197,94,0.4)' : 'rgba(59,130,246,0.4)');
      } else {
        dot.style.background = 'rgba(255,255,255,0.1)';
        dot.style.boxShadow = 'none';
      }
    }
  }
  // Remaining time display (shows during playback)
  var remEl = document.getElementById('remaining-time');
  if (remEl) {
    if (isPlaying) {
      var maxR = 0;
      document.querySelectorAll('.clip').forEach(function(c) {
        var r = (parseInt(c.style.left) + parseInt(c.style.width) - 100) / (80 / 15);
        if (r > maxR) maxR = r;
      });
      var remaining = Math.max(0, maxR - currentTime);
      var rm = Math.floor(remaining / 60);
      var rs = Math.floor(remaining % 60);
      remEl.textContent = '-' + rm + ':' + rs.toString().padStart(2, '0');
      remEl.style.opacity = '0.6';
    } else {
      remEl.style.opacity = '0';
    }
  }
}

function updatePlayheadPosition() {
  var pps = 80 / 15;
  var pos = 100 + currentTime * pps;
  document.getElementById('playhead').style.left = pos + 'px';
  // Auto-scroll timeline during playback (respects settings)
  if (isPlaying) {
    if (typeof autoScrollEnabled === 'undefined' || autoScrollEnabled) {
      var container = document.getElementById('timeline-container');
      var visibleRight = container.scrollLeft + container.clientWidth;
      if (pos > visibleRight - 60) {
        container.scrollLeft = pos - 200;
      }
    }
    // Update clip progress overlays and playing state (mute/solo aware)
    var hasSoloTrack = !!document.querySelector('.track-btn.soloed');
    document.querySelectorAll('.clip').forEach(function(clip) {
      var track = clip.closest('.track');
      var isMuted = track && track.classList.contains('track-muted');
      var isSoloed = track && track.classList.contains('track-soloed');
      var isActive = hasSoloTrack ? isSoloed : !isMuted;
      var clipLeft = parseInt(clip.style.left) + 100;
      var clipW = parseInt(clip.style.width);
      var clipRight = clipLeft + clipW;
      var progressEl = clip.querySelector('.clip-progress');
      var fillEl = clip.querySelector('.clip-progress-fill');
      if (isActive && pos >= clipLeft && pos <= clipRight) {
        var pct = ((pos - clipLeft) / clipW) * 100;
        if (progressEl) progressEl.style.width = pct + '%';
        if (fillEl) fillEl.style.width = pct + '%';
        if (!clip.classList.contains('clip-playing')) {
          clip.classList.add('clip-playing');
          if (!_userSelectedDuringPlayback) selectClipEl(clip, false);
        }
      } else {
        var done = isActive && pos > clipRight;
        if (progressEl) progressEl.style.width = done ? '100%' : '0';
        if (fillEl) fillEl.style.width = done ? '100%' : '0';
        clip.classList.remove('clip-playing');
      }
    });
  }
  // Update header progress bar
  var hpBar = document.getElementById('header-progress');
  if (hpBar) {
    if (isPlaying) {
      var maxRight = 600;
      document.querySelectorAll('.clip').forEach(function(c) {
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      var pct = Math.min(100, ((pos - 100) / maxRight) * 100);
      hpBar.style.width = pct + '%';
      hpBar.classList.add('active');
    } else {
      hpBar.classList.remove('active');
    }
  }
}

function toggleRec() {
  isRecording = !isRecording;
  var btn = document.getElementById('rec-btn');
  btn.classList.toggle('active', isRecording);
  document.getElementById('status-text').textContent = isRecording ? 'Recording' : 'Ready';
  var psRec = document.getElementById('playback-state');
  if (isRecording) {
    psRec.textContent = 'REC';
    psRec.className = 'transport-state state-rec';
  } else {
    psRec.textContent = isPlaying ? 'PLAY' : 'STOP';
    psRec.className = 'transport-state ' + (isPlaying ? 'state-play' : 'state-stop');
  }
  updateStatusDot();
  sfx(isRecording ? 'rec' : 'click');
}

/* ===== BPM ===== */
function updateBPM() {
  bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  updateBPMMode();
  buildRuler();
  saveSession();
  // Flash BPM input on change
  var bpmEl = document.getElementById('bpm-input');
  bpmEl.classList.remove('flash');
  void bpmEl.offsetWidth; // force reflow
  bpmEl.classList.add('flash');
  // Update BPM pulse animation speed
  var pulseDuration = (60 / bpm).toFixed(3);
  var pulse = document.getElementById('bpm-pulse');
  if (pulse) pulse.style.setProperty('--bpm-duration', pulseDuration + 's');
  // If tempo-linked, adjust exercise tempos AND music playback rate
  if (tempoLinked) {
    var repTempo = 60 / bpm;
    document.getElementById('insp-tempo').value = repTempo.toFixed(1);
    if (selectedClip) {
      selectedClip.dataset.tempo = repTempo.toFixed(1);
      updateClipDNA();
    }
    // Adjust music playback rate: 120 BPM = 1.0x, scale proportionally
    if (audioEl) {
      var rate = Math.max(0.5, Math.min(2.0, bpm / 120));
      audioEl.playbackRate = rate;
    }
    toast('Tempo linked: ' + repTempo.toFixed(1) + 's/rep, music ' + (bpm / 120).toFixed(2) + 'x');
  } else {
    // Reset music to normal speed when unlinked
    if (audioEl) audioEl.playbackRate = 1.0;
  }
}

function updateBPMMode() {
  var mode = 'Standard';
  for (var i = 0; i < BPM_MODES.length; i++) {
    if (bpm >= BPM_MODES[i].min && bpm < BPM_MODES[i].max) {
      mode = BPM_MODES[i].name;
      break;
    }
  }
  if (bpm >= 200) mode = 'Explosive';
  var el = document.getElementById('bpm-mode');
  el.textContent = mode;
  // Dynamic color by mode
  var modeColors = {'Slow Strength':['59,130,246','#3b82f6'],'Standard':['139,92,246','#8b5cf6'],'Flow State':['249,115,22','#f97316'],'Explosive':['239,68,68','#ef4444']};
  var mc = modeColors[mode] || ['139,92,246','#8b5cf6'];
  el.style.background = 'rgba(' + mc[0] + ',0.08)';
  el.style.borderColor = 'rgba(' + mc[0] + ',0.15)';
  el.style.color = mc[1];
  // Subtle ambient tint on timeline based on mode
  var timeline = document.getElementById('timeline-tracks');
  if (timeline) timeline.style.boxShadow = 'inset 0 0 80px rgba(' + mc[0] + ',0.015)';
}

function toggleTempoLink() {
  tempoLinked = !tempoLinked;
  var el = document.getElementById('tempo-link');
  el.classList.toggle('active', tempoLinked);
  if (tempoLinked) {
    sfx('click');
    toast('BPM linked to exercise tempo');
    updateBPM();
  } else {
    if (audioEl) audioEl.playbackRate = 1.0;
    sfx('click');
    toast('Tempo unlinked');
  }
}

/* Tap Tempo — tap rhythm to set BPM */
var tapTimes = [];
function tapTempo() {
  var now = Date.now();
  tapTimes.push(now);
  // Keep only last 8 taps (last 3 seconds)
  tapTimes = tapTimes.filter(function(t) { return now - t < 3000; });
  if (tapTimes.length >= 2) {
    var intervals = [];
    for (var i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    var avg = intervals.reduce(function(a, b) { return a + b; }, 0) / intervals.length;
    var tapBpm = Math.round(60000 / avg);
    tapBpm = Math.max(40, Math.min(200, tapBpm));
    bpm = tapBpm;
    document.getElementById('bpm-input').value = bpm;
    updateBPM();
    toast('Tap: ' + bpm + ' BPM (' + tapTimes.length + ' taps)');
  } else {
    toast('Tap... (keep tapping)');
  }
  sfx('metronome');
  // Visual feedback on tap button
  var btn = document.getElementById('tap-tempo');
  if (btn) {
    btn.classList.add('active');
    setTimeout(function() { btn.classList.remove('active'); }, 100);
  }
}

var timeSigOptions = ['4/4', '3/4', '6/8', '5/4', '7/8'];
var timeSigIdx = 0;
function getBeatsPerBar() {
  var ts = timeSigOptions[timeSigIdx];
  return parseInt(ts.split('/')[0]) || 4;
}
function cycleTimeSig() {
  timeSigIdx = (timeSigIdx + 1) % timeSigOptions.length;
  document.getElementById('time-sig').textContent = timeSigOptions[timeSigIdx];
  sfx('click');
  buildRuler();
  toast('Time signature: ' + timeSigOptions[timeSigIdx]);
}

function toggleMetronome() {
  metronomeEnabled = !metronomeEnabled;
  beatCounter = Math.floor(currentTime / (60 / bpm));
  var btn = document.getElementById('metro-btn');
  if (btn) {
    btn.classList.toggle('active', metronomeEnabled);
    btn.classList.toggle('metro-active', metronomeEnabled);
  }
  sfx(metronomeEnabled ? 'metronome' : 'click');
  toast(metronomeEnabled ? 'Metronome ON' : 'Metronome OFF');
}

function toggleLoop() {
  loopEnabled = !loopEnabled;
  var btn = document.getElementById('loop-btn');
  if (btn) btn.classList.toggle('active', loopEnabled);
  var region = document.getElementById('loop-region');
  region.classList.toggle('active', loopEnabled);
  if (loopEnabled) {
    updateLoopRegion();
    sfx('click');
    toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
  } else {
    sfx('click');
    toast('Loop OFF');
  }
}

function updateLoopRegion() {
  var pps = 80 / 15;
  var scale = zoomLevel / 100;
  var region = document.getElementById('loop-region');
  region.style.left = (100 * scale + loopStart * pps * scale) + 'px';
  region.style.width = ((loopEnd - loopStart) * pps * scale) + 'px';
}

/* ===== LOOP REGION INTERACTION ===== */
function initLoopDrag() {
  var region = document.getElementById('loop-region');
  var pps = function() { return (80 / 15) * (zoomLevel / 100); };
  var headerOffset = function() { return 100 * (zoomLevel / 100); };
  /* Handle drag (resize loop start/end) */
  region.querySelectorAll('.loop-handle').forEach(function(handle) {
    handle.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      e.preventDefault();
      var side = handle.dataset.side;
      var container = document.getElementById('timeline-container');
      function onMove(e) {
        var rect = document.getElementById('timeline-tracks').getBoundingClientRect();
        var x = e.clientX - rect.left + container.scrollLeft;
        var timeSec = Math.max(0, (x - headerOffset()) / pps());
        if (snapEnabled) {
          var snapSz = getSnapSize();
          var snapPx = Math.round((timeSec * pps()) / snapSz) * snapSz;
          timeSec = snapPx / pps();
        }
        if (side === 'left') {
          loopStart = Math.max(0, Math.min(timeSec, loopEnd - 1));
        } else {
          loopEnd = Math.max(loopStart + 1, timeSec);
        }
        updateLoopRegion();
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
        saveSession();
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
  /* Body drag (move entire loop region) */
  region.querySelector('.loop-body').addEventListener('mousedown', function(e) {
    e.stopPropagation();
    e.preventDefault();
    var container = document.getElementById('timeline-container');
    var startX = e.clientX;
    var origStart = loopStart;
    var origEnd = loopEnd;
    var duration = loopEnd - loopStart;
    function onMove(e) {
      var deltaPx = e.clientX - startX;
      var deltaSec = deltaPx / pps();
      var newStart = Math.max(0, origStart + deltaSec);
      loopStart = newStart;
      loopEnd = newStart + duration;
      updateLoopRegion();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
      saveSession();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

/* Option+drag on ruler to create loop region */
function initRulerLoopDrag() {
  var ruler = document.getElementById('timeline-ruler');
  ruler.addEventListener('mousedown', function(e) {
    if (!e.altKey) return;
    e.preventDefault();
    e.stopPropagation();
    var container = document.getElementById('timeline-container');
    var pps = (80 / 15) * (zoomLevel / 100);
    var ho = 100 * (zoomLevel / 100);
    var rect = ruler.getBoundingClientRect();
    var startX = e.clientX - rect.left + container.scrollLeft;
    var startSec = Math.max(0, (startX - ho) / pps);
    loopStart = startSec;
    loopEnd = startSec;
    loopEnabled = true;
    var btn = document.getElementById('loop-btn');
    if (btn) btn.classList.add('active');
    var region = document.getElementById('loop-region');
    region.classList.add('active');
    updateLoopRegion();
    function onMove(e) {
      var curX = e.clientX - rect.left + container.scrollLeft;
      var curSec = Math.max(0, (curX - ho) / pps);
      if (curSec >= startSec) {
        loopStart = startSec;
        loopEnd = Math.max(startSec + 1, curSec);
      } else {
        loopStart = curSec;
        loopEnd = startSec;
      }
      updateLoopRegion();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      if (loopEnd - loopStart < 1) {
        loopEnd = loopStart + 15;
      }
      updateLoopRegion();
      sfx('click');
      toast('Loop set: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
      saveSession();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

function formatTime(sec) {
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + s.toString().padStart(2, '0');
}

/* ===== FADERS ===== */
function buildFaders() {
  var container = document.getElementById('fader-group');
  var html = '';
  FADERS.forEach(function(f) {
    html += '<div class="fader" data-fader="'+f.id+'">';
    html += '<div class="fader-label">'+f.label+'</div>';
    html += '<div class="fader-track" onmousedown="startFaderDrag(event,\''+f.id+'\')" ontouchstart="startFaderDrag(event,\''+f.id+'\')" ondblclick="resetFader(\''+f.id+'\')">';
    html += '<div class="fader-fill" style="height:'+f.value+'%;background:'+f.color+'"></div>';
    html += '<div class="fader-handle" style="bottom:'+(f.value-3)+'%"></div>';
    html += '</div>';
    html += '<div class="fader-value" id="fader-val-'+f.id+'">'+(f.value/10).toFixed(0)+'</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function resetFader(faderId) {
  var fader = document.querySelector('[data-fader="'+faderId+'"]');
  if (!fader) return;
  fader.querySelector('.fader-fill').style.height = '50%';
  fader.querySelector('.fader-handle').style.bottom = '47%';
  fader.querySelector('.fader-value').textContent = '5';
  saveSession();
  toast('Fader reset: 50%');
}

function startFaderDrag(e, faderId) {
  e.preventDefault();
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  function updatePos(clientY) {
    var y = 1 - ((clientY - rect.top) / rect.height);
    y = Math.max(0, Math.min(1, y));
    var pct = y * 100;
    track.querySelector('.fader-fill').style.height = pct + '%';
    track.querySelector('.fader-handle').style.bottom = (pct - 3) + '%';
    document.getElementById('fader-val-' + faderId).textContent = (pct / 10).toFixed(0);
  }
  var handle = track.querySelector('.fader-handle');
  handle.classList.add('dragging');
  function onMouseMove(e) { updatePos(e.clientY); }
  function onMouseUp() { handle.classList.remove('dragging'); document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updatePos(e.touches[0].clientY); }
  function onTouchEnd() { handle.classList.remove('dragging'); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    updatePos(e.touches[0].clientY);
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    updatePos(e.clientY);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== KNOBS ===== */
function buildKnobs() {
  var container = document.getElementById('knob-group');
  var html = '';
  KNOBS.forEach(function(k) {
    var deg = (k.value - 0.5) * 270;
    html += '<div class="knob" data-knob="'+k.id+'">';
    html += '<div class="knob-dial" onmousedown="startKnobDrag(event,\''+k.id+'\')" ontouchstart="startKnobDrag(event,\''+k.id+'\')" ondblclick="resetKnob(\''+k.id+'\')">';
    html += '<div class="knob-indicator" style="transform:translateX(-50%) rotate('+deg+'deg)"></div>';
    html += '</div>';
    html += '<div class="knob-label">'+k.label+'</div>';
    html += '<div class="knob-value" id="knob-val-'+k.id+'">'+(k.value*100).toFixed(0)+'%</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function resetKnob(knobId) {
  var knob = document.querySelector('[data-knob="'+knobId+'"]');
  if (!knob) return;
  var indicator = knob.querySelector('.knob-indicator');
  if (indicator) indicator.style.transform = 'translateX(-50%) rotate(0deg)';
  var valEl = document.getElementById('knob-val-' + knobId);
  if (valEl) valEl.textContent = '50%';
  saveSession();
  toast('Knob reset: 50%');
}

function startKnobDrag(e, knobId) {
  e.preventDefault();
  var startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  var dial = e.currentTarget;
  var indicator = dial.querySelector('.knob-indicator');
  var startDeg = parseFloat(indicator.style.transform.match(/rotate\(([^)]+)deg\)/)[1]);
  dial.classList.add('dragging');
  function updateKnob(clientY) {
    var delta = (startY - clientY) * 1.5;
    var deg = Math.max(-135, Math.min(135, startDeg + delta));
    indicator.style.transform = 'translateX(-50%) rotate(' + deg + 'deg)';
    var val = ((deg + 135) / 270);
    document.getElementById('knob-val-' + knobId).textContent = (val * 100).toFixed(0) + '%';
  }
  function onMouseMove(e) { updateKnob(e.clientY); }
  function onMouseUp() { dial.classList.remove('dragging'); document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updateKnob(e.touches[0].clientY); }
  function onTouchEnd() { dial.classList.remove('dragging'); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== METERS ===== */
function buildMeters() {
  var container = document.getElementById('meters');
  var html = '';
  for (var i = 0; i < 12; i++) {
    html += '<div class="meter-bar" style="height:' + (10 + Math.random() * 30) + 'px"><div class="peak-hold"></div></div>';
  }
  container.innerHTML = html;
  // Build per-channel meters
  var chContainer = document.getElementById('channel-meters');
  var chHtml = '';
  var trackColors = {push:'var(--accent-blue)',pull:'var(--accent-purple)',core:'var(--accent-orange)',legs:'var(--accent-green)',skills:'var(--accent-cyan)'};
  var trackNames = {push:'P',pull:'PL',core:'C',legs:'L',skills:'SK'};
  Object.keys(trackColors).forEach(function(tid) {
    chHtml += '<div class="channel-meter"><div class="channel-meter-bar"><div class="channel-meter-fill" id="ch-meter-'+tid+'" style="width:0%;background:'+trackColors[tid]+'"></div></div><div class="channel-meter-label">'+trackNames[tid]+'</div></div>';
  });
  chContainer.innerHTML = chHtml;
}

function startMeters() {
  if (meterInterval) return;
  meterInterval = setInterval(function() {
    document.querySelectorAll('.meter-bar').forEach(function(bar) {
      var newH = 10 + Math.random() * 50;
      bar.style.height = newH + 'px';
      bar.style.background = newH > 45 ? 'var(--accent-red)' : newH > 30 ? 'var(--accent-orange)' : 'var(--accent-green)';
    });
    // Animate channel meters + track header VU dots
    ['push','pull','core','legs','skills'].forEach(function(tid) {
      var el = document.getElementById('ch-meter-' + tid);
      var trackClips = document.querySelectorAll('.track-content[data-track="'+tid+'"] .clip');
      var level = trackClips.length > 0 ? (30 + Math.random() * 70) : 0;
      if (el) el.style.width = level + '%';
      // Update track header VU dots
      var vu = document.getElementById('vu-' + tid);
      if (vu) {
        var dots = vu.children;
        var litCount = Math.floor(level / 20);
        for (var d = 0; d < dots.length; d++) {
          dots[d].className = 'track-vu-dot';
          if (d < litCount) {
            dots[d].classList.add(d < 3 ? 'on-low' : d < 4 ? 'on-mid' : 'on-high');
          }
        }
      }
    });
  }, 100);
}

function stopMeters() {
  clearInterval(meterInterval);
  meterInterval = null;
  document.querySelectorAll('.meter-bar').forEach(function(bar) {
    bar.style.height = '5px';
    bar.style.background = 'var(--accent-green)';
  });
  // Clear track header VU dots
  document.querySelectorAll('.track-vu-dot').forEach(function(d) {
    d.className = 'track-vu-dot';
  });
}

/* ===== TRACK CONTROLS ===== */
function toggleMute(btn) {
  btn.classList.toggle('muted');
  var track = btn.closest('.track');
  track.classList.toggle('track-muted', btn.classList.contains('muted'));
  sfx('click');
}
function toggleSolo(btn) {
  btn.classList.toggle('soloed');
  sfx('click');
  // Solo logic: if any track is soloed, mute all others visually
  var anysoloed = document.querySelector('.track-btn.soloed');
  document.querySelectorAll('.track').forEach(function(t) {
    if (t.dataset.track === 'music') return;
    var hasSolo = t.querySelector('.track-btn.soloed');
    var hasMute = t.querySelector('.track-btn.muted');
    if (anysoloed && !hasSolo && !hasMute) {
      t.classList.add('track-muted');
    } else if (!anysoloed && !hasMute) {
      t.classList.remove('track-muted');
    }
    t.classList.toggle('track-soloed', !!hasSolo);
  });
  // Toggle has-solo class on timeline-tracks for CSS dimming
  var tl = document.getElementById('timeline-tracks');
  if (tl) tl.classList.toggle('has-solo', !!anysoloed);
}
function toggleArm(btn) {
  btn.classList.toggle('armed');
  sfx('click');
}

/* ===== VIDEO ===== */
function toggleVideo() {
  var sec = document.getElementById('video-section');
  sec.classList.toggle('collapsed');
  document.getElementById('btn-video').classList.toggle('active', !sec.classList.contains('collapsed'));
}

/* Video drop zone */
document.addEventListener('DOMContentLoaded', function() {
  var vp = document.getElementById('video-placeholder');
  if (!vp) return;
  vp.addEventListener('click', function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function() { loadVideoFile(input.files[0]); };
    input.click();
  });
  vp.addEventListener('dragover', function(e) { e.preventDefault(); vp.style.background = 'rgba(6,182,212,0.1)'; });
  vp.addEventListener('dragleave', function() { vp.style.background = ''; });
  vp.addEventListener('drop', function(e) {
    e.preventDefault();
    vp.style.background = '';
    if (e.dataTransfer.files.length) loadVideoFile(e.dataTransfer.files[0]);
  });
});

function loadVideoFile(file) {
  if (!file || !file.type.startsWith('video/')) return;
  var video = document.getElementById('studio-video');
  var placeholder = document.getElementById('video-placeholder');
  video.src = URL.createObjectURL(file);
  video.style.display = '';
  placeholder.style.display = 'none';
  toast('Video loaded: ' + file.name);
}

/* ===== MUSIC ===== */
function toggleMusic() {
  var panel = document.getElementById('music-panel');
  var visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : '';
  document.querySelector('[onclick="toggleMusic()"]').classList.toggle('active', !visible);
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.volume = 0.5;
    audioEl.addEventListener('ended', function() { musicNext(); });
  }
}

function musicToggle() {
  if (!audioEl) toggleMusic();
  if (musicPlaying) {
    audioEl.pause();
    musicPlaying = false;
    document.getElementById('music-play-btn').innerHTML = '&#9654;';
    document.getElementById('music-eq').style.display = 'none';
  } else {
    if (!audioEl.src || audioEl.ended) {
      audioEl.src = MUSIC_TRACKS[musicIndex].url;
    }
    audioEl.play().catch(function() {});
    musicPlaying = true;
    document.getElementById('music-play-btn').innerHTML = '&#9616;&#9616;';
    document.getElementById('music-play-btn').classList.add('playing');
    document.getElementById('music-eq').style.display = '';
    document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  }
}

function musicNext() {
  musicIndex = (musicIndex + 1) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  var sel = document.getElementById('music-track-select');
  if (sel) sel.selectedIndex = musicIndex;
}

function musicPrev() {
  musicIndex = (musicIndex - 1 + MUSIC_TRACKS.length) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  var sel = document.getElementById('music-track-select');
  if (sel) sel.selectedIndex = musicIndex;
}

function musicVolume(val) {
  if (audioEl) audioEl.volume = val / 100;
}

function musicSelectTrack(index) {
  musicIndex = index;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  drawMusicWaveform(MUSIC_TRACKS[musicIndex].name);
}

// Update music time display
setInterval(function() {
  if (!audioEl || !musicPlaying) return;
  var t = audioEl.currentTime || 0;
  var m = Math.floor(t / 60);
  var s = Math.floor(t % 60);
  var el = document.getElementById('music-time');
  if (el) el.textContent = m + ':' + s.toString().padStart(2, '0');
}, 500);

/* Draw static waveform in music track when a song is selected */
function drawMusicWaveform(trackName) {
  var canvas = document.getElementById('music-waveform-canvas');
  if (!canvas || !canvas.getContext) return;
  var parent = canvas.parentElement;
  canvas.width = parent.clientWidth - 100;
  canvas.height = 44;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#06b6d4';
  var mid = canvas.height / 2;
  var seed = 0;
  for (var i = 0; i < trackName.length; i++) seed += trackName.charCodeAt(i);
  for (var x = 0; x < canvas.width; x += 2) {
    var v = Math.sin(x * 0.02 + seed * 0.1) * 0.5 +
            Math.sin(x * 0.07 + seed * 0.05) * 0.3 +
            Math.sin(x * 0.15 + seed * 0.02) * 0.15 +
            Math.random() * 0.05;
    var amp = (mid - 4) * Math.abs(v);
    ctx.fillRect(x, mid - amp, 1, amp * 2);
  }
}

/* ===== PRESETS ===== */
function togglePresets() {
  var drawer = document.getElementById('presets-drawer');
  drawer.classList.toggle('open');
  document.getElementById('btn-presets').classList.toggle('active', drawer.classList.contains('open'));
}

function loadPreset(id) {
  var p = PRESETS[id];
  if (!p) return;
  pushUndo();
  // Clear timeline
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Set BPM
  bpm = p.bpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Add clips
  p.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    if (!track) return;
    var ex = null;
    for (var i = 0; i < EXERCISES.length; i++) {
      if (EXERCISES[i].name === c.name) { ex = EXERCISES[i]; break; }
    }
    if (!ex) return;
    var clip = createClipElement(ex, c.x, c.w || 80);
    track.appendChild(clip);
  });
  // Set faders
  if (p.faders) {
    Object.keys(p.faders).forEach(function(key) {
      var fader = document.querySelector('[data-fader="'+key+'"]');
      if (!fader) return;
      var v = p.faders[key];
      fader.querySelector('.fader-fill').style.height = v + '%';
      fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
      fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
    });
  }
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  setWorkoutName(p.name);
  toast('Preset loaded: ' + p.name);
}

/* ===== RANDOM WORKOUT ===== */
function generateRandom() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Random BPM between 70-130
  bpm = 70 + Math.floor(Math.random() * 60);
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Pick random exercises per family track
  var families = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackIds = Object.keys(families);
  trackIds.forEach(function(tid) {
    var fam = families[tid];
    var familyExs = EXERCISES.filter(function(ex) { return ex.family === fam || (fam === 'Skills' && ex.family === 'Skills') || (fam === 'Legs' && ex.family === 'Flow'); });
    if (familyExs.length === 0) return;
    // 1-3 clips per track
    var numClips = 1 + Math.floor(Math.random() * 3);
    var track = document.querySelector('.track-content[data-track="'+tid+'"]');
    if (!track) return;
    var xPos = 0;
    for (var i = 0; i < numClips; i++) {
      var ex = familyExs[Math.floor(Math.random() * familyExs.length)];
      var w = 60 + Math.floor(Math.random() * 80);
      var clip = createClipElement(ex, xPos, w);
      track.appendChild(clip);
      xPos += w + Math.floor(Math.random() * 40);
    }
  });
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  setWorkoutName('Random ' + bpm + ' BPM');
  toast('Random workout generated at ' + bpm + ' BPM');
}

/* Fade overlay — draws gradient overlay showing fade in/out on clip */
function updateFadeOverlay(clip) {
  var existing = clip.querySelector('.clip-fade-overlay');
  if (existing) existing.remove();
  var fi = parseInt(clip.dataset.fadeIn) || 0;
  var fo = parseInt(clip.dataset.fadeOut) || 0;
  if (fi === 0 && fo === 0) return;
  var ov = document.createElement('div');
  ov.className = 'clip-fade-overlay';
  ov.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1';
  var clipW = parseInt(clip.style.width) || 80;
  var fiPct = Math.min(50, (fi / clipW) * 100);
  var foPct = Math.min(50, (fo / clipW) * 100);
  var grad = 'linear-gradient(90deg, rgba(5,7,17,0.6) 0%, transparent ' + fiPct + '%, transparent ' + (100 - foPct) + '%, rgba(5,7,17,0.6) 100%)';
  ov.style.background = grad;
  clip.appendChild(ov);
}

/* ===== CLEAR ===== */
function clearTimeline() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats();
  saveSession();
  sfx('delete');
  toast('Timeline cleared');
}

/* ===== SAVE / LOAD ===== */
/* Debounced auto-save — coalesces rapid saveSession() calls into one write */
var _saveTimer = null;
var _saveImmediate = false;
function saveSession(immediate) {
  if (immediate) {
    _saveImmediate = true;
  }
  if (_saveTimer) clearTimeout(_saveTimer);
  if (_saveImmediate) {
    _saveImmediate = false;
    _doSaveSession();
  } else {
    _saveTimer = setTimeout(_doSaveSession, 300);
  }
}
function _doSaveSession() {
  _saveTimer = null;
  try {
    var session = {bpm: bpm, clips: [], faders: {}, knobs: {}};
    document.querySelectorAll('.clip').forEach(function(clip) {
      session.clips.push({
        exerciseId: clip.dataset.exerciseId,
        track: clip.parentElement.dataset.track,
        left: clip.style.left,
        width: clip.style.width,
        sets: clip.dataset.sets,
        reps: clip.dataset.reps,
        tempo: clip.dataset.tempo,
        rest: clip.dataset.rest,
        rpe: clip.dataset.rpe,
        notes: clip.dataset.notes || '',
        customColor: clip.dataset.customColor || '',
        fadeIn: clip.dataset.fadeIn || '0',
        fadeOut: clip.dataset.fadeOut || '0',
        group: clip.dataset.group || '',
        locked: clip.dataset.locked || ''
      });
    });
    document.querySelectorAll('[data-fader]').forEach(function(f) {
      var fill = f.querySelector('.fader-fill');
      session.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
    });
    // Knobs
    document.querySelectorAll('[data-knob]').forEach(function(k) {
      var indicator = k.querySelector('.knob-indicator');
      if (indicator) {
        var m = indicator.style.transform.match(/rotate\(([^)]+)deg\)/);
        var deg = m ? parseFloat(m[1]) : 0;
        session.knobs[k.dataset.knob] = deg;
      }
    });
    // Markers
    session.markers = markers.map(function(m) { return {id: m.id, time: m.time, label: m.label}; });
    session.markerCounter = markerCounter;
    // Workout name + creation date
    session.workoutName = workoutName || '';
    session.workoutNotes = workoutNotes || '';
    session.createdAt = _sessionCreatedAt || new Date().toISOString();
    // Recently used exercises
    if (typeof recentExercises !== 'undefined') session.recentExercises = recentExercises.slice(0);
    // Loop region
    session.loopEnabled = loopEnabled;
    session.loopStart = loopStart;
    session.loopEnd = loopEnd;
    session.groupCounter = _groupCounter;
    // Playhead time
    session.currentTime = currentTime;
    // Session timer cumulative seconds
    session.sessionElapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
    // Settings persistence
    session.settings = {
      snapEnabled: snapEnabled,
      gridRes: gridRes,
      sfxEnabled: sfxEnabled,
      metroVolume: metroVolume,
      autoScrollEnabled: autoScrollEnabled,
      playbackSpeed: playbackSpeed,
      zoomLevel: zoomLevel,
      timeSigIdx: timeSigIdx
    };
    // Track states (solo/mute/armed)
    session.trackStates = {};
    document.querySelectorAll('.track').forEach(function(t) {
      var tid = t.dataset.track;
      if (!tid) return;
      session.trackStates[tid] = {
        muted: t.classList.contains('track-muted'),
        soloed: t.classList.contains('track-soloed'),
        collapsed: t.classList.contains('track-collapsed')
      };
    });
    // Version tracking
    if (typeof _workoutVersion !== 'undefined') {
      _workoutVersion++;
      session.workoutVersion = _workoutVersion;
      updateVersionDisplay();
    }
    localStorage.setItem('sms_session', JSON.stringify(session));
    // Flash save indicator
    var si = document.getElementById('save-indicator');
    if (si) {
      si.style.opacity = '1';
      setTimeout(function() { si.style.opacity = '0'; }, 1200);
    }
  } catch(e) {}
}

function loadSession() {
  try {
    var saved = localStorage.getItem('sms_session');
    if (!saved) return;
    var s = JSON.parse(saved);
    if (s.bpm) { bpm = s.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
    // Restore playhead position
    if (typeof s.currentTime === 'number') {
      currentTime = s.currentTime;
      updateTimeDisplay();
      updatePlayheadPosition();
    }
    // Restore session timer cumulative
    if (typeof s.sessionElapsed === 'number') {
      sessionStartTime = Date.now() - (s.sessionElapsed * 1000);
    }
    if (s.clips) {
      s.clips.forEach(function(c) {
        var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
        var ex = getExercise(c.exerciseId);
        if (!track || !ex) return;
        var clip = createClipElement(ex, c.left, c.width, {
          sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe,
          fadeIn: c.fadeIn || '0', fadeOut: c.fadeOut || '0'
        });
        if (c.notes) clip.dataset.notes = c.notes;
        if (c.customColor) {
          clip.dataset.customColor = c.customColor;
          clip.style.background = 'linear-gradient(180deg, ' + c.customColor + '44 0%, ' + c.customColor + '22 100%)';
          clip.style.borderTopColor = c.customColor;
        }
        if (c.group) {
          clip.dataset.group = c.group;
          clip.style.outline = '1px dashed rgba(59,130,246,0.3)';
        }
        if (c.locked) {
          clip.dataset.locked = '1';
          clip.classList.add('clip-locked');
        }
        track.appendChild(clip);
      });
    }
    // Restore group counter
    if (s.groupCounter) _groupCounter = s.groupCounter;
    if (s.faders) {
      Object.keys(s.faders).forEach(function(key) {
        var fader = document.querySelector('[data-fader="'+key+'"]');
        if (!fader) return;
        var v = s.faders[key];
        fader.querySelector('.fader-fill').style.height = v + '%';
        fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
        fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
      });
    }
    // Restore knobs
    if (s.knobs) {
      Object.keys(s.knobs).forEach(function(key) {
        var knob = document.querySelector('[data-knob="'+key+'"]');
        if (!knob) return;
        var deg = s.knobs[key];
        var indicator = knob.querySelector('.knob-indicator');
        if (indicator) indicator.style.transform = 'translateX(-50%) rotate('+deg+'deg)';
        var val = ((deg + 135) / 270);
        var valEl = document.getElementById('knob-val-' + key);
        if (valEl) valEl.textContent = (val * 100).toFixed(0) + '%';
      });
    }
    // Restore markers
    if (s.markers && s.markers.length) {
      markers = s.markers;
      markerCounter = s.markerCounter || markers.length;
      renderAllMarkers();
    }
    // Restore workout name
    if (s.workoutName) {
      workoutName = s.workoutName;
      var wn = document.getElementById('workout-name');
      if (wn) wn.textContent = workoutName;
      var hn = document.getElementById('header-workout-name');
      if (hn) hn.textContent = workoutName;
    }
    if (s.createdAt) _sessionCreatedAt = s.createdAt;
    if (s.workoutNotes) workoutNotes = s.workoutNotes;
    // Restore workout version
    if (s.workoutVersion) { _workoutVersion = s.workoutVersion; updateVersionDisplay(); }
    // Restore recently used exercises
    if (s.recentExercises && s.recentExercises.length) {
      recentExercises = s.recentExercises;
      if (typeof updateRecentSection === 'function') updateRecentSection();
    }
    // Restore loop region
    if (typeof s.loopEnabled !== 'undefined') {
      loopEnabled = s.loopEnabled;
      loopStart = s.loopStart || 0;
      loopEnd = s.loopEnd || 60;
      var btn = document.getElementById('loop-btn');
      if (btn) btn.classList.toggle('active', loopEnabled);
      var region = document.getElementById('loop-region');
      region.classList.toggle('active', loopEnabled);
      if (loopEnabled) updateLoopRegion();
    }
    // Restore track states
    if (s.trackStates) {
      Object.keys(s.trackStates).forEach(function(tid) {
        var ts = s.trackStates[tid];
        var track = document.querySelector('.track[data-track="'+tid+'"]');
        if (!track) return;
        track.classList.toggle('track-muted', !!ts.muted);
        track.classList.toggle('track-soloed', !!ts.soloed);
        track.classList.toggle('track-collapsed', !!ts.collapsed);
        var muteBtn = track.querySelector('.track-btn[data-action="mute"]');
        var soloBtn = track.querySelector('.track-btn[data-action="solo"]');
        if (muteBtn) muteBtn.classList.toggle('muted', !!ts.muted);
        if (soloBtn) soloBtn.classList.toggle('soloed', !!ts.soloed);
      });
      var hasSolo = !!document.querySelector('.track-btn.soloed');
      var tracksEl = document.getElementById('timeline-tracks');
      if (tracksEl) tracksEl.classList.toggle('has-solo', hasSolo);
    }
    // Restore settings
    if (s.settings) {
      var st = s.settings;
      if (typeof st.snapEnabled !== 'undefined') {
        snapEnabled = st.snapEnabled;
        var snapBtn = document.getElementById('snap-badge');
        if (snapBtn) { snapBtn.classList.toggle('active', snapEnabled); snapBtn.textContent = snapEnabled ? 'SNAP ' + (st.gridRes || 4) + 'B' : 'SNAP'; }
        var settingsSnapBtn = document.getElementById('settings-snap');
        if (settingsSnapBtn) settingsSnapBtn.textContent = snapEnabled ? 'ON' : 'OFF';
      }
      if (st.gridRes) {
        gridRes = st.gridRes;
        var gridSel = document.getElementById('settings-grid');
        if (gridSel) gridSel.value = gridRes;
      }
      if (typeof st.sfxEnabled !== 'undefined') {
        sfxEnabled = st.sfxEnabled;
        var sfxBtn = document.getElementById('settings-sfx');
        if (sfxBtn) sfxBtn.textContent = sfxEnabled ? 'ON' : 'OFF';
      }
      if (typeof st.metroVolume !== 'undefined') {
        metroVolume = st.metroVolume;
        var metroSlider = document.getElementById('settings-metro-vol');
        if (metroSlider) metroSlider.value = metroVolume * 100;
      }
      if (typeof st.autoScrollEnabled !== 'undefined') {
        autoScrollEnabled = st.autoScrollEnabled;
        var asBtn = document.getElementById('auto-scroll-btn');
        if (asBtn) asBtn.classList.toggle('active', autoScrollEnabled);
        var asSettings = document.getElementById('settings-autoscroll');
        if (asSettings) asSettings.textContent = autoScrollEnabled ? 'ON' : 'OFF';
      }
      if (st.playbackSpeed) {
        playbackSpeed = st.playbackSpeed;
        var speedBtn = document.getElementById('speed-btn');
        if (speedBtn) speedBtn.textContent = playbackSpeed + 'x';
      }
      if (st.zoomLevel) {
        zoomLevel = st.zoomLevel;
        applyZoom();
      }
      if (typeof st.timeSigIdx === 'number') {
        timeSigIdx = st.timeSigIdx;
        var tsEl = document.getElementById('time-sig');
        if (tsEl && timeSigOptions[timeSigIdx]) tsEl.textContent = timeSigOptions[timeSigIdx];
      }
    }
    updateStats();
  } catch(e) {}
}

/* ===== EXPORT ===== */
function exportWorkout() {
  var workout = {
    version: 2,
    name: workoutName || 'Saturno Movement Studio Export',
    timestamp: new Date().toISOString(),
    createdAt: _sessionCreatedAt,
    workoutNotes: workoutNotes || '',
    bpm: bpm,
    bpmMode: document.getElementById('bpm-mode').textContent,
    tracks: {}
  };
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    workout.tracks[t.id] = [];
  });
  document.querySelectorAll('.clip').forEach(function(clip) {
    var trackId = clip.parentElement.dataset.track;
    var ex = getExercise(clip.dataset.exerciseId);
    workout.tracks[trackId].push({
      movement: ex ? ex.name : clip.textContent,
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      discipline: ex ? ex.discipline : '',
      stage: ex ? ex.stage : 1,
      startTime: parseInt(clip.style.left) / 80 * 15,
      duration: parseInt(clip.style.width) / 80 * 15,
      sets: parseInt(clip.dataset.sets) || 3,
      reps: parseInt(clip.dataset.reps) || 8,
      tempo: parseFloat(clip.dataset.tempo) || 3,
      rest: parseInt(clip.dataset.rest) || 60,
      rpe: parseInt(clip.dataset.rpe) || 7,
      notes: clip.dataset.notes || '',
      fadeIn: parseInt(clip.dataset.fadeIn) || 0,
      fadeOut: parseInt(clip.dataset.fadeOut) || 0,
      customColor: clip.dataset.customColor || '',
      group: clip.dataset.group || '',
      locked: clip.dataset.locked || ''
    });
  });
  workout.groupCounter = _groupCounter;
  workout.markers = markers.map(function(m) { return {id: m.id, time: m.time, label: m.label}; });
  workout.loop = {enabled: loopEnabled, start: loopStart, end: loopEnd};
  workout.workoutVersion = _workoutVersion;
  // Faders
  workout.faders = {};
  document.querySelectorAll('[data-fader]').forEach(function(f) {
    var fill = f.querySelector('.fader-fill');
    workout.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
  });
  // Knobs
  workout.knobs = {};
  document.querySelectorAll('[data-knob]').forEach(function(k) {
    var indicator = k.querySelector('.knob-indicator');
    if (indicator) {
      var m = indicator.style.transform.match(/rotate\(([^)]+)deg\)/);
      workout.knobs[k.dataset.knob] = m ? parseFloat(m[1]) : 0;
    }
  });
  var blob = new Blob([JSON.stringify(workout, null, 2)], {type: 'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('Workout exported');
}

function exportCSV() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var rows = [['Track','Exercise','Pattern','Family','Discipline','Stage','Sets','Reps','Tempo','Rest','RPE','Color','Locked','Notes']];
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    var track = c.parentElement.dataset.track;
    rows.push([
      track, ex ? ex.name : '', ex ? ex.pattern : '', ex ? ex.family : '',
      ex ? ex.discipline : '', ex ? ex.stage : '',
      c.dataset.sets || '3', c.dataset.reps || '8', c.dataset.tempo || '3',
      c.dataset.rest || '60', c.dataset.rpe || '7',
      c.dataset.customColor || '',
      c.dataset.locked ? 'Yes' : '',
      (c.dataset.notes || '').replace(/"/g, '""')
    ]);
  });
  var csv = rows.map(function(r) { return r.map(function(v) { return '"' + v + '"'; }).join(','); }).join('\n');
  var blob = new Blob([csv], {type: 'text/csv'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  toast('CSV exported');
}

function shareWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var data = {n: workoutName || 'Workout', b: bpm, c: []};
  clips.forEach(function(clip) {
    data.c.push({
      e: clip.dataset.exerciseId,
      t: clip.parentElement.dataset.track,
      l: parseInt(clip.style.left) || 0,
      w: parseInt(clip.style.width) || 80,
      s: clip.dataset.sets, r: clip.dataset.reps,
      p: clip.dataset.rpe
    });
  });
  var json = JSON.stringify(data);
  var encoded = btoa(unescape(encodeURIComponent(json)));
  var url = window.location.origin + window.location.pathname + '#share=' + encoded;
  try {
    navigator.clipboard.writeText(url).then(function() {
      toast('Share URL copied to clipboard');
      sfx('click');
    });
  } catch(e) {
    toast('URL generated (check console)');
  }
}

function loadFromHash() {
  try {
    var hash = window.location.hash;
    if (!hash || hash.indexOf('#share=') !== 0) return;
    var encoded = hash.substring(7);
    var json = decodeURIComponent(escape(atob(encoded)));
    var data = JSON.parse(json);
    if (!data.c || !data.c.length) return;
    pushUndo();
    document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
    selectedClip = null;
    document.getElementById('inspector').style.display = 'none';
    if (data.b) { bpm = data.b; document.getElementById('bpm-input').value = bpm; updateBPMMode(); buildRuler(); }
    data.c.forEach(function(item) {
      var track = document.querySelector('.track-content[data-track="'+item.t+'"]');
      var ex = getExercise(item.e);
      if (!track || !ex) return;
      var clip = createClipElement(ex, item.l, item.w, {
        sets: item.s, reps: item.r, rpe: item.p
      });
      track.appendChild(clip);
    });
    updateStats(); saveSession();
    setWorkoutName(data.n || 'Shared Workout');
    toast('Loaded shared workout: ' + (data.n || 'Workout'));
    window.location.hash = '';
  } catch(e) {}
}

/* ===== IMPORT WORKOUT ===== */
function importWorkout() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function() {
    if (!input.files[0]) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var workout = JSON.parse(e.target.result);
        if (!workout.tracks) { toast('Invalid workout file'); return; }
        pushUndo();
        document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
        selectedClip = null;
        document.getElementById('inspector').style.display = 'none';
        if (workout.bpm) {
          bpm = workout.bpm;
          document.getElementById('bpm-input').value = bpm;
          updateBPMMode();
          buildRuler();
        }
        var pps = 80 / 15;
        Object.keys(workout.tracks).forEach(function(trackId) {
          var track = document.querySelector('.track-content[data-track="'+trackId+'"]');
          if (!track) return;
          workout.tracks[trackId].forEach(function(item) {
            var ex = null;
            for (var i = 0; i < EXERCISES.length; i++) {
              if (EXERCISES[i].name === item.movement) { ex = EXERCISES[i]; break; }
            }
            if (!ex) return;
            var left = (item.startTime || 0) * pps;
            var width = (item.duration || 15) * pps;
            var clip = createClipElement(ex, left, width, {
              sets: item.sets, reps: item.reps, tempo: item.tempo,
              rest: item.rest, rpe: item.rpe,
              fadeIn: (item.fadeIn || 0).toString(),
              fadeOut: (item.fadeOut || 0).toString()
            });
            if (item.notes) clip.dataset.notes = item.notes;
            if (item.customColor) {
              clip.dataset.customColor = item.customColor;
              clip.style.background = 'linear-gradient(180deg, ' + item.customColor + '44 0%, ' + item.customColor + '22 100%)';
              clip.style.borderTopColor = item.customColor;
            }
            if (item.group) {
              clip.dataset.group = item.group;
              clip.style.outline = '1px dashed rgba(59,130,246,0.3)';
            }
            if (item.locked) {
              clip.dataset.locked = '1';
              clip.classList.add('clip-locked');
            }
            track.appendChild(clip);
          });
        });
        if (workout.groupCounter) _groupCounter = workout.groupCounter;
        // Import markers
        if (workout.markers && workout.markers.length) {
          markers = workout.markers;
          markerCounter = markers.reduce(function(max, m) { return Math.max(max, m.id); }, 0);
          renderAllMarkers();
        }
        // Import faders
        if (workout.faders) {
          Object.keys(workout.faders).forEach(function(key) {
            var fader = document.querySelector('[data-fader="'+key+'"]');
            if (!fader) return;
            var v = workout.faders[key];
            fader.querySelector('.fader-fill').style.height = v + '%';
            fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
            fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
          });
        }
        // Import knobs
        if (workout.knobs) {
          Object.keys(workout.knobs).forEach(function(key) {
            var knob = document.querySelector('[data-knob="'+key+'"]');
            if (!knob) return;
            var deg = workout.knobs[key];
            var indicator = knob.querySelector('.knob-indicator');
            if (indicator) indicator.style.transform = 'translateX(-50%) rotate('+deg+'deg)';
            var val = ((deg + 135) / 270);
            var valEl = document.getElementById('knob-val-' + key);
            if (valEl) valEl.textContent = (val * 100).toFixed(0) + '%';
          });
        }
        // Import loop
        if (workout.loop) {
          loopEnabled = workout.loop.enabled || false;
          loopStart = workout.loop.start || 0;
          loopEnd = workout.loop.end || 60;
          var lBtn = document.getElementById('loop-btn');
          if (lBtn) lBtn.classList.toggle('active', loopEnabled);
          var lReg = document.getElementById('loop-region');
          lReg.classList.toggle('active', loopEnabled);
          if (loopEnabled) updateLoopRegion();
        }
        if (workout.createdAt) _sessionCreatedAt = workout.createdAt;
        if (workout.workoutNotes) workoutNotes = workout.workoutNotes;
        updateStats();
        saveSession();
        sfx('preset');
        setWorkoutName(workout.name || 'Imported Workout');
        toast('Imported: ' + (workout.name || 'workout'));
      } catch(err) {
        toast('Error importing file');
      }
    };
    reader.readAsText(input.files[0]);
  };
  input.click();
}

/* ===== PRINT WORKOUT ===== */
function printWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.textContent,
      pattern: ex ? ex.pattern : '',
      discipline: ex ? ex.discipline : '',
      stage: ex ? ex.stage : 1,
      sets: c.dataset.sets || 3,
      reps: c.dataset.reps || 8,
      tempo: c.dataset.tempo || 3,
      rest: c.dataset.rest || 60,
      rpe: c.dataset.rpe || 7,
      notes: c.dataset.notes || '',
      startTime: parseInt(c.style.left) / 80 * 15
    });
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var totalClips = clips.length;
  var totalSets = 0, totalReps = 0;
  clips.forEach(function(c) { totalSets += parseInt(c.dataset.sets) || 3; totalReps += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8); });
  var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var letterIdx = 0;
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Workout - Saturno Movement Studio</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Sora:wght@200;300;400;500;600&display=swap" rel="stylesheet">';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}';
  html += 'body{font-family:Sora,sans-serif;padding:48px 32px 80px;max-width:600px;margin:0 auto;background:#050711;color:#e2e8f0}';
  html += 'h1{font-size:22px;font-weight:300;letter-spacing:0.06em;margin-bottom:4px}';
  html += '.subtitle{font-size:9px;color:#475569;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:20px}';
  html += '.meta{font-size:10px;color:#64748b;display:flex;gap:24px;margin-bottom:32px;letter-spacing:0.04em}';
  html += '.meta b{font-weight:500;color:#94a3b8}';
  html += '.stats{display:flex;gap:32px;justify-content:center;margin-bottom:32px}';
  html += '.stat{text-align:center}';
  html += '.stat-val{font-size:28px;font-weight:200;background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}';
  html += '.stat-label{font-size:7px;color:#475569;text-transform:uppercase;letter-spacing:0.2em;margin-top:4px}';
  html += '.divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);margin:32px 0}';
  html += '.group-label{font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:20px}';
  html += '.exercise{display:flex;gap:16px;align-items:flex-start;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.03)}';
  html += '.exercise:last-child{border-bottom:none}';
  html += '.ex-idx{font-size:11px;font-weight:300;color:#475569;min-width:28px;letter-spacing:0.04em;padding-top:1px}';
  html += '.ex-body{flex:1}';
  html += '.ex-name{font-size:14px;font-weight:500;color:#e2e8f0;letter-spacing:0.02em;margin-bottom:8px;line-height:1.2}';
  html += '.ex-params{display:flex;flex-wrap:wrap;gap:16px;font-size:11px;color:#64748b}';
  html += '.param{display:flex;align-items:baseline;gap:4px}';
  html += '.param-val{font-weight:500}';
  html += '.param-label{font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.08em}';
  html += '.footer{text-align:center;margin-top:48px;font-size:8px;color:rgba(255,255,255,0.12);text-transform:uppercase;letter-spacing:0.2em}';
  html += '@media print{body{padding:24px;background:#fff;color:#111}';
  html += '.stat-val{background:none;-webkit-text-fill-color:#111;color:#111}';
  html += '.ex-name{color:#111}.ex-params{color:#555}.param-label{color:#888}';
  html += '.group-label{color:#888}.ex-idx{color:#888}.meta{color:#888}.meta b{color:#555}';
  html += '.divider{background:#e0e0e0}.exercise{border-bottom-color:#eee}';
  html += '.subtitle{color:#888}.footer{color:#ccc}}';
  html += '</style></head><body>';
  html += '<h1>' + (workoutName && workoutName !== 'Untitled' ? workoutName : 'Saturno Movement Studio') + '</h1>';
  html += '<div class="subtitle">' + (workoutName && workoutName !== 'Untitled' ? 'Saturno Movement Studio' : 'The Ableton of Movement') + '</div>';
  var printCreated = _sessionCreatedAt ? new Date(_sessionCreatedAt).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : '';
  var modeDesc = '';
  for (var mi = 0; mi < BPM_MODES.length; mi++) {
    if (mode === BPM_MODES[mi].name) { modeDesc = BPM_MODES[mi].desc; break; }
  }
  html += '<div class="meta"><span><b>' + bpm + '</b> BPM</span><span>' + mode + (modeDesc ? ' - ' + modeDesc : '') + '</span><span>' + new Date().toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + '</span>';
  if (printCreated) html += '<span>Created ' + printCreated + '</span>';
  html += '</div>';
  if (workoutNotes) {
    html += '<div style="font-size:10px;color:#64748b;margin-bottom:16px;font-style:italic;line-height:1.5">' + workoutNotes.replace(/</g, '&lt;') + '</div>';
  }
  var totalDur = 0;
  clips.forEach(function(c) {
    var st = parseInt(c.dataset.sets) || 3;
    var rp = parseInt(c.dataset.reps) || 8;
    var tp = parseFloat(c.dataset.tempo) || 3;
    var rs = parseInt(c.dataset.rest) || 60;
    totalDur += (st * rp * tp) + ((st - 1) * rs);
  });
  var durMin = Math.floor(totalDur / 60);
  html += '<div class="stats"><div class="stat"><div class="stat-val">' + totalClips + '</div><div class="stat-label">Exercises</div></div>';
  html += '<div class="stat"><div class="stat-val">' + totalSets + '</div><div class="stat-label">Total Sets</div></div>';
  html += '<div class="stat"><div class="stat-val">' + totalReps + '</div><div class="stat-label">Total Reps</div></div>';
  html += '<div class="stat"><div class="stat-val">' + durMin + '</div><div class="stat-label">Est. Minutes</div></div></div>';
  var printFams = {};
  clips.forEach(function(c) { var ex = getExercise(c.dataset.exerciseId); if (ex) printFams[ex.family] = (printFams[ex.family] || 0) + 1; });
  var pfKeys = Object.keys(printFams);
  if (pfKeys.length > 0) {
    html += '<div style="text-align:center;font-size:9px;color:#64748b;margin-bottom:24px;letter-spacing:0.04em">';
    html += pfKeys.sort(function(a,b){ return printFams[b]-printFams[a]; }).map(function(f){ return f + ' (' + printFams[f] + ')'; }).join(' / ');
    html += '</div>';
  }
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackColors = {push:'#3b82f6',pull:'#8b5cf6',core:'#f97316',legs:'#22c55e',skills:'#06b6d4'};
  var trackOrder = ['push','pull','legs','core','skills'];
  trackOrder.forEach(function(trackId) {
    if (!groups[trackId] || groups[trackId].length === 0) return;
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.startTime - b.startTime; });
    var letter = letters[letterIdx] || 'Z';
    letterIdx++;
    html += '<div class="divider"></div>';
    html += '<div class="group-label" style="color:' + (trackColors[trackId] || '#64748b') + '">' + (trackNames[trackId] || trackId) + ' <span style="font-weight:300;opacity:0.6">(' + exercises.length + ')</span></div>';
    exercises.forEach(function(ex, i) {
      var idx = letter + (i + 1);
      html += '<div class="exercise">';
      html += '<div class="ex-idx" style="color:' + (trackColors[trackId] || '#64748b') + '">' + idx + '</div>';
      html += '<div class="ex-body">';
      html += '<div class="ex-name">' + ex.name + '</div>';
      if (ex.discipline || ex.stage) {
        html += '<div style="font-size:9px;color:#475569;margin-bottom:6px;letter-spacing:0.04em">';
        if (ex.discipline) html += ex.discipline;
        if (ex.discipline && ex.stage) html += ' &middot; ';
        if (ex.stage) html += 'Stage ' + ex.stage;
        html += '</div>';
      }
      html += '<div class="ex-params">';
      html += '<div class="param"><span class="param-val" style="color:#eab308">' + ex.reps + '</span> <span class="param-label">reps</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#3b82f6">' + ex.sets + '</span> <span class="param-label">sets</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#22c55e">' + ex.rest + 's</span> <span class="param-label">rest</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#8b5cf6">' + ex.tempo + 's</span> <span class="param-label">tempo</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#ef4444">' + ex.rpe + '</span> <span class="param-label">rpe</span></div>';
      html += '</div>';
      if (ex.notes) {
        html += '<div style="margin-top:6px;font-size:10px;color:#64748b;font-style:italic;line-height:1.4">' + ex.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      } else {
        html += '<div style="margin-top:8px;border-bottom:1px dashed rgba(255,255,255,0.06);height:1px"></div>';
      }
      html += '</div></div>';
    });
  });
  html += '<div class="footer">Generated by Saturno Movement Studio</div>';
  html += '</body></html>';
  var win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.print();
}

/* ===== WORKOUT SUMMARY ===== */
function showSummary() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add exercises to view summary'); return; }

  // Group clips by track, sorted by position
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.querySelector('.clip-name') ? c.querySelector('.clip-name').textContent : 'Exercise',
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      discipline: ex ? ex.discipline : '',
      stage: ex ? ex.stage : 1,
      sets: c.dataset.sets || '3',
      reps: c.dataset.reps || '8',
      tempo: c.dataset.tempo || '3',
      rest: c.dataset.rest || '60',
      rpe: c.dataset.rpe || '7',
      notes: c.dataset.notes || '',
      left: parseInt(c.style.left) || 0
    });
  });

  // Totals
  var totalEx = clips.length;
  var totalSets = 0;
  var totalReps = 0;
  clips.forEach(function(c) {
    var s = parseInt(c.dataset.sets) || 3;
    var r = parseInt(c.dataset.reps) || 8;
    totalSets += s;
    totalReps += s * r;
  });

  var mode = document.getElementById('bpm-mode').textContent;
  var name = workoutName && workoutName !== 'Untitled' ? workoutName : 'Workout';
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackColors = {push:'#3b82f6',pull:'#8b5cf6',core:'#f97316',legs:'#22c55e',skills:'#06b6d4'};
  var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var letterIdx = 0;

  var html = '';
  html += '<div class="summary-header">';
  html += '<div class="summary-title">' + name + '</div>';
  html += '<div class="summary-subtitle">Saturno Movement Studio</div>';
  html += '<div class="summary-meta">';
  html += '<span><span class="summary-meta-val">' + bpm + '</span> BPM</span>';
  html += '<span>' + mode + '</span>';
  html += '<span>' + new Date().toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + '</span>';
  html += '</div>';
  html += '</div>';
  if (workoutNotes) {
    html += '<div style="font-size:10px;color:var(--muted);margin-bottom:12px;font-style:italic;text-align:center;line-height:1.5">' + workoutNotes.replace(/</g, '&lt;') + '</div>';
  }

  // Estimated workout time
  var estSec = 0;
  clips.forEach(function(c) {
    var st = parseInt(c.dataset.sets) || 3;
    var rp = parseInt(c.dataset.reps) || 8;
    var tp = parseFloat(c.dataset.tempo) || 3;
    var rs = parseInt(c.dataset.rest) || 60;
    estSec += st * (rp * tp + rs) - rs;
  });
  var estMin = Math.floor(estSec / 60);
  // Unique disciplines
  var disciplines = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex && ex.discipline) disciplines[ex.discipline] = true;
  });
  var discCount = Object.keys(disciplines).length;

  html += '<div class="summary-stats">';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + totalEx + '</div><div class="summary-stat-label">Exercises</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + totalSets + '</div><div class="summary-stat-label">Total Sets</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + totalReps + '</div><div class="summary-stat-label">Total Reps</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + estMin + '</div><div class="summary-stat-label">Est. Minutes</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + getSessionElapsed() + '</div><div class="summary-stat-label">Session Time</div></div>';
  html += '</div>';
  // Family breakdown
  var famBreak = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) famBreak[ex.family] = (famBreak[ex.family] || 0) + 1;
  });
  var famHtml = '';
  Object.keys(famBreak).sort(function(a, b) { return famBreak[b] - famBreak[a]; }).forEach(function(f) {
    var fc = (FAMILY_MAP[f] || {}).color || '#666';
    famHtml += '<span style="color:' + fc + ';font-weight:500">' + f + ' ' + famBreak[f] + '</span>';
  });
  if (famHtml) {
    html += '<div style="text-align:center;font-size:8px;color:var(--micro);margin-bottom:8px;display:flex;justify-content:center;gap:12px;letter-spacing:0.04em">' + famHtml + '</div>';
  }
  if (discCount > 0) {
    html += '<div style="text-align:center;font-size:9px;color:var(--micro);margin-bottom:16px;letter-spacing:0.06em">' + Object.keys(disciplines).join(' / ') + '</div>';
  }

  var trackOrder = ['push','pull','legs','core','skills'];
  trackOrder.forEach(function(trackId) {
    if (!groups[trackId] || groups[trackId].length === 0) return;
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.left - b.left; });
    var letter = letters[letterIdx] || 'Z';
    letterIdx++;

    html += '<div class="summary-divider"></div>';
    html += '<div class="summary-group-label" style="color:' + (trackColors[trackId] || '#64748b') + '">' + (trackNames[trackId] || trackId) + '</div>';

    exercises.forEach(function(ex, i) {
      var idx = letter + (i + 1);
      var tempoStr = ex.tempo + 's';
      var restMin = parseInt(ex.rest);
      var restStr = restMin >= 60 ? Math.floor(restMin / 60) + '-' + Math.ceil(restMin / 60 + 0.5) + ' min' : restMin + 's';

      html += '<div class="summary-exercise">';
      html += '<div class="summary-ex-index" style="color:' + (trackColors[trackId] || '#64748b') + '">' + idx + '</div>';
      html += '<div class="summary-ex-body">';
      html += '<div class="summary-ex-name">' + ex.name;
      if (ex.discipline && ex.discipline !== 'Calisthenics') html += ' <span style="font-size:10px;color:var(--micro);font-weight:300">(' + ex.discipline + ')</span>';
      html += '</div>';
      html += '<div class="summary-ex-params">';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#eab308">' + ex.reps + '</span> <span class="summary-param-label">reps</span></div>';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#3b82f6">' + ex.sets + '</span> <span class="summary-param-label">sets</span></div>';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#22c55e">' + restStr + '</span> <span class="summary-param-label">rest</span></div>';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#8b5cf6">' + tempoStr + '</span> <span class="summary-param-label">tempo</span></div>';
      html += '</div>';
      if (ex.notes) {
        html += '<div style="margin-top:8px;font-size:10px;color:var(--text-secondary);font-style:italic;line-height:1.5;opacity:0.8">' + ex.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      }
      // Build progression chain for this exercise's pattern
      var chainId = 'prog-' + trackId + '-' + i;
      html += '<div class="summary-ex-prog" onclick="toggleProgChain(\'' + chainId + '\')">Progressions &amp; Alternatives</div>';
      html += '<div class="summary-prog-chain" id="' + chainId + '">';
      var siblings = EXERCISES.filter(function(e) { return e.pattern === ex.pattern; });
      var stages = [1, 2, 3];
      var stageLabels = {0:'Foundation', 1:'Stage 1', 2:'Stage 2', 3:'Stage 3'};
      stages.forEach(function(s) {
        var stageExs = siblings.filter(function(e) { return e.stage === s; });
        if (stageExs.length === 0) return;
        html += '<div class="summary-prog-stage">' + (stageLabels[s] || 'Stage ' + s) + '</div>';
        stageExs.forEach(function(se) {
          var isCurrent = se.name === ex.name;
          html += '<div class="summary-prog-item' + (isCurrent ? ' current' : '') + '">';
          html += (isCurrent ? '> ' : '') + se.name;
          if (se.discipline !== 'Calisthenics') html += ' <span class="prog-disc">' + se.discipline + '</span>';
          html += '</div>';
        });
      });
      html += '</div>';
      html += '</div>';
      html += '</div>';
    });
  });

  html += '<div class="summary-footer">Generated by Saturno Movement Studio</div>';

  document.getElementById('summary-content').innerHTML = html;
  document.getElementById('summary-overlay').classList.add('open');
  sfx('open');
}

function closeSummary() {
  document.getElementById('summary-overlay').classList.remove('open');
}

function copyWorkoutText() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No exercises to copy'); return; }
  var lines = [];
  var name = workoutName && workoutName !== 'Untitled' ? workoutName : 'Workout';
  var txtEstSec = 0;
  clips.forEach(function(c) {
    var st = parseInt(c.dataset.sets) || 3;
    var rp = parseInt(c.dataset.reps) || 8;
    var tp = parseFloat(c.dataset.tempo) || 3;
    var rs = parseInt(c.dataset.rest) || 60;
    txtEstSec += st * (rp * tp + rs) - rs;
  });
  var txtEstMin = Math.floor(txtEstSec / 60);
  lines.push(name + ' | ' + bpm + ' BPM | ' + document.getElementById('bpm-mode').textContent);
  lines.push(clips.length + ' exercises | ~' + txtEstMin + ' min');
  if (workoutNotes) { lines.push('Notes: ' + workoutNotes); }
  lines.push('');
  var trackNames = {push:'PUSH',pull:'PULL',core:'CORE',legs:'LEGS',skills:'SKILLS'};
  var trackOrder = ['push','pull','legs','core','skills'];
  var groups = {};
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!groups[tid]) groups[tid] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[tid].push({
      name: ex ? ex.name : 'Exercise',
      sets: c.dataset.sets || '3',
      reps: c.dataset.reps || '8',
      tempo: c.dataset.tempo || '3',
      rest: c.dataset.rest || '60',
      rpe: c.dataset.rpe || '7',
      notes: c.dataset.notes || '',
      left: parseInt(c.style.left) || 0
    });
  });
  trackOrder.forEach(function(tid) {
    if (!groups[tid] || groups[tid].length === 0) return;
    groups[tid].sort(function(a, b) { return a.left - b.left; });
    lines.push('--- ' + (trackNames[tid] || tid) + ' ---');
    groups[tid].forEach(function(ex, i) {
      var line = (i+1) + '. ' + ex.name + ' - ' + ex.sets + 'x' + ex.reps + ' @' + ex.tempo + 's | Rest ' + ex.rest + 's | RPE ' + ex.rpe;
      if (ex.notes) line += ' | Note: ' + ex.notes;
      lines.push(line);
    });
    lines.push('');
  });
  lines.push('Made with Saturno Movement Studio');
  var text = lines.join('\n');
  try {
    navigator.clipboard.writeText(text).then(function() {
      toast('Workout copied to clipboard');
      sfx('click');
    });
  } catch(e) {
    toast('Could not copy');
  }
}

// Click overlay background to close summary
document.getElementById('summary-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSummary();
});

function toggleProgChain(id) {
  var el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}



/* ===== TOAST ===== */
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

/* ===== SAVED WORKOUTS ===== */
function getSavedWorkouts() {
  try { return JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) { return []; }
}

function saveNamedWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  showInlinePrompt('Save workout as', workoutName !== 'Untitled' ? workoutName : '', function(name) {
    if (!name) return;
    var workout = {
      name: name,
      created: new Date().toISOString(),
      bpm: bpm,
      clipCount: clips.length,
      state: captureState()
    };
    var saved = getSavedWorkouts();
    saved.unshift(workout);
    if (saved.length > 20) saved = saved.slice(0, 20);
    try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
    setWorkoutName(name);
    toast('Saved: ' + name);
  });
}

function showSavedWorkouts() {
  var saved = getSavedWorkouts();
  var list = document.getElementById('saved-list');
  if (saved.length === 0) {
    list.innerHTML = '<div class="saved-empty">No saved workouts yet. Use SAVE AS to save one.</div>';
  } else {
    var html = '';
    saved.forEach(function(w, i) {
      var date = new Date(w.created).toLocaleDateString();
      var timeAgo = '';
      var diff = Date.now() - new Date(w.created).getTime();
      var hours = Math.floor(diff / 3600000);
      var days = Math.floor(diff / 86400000);
      if (days > 0) timeAgo = days + 'd ago';
      else if (hours > 0) timeAgo = hours + 'h ago';
      else timeAgo = 'just now';
      html += '<div class="saved-item" onclick="loadSavedWorkout('+i+')">';
      html += '<span class="saved-item-delete" onclick="event.stopPropagation();deleteSavedWorkout('+i+')">delete</span>';
      html += '<div class="saved-item-name">'+w.name+'</div>';
      html += '<div class="saved-item-info" style="display:flex;gap:8px;flex-wrap:wrap">';
      html += '<span>'+w.clipCount+' clips</span>';
      html += '<span style="color:var(--accent-orange)">'+w.bpm+' BPM</span>';
      html += '<span>'+timeAgo+'</span>';
      html += '</div></div>';
    });
    list.innerHTML = html;
  }
  document.getElementById('saved-modal').classList.add('open');
}

function closeSavedWorkouts() {
  document.getElementById('saved-modal').classList.remove('open');
}

function loadSavedWorkout(index) {
  var saved = getSavedWorkouts();
  if (!saved[index]) return;
  pushUndo();
  var state = JSON.parse(saved[index].state);
  restoreState(state);
  closeSavedWorkouts();
  setWorkoutName(saved[index].name);
  toast('Loaded: ' + saved[index].name);
}

function deleteSavedWorkout(index) {
  var saved = getSavedWorkouts();
  var name = saved[index] ? saved[index].name : '';
  saved.splice(index, 1);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  showSavedWorkouts();
  toast('Deleted: ' + name);
}

/* Close modal on overlay click */
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('saved-modal');
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeSavedWorkouts();
  });
});

/* ===== UNDO / REDO ===== */
function captureState() {
  var state = {bpm: bpm, clips: []};
  document.querySelectorAll('.clip').forEach(function(clip) {
    state.clips.push({
      exerciseId: clip.dataset.exerciseId,
      track: clip.parentElement.dataset.track,
      left: clip.style.left,
      width: clip.style.width,
      sets: clip.dataset.sets,
      reps: clip.dataset.reps,
      tempo: clip.dataset.tempo,
      rest: clip.dataset.rest,
      rpe: clip.dataset.rpe,
      notes: clip.dataset.notes || '',
      customColor: clip.dataset.customColor || '',
      fadeIn: clip.dataset.fadeIn || '0',
      fadeOut: clip.dataset.fadeOut || '0',
      group: clip.dataset.group || '',
      locked: clip.dataset.locked || ''
    });
  });
  state.markers = markers.map(function(m) { return {id: m.id, time: m.time, label: m.label}; });
  state.markerCounter = markerCounter;
  state.groupCounter = _groupCounter;
  state.loopEnabled = loopEnabled;
  state.loopStart = loopStart;
  state.loopEnd = loopEnd;
  return JSON.stringify(state);
}

function updateUndoCount() {
  var el = document.getElementById('undo-count');
  if (el) el.textContent = undoStack.length > 0 || redoStack.length > 0 ? 'U:' + undoStack.length + ' R:' + redoStack.length : '';
}

function pushUndo() {
  var state = captureState();
  if (undoStack.length > 0 && undoStack[undoStack.length - 1] === state) return;
  undoStack.push(state);
  if (undoStack.length > maxUndo) undoStack.shift();
  redoStack = [];
  updateUndoCount();
}

function undo() {
  if (undoStack.length === 0) { toast('Nothing to undo'); return; }
  redoStack.push(captureState());
  var state = JSON.parse(undoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Undo (' + undoStack.length + ' left)');
  updateUndoCount();
}

function redo() {
  if (redoStack.length === 0) { toast('Nothing to redo'); return; }
  undoStack.push(captureState());
  var state = JSON.parse(redoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Redo (' + redoStack.length + ' left)');
  updateUndoCount();
}

function restoreState(state) {
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  if (state.bpm) { bpm = state.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
  state.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    var ex = getExercise(c.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, c.left, c.width, {
      sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe,
      fadeIn: c.fadeIn || '0', fadeOut: c.fadeOut || '0'
    });
    if (c.notes) clip.dataset.notes = c.notes;
    if (c.customColor) {
      clip.dataset.customColor = c.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + c.customColor + '44 0%, ' + c.customColor + '22 100%)';
      clip.style.borderTopColor = c.customColor;
    }
    if (c.group) {
      clip.dataset.group = c.group;
      clip.style.outline = '1px dashed rgba(59,130,246,0.3)';
    }
    if (c.locked) {
      clip.dataset.locked = '1';
      clip.classList.add('clip-locked');
    }
    track.appendChild(clip);
  });
  // Restore group counter
  if (state.groupCounter) _groupCounter = state.groupCounter;
  // Restore markers
  if (state.markers) {
    markers = state.markers;
    markerCounter = state.markerCounter || markers.length;
    renderAllMarkers();
  }
  // Restore loop state
  if (typeof state.loopEnabled !== 'undefined') {
    loopEnabled = state.loopEnabled;
    loopStart = state.loopStart || 0;
    loopEnd = state.loopEnd || 60;
    var lBtn = document.getElementById('loop-btn');
    if (lBtn) lBtn.classList.toggle('active', loopEnabled);
    var lRegion = document.getElementById('loop-region');
    lRegion.classList.toggle('active', loopEnabled);
    if (loopEnabled) updateLoopRegion();
  }
  updateStats();
  saveSession();
}

/* ===== DELETE SELECTED CLIPS ===== */
function deleteSelectedClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('No clips selected'); return; }
  pushUndo();
  var count = 0;
  sel.forEach(function(c) { if (!c.classList.contains('clip-locked')) { c.remove(); count++; } });
  if (count === 0) { toast('All selected clips are locked'); return; }
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession();
  sfx('delete');
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clip' + (count > 1 ? 's' : '') + ' deleted');
}

/* ===== DUPLICATE CLIP ===== */
function duplicateClip() {
  var allSelected = document.querySelectorAll('.clip.selected');
  if (allSelected.length > 1) {
    pushUndo();
    var duped = 0;
    allSelected.forEach(function(src) {
      if (src.classList.contains('clip-locked')) return;
      var ex = getExercise(src.dataset.exerciseId);
      if (!ex) return;
      var track = src.parentElement;
      var newLeft = parseInt(src.style.left) + parseInt(src.style.width) + 4;
      var clip = createClipElement(ex, newLeft, parseInt(src.style.width), {
        sets: src.dataset.sets, reps: src.dataset.reps,
        tempo: src.dataset.tempo, rest: src.dataset.rest,
        rpe: src.dataset.rpe,
        fadeIn: src.dataset.fadeIn || '0', fadeOut: src.dataset.fadeOut || '0'
      });
      if (src.dataset.notes) clip.dataset.notes = src.dataset.notes;
      if (src.dataset.customColor) {
        clip.dataset.customColor = src.dataset.customColor;
        clip.style.background = 'linear-gradient(180deg, ' + src.dataset.customColor + '44 0%, ' + src.dataset.customColor + '22 100%)';
        clip.style.borderTopColor = src.dataset.customColor;
      }
      track.appendChild(clip);
      duped++;
    });
    updateStats(); saveSession(); sfx('drop');
    toast(duped + ' clips duplicated');
    return;
  }
  if (!selectedClip) { toast('Select a clip first'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var track = selectedClip.parentElement;
  var newLeft = parseInt(selectedClip.style.left) + parseInt(selectedClip.style.width) + 4;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: selectedClip.dataset.fadeIn || '0',
    fadeOut: selectedClip.dataset.fadeOut || '0'
  });
  if (selectedClip.dataset.notes) clip.dataset.notes = selectedClip.dataset.notes;
  if (selectedClip.dataset.customColor) {
    clip.dataset.customColor = selectedClip.dataset.customColor;
    clip.style.background = 'linear-gradient(180deg, ' + selectedClip.dataset.customColor + '44 0%, ' + selectedClip.dataset.customColor + '22 100%)';
    clip.style.borderTopColor = selectedClip.dataset.customColor;
  }
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  sfx('drop');
  toast('Duplicated: ' + ex.name);
}

/* ===== SNAP TO GRID ===== */
var snapEnabled = false;

function getSnapSize() {
  // gridRes = beats per snap unit, pps = 80px / 15sec, beatSec = 60/bpm
  var pps = 80 / 15;
  var beatSec = 60 / bpm;
  return Math.round(gridRes * beatSec * pps);
}

function toggleSnap() {
  snapEnabled = !snapEnabled;
  var btn = document.getElementById('btn-snap');
  if (btn) btn.classList.toggle('active', snapEnabled);
  var settingsBtn = document.getElementById('settings-snap');
  if (settingsBtn) settingsBtn.textContent = snapEnabled ? 'ON' : 'OFF';
  var snapBadge = document.getElementById('snap-badge');
  if (snapBadge) {
    snapBadge.classList.toggle('active', snapEnabled);
    snapBadge.textContent = snapEnabled ? 'SNAP ' + gridRes + 'B' : 'SNAP';
  }
  sfx('snap');
  toast(snapEnabled ? 'Snap ON (' + gridRes + ' beat' + (gridRes > 1 ? 's' : '') + ')' : 'Snap OFF');
}

function snapValue(val) {
  if (!snapEnabled) return val;
  var sz = getSnapSize();
  if (sz < 4) sz = 4; // minimum 4px snap to avoid 0-division
  var snapped = Math.round(val / sz) * sz;
  if (snapped !== val) showSnapLine(snapped);
  return snapped;
}
function showSnapLine(x) {
  var container = document.getElementById('timeline-tracks');
  if (!container) return;
  var line = document.createElement('div');
  line.className = 'snap-line';
  line.style.left = x + 'px';
  container.appendChild(line);
  setTimeout(function() { if (line.parentNode) line.remove(); }, 300);
}

/* ===== ZOOM ===== */
var zoomLevel = 100;
var ZOOM_STEPS = [50, 75, 100, 125, 150, 200];

function zoomIn() {
  var idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx < ZOOM_STEPS.length - 1) {
    zoomLevel = ZOOM_STEPS[idx + 1];
    applyZoom();
    toast('Zoom: ' + zoomLevel + '%');
  }
}

function zoomOut() {
  var idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx > 0) {
    zoomLevel = ZOOM_STEPS[idx - 1];
    applyZoom();
    toast('Zoom: ' + zoomLevel + '%');
  }
}

function zoomToFit() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to fit'); return; }
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  maxRight += 120; // padding for track headers + margin
  var containerW = document.getElementById('timeline-container').clientWidth;
  var targetZoom = Math.round(containerW / maxRight * 100);
  // Clamp to zoom steps
  var bestStep = ZOOM_STEPS[0];
  for (var i = 0; i < ZOOM_STEPS.length; i++) {
    if (ZOOM_STEPS[i] <= targetZoom) bestStep = ZOOM_STEPS[i];
  }
  zoomLevel = bestStep;
  applyZoom();
  document.getElementById('timeline-container').scrollLeft = 0;
  toast('Zoom to fit: ' + zoomLevel + '%');
}

function applyZoom() {
  var scale = zoomLevel / 100;
  var tracks = document.getElementById('timeline-tracks');
  var ruler = document.getElementById('timeline-ruler');
  tracks.style.transform = 'scaleX(' + scale + ')';
  tracks.style.transformOrigin = 'left top';
  ruler.style.transform = 'scaleX(' + scale + ')';
  ruler.style.transformOrigin = 'left top';
  document.getElementById('zoom-level').textContent = zoomLevel + '%';
  // Sync footer zoom slider
  var sliderIdx = ZOOM_STEPS.indexOf(zoomLevel);
  if (sliderIdx >= 0) {
    var slider = document.getElementById('zoom-slider');
    if (slider) slider.value = sliderIdx;
  }
  var pct = document.getElementById('zoom-pct');
  if (pct) pct.textContent = zoomLevel + '%';
  // Toggle 16th note grid at higher zoom levels
  var trackContents = document.querySelectorAll('.track-content');
  trackContents.forEach(function(tc) {
    if (zoomLevel >= 125) {
      tc.classList.add('grid-16th');
    } else {
      tc.classList.remove('grid-16th');
    }
  });
  sfx('click');
}

function setZoomFromSlider(val) {
  var idx = parseInt(val);
  if (idx >= 0 && idx < ZOOM_STEPS.length) {
    zoomLevel = ZOOM_STEPS[idx];
    applyZoom();
  }
}

/* ===== SCROLL TO PLAYHEAD (Locate) ===== */
function scrollToPlayhead() {
  var container = document.getElementById('timeline-container');
  var playhead = document.getElementById('playhead');
  if (!container || !playhead) return;
  var phLeft = parseInt(playhead.style.left) || 100;
  var scale = zoomLevel / 100;
  var viewCenter = container.clientWidth / 2;
  container.scrollLeft = (phLeft * scale) - viewCenter;
  sfx('click');
  toast('Locate: playhead');
}

/* ===== CONTEXT MENU ===== */
var ctxClip = null, ctxExercise = null;
function showClipContextMenu(x, y, clip, exercise) {
  ctxClip = clip;
  ctxExercise = exercise;
  var menu = document.getElementById('clip-context-menu');
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.add('open');
  // Adjust if overflows viewport
  var rect = menu.getBoundingClientRect();
  if (rect.right > window.innerWidth) menu.style.left = (x - rect.width) + 'px';
  if (rect.bottom > window.innerHeight) menu.style.top = (y - rect.height) + 'px';
}

function hideContextMenu() {
  document.getElementById('clip-context-menu').classList.remove('open');
  ctxClip = null;
  ctxExercise = null;
}

document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.clip-context-menu')) hideContextMenu();
  });
  document.getElementById('clip-context-menu').addEventListener('click', function(e) {
    var item = e.target.closest('.ctx-item');
    if (!item || !ctxClip) return;
    var action = item.dataset.action;
    if (action === 'duplicate') {
      selectClipEl(ctxClip);
      duplicateClip();
    } else if (action === 'inspect') {
      selectClipEl(ctxClip);
    } else if (action === 'split') {
      selectClipEl(ctxClip);
      splitClipAtPlayhead();
    } else if (action === 'snap-start') {
      pushUndo();
      ctxClip.style.left = '0px';
      saveSession(); updateStats();
      toast('Snapped to start');
    } else if (action === 'snap-next') {
      pushUndo();
      var track = ctxClip.parentElement;
      var clips = track.querySelectorAll('.clip');
      var maxRight = 0;
      clips.forEach(function(c) {
        if (c === ctxClip) return;
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      ctxClip.style.left = (maxRight + 2) + 'px';
      saveSession(); updateStats();
      toast('Snapped after previous');
    } else if (action === 'rpe-up' || action === 'rpe-down') {
      var rpe = parseInt(ctxClip.dataset.rpe) || 7;
      rpe = action === 'rpe-up' ? Math.min(10, rpe + 1) : Math.max(1, rpe - 1);
      ctxClip.dataset.rpe = rpe;
      if (typeof updateClipVisuals === 'function') updateClipVisuals(ctxClip, rpe);
      saveSession();
      toast('RPE: ' + rpe);
    } else if (action.indexOf('move-') === 0) {
      var targetTrackId = action.replace('move-', '');
      var targetTrack = document.querySelector('.track-content[data-track="'+targetTrackId+'"]');
      if (targetTrack && ctxClip.parentElement !== targetTrack) {
        pushUndo();
        targetTrack.appendChild(ctxClip);
        updateStats(); saveSession();
        sfx('drop');
        toast('Moved to ' + targetTrackId);
      }
    } else if (action === 'color') {
      var swatch = e.target.closest('.ctx-color-swatch');
      if (swatch) {
        var newColor = swatch.dataset.color;
        pushUndo();
        if (newColor) {
          ctxClip.dataset.customColor = newColor;
          ctxClip.style.background = 'linear-gradient(180deg, ' + newColor + '44 0%, ' + newColor + '22 100%)';
          ctxClip.style.borderTopColor = newColor;
        } else {
          delete ctxClip.dataset.customColor;
          var ex = getExercise(ctxClip.dataset.exerciseId);
          if (ex) {
            var fm = FAMILY_MAP[ex.family] || {};
            var baseColor = fm.color || '#3b82f6';
            ctxClip.style.background = 'linear-gradient(180deg, ' + baseColor + '44 0%, ' + baseColor + '22 100%)';
            ctxClip.style.borderTopColor = baseColor;
          }
        }
        saveSession();
        toast(newColor ? 'Color set' : 'Color reset');
      }
    } else if (action === 'stage-up' || action === 'stage-down') {
      var curEx = getExercise(ctxClip.dataset.exerciseId);
      if (curEx) {
        var targetStage = action === 'stage-up' ? curEx.stage + 1 : curEx.stage - 1;
        var sibling = EXERCISES.filter(function(e) { return e.pattern === curEx.pattern && e.stage === targetStage; })[0];
        if (sibling) {
          selectClipEl(ctxClip);
          swapClipExercise(sibling.id);
        } else {
          toast('No stage ' + targetStage + ' for this pattern');
        }
      }
    } else if (action === 'group') {
      groupSelectedClips();
    } else if (action === 'ungroup') {
      ungroupSelectedClips();
    } else if (action === 'reset-fades') {
      ctxClip.dataset.fadeIn = '0';
      ctxClip.dataset.fadeOut = '0';
      var fadeInEl = ctxClip.querySelector('.clip-fade-in');
      var fadeOutEl = ctxClip.querySelector('.clip-fade-out');
      if (fadeInEl) { fadeInEl.style.width = '0px'; fadeInEl.classList.remove('has-fade'); }
      if (fadeOutEl) { fadeOutEl.style.width = '0px'; fadeOutEl.classList.remove('has-fade'); }
      updateFadeOverlay(ctxClip);
      saveSession();
      toast('Fades reset');
    } else if (action === 'toggle-lock') {
      ctxClip.classList.toggle('clip-locked');
      ctxClip.dataset.locked = ctxClip.classList.contains('clip-locked') ? '1' : '';
      saveSession();
      toast(ctxClip.classList.contains('clip-locked') ? 'Clip locked' : 'Clip unlocked');
    } else if (action === 'delete') {
      pushUndo();
      ctxClip.remove();
      if (selectedClip === ctxClip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      sfx('delete');
      toast('Clip deleted');
    }
    hideContextMenu();
  });
});

/* ===== CLICK-TO-SEEK + DRAG-TO-SCRUB ON RULER ===== */
document.addEventListener('DOMContentLoaded', function() {
  var ruler = document.getElementById('timeline-ruler');
  ruler.style.cursor = 'pointer';
  var _rulerScrubbing = false;
  function rulerSeek(e) {
    var rect = ruler.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = (80 / 15) * (zoomLevel / 100);
    var ho = 100 * (zoomLevel / 100);
    currentTime = Math.max(0, (x - ho) / pps);
    if (snapEnabled) {
      var beatSec = 60 / bpm;
      currentTime = Math.round(currentTime / beatSec) * beatSec;
    }
    updateTimeDisplay();
    updatePlayheadPosition();
  }
  ruler.addEventListener('mousedown', function(e) {
    if (e.altKey) return; /* Alt+click handled by loop drag */
    if (e.button !== 0) return;
    e.preventDefault();
    _rulerScrubbing = true;
    rulerSeek(e);
    sfx('click');
    function onMove(e) { if (_rulerScrubbing) rulerSeek(e); }
    function onUp() {
      _rulerScrubbing = false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Double-click ruler to add marker at that position */
  ruler.addEventListener('dblclick', function(e) {
    if (e.altKey) return;
    var rect = ruler.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = (80 / 15) * (zoomLevel / 100);
    var ho = 100 * (zoomLevel / 100);
    var timeSec = Math.max(0, (x - ho) / pps);
    addMarkerAt(timeSec);
  });
  /* Click track header to highlight active track, double-click to collapse */
  document.querySelectorAll('.track-header').forEach(function(header) {
    header.addEventListener('click', function() {
      document.querySelectorAll('.track.track-active').forEach(function(t) { t.classList.remove('track-active'); });
      header.closest('.track').classList.add('track-active');
    });
    header.addEventListener('dblclick', function() {
      header.closest('.track').classList.toggle('track-collapsed');
    });
    header.addEventListener('contextmenu', function(e) {
      showTrackCtx(e, header.closest('.track'));
    });
  });
  /* Timecode scrub — drag on time display to scrub */
  var timeDisp = document.getElementById('time-display');
  timeDisp.style.cursor = 'ew-resize';
  timeDisp.addEventListener('mousedown', function(e) {
    e.preventDefault();
    var startX = e.clientX;
    var startTime = currentTime;
    function onMove(e) {
      var delta = (e.clientX - startX) * 0.5; // 0.5s per pixel
      currentTime = Math.max(0, startTime + delta);
      updateTimeDisplay();
      updatePlayheadPosition();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Click on empty timeline area to seek */
  var tracks = document.getElementById('timeline-tracks');
  tracks.addEventListener('click', function(e) {
    if (e.target.closest('.clip') || e.target.closest('.track-header')) return;
    var rect = tracks.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = 80 / 15;
    var scale = zoomLevel / 100;
    currentTime = Math.max(0, (x / scale - 100) / pps);
    updateTimeDisplay();
    updatePlayheadPosition();
  });
  /* Rubber band selection on timeline */
  tracks.addEventListener('mousedown', function(e) {
    if (e.target.closest('.clip') || e.target.closest('.track-header') || e.button !== 0) return;
    var container = document.getElementById('timeline-container');
    var rect = tracks.getBoundingClientRect();
    var startX = e.clientX - rect.left + container.scrollLeft;
    var startY = e.clientY - rect.top + container.scrollTop;
    var box = document.createElement('div');
    box.className = 'select-box';
    tracks.appendChild(box);
    function onMove(e) {
      var curX = e.clientX - rect.left + container.scrollLeft;
      var curY = e.clientY - rect.top + container.scrollTop;
      var x1 = Math.min(startX, curX), x2 = Math.max(startX, curX);
      var y1 = Math.min(startY, curY), y2 = Math.max(startY, curY);
      box.style.left = x1 + 'px';
      box.style.top = y1 + 'px';
      box.style.width = (x2 - x1) + 'px';
      box.style.height = (y2 - y1) + 'px';
      // Highlight clips inside selection box
      document.querySelectorAll('.clip').forEach(function(c) {
        var cl = parseInt(c.style.left) || 0;
        var cw = parseInt(c.style.width) || 0;
        var ct = c.closest('.track');
        var tOff = ct ? ct.offsetTop : 0;
        var ch = ct ? ct.offsetHeight : 60;
        var inX = cl + cw > x1 && cl < x2;
        var inY = tOff + ch > y1 && tOff < y2;
        if (inX && inY) {
          c.classList.add('selected');
        } else if (!e.shiftKey) {
          c.classList.remove('selected');
        }
      });
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      box.remove();
      var sel = document.querySelectorAll('.clip.selected');
      if (sel.length > 0) {
        selectedClip = sel[sel.length - 1];
        toast(sel.length + ' clip' + (sel.length > 1 ? 's' : '') + ' selected');
      }
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Init loop region drag interaction */
  initLoopDrag();
  initRulerLoopDrag();
});

/* ===== MOUSE WHEEL ZOOM on Timeline ===== */
document.addEventListener('DOMContentLoaded', function() {
  var container = document.getElementById('timeline-container');
  container.addEventListener('wheel', function(e) {
    if (e.metaKey || e.ctrlKey) {
      e.preventDefault();
      var rect = container.getBoundingClientRect();
      var mouseX = e.clientX - rect.left;
      var scrollBefore = container.scrollLeft;
      var oldZoom = zoomLevel;
      if (e.deltaY < 0) { zoomIn(); } else { zoomOut(); }
      if (zoomLevel !== oldZoom) {
        var ratio = zoomLevel / oldZoom;
        container.scrollLeft = (scrollBefore + mouseX) * ratio - mouseX;
      }
    }
  }, { passive: false });
});

/* ===== TRACK RESIZE HANDLES ===== */
document.addEventListener('DOMContentLoaded', function() {
  var allTracks = document.querySelectorAll('.track');
  allTracks.forEach(function(track, i) {
    if (i === allTracks.length - 1) return; // no handle on last track
    var handle = document.createElement('div');
    handle.className = 'track-resize-handle';
    track.parentElement.insertBefore(handle, track.nextSibling);
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      var startY = e.clientY;
      var startH = track.offsetHeight;
      function onMove(e) {
        var newH = Math.max(24, Math.min(200, startH + (e.clientY - startY)));
        track.style.height = newH + 'px';
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
});

/* ===== PLAYHEAD ANIMATION ===== */
function updatePlayheadClass() {
  var ph = document.getElementById('playhead');
  if (isPlaying) { ph.classList.add('playing'); } else { ph.classList.remove('playing'); }
}

var focusMode = false;
function toggleFocusMode() {
  focusMode = !focusMode;
  var main = document.querySelector('.main');
  var indicator = document.getElementById('focus-indicator');
  if (focusMode) {
    main.classList.add('focus-mode');
    indicator.classList.add('visible');
    toast('Focus mode — press F to exit');
  } else {
    main.classList.remove('focus-mode');
    indicator.classList.remove('visible');
    toast('Focus mode off');
  }
  sfx('click');
}

function updateStatusDot() {
  var dot = document.querySelector('.status-dot');
  if (!dot) return;
  dot.classList.remove('playing', 'recording');
  if (isRecording) { dot.classList.add('recording'); }
  else if (isPlaying) { dot.classList.add('playing'); }
  // Sync BPM pulse timing
  var d = (60 / bpm).toFixed(3);
  dot.style.setProperty('--bpm-duration', d + 's');
}

/* ===== MARKERS ===== */
function addMarker() {
  addMarkerAt(currentTime);
}

function addMarkerAt(timeSec) {
  markerCounter++;
  var marker = {id: markerCounter, time: timeSec, label: 'M' + markerCounter};
  markers.push(marker);
  renderMarker(marker);
  saveSession();
  sfx('click');
  toast('Marker ' + markerCounter + ' at ' + formatTime(timeSec));
}

function renderMarker(marker) {
  var pps = 80 / 15;
  var pos = 100 + marker.time * pps;
  var el = document.createElement('div');
  el.className = 'marker';
  el.dataset.markerId = marker.id;
  el.style.left = pos + 'px';
  el.innerHTML = '<div class="marker-flag">' + marker.label + '</div><div class="marker-line"></div>';
  el.addEventListener('click', function(e) {
    e.stopPropagation();
    currentTime = marker.time;
    updateTimeDisplay();
    updatePlayheadPosition();
    sfx('click');
  });
  el.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    el.remove();
    markers = markers.filter(function(m) { return m.id !== marker.id; });
    sfx('delete');
    toast('Marker removed');
  });
  document.getElementById('timeline-tracks').appendChild(el);
}

function renderAllMarkers() {
  document.querySelectorAll('.marker').forEach(function(m) { m.remove(); });
  markers.forEach(function(m) { renderMarker(m); });
}
function clearAllMarkers() {
  if (markers.length === 0) { toast('No markers to clear'); return; }
  pushUndo();
  markers = [];
  markerCounter = 0;
  document.querySelectorAll('.marker').forEach(function(m) { m.remove(); });
  saveSession();
  toast('All markers cleared');
}

/* ===== FOOTER MODE TOGGLE ===== */
var footerMode = 'bars'; // 'bars' or 'time'
function toggleFooterMode() {
  footerMode = footerMode === 'bars' ? 'time' : 'bars';
  updateTimeDisplay();
  toast('Position: ' + (footerMode === 'bars' ? 'Bars.Beats.Ticks' : 'Time'));
}

/* ===== COMMAND PALETTE ===== */
var CMD_ACTIONS = [
  {label:'Play / Pause', key:'Space', icon:'\u25B6', action: function() { togglePlay(); }},
  {label:'Stop', key:'Esc', icon:'\u25A0', action: function() { stopPlayback(); }},
  {label:'Toggle Snap', key:'S', icon:'\u2593', action: function() { toggleSnap(); }},
  {label:'Toggle Loop', key:'L', icon:'\u21BB', action: function() { toggleLoop(); }},
  {label:'Toggle Metronome', key:'', icon:'\u266A', action: function() { toggleMetronome(); }},
  {label:'Add Marker', key:'M', icon:'\u2691', action: function() { addMarker(); }},
  {label:'Clear All Markers', key:'', icon:'\u2691', action: function() { clearAllMarkers(); }},
  {label:'Split Clip', key:'B', icon:'\u2702', action: function() { splitClipAtPlayhead(); }},
  {label:'Copy Clips', key:'Cmd+C', icon:'\u2398', action: function() { copyClips(); }},
  {label:'Paste Clips', key:'Cmd+V', icon:'\u2398', action: function() { pasteClips(); }},
  {label:'Duplicate Clip', key:'Cmd+D', icon:'\u2398', action: function() { duplicateClip(); }},
  {label:'Duplicate Track', key:'Cmd+Shift+D', icon:'\u2398', action: function() { duplicateTrackClips(); }},
  {label:'Zoom to Fit', key:'', icon:'\u2922', action: function() { zoomToFit(); }},
  {label:'Zoom In', key:'Cmd++', icon:'+', action: function() { zoomIn(); }},
  {label:'Zoom Out', key:'Cmd+-', icon:'-', action: function() { zoomOut(); }},
  {label:'Zoom Reset (100%)', key:'Cmd+0', icon:'1:1', action: function() { zoomLevel = 100; applyZoom(); toast('Zoom reset: 100%'); }},
  {label:'Toggle Focus Mode', key:'F', icon:'\u2B1C', action: function() { toggleFocusMode(); }},
  {label:'Tap Tempo', key:'T', icon:'\u266A', action: function() { tapTempo(); }},
  {label:'Select All Clips', key:'Cmd+A', icon:'\u2610', action: function() { document.querySelectorAll('.clip').forEach(function(c){c.classList.add('selected')}); toast('All selected'); }},
  {label:'Quantize All Clips', key:'Q', icon:'\u2593', action: function() { quantizeClips(); }},
  {label:'Auto-Arrange Clips', key:'', icon:'\u21F6', action: function() { autoArrange(); }},
  {label:'Humanize Clips', key:'', icon:'\u223F', action: function() { humanizeClips(); }},
  {label:'Spread Clips Evenly', key:'', icon:'\u21F6', action: function() { spreadClipsEvenly(); }},
  {label:'Select Track Clips', key:'Cmd+Shift+A', icon:'\u2610', action: function() { var at=document.querySelector('.track.track-active .track-content'); if(at){document.querySelectorAll('.clip.selected').forEach(function(c){c.classList.remove('selected')});at.querySelectorAll('.clip').forEach(function(c){c.classList.add('selected')});if(typeof updateSelectionBadge==='function')updateSelectionBadge();toast('Track clips selected');} }},
  {label:'Invert Selection', key:'Cmd+I', icon:'\u21C4', action: function() { document.querySelectorAll('.clip').forEach(function(c){c.classList.toggle('selected')}); if(typeof updateSelectionBadge==='function')updateSelectionBadge(); toast('Selection inverted'); }},
  {label:'Clear All Clips', key:'', icon:'\u2716', action: function() { clearAllClips(); }},
  {label:'Save Session', key:'Cmd+S', icon:'\u2913', action: function() { saveSession(); sfx('click'); toast('Session saved'); }},
  {label:'Save as Named Workout', key:'', icon:'\u2913', action: function() { saveNamedWorkout(); }},
  {label:'Load Workout', key:'', icon:'\u2912', action: function() { showSavedWorkouts(); }},
  {label:'Export JSON', key:'', icon:'\u21A6', action: function() { exportWorkout(); }},
  {label:'Import Workout', key:'', icon:'\u21A4', action: function() { importWorkout(); }},
  {label:'Export CSV', key:'', icon:'\u21A6', action: function() { exportCSV(); }},
  {label:'Print Sheet', key:'', icon:'\u2399', action: function() { printWorkout(); }},
  {label:'Workout Summary', key:'', icon:'\u2261', action: function() { showSummary(); }},
  {label:'Generate Random', key:'G', icon:'\u2684', action: function() { generateRandom(); }},
  {label:'Rename Workout', key:'', icon:'\u270E', action: function() { renameWorkout(); }},
  {label:'Toggle Presets', key:'P', icon:'\u2630', action: function() { togglePresets(); }},
  {label:'Keyboard Shortcuts', key:'?', icon:'\u2328', action: function() { toggleShortcuts(); }},
  {label:'Reset Session', key:'', icon:'\u21BA', action: function() { resetSession(); }},
  {label:'Scroll to Playhead', key:'', icon:'\u25B8', action: function() { scrollToPlayhead(); }},
  {label:'Toggle Auto-Scroll', key:'', icon:'\u21C5', action: function() { toggleAutoScrollFromTransport(); }},
  {label:'Deselect All', key:'Esc', icon:'\u2610', action: function() { document.querySelectorAll('.clip.selected').forEach(function(c){c.classList.remove('selected')}); selectedClip=null; document.getElementById('inspector').style.display='none'; if(typeof updateSelectionBadge==='function')updateSelectionBadge(); toast('Deselected'); }},
  {label:'Toggle Record Mode', key:'R', icon:'\u23FA', action: function() { toggleRec(); }},
  {label:'Cycle Time Signature', key:'', icon:'4/4', action: function() { cycleTimeSig(); }},
  {label:'Collapse All Tracks', key:'Shift+C', icon:'\u25BC', action: function() { document.querySelectorAll('.track').forEach(function(t){if(t.dataset.track!=='music')t.classList.add('track-collapsed')}); toast('Tracks collapsed'); }},
  {label:'Expand All Tracks', key:'', icon:'\u25B2', action: function() { document.querySelectorAll('.track').forEach(function(t){t.classList.remove('track-collapsed')}); toast('Tracks expanded'); }},
  {label:'Move Clip Up', key:'\u2191', icon:'\u2191', action: function() { if(!selectedClip)return; var tids=['push','pull','core','legs','skills']; var ci=tids.indexOf(selectedClip.parentElement.dataset.track); if(ci>0){pushUndo();var nt=document.querySelector('.track-content[data-track="'+tids[ci-1]+'"]');selectedClip.parentElement.removeChild(selectedClip);nt.appendChild(selectedClip);saveSession();updateStats();toast('Moved up');} }},
  {label:'Move Clip Down', key:'\u2193', icon:'\u2193', action: function() { if(!selectedClip)return; var tids=['push','pull','core','legs','skills']; var ci=tids.indexOf(selectedClip.parentElement.dataset.track); if(ci>=0&&ci<tids.length-1){pushUndo();var nt=document.querySelector('.track-content[data-track="'+tids[ci+1]+'"]');selectedClip.parentElement.removeChild(selectedClip);nt.appendChild(selectedClip);saveSession();updateStats();toast('Moved down');} }},
  {label:'Delete Selected Clips', key:'Del', icon:'\u2716', action: function() { deleteSelectedClips(); }},
  {label:'Group Selected Clips', key:'Cmd+G', icon:'\u2B1C', action: function() { groupSelectedClips(); }},
  {label:'Ungroup Selected Clips', key:'Cmd+Shift+G', icon:'\u2B1C', action: function() { ungroupSelectedClips(); }},
  {label:'Share Workout (URL)', key:'', icon:'\u21A6', action: function() { shareWorkout(); }},
  {label:'Copy Workout as Text', key:'', icon:'\u2398', action: function() { copyWorkoutText(); }},
  {label:'Cycle Playback Speed', key:'', icon:'\u25B6', action: function() { cyclePlaybackSpeed(); }},
  {label:'Playback 0.5x', key:'', icon:'\u25B6', action: function() { playbackSpeed=0.5; document.getElementById('speed-btn').textContent='0.5x'; toast('Speed: 0.5x'); }},
  {label:'Playback 1x (Normal)', key:'', icon:'\u25B6', action: function() { playbackSpeed=1; document.getElementById('speed-btn').textContent='1x'; toast('Speed: 1x'); }},
  {label:'Playback 2x', key:'', icon:'\u25B6', action: function() { playbackSpeed=2; document.getElementById('speed-btn').textContent='2x'; toast('Speed: 2x'); }},
  {label:'Reverse Track Order', key:'', icon:'\u21C4', action: function() { reverseTrackClips(); }},
  {label:'Lock / Unlock Clip', key:'Cmd+L', icon:'\u2693', action: function() { if(!selectedClip)return; selectedClip.classList.toggle('clip-locked'); selectedClip.dataset.locked=selectedClip.classList.contains('clip-locked')?'1':''; saveSession(); toast(selectedClip.classList.contains('clip-locked')?'Locked':'Unlocked'); }},
  {label:'Reset All Faders', key:'', icon:'\u21BA', action: function() { FADERS.forEach(function(f){resetFader(f.id);}); toast('All faders reset'); }},
  {label:'Reset All Knobs', key:'', icon:'\u21BA', action: function() { KNOBS.forEach(function(k){resetKnob(k.id);}); toast('All knobs reset'); }},
  {label:'Next Marker', key:'N', icon:'\u25B8', action: function() { var e={code:'KeyN',shiftKey:false,metaKey:false,ctrlKey:false,preventDefault:function(){}}; if(markers.length===0){toast('No markers');return;} var sorted=markers.slice().sort(function(a,b){return a.time-b.time;}); var next=null; for(var i=0;i<sorted.length;i++){if(sorted[i].time>currentTime+0.1){next=sorted[i];break;}} if(next){currentTime=next.time;updateTimeDisplay();updatePlayheadPosition();toast('Marker: '+next.label);}else{toast('No next marker');} }},
  {label:'Previous Marker', key:'Shift+N', icon:'\u25C2', action: function() { if(markers.length===0){toast('No markers');return;} var sorted=markers.slice().sort(function(a,b){return a.time-b.time;}); var prev=null; for(var i=sorted.length-1;i>=0;i--){if(sorted[i].time<currentTime-0.1){prev=sorted[i];break;}} if(prev){currentTime=prev.time;updateTimeDisplay();updatePlayheadPosition();toast('Marker: '+prev.label);}else{toast('No previous marker');} }},
  {label:'Jump to Start', key:'Home', icon:'\u25C0', action: function() { currentTime=0; updateTimeDisplay(); updatePlayheadPosition(); toast('Start'); }},
  {label:'Jump to End', key:'End', icon:'\u25B6', action: function() { var maxR=0; document.querySelectorAll('.clip').forEach(function(c){var r=(parseInt(c.style.left)+parseInt(c.style.width)-100)/(80/15); if(r>maxR)maxR=r;}); currentTime=Math.max(0,maxR); updateTimeDisplay(); updatePlayheadPosition(); toast('End'); }},
  {label:'Collapse Active Track', key:'C', icon:'\u25BC', action: function() { var t=document.querySelector('.track.track-active'); if(t){t.classList.toggle('track-collapsed');toast(t.classList.contains('track-collapsed')?'Collapsed':'Expanded');} }},
  {label:'Clear Track Clips', key:'', icon:'\u2716', action: function() { clearTrackClips(); }},
  {label:'Stage Up', key:'PgUp', icon:'\u25B2', action: function() { if(!selectedClip)return; var ex=getExercise(selectedClip.dataset.exerciseId); if(!ex)return; var sib=EXERCISES.filter(function(e){return e.pattern===ex.pattern&&e.stage===ex.stage+1;})[0]; if(sib){pushUndo();swapClipExercise(sib.id);toast('Stage '+(ex.stage+1)+': '+sib.name);}else{toast('Max stage');} }},
  {label:'Stage Down', key:'PgDn', icon:'\u25BC', action: function() { if(!selectedClip)return; var ex=getExercise(selectedClip.dataset.exerciseId); if(!ex)return; var sib=EXERCISES.filter(function(e){return e.pattern===ex.pattern&&e.stage===ex.stage-1;})[0]; if(sib){pushUndo();swapClipExercise(sib.id);toast('Stage '+(ex.stage-1)+': '+sib.name);}else{toast('Min stage');} }},
  {label:'Auto-Name Workout', key:'', icon:'\u270E', action: function() { autoNameWorkout(); }},
  {label:'Paste at Playhead', key:'Cmd+Shift+V', icon:'\u2398', action: function() { pasteAtPlayhead(); }},
  {label:'Select Push Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Push'); }},
  {label:'Select Pull Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Pull'); }},
  {label:'Select Core Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Core'); }},
  {label:'Select Legs Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Legs'); }},
  {label:'Select Skills Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Skills'); }},
  {label:'Set BPM 60', key:'', icon:'\u266A', action: function() { bpm=60; document.getElementById('bpm-input').value=60; updateBPM(); toast('BPM: 60'); }},
  {label:'Set BPM 80', key:'', icon:'\u266A', action: function() { bpm=80; document.getElementById('bpm-input').value=80; updateBPM(); toast('BPM: 80'); }},
  {label:'Set BPM 100', key:'', icon:'\u266A', action: function() { bpm=100; document.getElementById('bpm-input').value=100; updateBPM(); toast('BPM: 100'); }},
  {label:'Set BPM 120', key:'', icon:'\u266A', action: function() { bpm=120; document.getElementById('bpm-input').value=120; updateBPM(); toast('BPM: 120'); }},
  {label:'Set BPM 140', key:'', icon:'\u266A', action: function() { bpm=140; document.getElementById('bpm-input').value=140; updateBPM(); toast('BPM: 140'); }},
  {label:'Set BPM 160', key:'', icon:'\u266A', action: function() { bpm=160; document.getElementById('bpm-input').value=160; updateBPM(); toast('BPM: 160'); }},
  {label:'Workout Stats', key:'', icon:'\u2139', action: function() { showWorkoutStats(); }},
  {label:'Toggle Grid Lines', key:'', icon:'\u2591', action: function() { toggleGridLines(); }},
  {label:'Clear Recent Exercises', key:'', icon:'\u2716', action: function() { recentExercises=[]; updateRecentSection(); toast('Recent exercises cleared'); }},
  {label:'Reset All Clip Colors', key:'', icon:'\u25A0', action: function() { pushUndo(); document.querySelectorAll('.clip').forEach(function(c){ if(c.dataset.customColor){ delete c.dataset.customColor; var ex=getExercise(c.dataset.exerciseId); var fc=(ex&&FAMILY_MAP[ex.family])?FAMILY_MAP[ex.family].color:'#666'; c.style.background='linear-gradient(180deg, '+fc+'22 0%, '+fc+'11 100%)'; c.style.borderTopColor=fc+'44'; }}); saveSession(); toast('Clip colors reset to family defaults'); }},
  {label:'Copy Clip Info', key:'', icon:'\u2398', action: function() { if(!selectedClip){toast('Select a clip');return;} var ex=getExercise(selectedClip.dataset.exerciseId); var txt=(ex?ex.name:'Clip')+' | '+selectedClip.dataset.sets+'x'+selectedClip.dataset.reps+' @ '+selectedClip.dataset.tempo+'s | Rest: '+selectedClip.dataset.rest+'s | RPE: '+selectedClip.dataset.rpe+(ex?' | '+ex.family+' S'+ex.stage:''); navigator.clipboard.writeText(txt).then(function(){toast('Clip info copied');}); }},
  {label:'Shift All RPE +1', key:'', icon:'\u25B2', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip').forEach(function(cl){ var r=parseInt(cl.dataset.rpe)||7; if(r<10){cl.dataset.rpe=r+1; var b=cl.querySelector('.clip-rpe-badge'); if(b)b.textContent=r+1; c++;} }); saveSession(); toast(c+' clips RPE +1'); }},
  {label:'Shift All RPE -1', key:'', icon:'\u25BC', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip').forEach(function(cl){ var r=parseInt(cl.dataset.rpe)||7; if(r>1){cl.dataset.rpe=r-1; var b=cl.querySelector('.clip-rpe-badge'); if(b)b.textContent=r-1; c++;} }); saveSession(); toast(c+' clips RPE -1'); }},
  {label:'Select Stage 1 Clips', key:'', icon:'S1', action: function() { selectClipsByStage(1); }},
  {label:'Select Stage 2 Clips', key:'', icon:'S2', action: function() { selectClipsByStage(2); }},
  {label:'Select Stage 3 Clips', key:'', icon:'S3', action: function() { selectClipsByStage(3); }},
  {label:'Set All to Stage 1', key:'', icon:'S1', action: function() { setAllStage(1); }},
  {label:'Set All to Stage 2', key:'', icon:'S2', action: function() { setAllStage(2); }},
  {label:'Set All to Stage 3', key:'', icon:'S3', action: function() { setAllStage(3); }},
  {label:'Set All Rest 30s', key:'', icon:'\u23F1', action: function() { setAllRest(30); }},
  {label:'Set All Rest 60s', key:'', icon:'\u23F1', action: function() { setAllRest(60); }},
  {label:'Set All Rest 90s', key:'', icon:'\u23F1', action: function() { setAllRest(90); }},
  {label:'Set All Rest 120s', key:'', icon:'\u23F1', action: function() { setAllRest(120); }},
  {label:'Set All Tempo 2s', key:'', icon:'\u23F1', action: function() { setAllTempo(2); }},
  {label:'Set All Tempo 3s', key:'', icon:'\u23F1', action: function() { setAllTempo(3); }},
  {label:'Set All Tempo 4s', key:'', icon:'\u23F1', action: function() { setAllTempo(4); }},
  {label:'Set All Tempo 5s', key:'', icon:'\u23F1', action: function() { setAllTempo(5); }},
  {label:'Complexity Score', key:'', icon:'\u2139', action: function() { showComplexityScore(); }},
  {label:'Edit Workout Notes', key:'', icon:'\u270E', action: function() { showInlinePrompt('Workout Notes', workoutNotes, function(v){ workoutNotes=v; saveSession(); toast('Notes saved'); }); }},
  {label:'Lock All Clips', key:'', icon:'\u2693', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip').forEach(function(cl){if(!cl.classList.contains('clip-locked')){cl.classList.add('clip-locked');cl.dataset.locked='1';c++;}}); saveSession(); toast(c+' clips locked'); }},
  {label:'Unlock All Clips', key:'', icon:'\u2693', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip.clip-locked').forEach(function(cl){cl.classList.remove('clip-locked');cl.dataset.locked='';c++;}); saveSession(); toast(c+' clips unlocked'); }},
  {label:'Duplicate to Next Bar', key:'', icon:'\u25B8', action: function() { duplicateToNextBar(); }},
  {label:'Fill Track with Exercise', key:'', icon:'\u2593', action: function() { fillTrackWithExercise(); }},
  {label:'Mirror Workout', key:'', icon:'\u21C4', action: function() { mirrorWorkout(); }},
  {label:'Swap Two Clips', key:'', icon:'\u21C4', action: function() { swapTwoClips(); }},
  {label:'Align Clips to Playhead', key:'', icon:'\u25B8', action: function() { alignClipsToPlayhead(); }},
  {label:'Trim Clip to Loop Region', key:'', icon:'\u2702', action: function() { trimClipToLoop(); }},
  {label:'Apply Inspector to Selected', key:'', icon:'\u2913', action: function() { applyInspectorToSelected(); }},
  {label:'Collect to Active Track', key:'', icon:'\u21B3', action: function() { collectToTrack(); }},
  {label:'Stagger Clips (2-beat offset)', key:'', icon:'\u21F6', action: function() { staggerClips(); }},
  {label:'Random Exercise Swap', key:'', icon:'\u2684', action: function() { randomSwapExercise(); }},
  {label:'Randomize All Exercises', key:'', icon:'\u2684', action: function() { randomizeAllExercises(); }},
  {label:'Consolidate Adjacent Clips', key:'', icon:'\u25A0', action: function() { consolidateClips(); }},
  {label:'Exercise Frequency', key:'', icon:'\u2139', action: function() { showExerciseFrequency(); }},
  {label:'Balance Report', key:'', icon:'\u2261', action: function() { showBalanceReport(); }},
  {label:'Scale Durations 0.5x (Half)', key:'', icon:'\u21F6', action: function() { scaleClipDurations(0.5); }},
  {label:'Scale Durations 2x (Double)', key:'', icon:'\u21F6', action: function() { scaleClipDurations(2); }},
  {label:'Quantize Selected Clips', key:'', icon:'\u2593', action: function() { quantizeSelected(); }},
  {label:'Export as Markdown', key:'', icon:'\u21A6', action: function() { exportMarkdown(); }},
  {label:'Compare with Saved Session', key:'', icon:'\u21C4', action: function() { compareWithSaved(); }},
  {label:'Select Clips in Loop Range', key:'', icon:'\u2610', action: function() { selectClipsInLoopRange(); }},
  {label:'Sort Track Alphabetically', key:'', icon:'\u2193', action: function() { sortTrackByName(); }},
  {label:'Compact Track (Remove Gaps)', key:'', icon:'\u25A0', action: function() { compactTrack(); }},
  {label:'Distribute Across Tracks', key:'', icon:'\u21F6', action: function() { distributeAcrossTracks(); }},
  {label:'Cycle Exercise in Pattern', key:'', icon:'\u21BB', action: function() { cycleExerciseInPattern(); }},
  {label:'Compact All Tracks', key:'', icon:'\u25A0', action: function() { compactAllTracks(); }},
  {label:'Select Overlapping Clips', key:'', icon:'\u25C9', action: function() { selectOverlappingClips(); }},
  {label:'Select Superset Clips', key:'', icon:'\u25C9', action: function() { selectSupersetClips(); }},
  {label:'Shift All Clips Right 1 Bar', key:'', icon:'\u25B6', action: function() { shiftAllClips(1); }},
  {label:'Shift All Clips Left 1 Bar', key:'', icon:'\u25C0', action: function() { shiftAllClips(-1); }},
  {label:'Insert Silence at Playhead', key:'', icon:'\u25B8', action: function() { insertSilenceAtPlayhead(); }},
  {label:'Remove Silence at Playhead', key:'', icon:'\u25C2', action: function() { removeSilenceAtPlayhead(); }},
  {label:'Clone Track to Push', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('push'); }},
  {label:'Clone Track to Pull', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('pull'); }},
  {label:'Clone Track to Core', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('core'); }},
  {label:'Clone Track to Legs', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('legs'); }},
  {label:'Clone Track to Skills', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('skills'); }},
  {label:'Export Session Stats', key:'', icon:'\u2139', action: function() { exportSessionStats(); }},
  {label:'Toggle RPE Color Mode', key:'', icon:'\u25A0', action: function() { toggleRpeColorMode(); }},
  {label:'Select Next Clip', key:'J', icon:'\u25B6', action: function() { selectNextClip(); }},
  {label:'Select Previous Clip', key:'K', icon:'\u25C0', action: function() { selectPrevClip(); }},
  {label:'Select Duplicate Exercises', key:'', icon:'\u25C9', action: function() { selectDuplicateExercises(); }},
  {label:'Repeat Last Command', key:'', icon:'\u21BB', action: function() { repeatLastCommand(); }},
  {label:'Select First 30s', key:'', icon:'\u2610', action: function() { selectClipsInTimeRange(0, 30); }},
  {label:'Select First 60s', key:'', icon:'\u2610', action: function() { selectClipsInTimeRange(0, 60); }},
  {label:'Save as Template', key:'', icon:'\u2913', action: function() { saveWorkoutTemplate(); }},
  {label:'Load Template', key:'', icon:'\u2912', action: function() { loadWorkoutTemplate(); }},
  {label:'Half-Time BPM', key:'', icon:'\u00BD', action: function() { halfTimeBPM(); }},
  {label:'Double-Time BPM', key:'', icon:'\u00D7', action: function() { doubleTimeBPM(); }},
  {label:'Export HTML Report', key:'', icon:'\u2B1A', action: function() { exportHTMLReport(); }},
  {label:'Suggest Harder Exercise', key:'', icon:'\u2191', action: function() { suggestProgression('up'); }},
  {label:'Suggest Easier Exercise', key:'', icon:'\u2193', action: function() { suggestProgression('down'); }},
  {label:'Insert Rest Between Clips', key:'', icon:'\u23F8', action: function() { insertRestBetweenClips(); }},
  {label:'Workout Diff vs Saved', key:'', icon:'\u2260', action: function() { workoutDiff(); }},
  {label:'Generate Warmup', key:'', icon:'\u2600', action: function() { generateWarmup(); }},
  {label:'Generate Cooldown', key:'', icon:'\u2744', action: function() { generateCooldown(); }},
  {label:'Split Clip in 2', key:'', icon:'\u2702', action: function() { splitClipEqual(2); }},
  {label:'Split Clip in 3', key:'', icon:'\u2702', action: function() { splitClipEqual(3); }},
  {label:'Split Clip in 4', key:'', icon:'\u2702', action: function() { splitClipEqual(4); }},
  {label:'Start Workout Timer', key:'', icon:'\u23F1', action: function() { startWorkoutTimer(); }},
  {label:'Add Phase Markers', key:'', icon:'\u2691', action: function() { addPhaseMarkers(); }},
  {label:'Show RPE Curve', key:'', icon:'\u2197', action: function() { showRPECurve(); }},
  {label:'Name Superset Groups', key:'', icon:'\u2387', action: function() { nameSupersetGroups(); }},
  {label:'Density Heatmap', key:'', icon:'\u2593', action: function() { showDensityHeatmap(); }},
  {label:'Search & Replace Exercise', key:'', icon:'\u21C4', action: function() { searchReplaceExercise(); }},
  {label:'Progressive RPE (Ascending)', key:'', icon:'\u2197', action: function() { progressiveRPE('ascending'); }},
  {label:'Progressive RPE (Descending)', key:'', icon:'\u2198', action: function() { progressiveRPE('descending'); }},
  {label:'Arrange as Circuit', key:'', icon:'\u21C6', action: function() { arrangeAsCircuit(); }},
  {label:'Time Under Tension', key:'', icon:'\u23F1', action: function() { showTUT(); }},
  {label:'Rate Workout', key:'', icon:'\u2605', action: function() { rateWorkout(); }},
  {label:'Rating History', key:'', icon:'\u2606', action: function() { showRatingHistory(); }},
  {label:'Show Substitutions', key:'', icon:'\u21C4', action: function() { showSubstitutions(); }},
  {label:'Undo History', key:'', icon:'\u238C', action: function() { showUndoHistory(); }},
  {label:'Muscle Group Coverage', key:'', icon:'\u2694', action: function() { showMuscleGroupCoverage(); }},
  {label:'Workout Calendar', key:'', icon:'\u2610', action: function() { showWorkoutCalendar(); }},
  {label:'Add Crossfades', key:'', icon:'\u223C', action: function() { addCrossfadeBetweenClips(); }},
  {label:'Intensity Zones', key:'', icon:'\u2601', action: function() { showIntensityZones(); }},
  {label:'Swap Push <-> Pull', key:'', icon:'\u21C4', action: function() { swapTracks('push', 'pull'); }},
  {label:'Swap Core <-> Legs', key:'', icon:'\u21C4', action: function() { swapTracks('core', 'legs'); }},
  {label:'Export Timeline Image', key:'', icon:'\u2B1A', action: function() { exportTimelineImage(); }},
  {label:'Pattern Balance', key:'', icon:'\u2696', action: function() { showPatternBalance(); }},
  {label:'Paste Exercises from Clipboard', key:'', icon:'\u2398', action: function() { pasteExercisesFromText(); }},
  {label:'Workout Streak', key:'', icon:'\u2605', action: function() { showWorkoutStreak(); }},
  {label:'Compare Saved Workouts', key:'', icon:'\u2194', action: function() { compareSavedWorkouts(); }},
  {label:'Exercise History', key:'', icon:'\u2139', action: function() { showExerciseHistory(); }},
  {label:'Smart Auto-Arrange', key:'', icon:'\u2630', action: function() { smartAutoArrange(); }},
  {label:'Ghost Mode (Dim Unselected)', key:'', icon:'\u25D1', action: function() { toggleGhostMode(); }},
  {label:'Detailed Workout Analysis', key:'', icon:'\u2139', action: function() { detailedWorkoutAnalysis(); }},
  {label:'Exercise Atlas', key:'', icon:'\u2606', action: function() { showExerciseAtlas(); }},
  {label:'Toggle Library (Mobile)', key:'', icon:'\u266B', action: function() { if(isMobileView()) toggleMobileLibrary(); else toast('Desktop: library always visible'); }},
  {label:'Toggle Mixer (Mobile)', key:'', icon:'\u2699', action: function() { if(isMobileView()) toggleMobileInspector(); else toast('Desktop: mixer always visible'); }},
  {label:'Close All Drawers (Mobile)', key:'', icon:'\u2715', action: function() { closeMobileDrawers(); }},
  {label:'Cinematic Workout Intro', key:'', icon:'\u2728', action: function() { showWorkoutIntro(); }},
  {label:'View Achievements', key:'', icon:'\u2605', action: function() { showAllAchievements(); }},
  {label:'Smart Workout Suggestions', key:'', icon:'\u2139', action: function() { suggestWorkoutImprovements(); }},
  {label:'Quick Workout Templates', key:'', icon:'\u2B50', action: function() { showQuickTemplates(); }},
  {label:'Workout Heat Calendar', key:'', icon:'\u2593', action: function() { showWorkoutHeatCalendar(); }},
  {label:'Motivational Quote', key:'', icon:'\u275D', action: function() { toast(getMotivationalQuote()); }},
  {label:'Generate Share Card', key:'', icon:'\u2B06', action: function() { generateShareCard(); }},
  {label:'Show Favorites', key:'', icon:'\u2605', action: function() { updateFavoritePanel(); toast('Favorites updated'); }},
  {label:'Workout History Timeline', key:'', icon:'\u2195', action: function() { showWorkoutHistory(); }},
  {label:'Cheat Sheet (Quick Reference)', key:'', icon:'\u2328', action: function() { showCheatSheet(); }},
  {label:'View Auto-Backups', key:'', icon:'\u21BA', action: function() { showAutoBackups(); }},
  {label:'Scale: Beginner', key:'', icon:'\u25B3', action: function() { scaleWorkoutDifficulty('beginner'); }},
  {label:'Scale: Intermediate', key:'', icon:'\u25B3', action: function() { scaleWorkoutDifficulty('intermediate'); }},
  {label:'Scale: Advanced', key:'', icon:'\u25B3', action: function() { scaleWorkoutDifficulty('advanced'); }},
  {label:'Scale: Elite', key:'', icon:'\u25B3', action: function() { scaleWorkoutDifficulty('elite'); }},
  {label:'Search Exercises (Enhanced)', key:'', icon:'\u2315', action: function() { exerciseSearchModal(); }},
  {label:'Rest Timer 30s', key:'', icon:'\u23F1', action: function() { startRestTimer(30); }},
  {label:'Rest Timer 60s', key:'', icon:'\u23F1', action: function() { startRestTimer(60); }},
  {label:'Rest Timer 90s', key:'', icon:'\u23F1', action: function() { startRestTimer(90); }},
  {label:'Rest Timer 120s', key:'', icon:'\u23F1', action: function() { startRestTimer(120); }},
  {label:'Stop Rest Timer', key:'', icon:'\u2716', action: function() { stopRestTimer(); }},
  {label:'Coaching Notes (Selected Exercise)', key:'', icon:'\u270E', action: function() { var c=document.querySelector('.clip.selected'); if(c) showCoachingNotes(c.getAttribute('data-exercise')); else toast('Select a clip first'); }},
  {label:'Set Reference URL (Selected Exercise)', key:'', icon:'\u2197', action: function() { var c=document.querySelector('.clip.selected'); if(c) setExerciseRef(c.getAttribute('data-exercise')); else toast('Select a clip first'); }},
  {label:'Open Reference URL (Selected Exercise)', key:'', icon:'\u2197', action: function() { var c=document.querySelector('.clip.selected'); if(c) openExerciseRef(c.getAttribute('data-exercise')); else toast('Select a clip first'); }},
  {label:'Theme: Dim', key:'', icon:'\u263E', action: function() { setDarkModeIntensity('dim'); }},
  {label:'Theme: Standard', key:'', icon:'\u2600', action: function() { setDarkModeIntensity('standard'); }},
  {label:'Theme: High Contrast', key:'', icon:'\u2B50', action: function() { setDarkModeIntensity('high'); }},
  {label:'Cycle Theme Intensity', key:'', icon:'\u2B50', action: function() { cycleDarkMode(); }},
  {label:'Compare with Saved Workout', key:'', icon:'\u2194', action: function() { showWorkoutComparison(); }},
  {label:'Progression Tree', key:'', icon:'\u2934', action: function() { showProgressionTree(); }},
  {label:'Volume Breakdown', key:'', icon:'\u2211', action: function() { showVolumeEstimate(); }},
  {label:'Auto-Detect Phases (Warmup/Main/Cooldown)', key:'', icon:'\u25B6', action: function() { autoDetectPhases(); }},
  {label:'Clear Phase Markers', key:'', icon:'\u2716', action: function() { clearPhaseMarkers(); }},
  {label:'Export Session Notes (HTML)', key:'', icon:'\u2709', action: function() { exportSessionNotes(); }},
  {label:'Start Playlist Mode', key:'', icon:'\u25B6', action: function() { startPlaylistMode(); }},
  {label:'Stop Playlist Mode', key:'', icon:'\u25A0', action: function() { stopPlaylistMode(); }},
  {label:'Workout Flow Visualizer', key:'', icon:'\u21C4', action: function() { showWorkoutFlow(); }},
  {label:'Smart Rest Suggestions', key:'', icon:'\u23F1', action: function() { suggestRest(); }},
  {label:'Apply Rest Suggestions', key:'', icon:'\u2714', action: function() { applyRestSuggestions(); }},
  {label:'Take Workout Snapshot', key:'', icon:'\u2B50', action: function() { takeWorkoutSnapshot(); }},
  {label:'Snapshot History', key:'', icon:'\u231A', action: function() { showSnapshotHistory(); }},
  {label:'Build Superset (selected clips)', key:'', icon:'\u2295', action: function() { buildSuperset(); }},
  {label:'Clear All Supersets', key:'', icon:'\u2296', action: function() { clearSupersets(); }},
  {label:'List Superset Groups', key:'', icon:'\u2630', action: function() { listSupersets(); }},
  {label:'Tag Intent: Pick...', key:'', icon:'\u2691', action: function() { showIntentPicker(); }},
  {label:'Tag Intent: Strength', key:'', icon:'\u2691', action: function() { tagClipIntent('Strength'); }},
  {label:'Tag Intent: Hypertrophy', key:'', icon:'\u2691', action: function() { tagClipIntent('Hypertrophy'); }},
  {label:'Tag Intent: Endurance', key:'', icon:'\u2691', action: function() { tagClipIntent('Endurance'); }},
  {label:'Tag Intent: Power', key:'', icon:'\u2691', action: function() { tagClipIntent('Power'); }},
  {label:'Tag Intent: Mobility', key:'', icon:'\u2691', action: function() { tagClipIntent('Mobility'); }},
  {label:'Tag Intent: Skill', key:'', icon:'\u2691', action: function() { tagClipIntent('Skill'); }},
  {label:'Intent Summary', key:'', icon:'\u2691', action: function() { showIntentSummary(); }},
  {label:'Log Personal Record', key:'', icon:'\u2B50', action: function() { showPRLogger(); }},
  {label:'View PR History', key:'', icon:'\u2B50', action: function() { showPRHistory(); }},
  {label:'Periodization Planner', key:'', icon:'\u2630', action: function() { showPeriodization(); }},
  {label:'Timer Presets (Tabata/EMOM/AMRAP)', key:'', icon:'\u23F1', action: function() { showTimerPresets(); }},
  {label:'Stop Timer', key:'', icon:'\u25A0', action: function() { stopTimerPresetOverlay(); }},
  {label:'Export to Calendar (.ics)', key:'', icon:'\u2709', action: function() { exportToCalendar(); }},
  {label:'Movement Journal: New Entry', key:'', icon:'\u270E', action: function() { addJournalEntry(); }},
  {label:'Movement Journal: History', key:'', icon:'\u270E', action: function() { showJournalHistory(); }},
  {label:'Workout Streak Badge', key:'', icon:'\u2B50', action: function() { showStreakBadge(); }},
  {label:'Quick Swap Exercise', key:'', icon:'\u21C4', action: function() { showQuickSwap(); }},
  {label:'Zen Mode (Z key)', key:'z', icon:'\u2600', action: function() { toggleZenMode(); }},
  {label:'Exercise Preview Image', key:'', icon:'\u25B6', action: function() { showExercisePreviewFromClip(); }},
  {label:'Toggle Recovery Prompts', key:'', icon:'\u2764', action: function() { toggleRecoveryPrompts(); }},
  {label:'Recovery Interval: 10 min', key:'', icon:'\u2764', action: function() { setRecoveryInterval(10); }},
  {label:'Recovery Interval: 15 min', key:'', icon:'\u2764', action: function() { setRecoveryInterval(15); }},
  {label:'Recovery Interval: 20 min', key:'', icon:'\u2764', action: function() { setRecoveryInterval(20); }},
  {label:'Toggle UI Sound Effects', key:'', icon:'\u266A', action: function() { toggleUISfx(); }},
  {label:'Export Training Log (Markdown)', key:'', icon:'\u2709', action: function() { exportTrainingLog(); }},
  {label:'Rate Exercise Difficulty', key:'', icon:'\u2B50', action: function() { showDifficultyRater(); }},
  {label:'Difficulty Overview', key:'', icon:'\u2B50', action: function() { showDifficultyOverview(); }},
  {label:'Clone & Modify Workout', key:'', icon:'\u2398', action: function() { showCloneWorkout(); }},
  {label:'Progressive Overload Options', key:'', icon:'\u2191', action: function() { showOverloadOptions(); }},
  {label:'Exercise Tag Editor', key:'', icon:'\u2691', action: function() { showTagEditor(); }},
  {label:'All Exercise Tags', key:'', icon:'\u2691', action: function() { showAllTags(); }},
  {label:'Set Session Goal', key:'', icon:'\u2691', action: function() { setSessionGoal(); }},
  {label:'Check Goal Progress', key:'', icon:'\u2714', action: function() { checkSessionGoals(); }},
  {label:'Share Workout as URL', key:'', icon:'\u21C4', action: function() { shareWorkoutAsURL(); }},
  {label:'Cooldown Recommendations', key:'', icon:'\u2764', action: function() { suggestCooldown(); }},
  {label:'Download Summary Card (PNG)', key:'', icon:'\u2B50', action: function() { generateSummaryCard(); }},
  {label:'Add Bookmark at Playhead', key:'', icon:'\u2691', action: function() { addBookmark(); }},
  {label:'Show Bookmarks', key:'', icon:'\u2691', action: function() { showBookmarks(); }},
  {label:'Clear All Bookmarks', key:'', icon:'\u2716', action: function() { clearAllBookmarks(); }},
  {label:'Suggest Exercise Pairings', key:'', icon:'\u2295', action: function() { suggestPairings(); }},
  {label:'Start Macro Recording', key:'', icon:'\u25CF', action: function() { startMacroRecord(); }},
  {label:'Stop Macro Recording', key:'', icon:'\u25A0', action: function() { stopMacroRecord(); }},
  {label:'Saved Macros', key:'', icon:'\u25B6', action: function() { showMacroList(); }},
  {label:'Clear All Macros', key:'', icon:'\u2716', action: function() { clearMacros(); }},
  {label:'Preview Workout Animation', key:'', icon:'\u25B6', action: function() { previewWorkout(); }},
  {label:'Stop Preview', key:'', icon:'\u25A0', action: function() { stopPreview(); }},
  {label:'Sort Library: Alphabetical', key:'', icon:'\u2630', action: function() { sortLibrary('alpha'); }},
  {label:'Sort Library: By Family', key:'', icon:'\u2630', action: function() { sortLibrary('family'); }},
  {label:'Sort Library: By Difficulty', key:'', icon:'\u2630', action: function() { sortLibrary('difficulty'); }},
  {label:'Sort Library: By Frequency', key:'', icon:'\u2630', action: function() { sortLibrary('frequency'); }},
  {label:'Session Debrief', key:'', icon:'\u2B50', action: function() { showSessionDebrief(); }},
  {label:'Show Workout Changelog', key:'', icon:'\u270E', action: function() { showChangelog(); }},
  {label:'Clear Changelog', key:'', icon:'\u2716', action: function() { clearChangelog(); }},
  {label:'Training Week Planner', key:'', icon:'\u2630', action: function() { showWeekPlanner(); }},
  {label:'Load Today\'s Workout', key:'', icon:'\u25B6', action: function() { loadTodaysWorkout(); }},
  {label:'Complexity Radar Chart', key:'', icon:'\u25CE', action: function() { showComplexityRadar(); }},
  {label:'Challenge: Speed Build', key:'', icon:'\u26A1', action: function() { startChallenge('speed'); }},
  {label:'Challenge: Family Blitz', key:'', icon:'\u26A1', action: function() { startChallenge('variety'); }},
  {label:'Challenge: Volume King', key:'', icon:'\u26A1', action: function() { startChallenge('volume'); }},
  {label:'Challenge: Perfect Balance', key:'', icon:'\u26A1', action: function() { startChallenge('balance'); }},
  {label:'End Challenge', key:'', icon:'\u25A0', action: function() { endChallenge(); }},
  {label:'Edit Movement Cues', key:'', icon:'\u270E', action: function() { showCueEditor(); }},
  {label:'Show Movement Cues', key:'', icon:'\u270E', action: function() { showCueForClip(); }},
  {label:'Narrate Workout (TTS)', key:'', icon:'\u266A', action: function() { generateNarration(); }},
  {label:'Stop Narration', key:'', icon:'\u25A0', action: function() { stopNarration(); }},
  {label:'Theme Picker', key:'', icon:'\u2600', action: function() { showThemePicker(); }},
  {label:'Theme: Cosmic Blue', key:'', icon:'\u2600', action: function() { applyTheme('default'); }},
  {label:'Theme: Midnight', key:'', icon:'\u2600', action: function() { applyTheme('midnight'); }},
  {label:'Theme: Ember', key:'', icon:'\u2600', action: function() { applyTheme('ember'); }},
  {label:'Theme: Frost', key:'', icon:'\u2600', action: function() { applyTheme('frost'); }},
  {label:'Theme: Neon', key:'', icon:'\u2600', action: function() { applyTheme('neon'); }},
  {label:'Progression Tracker', key:'', icon:'\u2191', action: function() { showProgressionTracker(); }},
  {label:'Pin Command to Toolbar', key:'', icon:'\u2691', action: function() { showPinPicker(); }},
  {label:'Stats Dashboard', key:'', icon:'\u2630', action: function() { showStatsDashboard(); }},
  {label:'Log Workout Mastery', key:'', icon:'\u2191', action: function() { logCurrentWorkoutMastery(); }},
  {label:'Mastery Overview', key:'', icon:'\u2191', action: function() { showMasteryOverview(); }},
  {label:'Import Workout from Text', key:'', icon:'\u2709', action: function() { importFromText(); }},
  {label:'Share Workout to Social', key:'', icon:'\u21e7', action: function() { shareToSocial(); }},
  {label:'Lookup Exercise Video', key:'', icon:'\u25b6', action: function() { lookupExerciseVideo(); }},
  {label:'Lookup Exercise Image', key:'', icon:'\u25a3', action: function() { lookupExerciseImage(); }},
  {label:'Show Training Cycle', key:'', icon:'\u21bb', action: function() { showCycleTracker(); }},
  {label:'Advance Cycle Week', key:'', icon:'\u2192', action: function() { advanceCycleWeek(); }},
  {label:'Reset Training Cycle', key:'', icon:'\u21ba', action: function() { resetCycle(); }},
  {label:'Create Exercise Combo', key:'', icon:'\u2726', action: function() { createCombo(); }},
  {label:'Show Saved Combos', key:'', icon:'\u2726', action: function() { showComboList(); }},
  {label:'Workout Comparison Matrix', key:'', icon:'\u2261', action: function() { showComparisonMatrix(); }},
  {label:'Auto-Periodize Workout', key:'', icon:'\u21c4', action: function() { autoPeriodize(); }},
  {label:'Search Coaching Notes', key:'', icon:'\u2315', action: function() { searchExerciseNotes(); }},
  {label:'Create Workout Variant', key:'', icon:'\u2234', action: function() { createWorkoutVariant(); }},
  {label:'Focus Timer (Pomodoro)', key:'', icon:'\u23f2', action: function() { showFocusTimer(); }},
  {label:'Build Movement Flow', key:'', icon:'\u2194', action: function() { showFlowBuilder(); }},
  {label:'Show Saved Flows', key:'', icon:'\u2194', action: function() { showFlowList(); }},
  {label:'Export Analytics Report', key:'', icon:'\u2197', action: function() { exportAnalyticsHTML(); }},
  {label:'Quick Workout Wizard', key:'', icon:'\u2606', action: function() { showWorkoutWizard(); }},
  {label:'Exercise Encyclopedia', key:'', icon:'\u2637', action: function() { showEncyclopedia(); }},
  {label:'Training Calendar (6 months)', key:'', icon:'\u2610', action: function() { showExtendedCalendar(); }},
  {label:'Custom Countdown Builder', key:'', icon:'\u23f1', action: function() { showCountdownBuilder(); }},
  {label:'Run Saved Countdown', key:'', icon:'\u23f1', action: function() { showSavedSeqs(); }},
  {label:'Exercise Relationships', key:'', icon:'\u2194', action: function() { showRelationshipsMap(); }},
  {label:'Workout Score', key:'', icon:'\u2605', action: function() { showWorkoutScore(); }},
  {label:'Quick Notes Sidebar', key:'', icon:'\u270e', action: function() { toggleQuickNotes(); }},
  {label:'Workout Playlist Creator', key:'', icon:'\u266b', action: function() { showPlaylistCreator(); }},
  {label:'Next Playlist Workout', key:'', icon:'\u23ed', action: function() { nextPlaylistWorkout(); }},
  {label:'Check Exercise Frequency', key:'', icon:'\u26a0', action: function() { checkExerciseFrequency(); }},
  {label:'Training Split Recommender', key:'', icon:'\u2263', action: function() { showSplitRecommender(); }},
  {label:'Muscle Fatigue Tracker', key:'', icon:'\u2620', action: function() { showFatigueTracker(); }},
  {label:'Substitution Wizard', key:'', icon:'\u21c6', action: function() { showSubstitutionWizard(); }},
  {label:'Time Estimator', key:'', icon:'\u23f0', action: function() { showTimeEstimator(); }},
  {label:'Create Workout Blueprint', key:'', icon:'\u2692', action: function() { createBlueprint(); }},
  {label:'Show Blueprints', key:'', icon:'\u2692', action: function() { showBlueprintList(); }},
  {label:'Auto-Suggest RPE', key:'', icon:'\u2195', action: function() { autoSuggestRPE(); }},
  {label:'Analyze Movement Patterns', key:'', icon:'\u2690', action: function() { analyzeMovementPatterns(); }},
  {label:'Quick-Build Presets', key:'', icon:'\u2699', action: function() { showQuickBuildPanel(); }},
  {label:'Log Session', key:'', icon:'\u2611', action: function() { logSessionHistory(); }},
  {label:'Session History', key:'', icon:'\u2611', action: function() { showSessionHistory(); }},
  {label:'Export PDF-Ready Worksheet', key:'', icon:'\u2399', action: function() { exportPDFReady(); }},
  {label:'Workout Fingerprint', key:'', icon:'\u2318', action: function() { showWorkoutFingerprint(); }},
  {label:'Auto Superset Pair', key:'', icon:'\u21cb', action: function() { autoSupersetPair(); }},
  {label:'Volume Landmarks (MEV/MAV/MRV)', key:'', icon:'\u2261', action: function() { showVolumeLandmarks(); }},
  {label:'Color Legend', key:'', icon:'\u25a0', action: function() { showColorLegend(); }},
  {label:'Exercise Pool Manager', key:'', icon:'\u2630', action: function() { showPoolManager(); }},
  {label:'Session Comparison', key:'', icon:'\u2262', action: function() { showSessionComparison(); }},
  {label:'Workout Insights', key:'', icon:'\u2139', action: function() { showWorkoutInsights(); }},
  {label:'Toggle Favorite Exercise', key:'', icon:'\u2605', action: function() { toggleFavorite(); }},
  {label:'Show Favorites', key:'', icon:'\u2605', action: function() { showFavorites(); }},
  {label:'About Saturno Movement Studio', key:'', icon:'\u24d8', action: function() { showAbout(); }},
  {label:'Workout DNA', key:'', icon:'\u2622', action: function() { showWorkoutDNA(); }},
  {label:'Exercise History Graph', key:'', icon:'\ud83d\udcc8', action: function() { showExerciseHistoryGraph(); }},
  {label:'Remix Workout', key:'', icon:'\ud83d\udd00', action: function() { remixWorkout(); }},
  {label:'Progressive Overload Tracker', key:'', icon:'\ud83d\udcc8', action: function() { showOverloadTracker(); }},
  {label:'Snapshot Diff', key:'', icon:'\ud83d\udd0d', action: function() { showSnapshotDiff(); }},
  {label:'Exercise Rotation Scheduler', key:'', icon:'\ud83d\udd04', action: function() { showRotationScheduler(); }},
  {label:'Training Load (ACWR)', key:'', icon:'\u2696', action: function() { showTrainingLoad(); }},
  {label:'Streak Challenges', key:'', icon:'\ud83d\udd25', action: function() { showStreakChallenges(); }},
  {label:'Exercise Clusters', key:'', icon:'\ud83e\udde9', action: function() { showClusterBuilder(); }},
  {label:'Volume Wave Planner', key:'', icon:'\ud83c\udf0a', action: function() { showVolumeWavePlanner(); }},
];

function openCmdPalette() {
  var pal = document.getElementById('cmd-palette');
  pal.classList.add('open');
  var input = document.getElementById('cmd-input');
  input.value = '';
  input.focus();
  renderCommands('');
}

function closeCmdPalette() {
  document.getElementById('cmd-palette').classList.remove('open');
}

function filterCommands() {
  renderCommands(document.getElementById('cmd-input').value.toLowerCase());
}

function renderCommands(q) {
  var results = document.getElementById('cmd-results');
  var filtered = CMD_ACTIONS.filter(function(a) {
    return !q || a.label.toLowerCase().indexOf(q) !== -1;
  });
  var html = '';
  filtered.forEach(function(a, i) {
    html += '<div class="cmd-result' + (i === 0 ? ' active' : '') + '" data-idx="' + CMD_ACTIONS.indexOf(a) + '">';
    html += '<span class="cmd-result-icon">' + a.icon + '</span>';
    html += '<span class="cmd-result-text">' + a.label + '</span>';
    if (a.key) html += '<span class="cmd-result-key">' + a.key + '</span>';
    html += '</div>';
  });
  var countEl = document.getElementById('cmd-count');
  if (countEl) countEl.textContent = filtered.length + ' / ' + CMD_ACTIONS.length + ' commands';
  results.innerHTML = html || '<div style="padding:12px 16px;font-size:10px;color:var(--micro)">No commands found</div>';
  // Click handlers
  results.querySelectorAll('.cmd-result').forEach(function(el) {
    el.addEventListener('click', function() {
      var idx = parseInt(el.dataset.idx);
      closeCmdPalette();
      _lastCommand = CMD_ACTIONS[idx].action;
      CMD_ACTIONS[idx].action();
    });
  });
}

// Cmd+K to open, Escape to close
document.getElementById('cmd-palette').addEventListener('click', function(e) {
  if (e.target === document.getElementById('cmd-palette')) closeCmdPalette();
});
document.getElementById('cmd-input').addEventListener('keydown', function(e) {
  if (e.code === 'Escape') { closeCmdPalette(); e.stopPropagation(); return; }
  if (e.code === 'Enter') {
    var active = document.querySelector('.cmd-result.active');
    if (active) {
      closeCmdPalette();
      var idx = parseInt(active.dataset.idx);
      _lastCommand = CMD_ACTIONS[idx].action;
      CMD_ACTIONS[idx].action();
    }
    return;
  }
  if (e.code === 'ArrowDown' || e.code === 'ArrowUp') {
    e.preventDefault();
    var items = Array.from(document.querySelectorAll('.cmd-result'));
    var cur = items.findIndex(function(el) { return el.classList.contains('active'); });
    items.forEach(function(el) { el.classList.remove('active'); });
    if (e.code === 'ArrowDown') cur = (cur + 1) % items.length;
    else cur = (cur - 1 + items.length) % items.length;
    if (items[cur]) { items[cur].classList.add('active'); items[cur].scrollIntoView({block:'nearest'}); }
  }
});

/* ===== INLINE PROMPT — Craft-style replacement for native prompt() ===== */
var inlinePromptCallback = null;
function showInlinePrompt(label, defaultVal, callback) {
  inlinePromptCallback = callback;
  var overlay = document.getElementById('inline-prompt');
  var lbl = document.getElementById('inline-prompt-label');
  var inp = document.getElementById('inline-prompt-input');
  lbl.textContent = label;
  inp.value = defaultVal || '';
  overlay.classList.add('open');
  setTimeout(function() { inp.focus(); inp.select(); }, 50);
}
function closeInlinePrompt(value) {
  document.getElementById('inline-prompt').classList.remove('open');
  if (inlinePromptCallback) {
    var cb = inlinePromptCallback;
    inlinePromptCallback = null;
    cb(value);
  }
}
function confirmInlinePrompt() {
  var val = document.getElementById('inline-prompt-input').value.trim();
  closeInlinePrompt(val || null);
}
// Enter confirms, Escape cancels
document.addEventListener('keydown', function(e) {
  var overlay = document.getElementById('inline-prompt');
  if (!overlay || !overlay.classList.contains('open')) return;
  if (e.key === 'Enter') { e.preventDefault(); confirmInlinePrompt(); }
  if (e.key === 'Escape') { e.preventDefault(); closeInlinePrompt(null); }
});

/* ===== WORKOUT NAME ===== */
var workoutName = 'Untitled';
var workoutNotes = '';
var _sessionCreatedAt = new Date().toISOString();
function setWorkoutName(name) {
  workoutName = name;
  document.getElementById('workout-name').textContent = name;
  var headerName = document.getElementById('header-workout-name');
  if (headerName) headerName.textContent = name;
  document.title = (name || 'Untitled') + ' - Saturno Movement Studio';
}
function renameWorkout() {
  showInlinePrompt('Workout name', workoutName, function(name) {
    if (name) {
      setWorkoutName(name);
      saveSession();
      toast('Renamed: ' + workoutName);
    }
  });
}

/* ===== CLIP SPLIT ===== */
function splitClipAtPlayhead() {
  if (!selectedClip) { toast('Select a clip to split'); return; }
  var pps = 80 / 15;
  var clipLeft = parseInt(selectedClip.style.left);
  var clipW = parseInt(selectedClip.style.width);
  var splitPos = 100 + currentTime * pps;
  // Check if playhead is within the clip
  if (splitPos <= clipLeft || splitPos >= clipLeft + clipW) {
    toast('Move playhead inside clip to split');
    return;
  }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var leftW = splitPos - clipLeft;
  var rightW = clipW - leftW;
  // Resize current clip to left portion
  selectedClip.style.width = leftW + 'px';
  var canvas = selectedClip.querySelector('.clip-waveform');
  var splitFm = FAMILY_MAP[ex.family] || {color:'#fff'};
  if (canvas) drawClipWaveform(canvas, splitFm.color, leftW + 'px', 0.5, parseInt(selectedClip.dataset.rpe) || 7);
  addBeatMarkers(selectedClip, leftW);
  // Create right portion
  var dna = {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: '0',
    fadeOut: selectedClip.dataset.fadeOut || '0'
  };
  // Left clip keeps fadeIn, loses fadeOut
  selectedClip.dataset.fadeOut = '0';
  var foEl = selectedClip.querySelector('.clip-fade-out');
  if (foEl) { foEl.style.width = '0px'; foEl.classList.remove('has-fade'); }
  updateFadeOverlay(selectedClip);
  var rightClip = createClipElement(ex, splitPos, rightW, dna);
  if (selectedClip.dataset.notes) rightClip.dataset.notes = selectedClip.dataset.notes;
  if (selectedClip.dataset.customColor) {
    rightClip.dataset.customColor = selectedClip.dataset.customColor;
    rightClip.style.background = selectedClip.style.background;
    rightClip.style.borderTopColor = selectedClip.style.borderTopColor;
  }
  selectedClip.parentElement.appendChild(rightClip);
  updateStats(); saveSession();
  sfx('click');
  toast('Clip split at ' + formatTime(currentTime));
}

/* ===== DUPLICATE TRACK CLIPS ===== */
function duplicateTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = activeTrack.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in track'); return; }
  pushUndo();
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var offset = maxRight + 8;
  var count = 0;
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var newLeft = parseInt(c.style.left) + offset;
    var dna = {
      sets: c.dataset.sets, reps: c.dataset.reps,
      tempo: c.dataset.tempo, rest: c.dataset.rest, rpe: c.dataset.rpe,
      fadeIn: c.dataset.fadeIn || '0', fadeOut: c.dataset.fadeOut || '0'
    };
    var dup = createClipElement(ex, newLeft, parseInt(c.style.width), dna);
    if (c.dataset.notes) dup.dataset.notes = c.dataset.notes;
    if (c.dataset.customColor) {
      dup.dataset.customColor = c.dataset.customColor;
      dup.style.background = c.style.background;
      dup.style.borderTopColor = c.style.borderTopColor;
    }
    activeTrack.appendChild(dup);
    count++;
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(count + ' clips duplicated');
}

function reverseTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip')).filter(function(c) {
    return !c.classList.contains('clip-locked');
  });
  if (clips.length < 2) { toast('Need 2+ unlocked clips to reverse'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var positions = clips.map(function(c) { return parseInt(c.style.left); });
  var widths = clips.map(function(c) { return parseInt(c.style.width); });
  var reversed = clips.slice().reverse();
  var curLeft = positions[0];
  for (var ri = 0; ri < reversed.length; ri++) {
    reversed[ri].style.left = curLeft + 'px';
    if (ri < reversed.length - 1) {
      var origGap = positions[ri + 1] - (positions[ri] + widths[ri]);
      curLeft += parseInt(reversed[ri].style.width) + Math.max(0, origGap);
    }
  }
  updateStats(); saveSession();
  toast('Track clips reversed');
}

/* ===== CUSTOM CLIP TOOLTIP ===== */
var tipTimer = null;
document.addEventListener('mouseover', function(e) {
  var clipEl = e.target.closest('.clip');
  if (!clipEl) return;
  clearTimeout(tipTimer);
  tipTimer = setTimeout(function() {
    var ex = getExercise(clipEl.dataset.exerciseId);
    if (!ex) return;
    var tip = document.getElementById('clip-tip');
    document.getElementById('tip-name').textContent = ex.name;
    document.getElementById('tip-pattern').textContent = ex.pattern;
    document.getElementById('tip-stage').textContent = 'Stage ' + ex.stage;
    document.getElementById('tip-discipline').textContent = ex.discipline;
    var sets = parseInt(clipEl.dataset.sets) || 3;
    var reps = parseInt(clipEl.dataset.reps) || 8;
    var tempo = parseFloat(clipEl.dataset.tempo) || 3;
    var rest = parseInt(clipEl.dataset.rest) || 60;
    document.getElementById('tip-dna').textContent = sets + 'x' + reps + ' @ RPE ' + clipEl.dataset.rpe;
    var fm = FAMILY_MAP[ex.family] || {};
    document.getElementById('tip-instrument').textContent = fm.instrument || '';
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var tut = sets * reps * tempo;
    var m = Math.floor(totalSec / 60);
    var s = Math.floor(totalSec % 60);
    document.getElementById('tip-time').textContent = m + ':' + s.toString().padStart(2, '0') + ' total';
    document.getElementById('tip-tut').textContent = 'TUT ' + tut + 's';
    var rect = clipEl.getBoundingClientRect();
    tip.style.left = (rect.left + rect.width / 2) + 'px';
    tip.style.top = (rect.top - 40) + 'px';
    tip.style.transform = 'translateX(-50%)';
    tip.classList.add('show');
  }, 400);
});
document.addEventListener('mouseout', function(e) {
  if (e.target.closest('.clip')) {
    clearTimeout(tipTimer);
    document.getElementById('clip-tip').classList.remove('show');
  }
});

/* ===== TRACK HEADER CONTEXT MENU ===== */
var trackCtxTarget = null;
function showTrackCtx(e, trackEl) {
  e.preventDefault();
  trackCtxTarget = trackEl;
  var ctx = document.getElementById('track-ctx');
  ctx.style.left = e.clientX + 'px';
  ctx.style.top = e.clientY + 'px';
  ctx.classList.add('open');
}
function hideTrackCtx() {
  document.getElementById('track-ctx').classList.remove('open');
  trackCtxTarget = null;
}
document.addEventListener('click', function() { hideTrackCtx(); });
document.getElementById('track-ctx').addEventListener('click', function(e) {
  var item = e.target.closest('.track-ctx-item');
  if (!item || !trackCtxTarget) return;
  var action = item.dataset.action;
  var content = trackCtxTarget.querySelector('.track-content');
  if (action === 'solo') {
    var btn = trackCtxTarget.querySelector('.track-btn:nth-child(2)');
    if (btn) toggleSolo(btn);
  } else if (action === 'mute') {
    var btn = trackCtxTarget.querySelector('.track-btn:nth-child(1)');
    if (btn) toggleMute(btn);
  } else if (action === 'select-all') {
    if (content) content.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
    toast('Track clips selected');
  } else if (action === 'collapse') {
    trackCtxTarget.classList.toggle('track-collapsed');
  } else if (action === 'collapse-all') {
    var allCollapsed = true;
    document.querySelectorAll('.track').forEach(function(t) { if (!t.classList.contains('track-collapsed') && t.dataset.track !== 'music') allCollapsed = false; });
    document.querySelectorAll('.track').forEach(function(t) { if (t.dataset.track !== 'music') t.classList.toggle('track-collapsed', !allCollapsed); });
    toast(allCollapsed ? 'Tracks expanded' : 'Tracks collapsed');
  } else if (action === 'clear') {
    if (content) {
      var clips = content.querySelectorAll('.clip');
      if (clips.length === 0) { toast('Track is empty'); hideTrackCtx(); return; }
      pushUndo();
      clips.forEach(function(c) { c.remove(); });
      updateStats(); saveSession();
      sfx('delete');
      toast(clips.length + ' clips cleared');
    }
  }
  hideTrackCtx();
});

/* RPE visual updater — updates velocity strip when RPE changes via context menu */
function updateClipVisuals(clip, rpe) {
  var velocity = clip.querySelector('.clip-velocity');
  if (velocity) {
    var velColor = rpe >= 9 ? '#ef4444' : rpe >= 7 ? '#f97316' : rpe >= 5 ? '#eab308' : '#22c55e';
    var velAlpha = 0.3 + (rpe / 10) * 0.5;
    velocity.style.background = 'linear-gradient(90deg, ' + velColor + Math.round(velAlpha * 255).toString(16).padStart(2,'0') + ', transparent)';
  }
}

/* ===== RIGHT PANEL TABS ===== */
function switchPanelTab(tabId) {
  document.querySelectorAll('.panel-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.panel-tab-content').forEach(function(c) { c.classList.remove('active'); });
  document.querySelector('.panel-tab[data-tab="'+tabId+'"]').classList.add('active');
  document.getElementById('tab-'+tabId).classList.add('active');
}

/* ===== EMPTY TIMELINE STATE ===== */
function updateEmptyState() {
  var clips = document.querySelectorAll('.clip');
  var el = document.getElementById('timeline-empty');
  if (!el) return;
  if (clips.length > 0) {
    el.classList.add('hidden');
  } else {
    el.classList.remove('hidden');
  }
}

/* ===== SETTINGS FUNCTIONS ===== */
var gridRes = 4;
var autoScrollEnabled = true;
var sfxEnabled = true;
var metroVolume = 0.5;

function setGridRes(val) {
  gridRes = parseInt(val);
  var snapBadge = document.getElementById('snap-badge');
  if (snapBadge && snapEnabled) snapBadge.textContent = 'SNAP ' + gridRes + 'B';
  toast('Grid: ' + gridRes + ' beat' + (gridRes > 1 ? 's' : '') + (snapEnabled ? ' (snap active)' : ''));
}

function toggleAutoScrollFromSettings() {
  autoScrollEnabled = !autoScrollEnabled;
  syncAutoScrollUI();
  toast('Auto-scroll ' + (autoScrollEnabled ? 'on' : 'off'));
}

function toggleSFXSetting() {
  sfxEnabled = !sfxEnabled;
  document.getElementById('settings-sfx').textContent = sfxEnabled ? 'ON' : 'OFF';
  toast('UI sounds ' + (sfxEnabled ? 'on' : 'off'));
}

/* ===== QUANTIZE — Snap All Clips to Grid ===== */
function quantizeClips() {
  var selected = document.querySelectorAll('.clip.selected');
  var clips = selected.length > 0 ? selected : document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to quantize'); return; }
  pushUndo();
  var snapPx = (typeof getSnapSize === 'function') ? getSnapSize() : (80 / 4);
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left) || 0;
    c.style.left = Math.round(left / snapPx) * snapPx + 'px';
    count++;
  });
  saveSession();
  sfx('snap');
  toast(count + ' clip' + (count !== 1 ? 's' : '') + ' quantized');
}

/* ===== CLIPBOARD — Copy/Paste Clips ===== */
var clipboardData = [];

function updateClipboardIndicator() {
  var el = document.getElementById('footer-clipboard');
  if (!el) return;
  el.textContent = clipboardData.length > 0 ? 'CLIP: ' + clipboardData.length : '';
}

function copyClips() {
  var selected = document.querySelectorAll('.clip.selected');
  if (selected.length === 0) { toast('No clips selected'); return; }
  clipboardData = [];
  selected.forEach(function(c) {
    clipboardData.push({
      exerciseId: c.dataset.exerciseId,
      left: parseInt(c.style.left),
      width: parseInt(c.style.width),
      track: c.parentElement.dataset.track,
      sets: c.dataset.sets,
      reps: c.dataset.reps,
      tempo: c.dataset.tempo,
      rest: c.dataset.rest,
      rpe: c.dataset.rpe,
      notes: c.dataset.notes || '',
      customColor: c.dataset.customColor || '',
      fadeIn: c.dataset.fadeIn || '0',
      fadeOut: c.dataset.fadeOut || '0'
    });
  });
  sfx('click');
  updateClipboardIndicator();
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' copied');
}

function pasteClips() {
  if (clipboardData.length === 0) { toast('Nothing to paste'); return; }
  pushUndo();
  var offset = 40; // paste slightly offset from original
  clipboardData.forEach(function(cd) {
    var track = document.querySelector('.track-content[data-track="'+cd.track+'"]');
    var ex = getExercise(cd.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, cd.left + offset, cd.width, {
      sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe,
      fadeIn: cd.fadeIn || '0', fadeOut: cd.fadeOut || '0'
    });
    if (cd.notes) clip.dataset.notes = cd.notes;
    if (cd.customColor) {
      clip.dataset.customColor = cd.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + cd.customColor + '44 0%, ' + cd.customColor + '22 100%)';
      clip.style.borderTopColor = cd.customColor;
    }
    track.appendChild(clip);
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' pasted');
}

function pasteAtPlayhead() {
  if (clipboardData.length === 0) { toast('Nothing to paste'); return; }
  pushUndo();
  var pps = 80 / 15;
  var targetLeft = 100 + currentTime * pps;
  var minLeft = Infinity;
  clipboardData.forEach(function(cd) { if (cd.left < minLeft) minLeft = cd.left; });
  var offsetAmt = targetLeft - minLeft;
  clipboardData.forEach(function(cd) {
    var track = document.querySelector('.track-content[data-track="'+cd.track+'"]');
    var ex = getExercise(cd.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, cd.left + offsetAmt, cd.width, {
      sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe,
      fadeIn: cd.fadeIn || '0', fadeOut: cd.fadeOut || '0'
    });
    if (cd.notes) clip.dataset.notes = cd.notes;
    if (cd.customColor) {
      clip.dataset.customColor = cd.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + cd.customColor + '44 0%, ' + cd.customColor + '22 100%)';
      clip.style.borderTopColor = cd.customColor;
    }
    track.appendChild(clip);
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' pasted at playhead');
}

/* ===== AUTO-ARRANGE — Lay Out Clips Sequentially ===== */
function autoArrange() {
  var tracks = document.querySelectorAll('.track-content');
  var totalMoved = 0;
  pushUndo();
  tracks.forEach(function(track) {
    if (track.dataset.track === 'music') return;
    var clips = Array.from(track.querySelectorAll('.clip'));
    if (clips.length === 0) return;
    clips.sort(function(a, b) { return (parseInt(a.style.left) || 0) - (parseInt(b.style.left) || 0); });
    var pos = 0;
    var gap = 2;
    clips.forEach(function(c) {
      if (c.classList.contains('clip-locked')) {
        pos = (parseInt(c.style.left) || 0) + (parseInt(c.style.width) || 80) + gap;
        return;
      }
      var old = parseInt(c.style.left) || 0;
      c.style.left = pos + 'px';
      if (old !== pos) totalMoved++;
      pos += (parseInt(c.style.width) || 80) + gap;
    });
  });
  saveSession(); updateStats();
  sfx('snap');
  toast(totalMoved + ' clips arranged');
}

function spreadClipsEvenly() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips to spread'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var totalClipWidth = 0;
  clips.forEach(function(c) { totalClipWidth += parseInt(c.style.width) || 80; });
  var maxRight = parseInt(clips[clips.length - 1].style.left) + (parseInt(clips[clips.length - 1].style.width) || 80);
  var availableSpace = maxRight - totalClipWidth;
  var gap = clips.length > 1 ? availableSpace / (clips.length - 1) : 0;
  var curLeft = parseInt(clips[0].style.left) || 0;
  clips.forEach(function(c, i) {
    if (!c.classList.contains('clip-locked')) {
      c.style.left = Math.round(curLeft) + 'px';
    }
    curLeft += (parseInt(c.style.width) || 80) + gap;
  });
  updateStats(); saveSession();
  toast('Clips spread evenly');
}

function humanizeClips() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to humanize'); return; }
  pushUndo();
  var pps = 80 / 15;
  var maxJitter = pps * 0.3; // +/- 0.3 seconds
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var cur = parseInt(c.style.left) || 0;
    var offset = (Math.random() - 0.5) * 2 * maxJitter;
    c.style.left = Math.max(0, Math.round(cur + offset)) + 'px';
    count++;
  });
  saveSession(); updateStats();
  toast(count + ' clips humanized');
}

function clearAllClips() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to clear'); return; }
  pushUndo();
  clips.forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession(); updateEmptyState();
  sfx('delete');
  toast(clips.length + ' clips cleared');
}

function clearTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = activeTrack.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in track'); return; }
  pushUndo();
  var count = clips.length;
  clips.forEach(function(c) {
    if (c === selectedClip) {
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
    }
    c.remove();
  });
  updateStats(); saveSession();
  sfx('delete');
  toast(count + ' track clips cleared');
}

function setAllRest(seconds) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    c.dataset.rest = seconds;
    count++;
  });
  if (selectedClip) {
    document.getElementById('insp-rest').value = seconds;
    updateInspectorTime();
  }
  saveSession(); updateStats();
  toast(count + ' clips rest set to ' + seconds + 's');
}

function showComplexityScore() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var patterns = {};
  var families = {};
  var stages = {};
  var disciplines = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      patterns[ex.pattern] = true;
      families[ex.family] = true;
      stages[ex.stage] = true;
      if (ex.discipline) disciplines[ex.discipline] = true;
    }
  });
  var pCount = Object.keys(patterns).length;
  var fCount = Object.keys(families).length;
  var sCount = Object.keys(stages).length;
  var dCount = Object.keys(disciplines).length;
  var score = Math.min(100, Math.round((pCount * 8 + fCount * 15 + sCount * 10 + dCount * 12)));
  toast('Complexity: ' + score + '/100 | ' + pCount + ' patterns, ' + fCount + ' families, ' + sCount + ' stages, ' + dCount + ' disciplines');
}

function setAllTempo(seconds) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    c.dataset.tempo = seconds;
    count++;
  });
  if (selectedClip) {
    document.getElementById('insp-tempo').value = seconds;
    updateInspectorTime();
  }
  saveSession(); updateStats();
  toast(count + ' clips tempo set to ' + seconds + 's');
}

function duplicateToNextBar() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * (80 / 15));
  var newLeft = parseInt(selectedClip.style.left) + barPx;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets, reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: selectedClip.dataset.fadeIn || '0', fadeOut: selectedClip.dataset.fadeOut || '0'
  });
  if (selectedClip.dataset.notes) clip.dataset.notes = selectedClip.dataset.notes;
  if (selectedClip.dataset.customColor) {
    clip.dataset.customColor = selectedClip.dataset.customColor;
    clip.style.background = 'linear-gradient(180deg, ' + selectedClip.dataset.customColor + '44 0%, ' + selectedClip.dataset.customColor + '22 100%)';
    clip.style.borderTopColor = selectedClip.dataset.customColor;
  }
  selectedClip.parentElement.appendChild(clip);
  updateStats(); saveSession(); sfx('drop');
  toast('Duplicated to next bar');
}

function fillTrackWithExercise() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  var track = selectedClip.parentElement;
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  pushUndo();
  var clipW = parseInt(selectedClip.style.width) || 80;
  var gap = 4;
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * (80 / 15));
  var startLeft = parseInt(selectedClip.style.left) + clipW + gap;
  var maxPx = 100 + Math.round(300 * (60 / bpm) * (80 / 15));
  var existing = Array.from(track.querySelectorAll('.clip'));
  var maxExisting = 0;
  existing.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxExisting) maxExisting = r;
  });
  if (maxExisting > maxPx) maxPx = maxExisting + barPx * 2;
  var filled = 0;
  var pos = startLeft;
  while (pos + clipW <= maxPx && filled < 32) {
    var overlaps = false;
    existing.forEach(function(c) {
      var cL = parseInt(c.style.left);
      var cR = cL + parseInt(c.style.width);
      if (pos + clipW > cL && pos < cR) overlaps = true;
    });
    if (!overlaps) {
      var clip = createClipElement(ex, pos, clipW, {
        sets: selectedClip.dataset.sets, reps: selectedClip.dataset.reps,
        tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
        rpe: selectedClip.dataset.rpe
      });
      track.appendChild(clip);
      existing.push(clip);
      filled++;
    }
    pos += clipW + gap;
  }
  updateStats(); saveSession(); sfx('drop');
  toast(filled + ' clips added to track');
}

function searchLibraryForInspected() {
  if (!selectedClip) return;
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var searchInput = document.getElementById('lib-search');
  if (searchInput) {
    searchInput.value = ex.name;
    filterLibrary();
    searchInput.focus();
    toast('Searching: ' + ex.name);
  }
}

function setAllStage(targetStage) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var swapped = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var curEx = getExercise(c.dataset.exerciseId);
    if (!curEx || curEx.stage === targetStage) return;
    var sibling = EXERCISES.filter(function(ex) { return ex.pattern === curEx.pattern && ex.stage === targetStage; })[0];
    if (sibling) {
      c.dataset.exerciseId = sibling.id;
      var nameEl = c.querySelector('.clip-name');
      if (nameEl) nameEl.textContent = sibling.name;
      var dotsEl = c.querySelector('.clip-stage-dots');
      if (dotsEl) {
        var dots = dotsEl.querySelectorAll('.clip-stage-dot');
        dots.forEach(function(d, i) {
          d.className = 'clip-stage-dot' + (i < targetStage ? ' filled' : '');
        });
      }
      swapped++;
    }
  });
  saveSession(); updateStats();
  toast(swapped + ' clips set to Stage ' + targetStage);
}

function mirrorWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to mirror'); return; }
  pushUndo();
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var ho = 100;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var origLeft = parseInt(c.style.left);
    var w = parseInt(c.style.width);
    var newLeft = ho + (maxRight - ho) - (origLeft - ho) - w;
    c.style.left = Math.max(ho, newLeft) + 'px';
  });
  updateStats(); saveSession();
  sfx('click');
  toast('Workout mirrored');
}

function swapTwoClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length !== 2) { toast('Select exactly 2 clips to swap'); return; }
  if (sel[0].classList.contains('clip-locked') || sel[1].classList.contains('clip-locked')) {
    toast('Cannot swap locked clips'); return;
  }
  pushUndo();
  var leftA = sel[0].style.left;
  var leftB = sel[1].style.left;
  sel[0].style.left = leftB;
  sel[1].style.left = leftA;
  updateStats(); saveSession(); sfx('click');
  toast('Clips swapped');
}

function alignClipsToPlayhead() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('Select clips first'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var targetPx = ho + Math.round(currentTime * pps);
  var count = 0;
  var sorted = Array.from(sel).sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var offset = targetPx;
  sorted.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var w = parseInt(c.style.width) || 80;
    c.style.left = offset + 'px';
    offset += w + 4;
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips aligned to playhead');
}

function trimClipToLoop() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (!loopEnabled) { toast('Enable loop region first'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var loopLeftPx = ho + Math.round(loopStart * pps);
  var loopRightPx = ho + Math.round(loopEnd * pps);
  var clipLeft = parseInt(selectedClip.style.left);
  var clipWidth = parseInt(selectedClip.style.width);
  var clipRight = clipLeft + clipWidth;
  var newLeft = Math.max(clipLeft, loopLeftPx);
  var newRight = Math.min(clipRight, loopRightPx);
  if (newRight <= newLeft) { toast('Clip outside loop region'); return; }
  selectedClip.style.left = newLeft + 'px';
  selectedClip.style.width = (newRight - newLeft) + 'px';
  updateStats(); saveSession(); sfx('click');
  toast('Clip trimmed to loop region');
}

function applyInspectorToSelected() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length < 2) { toast('Select 2+ clips to batch-set params'); return; }
  var sets = document.getElementById('insp-sets').value;
  var reps = document.getElementById('insp-reps').value;
  var tempo = document.getElementById('insp-tempo').value;
  var rest = document.getElementById('insp-rest').value;
  var rpe = document.getElementById('insp-rpe').value;
  pushUndo();
  var count = 0;
  sel.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    c.dataset.sets = sets;
    c.dataset.reps = reps;
    c.dataset.tempo = tempo;
    c.dataset.rest = rest;
    c.dataset.rpe = rpe;
    var rpeBadge = c.querySelector('.clip-rpe-badge');
    if (rpeBadge) rpeBadge.textContent = rpe;
    updateClipDNA(c);
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips updated with inspector values');
}

function staggerClips() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) { toast('Select 2+ clips to stagger'); return; }
  pushUndo();
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var staggerAmount = beatPx * 2;
  sel.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var baseLeft = parseInt(sel[0].style.left);
  var count = 0;
  sel.forEach(function(c, i) {
    if (c.classList.contains('clip-locked')) return;
    c.style.left = (baseLeft + i * staggerAmount) + 'px';
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips staggered by 2 beats');
}

function collectToTrack() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('Select clips first'); return; }
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  pushUndo();
  var count = 0;
  sel.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    if (c.parentElement !== activeTrack) {
      c.parentElement.removeChild(c);
      activeTrack.appendChild(c);
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips moved to active track');
}

function randomSwapExercise() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var sameFamily = EXERCISES.filter(function(e) { return e.family === ex.family && e.id !== ex.id; });
  if (sameFamily.length === 0) { toast('No other exercises in ' + ex.family); return; }
  pushUndo();
  var rand = sameFamily[Math.floor(Math.random() * sameFamily.length)];
  selectedClip.dataset.exerciseId = rand.id;
  var nameEl = selectedClip.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = rand.name;
  var dotsEl = selectedClip.querySelector('.clip-stage-dots');
  if (dotsEl) {
    var dots = dotsEl.querySelectorAll('.clip-stage-dot');
    dots.forEach(function(d, i) { d.className = 'clip-stage-dot' + (i < rand.stage ? ' filled' : ''); });
  }
  selectClipEl(selectedClip);
  saveSession(); sfx('click');
  toast('Swapped to: ' + rand.name + ' (S' + rand.stage + ')');
}

function randomizeAllExercises() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var swapped = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var sameFamily = EXERCISES.filter(function(e) { return e.family === ex.family && e.id !== ex.id; });
    if (sameFamily.length === 0) return;
    var rand = sameFamily[Math.floor(Math.random() * sameFamily.length)];
    c.dataset.exerciseId = rand.id;
    var nameEl = c.querySelector('.clip-name');
    if (nameEl) nameEl.textContent = rand.name;
    var dotsEl = c.querySelector('.clip-stage-dots');
    if (dotsEl) {
      var dots = dotsEl.querySelectorAll('.clip-stage-dot');
      dots.forEach(function(d, i) { d.className = 'clip-stage-dot' + (i < rand.stage ? ' filled' : ''); });
    }
    swapped++;
  });
  saveSession(); updateStats(); sfx('click');
  toast(swapped + ' exercises randomized within families');
}

function quickAddExercise(exerciseId) {
  var ex = getExercise(exerciseId);
  if (!ex) return;
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) {
    var fam = ex.family.toLowerCase();
    activeTrack = document.querySelector('.track-content[data-track="' + fam + '"]');
  }
  if (!activeTrack) activeTrack = document.querySelector('.track-content[data-track="push"]');
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var left = ho + Math.round(currentTime * pps);
  var clip = createClipElement(ex, left, 80);
  activeTrack.appendChild(clip);
  addToRecent(ex.id);
  updateStats(); saveSession(); sfx('drop');
  toast('Added: ' + ex.name);
}

function consolidateClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips to consolidate'); return; }
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  pushUndo();
  var merged = 0;
  var i = 0;
  while (i < clips.length - 1) {
    if (clips[i].classList.contains('clip-locked') || clips[i + 1].classList.contains('clip-locked')) { i++; continue; }
    var aR = parseInt(clips[i].style.left) + parseInt(clips[i].style.width);
    var bL = parseInt(clips[i + 1].style.left);
    if (Math.abs(aR - bL) <= 8) {
      var newWidth = parseInt(clips[i].style.width) + parseInt(clips[i + 1].style.width) + (bL - aR);
      clips[i].style.width = newWidth + 'px';
      var totalSets = (parseInt(clips[i].dataset.sets) || 3) + (parseInt(clips[i + 1].dataset.sets) || 3);
      clips[i].dataset.sets = totalSets;
      updateClipInfo(clips[i]);
      clips[i + 1].remove();
      clips.splice(i + 1, 1);
      merged++;
    } else {
      i++;
    }
  }
  updateStats(); saveSession(); sfx('click');
  toast(merged + ' clip' + (merged !== 1 ? 's' : '') + ' consolidated');
}

function showExerciseFrequency() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var freq = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) freq[ex.name] = (freq[ex.name] || 0) + 1;
  });
  var sorted = Object.keys(freq).sort(function(a, b) { return freq[b] - freq[a]; });
  var top5 = sorted.slice(0, 5).map(function(name) { return name + ' (' + freq[name] + ')'; });
  toast('Top exercises: ' + top5.join(', ') + (sorted.length > 5 ? ' +' + (sorted.length - 5) + ' more' : ''));
}

function showBalanceReport() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var famSets = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      var sets = parseInt(c.dataset.sets) || 3;
      famSets[ex.family] = (famSets[ex.family] || 0) + sets;
    }
  });
  var total = 0;
  Object.keys(famSets).forEach(function(f) { total += famSets[f]; });
  var report = Object.keys(famSets).sort(function(a, b) { return famSets[b] - famSets[a]; }).map(function(f) {
    var pct = Math.round(famSets[f] / total * 100);
    return f + ': ' + pct + '%';
  });
  var pushPull = (famSets['Push'] || 0) + '/' + (famSets['Pull'] || 0);
  toast('Balance: ' + report.join(' | ') + ' (Push/Pull: ' + pushPull + ')');
}

function scaleClipDurations(factor) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var count = 0;
  var ho = 100;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    var w = parseInt(c.style.width);
    var relLeft = left - ho;
    c.style.left = Math.round(ho + relLeft * factor) + 'px';
    c.style.width = Math.max(20, Math.round(w * factor)) + 'px';
    updateClipInfo(c);
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips scaled ' + factor + 'x');
}

function quantizeSelected() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('Select clips to quantize'); return; }
  pushUndo();
  var snapSz = (typeof getSnapSize === 'function') ? getSnapSize() : 20;
  if (snapSz < 4) snapSz = 4;
  var count = 0;
  sel.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    var ho = 100;
    var rel = left - ho;
    var snapped = Math.round(rel / snapSz) * snapSz;
    c.style.left = (ho + snapped) + 'px';
    count++;
  });
  updateStats(); saveSession(); sfx('snap');
  toast(count + ' clips quantized to grid');
}

function exportMarkdown() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var name = document.getElementById('workout-name').textContent || 'Untitled';
  var md = '# ' + name + '\n\n';
  md += '**BPM:** ' + bpm + ' | **Mode:** ' + (document.getElementById('bpm-mode').textContent || '') + '\n\n';
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var trackLabels = {push:'Push', pull:'Pull', core:'Core', legs:'Legs', skills:'Skills'};
  trackOrder.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    if (trackClips.length === 0) return;
    trackClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    md += '## ' + trackLabels[tid] + '\n\n';
    md += '| # | Exercise | Sets | Reps | Tempo | Rest | RPE |\n';
    md += '|---|----------|------|------|-------|------|-----|\n';
    trackClips.forEach(function(c, i) {
      var ex = getExercise(c.dataset.exerciseId);
      md += '| ' + (i + 1) + ' | ' + (ex ? ex.name : '?') + ' | ' + (c.dataset.sets || 3) + ' | ' + (c.dataset.reps || 8) + ' | ' + (c.dataset.tempo || 3) + 's | ' + (c.dataset.rest || 60) + 's | ' + (c.dataset.rpe || 7) + ' |\n';
    });
    md += '\n';
  });
  if (workoutNotes) md += '## Notes\n\n' + workoutNotes + '\n';
  md += '\n---\n*Generated by Saturno Movement Studio*\n';
  navigator.clipboard.writeText(md).then(function() { toast('Markdown copied to clipboard'); });
}

function compareWithSaved() {
  var saved = null;
  try { saved = JSON.parse(localStorage.getItem('sms-session')); } catch(e) {}
  if (!saved || !saved.tracks) { toast('No saved session to compare'); return; }
  var savedClipCount = 0;
  var savedFamilies = {};
  saved.tracks.forEach(function(t) {
    if (t.clips) {
      savedClipCount += t.clips.length;
      t.clips.forEach(function(c) {
        if (c.family) savedFamilies[c.family] = (savedFamilies[c.family] || 0) + 1;
      });
    }
  });
  var curClips = document.querySelectorAll('.clip').length;
  var curFamilies = {};
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) curFamilies[ex.family] = (curFamilies[ex.family] || 0) + 1;
  });
  var diff = curClips - savedClipCount;
  var diffStr = diff > 0 ? '+' + diff : diff === 0 ? '0' : '' + diff;
  toast('Saved: ' + savedClipCount + ' clips | Current: ' + curClips + ' clips (' + diffStr + ')');
}

function selectClipsInLoopRange() {
  if (!loopEnabled) { toast('Enable loop region first'); return; }
  var pps = 80 / 15;
  var ho = 100;
  var loopLeftPx = ho + Math.round(loopStart * pps);
  var loopRightPx = ho + Math.round(loopEnd * pps);
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var cL = parseInt(c.style.left);
    var cR = cL + parseInt(c.style.width);
    if (cR > loopLeftPx && cL < loopRightPx) {
      c.classList.add('selected');
      count++;
    }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clips in loop range selected');
}

function sortTrackByName() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips to sort'); return; }
  pushUndo();
  clips.sort(function(a, b) {
    var exA = getExercise(a.dataset.exerciseId);
    var exB = getExercise(b.dataset.exerciseId);
    var nameA = exA ? exA.name : '';
    var nameB = exB ? exB.name : '';
    return nameA.localeCompare(nameB);
  });
  var ho = 100;
  var gap = 4;
  var pos = ho;
  clips.forEach(function(c) {
    if (!c.classList.contains('clip-locked')) {
      c.style.left = pos + 'px';
    }
    pos = parseInt(c.style.left) + parseInt(c.style.width) + gap;
  });
  updateStats(); saveSession(); sfx('click');
  toast('Track sorted alphabetically');
}

function compactTrack() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips on track'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var ho = 100;
  var gap = 4;
  var pos = ho;
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) {
      pos = parseInt(c.style.left) + parseInt(c.style.width) + gap;
      return;
    }
    if (parseInt(c.style.left) !== pos) count++;
    c.style.left = pos + 'px';
    pos += parseInt(c.style.width) + gap;
  });
  updateStats(); saveSession(); sfx('click');
  toast('Track compacted (' + count + ' clips moved)');
}

function distributeAcrossTracks() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) { toast('Select 2+ clips to distribute'); return; }
  var trackIds = ['push', 'pull', 'core', 'legs', 'skills'];
  pushUndo();
  var count = 0;
  sel.forEach(function(c, i) {
    if (c.classList.contains('clip-locked')) return;
    var targetTrack = document.querySelector('.track-content[data-track="' + trackIds[i % trackIds.length] + '"]');
    if (targetTrack && c.parentElement !== targetTrack) {
      c.parentElement.removeChild(c);
      targetTrack.appendChild(c);
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips distributed across tracks');
}

function cycleExerciseInPattern() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var samePattern = EXERCISES.filter(function(e) { return e.pattern === ex.pattern; });
  samePattern.sort(function(a, b) { return a.stage - b.stage; });
  var curIdx = -1;
  for (var i = 0; i < samePattern.length; i++) {
    if (samePattern[i].id === ex.id) { curIdx = i; break; }
  }
  var nextIdx = (curIdx + 1) % samePattern.length;
  var next = samePattern[nextIdx];
  pushUndo();
  selectedClip.dataset.exerciseId = next.id;
  var nameEl = selectedClip.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = next.name;
  var dotsEl = selectedClip.querySelector('.clip-stage-dots');
  if (dotsEl) {
    var dots = dotsEl.querySelectorAll('.clip-stage-dot');
    dots.forEach(function(d, i) { d.className = 'clip-stage-dot' + (i < next.stage ? ' filled' : ''); });
  }
  selectClipEl(selectedClip);
  saveSession(); sfx('click');
  toast(next.name + ' (S' + next.stage + ')');
}

function compactAllTracks() {
  pushUndo();
  var total = 0;
  var trackIds = ['push', 'pull', 'core', 'legs', 'skills'];
  trackIds.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var clips = Array.from(tc.querySelectorAll('.clip'));
    if (clips.length === 0) return;
    clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    var ho = 100;
    var gap = 4;
    var pos = ho;
    clips.forEach(function(c) {
      if (c.classList.contains('clip-locked')) {
        pos = parseInt(c.style.left) + parseInt(c.style.width) + gap;
        return;
      }
      if (parseInt(c.style.left) !== pos) total++;
      c.style.left = pos + 'px';
      pos += parseInt(c.style.width) + gap;
    });
  });
  updateStats(); saveSession(); sfx('click');
  toast('All tracks compacted (' + total + ' clips moved)');
}

function selectOverlappingClips() {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip.clip-overlap').forEach(function(c) {
    c.classList.add('selected');
    count++;
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' overlapping clip' + (count !== 1 ? 's' : '') + ' selected');
}

function selectSupersetClips() {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip.clip-superset').forEach(function(c) {
    c.classList.add('selected');
    count++;
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' superset clip' + (count !== 1 ? 's' : '') + ' selected');
}

function shiftAllClips(direction) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * (80 / 15));
  var ho = 100;
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    var newLeft = left + (direction * barPx);
    if (newLeft >= ho) {
      c.style.left = newLeft + 'px';
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips shifted ' + (direction > 0 ? 'right' : 'left') + ' 1 bar');
}

function insertSilenceAtPlayhead() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var playheadPx = ho + Math.round(currentTime * pps);
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * pps);
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    if (left >= playheadPx) {
      c.style.left = (left + barPx) + 'px';
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast('Inserted 1 bar silence (' + count + ' clips shifted)');
}

function removeSilenceAtPlayhead() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var playheadPx = ho + Math.round(currentTime * pps);
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * pps);
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    if (left >= playheadPx + barPx) {
      c.style.left = Math.max(ho, left - barPx) + 'px';
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast('Removed 1 bar silence (' + count + ' clips shifted)');
}

function cloneTrackToTarget(targetId) {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var target = document.querySelector('.track-content[data-track="' + targetId + '"]');
  if (!target) { toast('Target track not found'); return; }
  if (activeTrack === target) { toast('Cannot clone to same track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips to clone'); return; }
  pushUndo();
  var count = 0;
  clips.forEach(function(src) {
    var ex = getExercise(src.dataset.exerciseId);
    if (!ex) return;
    var clip = createClipElement(ex, parseInt(src.style.left), parseInt(src.style.width), {
      sets: src.dataset.sets, reps: src.dataset.reps,
      tempo: src.dataset.tempo, rest: src.dataset.rest,
      rpe: src.dataset.rpe,
      fadeIn: src.dataset.fadeIn || '0', fadeOut: src.dataset.fadeOut || '0'
    });
    if (src.dataset.notes) clip.dataset.notes = src.dataset.notes;
    if (src.dataset.customColor) {
      clip.dataset.customColor = src.dataset.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + src.dataset.customColor + '44 0%, ' + src.dataset.customColor + '22 100%)';
      clip.style.borderTopColor = src.dataset.customColor;
    }
    target.appendChild(clip);
    count++;
  });
  updateStats(); saveSession(); sfx('drop');
  toast(count + ' clips cloned to ' + targetId);
}

function getSessionElapsed() {
  var elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
  var h = Math.floor(elapsed / 3600);
  var m = Math.floor((elapsed % 3600) / 60);
  if (h > 0) return h + 'h ' + m + 'm';
  return m + ' min';
}

function exportSessionStats() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var name = document.getElementById('workout-name').textContent || 'Untitled';
  var lines = [];
  lines.push('=== ' + name + ' ===');
  lines.push('BPM: ' + bpm + ' | Mode: ' + (document.getElementById('bpm-mode').textContent || ''));
  lines.push('Clips: ' + clips.length);
  var totalSets = 0, totalReps = 0, totalRpe = 0;
  var families = {}, exercises = {}, disciplines = {};
  clips.forEach(function(c) {
    totalSets += parseInt(c.dataset.sets) || 3;
    totalReps += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8);
    totalRpe += parseInt(c.dataset.rpe) || 7;
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      families[ex.family] = (families[ex.family] || 0) + 1;
      exercises[ex.name] = (exercises[ex.name] || 0) + 1;
      if (ex.discipline) disciplines[ex.discipline] = true;
    }
  });
  lines.push('Total Sets: ' + totalSets + ' | Total Reps: ' + totalReps);
  lines.push('Avg RPE: ' + (totalRpe / clips.length).toFixed(1));
  lines.push('Disciplines: ' + Object.keys(disciplines).join(', '));
  lines.push('Families: ' + Object.keys(families).map(function(f) { return f + ' (' + families[f] + ')'; }).join(', '));
  lines.push('Session: ' + getSessionElapsed());
  if (workoutNotes) lines.push('Notes: ' + workoutNotes);
  navigator.clipboard.writeText(lines.join('\n')).then(function() { toast('Session stats copied'); });
}

var rpeColorMode = false;
function toggleRpeColorMode() {
  rpeColorMode = !rpeColorMode;
  var rpeColors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
  document.querySelectorAll('.clip').forEach(function(c) {
    if (rpeColorMode) {
      var rpe = parseInt(c.dataset.rpe) || 7;
      var color = rpeColors[rpe - 1] || '#eab308';
      c.style.borderTopColor = color + '88';
      c.style.background = 'linear-gradient(180deg, ' + color + '22 0%, ' + color + '11 100%)';
    } else {
      if (c.dataset.customColor) {
        c.style.background = 'linear-gradient(180deg, ' + c.dataset.customColor + '44 0%, ' + c.dataset.customColor + '22 100%)';
        c.style.borderTopColor = c.dataset.customColor;
      } else {
        var ex = getExercise(c.dataset.exerciseId);
        var fc = (ex && FAMILY_MAP[ex.family]) ? FAMILY_MAP[ex.family].color : '#666';
        c.style.background = 'linear-gradient(180deg, ' + fc + '22 0%, ' + fc + '11 100%)';
        c.style.borderTopColor = fc + '44';
      }
    }
  });
  toast('RPE Color Mode: ' + (rpeColorMode ? 'ON' : 'OFF'));
}

var _lastCommand = null;
function repeatLastCommand() {
  if (!_lastCommand) { toast('No command to repeat'); return; }
  _lastCommand();
}

function selectNextClip() {
  var allClips = getSortedClips();
  if (allClips.length === 0) return;
  var curIdx = -1;
  if (selectedClip) {
    for (var i = 0; i < allClips.length; i++) {
      if (allClips[i] === selectedClip) { curIdx = i; break; }
    }
  }
  var nextIdx = (curIdx + 1) % allClips.length;
  selectClipEl(allClips[nextIdx]);
  sfx('click');
}

function selectPrevClip() {
  var allClips = getSortedClips();
  if (allClips.length === 0) return;
  var curIdx = 0;
  if (selectedClip) {
    for (var i = 0; i < allClips.length; i++) {
      if (allClips[i] === selectedClip) { curIdx = i; break; }
    }
  }
  var prevIdx = (curIdx - 1 + allClips.length) % allClips.length;
  selectClipEl(allClips[prevIdx]);
  sfx('click');
}

function getSortedClips() {
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var result = [];
  trackOrder.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    trackClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    result = result.concat(trackClips);
  });
  return result;
}

function selectDuplicateExercises() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.exerciseId === ex.id) {
      c.classList.add('selected');
      count++;
    }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clip' + (count !== 1 ? 's' : '') + ' with ' + ex.name + ' selected');
}

function selectClipsInTimeRange(startSec, endSec) {
  var pps = 80 / 15;
  var ho = 100;
  var startPx = ho + Math.round(startSec * pps);
  var endPx = ho + Math.round(endSec * pps);
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var cL = parseInt(c.style.left);
    var cR = cL + parseInt(c.style.width);
    if (cR > startPx && cL < endPx) {
      c.classList.add('selected');
      count++;
    }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clips in ' + startSec + '-' + endSec + 's selected');
}

function saveWorkoutTemplate() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to save as template'); return; }
  var name = document.getElementById('workout-name').textContent || 'Untitled';
  showInlinePrompt('Template Name', name + ' Template', function(templateName) {
    if (!templateName) return;
    var template = {
      name: templateName,
      bpm: bpm,
      tracks: []
    };
    var trackIds = ['push', 'pull', 'core', 'legs', 'skills'];
    trackIds.forEach(function(tid) {
      var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
      if (!tc) return;
      var trackClips = [];
      tc.querySelectorAll('.clip').forEach(function(c) {
        trackClips.push({
          exerciseId: c.dataset.exerciseId,
          left: parseInt(c.style.left),
          width: parseInt(c.style.width),
          sets: c.dataset.sets, reps: c.dataset.reps,
          tempo: c.dataset.tempo, rest: c.dataset.rest,
          rpe: c.dataset.rpe
        });
      });
      if (trackClips.length > 0) template.tracks.push({id: tid, clips: trackClips});
    });
    var templates = [];
    try { templates = JSON.parse(localStorage.getItem('sms-templates') || '[]'); } catch(e) {}
    templates.unshift(template);
    if (templates.length > 10) templates.pop();
    try { localStorage.setItem('sms-templates', JSON.stringify(templates)); } catch(e) {}
    toast('Template saved: ' + templateName);
  });
}

function loadWorkoutTemplate() {
  var templates = [];
  try { templates = JSON.parse(localStorage.getItem('sms-templates') || '[]'); } catch(e) {}
  if (templates.length === 0) { toast('No templates saved'); return; }
  var items = templates.map(function(t, i) { return (i + 1) + '. ' + t.name + ' (' + t.bpm + ' BPM)'; });
  showInlinePrompt('Load Template (number)', items.join('\n'), function(val) {
    var idx = parseInt(val) - 1;
    if (isNaN(idx) || idx < 0 || idx >= templates.length) { toast('Invalid template number'); return; }
    var template = templates[idx];
    pushUndo();
    document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
    selectedClip = null;
    document.getElementById('inspector').style.display = 'none';
    bpm = template.bpm;
    document.getElementById('bpm-input').value = bpm;
    updateBPMMode();
    template.tracks.forEach(function(t) {
      var tc = document.querySelector('.track-content[data-track="' + t.id + '"]');
      if (!tc) return;
      t.clips.forEach(function(cd) {
        var ex = getExercise(cd.exerciseId);
        if (!ex) return;
        var clip = createClipElement(ex, cd.left, cd.width, {
          sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe
        });
        tc.appendChild(clip);
      });
    });
    updateStats(); saveSession(); sfx('drop');
    toast('Loaded: ' + template.name);
  });
}

/* ===== BATCH 250: WORKOUT VERSION TRACKING ===== */
var _workoutVersion = 1;
function bumpVersion() {
  _workoutVersion++;
  updateVersionDisplay();
}
function updateVersionDisplay() {
  var el = document.getElementById('footer-version');
  if (el) el.textContent = 'v' + _workoutVersion;
}

/* ===== BATCH 251: HALF-TIME / DOUBLE-TIME BPM ===== */
function halfTimeBPM() {
  var newBpm = Math.max(30, Math.round(bpm / 2));
  bpm = newBpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  saveSession();
  sfx('click');
  toast('Half-time: ' + bpm + ' BPM');
}
function doubleTimeBPM() {
  var newBpm = Math.min(300, bpm * 2);
  bpm = newBpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  saveSession();
  sfx('click');
  toast('Double-time: ' + bpm + ' BPM');
}

/* ===== BATCH 252: EXPORT AS HTML REPORT ===== */
function exportHTMLReport() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var name = workoutName || 'Untitled Workout';
  var modeName = document.getElementById('bpm-mode') ? document.getElementById('bpm-mode').textContent : '';
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var trackLabels = {push:'Push', pull:'Pull', core:'Core', legs:'Legs', skills:'Skills'};
  var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
  var totalSets = 0; var totalReps = 0; var exerciseSet = {};
  var trackData = {};
  trackOrder.forEach(function(tid) { trackData[tid] = []; });
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex || !trackData[tid]) return;
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    totalSets += sets; totalReps += sets * reps;
    exerciseSet[ex.id] = true;
    trackData[tid].push({
      name: ex.name, stage: ex.stage, discipline: ex.discipline,
      sets: sets, reps: reps, tempo: c.dataset.tempo || '3',
      rest: c.dataset.rest || '60', rpe: c.dataset.rpe || '7',
      notes: c.dataset.notes || ''
    });
  });
  var estTime = 0;
  clips.forEach(function(c) {
    var s = parseInt(c.dataset.sets) || 3;
    var r = parseInt(c.dataset.reps) || 8;
    var t = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    estTime += s * r * t + (s - 1) * rest;
  });
  var estMin = Math.round(estTime / 60);
  var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>' + name + ' - SMS Report</title>';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#050711;color:#e2e8f0;font-family:Sora,system-ui,sans-serif;padding:40px 20px;max-width:800px;margin:0 auto}';
  html += 'h1{font-size:24px;font-weight:700;margin-bottom:4px}h2{font-size:14px;font-weight:600;margin:24px 0 8px;text-transform:uppercase;letter-spacing:0.08em}';
  html += '.meta{font-size:11px;color:#64748b;margin-bottom:20px;display:flex;gap:16px;flex-wrap:wrap}.meta span{white-space:nowrap}';
  html += '.track-section{margin-bottom:20px}.track-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:6px 0;border-bottom:1px solid #1e293b;margin-bottom:8px}';
  html += 'table{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:8px}th{text-align:left;padding:4px 8px;color:#64748b;font-weight:500;border-bottom:1px solid #1e293b;font-size:10px}';
  html += 'td{padding:4px 8px;border-bottom:1px solid #0f172a}.notes-cell{font-size:9px;color:#94a3b8;font-style:italic}';
  html += '.rpe-badge{display:inline-block;width:18px;height:14px;border-radius:3px;text-align:center;font-size:9px;font-weight:600;line-height:14px}';
  html += '.footer-bar{margin-top:32px;padding-top:12px;border-top:1px solid #1e293b;font-size:9px;color:#475569;text-align:center}';
  html += '@media print{body{background:#fff;color:#1e293b}td,th{border-bottom-color:#e2e8f0}.track-label{border-bottom-color:#e2e8f0}.footer-bar{border-top-color:#e2e8f0}}</style></head><body>';
  html += '<h1>' + name + '</h1>';
  html += '<div class="meta"><span>' + bpm + ' BPM ' + modeName + '</span><span>' + clips.length + ' clips</span><span>' + Object.keys(exerciseSet).length + ' exercises</span>';
  html += '<span>' + totalSets + ' total sets</span><span>~' + estMin + ' min</span>';
  if (_sessionCreatedAt) html += '<span>Created: ' + new Date(_sessionCreatedAt).toLocaleDateString() + '</span>';
  html += '<span>Exported: ' + new Date().toLocaleDateString() + '</span></div>';
  if (workoutNotes) html += '<p style="font-size:11px;color:#94a3b8;margin-bottom:16px;padding:8px;background:#0f172a;border-radius:4px">' + workoutNotes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
  trackOrder.forEach(function(tid) {
    if (trackData[tid].length === 0) return;
    html += '<div class="track-section"><div class="track-label" style="color:' + familyColors[tid] + '">' + trackLabels[tid] + ' (' + trackData[tid].length + ')</div>';
    html += '<table><tr><th>#</th><th>Exercise</th><th>S</th><th>Sets</th><th>Reps</th><th>Tempo</th><th>Rest</th><th>RPE</th></tr>';
    trackData[tid].forEach(function(item, idx) {
      var rpeVal = parseInt(item.rpe) || 7;
      var rpeColors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
      var rpeColor = rpeColors[rpeVal - 1] || '#eab308';
      html += '<tr><td>' + (idx + 1) + '</td><td>' + item.name + '</td><td>S' + item.stage + '</td>';
      html += '<td>' + item.sets + '</td><td>' + item.reps + '</td><td>' + item.tempo + 's</td><td>' + item.rest + 's</td>';
      html += '<td><span class="rpe-badge" style="background:' + rpeColor + '22;color:' + rpeColor + '">' + rpeVal + '</span></td></tr>';
      if (item.notes) html += '<tr><td></td><td colspan="7" class="notes-cell">' + item.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</td></tr>';
    });
    html += '</table></div>';
  });
  html += '<div class="footer-bar">Generated by Saturno Movement Studio | saturnomovement.com</div>';
  html += '</body></html>';
  var blob = new Blob([html], {type: 'text/html'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-report.html';
  a.click();
  toast('HTML report exported');
}

/* ===== BATCH 253: SUGGEST PROGRESSION ===== */
function suggestProgression(direction) {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var targetStage = direction === 'up' ? ex.stage + 1 : ex.stage - 1;
  if (targetStage < 1 || targetStage > 3) { toast('No ' + (direction === 'up' ? 'harder' : 'easier') + ' progression'); return; }
  var candidates = EXERCISES.filter(function(e) { return e.pattern === ex.pattern && e.stage === targetStage; });
  if (candidates.length === 0) { toast('No stage ' + targetStage + ' for ' + ex.pattern); return; }
  pushUndo();
  var replacement = candidates[Math.floor(Math.random() * candidates.length)];
  selectedClip.dataset.exerciseId = replacement.id;
  var nameEl = selectedClip.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = replacement.name;
  var dots = selectedClip.querySelector('.clip-stage-dots');
  if (dots) {
    dots.innerHTML = '';
    for (var d = 1; d <= 3; d++) {
      var dot = document.createElement('span');
      dot.style.cssText = 'width:3px;height:3px;border-radius:50%;background:' + (d <= replacement.stage ? 'var(--accent-cyan)' : 'rgba(255,255,255,0.15)');
      dots.appendChild(dot);
    }
  }
  selectClipEl(selectedClip);
  saveSession(); sfx('click');
  toast((direction === 'up' ? 'Harder' : 'Easier') + ': ' + replacement.name + ' (S' + replacement.stage + ')');
}

/* ===== BATCH 254: TRACK COLOR THEME ===== */
var trackColorOverrides = {};
function setTrackColor(trackId, color) {
  trackColorOverrides[trackId] = color;
  var tc = document.querySelector('.track-content[data-track="' + trackId + '"]');
  if (!tc) return;
  tc.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.customColor) return;
    c.style.borderTopColor = color;
    c.style.background = 'linear-gradient(180deg, ' + color + '22 0%, ' + color + '11 100%)';
  });
  saveSession();
  toast(trackId + ' track color set');
}
function resetTrackColor(trackId) {
  delete trackColorOverrides[trackId];
  var tc = document.querySelector('.track-content[data-track="' + trackId + '"]');
  if (!tc) return;
  tc.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.customColor) return;
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
    var fc = familyColors[ex.family] || '#06b6d4';
    c.style.borderTopColor = fc;
    c.style.background = 'linear-gradient(180deg, ' + fc + '22 0%, ' + fc + '11 100%)';
  });
  saveSession();
  toast(trackId + ' track color reset');
}

/* ===== BATCH 255: INSERT REST BETWEEN CLIPS ===== */
function insertRestBetweenClips() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) { toast('Select 2+ clips to insert rest gaps'); return; }
  pushUndo();
  var byTrack = {};
  sel.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!byTrack[tid]) byTrack[tid] = [];
    byTrack[tid].push(c);
  });
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var restGap = beatPx * 4;
  var count = 0;
  Object.keys(byTrack).forEach(function(tid) {
    var trackClips = byTrack[tid];
    trackClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    for (var i = trackClips.length - 1; i > 0; i--) {
      if (trackClips[i].classList.contains('clip-locked')) continue;
      var prevRight = parseInt(trackClips[i - 1].style.left) + parseInt(trackClips[i - 1].style.width);
      var curLeft = parseInt(trackClips[i].style.left);
      var gap = curLeft - prevRight;
      if (gap < restGap) {
        var shift = restGap - gap;
        for (var j = i; j < trackClips.length; j++) {
          if (trackClips[j].classList.contains('clip-locked')) continue;
          trackClips[j].style.left = (parseInt(trackClips[j].style.left) + shift) + 'px';
          count++;
        }
      }
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast('Rest gaps inserted (' + count + ' clips shifted)');
}

/* ===== BATCH 256: WORKOUT COMPARISON DIFF ===== */
function workoutDiff() {
  var saved = null;
  try { saved = JSON.parse(localStorage.getItem('sms_session')); } catch(e) {}
  if (!saved || !saved.clips) { toast('No saved state to compare'); return; }
  var currentClips = [];
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    currentClips.push({
      name: ex ? ex.name : '?',
      track: c.parentElement.dataset.track,
      sets: c.dataset.sets, reps: c.dataset.reps,
      rpe: c.dataset.rpe
    });
  });
  var savedExNames = {};
  saved.clips.forEach(function(c) {
    var ex = getExercise(c.exerciseId);
    var key = (ex ? ex.name : '?') + ':' + c.track;
    savedExNames[key] = (savedExNames[key] || 0) + 1;
  });
  var currentExNames = {};
  currentClips.forEach(function(c) {
    var key = c.name + ':' + c.track;
    currentExNames[key] = (currentExNames[key] || 0) + 1;
  });
  var added = [];
  var removed = [];
  Object.keys(currentExNames).forEach(function(k) {
    var diff = currentExNames[k] - (savedExNames[k] || 0);
    if (diff > 0) added.push(k.split(':')[0] + ' x' + diff);
  });
  Object.keys(savedExNames).forEach(function(k) {
    var diff = savedExNames[k] - (currentExNames[k] || 0);
    if (diff > 0) removed.push(k.split(':')[0] + ' x' + diff);
  });
  var msg = 'Diff vs saved:\n';
  if (added.length) msg += 'Added: ' + added.join(', ') + '\n';
  if (removed.length) msg += 'Removed: ' + removed.join(', ') + '\n';
  if (!added.length && !removed.length) msg += 'No differences';
  msg += '\nClips: ' + saved.clips.length + ' -> ' + currentClips.length;
  toast(msg);
}

/* ===== BATCH 257: AUTO-GENERATE WARMUP ===== */
function generateWarmup() {
  var mobilityExercises = EXERCISES.filter(function(e) { return e.discipline === 'Mobility'; });
  if (mobilityExercises.length === 0) { toast('No mobility exercises available'); return; }
  pushUndo();
  var ho = 100;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 4;
  var gap = 4;
  var shuffled = mobilityExercises.slice().sort(function() { return Math.random() - 0.5; });
  var warmupCount = Math.min(4, shuffled.length);
  var targetTrack = document.querySelector('.track-content[data-track="skills"]');
  if (!targetTrack) { toast('No skills track'); return; }
  var minLeft = Infinity;
  document.querySelectorAll('.clip').forEach(function(c) {
    var l = parseInt(c.style.left);
    if (l < minLeft) minLeft = l;
  });
  if (minLeft === Infinity) minLeft = ho + clipW * warmupCount + gap * warmupCount + beatPx * 2;
  var warmupStart = ho;
  if (minLeft > ho) {
    var neededSpace = warmupCount * (clipW + gap) + beatPx * 2;
    if (minLeft - ho < neededSpace) {
      var shift = neededSpace - (minLeft - ho);
      document.querySelectorAll('.clip').forEach(function(c) {
        if (c.classList.contains('clip-locked')) return;
        c.style.left = (parseInt(c.style.left) + shift) + 'px';
      });
    }
  }
  var xPos = warmupStart;
  for (var i = 0; i < warmupCount; i++) {
    var ex = shuffled[i];
    var clip = createClipElement(ex, xPos, clipW, {
      sets: '2', reps: '10', tempo: '3', rest: '30', rpe: '3'
    });
    targetTrack.appendChild(clip);
    xPos += clipW + gap;
  }
  updateStats(); saveSession(); sfx('drop');
  toast(warmupCount + ' warmup exercises added to Skills track');
}

/* ===== BATCH 258: AUTO-GENERATE COOLDOWN ===== */
function generateCooldown() {
  var mobilityExercises = EXERCISES.filter(function(e) { return e.discipline === 'Mobility'; });
  if (mobilityExercises.length === 0) { toast('No mobility exercises available'); return; }
  pushUndo();
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 6;
  var gap = 4;
  var shuffled = mobilityExercises.slice().sort(function() { return Math.random() - 0.5; });
  var cooldownCount = Math.min(4, shuffled.length);
  var targetTrack = document.querySelector('.track-content[data-track="skills"]');
  if (!targetTrack) { toast('No skills track'); return; }
  var maxRight = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var cooldownStart = maxRight + beatPx * 2;
  var xPos = cooldownStart;
  for (var i = 0; i < cooldownCount; i++) {
    var ex = shuffled[i];
    var clip = createClipElement(ex, xPos, clipW, {
      sets: '1', reps: '1', tempo: '30', rest: '10', rpe: '2'
    });
    targetTrack.appendChild(clip);
    xPos += clipW + gap;
  }
  updateStats(); saveSession(); sfx('drop');
  toast(cooldownCount + ' cooldown stretches added after workout');
}

/* ===== BATCH 259: SPLIT CLIP INTO N EQUAL PARTS ===== */
function splitClipEqual(n) {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  if (n < 2 || n > 8) { toast('Split into 2-8 parts'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  pushUndo();
  var origLeft = parseInt(selectedClip.style.left);
  var origWidth = parseInt(selectedClip.style.width);
  var partWidth = Math.floor(origWidth / n);
  if (partWidth < 10) { toast('Clip too small to split ' + n + ' ways'); return; }
  var track = selectedClip.parentElement;
  var origSets = Math.max(1, Math.floor((parseInt(selectedClip.dataset.sets) || 3) / n));
  var props = {
    sets: String(origSets), reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: '0', fadeOut: '0'
  };
  if (selectedClip.dataset.notes) props.notes = selectedClip.dataset.notes;
  selectedClip.remove();
  selectedClip = null;
  for (var i = 0; i < n; i++) {
    var clip = createClipElement(ex, origLeft + i * partWidth, partWidth, props);
    if (props.notes) clip.dataset.notes = props.notes;
    track.appendChild(clip);
  }
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession(); sfx('click');
  toast('Clip split into ' + n + ' equal parts');
}

/* ===== BATCH 260: WORKOUT TIMER COUNTDOWN ===== */
var _timerInterval = null;
var _timerOverlay = null;
function startWorkoutTimer() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips for timer'); return; }
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var exercises = [];
  trackOrder.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var tClips = Array.from(tc.querySelectorAll('.clip'));
    tClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    tClips.forEach(function(c) {
      var ex = getExercise(c.dataset.exerciseId);
      if (!ex) return;
      exercises.push({
        name: ex.name, sets: parseInt(c.dataset.sets) || 3,
        reps: parseInt(c.dataset.reps) || 8, tempo: parseFloat(c.dataset.tempo) || 3,
        rest: parseInt(c.dataset.rest) || 60
      });
    });
  });
  if (exercises.length === 0) { toast('No exercises found'); return; }
  var ov = document.createElement('div');
  ov.id = 'timer-overlay';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(5,7,17,0.97);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Sora,system-ui,sans-serif;color:#e2e8f0';
  var html = '<div style="text-align:center;max-width:500px;padding:20px">';
  html += '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px">Workout Timer</div>';
  html += '<div id="timer-exercise" style="font-size:28px;font-weight:700;margin-bottom:4px">Ready</div>';
  html += '<div id="timer-detail" style="font-size:13px;color:#94a3b8;margin-bottom:24px"></div>';
  html += '<div id="timer-countdown" style="font-size:72px;font-weight:700;font-variant-numeric:tabular-nums;color:var(--accent-cyan,#22d3ee);margin-bottom:24px">0</div>';
  html += '<div id="timer-progress" style="font-size:11px;color:#64748b;margin-bottom:32px"></div>';
  html += '<button id="timer-close" style="padding:8px 24px;background:transparent;border:1px solid #334155;color:#94a3b8;border-radius:4px;cursor:pointer;font-family:Sora,system-ui,sans-serif;font-size:11px">ESC to close</button>';
  html += '</div>';
  ov.innerHTML = html;
  document.body.appendChild(ov);
  _timerOverlay = ov;
  ov.querySelector('#timer-close').addEventListener('click', stopWorkoutTimer);
  var exIdx = 0; var setIdx = 0; var phase = 'work'; var countdown = 0;
  function showState() {
    var exerciseEl = ov.querySelector('#timer-exercise');
    var detailEl = ov.querySelector('#timer-detail');
    var countEl = ov.querySelector('#timer-countdown');
    var progEl = ov.querySelector('#timer-progress');
    if (exIdx >= exercises.length) {
      exerciseEl.textContent = 'Workout Complete!';
      detailEl.textContent = '';
      countEl.textContent = '';
      countEl.style.color = '#22c55e';
      progEl.textContent = exercises.length + '/' + exercises.length + ' exercises done';
      clearInterval(_timerInterval); _timerInterval = null;
      return;
    }
    var cur = exercises[exIdx];
    exerciseEl.textContent = cur.name;
    if (phase === 'work') {
      detailEl.textContent = 'Set ' + (setIdx + 1) + '/' + cur.sets + ' | ' + cur.reps + ' reps @ ' + cur.tempo + 's';
      countEl.textContent = countdown;
      countEl.style.color = '#22d3ee';
    } else {
      detailEl.textContent = 'Rest';
      countEl.textContent = countdown;
      countEl.style.color = '#eab308';
    }
    progEl.textContent = (exIdx + 1) + '/' + exercises.length + ' exercises';
  }
  function nextPhase() {
    var cur = exercises[exIdx];
    if (phase === 'work') {
      countdown = Math.round(cur.reps * cur.tempo);
      phase = 'work';
      showState();
      _timerInterval = setInterval(function() {
        countdown--;
        showState();
        if (countdown <= 0) {
          clearInterval(_timerInterval);
          setIdx++;
          if (setIdx >= cur.sets) {
            exIdx++; setIdx = 0;
            if (exIdx >= exercises.length) { showState(); return; }
            phase = 'rest'; countdown = exercises[exIdx - 1].rest;
          } else {
            phase = 'rest'; countdown = cur.rest;
          }
          nextPhase();
        }
      }, 1000);
    } else {
      showState();
      _timerInterval = setInterval(function() {
        countdown--;
        showState();
        if (countdown <= 0) {
          clearInterval(_timerInterval);
          phase = 'work';
          nextPhase();
        }
      }, 1000);
    }
  }
  phase = 'work';
  countdown = Math.round(exercises[0].reps * exercises[0].tempo);
  nextPhase();
}
function stopWorkoutTimer() {
  if (_timerInterval) { clearInterval(_timerInterval); _timerInterval = null; }
  if (_timerOverlay) { _timerOverlay.remove(); _timerOverlay = null; }
}

/* ===== BATCH 261: TRACK VOLUME BARS ===== */
function updateTrackVolumeBars() {
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var maxSets = 0;
  var trackSets = {};
  trackOrder.forEach(function(tid) {
    var total = 0;
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (tc) {
      tc.querySelectorAll('.clip').forEach(function(c) {
        total += parseInt(c.dataset.sets) || 3;
      });
    }
    trackSets[tid] = total;
    if (total > maxSets) maxSets = total;
  });
  trackOrder.forEach(function(tid) {
    var bar = document.getElementById('track-vol-' + tid);
    if (!bar) {
      var header = document.querySelector('.track[data-track="' + tid + '"] .track-header');
      if (!header) return;
      bar = document.createElement('div');
      bar.id = 'track-vol-' + tid;
      bar.style.cssText = 'position:absolute;bottom:2px;left:4px;right:4px;height:2px;border-radius:1px;background:rgba(255,255,255,0.05);overflow:hidden';
      var fill = document.createElement('div');
      fill.className = 'track-vol-fill';
      fill.style.cssText = 'height:100%;border-radius:1px;transition:width 0.3s';
      bar.appendChild(fill);
      header.style.position = 'relative';
      header.appendChild(bar);
    }
    var fill = bar.querySelector('.track-vol-fill');
    var pct = maxSets > 0 ? (trackSets[tid] / maxSets) * 100 : 0;
    var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
    fill.style.width = pct + '%';
    fill.style.background = familyColors[tid] || '#06b6d4';
  });
}

/* ===== BATCH 262: AUTO PHASE MARKERS ===== */
function addPhaseMarkers() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips for phase markers'); return; }
  var pps = 80 / 15;
  var ho = 100;
  var sortedByLeft = clips.slice().sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var firstTime = (parseInt(sortedByLeft[0].style.left) - ho) / pps;
  var lastRight = 0;
  sortedByLeft.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > lastRight) lastRight = r;
  });
  var endTime = (lastRight - ho) / pps;
  var totalDuration = endTime - firstTime;
  if (totalDuration < 60) { toast('Workout too short for phases'); return; }
  var warmupEnd = firstTime + totalDuration * 0.15;
  var cooldownStart = firstTime + totalDuration * 0.85;
  markers.push({id: ++markerCounter, time: firstTime, label: 'WARMUP'});
  markers.push({id: ++markerCounter, time: warmupEnd, label: 'MAIN'});
  markers.push({id: ++markerCounter, time: cooldownStart, label: 'COOLDOWN'});
  markers.push({id: ++markerCounter, time: endTime, label: 'END'});
  if (typeof renderAllMarkers === 'function') renderAllMarkers();
  saveSession(); sfx('click');
  toast('Phase markers added (Warmup / Main / Cooldown / End)');
}

/* ===== BATCH 263: RPE CURVE DISPLAY ===== */
function showRPECurve() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips'); return; }
  var sorted = clips.slice().sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var rpeValues = sorted.map(function(c) { return parseInt(c.dataset.rpe) || 7; });
  var names = sorted.map(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    return ex ? ex.name.substring(0, 12) : '?';
  });
  var maxRpe = 10;
  var barWidth = 24;
  var height = 100;
  var rpeColors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
  var svgWidth = Math.max(300, rpeValues.length * (barWidth + 4) + 40);
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + svgWidth + '" height="' + (height + 40) + '" style="background:#0f172a;border-radius:8px;padding:8px">';
  svg += '<text x="' + (svgWidth / 2) + '" y="14" text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Sora,sans-serif">RPE Curve</text>';
  rpeValues.forEach(function(rpe, i) {
    var x = 20 + i * (barWidth + 4);
    var barH = (rpe / maxRpe) * height * 0.8;
    var y = 24 + (height * 0.8 - barH);
    var color = rpeColors[rpe - 1] || '#eab308';
    svg += '<rect x="' + x + '" y="' + y + '" width="' + barWidth + '" height="' + barH + '" fill="' + color + '44" stroke="' + color + '" stroke-width="1" rx="2"/>';
    svg += '<text x="' + (x + barWidth / 2) + '" y="' + (y - 4) + '" text-anchor="middle" fill="' + color + '" font-size="9" font-family="Sora,sans-serif">' + rpe + '</text>';
    svg += '<text x="' + (x + barWidth / 2) + '" y="' + (24 + height * 0.8 + 12) + '" text-anchor="middle" fill="#475569" font-size="7" font-family="Sora,sans-serif" transform="rotate(-45,' + (x + barWidth / 2) + ',' + (24 + height * 0.8 + 12) + ')">' + names[i] + '</text>';
  });
  svg += '</svg>';
  var blob = new Blob([svg], {type: 'image/svg+xml'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  toast('RPE curve opened in new tab');
}

/* ===== BATCH 264: SUPERSET GROUP NAMING ===== */
function nameSupersetGroups() {
  var clips = document.querySelectorAll('.clip');
  var groups = {};
  clips.forEach(function(c) {
    var left = parseInt(c.style.left);
    var right = left + parseInt(c.style.width);
    var tid = c.parentElement.dataset.track;
    clips.forEach(function(c2) {
      if (c === c2) return;
      var tid2 = c2.parentElement.dataset.track;
      if (tid === tid2) return;
      var l2 = parseInt(c2.style.left);
      var r2 = l2 + parseInt(c2.style.width);
      if (left < r2 && right > l2) {
        var key = Math.min(left, l2) + '-' + Math.max(right, r2);
        if (!groups[key]) groups[key] = [];
        if (groups[key].indexOf(c) === -1) groups[key].push(c);
        if (groups[key].indexOf(c2) === -1) groups[key].push(c2);
      }
    });
  });
  var keys = Object.keys(groups);
  if (keys.length === 0) { toast('No supersets found'); return; }
  var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var count = 0;
  keys.forEach(function(k, idx) {
    var label = labels[idx % 26] + '1';
    groups[k].forEach(function(c) {
      c.dataset.supersetLabel = label;
      var badge = c.querySelector('.clip-ss-label');
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'clip-ss-label';
        badge.style.cssText = 'position:absolute;top:1px;right:14px;font-size:7px;font-weight:700;color:rgba(168,85,247,0.9);letter-spacing:0.04em;z-index:2';
        c.appendChild(badge);
      }
      badge.textContent = label;
    });
    count++;
  });
  saveSession(); sfx('click');
  toast(count + ' superset group' + (count !== 1 ? 's' : '') + ' labeled');
}

/* ===== BATCH 265: DENSITY HEATMAP ===== */
function showDensityHeatmap() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var ho = 100; var pps = 80 / 15;
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var totalSec = Math.ceil((maxRight - ho) / pps);
  var bucketSize = 15;
  var buckets = [];
  for (var b = 0; b < Math.ceil(totalSec / bucketSize); b++) buckets.push(0);
  clips.forEach(function(c) {
    var startSec = (parseInt(c.style.left) - ho) / pps;
    var endSec = startSec + parseInt(c.style.width) / pps;
    for (var b = 0; b < buckets.length; b++) {
      var bStart = b * bucketSize;
      var bEnd = (b + 1) * bucketSize;
      if (startSec < bEnd && endSec > bStart) buckets[b]++;
    }
  });
  var maxDensity = Math.max.apply(null, buckets) || 1;
  var barW = 20; var barH = 80;
  var svgW = buckets.length * (barW + 2) + 40;
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + svgW + '" height="' + (barH + 50) + '" style="background:#0f172a;border-radius:8px;padding:8px">';
  svg += '<text x="' + (svgW / 2) + '" y="14" text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Sora,sans-serif">Timeline Density (' + bucketSize + 's buckets)</text>';
  buckets.forEach(function(count, i) {
    var x = 20 + i * (barW + 2);
    var h = (count / maxDensity) * barH * 0.8;
    var y = 24 + barH * 0.8 - h;
    var intensity = count / maxDensity;
    var r = Math.round(34 + intensity * 205);
    var g = Math.round(211 - intensity * 143);
    var b = Math.round(238 - intensity * 170);
    var color = 'rgb(' + r + ',' + g + ',' + b + ')';
    svg += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + Math.max(2, h) + '" fill="' + color + '44" stroke="' + color + '" stroke-width="1" rx="2"/>';
    svg += '<text x="' + (x + barW / 2) + '" y="' + (y - 3) + '" text-anchor="middle" fill="' + color + '" font-size="8" font-family="Sora,sans-serif">' + count + '</text>';
    var label = Math.floor(i * bucketSize / 60) + ':' + (String(Math.floor(i * bucketSize % 60))).padStart(2, '0');
    svg += '<text x="' + (x + barW / 2) + '" y="' + (24 + barH * 0.8 + 12) + '" text-anchor="middle" fill="#475569" font-size="7" font-family="Sora,sans-serif">' + label + '</text>';
  });
  svg += '</svg>';
  var blob = new Blob([svg], {type: 'image/svg+xml'});
  window.open(URL.createObjectURL(blob), '_blank');
  toast('Density heatmap opened');
}

/* ===== BATCH 266: EXERCISE SEARCH AND REPLACE ===== */
function searchReplaceExercise() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var exerciseMap = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) exerciseMap[ex.id] = ex.name;
  });
  var exList = Object.keys(exerciseMap);
  if (exList.length === 0) { toast('No exercises found'); return; }
  var promptText = 'Exercises in workout:\n';
  exList.forEach(function(id, i) { promptText += (i + 1) + '. ' + exerciseMap[id] + '\n'; });
  promptText += '\nEnter number to replace:';
  showInlinePrompt(promptText, function(val) {
    var idx = parseInt(val) - 1;
    if (isNaN(idx) || idx < 0 || idx >= exList.length) { toast('Invalid selection'); return; }
    var oldId = exList[idx];
    var oldEx = getExercise(oldId);
    var samePattern = EXERCISES.filter(function(e) { return e.pattern === oldEx.pattern && e.id !== oldId; });
    if (samePattern.length === 0) { toast('No alternatives for ' + oldEx.pattern); return; }
    var replaceText = 'Replace ' + oldEx.name + ' with:\n';
    samePattern.forEach(function(e, i) { replaceText += (i + 1) + '. ' + e.name + ' (S' + e.stage + ')\n'; });
    showInlinePrompt(replaceText, function(val2) {
      var rIdx = parseInt(val2) - 1;
      if (isNaN(rIdx) || rIdx < 0 || rIdx >= samePattern.length) { toast('Invalid selection'); return; }
      var newEx = samePattern[rIdx];
      pushUndo();
      var count = 0;
      clips.forEach(function(c) {
        if (c.dataset.exerciseId === oldId) {
          if (c.classList.contains('clip-locked')) return;
          c.dataset.exerciseId = newEx.id;
          var nameEl = c.querySelector('.clip-name');
          if (nameEl) nameEl.textContent = newEx.name;
          var dots = c.querySelector('.clip-stage-dots');
          if (dots) {
            dots.innerHTML = '';
            for (var d = 1; d <= 3; d++) {
              var dot = document.createElement('span');
              dot.style.cssText = 'width:3px;height:3px;border-radius:50%;background:' + (d <= newEx.stage ? 'var(--accent-cyan)' : 'rgba(255,255,255,0.15)');
              dots.appendChild(dot);
            }
          }
          count++;
        }
      });
      updateStats(); saveSession(); sfx('click');
      toast('Replaced ' + count + ' clips: ' + oldEx.name + ' -> ' + newEx.name);
    });
  });
}

/* ===== BATCH 267: PROGRESSIVE RPE ===== */
function progressiveRPE(direction) {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var startRPE = direction === 'ascending' ? 4 : 9;
  var endRPE = direction === 'ascending' ? 9 : 4;
  var count = 0;
  clips.forEach(function(c, i) {
    if (c.classList.contains('clip-locked')) return;
    var rpe = Math.round(startRPE + (endRPE - startRPE) * (i / Math.max(1, clips.length - 1)));
    c.dataset.rpe = String(rpe);
    var badge = c.querySelector('.clip-rpe-badge');
    if (badge) badge.textContent = rpe;
    updateClipDNA(c);
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips set to ' + direction + ' RPE (' + startRPE + '->' + endRPE + ')');
}

/* ===== BATCH 268: CIRCUIT MODE ===== */
function arrangeAsCircuit() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) {
    sel = Array.from(document.querySelectorAll('.clip'));
  }
  if (sel.length < 2) { toast('Need 2+ clips for circuit'); return; }
  pushUndo();
  var ho = 100;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 4;
  var gap = 4;
  var byTrack = {};
  sel.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!byTrack[tid]) byTrack[tid] = [];
    byTrack[tid].push(c);
  });
  var trackIds = Object.keys(byTrack);
  if (trackIds.length < 2) { toast('Need clips on 2+ tracks for circuit'); return; }
  var maxRounds = 0;
  trackIds.forEach(function(tid) {
    if (byTrack[tid].length > maxRounds) maxRounds = byTrack[tid].length;
  });
  var xPos = ho;
  var count = 0;
  for (var round = 0; round < maxRounds; round++) {
    trackIds.forEach(function(tid) {
      if (round < byTrack[tid].length) {
        var c = byTrack[tid][round];
        if (c.classList.contains('clip-locked')) return;
        c.style.left = xPos + 'px';
        c.style.width = clipW + 'px';
        xPos += clipW + gap;
        count++;
      }
    });
    xPos += beatPx * 2;
  }
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips arranged in circuit (' + maxRounds + ' rounds)');
}

/* ===== BATCH 269: TIME UNDER TENSION CALCULATOR ===== */
function showTUT() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var totalTUT = 0;
  var perExercise = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var tut = sets * reps * tempo;
    totalTUT += tut;
    if (!perExercise[ex.name]) perExercise[ex.name] = 0;
    perExercise[ex.name] += tut;
  });
  var sorted = Object.keys(perExercise).sort(function(a, b) { return perExercise[b] - perExercise[a]; });
  var msg = 'Time Under Tension\n';
  msg += 'Total: ' + Math.round(totalTUT) + 's (' + (totalTUT / 60).toFixed(1) + ' min)\n\n';
  sorted.forEach(function(name, i) {
    msg += (i + 1) + '. ' + name + ': ' + Math.round(perExercise[name]) + 's\n';
  });
  toast(msg);
}

/* ===== BATCH 270: ENHANCED CLIP INFO TOOLTIP ===== */
function showClipDetail(clipEl) {
  var ex = getExercise(clipEl.dataset.exerciseId);
  if (!ex) return;
  var sets = clipEl.dataset.sets || '3';
  var reps = clipEl.dataset.reps || '8';
  var tempo = clipEl.dataset.tempo || '3';
  var rest = clipEl.dataset.rest || '60';
  var rpe = clipEl.dataset.rpe || '7';
  var tut = parseInt(sets) * parseInt(reps) * parseFloat(tempo);
  var info = ex.name + ' (S' + ex.stage + ')';
  info += '\n' + ex.pattern + ' | ' + ex.discipline;
  info += '\n' + sets + 'x' + reps + ' @ ' + tempo + 's | Rest ' + rest + 's | RPE ' + rpe;
  info += '\nTUT: ' + Math.round(tut) + 's';
  if (clipEl.dataset.notes) info += '\nNote: ' + clipEl.dataset.notes.substring(0, 50);
  if (clipEl.dataset.locked === '1') info += '\n[LOCKED]';
  clipEl.title = info;
}

/* ===== BATCH 271: WORKOUT RATING ===== */
var _workoutRating = 0;
function rateWorkout() {
  showInlinePrompt('Rate this workout (1-5 stars):', function(val) {
    var rating = parseInt(val);
    if (isNaN(rating) || rating < 1 || rating > 5) { toast('Enter 1-5'); return; }
    _workoutRating = rating;
    var stars = '';
    for (var i = 0; i < 5; i++) stars += i < rating ? '\u2605' : '\u2606';
    try {
      var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
      ratings.push({
        name: workoutName || 'Untitled',
        rating: rating,
        date: new Date().toISOString(),
        clips: document.querySelectorAll('.clip').length,
        bpm: bpm
      });
      if (ratings.length > 50) ratings = ratings.slice(-50);
      localStorage.setItem('sms_ratings', JSON.stringify(ratings));
    } catch(e) {}
    toast(stars + ' (' + rating + '/5) rated');
  });
}
function showRatingHistory() {
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    if (ratings.length === 0) { toast('No ratings yet'); return; }
    var msg = 'Workout Ratings:\n';
    ratings.slice(-10).reverse().forEach(function(r, i) {
      var stars = '';
      for (var s = 0; s < 5; s++) stars += s < r.rating ? '\u2605' : '\u2606';
      msg += (i + 1) + '. ' + stars + ' ' + r.name + ' (' + new Date(r.date).toLocaleDateString() + ')\n';
    });
    toast(msg);
  } catch(e) { toast('Error loading ratings'); }
}

/* ===== BATCH 272: EXERCISE SUBSTITUTION TABLE ===== */
function showSubstitutions() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var samePattern = EXERCISES.filter(function(e) { return e.pattern === ex.pattern && e.id !== ex.id; });
  var sameFamily = EXERCISES.filter(function(e) { return e.family === ex.family && e.id !== ex.id && e.pattern !== ex.pattern; });
  var msg = 'Substitutions for ' + ex.name + ' (S' + ex.stage + ', ' + ex.pattern + ')\n\n';
  if (samePattern.length > 0) {
    msg += 'Same Pattern (' + ex.pattern + '):\n';
    samePattern.forEach(function(e) { msg += '  S' + e.stage + ' ' + e.name + ' [' + e.discipline + ']\n'; });
  }
  if (sameFamily.length > 0) {
    msg += '\nSame Family (' + ex.family + '):\n';
    sameFamily.slice(0, 8).forEach(function(e) { msg += '  S' + e.stage + ' ' + e.name + ' [' + e.pattern + ']\n'; });
  }
  if (samePattern.length === 0 && sameFamily.length === 0) msg += 'No substitutions available';
  toast(msg);
}

/* ===== BATCH 273: UNDO HISTORY VIEWER ===== */
function showUndoHistory() {
  var msg = 'Undo Stack: ' + undoStack.length + '/' + maxUndo + ' states\n';
  msg += 'Redo Stack: ' + redoStack.length + ' states\n\n';
  if (undoStack.length > 0) {
    msg += 'Recent undo states:\n';
    var recent = undoStack.slice(-5);
    recent.forEach(function(stateStr, i) {
      try {
        var state = JSON.parse(stateStr);
        msg += (undoStack.length - recent.length + i + 1) + '. ' + state.clips.length + ' clips, BPM ' + state.bpm + '\n';
      } catch(e) { msg += (i + 1) + '. [parse error]\n'; }
    });
  } else {
    msg += 'No undo states available';
  }
  toast(msg);
}

/* ===== BATCH 274: MUSCLE GROUP COVERAGE ===== */
function showMuscleGroupCoverage() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var muscleMap = {
    'Horizontal Push': ['Chest', 'Triceps', 'Shoulders'],
    'Horizontal Pull': ['Back', 'Biceps', 'Rear Delts'],
    'Downward Press': ['Chest', 'Shoulders', 'Triceps'],
    'Vertical Pull': ['Lats', 'Biceps', 'Forearms'],
    'Overhead Press': ['Shoulders', 'Triceps', 'Upper Chest'],
    'Knee-Dominant': ['Quads', 'Glutes', 'Calves'],
    'Hip-Dominant': ['Hamstrings', 'Glutes', 'Lower Back'],
    'Core': ['Abs', 'Obliques', 'Lower Back'],
    'Mobility': ['Flexibility', 'Joint Health']
  };
  var muscleHits = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var sets = parseInt(c.dataset.sets) || 3;
    var muscles = muscleMap[ex.pattern] || [];
    muscles.forEach(function(m) {
      muscleHits[m] = (muscleHits[m] || 0) + sets;
    });
  });
  var sorted = Object.keys(muscleHits).sort(function(a, b) { return muscleHits[b] - muscleHits[a]; });
  var maxHits = sorted.length > 0 ? muscleHits[sorted[0]] : 1;
  var msg = 'Muscle Group Coverage\n';
  sorted.forEach(function(m) {
    var pct = Math.round((muscleHits[m] / maxHits) * 100);
    var bar = '';
    for (var i = 0; i < Math.round(pct / 10); i++) bar += '\u2588';
    msg += m + ': ' + muscleHits[m] + ' sets ' + bar + '\n';
  });
  var missing = ['Chest','Back','Shoulders','Biceps','Triceps','Quads','Hamstrings','Glutes','Abs','Calves'].filter(function(m) { return !muscleHits[m]; });
  if (missing.length > 0) msg += '\nMissing: ' + missing.join(', ');
  toast(msg);
}

/* ===== BATCH 275: WORKOUT CALENDAR ===== */
function showWorkoutCalendar() {
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    var saved = [];
    try {
      var sw = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]');
      sw.forEach(function(w) { if (w.timestamp) saved.push({date: w.timestamp, name: w.name}); });
    } catch(e) {}
    var allDates = {};
    ratings.forEach(function(r) {
      var d = new Date(r.date).toLocaleDateString();
      allDates[d] = (allDates[d] || []);
      allDates[d].push(r.name + ' (' + r.rating + '/5)');
    });
    saved.forEach(function(s) {
      var d = new Date(s.date).toLocaleDateString();
      allDates[d] = (allDates[d] || []);
      allDates[d].push(s.name + ' [saved]');
    });
    var dates = Object.keys(allDates).sort().reverse();
    if (dates.length === 0) { toast('No workout history'); return; }
    var msg = 'Workout Calendar (last 14 days):\n\n';
    dates.slice(0, 14).forEach(function(d) {
      msg += d + ':\n';
      allDates[d].forEach(function(w) { msg += '  ' + w + '\n'; });
    });
    msg += '\nTotal: ' + dates.length + ' workout days';
    toast(msg);
  } catch(e) { toast('Error loading calendar'); }
}

/* ===== BATCH 276: CLIP CROSSFADE ===== */
function addCrossfadeBetweenClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips on active track'); return; }
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  pushUndo();
  var count = 0;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var fadeAmount = beatPx;
  for (var i = 0; i < clips.length - 1; i++) {
    if (clips[i].classList.contains('clip-locked') || clips[i + 1].classList.contains('clip-locked')) continue;
    var aR = parseInt(clips[i].style.left) + parseInt(clips[i].style.width);
    var bL = parseInt(clips[i + 1].style.left);
    var gap = bL - aR;
    if (gap > fadeAmount * 2) continue;
    if (gap > 0) {
      clips[i + 1].style.left = (bL - Math.min(gap, fadeAmount)) + 'px';
    }
    clips[i].dataset.fadeOut = String(fadeAmount);
    clips[i + 1].dataset.fadeIn = String(fadeAmount);
    if (typeof updateFadeOverlay === 'function') {
      updateFadeOverlay(clips[i]);
      updateFadeOverlay(clips[i + 1]);
    }
    count++;
  }
  updateStats(); saveSession(); sfx('click');
  toast(count + ' crossfade' + (count !== 1 ? 's' : '') + ' applied');
}

/* ===== BATCH 277: INTENSITY ZONES ===== */
function showIntensityZones() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips'); return; }
  var zones = {
    'Recovery (RPE 1-3)': {count: 0, sets: 0, color: '#22c55e'},
    'Moderate (RPE 4-6)': {count: 0, sets: 0, color: '#eab308'},
    'Hard (RPE 7-8)': {count: 0, sets: 0, color: '#f97316'},
    'Max Effort (RPE 9-10)': {count: 0, sets: 0, color: '#ef4444'}
  };
  clips.forEach(function(c) {
    var rpe = parseInt(c.dataset.rpe) || 7;
    var sets = parseInt(c.dataset.sets) || 3;
    if (rpe <= 3) { zones['Recovery (RPE 1-3)'].count++; zones['Recovery (RPE 1-3)'].sets += sets; }
    else if (rpe <= 6) { zones['Moderate (RPE 4-6)'].count++; zones['Moderate (RPE 4-6)'].sets += sets; }
    else if (rpe <= 8) { zones['Hard (RPE 7-8)'].count++; zones['Hard (RPE 7-8)'].sets += sets; }
    else { zones['Max Effort (RPE 9-10)'].count++; zones['Max Effort (RPE 9-10)'].sets += sets; }
  });
  var msg = 'Intensity Zones\n\n';
  Object.keys(zones).forEach(function(z) {
    var pct = Math.round((zones[z].count / clips.length) * 100);
    msg += z + ': ' + zones[z].count + ' clips (' + pct + '%), ' + zones[z].sets + ' sets\n';
  });
  toast(msg);
}

/* ===== BATCH 278: TRACK SWAP ===== */
function swapTracks(trackA, trackB) {
  var tcA = document.querySelector('.track-content[data-track="' + trackA + '"]');
  var tcB = document.querySelector('.track-content[data-track="' + trackB + '"]');
  if (!tcA || !tcB) { toast('Invalid tracks'); return; }
  pushUndo();
  var clipsA = Array.from(tcA.querySelectorAll('.clip'));
  var clipsB = Array.from(tcB.querySelectorAll('.clip'));
  clipsA.forEach(function(c) { tcB.appendChild(c); });
  clipsB.forEach(function(c) { tcA.appendChild(c); });
  updateStats(); saveSession(); sfx('click');
  toast('Swapped ' + trackA + ' <-> ' + trackB + ' (' + clipsA.length + '/' + clipsB.length + ' clips)');
}

/* ===== BATCH 279: EXPORT TIMELINE IMAGE ===== */
function exportTimelineImage() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
  var trackLabels = {push:'PUSH', pull:'PULL', core:'CORE', legs:'LEGS', skills:'SKILLS'};
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var ho = 100;
  var canvasW = Math.max(800, maxRight + 40);
  var trackH = 40;
  var headerH = 30;
  var canvasH = headerH + trackOrder.length * (trackH + 4) + 30;
  var canvas = document.createElement('canvas');
  canvas.width = canvasW;
  canvas.height = canvasH;
  var ctx = canvas.getContext('2d');
  ctx.fillStyle = '#050711';
  ctx.fillRect(0, 0, canvasW, canvasH);
  ctx.font = '14px Sora, system-ui, sans-serif';
  ctx.fillStyle = '#e2e8f0';
  ctx.textAlign = 'center';
  ctx.fillText((workoutName || 'Untitled') + ' | ' + bpm + ' BPM', canvasW / 2, 18);
  trackOrder.forEach(function(tid, ti) {
    var y = headerH + ti * (trackH + 4);
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, y, canvasW, trackH);
    ctx.fillStyle = familyColors[tid] + '66';
    ctx.font = '9px Sora, system-ui, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText(trackLabels[tid], 4, y + 24);
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    tc.querySelectorAll('.clip').forEach(function(c) {
      var left = parseInt(c.style.left) - ho + 60;
      var width = parseInt(c.style.width);
      var color = familyColors[tid];
      ctx.fillStyle = color + '44';
      ctx.fillRect(left, y + 2, width, trackH - 4);
      ctx.strokeStyle = color;
      ctx.lineWidth = 1;
      ctx.strokeRect(left, y + 2, width, trackH - 4);
      var ex = getExercise(c.dataset.exerciseId);
      if (ex && width > 30) {
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '8px Sora, system-ui, sans-serif';
        ctx.textAlign = 'left';
        var name = ex.name;
        if (ctx.measureText(name).width > width - 6) name = name.substring(0, Math.floor(width / 6)) + '..';
        ctx.fillText(name, left + 3, y + 14);
        ctx.fillStyle = '#94a3b8';
        ctx.font = '7px Sora, system-ui, sans-serif';
        ctx.fillText(c.dataset.sets + 'x' + c.dataset.reps, left + 3, y + 24);
      }
    });
  });
  ctx.fillStyle = '#475569';
  ctx.font = '8px Sora, system-ui, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Saturno Movement Studio', canvasW / 2, canvasH - 8);
  canvas.toBlob(function(blob) {
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
    a.download = safeName + '-timeline.png';
    a.click();
    toast('Timeline image exported');
  });
}

/* ===== BATCH 280: MOVEMENT PATTERN BALANCE ===== */
function showPatternBalance() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var patterns = {};
  var pushSets = 0; var pullSets = 0; var upperSets = 0; var lowerSets = 0;
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var sets = parseInt(c.dataset.sets) || 3;
    patterns[ex.pattern] = (patterns[ex.pattern] || 0) + sets;
    if (ex.family === 'Push') pushSets += sets;
    if (ex.family === 'Pull') pullSets += sets;
    if (ex.family === 'Push' || ex.family === 'Pull' || ex.family === 'Skills') upperSets += sets;
    if (ex.family === 'Legs') lowerSets += sets;
  });
  var msg = 'Movement Pattern Balance\n\n';
  var pushPull = pullSets > 0 ? (pushSets / pullSets).toFixed(2) : 'N/A';
  var upperLower = lowerSets > 0 ? (upperSets / lowerSets).toFixed(2) : 'N/A';
  msg += 'Push/Pull ratio: ' + pushPull + ':1 (ideal: 1.0-1.5)\n';
  msg += 'Upper/Lower ratio: ' + upperLower + ':1 (ideal: 1.0-2.0)\n\n';
  msg += 'By Pattern:\n';
  Object.keys(patterns).sort(function(a, b) { return patterns[b] - patterns[a]; }).forEach(function(p) {
    msg += '  ' + p + ': ' + patterns[p] + ' sets\n';
  });
  var totalPush = pushSets + pullSets;
  if (totalPush > 0) {
    var pushPct = Math.round((pushSets / totalPush) * 100);
    msg += '\nPush ' + pushPct + '% / Pull ' + (100 - pushPct) + '%';
  }
  toast(msg);
}

/* ===== BATCH 281: PASTE EXERCISES FROM TEXT ===== */
function pasteExercisesFromText() {
  navigator.clipboard.readText().then(function(text) {
    if (!text || !text.trim()) { toast('Clipboard empty'); return; }
    var lines = text.split('\n').filter(function(l) { return l.trim(); });
    if (lines.length === 0) { toast('No exercise names found'); return; }
    pushUndo();
    var ho = 100;
    var beatPx = Math.round((60 / bpm) * (80 / 15));
    var clipW = beatPx * 4;
    var gap = 4;
    var maxRight = ho;
    document.querySelectorAll('.clip').forEach(function(c) {
      var r = parseInt(c.style.left) + parseInt(c.style.width);
      if (r > maxRight) maxRight = r;
    });
    var xPos = maxRight + beatPx * 2;
    var count = 0;
    lines.forEach(function(line) {
      var name = line.trim().replace(/^\d+[\.\)]\s*/, '');
      var match = null;
      var nameLower = name.toLowerCase();
      EXERCISES.forEach(function(e) {
        if (e.name.toLowerCase() === nameLower) match = e;
      });
      if (!match) {
        EXERCISES.forEach(function(e) {
          if (!match && e.name.toLowerCase().indexOf(nameLower) !== -1) match = e;
        });
      }
      if (!match) {
        EXERCISES.forEach(function(e) {
          if (!match && nameLower.indexOf(e.name.toLowerCase().split(' ')[0]) !== -1) match = e;
        });
      }
      if (match) {
        var familyTrack = {Push:'push', Pull:'pull', Core:'core', Legs:'legs', Skills:'skills', Flow:'skills'};
        var tid = familyTrack[match.family] || 'push';
        var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
        if (tc) {
          var clip = createClipElement(match, xPos, clipW, {});
          tc.appendChild(clip);
          xPos += clipW + gap;
          count++;
        }
      }
    });
    updateStats(); saveSession(); sfx('drop');
    toast(count + '/' + lines.length + ' exercises added from clipboard');
  }).catch(function() { toast('Cannot read clipboard'); });
}

/* ===== BATCH 282: WORKOUT STREAK TRACKER ===== */
function showWorkoutStreak() {
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    if (ratings.length === 0) { toast('No workout history for streak'); return; }
    var days = {};
    ratings.forEach(function(r) {
      var d = new Date(r.date).toISOString().split('T')[0];
      days[d] = true;
    });
    var dayList = Object.keys(days).sort().reverse();
    var streak = 0;
    var today = new Date();
    for (var i = 0; i < 365; i++) {
      var checkDate = new Date(today);
      checkDate.setDate(checkDate.getDate() - i);
      var dateStr = checkDate.toISOString().split('T')[0];
      if (days[dateStr]) {
        streak++;
      } else if (i > 0) {
        break;
      }
    }
    var totalDays = dayList.length;
    var firstDate = dayList.length > 0 ? dayList[dayList.length - 1] : 'N/A';
    var msg = 'Workout Streak\n\n';
    msg += 'Current streak: ' + streak + ' day' + (streak !== 1 ? 's' : '') + '\n';
    msg += 'Total workout days: ' + totalDays + '\n';
    msg += 'First workout: ' + firstDate + '\n';
    msg += 'Total workouts: ' + ratings.length + '\n';
    var avgRating = 0;
    ratings.forEach(function(r) { avgRating += r.rating; });
    avgRating = (avgRating / ratings.length).toFixed(1);
    msg += 'Avg rating: ' + avgRating + '/5';
    toast(msg);
  } catch(e) { toast('Error loading streak data'); }
}

/* ===== BATCH 283: COMPARE SAVED WORKOUTS ===== */
function compareSavedWorkouts() {
  try {
    var saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]');
    if (saved.length < 1) { toast('Need at least 1 saved workout to compare'); return; }
    var promptText = 'Compare current with:\n';
    saved.forEach(function(w, i) { promptText += (i + 1) + '. ' + w.name + '\n'; });
    showInlinePrompt(promptText, function(val) {
      var idx = parseInt(val) - 1;
      if (isNaN(idx) || idx < 0 || idx >= saved.length) { toast('Invalid selection'); return; }
      var other = JSON.parse(saved[idx].state);
      var currentEx = {};
      document.querySelectorAll('.clip').forEach(function(c) {
        var ex = getExercise(c.dataset.exerciseId);
        if (ex) currentEx[ex.name] = (currentEx[ex.name] || 0) + 1;
      });
      var otherEx = {};
      other.clips.forEach(function(c) {
        var ex = getExercise(c.exerciseId);
        if (ex) otherEx[ex.name] = (otherEx[ex.name] || 0) + 1;
      });
      var shared = []; var onlyCurrent = []; var onlyOther = [];
      Object.keys(currentEx).forEach(function(name) {
        if (otherEx[name]) shared.push(name);
        else onlyCurrent.push(name);
      });
      Object.keys(otherEx).forEach(function(name) {
        if (!currentEx[name]) onlyOther.push(name);
      });
      var msg = 'Comparison: Current vs ' + saved[idx].name + '\n\n';
      msg += 'Shared: ' + shared.length + ' exercises\n';
      if (shared.length) msg += '  ' + shared.join(', ') + '\n';
      msg += 'Only in current: ' + onlyCurrent.length + '\n';
      if (onlyCurrent.length) msg += '  ' + onlyCurrent.join(', ') + '\n';
      msg += 'Only in ' + saved[idx].name + ': ' + onlyOther.length + '\n';
      if (onlyOther.length) msg += '  ' + onlyOther.join(', ') + '\n';
      msg += '\nCurrent: ' + document.querySelectorAll('.clip').length + ' clips';
      msg += '\n' + saved[idx].name + ': ' + other.clips.length + ' clips';
      toast(msg);
    });
  } catch(e) { toast('Error loading workouts'); }
}

/* ===== BATCH 284: EXERCISE HISTORY ===== */
function showExerciseHistory() {
  try {
    var saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]');
    var exerciseCounts = {};
    saved.forEach(function(w) {
      try {
        var state = JSON.parse(w.state);
        state.clips.forEach(function(c) {
          var ex = getExercise(c.exerciseId);
          if (ex) exerciseCounts[ex.name] = (exerciseCounts[ex.name] || 0) + 1;
        });
      } catch(e) {}
    });
    document.querySelectorAll('.clip').forEach(function(c) {
      var ex = getExercise(c.dataset.exerciseId);
      if (ex) exerciseCounts[ex.name] = (exerciseCounts[ex.name] || 0) + 1;
    });
    var sorted = Object.keys(exerciseCounts).sort(function(a, b) { return exerciseCounts[b] - exerciseCounts[a]; });
    if (sorted.length === 0) { toast('No exercise history'); return; }
    var msg = 'Most Used Exercises (all workouts)\n\n';
    sorted.slice(0, 15).forEach(function(name, i) {
      msg += (i + 1) + '. ' + name + ': ' + exerciseCounts[name] + ' times\n';
    });
    msg += '\nTotal unique: ' + sorted.length + ' exercises';
    toast(msg);
  } catch(e) { toast('Error loading history'); }
}

/* ===== BATCH 285: SMART AUTO-ARRANGE ===== */
function smartAutoArrange() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips'); return; }
  pushUndo();
  var ho = 100;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 4;
  var gap = 4;
  var byFamily = {};
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!byFamily[tid]) byFamily[tid] = [];
    byFamily[tid].push(c);
  });
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var orderedFamilies = trackOrder.filter(function(t) { return byFamily[t] && byFamily[t].length > 0; });
  var maxClips = 0;
  orderedFamilies.forEach(function(tid) {
    if (byFamily[tid].length > maxClips) maxClips = byFamily[tid].length;
  });
  var count = 0;
  for (var round = 0; round < maxClips; round++) {
    orderedFamilies.forEach(function(tid) {
      if (round >= byFamily[tid].length) return;
      var c = byFamily[tid][round];
      if (c.classList.contains('clip-locked')) return;
      var xPos = ho + round * (clipW + gap + beatPx) + (orderedFamilies.indexOf(tid) * 2);
      c.style.left = xPos + 'px';
      c.style.width = clipW + 'px';
      count++;
    });
  }
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips auto-arranged by family rotation');
}

/* ===== BATCH 286: GHOST/FOCUS MODE FOR CLIPS ===== */
var _ghostMode = false;
function toggleGhostMode() {
  _ghostMode = !_ghostMode;
  document.querySelectorAll('.clip').forEach(function(c) {
    if (_ghostMode) {
      if (c.classList.contains('selected')) {
        c.style.opacity = '1';
        c.style.filter = '';
      } else {
        c.style.opacity = '0.2';
        c.style.filter = 'grayscale(0.8)';
      }
    } else {
      c.style.opacity = '';
      c.style.filter = '';
    }
  });
  toast('Ghost mode: ' + (_ghostMode ? 'ON (unselected dimmed)' : 'OFF'));
}

/* ===== BATCH 287: DETAILED WORKOUT ANALYSIS ===== */
function detailedWorkoutAnalysis() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var totalSets = 0; var totalReps = 0; var totalTUT = 0;
  var rpeSum = 0; var tempoSum = 0; var restSum = 0;
  var exercises = {}; var families = {}; var patterns = {}; var disciplines = {}; var stages = {1:0, 2:0, 3:0};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    var rpe = parseInt(c.dataset.rpe) || 7;
    totalSets += sets; totalReps += sets * reps;
    totalTUT += sets * reps * tempo;
    rpeSum += rpe; tempoSum += tempo; restSum += rest;
    if (ex) {
      exercises[ex.name] = true;
      families[ex.family] = (families[ex.family] || 0) + sets;
      patterns[ex.pattern] = (patterns[ex.pattern] || 0) + 1;
      disciplines[ex.discipline] = (disciplines[ex.discipline] || 0) + 1;
      if (stages[ex.stage] !== undefined) stages[ex.stage]++;
    }
  });
  var msg = 'Detailed Workout Analysis\n';
  msg += '========================\n';
  msg += 'Clips: ' + clips.length + ' | Exercises: ' + Object.keys(exercises).length + '\n';
  msg += 'Sets: ' + totalSets + ' | Reps: ' + totalReps + '\n';
  msg += 'TUT: ' + Math.round(totalTUT) + 's (' + (totalTUT / 60).toFixed(1) + 'min)\n';
  msg += 'Avg RPE: ' + (rpeSum / clips.length).toFixed(1) + '\n';
  msg += 'Avg Tempo: ' + (tempoSum / clips.length).toFixed(1) + 's\n';
  msg += 'Avg Rest: ' + (restSum / clips.length).toFixed(0) + 's\n';
  msg += '\nStages: S1=' + stages[1] + ' S2=' + stages[2] + ' S3=' + stages[3] + '\n';
  msg += 'Patterns: ' + Object.keys(patterns).length + ' | Disciplines: ' + Object.keys(disciplines).length + '\n';
  msg += '\nFamilies:\n';
  Object.keys(families).sort(function(a, b) { return families[b] - families[a]; }).forEach(function(f) {
    msg += '  ' + f + ': ' + families[f] + ' sets\n';
  });
  toast(msg);
}

/* ===== BATCH 288: EXERCISE ATLAS ===== */
function showExerciseAtlas() {
  var usedExercises = {};
  document.querySelectorAll('.clip').forEach(function(c) {
    usedExercises[c.dataset.exerciseId] = (usedExercises[c.dataset.exerciseId] || 0) + 1;
  });
  var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Exercise Atlas</title>';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#050711;color:#e2e8f0;font-family:Sora,system-ui,sans-serif;padding:20px}';
  html += 'h1{font-size:18px;margin-bottom:16px;text-align:center}';
  html += '.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}';
  html += '.card{background:#0f172a;border:1px solid #1e293b;border-radius:6px;padding:10px;font-size:10px;transition:border-color 0.2s}';
  html += '.card:hover{border-color:#334155}.card-name{font-size:12px;font-weight:600;margin-bottom:4px}';
  html += '.card-meta{color:#64748b;font-size:9px;margin-bottom:4px}';
  html += '.card-badge{display:inline-block;padding:1px 6px;border-radius:3px;font-size:8px;font-weight:600;margin-right:3px}';
  html += '.used{border-left:3px solid #22d3ee}</style></head><body>';
  html += '<h1>Exercise Atlas (' + EXERCISES.length + ' exercises)</h1>';
  html += '<div class="grid">';
  var familyColors = {Push:'#ef4444', Pull:'#3b82f6', Core:'#eab308', Legs:'#22c55e', Skills:'#a855f7', Flow:'#ec4899'};
  EXERCISES.forEach(function(ex) {
    var used = usedExercises[ex.id] || 0;
    var fc = familyColors[ex.family] || '#64748b';
    html += '<div class="card' + (used > 0 ? ' used' : '') + '">';
    html += '<div class="card-name">' + ex.name + '</div>';
    html += '<div class="card-meta">' + ex.pattern + '</div>';
    html += '<span class="card-badge" style="background:' + fc + '22;color:' + fc + '">' + ex.family + '</span>';
    html += '<span class="card-badge" style="background:#22d3ee22;color:#22d3ee">S' + ex.stage + '</span>';
    html += '<span class="card-badge" style="background:#a855f722;color:#a855f7">' + ex.discipline + '</span>';
    if (used > 0) html += '<span class="card-badge" style="background:#22c55e22;color:#22c55e">x' + used + '</span>';
    html += '</div>';
  });
  html += '</div></body></html>';
  var blob = new Blob([html], {type: 'text/html'});
  window.open(URL.createObjectURL(blob), '_blank');
  toast('Exercise Atlas opened');
}

/* ===== BATCH 289-291: MOBILE RESPONSIVE SYSTEM ===== */

/* --- Batch 289: Mobile drawer system --- */
var _mobileLibraryOpen = false;
var _mobileInspectorOpen = false;
var _mobileNavOpen = false;

function isMobileView() {
  return window.innerWidth <= 640;
}

function toggleMobileNav() {
  var nav = document.getElementById('header-nav');
  if (!nav) return;
  _mobileNavOpen = !_mobileNavOpen;
  if (_mobileNavOpen) {
    nav.classList.add('mobile-open');
    showMobileOverlay();
    var btn = document.getElementById('mpb-more');
    if (btn) btn.classList.add('active');
  } else {
    nav.classList.remove('mobile-open');
    hideMobileOverlay();
    var btn = document.getElementById('mpb-more');
    if (btn) btn.classList.remove('active');
  }
}

function toggleMobileLibrary() {
  var panel = document.querySelector('.panel-left');
  if (!panel) return;
  if (_mobileInspectorOpen) closeMobileInspector();
  if (_mobileNavOpen) closeMobileNavMenu();
  _mobileLibraryOpen = !_mobileLibraryOpen;
  if (_mobileLibraryOpen) {
    panel.classList.add('drawer-open');
    showMobileOverlay();
    var btn = document.getElementById('mpb-library');
    if (btn) btn.classList.add('active');
  } else {
    panel.classList.remove('drawer-open');
    hideMobileOverlay();
    var btn = document.getElementById('mpb-library');
    if (btn) btn.classList.remove('active');
  }
}

function toggleMobileInspector() {
  var panel = document.querySelector('.panel-right');
  if (!panel) return;
  if (_mobileLibraryOpen) closeMobileLibrary();
  if (_mobileNavOpen) closeMobileNavMenu();
  _mobileInspectorOpen = !_mobileInspectorOpen;
  if (_mobileInspectorOpen) {
    panel.classList.add('drawer-open');
    showMobileOverlay();
    var btn = document.getElementById('mpb-mixer');
    if (btn) btn.classList.add('active');
  } else {
    panel.classList.remove('drawer-open');
    hideMobileOverlay();
    var btn = document.getElementById('mpb-mixer');
    if (btn) btn.classList.remove('active');
  }
}

function closeMobileLibrary() {
  var panel = document.querySelector('.panel-left');
  if (panel) panel.classList.remove('drawer-open');
  _mobileLibraryOpen = false;
  var btn = document.getElementById('mpb-library');
  if (btn) btn.classList.remove('active');
}

function closeMobileInspector() {
  var panel = document.querySelector('.panel-right');
  if (panel) panel.classList.remove('drawer-open');
  _mobileInspectorOpen = false;
  var btn = document.getElementById('mpb-mixer');
  if (btn) btn.classList.remove('active');
}

function closeMobileNavMenu() {
  var nav = document.getElementById('header-nav');
  if (nav) nav.classList.remove('mobile-open');
  _mobileNavOpen = false;
  var btn = document.getElementById('mpb-more');
  if (btn) btn.classList.remove('active');
}

function closeMobileDrawers() {
  closeMobileLibrary();
  closeMobileInspector();
  closeMobileNavMenu();
  hideMobileOverlay();
}

function showMobileOverlay() {
  var ov = document.getElementById('mobile-overlay');
  if (ov) { ov.style.display = 'block'; requestAnimationFrame(function() { ov.classList.add('visible'); }); }
}

function hideMobileOverlay() {
  var ov = document.getElementById('mobile-overlay');
  if (ov) { ov.classList.remove('visible'); setTimeout(function() { ov.style.display = 'none'; }, 250); }
}

/* Update mobile play button state */
function updateMobilePlayBtn() {
  var icon = document.getElementById('mpb-play-icon');
  var btn = document.getElementById('mpb-play');
  if (!icon || !btn) return;
  if (typeof isPlaying !== 'undefined' && isPlaying) {
    icon.innerHTML = '&#9646;&#9646;';
    btn.classList.add('active');
  } else {
    icon.innerHTML = '&#9654;';
    btn.classList.remove('active');
  }
}

/* --- Batch 290: Touch drag-drop for timeline --- */
var _touchDragData = null;

function initTouchDragDrop() {
  /* Library items — touch to add to timeline */
  document.addEventListener('touchstart', function(e) {
    if (!isMobileView()) return;
    var item = e.target.closest('.movement-item');
    if (!item) return;
    var exName = item.getAttribute('data-exercise');
    if (!exName) return;
    _touchDragData = { exercise: exName, startX: e.touches[0].clientX, startY: e.touches[0].clientY, moved: false };
  }, { passive: true });

  document.addEventListener('touchmove', function(e) {
    if (!_touchDragData) return;
    var dx = Math.abs(e.touches[0].clientX - _touchDragData.startX);
    var dy = Math.abs(e.touches[0].clientY - _touchDragData.startY);
    if (dx > 10 || dy > 10) _touchDragData.moved = true;
  }, { passive: true });

  document.addEventListener('touchend', function(e) {
    if (!_touchDragData) return;
    var data = _touchDragData;
    _touchDragData = null;
    /* If user tapped (not dragged), add exercise at playhead on active track */
    if (!data.moved && data.exercise) {
      if (typeof quickAddExercise === 'function') {
        quickAddExercise(data.exercise);
        if (isMobileView()) closeMobileDrawers();
      }
    }
  }, { passive: true });

  /* Timeline clips — touch-move for repositioning */
  var _clipTouch = null;
  var timelineTracks = document.getElementById('timeline-tracks');
  if (!timelineTracks) return;

  timelineTracks.addEventListener('touchstart', function(e) {
    if (!isMobileView()) return;
    var clip = e.target.closest('.clip');
    if (!clip || clip.classList.contains('clip-locked')) return;
    _clipTouch = {
      clip: clip,
      startX: e.touches[0].clientX,
      startY: e.touches[0].clientY,
      origLeft: parseFloat(clip.style.left) || 0,
      moved: false
    };
    clip.style.zIndex = '20';
    clip.style.opacity = '0.85';
  }, { passive: true });

  timelineTracks.addEventListener('touchmove', function(e) {
    if (!_clipTouch) return;
    var dx = e.touches[0].clientX - _clipTouch.startX;
    var dy = Math.abs(e.touches[0].clientY - _clipTouch.startY);
    if (Math.abs(dx) > 5 || dy > 5) _clipTouch.moved = true;
    if (_clipTouch.moved) {
      _clipTouch.clip.style.left = (_clipTouch.origLeft + dx) + 'px';
      e.preventDefault();
    }
  }, { passive: false });

  timelineTracks.addEventListener('touchend', function(e) {
    if (!_clipTouch) return;
    var clip = _clipTouch.clip;
    clip.style.zIndex = '';
    clip.style.opacity = '';
    if (_clipTouch.moved) {
      /* Snap to grid if enabled */
      var left = parseFloat(clip.style.left) || 0;
      if (left < 0) left = 0;
      if (typeof getSnapSize === 'function' && typeof settings !== 'undefined' && settings.snap) {
        var snap = getSnapSize();
        left = Math.round(left / snap) * snap;
      }
      clip.style.left = left + 'px';
      if (typeof captureUndo === 'function') captureUndo();
      if (typeof updateStats === 'function') updateStats();
    } else {
      /* Tap to select */
      if (clip.classList.contains('selected')) {
        clip.classList.remove('selected');
      } else {
        if (!e.shiftKey) document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
        clip.classList.add('selected');
      }
      if (typeof inspectClip === 'function') inspectClip(clip);
    }
    _clipTouch = null;
  }, { passive: true });
}

/* --- Batch 291: Swipe gestures + mobile play sync --- */
function initMobileSwipeGestures() {
  /* Swipe right on timeline to open library */
  var container = document.getElementById('timeline-container');
  if (!container) return;
  var _swipe = null;

  container.addEventListener('touchstart', function(e) {
    if (!isMobileView()) return;
    if (e.touches.length !== 1) return;
    var t = e.touches[0];
    /* Only trigger swipe from left edge (first 30px) */
    if (t.clientX > 30 && !_mobileLibraryOpen) return;
    _swipe = { startX: t.clientX, startY: t.clientY };
  }, { passive: true });

  container.addEventListener('touchmove', function(e) {
    if (!_swipe) return;
    var dx = e.touches[0].clientX - _swipe.startX;
    var dy = Math.abs(e.touches[0].clientY - _swipe.startY);
    /* Horizontal swipe detection */
    if (Math.abs(dx) > 50 && dy < 40) {
      if (dx > 0 && !_mobileLibraryOpen) {
        toggleMobileLibrary();
      }
      _swipe = null;
    }
  }, { passive: true });

  container.addEventListener('touchend', function() { _swipe = null; }, { passive: true });
}

/* Wire mobile play button into togglePlay */
(function() {
  var origTogglePlay = typeof togglePlay === 'function' ? togglePlay : null;
  if (!origTogglePlay) return;
  /* Patch after DOMContentLoaded to ensure togglePlay is defined */
  var _patchAttempted = false;
  function patchTogglePlay() {
    if (_patchAttempted) return;
    _patchAttempted = true;
    var _origPlay = window.togglePlay;
    window.togglePlay = function() {
      _origPlay.apply(this, arguments);
      updateMobilePlayBtn();
    };
  }
  if (document.readyState === 'complete') {
    setTimeout(patchTogglePlay, 100);
  } else {
    window.addEventListener('load', function() { setTimeout(patchTogglePlay, 100); });
  }
})();

/* Initialize mobile features on DOM ready */
(function() {
  function initMobile() {
    initTouchDragDrop();
    initMobileSwipeGestures();
    /* Handle resize — clean up drawer states when switching to desktop */
    window.addEventListener('resize', function() {
      if (!isMobileView()) {
        closeMobileDrawers();
        var panel = document.querySelector('.panel-left');
        if (panel) panel.classList.remove('drawer-open');
        var right = document.querySelector('.panel-right');
        if (right) right.classList.remove('drawer-open');
        var nav = document.getElementById('header-nav');
        if (nav) nav.classList.remove('mobile-open');
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobile);
  } else {
    initMobile();
  }
})();

/* --- Batch 292: Landscape detection + haptic feedback --- */
var _landscapeHintDismissed = false;

function checkLandscapeHint() {
  if (!isMobileView()) return;
  try { _landscapeHintDismissed = localStorage.getItem('sms_landscape_dismissed') === '1'; } catch(e) {}
  if (_landscapeHintDismissed) return;
  var isPortrait = window.innerHeight > window.innerWidth;
  var hint = document.getElementById('landscape-hint');
  if (hint && isPortrait) {
    hint.classList.add('visible');
  }
}

function dismissLandscapeHint() {
  var hint = document.getElementById('landscape-hint');
  if (hint) hint.classList.remove('visible');
  _landscapeHintDismissed = true;
  try { localStorage.setItem('sms_landscape_dismissed', '1'); } catch(e) {}
}

/* Haptic feedback for touch interactions (if supported) */
function haptic(type) {
  if (!navigator.vibrate) return;
  if (type === 'light') navigator.vibrate(10);
  else if (type === 'medium') navigator.vibrate(25);
  else if (type === 'heavy') navigator.vibrate(50);
  else navigator.vibrate(10);
}

/* Wire haptic into key touch interactions */
(function() {
  document.addEventListener('click', function(e) {
    if (!isMobileView()) return;
    if (e.target.closest('.transport-btn') || e.target.closest('.mobile-panel-btn') || e.target.closest('.nav-btn')) {
      haptic('light');
    }
    if (e.target.closest('.clip')) {
      haptic('medium');
    }
  }, { passive: true });
})();

/* Show landscape hint on first mobile visit */
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(checkLandscapeHint, 1000); });
  } else {
    setTimeout(checkLandscapeHint, 1000);
  }
  /* Also listen for orientation changes */
  window.addEventListener('orientationchange', function() {
    var hint = document.getElementById('landscape-hint');
    if (hint && hint.classList.contains('visible')) {
      /* Auto-dismiss if user rotated to landscape */
      var isLandscape = window.innerWidth > window.innerHeight;
      if (isLandscape) dismissLandscapeHint();
    }
  });
})();

/* --- Batch 293: Swipe-to-delete clips on mobile --- */
function initSwipeToDelete() {
  var timelineTracks = document.getElementById('timeline-tracks');
  if (!timelineTracks) return;
  var _swipeDel = null;

  timelineTracks.addEventListener('touchstart', function(e) {
    if (!isMobileView()) return;
    var clip = e.target.closest('.clip');
    if (!clip || clip.classList.contains('clip-locked')) return;
    /* Only activate on horizontal swipe, not on already-moving clips */
    _swipeDel = {
      clip: clip,
      startX: e.touches[0].clientX,
      startY: e.touches[0].clientY,
      origTransform: clip.style.transform || '',
      triggered: false
    };
  }, { passive: true });

  timelineTracks.addEventListener('touchmove', function(e) {
    if (!_swipeDel) return;
    var dx = e.touches[0].clientX - _swipeDel.startX;
    var dy = Math.abs(e.touches[0].clientY - _swipeDel.startY);
    /* Only swipe-to-delete for left swipes */
    if (dx < -20 && dy < 30) {
      var offset = Math.max(dx, -80);
      _swipeDel.clip.style.transform = 'translateX(' + offset + 'px)';
      if (dx < -60) {
        _swipeDel.triggered = true;
        _swipeDel.clip.style.opacity = '0.5';
      } else {
        _swipeDel.triggered = false;
        _swipeDel.clip.style.opacity = '1';
      }
    }
  }, { passive: true });

  timelineTracks.addEventListener('touchend', function(e) {
    if (!_swipeDel) return;
    var data = _swipeDel;
    _swipeDel = null;
    if (data.triggered) {
      /* Delete the clip */
      haptic('heavy');
      if (typeof captureUndo === 'function') captureUndo();
      data.clip.style.transform = 'translateX(-100%)';
      data.clip.style.opacity = '0';
      data.clip.style.transition = 'transform 0.2s, opacity 0.2s';
      setTimeout(function() {
        if (data.clip.parentNode) data.clip.parentNode.removeChild(data.clip);
        if (typeof updateStats === 'function') updateStats();
      }, 200);
      toast('Clip deleted');
    } else {
      data.clip.style.transform = data.origTransform;
      data.clip.style.opacity = '1';
    }
  }, { passive: true });
}

/* Init swipe-to-delete */
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSwipeToDelete);
  } else {
    initSwipeToDelete();
  }
})();

/* --- Batch 294: Double-tap timeline to add exercise + mobile quick actions --- */
function initDoubleTapAdd() {
  var container = document.getElementById('timeline-container');
  if (!container) return;
  var _lastTap = 0;
  var _lastTapX = 0;
  var _lastTapY = 0;

  container.addEventListener('touchend', function(e) {
    if (!isMobileView()) return;
    /* Ignore if tapped on a clip */
    if (e.target.closest('.clip')) return;
    var now = Date.now();
    var touch = e.changedTouches[0];
    var dx = Math.abs(touch.clientX - _lastTapX);
    var dy = Math.abs(touch.clientY - _lastTapY);
    if (now - _lastTap < 300 && dx < 30 && dy < 30) {
      /* Double tap detected — open command palette for quick add */
      haptic('medium');
      if (typeof toggleCommandPalette === 'function') {
        toggleCommandPalette();
      }
      _lastTap = 0;
    } else {
      _lastTap = now;
      _lastTapX = touch.clientX;
      _lastTapY = touch.clientY;
    }
  }, { passive: true });
}

/* Long press on clip for context menu on mobile */
function initLongPressContext() {
  var timelineTracks = document.getElementById('timeline-tracks');
  if (!timelineTracks) return;
  var _longPress = null;

  timelineTracks.addEventListener('touchstart', function(e) {
    if (!isMobileView()) return;
    var clip = e.target.closest('.clip');
    if (!clip) return;
    _longPress = setTimeout(function() {
      haptic('heavy');
      /* Select the clip first */
      document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
      clip.classList.add('selected');
      if (typeof inspectClip === 'function') inspectClip(clip);
      /* Open context menu at touch position */
      if (typeof showContextMenu === 'function') {
        var touch = e.touches[0];
        var fakeEvent = { preventDefault: function(){}, clientX: touch.clientX, clientY: touch.clientY };
        showContextMenu(fakeEvent, clip);
      }
      _longPress = null;
    }, 500);
  }, { passive: true });

  timelineTracks.addEventListener('touchmove', function() {
    if (_longPress) { clearTimeout(_longPress); _longPress = null; }
  }, { passive: true });

  timelineTracks.addEventListener('touchend', function() {
    if (_longPress) { clearTimeout(_longPress); _longPress = null; }
  }, { passive: true });
}

/* Init all Batch 294 features */
(function() {
  function initBatch294() {
    initDoubleTapAdd();
    initLongPressContext();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBatch294);
  } else {
    initBatch294();
  }
})();

/* ===== BATCH 295: CINEMATIC WORKOUT INTRO ===== */
function showWorkoutIntro(callback) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { if (callback) callback(); return; }
  /* Gather workout stats for the intro */
  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Untitled';
  var bpm = document.getElementById('bpm-input') ? document.getElementById('bpm-input').value : '120';
  var mode = document.getElementById('bpm-mode') ? document.getElementById('bpm-mode').textContent : 'Standard';
  var clipCount = clips.length;
  var families = {};
  clips.forEach(function(c) {
    var fam = c.getAttribute('data-family') || 'Unknown';
    families[fam] = (families[fam] || 0) + 1;
  });
  var dominantFamily = '';
  var maxCount = 0;
  for (var f in families) { if (families[f] > maxCount) { maxCount = families[f]; dominantFamily = f; } }

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:999;background:#050711;display:flex;align-items:center;justify-content:center;flex-direction:column;opacity:0;transition:opacity 0.5s';

  var inner = '<div style="text-align:center;opacity:0;transform:translateY(20px);transition:opacity 0.8s 0.3s,transform 0.8s 0.3s">';
  inner += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.3em;color:var(--accent-cyan);margin-bottom:16px;font-weight:600">Saturno Movement Studio</div>';
  inner += '<div style="font-size:28px;font-weight:800;color:#fff;margin-bottom:8px;letter-spacing:-0.02em">' + workoutName + '</div>';
  inner += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:24px">' + clipCount + ' exercises | ' + bpm + ' BPM | ' + mode + '</div>';
  inner += '<div style="display:flex;gap:12px;justify-content:center;margin-bottom:24px">';
  for (var fam in families) {
    var colors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6',Flow:'#ec4899'};
    var col = colors[fam] || '#06b6d4';
    inner += '<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:' + col + '">' + families[fam] + '</div><div style="font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:' + col + ';opacity:0.7">' + fam + '</div></div>';
  }
  inner += '</div>';
  inner += '<div style="width:120px;height:2px;background:var(--border);margin:0 auto;border-radius:1px;overflow:hidden"><div style="width:0%;height:100%;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-blue));transition:width 2s linear;border-radius:1px" id="intro-progress"></div></div>';
  inner += '</div>';
  overlay.innerHTML = inner;
  document.body.appendChild(overlay);

  requestAnimationFrame(function() {
    overlay.style.opacity = '1';
    var content = overlay.querySelector('div > div');
    if (content) { content.style.opacity = '1'; content.style.transform = 'translateY(0)'; }
    var bar = document.getElementById('intro-progress');
    if (bar) setTimeout(function() { bar.style.width = '100%'; }, 100);
  });

  setTimeout(function() {
    overlay.style.opacity = '0';
    setTimeout(function() {
      if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
      if (callback) callback();
    }, 500);
  }, 2500);
}

/* Wire intro into workout timer */
var _origStartWorkoutTimer = typeof startWorkoutTimer === 'function' ? startWorkoutTimer : null;
(function() {
  function patchTimer() {
    if (!window.startWorkoutTimer) return;
    var orig = window.startWorkoutTimer;
    window.startWorkoutTimer = function() {
      showWorkoutIntro(function() { orig(); });
    };
  }
  if (document.readyState === 'complete') setTimeout(patchTimer, 200);
  else window.addEventListener('load', function() { setTimeout(patchTimer, 200); });
})();

/* ===== BATCH 296: ACHIEVEMENT SYSTEM ===== */
var ACHIEVEMENTS = [
  {id:'first_workout',name:'First Composition',desc:'Save your first workout',icon:'\u2605',check:function(){return getSavedWorkoutCount()>=1;}},
  {id:'composer_5',name:'Prolific Composer',desc:'Save 5 workouts',icon:'\u2605\u2605',check:function(){return getSavedWorkoutCount()>=5;}},
  {id:'full_spectrum',name:'Full Spectrum',desc:'Use all 5 movement families in one workout',icon:'\u2606',check:function(){return getActiveFamilyCount()>=5;}},
  {id:'speed_demon',name:'Speed Demon',desc:'Set BPM to 160+',icon:'\u26A1',check:function(){var b=document.getElementById('bpm-input');return b&&parseInt(b.value)>=160;}},
  {id:'monk',name:'Monk Mode',desc:'Use BPM under 70',icon:'\u2638',check:function(){var b=document.getElementById('bpm-input');return b&&parseInt(b.value)<70;}},
  {id:'mega_session',name:'Marathon Session',desc:'Spend 30+ minutes in one session',icon:'\u23F0',check:function(){return getSessionMinutes()>=30;}},
  {id:'clip_master',name:'Clip Master',desc:'Have 20+ clips in one workout',icon:'\u2630',check:function(){return document.querySelectorAll('.clip').length>=20;}},
  {id:'superset_king',name:'Superset King',desc:'Create 3+ supersets',icon:'\u26D3',check:function(){var ss=document.getElementById('footer-supersets');return ss&&parseInt(ss.textContent)>=3;}},
  {id:'rpe_warrior',name:'RPE Warrior',desc:'Have a clip with RPE 10',icon:'\u2694',check:function(){var clips=document.querySelectorAll('.clip');for(var i=0;i<clips.length;i++){if(parseInt(clips[i].getAttribute('data-rpe'))>=10)return true;}return false;}},
  {id:'rated_10',name:'Critic',desc:'Rate 10 workouts',icon:'\u272A',check:function(){try{var r=JSON.parse(localStorage.getItem('sms_ratings')||'[]');return r.length>=10;}catch(e){return false;}}}
];

function getSavedWorkoutCount() {
  try { var s = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); return s.length; } catch(e) { return 0; }
}

function getActiveFamilyCount() {
  var families = {};
  document.querySelectorAll('.clip').forEach(function(c) {
    var f = c.getAttribute('data-family');
    if (f) families[f] = true;
  });
  return Object.keys(families).length;
}

function getSessionMinutes() {
  var el = document.getElementById('session-timer');
  if (!el) return 0;
  var text = el.textContent || '';
  var parts = text.split(':');
  if (parts.length === 2) return parseInt(parts[0]) || 0;
  return 0;
}

function getUnlockedAchievements() {
  try { return JSON.parse(localStorage.getItem('sms_achievements') || '[]'); } catch(e) { return []; }
}

function saveAchievement(id) {
  try {
    var unlocked = getUnlockedAchievements();
    if (unlocked.indexOf(id) === -1) {
      unlocked.push(id);
      localStorage.setItem('sms_achievements', JSON.stringify(unlocked));
    }
  } catch(e) {}
}

function checkAchievements() {
  var unlocked = getUnlockedAchievements();
  ACHIEVEMENTS.forEach(function(a) {
    if (unlocked.indexOf(a.id) === -1 && a.check()) {
      saveAchievement(a.id);
      showAchievementToast(a);
    }
  });
}

function showAchievementToast(achievement) {
  haptic('heavy');
  var el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-20px);z-index:600;background:linear-gradient(135deg,rgba(6,182,212,0.15),rgba(59,130,246,0.15));border:1px solid rgba(6,182,212,0.3);padding:12px 20px;border-radius:8px;text-align:center;opacity:0;transition:opacity 0.4s,transform 0.4s;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);pointer-events:none;min-width:200px';
  el.innerHTML = '<div style="font-size:20px;margin-bottom:4px">' + achievement.icon + '</div><div style="font-size:10px;font-weight:700;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:2px">Achievement Unlocked</div><div style="font-size:12px;font-weight:600;color:#fff">' + achievement.name + '</div><div style="font-size:9px;color:var(--text-secondary);margin-top:2px">' + achievement.desc + '</div>';
  document.body.appendChild(el);
  requestAnimationFrame(function() {
    el.style.opacity = '1';
    el.style.transform = 'translateX(-50%) translateY(0)';
  });
  setTimeout(function() {
    el.style.opacity = '0';
    el.style.transform = 'translateX(-50%) translateY(-20px)';
    setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 400);
  }, 3500);
}

function showAllAchievements() {
  var unlocked = getUnlockedAchievements();
  var html = '<div style="max-width:400px;margin:0 auto;padding:20px">';
  html += '<div style="text-align:center;margin-bottom:20px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Achievements</div><div style="font-size:24px;font-weight:700;color:#fff">' + unlocked.length + ' / ' + ACHIEVEMENTS.length + '</div></div>';
  ACHIEVEMENTS.forEach(function(a) {
    var isUnlocked = unlocked.indexOf(a.id) !== -1;
    html += '<div style="display:flex;gap:12px;align-items:center;padding:10px;margin-bottom:4px;border-radius:6px;background:' + (isUnlocked ? 'rgba(6,182,212,0.06)' : 'rgba(255,255,255,0.02)') + ';border:1px solid ' + (isUnlocked ? 'rgba(6,182,212,0.15)' : 'rgba(255,255,255,0.04)') + '">';
    html += '<div style="font-size:20px;opacity:' + (isUnlocked ? '1' : '0.2') + ';min-width:28px;text-align:center">' + a.icon + '</div>';
    html += '<div><div style="font-size:11px;font-weight:600;color:' + (isUnlocked ? '#fff' : 'var(--micro)') + '">' + a.name + '</div>';
    html += '<div style="font-size:9px;color:' + (isUnlocked ? 'var(--text-secondary)' : 'var(--micro)') + '">' + a.desc + '</div></div>';
    if (isUnlocked) html += '<div style="margin-left:auto;font-size:8px;color:var(--accent-cyan)">UNLOCKED</div>';
    html += '</div>';
  });
  html += '</div>';
  var w = window.open('', '_blank');
  if (!w) { toast('Enable popups for achievements'); return; }
  w.document.write('<!DOCTYPE html><html><head><title>Achievements - Saturno Movement Studio</title><link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"><style>*{box-sizing:border-box;margin:0;padding:0}body{background:#050711;color:#e2e8f0;font-family:Sora,sans-serif;padding:40px 20px}</style></head><body>' + html + '</body></html>');
  w.document.close();
  toast('Achievements: ' + unlocked.length + '/' + ACHIEVEMENTS.length);
}

/* Check achievements periodically (every 30s) */
(function() {
  setInterval(function() { try { checkAchievements(); } catch(e) {} }, 30000);
  /* Also check on save */
  if (document.readyState === 'complete') {
    setTimeout(function() { try { checkAchievements(); } catch(e) {} }, 5000);
  } else {
    window.addEventListener('load', function() { setTimeout(function() { try { checkAchievements(); } catch(e) {} }, 5000); });
  }
})();

/* ===== BATCH 297: SMART WORKOUT SUGGESTIONS ===== */
function suggestWorkoutImprovements() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add exercises first'); return; }

  var suggestions = [];
  var families = {};
  var patterns = {};
  var stages = {};
  var totalRPE = 0;
  var rpeCount = 0;

  clips.forEach(function(c) {
    var fam = c.getAttribute('data-family') || 'Unknown';
    var pat = c.getAttribute('data-pattern') || '';
    var stage = parseInt(c.getAttribute('data-stage')) || 1;
    var rpe = parseInt(c.getAttribute('data-rpe')) || 7;
    families[fam] = (families[fam] || 0) + 1;
    if (pat) patterns[pat] = (patterns[pat] || 0) + 1;
    stages[stage] = (stages[stage] || 0) + 1;
    totalRPE += rpe;
    rpeCount++;
  });

  var avgRPE = rpeCount > 0 ? (totalRPE / rpeCount).toFixed(1) : 0;
  var famKeys = Object.keys(families);
  var allFamilies = ['Push','Pull','Core','Legs','Skills'];
  var missingFams = allFamilies.filter(function(f) { return !families[f]; });

  /* Balance check */
  if (missingFams.length > 0) {
    suggestions.push({type:'balance',text:'Missing families: ' + missingFams.join(', ') + '. Add exercises from these groups for full coverage.'});
  }

  /* Push/Pull ratio */
  var pushCount = families['Push'] || 0;
  var pullCount = families['Pull'] || 0;
  if (pushCount > 0 && pullCount > 0) {
    var ratio = pushCount / pullCount;
    if (ratio > 1.5) suggestions.push({type:'ratio',text:'Push/Pull imbalance (' + pushCount + ':' + pullCount + '). Consider adding more pull exercises.'});
    else if (ratio < 0.67) suggestions.push({type:'ratio',text:'Pull-heavy (' + pushCount + ':' + pullCount + '). Consider adding more push exercises.'});
  }

  /* RPE distribution */
  if (parseFloat(avgRPE) > 8) {
    suggestions.push({type:'intensity',text:'Average RPE is ' + avgRPE + ' (very high). Consider mixing in lower-intensity exercises for recovery.'});
  } else if (parseFloat(avgRPE) < 5) {
    suggestions.push({type:'intensity',text:'Average RPE is ' + avgRPE + ' (low). Consider adding challenging exercises to stimulate adaptation.'});
  }

  /* Stage diversity */
  var stageKeys = Object.keys(stages);
  if (stageKeys.length === 1) {
    var onlyStage = stageKeys[0];
    if (onlyStage === '1') suggestions.push({type:'progression',text:'All exercises are Stage 1 (beginner). Mix in some S2/S3 for progressive overload.'});
    else if (onlyStage === '3') suggestions.push({type:'progression',text:'All exercises are Stage 3 (advanced). Consider S1/S2 exercises for warm-up or active recovery.'});
  }

  /* Clip count */
  if (clips.length < 4) {
    suggestions.push({type:'volume',text:'Only ' + clips.length + ' exercises. A balanced session typically has 6-12 exercises.'});
  } else if (clips.length > 15) {
    suggestions.push({type:'volume',text:clips.length + ' exercises is quite dense. Consider splitting into 2 sessions or reducing volume.'});
  }

  /* No rest between exercises warning */
  var bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  if (bpm >= 140) {
    suggestions.push({type:'tempo',text:'High BPM (' + bpm + '). Make sure rest periods are adequate for recovery between explosive efforts.'});
  }

  if (suggestions.length === 0) {
    suggestions.push({type:'perfect',text:'Great workout composition! Balanced families, good RPE distribution, and appropriate volume.'});
  }

  /* Display */
  var msg = 'WORKOUT ANALYSIS\n';
  msg += clips.length + ' exercises | Avg RPE: ' + avgRPE + ' | ' + famKeys.length + '/5 families\n\n';
  suggestions.forEach(function(s, i) {
    var prefix = s.type === 'perfect' ? '  ' : '  ';
    msg += prefix + s.text + '\n';
  });

  toast('Analysis complete');

  /* Show in a modal-like overlay */
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(3,5,9,0.8);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);cursor:pointer';
  overlay.onclick = function() { if (overlay.parentNode) overlay.parentNode.removeChild(overlay); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.95);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:24px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto;cursor:default;box-shadow:0 25px 80px rgba(0,0,0,0.6)';
  card.onclick = function(e) { e.stopPropagation(); };

  var html = '<div style="text-align:center;margin-bottom:16px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Smart Analysis</div><div style="font-size:18px;font-weight:700;color:#fff">Workout Suggestions</div></div>';
  html += '<div style="display:flex;justify-content:center;gap:20px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.06)">';
  html += '<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent-cyan)">' + clips.length + '</div><div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro)">Exercises</div></div>';
  html += '<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent-orange)">' + avgRPE + '</div><div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro)">Avg RPE</div></div>';
  html += '<div style="text-align:center"><div style="font-size:20px;font-weight:700;color:var(--accent-green)">' + famKeys.length + '/5</div><div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro)">Families</div></div>';
  html += '</div>';

  suggestions.forEach(function(s) {
    var typeColor = s.type === 'perfect' ? 'var(--accent-green)' : s.type === 'balance' ? 'var(--accent-orange)' : s.type === 'intensity' ? 'var(--accent-red)' : 'var(--accent-blue)';
    html += '<div style="padding:10px;margin-bottom:6px;border-radius:6px;background:rgba(255,255,255,0.02);border-left:2px solid ' + typeColor + '">';
    html += '<div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:' + typeColor + ';margin-bottom:2px">' + s.type + '</div>';
    html += '<div style="font-size:11px;color:var(--text-secondary);line-height:1.4">' + s.text + '</div>';
    html += '</div>';
  });

  html += '<div style="text-align:center;margin-top:16px"><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);background:none;border:1px solid var(--border);border-radius:4px;padding:8px 20px;cursor:pointer;font-family:Sora,sans-serif">Close</button></div>';

  card.innerHTML = html;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

/* ===== BATCH 298: QUICK WORKOUT TEMPLATES ===== */
var QUICK_TEMPLATES = [
  {name:'PPL Push Day',families:['Push','Core'],exercises:['Push-Up','Dip','Pike Push-Up','Pseudo Planche Push-Up','Hollow Body Hold','Plank'],bpm:110},
  {name:'PPL Pull Day',families:['Pull','Core'],exercises:['Pull-Up','Inverted Row','Tuck Front Lever Row','L-Sit','Dead Hang','Scapular CARs'],bpm:100},
  {name:'PPL Leg Day',families:['Legs','Core'],exercises:['Pistol Squat','Nordic Curl','Shrimp Squat','Step Up','L-Sit','Hip CARs'],bpm:95},
  {name:'Upper Body',families:['Push','Pull'],exercises:['Push-Up','Pull-Up','Dip','Inverted Row','Pike Push-Up','Tuck Front Lever Row'],bpm:105},
  {name:'Core Blitz',families:['Core'],exercises:['Hollow Body Hold','L-Sit','Plank','Dragon Flag','Ab Wheel','Hanging Leg Raise'],bpm:120},
  {name:'Mobility Flow',families:['Flow'],exercises:['Pancake Stretch','German Hang','Hip CARs','Scapular CARs','Pike Stretch','Bridge'],bpm:60},
  {name:'EMOM 10',families:['Push','Pull','Legs'],exercises:['Push-Up','Pull-Up','Pistol Squat','Dip','Inverted Row'],bpm:140},
  {name:'Skill Work',families:['Skills'],exercises:['Handstand','Muscle-Up','Back Lever','Front Lever','Planche Lean','L-Sit'],bpm:75}
];

function showQuickTemplates() {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(3,5,9,0.8);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);cursor:pointer';
  overlay.onclick = function() { if (overlay.parentNode) overlay.parentNode.removeChild(overlay); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.95);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;max-width:440px;width:92%;max-height:80vh;overflow-y:auto;cursor:default;box-shadow:0 25px 80px rgba(0,0,0,0.6)';
  card.onclick = function(e) { e.stopPropagation(); };

  var html = '<div style="text-align:center;margin-bottom:16px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Quick Start</div><div style="font-size:16px;font-weight:700;color:#fff">Workout Templates</div><div style="font-size:9px;color:var(--micro);margin-top:4px">Tap to generate a pre-built workout</div></div>';

  QUICK_TEMPLATES.forEach(function(t, i) {
    var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6',Flow:'#ec4899'};
    var dots = '';
    t.families.forEach(function(f) {
      dots += '<span style="width:8px;height:8px;border-radius:50%;background:' + (famColors[f]||'#06b6d4') + ';display:inline-block"></span>';
    });
    html += '<div onclick="applyQuickTemplate(' + i + ');this.closest(\'div[style*=fixed]\').remove()" style="display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:4px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s;-webkit-tap-highlight-color:transparent" onmouseenter="this.style.background=\'rgba(6,182,212,0.06)\'" onmouseleave="this.style.background=\'rgba(255,255,255,0.02)\'">';
    html += '<div style="display:flex;gap:3px;min-width:28px">' + dots + '</div>';
    html += '<div style="flex:1"><div style="font-size:12px;font-weight:600;color:#fff">' + t.name + '</div><div style="font-size:9px;color:var(--text-secondary)">' + t.exercises.length + ' exercises | ' + t.bpm + ' BPM</div></div>';
    html += '<div style="font-size:8px;color:var(--micro);text-transform:uppercase;letter-spacing:0.06em">' + t.families.join(' ') + '</div>';
    html += '</div>';
  });

  html += '<div style="text-align:center;margin-top:12px"><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);background:none;border:1px solid var(--border);border-radius:4px;padding:8px 20px;cursor:pointer;font-family:Sora,sans-serif">Cancel</button></div>';

  card.innerHTML = html;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

function applyQuickTemplate(index) {
  var t = QUICK_TEMPLATES[index];
  if (!t) return;
  if (typeof captureUndo === 'function') captureUndo();
  /* Clear existing clips */
  document.querySelectorAll('.clip').forEach(function(c) { if (c.parentNode) c.parentNode.removeChild(c); });
  /* Set BPM */
  var bpmInput = document.getElementById('bpm-input');
  if (bpmInput) { bpmInput.value = t.bpm; if (typeof updateBPM === 'function') updateBPM(); }
  /* Add exercises */
  var trackMap = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
  var beatWidth = typeof getSnapSize === 'function' ? getSnapSize() : 40;
  var trackPositions = {};

  t.exercises.forEach(function(exName) {
    /* Find the exercise in EXERCISES */
    var ex = null;
    if (typeof EXERCISES !== 'undefined') {
      for (var i = 0; i < EXERCISES.length; i++) {
        if (EXERCISES[i].name === exName) { ex = EXERCISES[i]; break; }
      }
    }
    if (!ex) return;
    var trackId = trackMap[ex.family] || 'core';
    var track = document.querySelector('.track[data-track="' + trackId + '"] .track-clips');
    if (!track) return;
    if (!trackPositions[trackId]) trackPositions[trackId] = 0;

    var clipWidth = beatWidth * 4; /* 1 bar per exercise */
    if (typeof createClipElement === 'function') {
      var clip = createClipElement(ex, trackPositions[trackId], clipWidth);
      track.appendChild(clip);
    }
    trackPositions[trackId] += clipWidth + beatWidth;
  });

  if (typeof updateStats === 'function') updateStats();
  if (typeof _doSaveSession === 'function') _doSaveSession();
  /* Set workout name */
  var nameEl = document.getElementById('workout-name');
  var headerName = document.getElementById('header-workout-name');
  if (nameEl) nameEl.textContent = t.name;
  if (headerName) headerName.textContent = t.name;
  document.title = t.name + ' - Saturno Movement Studio';
  toast('Template: ' + t.name);
  haptic('medium');
}

/* ===== BATCH 299: WORKOUT HEAT CALENDAR ===== */
function showWorkoutHeatCalendar() {
  /* Gather all workout dates from ratings + saved workouts */
  var dates = {};
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    ratings.forEach(function(r) {
      if (r.date) {
        var d = new Date(r.date).toISOString().split('T')[0];
        dates[d] = (dates[d] || 0) + 1;
      }
    });
  } catch(e) {}
  try {
    var saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]');
    saved.forEach(function(s) {
      if (s.created) {
        var d = new Date(s.created).toISOString().split('T')[0];
        dates[d] = (dates[d] || 0) + 1;
      }
    });
  } catch(e) {}

  /* Build 12-week calendar */
  var today = new Date();
  var startDate = new Date(today);
  startDate.setDate(startDate.getDate() - 83); /* 12 weeks back */
  startDate.setDate(startDate.getDate() - startDate.getDay()); /* Align to Sunday */

  var html = '<div style="max-width:500px;margin:0 auto;padding:24px">';
  html += '<div style="text-align:center;margin-bottom:20px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Activity</div><div style="font-size:20px;font-weight:700;color:#fff">Workout Calendar</div>';
  var totalDays = Object.keys(dates).length;
  html += '<div style="font-size:11px;color:var(--text-secondary);margin-top:4px">' + totalDays + ' active days</div></div>';

  /* Grid */
  html += '<div style="display:flex;gap:2px;justify-content:center;flex-wrap:wrap">';
  var dayNames = ['S','M','T','W','T','F','S'];

  /* Week columns */
  for (var w = 0; w < 12; w++) {
    html += '<div style="display:flex;flex-direction:column;gap:2px">';
    for (var d = 0; d < 7; d++) {
      var cellDate = new Date(startDate);
      cellDate.setDate(cellDate.getDate() + (w * 7) + d);
      var key = cellDate.toISOString().split('T')[0];
      var count = dates[key] || 0;
      var isToday = key === today.toISOString().split('T')[0];
      var intensity = count === 0 ? 'rgba(255,255,255,0.03)' : count === 1 ? 'rgba(6,182,212,0.3)' : count === 2 ? 'rgba(6,182,212,0.5)' : 'rgba(6,182,212,0.8)';
      var border = isToday ? '1px solid rgba(255,255,255,0.3)' : '1px solid transparent';
      var title = cellDate.toLocaleDateString('en-US', {month:'short',day:'numeric'}) + (count > 0 ? ' (' + count + ' workouts)' : '');
      html += '<div title="' + title + '" style="width:12px;height:12px;border-radius:2px;background:' + intensity + ';border:' + border + '"></div>';
    }
    html += '</div>';
  }
  html += '</div>';

  /* Legend */
  html += '<div style="display:flex;gap:4px;align-items:center;justify-content:center;margin-top:12px">';
  html += '<span style="font-size:8px;color:var(--micro)">Less</span>';
  ['rgba(255,255,255,0.03)','rgba(6,182,212,0.3)','rgba(6,182,212,0.5)','rgba(6,182,212,0.8)'].forEach(function(c) {
    html += '<div style="width:10px;height:10px;border-radius:2px;background:' + c + '"></div>';
  });
  html += '<span style="font-size:8px;color:var(--micro)">More</span>';
  html += '</div></div>';

  var w = window.open('', '_blank');
  if (!w) { toast('Enable popups'); return; }
  w.document.write('<!DOCTYPE html><html><head><title>Workout Calendar - Saturno Movement Studio</title><link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"><style>*{box-sizing:border-box;margin:0;padding:0}body{background:#050711;color:#e2e8f0;font-family:Sora,sans-serif;padding:40px 20px}</style></head><body>' + html + '</body></html>');
  w.document.close();
  toast('Calendar opened');
}

/* ===== BATCH 300: MOTIVATIONAL QUOTES + SESSION MILESTONES ===== */
var MOTIVATIONAL_QUOTES = [
  'The body achieves what the mind believes.',
  'Discipline is choosing between what you want now and what you want most.',
  'Every rep is a vote for who you want to become.',
  'You don\'t have to be extreme, just consistent.',
  'The only bad workout is the one that didn\'t happen.',
  'Strength does not come from physical capacity. It comes from an indomitable will.',
  'The pain you feel today will be the strength you feel tomorrow.',
  'Progress, not perfection.',
  'Your body can stand almost anything. It\'s your mind you have to convince.',
  'Fall seven times, stand up eight.',
  'The resistance you fight physically strengthens you mentally.',
  'Compose your movement. Master your craft.',
  'Movement is medicine. Consistency is the prescription.',
  'Train like an artist. Perform like a warrior.',
  'Every exercise is a brushstroke on the canvas of your body.'
];

function getMotivationalQuote() {
  return MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
}

/* Session milestone checker */
var _lastMilestone = 0;
var SESSION_MILESTONES = [5, 15, 30, 45, 60, 90, 120];

function checkSessionMilestones() {
  var el = document.getElementById('session-timer');
  if (!el) return;
  var text = el.textContent || '';
  var parts = text.split(':');
  var minutes = parseInt(parts[0]) || 0;

  for (var i = 0; i < SESSION_MILESTONES.length; i++) {
    var m = SESSION_MILESTONES[i];
    if (minutes >= m && _lastMilestone < m) {
      _lastMilestone = m;
      showMilestoneToast(m);
      break;
    }
  }
}

function showMilestoneToast(minutes) {
  haptic('heavy');
  var quote = getMotivationalQuote();
  var el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.9);z-index:600;background:rgba(5,7,17,0.95);border:1px solid rgba(6,182,212,0.2);padding:24px 32px;border-radius:12px;text-align:center;opacity:0;transition:opacity 0.5s,transform 0.5s;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);pointer-events:none;max-width:340px';

  var label = minutes >= 60 ? Math.floor(minutes/60) + 'h' + (minutes%60>0?' '+minutes%60+'m':'') : minutes + ' min';
  el.innerHTML = '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:8px">Session Milestone</div><div style="font-size:32px;font-weight:800;color:#fff;margin-bottom:8px">' + label + '</div><div style="font-size:11px;color:var(--text-secondary);line-height:1.5;font-style:italic">"' + quote + '"</div>';

  document.body.appendChild(el);
  requestAnimationFrame(function() {
    el.style.opacity = '1';
    el.style.transform = 'translate(-50%,-50%) scale(1)';
  });
  setTimeout(function() {
    el.style.opacity = '0';
    el.style.transform = 'translate(-50%,-50%) scale(0.95)';
    setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 500);
  }, 4000);
}

/* Check milestones every 30s */
(function() {
  setInterval(function() { try { checkSessionMilestones(); } catch(e) {} }, 30000);
})();

/* Update footer hint with motivational quotes periodically */
(function() {
  function rotateQuotes() {
    var hint = document.getElementById('footer-hint');
    if (!hint) return;
    setInterval(function() {
      if (Math.random() < 0.3) {
        hint.textContent = getMotivationalQuote();
        setTimeout(function() { hint.textContent = 'Saturno Movement Studio'; }, 8000);
      }
    }, 60000);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(rotateQuotes, 10000); });
  } else {
    setTimeout(rotateQuotes, 10000);
  }
})();

/* ===== BATCH 301: WORKOUT SHARE CARD ===== */
function generateShareCard() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add exercises first'); return; }

  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Untitled';
  var bpm = document.getElementById('bpm-input') ? document.getElementById('bpm-input').value : '120';
  var mode = document.getElementById('bpm-mode') ? document.getElementById('bpm-mode').textContent : 'Standard';
  var families = {};
  var totalSets = 0;
  var totalReps = 0;
  clips.forEach(function(c) {
    var fam = c.getAttribute('data-family') || 'Unknown';
    families[fam] = (families[fam] || 0) + 1;
    totalSets += parseInt(c.getAttribute('data-sets')) || 3;
    totalReps += (parseInt(c.getAttribute('data-sets')) || 3) * (parseInt(c.getAttribute('data-reps')) || 8);
  });

  var canvas = document.createElement('canvas');
  canvas.width = 1200;
  canvas.height = 630;
  var ctx = canvas.getContext('2d');

  /* Background */
  var bg = ctx.createLinearGradient(0, 0, 1200, 630);
  bg.addColorStop(0, '#050711');
  bg.addColorStop(0.5, '#0a0e1a');
  bg.addColorStop(1, '#050711');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, 1200, 630);

  /* Cosmic glow */
  var glow = ctx.createRadialGradient(600, 0, 0, 600, 0, 600);
  glow.addColorStop(0, 'rgba(6,182,212,0.08)');
  glow.addColorStop(0.5, 'rgba(59,130,246,0.04)');
  glow.addColorStop(1, 'transparent');
  ctx.fillStyle = glow;
  ctx.fillRect(0, 0, 1200, 630);

  /* Grid lines */
  ctx.strokeStyle = 'rgba(255,255,255,0.03)';
  ctx.lineWidth = 1;
  for (var gx = 0; gx < 1200; gx += 60) {
    ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, 630); ctx.stroke();
  }
  for (var gy = 0; gy < 630; gy += 60) {
    ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(1200, gy); ctx.stroke();
  }

  /* Brand header */
  ctx.font = '600 11px Sora, sans-serif';
  ctx.fillStyle = '#06b6d4';
  ctx.letterSpacing = '4px';
  ctx.textAlign = 'center';
  ctx.fillText('SATURNO MOVEMENT STUDIO', 600, 60);

  /* Workout name */
  ctx.font = '800 48px Sora, sans-serif';
  ctx.fillStyle = '#ffffff';
  ctx.fillText(workoutName, 600, 130);

  /* Subtitle */
  ctx.font = '400 16px Sora, sans-serif';
  ctx.fillStyle = '#8b94a5';
  ctx.fillText(bpm + ' BPM | ' + mode + ' | ' + clips.length + ' Exercises', 600, 165);

  /* Divider */
  var divGrad = ctx.createLinearGradient(300, 0, 900, 0);
  divGrad.addColorStop(0, 'transparent');
  divGrad.addColorStop(0.5, 'rgba(6,182,212,0.4)');
  divGrad.addColorStop(1, 'transparent');
  ctx.strokeStyle = divGrad;
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(300, 190); ctx.lineTo(900, 190); ctx.stroke();

  /* Stats boxes */
  var stats = [
    {label:'EXERCISES', value: '' + clips.length, color:'#06b6d4'},
    {label:'TOTAL SETS', value: '' + totalSets, color:'#3b82f6'},
    {label:'TOTAL REPS', value: '' + totalReps, color:'#8b5cf6'},
    {label:'FAMILIES', value: Object.keys(families).length + '/5', color:'#22c55e'}
  ];
  var sx = 150;
  stats.forEach(function(s) {
    ctx.font = '800 36px Sora, sans-serif';
    ctx.fillStyle = s.color;
    ctx.textAlign = 'center';
    ctx.fillText(s.value, sx + 112, 260);
    ctx.font = '600 9px Sora, sans-serif';
    ctx.fillStyle = '#475569';
    ctx.fillText(s.label, sx + 112, 285);
    sx += 225;
  });

  /* Family breakdown bars */
  var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6',Flow:'#ec4899'};
  var barY = 330;
  var allFams = ['Push','Pull','Core','Legs','Skills'];
  allFams.forEach(function(fam) {
    var count = families[fam] || 0;
    var pct = clips.length > 0 ? count / clips.length : 0;
    /* Label */
    ctx.font = '600 10px Sora, sans-serif';
    ctx.fillStyle = famColors[fam] || '#06b6d4';
    ctx.textAlign = 'left';
    ctx.fillText(fam.toUpperCase(), 200, barY + 10);
    /* Bar background */
    ctx.fillStyle = 'rgba(255,255,255,0.04)';
    roundRect(ctx, 280, barY - 2, 640, 16, 4);
    ctx.fill();
    /* Bar fill */
    if (pct > 0) {
      ctx.fillStyle = famColors[fam] || '#06b6d4';
      ctx.globalAlpha = 0.6;
      roundRect(ctx, 280, barY - 2, Math.max(640 * pct, 8), 16, 4);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
    /* Count */
    ctx.font = '500 10px Sora, sans-serif';
    ctx.fillStyle = '#64748b';
    ctx.textAlign = 'right';
    ctx.fillText(count + ' (' + Math.round(pct * 100) + '%)', 960, barY + 10);
    barY += 32;
  });

  /* Footer */
  ctx.font = '400 10px Sora, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.15)';
  ctx.textAlign = 'center';
  ctx.fillText('The Ableton of Movement | saturnomovement.com', 600, 590);

  /* Date */
  ctx.font = '400 9px Sora, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.1)';
  ctx.fillText(new Date().toLocaleDateString('en-US', {month:'long',day:'numeric',year:'numeric'}), 600, 610);

  /* Download */
  try {
    var link = document.createElement('a');
    link.download = (workoutName || 'workout') + '-share-card.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    toast('Share card downloaded');
  } catch(e) {
    toast('Error generating card');
  }
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

/* ===== BATCH 302: EXERCISE FAVORITES ===== */
function getFavorites() {
  try { return JSON.parse(localStorage.getItem('sms_favorites') || '[]'); } catch(e) { return []; }
}

function saveFavorites(favs) {
  try { localStorage.setItem('sms_favorites', JSON.stringify(favs)); } catch(e) {}
}

function toggleFavorite(exerciseName) {
  var favs = getFavorites();
  var idx = favs.indexOf(exerciseName);
  if (idx >= 0) {
    favs.splice(idx, 1);
    toast(exerciseName + ' unfavorited');
  } else {
    favs.push(exerciseName);
    toast(exerciseName + ' favorited');
  }
  saveFavorites(favs);
  haptic('light');
  updateFavoriteIndicators();
  updateFavoritePanel();
}

function isFavorite(exerciseName) {
  return getFavorites().indexOf(exerciseName) >= 0;
}

function updateFavoriteIndicators() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    var name = item.getAttribute('data-exercise');
    var star = item.querySelector('.fav-star');
    if (star) {
      star.style.color = isFavorite(name) ? 'var(--accent-orange)' : 'var(--micro)';
      star.style.opacity = isFavorite(name) ? '1' : '0.3';
    }
  });
}

function updateFavoritePanel() {
  var favs = getFavorites();
  var container = document.getElementById('favorites-panel');
  if (!container) return;
  var parent = container.closest('.movement-category');
  if (favs.length === 0) {
    if (parent) parent.style.display = 'none';
    return;
  }
  if (parent) parent.style.display = '';
  container.innerHTML = '';
  favs.forEach(function(name) {
    var ex = null;
    if (typeof EXERCISES !== 'undefined') {
      for (var i = 0; i < EXERCISES.length; i++) {
        if (EXERCISES[i].name === name) { ex = EXERCISES[i]; break; }
      }
    }
    if (!ex) return;
    var item = document.createElement('div');
    item.className = 'movement-item';
    item.setAttribute('draggable', 'true');
    item.setAttribute('data-exercise', ex.name);
    item.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px 12px;font-size:10px;cursor:grab;border-left:2px solid ' + (ex.color || 'var(--accent-cyan)');
    item.innerHTML = '<div class="mv-icon" style="background:' + (ex.color || 'var(--accent-cyan)') + ';color:#fff;font-size:7px">' + (ex.family || '?').charAt(0) + '</div><span class="mv-name">' + ex.name + '</span><span class="mv-stage" style="margin-left:auto">S' + (ex.stage || 1) + '</span>';
    item.addEventListener('dragstart', function(e) {
      e.dataTransfer.setData('text/plain', ex.name);
      e.dataTransfer.effectAllowed = 'copy';
    });
    item.addEventListener('dblclick', function() {
      if (typeof quickAddExercise === 'function') quickAddExercise(ex.name);
    });
    container.appendChild(item);
  });
}

/* Add favorites panel to library */
(function() {
  function addFavoritesPanel() {
    var libContainer = document.getElementById('library-container');
    if (!libContainer) return;
    var cat = document.createElement('div');
    cat.className = 'movement-category';
    cat.style.display = 'none';
    cat.innerHTML = '<div class="category-header" style="font-size:8px;color:var(--accent-orange);padding:5px 12px"><span>Favorites</span></div><div class="movement-list" id="favorites-panel"></div>';
    libContainer.parentNode.insertBefore(cat, libContainer);
    updateFavoritePanel();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addFavoritesPanel);
  } else {
    addFavoritesPanel();
  }
})();

/* Add star buttons to library items after they're rendered */
(function() {
  function addStarsToLibrary() {
    /* Observe library container for changes */
    var lib = document.getElementById('library-container');
    if (!lib) return;
    var observer = new MutationObserver(function() {
      lib.querySelectorAll('.movement-item:not([data-fav-init])').forEach(function(item) {
        item.setAttribute('data-fav-init', '1');
        var name = item.getAttribute('data-exercise');
        if (!name) return;
        var star = document.createElement('span');
        star.className = 'fav-star';
        star.style.cssText = 'cursor:pointer;font-size:10px;margin-left:4px;transition:color 0.15s,opacity 0.15s;-webkit-tap-highlight-color:transparent';
        star.style.color = isFavorite(name) ? 'var(--accent-orange)' : 'var(--micro)';
        star.style.opacity = isFavorite(name) ? '1' : '0.3';
        star.textContent = '\u2605';
        star.onclick = function(e) { e.stopPropagation(); toggleFavorite(name); };
        item.appendChild(star);
      });
    });
    observer.observe(lib, { childList: true, subtree: true });
    /* Also run once now */
    lib.querySelectorAll('.movement-item').forEach(function(item) {
      if (item.getAttribute('data-fav-init')) return;
      item.setAttribute('data-fav-init', '1');
      var name = item.getAttribute('data-exercise');
      if (!name) return;
      var star = document.createElement('span');
      star.className = 'fav-star';
      star.style.cssText = 'cursor:pointer;font-size:10px;margin-left:4px;transition:color 0.15s,opacity 0.15s;-webkit-tap-highlight-color:transparent';
      star.style.color = isFavorite(name) ? 'var(--accent-orange)' : 'var(--micro)';
      star.style.opacity = isFavorite(name) ? '1' : '0.3';
      star.textContent = '\u2605';
      star.onclick = function(e) { e.stopPropagation(); toggleFavorite(name); };
      item.appendChild(star);
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(addStarsToLibrary, 500); });
  } else {
    setTimeout(addStarsToLibrary, 500);
  }
})();

/* ===== BATCH 303: WORKOUT HISTORY TIMELINE ===== */
function showWorkoutHistory() {
  var entries = [];

  /* Gather from saved workouts */
  try {
    var saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]');
    saved.forEach(function(s) {
      entries.push({
        type: 'save',
        name: s.name || 'Untitled',
        date: s.created || s.date || null,
        clips: s.clips ? s.clips.length : (s.clipCount || 0),
        bpm: s.bpm || 120
      });
    });
  } catch(e) {}

  /* Gather from ratings */
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    ratings.forEach(function(r) {
      entries.push({
        type: 'rating',
        name: r.name || 'Untitled',
        date: r.date || null,
        rating: r.rating || 0,
        clips: r.clips || 0
      });
    });
  } catch(e) {}

  /* Sort by date (newest first) */
  entries.sort(function(a, b) {
    var da = a.date ? new Date(a.date).getTime() : 0;
    var db = b.date ? new Date(b.date).getTime() : 0;
    return db - da;
  });

  if (entries.length === 0) {
    toast('No workout history yet. Save or rate workouts to build history.');
    return;
  }

  /* Build vertical timeline */
  var html = '<div style="max-width:440px;margin:0 auto;padding:24px">';
  html += '<div style="text-align:center;margin-bottom:24px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">History</div><div style="font-size:20px;font-weight:700;color:#fff">Your Journey</div><div style="font-size:11px;color:var(--text-secondary);margin-top:4px">' + entries.length + ' recorded sessions</div></div>';

  html += '<div style="position:relative;padding-left:24px">';
  /* Vertical line */
  html += '<div style="position:absolute;left:8px;top:0;bottom:0;width:1px;background:linear-gradient(180deg,rgba(6,182,212,0.3),rgba(6,182,212,0.05))"></div>';

  entries.forEach(function(e, i) {
    var dateStr = e.date ? new Date(e.date).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : 'Unknown date';
    var dotColor = e.type === 'save' ? '#3b82f6' : '#f97316';
    var stars = '';
    if (e.rating) {
      for (var s = 0; s < 5; s++) {
        stars += '<span style="color:' + (s < e.rating ? '#f97316' : 'rgba(255,255,255,0.1)') + '">\u2605</span>';
      }
    }

    html += '<div style="position:relative;margin-bottom:16px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)">';
    /* Dot */
    html += '<div style="position:absolute;left:-20px;top:16px;width:8px;height:8px;border-radius:50%;background:' + dotColor + ';box-shadow:0 0 8px ' + dotColor + '40"></div>';
    /* Date */
    html += '<div style="font-size:8px;color:var(--micro);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px">' + dateStr + '</div>';
    /* Name */
    html += '<div style="font-size:13px;font-weight:600;color:#fff;margin-bottom:4px">' + e.name + '</div>';
    /* Details */
    html += '<div style="display:flex;gap:10px;font-size:9px;color:var(--text-secondary)">';
    if (e.clips) html += '<span>' + e.clips + ' exercises</span>';
    if (e.bpm) html += '<span>' + e.bpm + ' BPM</span>';
    if (e.type === 'save') html += '<span style="color:#3b82f6">Saved</span>';
    if (stars) html += '<span>' + stars + '</span>';
    html += '</div></div>';
  });

  html += '</div></div>';

  var w = window.open('', '_blank');
  if (!w) { toast('Enable popups'); return; }
  w.document.write('<!DOCTYPE html><html><head><title>Workout History - Saturno Movement Studio</title><link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"><style>*{box-sizing:border-box;margin:0;padding:0}body{background:#050711;color:#e2e8f0;font-family:Sora,sans-serif;padding:40px 20px}</style></head><body>' + html + '</body></html>');
  w.document.close();
  toast('History opened');
}

/* ===== BATCH 304: QUICK REFERENCE CHEAT SHEET ===== */
function showCheatSheet() {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:400;background:rgba(3,5,9,0.85);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);cursor:pointer;overflow-y:auto;padding:20px';
  overlay.onclick = function() { if (overlay.parentNode) overlay.parentNode.removeChild(overlay); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.98);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:24px;max-width:600px;width:95%;max-height:85vh;overflow-y:auto;cursor:default;box-shadow:0 25px 80px rgba(0,0,0,0.6)';
  card.onclick = function(e) { e.stopPropagation(); };

  var sections = [
    {title:'Playback', items:['Space = Play/Pause','Esc = Deselect + Stop','0 = Reset to start','Left/Right = Scrub by beat','Shift+Left/Right = Scrub by bar','Home = Jump to start','End = Jump to end']},
    {title:'Clips', items:['Click = Select clip','Shift+Click = Multi-select','Cmd+A = Select all','Cmd+I = Invert selection','Cmd+C = Copy','Cmd+V = Paste','Cmd+Shift+V = Paste at playhead','Cmd+D = Duplicate','Delete = Delete selected','B = Split at playhead','Cmd+L = Lock/Unlock','Cmd+G = Group','J/K = Next/Prev clip']},
    {title:'Editing', items:['Alt+Arrow = Resize clip','Arrow Up/Down = Move to track','[ ] = Nudge sets','Shift+[ ] = Nudge reps',', . = Nudge tempo','Shift+, . = Nudge rest','Shift+Up/Down = RPE adjust','PgUp/PgDn = Stage up/down','Alt+Drag = Duplicate clip']},
    {title:'Navigation', items:['Cmd+K = Command palette','? = Shortcuts panel','/ = Focus library search','F = Focus mode','P = Toggle presets','G = Generate random','S = Toggle snap','L = Toggle loop','T = Tap tempo','N/Shift+N = Next/Prev marker','Tab = Cycle clips','C = Collapse track']},
    {title:'Zoom', items:['Cmd++ = Zoom in','Cmd+- = Zoom out','Scroll wheel = Zoom','R = Record mode']},
    {title:'Mobile', items:['Tap exercise = Add to timeline','Swipe left on clip = Delete','Long-press clip = Context menu','Double-tap timeline = Commands','Swipe right from edge = Library']}
  ];

  var html = '<div style="text-align:center;margin-bottom:20px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Quick Reference</div><div style="font-size:18px;font-weight:700;color:#fff">Cheat Sheet</div></div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">';

  sections.forEach(function(sec) {
    html += '<div>';
    html += '<div style="font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent-cyan);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid rgba(6,182,212,0.15)">' + sec.title + '</div>';
    sec.items.forEach(function(item) {
      var parts = item.split(' = ');
      html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:10px">';
      html += '<kbd style="padding:2px 6px;border:1px solid rgba(255,255,255,0.1);border-radius:3px;font-size:8px;color:var(--text-secondary);font-family:Sora,sans-serif;background:rgba(255,255,255,0.03);white-space:nowrap">' + parts[0] + '</kbd>';
      html += '<span style="color:var(--muted);font-size:9px;text-align:right;margin-left:8px">' + (parts[1] || '') + '</span>';
      html += '</div>';
    });
    html += '</div>';
  });

  html += '</div>';
  html += '<div style="text-align:center;margin-top:16px"><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);background:none;border:1px solid var(--border);border-radius:4px;padding:8px 20px;cursor:pointer;font-family:Sora,sans-serif">Close</button></div>';

  card.innerHTML = html;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

/* ===== BATCH 305: CLIP ENTRANCE ANIMATION ===== */
(function() {
  /* Add CSS animation for clip entrance */
  var style = document.createElement('style');
  style.textContent = '@keyframes clipEnter{0%{opacity:0;transform:scaleX(0.3) translateY(4px)}60%{opacity:1;transform:scaleX(1.02) translateY(-1px)}100%{transform:scaleX(1) translateY(0)}}' +
    '@keyframes clipExit{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(0.8) translateY(8px)}}' +
    '.clip-entering{animation:clipEnter 0.25s cubic-bezier(0.34,1.56,0.64,1) forwards}' +
    '.clip-exiting{animation:clipExit 0.15s ease-in forwards;pointer-events:none}';
  document.head.appendChild(style);

  /* Patch createClipElement to add entrance animation */
  function patchClipCreation() {
    if (!window.createClipElement) return;
    var orig = window.createClipElement;
    window.createClipElement = function() {
      var clip = orig.apply(this, arguments);
      if (clip && clip.classList) {
        clip.classList.add('clip-entering');
        clip.addEventListener('animationend', function handler() {
          clip.classList.remove('clip-entering');
          clip.removeEventListener('animationend', handler);
        });
      }
      return clip;
    };
  }
  if (document.readyState === 'complete') setTimeout(patchClipCreation, 300);
  else window.addEventListener('load', function() { setTimeout(patchClipCreation, 300); });
})();

/* ===== BATCH 306: SESSION AUTO-BACKUP SYSTEM ===== */
var _autoBackupInterval = null;
var AUTO_BACKUP_INTERVAL = 120000; /* 2 minutes */
var MAX_AUTO_BACKUPS = 5;

function startAutoBackup() {
  if (_autoBackupInterval) return;
  _autoBackupInterval = setInterval(function() {
    try {
      var clips = document.querySelectorAll('.clip');
      if (clips.length === 0) return; /* Don't backup empty sessions */
      var backups = JSON.parse(localStorage.getItem('sms_auto_backups') || '[]');
      var snapshot = {
        timestamp: Date.now(),
        date: new Date().toISOString(),
        clipCount: clips.length,
        workoutName: document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Untitled',
        session: null
      };
      /* Try to capture session data */
      if (typeof _doSaveSession === 'function') {
        /* Build a minimal session snapshot */
        var clipData = [];
        clips.forEach(function(c) {
          clipData.push({
            exercise: c.getAttribute('data-exercise') || '',
            family: c.getAttribute('data-family') || '',
            track: c.closest('.track') ? c.closest('.track').getAttribute('data-track') : '',
            left: c.style.left,
            width: c.style.width,
            sets: c.getAttribute('data-sets'),
            reps: c.getAttribute('data-reps'),
            rpe: c.getAttribute('data-rpe')
          });
        });
        snapshot.clips = clipData;
        snapshot.bpm = document.getElementById('bpm-input') ? document.getElementById('bpm-input').value : '120';
      }
      backups.push(snapshot);
      /* Keep only last N backups */
      while (backups.length > MAX_AUTO_BACKUPS) backups.shift();
      localStorage.setItem('sms_auto_backups', JSON.stringify(backups));
    } catch(e) {}
  }, AUTO_BACKUP_INTERVAL);
}

function stopAutoBackup() {
  if (_autoBackupInterval) { clearInterval(_autoBackupInterval); _autoBackupInterval = null; }
}

function showAutoBackups() {
  var backups = [];
  try { backups = JSON.parse(localStorage.getItem('sms_auto_backups') || '[]'); } catch(e) {}
  if (backups.length === 0) { toast('No auto-backups yet (saved every 2 min)'); return; }

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(3,5,9,0.8);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);cursor:pointer';
  overlay.onclick = function() { if (overlay.parentNode) overlay.parentNode.removeChild(overlay); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.95);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;max-width:380px;width:92%;max-height:70vh;overflow-y:auto;cursor:default;box-shadow:0 25px 80px rgba(0,0,0,0.6)';
  card.onclick = function(e) { e.stopPropagation(); };

  var html = '<div style="text-align:center;margin-bottom:16px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-green);margin-bottom:4px">Recovery</div><div style="font-size:16px;font-weight:700;color:#fff">Auto-Backups</div><div style="font-size:9px;color:var(--micro);margin-top:4px">' + backups.length + ' snapshots (every 2 min)</div></div>';

  backups.reverse().forEach(function(b, i) {
    var date = new Date(b.timestamp || b.date);
    var timeAgo = Math.round((Date.now() - date.getTime()) / 60000);
    var agoText = timeAgo < 1 ? 'Just now' : timeAgo + ' min ago';
    html += '<div style="padding:10px;margin-bottom:4px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseenter="this.style.background=\'rgba(34,197,94,0.06)\'" onmouseleave="this.style.background=\'rgba(255,255,255,0.02)\'" onclick="restoreAutoBackup(' + (backups.length - 1 - i) + ');this.closest(\'div[style*=fixed]\').remove()">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center">';
    html += '<div><div style="font-size:11px;font-weight:600;color:#fff">' + (b.workoutName || 'Untitled') + '</div>';
    html += '<div style="font-size:9px;color:var(--text-secondary)">' + (b.clipCount || 0) + ' clips | ' + (b.bpm || 120) + ' BPM</div></div>';
    html += '<div style="text-align:right"><div style="font-size:9px;color:var(--accent-green)">' + agoText + '</div>';
    html += '<div style="font-size:8px;color:var(--micro)">' + date.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'}) + '</div></div>';
    html += '</div></div>';
  });

  html += '<div style="text-align:center;margin-top:12px"><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);background:none;border:1px solid var(--border);border-radius:4px;padding:8px 20px;cursor:pointer;font-family:Sora,sans-serif">Close</button></div>';

  card.innerHTML = html;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

function restoreAutoBackup(index) {
  try {
    var backups = JSON.parse(localStorage.getItem('sms_auto_backups') || '[]');
    var b = backups[index];
    if (!b || !b.clips) { toast('Backup has no clip data'); return; }
    if (typeof captureUndo === 'function') captureUndo();
    /* Clear existing clips */
    document.querySelectorAll('.clip').forEach(function(c) { if (c.parentNode) c.parentNode.removeChild(c); });
    /* Restore BPM */
    var bpmInput = document.getElementById('bpm-input');
    if (bpmInput && b.bpm) { bpmInput.value = b.bpm; if (typeof updateBPM === 'function') updateBPM(); }
    /* Restore workout name */
    var nameEl = document.getElementById('workout-name');
    var headerName = document.getElementById('header-workout-name');
    if (nameEl && b.workoutName) nameEl.textContent = b.workoutName;
    if (headerName && b.workoutName) headerName.textContent = b.workoutName;
    /* Restore clips */
    b.clips.forEach(function(cd) {
      if (!cd.exercise || !cd.track) return;
      var ex = null;
      if (typeof EXERCISES !== 'undefined') {
        for (var i = 0; i < EXERCISES.length; i++) {
          if (EXERCISES[i].name === cd.exercise) { ex = EXERCISES[i]; break; }
        }
      }
      if (!ex) return;
      var track = document.querySelector('.track[data-track="' + cd.track + '"] .track-clips');
      if (!track) return;
      if (typeof createClipElement === 'function') {
        var clip = createClipElement(ex, parseFloat(cd.left) || 0, parseFloat(cd.width) || 80);
        if (cd.sets) clip.setAttribute('data-sets', cd.sets);
        if (cd.reps) clip.setAttribute('data-reps', cd.reps);
        if (cd.rpe) clip.setAttribute('data-rpe', cd.rpe);
        track.appendChild(clip);
      }
    });
    if (typeof updateStats === 'function') updateStats();
    toast('Backup restored: ' + (b.workoutName || 'Untitled'));
    haptic('medium');
  } catch(e) {
    toast('Error restoring backup');
  }
}

/* Start auto-backup system */
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(startAutoBackup, 5000); });
  } else {
    setTimeout(startAutoBackup, 5000);
  }
})();

/* ===== BATCH 307: WORKOUT DIFFICULTY SCALING ===== */
function scaleWorkoutDifficulty(target) {
  /* target: 'beginner', 'intermediate', 'advanced', 'elite' */
  var clips = document.querySelectorAll('.clip:not(.clip-locked)');
  if (clips.length === 0) { toast('Add exercises first'); return; }
  if (typeof captureUndo === 'function') captureUndo();

  var presets = {
    beginner: { sets: 2, reps: 8, rpe: 4, rest: 90, tempo: 4, stage: 1 },
    intermediate: { sets: 3, reps: 10, rpe: 6, rest: 60, tempo: 3, stage: 2 },
    advanced: { sets: 4, reps: 8, rpe: 8, rest: 45, tempo: 3, stage: 3 },
    elite: { sets: 5, reps: 6, rpe: 9, rest: 30, tempo: 2, stage: 3 }
  };
  var p = presets[target];
  if (!p) { toast('Unknown difficulty: ' + target); return; }

  clips.forEach(function(c) {
    c.setAttribute('data-sets', p.sets);
    c.setAttribute('data-reps', p.reps);
    c.setAttribute('data-rpe', p.rpe);
    c.setAttribute('data-rest', p.rest);
    c.setAttribute('data-tempo', p.tempo);
    /* Try to swap to target stage */
    if (p.stage && typeof EXERCISES !== 'undefined') {
      var currentName = c.getAttribute('data-exercise');
      var currentPattern = c.getAttribute('data-pattern');
      if (currentPattern) {
        var candidate = null;
        EXERCISES.forEach(function(ex) {
          if (ex.pattern === currentPattern && ex.stage === p.stage && !candidate) candidate = ex;
        });
        if (candidate && candidate.name !== currentName) {
          c.setAttribute('data-exercise', candidate.name);
          c.setAttribute('data-stage', candidate.stage);
          c.setAttribute('data-discipline', candidate.discipline || '');
          var nameEl = c.querySelector('.clip-name');
          if (nameEl) nameEl.textContent = candidate.name;
          /* Update stage dots */
          var dots = c.querySelectorAll('.clip-stage-dot');
          dots.forEach(function(d, i) { d.classList.toggle('filled', i < candidate.stage); });
        }
      }
    }
    /* Update label */
    if (typeof updateClipInfo === 'function') updateClipInfo(c);
  });

  if (typeof updateStats === 'function') updateStats();
  toast('Scaled to ' + target + ': ' + p.sets + 'x' + p.reps + ' RPE ' + p.rpe);
  haptic('medium');
}

/* ===== BATCH 308: ENHANCED EXERCISE SEARCH ===== */
function exerciseSearchModal() {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:350;background:rgba(3,5,9,0.85);display:flex;align-items:flex-start;justify-content:center;padding-top:10vh;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.98);border:1px solid rgba(255,255,255,0.08);border-radius:12px;width:95%;max-width:440px;max-height:70vh;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.6)';

  /* Search input */
  var input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Search exercises by name, pattern, family, or discipline...';
  input.style.cssText = 'width:100%;padding:14px 16px;background:transparent;border:none;border-bottom:1px solid rgba(255,255,255,0.06);color:#fff;font-size:14px;font-family:Sora,sans-serif;outline:none';

  /* Filters */
  var filters = document.createElement('div');
  filters.style.cssText = 'display:flex;gap:4px;padding:8px 12px;flex-wrap:wrap;border-bottom:1px solid rgba(255,255,255,0.04)';
  var filterBtns = [
    {label:'All',value:'all'},
    {label:'Push',value:'Push',color:'#3b82f6'},
    {label:'Pull',value:'Pull',color:'#22c55e'},
    {label:'Core',value:'Core',color:'#f97316'},
    {label:'Legs',value:'Legs',color:'#ef4444'},
    {label:'Skills',value:'Skills',color:'#8b5cf6'},
    {label:'Flow',value:'Flow',color:'#ec4899'}
  ];
  var activeFilter = 'all';
  filterBtns.forEach(function(fb) {
    var btn = document.createElement('button');
    btn.textContent = fb.label;
    btn.style.cssText = 'padding:4px 10px;border:none;border-radius:4px;font-size:8px;font-family:Sora,sans-serif;cursor:pointer;text-transform:uppercase;letter-spacing:0.06em;transition:background 0.15s,color 0.15s;-webkit-tap-highlight-color:transparent';
    btn.style.background = fb.value === 'all' ? 'rgba(6,182,212,0.15)' : 'rgba(255,255,255,0.03)';
    btn.style.color = fb.value === 'all' ? '#06b6d4' : 'var(--micro)';
    btn.onclick = function() {
      activeFilter = fb.value;
      filters.querySelectorAll('button').forEach(function(b) { b.style.background = 'rgba(255,255,255,0.03)'; b.style.color = 'var(--micro)'; });
      btn.style.background = fb.color ? 'rgba(' + hexToRgb(fb.color) + ',0.15)' : 'rgba(6,182,212,0.15)';
      btn.style.color = fb.color || '#06b6d4';
      doSearch();
    };
    filters.appendChild(btn);
  });

  /* Results */
  var results = document.createElement('div');
  results.style.cssText = 'overflow-y:auto;flex:1;padding:4px 0;-webkit-overflow-scrolling:touch';

  function hexToRgb(hex) {
    var r = parseInt(hex.slice(1,3),16);
    var g = parseInt(hex.slice(3,5),16);
    var b = parseInt(hex.slice(5,7),16);
    return r+','+g+','+b;
  }

  function doSearch() {
    var q = input.value.toLowerCase().trim();
    results.innerHTML = '';
    if (typeof EXERCISES === 'undefined') return;
    var matches = EXERCISES.filter(function(ex) {
      if (activeFilter !== 'all' && ex.family !== activeFilter) return false;
      if (!q) return true;
      return ex.name.toLowerCase().indexOf(q) !== -1 ||
             (ex.pattern && ex.pattern.toLowerCase().indexOf(q) !== -1) ||
             (ex.family && ex.family.toLowerCase().indexOf(q) !== -1) ||
             (ex.discipline && ex.discipline.toLowerCase().indexOf(q) !== -1);
    });

    if (matches.length === 0) {
      results.innerHTML = '<div style="padding:20px;text-align:center;color:var(--micro);font-size:11px">No exercises found</div>';
      return;
    }

    matches.forEach(function(ex) {
      var row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background 0.1s;border-bottom:1px solid rgba(255,255,255,0.02);-webkit-tap-highlight-color:transparent';
      row.onmouseenter = function() { row.style.background = 'rgba(255,255,255,0.03)'; };
      row.onmouseleave = function() { row.style.background = ''; };
      row.onclick = function() {
        if (typeof quickAddExercise === 'function') quickAddExercise(ex.name);
        overlay.remove();
      };
      row.innerHTML = '<div style="width:24px;height:24px;border-radius:4px;background:' + (ex.color || 'var(--accent-cyan)') + ';display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;flex-shrink:0">' + (ex.family||'?').charAt(0) + '</div>' +
        '<div style="flex:1"><div style="font-size:11px;font-weight:600;color:#fff">' + ex.name + '</div><div style="font-size:8px;color:var(--text-secondary)">' + (ex.pattern||'') + ' | S' + (ex.stage||1) + ' | ' + (ex.discipline||'') + '</div></div>' +
        '<div style="font-size:8px;color:var(--micro)">' + (ex.family||'') + '</div>';
      results.appendChild(row);
    });
  }

  input.oninput = doSearch;
  input.onkeydown = function(e) { if (e.key === 'Escape') overlay.remove(); };

  card.appendChild(input);
  card.appendChild(filters);
  card.appendChild(results);
  overlay.appendChild(card);
  document.body.appendChild(overlay);
  input.focus();
  doSearch();
}

/* ===== BATCH 309: REST TIMER MINI-WIDGET ===== */
var _restTimer = null;
var _restTimerWidget = null;

function startRestTimer(seconds) {
  if (!seconds || seconds <= 0) seconds = 60;
  stopRestTimer();

  _restTimerWidget = document.createElement('div');
  _restTimerWidget.style.cssText = 'position:fixed;bottom:' + (isMobileView() ? '60px' : '32px') + ';right:16px;z-index:200;background:rgba(10,14,26,0.95);border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:12px 16px;min-width:120px;text-align:center;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 8px 32px rgba(0,0,0,0.5);cursor:pointer;transition:transform 0.2s;-webkit-tap-highlight-color:transparent';
  _restTimerWidget.onclick = function() { stopRestTimer(); };
  _restTimerWidget.setAttribute('data-tip', 'Click to dismiss');

  var remaining = seconds;
  function render() {
    var pct = remaining / seconds;
    var min = Math.floor(remaining / 60);
    var sec = remaining % 60;
    var timeStr = min > 0 ? min + ':' + (sec < 10 ? '0' : '') + sec : sec + 's';
    var color = pct > 0.5 ? '#06b6d4' : pct > 0.2 ? '#f97316' : '#ef4444';
    _restTimerWidget.innerHTML = '<div style="font-size:8px;text-transform:uppercase;letter-spacing:0.15em;color:' + color + ';margin-bottom:4px">Rest</div><div style="font-size:24px;font-weight:800;color:#fff;font-variant-numeric:tabular-nums">' + timeStr + '</div><div style="margin-top:6px;height:3px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden"><div style="height:100%;width:' + (pct * 100) + '%;background:' + color + ';border-radius:2px;transition:width 1s linear"></div></div>';
  }

  render();
  document.body.appendChild(_restTimerWidget);
  _restTimerWidget.style.transform = 'scale(0.9)';
  requestAnimationFrame(function() { _restTimerWidget.style.transform = 'scale(1)'; });

  _restTimer = setInterval(function() {
    remaining--;
    if (remaining <= 0) {
      stopRestTimer();
      haptic('heavy');
      toast('Rest complete! Go!');
      /* Play a subtle beep if possible */
      try {
        var ac = new (window.AudioContext || window.webkitAudioContext)();
        var osc = ac.createOscillator();
        var gain = ac.createGain();
        osc.connect(gain);
        gain.connect(ac.destination);
        osc.frequency.value = 880;
        gain.gain.value = 0.1;
        osc.start(ac.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.5);
        osc.stop(ac.currentTime + 0.5);
      } catch(e) {}
      return;
    }
    if (remaining <= 3) haptic('light');
    render();
  }, 1000);
}

function stopRestTimer() {
  if (_restTimer) { clearInterval(_restTimer); _restTimer = null; }
  if (_restTimerWidget && _restTimerWidget.parentNode) {
    _restTimerWidget.style.transform = 'scale(0.9)';
    _restTimerWidget.style.opacity = '0';
    var w = _restTimerWidget;
    setTimeout(function() { if (w.parentNode) w.parentNode.removeChild(w); }, 200);
    _restTimerWidget = null;
  }
}

/* ===== BATCH 310: PER-EXERCISE COACHING NOTES ===== */
var _exerciseCoachingNotes = {};

function loadCoachingNotes() {
  try { _exerciseCoachingNotes = JSON.parse(localStorage.getItem('sms_coaching_notes') || '{}'); } catch(e) { _exerciseCoachingNotes = {}; }
}

function saveCoachingNotes() {
  try { localStorage.setItem('sms_coaching_notes', JSON.stringify(_exerciseCoachingNotes)); } catch(e) {}
}

function showCoachingNotes(exerciseName) {
  if (!exerciseName) { toast('Select a clip first'); return; }
  loadCoachingNotes();
  var currentNote = _exerciseCoachingNotes[exerciseName] || '';

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:350;background:rgba(3,5,9,0.85);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)';
  overlay.onclick = function(e) { if (e.target === overlay) { save(); overlay.remove(); } };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.98);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;max-width:440px;width:92%;box-shadow:0 25px 80px rgba(0,0,0,0.6)';

  card.innerHTML = '<div style="margin-bottom:12px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.15em;color:var(--accent-cyan);margin-bottom:4px">Coaching Notes</div><div style="font-size:14px;font-weight:600;color:#fff">' + exerciseName + '</div></div>';

  var textarea = document.createElement('textarea');
  textarea.value = currentNote;
  textarea.placeholder = 'Add coaching cues, form tips, progressions, regressions...';
  textarea.style.cssText = 'width:100%;min-height:150px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:6px;color:var(--text);font-size:12px;font-family:Sora,sans-serif;resize:vertical;outline:none;line-height:1.6';
  textarea.onfocus = function() { textarea.style.borderColor = 'rgba(6,182,212,0.3)'; };
  textarea.onblur = function() { textarea.style.borderColor = 'rgba(255,255,255,0.06)'; };
  card.appendChild(textarea);

  var actions = document.createElement('div');
  actions.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;margin-top:12px';
  actions.innerHTML = '<button onclick="this.closest(\'div[style*=fixed]\').querySelector(\'textarea\').value=\'\'" style="font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--error);background:none;border:1px solid rgba(239,68,68,0.2);border-radius:4px;padding:6px 12px;cursor:pointer;font-family:Sora,sans-serif">Clear</button>';

  var saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save';
  saveBtn.style.cssText = 'font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent-cyan);background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.2);border-radius:4px;padding:6px 16px;cursor:pointer;font-family:Sora,sans-serif';
  saveBtn.onclick = function() { save(); overlay.remove(); };
  actions.appendChild(saveBtn);
  card.appendChild(actions);

  function save() {
    var val = textarea.value.trim();
    if (val) {
      _exerciseCoachingNotes[exerciseName] = val;
    } else {
      delete _exerciseCoachingNotes[exerciseName];
    }
    saveCoachingNotes();
    toast(val ? 'Notes saved for ' + exerciseName : 'Notes cleared');
  }

  overlay.appendChild(card);
  document.body.appendChild(overlay);
  textarea.focus();
}

/* Show coaching notes indicator on clips that have notes */
function updateCoachingNoteIndicators() {
  loadCoachingNotes();
  document.querySelectorAll('.clip').forEach(function(c) {
    var name = c.getAttribute('data-exercise');
    var existing = c.querySelector('.coaching-note-dot');
    if (_exerciseCoachingNotes[name]) {
      if (!existing) {
        var dot = document.createElement('div');
        dot.className = 'coaching-note-dot';
        dot.style.cssText = 'position:absolute;top:2px;left:4px;width:4px;height:4px;border-radius:50%;background:var(--accent-cyan);z-index:3;opacity:0.6';
        dot.title = 'Has coaching notes';
        c.appendChild(dot);
      }
    } else if (existing) {
      existing.remove();
    }
  });
}

/* Load on init */
(function() {
  loadCoachingNotes();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() { setTimeout(updateCoachingNoteIndicators, 1000); });
  } else {
    setTimeout(updateCoachingNoteIndicators, 1000);
  }
})();

/* ===== BATCH 311: EXERCISE REFERENCE URLS ===== */
var _exerciseRefs = {};

function loadExerciseRefs() {
  try { _exerciseRefs = JSON.parse(localStorage.getItem('sms_exercise_refs') || '{}'); } catch(e) { _exerciseRefs = {}; }
}

function saveExerciseRefs() {
  try { localStorage.setItem('sms_exercise_refs', JSON.stringify(_exerciseRefs)); } catch(e) {}
}

function setExerciseRef(exerciseName) {
  if (!exerciseName) { toast('Select a clip first'); return; }
  loadExerciseRefs();
  var current = _exerciseRefs[exerciseName] || '';
  var url = prompt('Video/photo reference URL for ' + exerciseName + ':', current);
  if (url === null) return;
  url = url.trim();
  if (url) {
    _exerciseRefs[exerciseName] = url;
    toast('Reference saved');
  } else {
    delete _exerciseRefs[exerciseName];
    toast('Reference cleared');
  }
  saveExerciseRefs();
}

function openExerciseRef(exerciseName) {
  loadExerciseRefs();
  var url = _exerciseRefs[exerciseName];
  if (!url) { toast('No reference URL set. Use "Set Reference URL" command.'); return; }
  window.open(url, '_blank');
  toast('Opening reference');
}

/* Load on init */
(function() { loadExerciseRefs(); })();

/* ===== BATCH 312: DARK MODE INTENSITY ===== */
var _darkModeLevel = 'standard'; /* dim, standard, high */

function loadDarkModeLevel() {
  try { _darkModeLevel = localStorage.getItem('sms_dark_mode') || 'standard'; } catch(e) {}
}

function saveDarkModeLevel() {
  try { localStorage.setItem('sms_dark_mode', _darkModeLevel); } catch(e) {}
}

function setDarkModeIntensity(level) {
  _darkModeLevel = level;
  saveDarkModeLevel();
  applyDarkMode();
  toast('Theme: ' + level);
}

function cycleDarkMode() {
  var levels = ['dim', 'standard', 'high'];
  var idx = levels.indexOf(_darkModeLevel);
  idx = (idx + 1) % levels.length;
  setDarkModeIntensity(levels[idx]);
}

function applyDarkMode() {
  var root = document.documentElement;
  if (_darkModeLevel === 'dim') {
    root.style.setProperty('--bg', '#020408');
    root.style.setProperty('--bg-deep', '#010204');
    root.style.setProperty('--surface', '#060a12');
    root.style.setProperty('--surface2', '#080c14');
    root.style.setProperty('--text', '#b0b8c8');
    root.style.setProperty('--text-bright', '#d0d8e8');
    root.style.setProperty('--text-secondary', '#6b7585');
  } else if (_darkModeLevel === 'high') {
    root.style.setProperty('--bg', '#080c18');
    root.style.setProperty('--bg-deep', '#050911');
    root.style.setProperty('--surface', '#0e1424');
    root.style.setProperty('--surface2', '#121a2c');
    root.style.setProperty('--text', '#f0f4fa');
    root.style.setProperty('--text-bright', '#ffffff');
    root.style.setProperty('--text-secondary', '#a0aab8');
    root.style.setProperty('--border', 'rgba(255,255,255,0.1)');
  } else {
    /* Standard — reset to defaults */
    root.style.setProperty('--bg', '#050711');
    root.style.setProperty('--bg-deep', '#030509');
    root.style.setProperty('--surface', '#0a0e1a');
    root.style.setProperty('--surface2', '#0d1117');
    root.style.setProperty('--text', '#e2e8f0');
    root.style.setProperty('--text-bright', '#ffffff');
    root.style.setProperty('--text-secondary', '#8b94a5');
    root.style.setProperty('--border', 'rgba(255,255,255,0.06)');
  }
}

/* Apply on load */
(function() {
  loadDarkModeLevel();
  if (_darkModeLevel !== 'standard') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyDarkMode);
    } else {
      applyDarkMode();
    }
  }
})();

/* ===== BATCH 313: WORKOUT COMPARISON OVERLAY ===== */
function showWorkoutComparison() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  if (saved.length === 0) { toast('No saved workouts to compare with'); return; }

  /* Get current workout data */
  var currentClips = [];
  document.querySelectorAll('.clip').forEach(function(c) {
    currentClips.push({
      exercise: c.getAttribute('data-exercise') || '',
      family: c.getAttribute('data-family') || '',
      sets: parseInt(c.getAttribute('data-sets')) || 3,
      reps: parseInt(c.getAttribute('data-reps')) || 8,
      rpe: parseInt(c.getAttribute('data-rpe')) || 7
    });
  });

  /* Pick most recent saved workout for comparison */
  var compareWith = saved[saved.length - 1];
  var compareClips = [];
  if (compareWith.clips) {
    compareWith.clips.forEach(function(c) {
      compareClips.push({
        exercise: c.exercise || c.getAttribute && c.getAttribute('data-exercise') || '',
        family: c.family || '',
        sets: parseInt(c.sets) || 3,
        reps: parseInt(c.reps) || 8,
        rpe: parseInt(c.rpe) || 7
      });
    });
  }

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(3,5,9,0.85);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);cursor:pointer;padding:20px';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.98);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;max-width:600px;width:95%;max-height:80vh;overflow-y:auto;cursor:default;box-shadow:0 25px 80px rgba(0,0,0,0.6)';
  card.onclick = function(e) { e.stopPropagation(); };

  var html = '<div style="text-align:center;margin-bottom:16px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Side by Side</div><div style="font-size:16px;font-weight:700;color:#fff">Workout Comparison</div></div>';

  /* Two columns */
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">';

  /* Current */
  html += '<div><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent-green);margin-bottom:8px;text-align:center">Current (' + currentClips.length + ' exercises)</div>';
  var currentFamilies = {};
  var currentTotalSets = 0;
  currentClips.forEach(function(c) { currentFamilies[c.family] = (currentFamilies[c.family]||0)+1; currentTotalSets += c.sets; });
  html += '<div style="font-size:10px;color:var(--text-secondary);text-align:center;margin-bottom:8px">' + currentTotalSets + ' total sets</div>';
  currentClips.forEach(function(c) {
    var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6'};
    html += '<div style="padding:4px 8px;margin-bottom:2px;border-left:2px solid ' + (famColors[c.family]||'#06b6d4') + ';font-size:10px;color:var(--text-secondary)">' + c.exercise + ' <span style="color:var(--micro);font-size:8px">' + c.sets + 'x' + c.reps + ' R' + c.rpe + '</span></div>';
  });
  html += '</div>';

  /* Saved */
  html += '<div><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent-blue);margin-bottom:8px;text-align:center">Saved: ' + (compareWith.name||'Untitled') + ' (' + compareClips.length + ')</div>';
  var savedTotalSets = 0;
  compareClips.forEach(function(c) { savedTotalSets += c.sets; });
  html += '<div style="font-size:10px;color:var(--text-secondary);text-align:center;margin-bottom:8px">' + savedTotalSets + ' total sets</div>';
  compareClips.forEach(function(c) {
    var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6'};
    html += '<div style="padding:4px 8px;margin-bottom:2px;border-left:2px solid ' + (famColors[c.family]||'#06b6d4') + ';font-size:10px;color:var(--text-secondary)">' + c.exercise + ' <span style="color:var(--micro);font-size:8px">' + c.sets + 'x' + c.reps + ' R' + c.rpe + '</span></div>';
  });
  html += '</div></div>';

  /* Diff summary */
  var added = currentClips.filter(function(c) { return !compareClips.some(function(cc) { return cc.exercise === c.exercise; }); });
  var removed = compareClips.filter(function(c) { return !currentClips.some(function(cc) { return cc.exercise === c.exercise; }); });
  if (added.length > 0 || removed.length > 0) {
    html += '<div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06)">';
    if (added.length > 0) html += '<div style="font-size:9px;color:var(--accent-green);margin-bottom:4px">+ Added: ' + added.map(function(a){return a.exercise;}).join(', ') + '</div>';
    if (removed.length > 0) html += '<div style="font-size:9px;color:var(--accent-red)">- Removed: ' + removed.map(function(r){return r.exercise;}).join(', ') + '</div>';
    html += '</div>';
  }

  html += '<div style="text-align:center;margin-top:16px"><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);background:none;border:1px solid var(--border);border-radius:4px;padding:8px 20px;cursor:pointer;font-family:Sora,sans-serif">Close</button></div>';

  card.innerHTML = html;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

/* ===== BATCH 314: EXERCISE PROGRESSION TREE ===== */
function showProgressionTree() {
  if (typeof EXERCISES === 'undefined') { toast('Exercise database not loaded'); return; }

  /* Group by pattern */
  var patterns = {};
  EXERCISES.forEach(function(ex) {
    if (!ex.pattern) return;
    if (!patterns[ex.pattern]) patterns[ex.pattern] = [];
    patterns[ex.pattern].push(ex);
  });

  var html = '<div style="max-width:700px;margin:0 auto;padding:24px">';
  html += '<div style="text-align:center;margin-bottom:24px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Progressions</div><div style="font-size:20px;font-weight:700;color:#fff">Exercise Tree</div><div style="font-size:10px;color:var(--text-secondary);margin-top:4px">Click any exercise to see its progression path</div></div>';

  var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6',Flow:'#ec4899'};

  for (var pat in patterns) {
    var exercises = patterns[pat];
    /* Sort by stage */
    exercises.sort(function(a, b) { return (a.stage || 1) - (b.stage || 1); });
    var fam = exercises[0] ? exercises[0].family : '';
    var col = famColors[fam] || '#06b6d4';

    html += '<div style="margin-bottom:20px;padding:16px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04)">';
    html += '<div style="font-size:11px;font-weight:600;color:' + col + ';margin-bottom:12px;text-transform:uppercase;letter-spacing:0.06em">' + pat + ' <span style="font-size:8px;color:var(--micro);font-weight:400;text-transform:none">(' + fam + ')</span></div>';

    /* Tree branches by stage */
    var stages = {1: [], 2: [], 3: []};
    exercises.forEach(function(ex) { var s = ex.stage || 1; if (!stages[s]) stages[s] = []; stages[s].push(ex); });

    html += '<div style="display:flex;gap:16px;align-items:flex-start">';
    [1, 2, 3].forEach(function(s) {
      html += '<div style="flex:1">';
      html += '<div style="font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);margin-bottom:6px;text-align:center">Stage ' + s + '</div>';
      if (stages[s].length === 0) {
        html += '<div style="padding:8px;text-align:center;font-size:9px;color:rgba(255,255,255,0.1)">-</div>';
      }
      stages[s].forEach(function(ex) {
        html += '<div style="padding:6px 8px;margin-bottom:3px;border-radius:4px;background:rgba(' + hexToRgbLocal(col) + ',0.08);border:1px solid rgba(' + hexToRgbLocal(col) + ',0.15);text-align:center">';
        html += '<div style="font-size:10px;font-weight:500;color:#fff">' + ex.name + '</div>';
        html += '<div style="font-size:7px;color:var(--micro)">' + (ex.discipline || '') + '</div>';
        html += '</div>';
      });
      html += '</div>';
      if (s < 3) html += '<div style="padding-top:24px;color:rgba(255,255,255,0.15);font-size:16px">&#8594;</div>';
    });
    html += '</div></div>';
  }
  html += '</div>';

  function hexToRgbLocal(hex) {
    var r = parseInt(hex.slice(1,3),16);
    var g = parseInt(hex.slice(3,5),16);
    var b = parseInt(hex.slice(5,7),16);
    return r+','+g+','+b;
  }

  var w = window.open('', '_blank');
  if (!w) { toast('Enable popups'); return; }
  w.document.write('<!DOCTYPE html><html><head><title>Progression Tree - Saturno Movement Studio</title><link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"><style>*{box-sizing:border-box;margin:0;padding:0}body{background:#050711;color:#e2e8f0;font-family:Sora,sans-serif;padding:40px 20px}</style></head><body>' + html + '</body></html>');
  w.document.close();
  toast('Progression tree opened');
}

/* ===== BATCH 315: TRAINING VOLUME ESTIMATOR ===== */
function showVolumeEstimate() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add exercises first'); return; }

  var data = {};
  clips.forEach(function(c) {
    var name = c.getAttribute('data-exercise') || 'Unknown';
    var fam = c.getAttribute('data-family') || 'Unknown';
    var sets = parseInt(c.getAttribute('data-sets')) || 3;
    var reps = parseInt(c.getAttribute('data-reps')) || 8;
    var rpe = parseInt(c.getAttribute('data-rpe')) || 7;
    var tempo = parseFloat(c.getAttribute('data-tempo')) || 3;

    if (!data[fam]) data[fam] = { exercises: [], totalSets: 0, totalReps: 0, totalTUT: 0 };
    data[fam].totalSets += sets;
    data[fam].totalReps += sets * reps;
    data[fam].totalTUT += sets * reps * tempo;
    data[fam].exercises.push({ name: name, sets: sets, reps: reps, rpe: rpe, volume: sets * reps, tut: sets * reps * tempo });
  });

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:300;background:rgba(3,5,9,0.85);display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);cursor:pointer;padding:20px';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  var card = document.createElement('div');
  card.style.cssText = 'background:rgba(10,14,26,0.98);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:24px;max-width:500px;width:95%;max-height:80vh;overflow-y:auto;cursor:default;box-shadow:0 25px 80px rgba(0,0,0,0.6)';
  card.onclick = function(e) { e.stopPropagation(); };

  var totalSets = 0, totalReps = 0, totalTUT = 0;
  for (var f in data) { totalSets += data[f].totalSets; totalReps += data[f].totalReps; totalTUT += data[f].totalTUT; }

  var html = '<div style="text-align:center;margin-bottom:16px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:var(--accent-cyan);margin-bottom:4px">Training Volume</div><div style="font-size:18px;font-weight:700;color:#fff">Volume Breakdown</div></div>';

  /* Global stats */
  html += '<div style="display:flex;justify-content:center;gap:24px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.06)">';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent-cyan)">' + totalSets + '</div><div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro)">Total Sets</div></div>';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent-blue)">' + totalReps + '</div><div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro)">Total Reps</div></div>';
  html += '<div style="text-align:center"><div style="font-size:22px;font-weight:700;color:var(--accent-purple)">' + Math.round(totalTUT) + 's</div><div style="font-size:7px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro)">Total TUT</div></div>';
  html += '</div>';

  /* Per-family breakdown */
  var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6',Flow:'#ec4899'};
  for (var fam in data) {
    var fd = data[fam];
    var col = famColors[fam] || '#06b6d4';
    html += '<div style="margin-bottom:12px;padding:10px;border-radius:6px;background:rgba(255,255,255,0.02);border-left:3px solid ' + col + '">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    html += '<div style="font-size:11px;font-weight:600;color:' + col + '">' + fam + '</div>';
    html += '<div style="font-size:9px;color:var(--text-secondary)">' + fd.totalSets + ' sets | ' + fd.totalReps + ' reps | ' + Math.round(fd.totalTUT) + 's TUT</div>';
    html += '</div>';
    fd.exercises.forEach(function(ex) {
      html += '<div style="display:flex;justify-content:space-between;padding:3px 0;font-size:10px;color:var(--muted)">';
      html += '<span>' + ex.name + '</span>';
      html += '<span style="font-size:8px;color:var(--micro)">' + ex.sets + 'x' + ex.reps + ' = ' + ex.volume + ' reps (' + Math.round(ex.tut) + 's)</span>';
      html += '</div>';
    });
    html += '</div>';
  }

  /* Recommendations */
  html += '<div style="margin-top:12px;padding:10px;border-radius:6px;background:rgba(6,182,212,0.04);border:1px solid rgba(6,182,212,0.1)">';
  html += '<div style="font-size:8px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent-cyan);margin-bottom:4px">Volume Guidelines</div>';
  var guidelines = [];
  for (var fg in data) {
    if (data[fg].totalSets < 6) guidelines.push(fg + ': ' + data[fg].totalSets + ' sets (low, aim for 10-20)');
    else if (data[fg].totalSets > 25) guidelines.push(fg + ': ' + data[fg].totalSets + ' sets (high, consider reducing)');
    else guidelines.push(fg + ': ' + data[fg].totalSets + ' sets (good range)');
  }
  guidelines.forEach(function(g) {
    html += '<div style="font-size:9px;color:var(--text-secondary);padding:2px 0">' + g + '</div>';
  });
  html += '</div>';

  html += '<div style="text-align:center;margin-top:16px"><button onclick="this.closest(\'div[style*=fixed]\').remove()" style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--micro);background:none;border:1px solid var(--border);border-radius:4px;padding:8px 20px;cursor:pointer;font-family:Sora,sans-serif">Close</button></div>';

  card.innerHTML = html;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

/* ===== BATCH 316: WARM-UP/COOLDOWN AUTO-DETECTION ===== */
function autoDetectPhases() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length < 3) { toast('Need at least 3 exercises'); return; }

  /* Sort by position */
  clips.sort(function(a, b) { return (parseFloat(a.style.left) || 0) - (parseFloat(b.style.left) || 0); });

  var warmupCount = Math.max(1, Math.floor(clips.length * 0.15));
  var cooldownCount = Math.max(1, Math.floor(clips.length * 0.15));

  clips.forEach(function(c, i) {
    /* Remove existing phase tags */
    var existing = c.querySelector('.phase-tag');
    if (existing) existing.remove();

    var phase = '';
    var color = '';
    if (i < warmupCount) {
      phase = 'W';
      color = 'rgba(34,197,94,0.6)';
    } else if (i >= clips.length - cooldownCount) {
      phase = 'C';
      color = 'rgba(99,102,241,0.6)';
    } else {
      phase = 'M';
      color = 'rgba(59,130,246,0.3)';
    }

    var tag = document.createElement('div');
    tag.className = 'phase-tag';
    tag.style.cssText = 'position:absolute;top:1px;left:50%;transform:translateX(-50%);font-size:6px;font-weight:700;color:' + color + ';z-index:3;text-transform:uppercase;letter-spacing:0.1em;pointer-events:none';
    tag.textContent = phase;
    c.appendChild(tag);
  });

  toast('Phases detected: ' + warmupCount + ' warmup, ' + (clips.length - warmupCount - cooldownCount) + ' main, ' + cooldownCount + ' cooldown');
}

function clearPhaseMarkers() {
  document.querySelectorAll('.phase-tag').forEach(function(t) { t.remove(); });
  toast('Phase markers cleared');
}

/* ===== BATCH 317: COMPREHENSIVE SESSION EXPORT ===== */
function exportSessionNotes() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add exercises first'); return; }

  loadCoachingNotes();
  loadExerciseRefs();

  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Untitled';
  var bpm = document.getElementById('bpm-input') ? document.getElementById('bpm-input').value : '120';
  var mode = document.getElementById('bpm-mode') ? document.getElementById('bpm-mode').textContent : 'Standard';
  var globalNotes = '';
  try { var s = JSON.parse(localStorage.getItem('sms_session') || '{}'); globalNotes = s.workoutNotes || ''; } catch(e) {}

  var html = '<!DOCTYPE html><html><head><title>' + workoutName + ' - Session Notes</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">';
  html += '<style>';
  html += '*{box-sizing:border-box;margin:0;padding:0}';
  html += 'body{background:#050711;color:#e2e8f0;font-family:Sora,sans-serif;padding:40px 20px;max-width:600px;margin:0 auto;line-height:1.6}';
  html += 'h1{font-size:20px;font-weight:700;margin-bottom:4px}';
  html += '.meta{font-size:10px;color:#8b94a5;margin-bottom:20px}';
  html += '.section{margin-bottom:24px;padding:16px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)}';
  html += '.section-title{font-size:9px;text-transform:uppercase;letter-spacing:0.15em;color:#06b6d4;margin-bottom:8px}';
  html += '.exercise{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04)}';
  html += '.exercise:last-child{border-bottom:none}';
  html += '.ex-name{font-size:13px;font-weight:600;color:#fff}';
  html += '.ex-params{font-size:10px;color:#8b94a5;margin-top:2px}';
  html += '.ex-notes{font-size:11px;color:#b0b8c8;margin-top:6px;padding:8px;background:rgba(6,182,212,0.04);border-left:2px solid rgba(6,182,212,0.2);border-radius:0 4px 4px 0}';
  html += '.ex-ref{font-size:9px;color:#3b82f6;margin-top:4px}';
  html += '.global-notes{font-size:11px;color:#b0b8c8;white-space:pre-wrap}';
  html += '@media print{body{background:#fff;color:#111}.section{background:#f8f9fa;border-color:#e2e8f0}.ex-name{color:#111}.ex-params{color:#555}.meta{color:#888}}';
  html += '</style></head><body>';

  html += '<h1>' + workoutName + '</h1>';
  html += '<div class="meta">' + bpm + ' BPM | ' + mode + ' | ' + clips.length + ' exercises | ' + new Date().toLocaleDateString('en-US', {month:'long',day:'numeric',year:'numeric'}) + '</div>';

  if (globalNotes) {
    html += '<div class="section"><div class="section-title">Workout Notes</div><div class="global-notes">' + globalNotes.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') + '</div></div>';
  }

  /* Group by family */
  var families = {};
  clips.forEach(function(c) {
    var fam = c.getAttribute('data-family') || 'Other';
    if (!families[fam]) families[fam] = [];
    families[fam].push({
      name: c.getAttribute('data-exercise') || 'Unknown',
      pattern: c.getAttribute('data-pattern') || '',
      stage: c.getAttribute('data-stage') || '1',
      sets: c.getAttribute('data-sets') || '3',
      reps: c.getAttribute('data-reps') || '8',
      rpe: c.getAttribute('data-rpe') || '7',
      tempo: c.getAttribute('data-tempo') || '3',
      rest: c.getAttribute('data-rest') || '60'
    });
  });

  for (var fam in families) {
    html += '<div class="section"><div class="section-title">' + fam + ' (' + families[fam].length + ')</div>';
    families[fam].forEach(function(ex) {
      html += '<div class="exercise">';
      html += '<div class="ex-name">' + ex.name + '</div>';
      html += '<div class="ex-params">' + ex.sets + 'x' + ex.reps + ' | RPE ' + ex.rpe + ' | ' + ex.tempo + 's tempo | ' + ex.rest + 's rest | S' + ex.stage + ' | ' + ex.pattern + '</div>';
      if (_exerciseCoachingNotes[ex.name]) {
        html += '<div class="ex-notes">' + _exerciseCoachingNotes[ex.name].replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') + '</div>';
      }
      if (_exerciseRefs[ex.name]) {
        html += '<div class="ex-ref"><a href="' + _exerciseRefs[ex.name] + '" target="_blank" style="color:#3b82f6;text-decoration:none">Reference Video</a></div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }

  html += '<div style="text-align:center;margin-top:24px;font-size:8px;color:rgba(255,255,255,0.1);text-transform:uppercase;letter-spacing:0.2em">Generated by Saturno Movement Studio</div>';
  html += '</body></html>';

  var w = window.open('', '_blank');
  if (!w) { toast('Enable popups'); return; }
  w.document.write(html);
  w.document.close();
  toast('Session notes exported');
}

/* ===== BATCH 318: PLAYLIST MODE ===== */
var _playlistMode = false;
var _playlistIndex = 0;
var _playlistExercises = [];
var _playlistOverlay = null;

function startPlaylistMode() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('Add exercises first'); return; }

  /* Sort by track order then position */
  var trackOrder = ['push','pull','core','legs','skills'];
  clips.sort(function(a, b) {
    var ta = a.closest('.track') ? trackOrder.indexOf(a.closest('.track').getAttribute('data-track')) : 99;
    var tb = b.closest('.track') ? trackOrder.indexOf(b.closest('.track').getAttribute('data-track')) : 99;
    if (ta !== tb) return ta - tb;
    return (parseFloat(a.style.left) || 0) - (parseFloat(b.style.left) || 0);
  });

  _playlistExercises = clips.map(function(c) {
    return {
      name: c.getAttribute('data-exercise') || 'Unknown',
      family: c.getAttribute('data-family') || '',
      sets: parseInt(c.getAttribute('data-sets')) || 3,
      reps: parseInt(c.getAttribute('data-reps')) || 8,
      rpe: parseInt(c.getAttribute('data-rpe')) || 7,
      tempo: parseFloat(c.getAttribute('data-tempo')) || 3,
      rest: parseInt(c.getAttribute('data-rest')) || 60,
      clip: c
    };
  });

  _playlistMode = true;
  _playlistIndex = 0;
  showPlaylistExercise();
}

function showPlaylistExercise() {
  if (_playlistIndex >= _playlistExercises.length) {
    stopPlaylistMode();
    toast('Playlist complete!');
    haptic('heavy');
    return;
  }

  var ex = _playlistExercises[_playlistIndex];
  var famColors = {Push:'#3b82f6',Pull:'#22c55e',Core:'#f97316',Legs:'#ef4444',Skills:'#8b5cf6',Flow:'#ec4899'};
  var col = famColors[ex.family] || '#06b6d4';

  if (_playlistOverlay) _playlistOverlay.remove();
  _playlistOverlay = document.createElement('div');
  _playlistOverlay.style.cssText = 'position:fixed;inset:0;z-index:500;background:rgba(5,7,17,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)';

  var html = '<div style="text-align:center;max-width:400px;padding:20px">';
  html += '<div style="font-size:9px;text-transform:uppercase;letter-spacing:0.2em;color:' + col + ';margin-bottom:4px">' + ex.family + ' | Exercise ' + (_playlistIndex + 1) + '/' + _playlistExercises.length + '</div>';
  html += '<div style="font-size:32px;font-weight:800;color:#fff;margin-bottom:8px">' + ex.name + '</div>';
  html += '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:24px">' + ex.sets + ' sets x ' + ex.reps + ' reps | RPE ' + ex.rpe + ' | ' + ex.tempo + 's per rep</div>';

  /* Progress bar */
  var pct = Math.round(((_playlistIndex + 1) / _playlistExercises.length) * 100);
  html += '<div style="width:200px;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;margin:0 auto 24px;overflow:hidden"><div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:2px;transition:width 0.3s"></div></div>';

  /* Buttons */
  html += '<div style="display:flex;gap:12px;justify-content:center">';
  html += '<button onclick="playlistPrev()" style="padding:12px 24px;border:1px solid rgba(255,255,255,0.1);border-radius:6px;background:none;color:var(--text-secondary);font-size:10px;text-transform:uppercase;letter-spacing:0.08em;cursor:pointer;font-family:Sora,sans-serif;min-width:80px;-webkit-tap-highlight-color:transparent">Prev</button>';
  html += '<button onclick="playlistRest()" style="padding:12px 24px;border:1px solid rgba(6,182,212,0.3);border-radius:6px;background:rgba(6,182,212,0.1);color:var(--accent-cyan);font-size:10px;text-transform:uppercase;letter-spacing:0.08em;cursor:pointer;font-family:Sora,sans-serif;min-width:80px;-webkit-tap-highlight-color:transparent">Rest ' + ex.rest + 's</button>';
  html += '<button onclick="playlistNext()" style="padding:12px 24px;border:1px solid rgba(34,197,94,0.3);border-radius:6px;background:rgba(34,197,94,0.1);color:var(--accent-green);font-size:10px;text-transform:uppercase;letter-spacing:0.08em;cursor:pointer;font-family:Sora,sans-serif;min-width:80px;-webkit-tap-highlight-color:transparent">Next</button>';
  html += '</div>';
  html += '<button onclick="stopPlaylistMode()" style="margin-top:16px;padding:8px 16px;border:none;background:none;color:var(--micro);font-size:8px;text-transform:uppercase;letter-spacing:0.1em;cursor:pointer;font-family:Sora,sans-serif;-webkit-tap-highlight-color:transparent">Exit Playlist</button>';
  html += '</div>';

  _playlistOverlay.innerHTML = html;
  document.body.appendChild(_playlistOverlay);
  haptic('medium');

  /* Highlight the corresponding clip */
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  if (ex.clip) ex.clip.classList.add('selected');
}

function playlistNext() {
  _playlistIndex++;
  showPlaylistExercise();
}

function playlistPrev() {
  if (_playlistIndex > 0) _playlistIndex--;
  showPlaylistExercise();
}

function playlistRest() {
  var ex = _playlistExercises[_playlistIndex];
  var restTime = ex ? ex.rest : 60;
  startRestTimer(restTime);
  /* Auto-advance after rest */
  setTimeout(function() {
    if (_playlistMode) playlistNext();
  }, (restTime + 1) * 1000);
}

function stopPlaylistMode() {
  _playlistMode = false;
  if (_playlistOverlay) { _playlistOverlay.remove(); _playlistOverlay = null; }
  stopRestTimer();
}

// Batch 319: Workout Flow Visualizer
function showWorkoutFlow() {
  var clips = Array.from(document.querySelectorAll('.clip')).sort(function(a, b) {
    var tA = parseInt(a.closest('.track-lane') ? a.closest('.track-lane').dataset.track : '0');
    var tB = parseInt(b.closest('.track-lane') ? b.closest('.track-lane').dataset.track : '0');
    if (tA !== tB) return tA - tB;
    return parseFloat(a.style.left) - parseFloat(b.style.left);
  });
  if (clips.length < 2) { showToast('Need 2+ clips for flow'); return; }
  var nodes = [];
  var seen = {};
  clips.forEach(function(c) {
    var name = c.dataset.exercise || c.textContent.trim().split('\n')[0];
    var fam = c.dataset.family || 'core';
    if (!seen[name]) { seen[name] = { name: name, family: fam, count: 0 }; nodes.push(seen[name]); }
    seen[name].count++;
  });
  var edges = [];
  for (var i = 0; i < clips.length - 1; i++) {
    var from = clips[i].dataset.exercise || clips[i].textContent.trim().split('\n')[0];
    var to = clips[i + 1].dataset.exercise || clips[i + 1].textContent.trim().split('\n')[0];
    if (from !== to) {
      var key = from + '->' + to;
      var found = false;
      for (var e = 0; e < edges.length; e++) { if (edges[e].key === key) { edges[e].weight++; found = true; break; } }
      if (!found) edges.push({ from: from, to: to, key: key, weight: 1 });
    }
  }
  var famColors = { push: '#f87171', pull: '#60a5fa', core: '#fbbf24', legs: '#4ade80', skills: '#c084fc', flow: '#22d3ee' };
  var w = 900, h = 600, cx = w / 2, cy = h / 2;
  var angleStep = (2 * Math.PI) / nodes.length;
  var radius = Math.min(w, h) * 0.35;
  nodes.forEach(function(n, idx) {
    n.x = cx + Math.cos(idx * angleStep - Math.PI / 2) * radius;
    n.y = cy + Math.sin(idx * angleStep - Math.PI / 2) * radius;
  });
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' + w + ' ' + h + '" style="background:#050711">';
  svg += '<text x="' + cx + '" y="30" text-anchor="middle" fill="#e2e8f0" font-family="Sora,sans-serif" font-size="16">Workout Flow</text>';
  var nodeMap = {};
  nodes.forEach(function(n) { nodeMap[n.name] = n; });
  edges.forEach(function(ed) {
    var a = nodeMap[ed.from], b = nodeMap[ed.to];
    if (a && b) {
      var opacity = Math.min(0.3 + ed.weight * 0.2, 1);
      svg += '<line x1="' + a.x + '" y1="' + a.y + '" x2="' + b.x + '" y2="' + b.y + '" stroke="#22d3ee" stroke-opacity="' + opacity + '" stroke-width="' + (1 + ed.weight) + '"/>';
      var mx = (a.x + b.x) / 2, my = (a.y + b.y) / 2;
      var dx = b.x - a.x, dy = b.y - a.y, len = Math.sqrt(dx * dx + dy * dy) || 1;
      var ax = dx / len, ay = dy / len;
      svg += '<polygon points="' + (mx + ax * 8) + ',' + (my + ay * 8) + ' ' + (mx - ax * 4 - ay * 4) + ',' + (my - ay * 4 + ax * 4) + ' ' + (mx - ax * 4 + ay * 4) + ',' + (my - ay * 4 - ax * 4) + '" fill="#22d3ee" fill-opacity="' + opacity + '"/>';
    }
  });
  nodes.forEach(function(n) {
    var col = famColors[n.family] || '#94a3b8';
    var r = 18 + n.count * 4;
    svg += '<circle cx="' + n.x + '" cy="' + n.y + '" r="' + r + '" fill="' + col + '" fill-opacity="0.15" stroke="' + col + '" stroke-width="2"/>';
    svg += '<text x="' + n.x + '" y="' + (n.y + 4) + '" text-anchor="middle" fill="' + col + '" font-family="Sora,sans-serif" font-size="9" font-weight="600">' + (n.name.length > 14 ? n.name.slice(0, 12) + '..' : n.name) + '</text>';
    svg += '<text x="' + n.x + '" y="' + (n.y + r + 14) + '" text-anchor="middle" fill="#64748b" font-family="Sora,sans-serif" font-size="8">' + n.count + 'x</text>';
  });
  svg += '</svg>';
  var tab = window.open('', '_blank');
  if (tab) { tab.document.write('<html><head><title>Workout Flow</title></head><body style="margin:0;background:#050711;display:flex;align-items:center;justify-content:center;min-height:100vh">' + svg + '</body></html>'); tab.document.close(); }
}

// Batch 320: Smart Rest Suggestions
function suggestRest() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips to analyze'); return; }
  var suggestions = [];
  clips.forEach(function(c) {
    var name = c.dataset.exercise || c.textContent.trim().split('\n')[0];
    var fam = c.dataset.family || 'core';
    var rpe = parseInt(c.dataset.rpe) || 7;
    var sets = parseInt(c.dataset.sets) || 3;
    var currentRest = parseInt(c.dataset.rest) || 60;
    var suggestedRest;
    if (rpe >= 9) suggestedRest = 180;
    else if (rpe >= 8) suggestedRest = 120;
    else if (rpe >= 7) suggestedRest = 90;
    else if (rpe >= 6) suggestedRest = 60;
    else suggestedRest = 45;
    if (fam === 'legs' || fam === 'push') suggestedRest = Math.round(suggestedRest * 1.15);
    if (fam === 'core' || fam === 'flow') suggestedRest = Math.round(suggestedRest * 0.8);
    if (sets >= 5) suggestedRest += 15;
    var diff = suggestedRest - currentRest;
    suggestions.push({ name: name, family: fam, rpe: rpe, currentRest: currentRest, suggestedRest: suggestedRest, diff: diff, clip: c });
  });
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="color:#e2e8f0;font-size:14px;font-weight:600">Smart Rest Suggestions</span>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:18px;font-family:Sora,sans-serif">X</button></div>';
  html += '<p style="color:#94a3b8;font-size:10px;margin:0 0 16px">Based on RPE, family, and set count</p>';
  var needsChange = suggestions.filter(function(s) { return Math.abs(s.diff) >= 15; });
  if (!needsChange.length) {
    html += '<p style="color:#4ade80;font-size:12px;text-align:center;padding:20px 0">All rest periods look good!</p>';
  } else {
    needsChange.forEach(function(s, idx) {
      var diffColor = s.diff > 0 ? '#f87171' : '#4ade80';
      var arrow = s.diff > 0 ? '+' : '';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
      html += '<div><span style="color:#e2e8f0;font-size:11px">' + s.name + '</span>';
      html += '<span style="color:#64748b;font-size:9px;margin-left:8px">RPE ' + s.rpe + '</span></div>';
      html += '<div style="text-align:right"><span style="color:#94a3b8;font-size:10px">' + s.currentRest + 's</span>';
      html += '<span style="color:#64748b;font-size:10px;margin:0 4px">-></span>';
      html += '<span style="color:#22d3ee;font-size:10px;font-weight:600">' + s.suggestedRest + 's</span>';
      html += '<span style="color:' + diffColor + ';font-size:9px;margin-left:6px">(' + arrow + s.diff + 's)</span></div></div>';
    });
    html += '<button onclick="applyRestSuggestions()" style="width:100%;margin-top:16px;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Apply All Suggestions</button>';
  }
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
  window._restSuggestions = suggestions;
}
function applyRestSuggestions() {
  if (!window._restSuggestions) return;
  if (typeof captureUndo === 'function') captureUndo();
  var applied = 0;
  window._restSuggestions.forEach(function(s) {
    if (Math.abs(s.diff) >= 15 && s.clip && !s.clip.classList.contains('clip-locked')) {
      s.clip.dataset.rest = s.suggestedRest;
      applied++;
    }
  });
  var modal = document.querySelector('div[style*="fixed"][style*="9999"]');
  if (modal) modal.remove();
  showToast('Applied rest to ' + applied + ' clips');
  window._restSuggestions = null;
}

// Batch 321: Workout Snapshot History
var _snapshotHistory = [];
function takeWorkoutSnapshot(label) {
  var clips = document.querySelectorAll('.clip');
  var data = [];
  clips.forEach(function(c) {
    data.push({
      exercise: c.dataset.exercise || c.textContent.trim().split('\n')[0],
      family: c.dataset.family || '',
      track: c.closest('.track-lane') ? c.closest('.track-lane').dataset.track : '',
      left: c.style.left,
      width: c.style.width,
      sets: c.dataset.sets || '3',
      reps: c.dataset.reps || '8',
      rpe: c.dataset.rpe || '7',
      rest: c.dataset.rest || '60'
    });
  });
  var bpm = typeof _bpm !== 'undefined' ? _bpm : 100;
  _snapshotHistory.push({
    label: label || 'Snapshot ' + _snapshotHistory.length,
    time: new Date().toLocaleTimeString(),
    clipCount: clips.length,
    bpm: bpm,
    data: data
  });
  if (_snapshotHistory.length > 20) _snapshotHistory.shift();
  showToast('Snapshot taken: ' + _snapshotHistory[_snapshotHistory.length - 1].label);
}
function showSnapshotHistory() {
  if (!_snapshotHistory.length) { showToast('No snapshots yet. Use Take Snapshot first.'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="color:#e2e8f0;font-size:14px;font-weight:600">Snapshot History</span>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:18px;font-family:Sora,sans-serif">X</button></div>';
  _snapshotHistory.forEach(function(snap, idx) {
    var families = {};
    snap.data.forEach(function(d) { families[d.family] = (families[d.family] || 0) + 1; });
    var famStr = Object.keys(families).map(function(f) { return f + ':' + families[f]; }).join(' ');
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
    html += '<div><span style="color:#e2e8f0;font-size:11px;font-weight:600">' + snap.label + '</span>';
    html += '<div style="color:#64748b;font-size:9px;margin-top:2px">' + snap.time + ' | ' + snap.clipCount + ' clips | ' + snap.bpm + ' BPM</div>';
    html += '<div style="color:#475569;font-size:8px;margin-top:2px">' + famStr + '</div></div>';
    html += '<button onclick="restoreSnapshot(' + idx + ')" style="padding:4px 12px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.2);border-radius:6px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:9px;flex-shrink:0">Restore</button></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function restoreSnapshot(idx) {
  var snap = _snapshotHistory[idx];
  if (!snap) return;
  if (typeof captureUndo === 'function') captureUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  if (typeof _bpm !== 'undefined') { _bpm = snap.bpm; var bpmEl = document.getElementById('bpm-display'); if (bpmEl) bpmEl.textContent = _bpm; }
  snap.data.forEach(function(d) {
    var lane = document.querySelector('.track-lane[data-track="' + d.track + '"]');
    if (!lane) lane = document.querySelector('.track-lane');
    if (lane && typeof createClipElement === 'function') {
      var clip = createClipElement(d.exercise, d.family);
      clip.style.left = d.left;
      clip.style.width = d.width;
      clip.dataset.sets = d.sets;
      clip.dataset.reps = d.reps;
      clip.dataset.rpe = d.rpe;
      clip.dataset.rest = d.rest;
      if (typeof updateClipInfo === 'function') updateClipInfo(clip);
      lane.appendChild(clip);
    }
  });
  var modal = document.querySelector('div[style*="fixed"][style*="9999"]');
  if (modal) modal.remove();
  showToast('Restored: ' + snap.label);
}

// Batch 322: Exercise Superset Builder
function buildSuperset() {
  var selected = document.querySelectorAll('.clip.selected');
  if (selected.length < 2) { showToast('Select 2+ clips to build superset'); return; }
  if (typeof captureUndo === 'function') captureUndo();
  var groupId = 'ss-' + Date.now();
  var colors = ['#f87171', '#60a5fa', '#fbbf24', '#4ade80', '#c084fc', '#22d3ee'];
  var colorIdx = Math.floor(Math.random() * colors.length);
  var names = [];
  selected.forEach(function(c, idx) {
    c.dataset.supersetGroup = groupId;
    c.dataset.supersetIndex = idx;
    var label = String.fromCharCode(65 + Math.floor(idx / 1)) + (idx + 1);
    var badge = c.querySelector('.ss-builder-badge');
    if (badge) badge.remove();
    var b = document.createElement('span');
    b.className = 'ss-builder-badge';
    b.style.cssText = 'position:absolute;top:2px;right:2px;background:' + colors[colorIdx] + ';color:#050711;font-size:7px;font-weight:700;padding:1px 4px;border-radius:3px;pointer-events:none;font-family:Sora,sans-serif;z-index:2';
    b.textContent = label;
    c.style.position = 'relative';
    c.appendChild(b);
    names.push(c.dataset.exercise || c.textContent.trim().split('\n')[0]);
  });
  showToast('Superset: ' + names.join(' + '));
}
function clearSupersets() {
  if (typeof captureUndo === 'function') captureUndo();
  document.querySelectorAll('.ss-builder-badge').forEach(function(b) { b.remove(); });
  document.querySelectorAll('[data-superset-group]').forEach(function(c) {
    delete c.dataset.supersetGroup;
    delete c.dataset.supersetIndex;
  });
  showToast('Supersets cleared');
}
function listSupersets() {
  var groups = {};
  document.querySelectorAll('[data-superset-group]').forEach(function(c) {
    var gid = c.dataset.supersetGroup;
    if (!groups[gid]) groups[gid] = [];
    groups[gid].push(c.dataset.exercise || c.textContent.trim().split('\n')[0]);
  });
  var keys = Object.keys(groups);
  if (!keys.length) { showToast('No supersets defined'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="color:#e2e8f0;font-size:14px;font-weight:600">Superset Groups</span>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:18px;font-family:Sora,sans-serif">X</button></div>';
  keys.forEach(function(k, i) {
    html += '<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
    html += '<span style="color:#22d3ee;font-size:10px;font-weight:600">Set ' + (i + 1) + '</span>';
    html += '<div style="color:#e2e8f0;font-size:11px;margin-top:4px">' + groups[k].join(' + ') + '</div></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 323: Workout Intent Tags
var INTENT_TAGS = ['Strength', 'Hypertrophy', 'Endurance', 'Power', 'Mobility', 'Skill'];
function tagClipIntent(intent) {
  var selected = document.querySelectorAll('.clip.selected');
  if (!selected.length) { showToast('Select clips first'); return; }
  if (typeof captureUndo === 'function') captureUndo();
  var intentColors = {
    Strength: '#f87171', Hypertrophy: '#c084fc', Endurance: '#4ade80',
    Power: '#fbbf24', Mobility: '#22d3ee', Skill: '#f472b6'
  };
  selected.forEach(function(c) {
    c.dataset.intent = intent;
    var tag = c.querySelector('.intent-tag');
    if (tag) tag.remove();
    var t = document.createElement('span');
    t.className = 'intent-tag';
    t.style.cssText = 'position:absolute;bottom:2px;left:4px;font-size:6px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;color:' + (intentColors[intent] || '#94a3b8') + ';pointer-events:none;font-family:Sora,sans-serif;z-index:2;opacity:0.8';
    t.textContent = intent;
    c.style.position = 'relative';
    c.appendChild(t);
  });
  showToast(selected.length + ' clips tagged: ' + intent);
}
function showIntentPicker() {
  var selected = document.querySelectorAll('.clip.selected');
  if (!selected.length) { showToast('Select clips first'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.9);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;max-width:360px">';
  var intentColors = { Strength: '#f87171', Hypertrophy: '#c084fc', Endurance: '#4ade80', Power: '#fbbf24', Mobility: '#22d3ee', Skill: '#f472b6' };
  INTENT_TAGS.forEach(function(tag) {
    var col = intentColors[tag] || '#94a3b8';
    html += '<button onclick="tagClipIntent(\'' + tag + '\');this.closest(\'div[style*=fixed]\').remove()" style="padding:12px 20px;background:rgba(255,255,255,0.03);border:1px solid ' + col + '40;border-radius:8px;color:' + col + ';cursor:pointer;font-family:Sora,sans-serif;font-size:12px;font-weight:600;letter-spacing:0.05em;min-width:100px">' + tag + '</button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function showIntentSummary() {
  var intents = {};
  document.querySelectorAll('[data-intent]').forEach(function(c) {
    var intent = c.dataset.intent;
    if (!intents[intent]) intents[intent] = 0;
    intents[intent]++;
  });
  var keys = Object.keys(intents);
  if (!keys.length) { showToast('No intent tags set'); return; }
  var total = 0;
  keys.forEach(function(k) { total += intents[k]; });
  var lines = keys.map(function(k) { return k + ': ' + intents[k] + ' (' + Math.round(intents[k] / total * 100) + '%)'; });
  showToast('Intent: ' + lines.join(', '));
}

// Batch 324: Personal Records Tracker
var _personalRecords = {};
function loadPRs() {
  try { var d = localStorage.getItem('sms_personal_records'); if (d) _personalRecords = JSON.parse(d); } catch(e) {}
}
function savePRs() {
  try { localStorage.setItem('sms_personal_records', JSON.stringify(_personalRecords)); } catch(e) {}
}
function logPR(exerciseName, value, unit) {
  if (!exerciseName) return;
  if (!_personalRecords[exerciseName]) _personalRecords[exerciseName] = [];
  _personalRecords[exerciseName].push({
    value: value,
    unit: unit || 'reps',
    date: new Date().toISOString().split('T')[0]
  });
  if (_personalRecords[exerciseName].length > 50) _personalRecords[exerciseName] = _personalRecords[exerciseName].slice(-50);
  savePRs();
  showToast('PR logged: ' + exerciseName + ' ' + value + ' ' + (unit || 'reps'));
}
function showPRLogger() {
  var selected = document.querySelector('.clip.selected');
  var defaultExercise = selected ? (selected.dataset.exercise || '') : '';
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:360px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Log Personal Record</span>';
  html += '<input id="pr-exercise" placeholder="Exercise name" value="' + defaultExercise + '" style="width:100%;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:12px;margin-bottom:8px;box-sizing:border-box"/>';
  html += '<div style="display:flex;gap:8px;margin-bottom:12px">';
  html += '<input id="pr-value" type="number" placeholder="Value" style="flex:1;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:12px"/>';
  html += '<select id="pr-unit" style="padding:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:12px">';
  html += '<option value="reps">reps</option><option value="sec">sec</option><option value="kg">kg</option><option value="lbs">lbs</option></select></div>';
  html += '<button onclick="var e=document.getElementById(\'pr-exercise\').value,v=parseFloat(document.getElementById(\'pr-value\').value),u=document.getElementById(\'pr-unit\').value;if(e&&v){logPR(e,v,u);this.closest(\'div[style*=fixed]\').remove();}else{showToast(\'Fill all fields\')}" style="width:100%;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Log PR</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function showPRHistory() {
  var keys = Object.keys(_personalRecords);
  if (!keys.length) { showToast('No PRs logged yet'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="color:#e2e8f0;font-size:14px;font-weight:600">Personal Records</span>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:18px;font-family:Sora,sans-serif">X</button></div>';
  keys.sort().forEach(function(ex) {
    var records = _personalRecords[ex];
    var best = records.reduce(function(a, b) { return b.value > a.value ? b : a; }, records[0]);
    html += '<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center">';
    html += '<span style="color:#e2e8f0;font-size:11px;font-weight:600">' + ex + '</span>';
    html += '<span style="color:#22d3ee;font-size:12px;font-weight:700">' + best.value + ' ' + best.unit + '</span></div>';
    html += '<div style="color:#64748b;font-size:9px;margin-top:2px">Best on ' + best.date + ' | ' + records.length + ' entries</div>';
    if (records.length > 1) {
      var recent = records.slice(-5).reverse();
      html += '<div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap">';
      recent.forEach(function(r) {
        var isBest = r.value === best.value;
        html += '<span style="font-size:8px;color:' + (isBest ? '#22d3ee' : '#475569') + '">' + r.value + r.unit.charAt(0) + ' ' + r.date.slice(5) + '</span>';
      });
      html += '</div>';
    }
    html += '</div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
loadPRs();

// Batch 325: Workout Periodization Planner
function showPeriodization() {
  var weeks = 4;
  var days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  var plan = {};
  try { var d = localStorage.getItem('sms_periodization'); if (d) plan = JSON.parse(d); } catch(e) {}
  var html = '<div id="periodization-overlay" style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:flex-start;justify-content:center;padding-top:40px;font-family:Sora,sans-serif;overflow-y:auto">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:700px;width:95%">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="color:#e2e8f0;font-size:14px;font-weight:600">Periodization Planner (4 Weeks)</span>';
  html += '<button onclick="document.getElementById(\'periodization-overlay\').remove()" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:18px;font-family:Sora,sans-serif">X</button></div>';
  html += '<div style="display:grid;grid-template-columns:40px repeat(7,1fr);gap:2px;font-size:9px">';
  html += '<div></div>';
  days.forEach(function(d) { html += '<div style="text-align:center;color:#64748b;font-weight:600;padding:4px 0">' + d + '</div>'; });
  var focusTypes = ['Push', 'Pull', 'Legs', 'Upper', 'Lower', 'Full', 'Rest', 'Skills', 'Core'];
  for (var w = 0; w < weeks; w++) {
    html += '<div style="color:#64748b;font-weight:600;display:flex;align-items:center;justify-content:center">W' + (w + 1) + '</div>';
    for (var d = 0; d < 7; d++) {
      var key = 'w' + w + 'd' + d;
      var val = plan[key] || '';
      var bgColor = val === 'Rest' ? 'rgba(255,255,255,0.02)' : (val ? 'rgba(34,211,238,0.08)' : 'rgba(255,255,255,0.02)');
      html += '<div style="background:' + bgColor + ';border:1px solid rgba(255,255,255,0.05);border-radius:4px;padding:6px 2px;text-align:center;min-height:32px;cursor:pointer" onclick="cyclePeriodDay(\'' + key + '\',this)">';
      html += '<span style="color:' + (val === 'Rest' ? '#475569' : '#22d3ee') + ';font-size:8px;font-weight:600">' + (val || '-') + '</span></div>';
    }
  }
  html += '</div>';
  html += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:12px">';
  focusTypes.forEach(function(f) {
    html += '<span style="color:#475569;font-size:7px;padding:2px 6px;border:1px solid rgba(255,255,255,0.05);border-radius:4px">' + f + '</span>';
  });
  html += '</div>';
  html += '<button onclick="savePeriodization()" style="width:100%;margin-top:12px;padding:8px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:6px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:10px;font-weight:600">Save Plan</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
var _periodFocusTypes = ['', 'Push', 'Pull', 'Legs', 'Upper', 'Lower', 'Full', 'Rest', 'Skills', 'Core'];
function cyclePeriodDay(key, el) {
  var plan = {};
  try { var d = localStorage.getItem('sms_periodization'); if (d) plan = JSON.parse(d); } catch(e) {}
  var current = plan[key] || '';
  var idx = _periodFocusTypes.indexOf(current);
  idx = (idx + 1) % _periodFocusTypes.length;
  plan[key] = _periodFocusTypes[idx];
  try { localStorage.setItem('sms_periodization', JSON.stringify(plan)); } catch(e) {}
  var val = plan[key];
  var span = el.querySelector('span');
  if (span) { span.textContent = val || '-'; span.style.color = val === 'Rest' ? '#475569' : (val ? '#22d3ee' : '#475569'); }
  el.style.background = val === 'Rest' ? 'rgba(255,255,255,0.02)' : (val ? 'rgba(34,211,238,0.08)' : 'rgba(255,255,255,0.02)');
}
function savePeriodization() {
  showToast('Periodization plan saved');
}

// Batch 326: Exercise Timer Presets (Tabata, EMOM, AMRAP)
function showTimerPresets() {
  var presets = [
    { name: 'Tabata', work: 20, rest: 10, rounds: 8, description: '20s work / 10s rest x 8' },
    { name: 'EMOM 10', work: 40, rest: 20, rounds: 10, description: 'Every minute on the minute x 10' },
    { name: 'EMOM 20', work: 40, rest: 20, rounds: 20, description: 'Every minute on the minute x 20' },
    { name: 'AMRAP 10', work: 600, rest: 0, rounds: 1, description: 'As many reps as possible in 10 min' },
    { name: 'AMRAP 20', work: 1200, rest: 0, rounds: 1, description: '20-minute AMRAP' },
    { name: '30/30', work: 30, rest: 30, rounds: 10, description: '30s on / 30s off x 10' },
    { name: '45/15', work: 45, rest: 15, rounds: 10, description: '45s work / 15s rest x 10' },
    { name: 'Pyramid', work: 0, rest: 0, rounds: 0, description: '10-20-30-40-50-40-30-20-10s' }
  ];
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Timer Presets</span>';
  presets.forEach(function(p, idx) {
    html += '<button onclick="startTimerPreset(' + idx + ');this.closest(\'div[style*=fixed]\').remove()" style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:12px;margin-bottom:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;color:#e2e8f0;cursor:pointer;font-family:Sora,sans-serif;text-align:left">';
    html += '<div><span style="font-size:12px;font-weight:600">' + p.name + '</span>';
    html += '<div style="color:#64748b;font-size:9px;margin-top:2px">' + p.description + '</div></div>';
    html += '<span style="color:#22d3ee;font-size:10px;flex-shrink:0;margin-left:12px">Start</span></button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
var _timerPresetData = [
  { name: 'Tabata', work: 20, rest: 10, rounds: 8 },
  { name: 'EMOM 10', work: 40, rest: 20, rounds: 10 },
  { name: 'EMOM 20', work: 40, rest: 20, rounds: 20 },
  { name: 'AMRAP 10', work: 600, rest: 0, rounds: 1 },
  { name: 'AMRAP 20', work: 1200, rest: 0, rounds: 1 },
  { name: '30/30', work: 30, rest: 30, rounds: 10 },
  { name: '45/15', work: 45, rest: 15, rounds: 10 },
  { name: 'Pyramid', work: 0, rest: 0, rounds: 0 }
];
var _timerInterval = null;
var _timerOverlay = null;
function startTimerPreset(idx) {
  var p = _timerPresetData[idx];
  if (!p) return;
  if (p.name === 'Pyramid') { startPyramidTimer(); return; }
  if (p.rounds === 1) { startCountdownTimer(p.work, p.name); return; }
  startIntervalTimer(p.work, p.rest, p.rounds, p.name);
}
function startIntervalTimer(workSec, restSec, rounds, name) {
  if (_timerInterval) clearInterval(_timerInterval);
  if (_timerOverlay) _timerOverlay.remove();
  var currentRound = 1;
  var phase = 'work';
  var timeLeft = workSec;
  var ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;inset:0;z-index:10000;background:rgba(5,7,17,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  ov.innerHTML = '<div style="color:#64748b;font-size:10px;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px" id="timer-name">' + name + '</div><div id="timer-phase" style="color:#4ade80;font-size:16px;font-weight:700;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em">WORK</div><div id="timer-display" style="color:#e2e8f0;font-size:72px;font-weight:300;letter-spacing:0.05em;font-variant-numeric:tabular-nums">' + formatTimerSec(timeLeft) + '</div><div id="timer-round" style="color:#64748b;font-size:11px;margin-top:12px">Round ' + currentRound + ' / ' + rounds + '</div><button onclick="stopTimerPresetOverlay()" style="margin-top:24px;padding:8px 24px;background:none;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Stop (ESC)</button>';
  document.body.appendChild(ov);
  _timerOverlay = ov;
  var phaseEl = ov.querySelector('#timer-phase');
  var displayEl = ov.querySelector('#timer-display');
  var roundEl = ov.querySelector('#timer-round');
  _timerInterval = setInterval(function() {
    timeLeft--;
    if (timeLeft < 0) {
      if (phase === 'work' && restSec > 0) {
        phase = 'rest';
        timeLeft = restSec;
        phaseEl.textContent = 'REST';
        phaseEl.style.color = '#f87171';
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      } else {
        currentRound++;
        if (currentRound > rounds) { stopTimerPresetOverlay(); showToast(name + ' complete!'); return; }
        phase = 'work';
        timeLeft = workSec;
        phaseEl.textContent = 'WORK';
        phaseEl.style.color = '#4ade80';
        roundEl.textContent = 'Round ' + currentRound + ' / ' + rounds;
        if (navigator.vibrate) navigator.vibrate(100);
      }
    }
    displayEl.textContent = formatTimerSec(timeLeft);
  }, 1000);
  var escHandler = function(e) { if (e.key === 'Escape') { stopTimerPresetOverlay(); document.removeEventListener('keydown', escHandler); } };
  document.addEventListener('keydown', escHandler);
}
function startCountdownTimer(totalSec, name) {
  if (_timerInterval) clearInterval(_timerInterval);
  if (_timerOverlay) _timerOverlay.remove();
  var timeLeft = totalSec;
  var ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;inset:0;z-index:10000;background:rgba(5,7,17,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  ov.innerHTML = '<div style="color:#64748b;font-size:10px;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px">' + name + '</div><div style="color:#fbbf24;font-size:16px;font-weight:700;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.1em">GO</div><div id="timer-display" style="color:#e2e8f0;font-size:72px;font-weight:300;letter-spacing:0.05em;font-variant-numeric:tabular-nums">' + formatTimerSec(timeLeft) + '</div><button onclick="stopTimerPresetOverlay()" style="margin-top:24px;padding:8px 24px;background:none;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Stop (ESC)</button>';
  document.body.appendChild(ov);
  _timerOverlay = ov;
  var displayEl = ov.querySelector('#timer-display');
  _timerInterval = setInterval(function() {
    timeLeft--;
    if (timeLeft < 0) { stopTimerPresetOverlay(); showToast(name + ' complete!'); return; }
    displayEl.textContent = formatTimerSec(timeLeft);
  }, 1000);
  var escHandler = function(e) { if (e.key === 'Escape') { stopTimerPresetOverlay(); document.removeEventListener('keydown', escHandler); } };
  document.addEventListener('keydown', escHandler);
}
function startPyramidTimer() {
  var steps = [10, 20, 30, 40, 50, 40, 30, 20, 10];
  var stepIdx = 0;
  if (_timerInterval) clearInterval(_timerInterval);
  if (_timerOverlay) _timerOverlay.remove();
  var timeLeft = steps[0];
  var ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;inset:0;z-index:10000;background:rgba(5,7,17,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  ov.innerHTML = '<div style="color:#64748b;font-size:10px;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px">Pyramid</div><div id="timer-step" style="color:#c084fc;font-size:14px;font-weight:600;margin-bottom:12px">' + steps[0] + 's interval (1/' + steps.length + ')</div><div id="timer-display" style="color:#e2e8f0;font-size:72px;font-weight:300;letter-spacing:0.05em;font-variant-numeric:tabular-nums">' + formatTimerSec(timeLeft) + '</div><button onclick="stopTimerPresetOverlay()" style="margin-top:24px;padding:8px 24px;background:none;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Stop (ESC)</button>';
  document.body.appendChild(ov);
  _timerOverlay = ov;
  var stepEl = ov.querySelector('#timer-step');
  var displayEl = ov.querySelector('#timer-display');
  _timerInterval = setInterval(function() {
    timeLeft--;
    if (timeLeft < 0) {
      stepIdx++;
      if (stepIdx >= steps.length) { stopTimerPresetOverlay(); showToast('Pyramid complete!'); return; }
      timeLeft = steps[stepIdx];
      stepEl.textContent = steps[stepIdx] + 's interval (' + (stepIdx + 1) + '/' + steps.length + ')';
      if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
    }
    displayEl.textContent = formatTimerSec(timeLeft);
  }, 1000);
  var escHandler = function(e) { if (e.key === 'Escape') { stopTimerPresetOverlay(); document.removeEventListener('keydown', escHandler); } };
  document.addEventListener('keydown', escHandler);
}
function formatTimerSec(s) {
  var m = Math.floor(s / 60);
  var sec = s % 60;
  return (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
}
function stopTimerPresetOverlay() {
  if (_timerInterval) { clearInterval(_timerInterval); _timerInterval = null; }
  if (_timerOverlay) { _timerOverlay.remove(); _timerOverlay = null; }
}

// Batch 327: Export Workout to Calendar (.ics)
function exportToCalendar() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips to export'); return; }
  var workoutName = 'Workout';
  var nameEl = document.getElementById('workout-name') || document.querySelector('.breadcrumb-name');
  if (nameEl) workoutName = nameEl.textContent || workoutName;
  var exercises = [];
  clips.forEach(function(c) {
    var name = c.dataset.exercise || c.textContent.trim().split('\n')[0];
    var sets = c.dataset.sets || '3';
    var reps = c.dataset.reps || '8';
    exercises.push(name + ' ' + sets + 'x' + reps);
  });
  var now = new Date();
  var tomorrow = new Date(now.getTime() + 86400000);
  tomorrow.setHours(8, 0, 0, 0);
  var endTime = new Date(tomorrow.getTime() + 3600000);
  function pad(n) { return n < 10 ? '0' + n : '' + n; }
  function icsDate(d) {
    return d.getFullYear() + pad(d.getMonth() + 1) + pad(d.getDate()) + 'T' + pad(d.getHours()) + pad(d.getMinutes()) + pad(d.getSeconds());
  }
  var uid = 'sms-' + Date.now() + '@saturnomovement';
  var description = exercises.join('\\n');
  if (description.length > 500) description = description.slice(0, 500) + '\\n...';
  var ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Saturno Movement Studio//EN\r\nBEGIN:VEVENT\r\nUID:' + uid + '\r\nDTSTAMP:' + icsDate(now) + '\r\nDTSTART:' + icsDate(tomorrow) + '\r\nDTEND:' + icsDate(endTime) + '\r\nSUMMARY:' + workoutName + '\r\nDESCRIPTION:' + description + '\r\nEND:VEVENT\r\nEND:VCALENDAR';
  var blob = new Blob([ics], { type: 'text/calendar' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = workoutName.replace(/[^a-zA-Z0-9]/g, '_') + '.ics';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('Calendar event downloaded');
}

// Batch 328: Movement Journal
var _movementJournal = [];
function loadJournal() {
  try { var d = localStorage.getItem('sms_movement_journal'); if (d) _movementJournal = JSON.parse(d); } catch(e) {}
}
function saveJournal() {
  try { localStorage.setItem('sms_movement_journal', JSON.stringify(_movementJournal)); } catch(e) {}
}
function addJournalEntry() {
  var clips = document.querySelectorAll('.clip');
  var workoutName = '';
  var nameEl = document.getElementById('workout-name') || document.querySelector('.breadcrumb-name');
  if (nameEl) workoutName = nameEl.textContent || '';
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:480px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:4px">Movement Journal</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:16px">' + new Date().toLocaleDateString() + (workoutName ? ' | ' + workoutName : '') + ' | ' + clips.length + ' exercises</span>';
  html += '<textarea id="journal-entry" placeholder="How did the session feel? Energy level, focus, breakthroughs, struggles..." style="width:100%;height:120px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;resize:vertical;box-sizing:border-box;line-height:1.6"></textarea>';
  html += '<div style="display:flex;gap:6px;margin:12px 0;flex-wrap:wrap">';
  var moods = ['Energized', 'Focused', 'Tired', 'Strong', 'Struggled', 'Flow State'];
  moods.forEach(function(m) {
    html += '<button class="journal-mood-btn" onclick="this.classList.toggle(\'active\');this.style.borderColor=this.classList.contains(\'active\')?\'rgba(34,211,238,0.5)\':\'rgba(255,255,255,0.1)\';this.style.color=this.classList.contains(\'active\')?\'#22d3ee\':\'#64748b\'" style="padding:4px 10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:9px">' + m + '</button>';
  });
  html += '</div>';
  html += '<button onclick="saveJournalEntry()" style="width:100%;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Save Entry</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function saveJournalEntry() {
  var text = document.getElementById('journal-entry');
  if (!text || !text.value.trim()) { showToast('Write something first'); return; }
  var moods = [];
  document.querySelectorAll('.journal-mood-btn.active').forEach(function(b) { moods.push(b.textContent); });
  var clips = document.querySelectorAll('.clip');
  var workoutName = '';
  var nameEl = document.getElementById('workout-name') || document.querySelector('.breadcrumb-name');
  if (nameEl) workoutName = nameEl.textContent || '';
  _movementJournal.push({
    date: new Date().toISOString(),
    text: text.value.trim(),
    moods: moods,
    workout: workoutName,
    clipCount: clips.length,
    bpm: typeof _bpm !== 'undefined' ? _bpm : 100
  });
  if (_movementJournal.length > 100) _movementJournal = _movementJournal.slice(-100);
  saveJournal();
  var modal = text.closest('div[style*="fixed"]');
  if (modal) modal.remove();
  showToast('Journal entry saved');
}
function showJournalHistory() {
  loadJournal();
  if (!_movementJournal.length) { showToast('No journal entries yet'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Movement Journal (' + _movementJournal.length + ' entries)</span>';
  _movementJournal.slice().reverse().forEach(function(entry) {
    var d = new Date(entry.date);
    html += '<div style="padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    html += '<span style="color:#22d3ee;font-size:10px;font-weight:600">' + d.toLocaleDateString() + '</span>';
    html += '<span style="color:#475569;font-size:9px">' + (entry.workout || 'Untitled') + ' | ' + (entry.clipCount || 0) + ' clips</span></div>';
    html += '<p style="color:#cbd5e1;font-size:11px;margin:0 0 6px;line-height:1.5;white-space:pre-wrap">' + entry.text + '</p>';
    if (entry.moods && entry.moods.length) {
      html += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
      entry.moods.forEach(function(m) { html += '<span style="color:#64748b;font-size:8px;padding:2px 6px;border:1px solid rgba(255,255,255,0.05);border-radius:8px">' + m + '</span>'; });
      html += '</div>';
    }
    html += '</div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
loadJournal();

// Batch 329: Workout Streaks Gamification
function getWorkoutStreak() {
  var dates = {};
  try {
    var ratings = localStorage.getItem('sms_workout_ratings');
    if (ratings) {
      JSON.parse(ratings).forEach(function(r) {
        if (r.date) dates[r.date.split('T')[0]] = true;
      });
    }
    var journal = localStorage.getItem('sms_movement_journal');
    if (journal) {
      JSON.parse(journal).forEach(function(j) {
        if (j.date) dates[j.date.split('T')[0]] = true;
      });
    }
  } catch(e) {}
  var sortedDates = Object.keys(dates).sort().reverse();
  if (!sortedDates.length) return { current: 0, best: 0, total: sortedDates.length };
  var streak = 0;
  var today = new Date().toISOString().split('T')[0];
  var checkDate = new Date(today);
  if (!dates[today]) {
    checkDate.setDate(checkDate.getDate() - 1);
    if (!dates[checkDate.toISOString().split('T')[0]]) return { current: 0, best: 0, total: sortedDates.length };
  }
  while (dates[checkDate.toISOString().split('T')[0]]) {
    streak++;
    checkDate.setDate(checkDate.getDate() - 1);
  }
  var best = streak;
  var tempStreak = 0;
  for (var i = 0; i < sortedDates.length; i++) {
    if (i === 0) { tempStreak = 1; continue; }
    var prev = new Date(sortedDates[i - 1]);
    var curr = new Date(sortedDates[i]);
    var diff = (prev - curr) / 86400000;
    if (diff <= 1) { tempStreak++; if (tempStreak > best) best = tempStreak; }
    else { tempStreak = 1; }
  }
  return { current: streak, best: best, total: sortedDates.length };
}
function showStreakBadge() {
  var s = getWorkoutStreak();
  var fire = '';
  if (s.current >= 30) fire = ' LEGENDARY';
  else if (s.current >= 14) fire = ' ON FIRE';
  else if (s.current >= 7) fire = ' HOT';
  else if (s.current >= 3) fire = ' WARMING UP';
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:16px;padding:32px;text-align:center;max-width:320px;width:90%">';
  html += '<div style="color:#fbbf24;font-size:48px;font-weight:700;line-height:1">' + s.current + '</div>';
  html += '<div style="color:#fbbf24;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.15em;margin-top:4px">Day Streak' + fire + '</div>';
  html += '<div style="display:flex;justify-content:center;gap:24px;margin-top:20px">';
  html += '<div><div style="color:#e2e8f0;font-size:20px;font-weight:600">' + s.best + '</div><div style="color:#64748b;font-size:9px;text-transform:uppercase;letter-spacing:0.1em">Best Streak</div></div>';
  html += '<div><div style="color:#e2e8f0;font-size:20px;font-weight:600">' + s.total + '</div><div style="color:#64748b;font-size:9px;text-transform:uppercase;letter-spacing:0.1em">Total Days</div></div>';
  html += '</div>';
  if (s.current >= 7) {
    var badges = [];
    if (s.current >= 30) badges.push('30-Day Legend');
    if (s.current >= 14) badges.push('2-Week Warrior');
    if (s.current >= 7) badges.push('Week Champion');
    html += '<div style="margin-top:16px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap">';
    badges.forEach(function(b) { html += '<span style="padding:4px 10px;border:1px solid rgba(251,191,36,0.3);border-radius:12px;color:#fbbf24;font-size:9px;font-weight:600">' + b + '</span>'; });
    html += '</div>';
  }
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 330: Quick Exercise Swap
function showQuickSwap(clip) {
  if (!clip) { var sel = document.querySelector('.clip.selected'); if (!sel) { showToast('Select a clip first'); return; } clip = sel; }
  var currentEx = clip.dataset.exercise || '';
  var currentFam = clip.dataset.family || '';
  var currentPattern = clip.dataset.pattern || '';
  var alternatives = [];
  if (typeof EXERCISES !== 'undefined') {
    EXERCISES.forEach(function(ex) {
      if (ex.name === currentEx) return;
      var match = false;
      if (currentPattern && ex.pattern === currentPattern) match = true;
      else if (currentFam && ex.family === currentFam) match = true;
      if (match) alternatives.push(ex);
    });
  }
  if (!alternatives.length) { showToast('No alternatives found'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:4px">Quick Swap</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:16px">Current: ' + currentEx + ' | ' + alternatives.length + ' alternatives</span>';
  alternatives.forEach(function(ex) {
    var stageLabel = ex.stages ? Object.keys(ex.stages).join('/') : '';
    html += '<button onclick="executeQuickSwap(\'' + ex.name.replace(/'/g, "\\'") + '\',\'' + (ex.family || currentFam) + '\',\'' + (ex.pattern || '') + '\');this.closest(\'div[style*=fixed]\').remove()" style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin-bottom:4px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:6px;color:#e2e8f0;cursor:pointer;font-family:Sora,sans-serif;text-align:left">';
    html += '<span style="font-size:11px">' + ex.name + '</span>';
    html += '<span style="color:#475569;font-size:8px;flex-shrink:0;margin-left:8px">' + (ex.pattern || '') + (stageLabel ? ' ' + stageLabel : '') + '</span></button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function executeQuickSwap(newName, newFamily, newPattern) {
  var clip = document.querySelector('.clip.selected');
  if (!clip) return;
  if (typeof captureUndo === 'function') captureUndo();
  clip.dataset.exercise = newName;
  if (newFamily) clip.dataset.family = newFamily;
  if (newPattern) clip.dataset.pattern = newPattern;
  var label = clip.querySelector('.clip-name') || clip.querySelector('span');
  if (label) label.textContent = newName;
  if (typeof updateClipInfo === 'function') updateClipInfo(clip);
  showToast('Swapped to: ' + newName);
}

// Batch 331: Workout Focus Mode (zen mode)
var _zenMode = false;
function toggleZenMode() {
  _zenMode = !_zenMode;
  var header = document.querySelector('.header, header');
  var panelLeft = document.querySelector('.panel-left');
  var panelRight = document.querySelector('.panel-right');
  var footer = document.querySelector('.footer, footer');
  var transport = document.querySelector('.transport');
  if (_zenMode) {
    if (header) header.style.display = 'none';
    if (panelLeft) panelLeft.style.display = 'none';
    if (panelRight) panelRight.style.display = 'none';
    if (footer) footer.style.opacity = '0.3';
    document.body.style.overflow = 'hidden';
    showToast('Zen Mode ON — press Z to exit');
  } else {
    if (header) header.style.display = '';
    if (panelLeft) panelLeft.style.display = '';
    if (panelRight) panelRight.style.display = '';
    if (footer) footer.style.opacity = '';
    document.body.style.overflow = '';
    showToast('Zen Mode OFF');
  }
}
(function() {
  document.addEventListener('keydown', function(e) {
    if (e.key === 'z' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
      var tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
      toggleZenMode();
    }
  });
})();

// Batch 332: Exercise GIF Placeholder System
var _exerciseGifs = {};
function loadExerciseGifs() {
  try { var d = localStorage.getItem('sms_exercise_gifs'); if (d) _exerciseGifs = JSON.parse(d); } catch(e) {}
}
function saveExerciseGifs() {
  try { localStorage.setItem('sms_exercise_gifs', JSON.stringify(_exerciseGifs)); } catch(e) {}
}
function setExerciseGif(exerciseName, url) {
  _exerciseGifs[exerciseName] = url;
  saveExerciseGifs();
  showToast('GIF set for ' + exerciseName);
}
function showExercisePreview(exerciseName) {
  loadExerciseGifs();
  var gifUrl = _exerciseGifs[exerciseName];
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:400px;width:90%;text-align:center">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:12px">' + exerciseName + '</span>';
  if (gifUrl) {
    html += '<img src="' + gifUrl + '" style="max-width:100%;border-radius:8px;margin-bottom:12px" onerror="this.style.display=\'none\'">';
  } else {
    html += '<div style="width:100%;height:200px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:12px">';
    html += '<span style="color:#475569;font-size:11px">No preview image set</span></div>';
  }
  html += '<input id="gif-url-input" placeholder="Paste image/GIF URL..." value="' + (gifUrl || '') + '" style="width:100%;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;margin-bottom:8px;box-sizing:border-box"/>';
  html += '<button onclick="var u=document.getElementById(\'gif-url-input\').value;setExerciseGif(\'' + exerciseName.replace(/'/g, "\\'") + '\',u);this.closest(\'div[style*=fixed]\').remove()" style="width:100%;padding:8px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:6px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:10px;font-weight:600">Save Preview Image</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function showExercisePreviewFromClip() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || clip.textContent.trim().split('\n')[0];
  showExercisePreview(name);
}
loadExerciseGifs();

// Batch 333: Micro-Recovery Prompts
var _recoveryInterval = null;
var _recoveryEnabled = false;
var _recoveryMinutes = 15;
var _recoveryPrompts = [
  'Take 3 deep breaths. Inhale 4s, hold 4s, exhale 6s.',
  'Drink some water. Stay hydrated.',
  'Roll your shoulders back 5 times.',
  'Close your eyes for 10 seconds.',
  'Shake out your hands and wrists.',
  'Stand up and do a 10-second stretch.',
  'Check your posture. Tall spine, relaxed shoulders.',
  'Breathe in through your nose, out through your mouth.',
  'Flex your ankles. Circle each foot 5 times.',
  'Smile. Release jaw tension.'
];
function toggleRecoveryPrompts() {
  _recoveryEnabled = !_recoveryEnabled;
  if (_recoveryEnabled) {
    if (_recoveryInterval) clearInterval(_recoveryInterval);
    _recoveryInterval = setInterval(function() {
      var prompt = _recoveryPrompts[Math.floor(Math.random() * _recoveryPrompts.length)];
      showRecoveryToast(prompt);
    }, _recoveryMinutes * 60 * 1000);
    showToast('Recovery prompts ON (every ' + _recoveryMinutes + ' min)');
  } else {
    if (_recoveryInterval) { clearInterval(_recoveryInterval); _recoveryInterval = null; }
    showToast('Recovery prompts OFF');
  }
}
function showRecoveryToast(msg) {
  var el = document.createElement('div');
  el.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10000;background:rgba(5,7,17,0.95);border:1px solid rgba(34,211,238,0.2);border-radius:16px;padding:32px 40px;text-align:center;font-family:Sora,sans-serif;max-width:380px;animation:fadeIn 0.3s ease';
  el.innerHTML = '<div style="color:#22d3ee;font-size:10px;text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px;font-weight:600">Micro-Recovery</div><div style="color:#e2e8f0;font-size:14px;line-height:1.6">' + msg + '</div><button onclick="this.parentElement.remove()" style="margin-top:16px;padding:6px 20px;background:none;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Got it</button>';
  document.body.appendChild(el);
  setTimeout(function() { if (el.parentElement) el.remove(); }, 15000);
}
function setRecoveryInterval(minutes) {
  _recoveryMinutes = minutes;
  if (_recoveryEnabled) {
    if (_recoveryInterval) clearInterval(_recoveryInterval);
    _recoveryInterval = setInterval(function() {
      var prompt = _recoveryPrompts[Math.floor(Math.random() * _recoveryPrompts.length)];
      showRecoveryToast(prompt);
    }, _recoveryMinutes * 60 * 1000);
  }
  showToast('Recovery interval: ' + minutes + ' min');
}

// Batch 334: Workout Sound Effects (UI feedback)
var _uiSfxEnabled = true;
var _uiAudioCtx = null;
function getUIAudioCtx() {
  if (!_uiAudioCtx) { try { _uiAudioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
  return _uiAudioCtx;
}
function playUISound(type) {
  if (!_uiSfxEnabled) return;
  var ctx = getUIAudioCtx();
  if (!ctx) return;
  var osc = ctx.createOscillator();
  var gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  gain.gain.value = 0.08;
  var now = ctx.currentTime;
  if (type === 'place') {
    osc.frequency.value = 800;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.08, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
    osc.start(now);
    osc.stop(now + 0.1);
  } else if (type === 'delete') {
    osc.frequency.value = 400;
    osc.type = 'sine';
    osc.frequency.exponentialRampToValueAtTime(200, now + 0.15);
    gain.gain.setValueAtTime(0.06, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
    osc.start(now);
    osc.stop(now + 0.15);
  } else if (type === 'snap') {
    osc.frequency.value = 1200;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.04, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
    osc.start(now);
    osc.stop(now + 0.05);
  } else if (type === 'undo') {
    osc.frequency.value = 500;
    osc.type = 'triangle';
    osc.frequency.linearRampToValueAtTime(700, now + 0.1);
    gain.gain.setValueAtTime(0.06, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
    osc.start(now);
    osc.stop(now + 0.12);
  } else if (type === 'success') {
    osc.frequency.value = 600;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.06, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    osc.start(now);
    osc.stop(now + 0.15);
    var osc2 = ctx.createOscillator();
    var gain2 = ctx.createGain();
    osc2.connect(gain2);
    gain2.connect(ctx.destination);
    osc2.frequency.value = 900;
    osc2.type = 'sine';
    gain2.gain.setValueAtTime(0.06, now + 0.1);
    gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
    osc2.start(now + 0.1);
    osc2.stop(now + 0.3);
  }
}
function toggleUISfx() {
  _uiSfxEnabled = !_uiSfxEnabled;
  showToast('UI Sounds ' + (_uiSfxEnabled ? 'ON' : 'OFF'));
}

// Batch 335: Training Log Export (comprehensive)
function exportTrainingLog() {
  var lines = [];
  lines.push('# Training Log Export');
  lines.push('*Generated by Saturno Movement Studio*');
  lines.push('*Date: ' + new Date().toLocaleDateString() + '*');
  lines.push('');
  try {
    var journal = localStorage.getItem('sms_movement_journal');
    if (journal) {
      var entries = JSON.parse(journal);
      if (entries.length) {
        lines.push('## Movement Journal (' + entries.length + ' entries)');
        lines.push('');
        entries.forEach(function(e) {
          var d = new Date(e.date);
          lines.push('### ' + d.toLocaleDateString() + (e.workout ? ' - ' + e.workout : ''));
          if (e.clipCount) lines.push('*' + e.clipCount + ' exercises | ' + (e.bpm || '?') + ' BPM*');
          lines.push('');
          lines.push(e.text);
          if (e.moods && e.moods.length) lines.push('**Mood:** ' + e.moods.join(', '));
          lines.push('---');
          lines.push('');
        });
      }
    }
  } catch(e) {}
  try {
    var prs = localStorage.getItem('sms_personal_records');
    if (prs) {
      var records = JSON.parse(prs);
      var keys = Object.keys(records);
      if (keys.length) {
        lines.push('## Personal Records (' + keys.length + ' exercises)');
        lines.push('');
        lines.push('| Exercise | Best | Unit | Date | Entries |');
        lines.push('|----------|------|------|------|---------|');
        keys.sort().forEach(function(ex) {
          var recs = records[ex];
          var best = recs.reduce(function(a, b) { return b.value > a.value ? b : a; }, recs[0]);
          lines.push('| ' + ex + ' | ' + best.value + ' | ' + best.unit + ' | ' + best.date + ' | ' + recs.length + ' |');
        });
        lines.push('');
      }
    }
  } catch(e) {}
  try {
    var ratings = localStorage.getItem('sms_workout_ratings');
    if (ratings) {
      var rats = JSON.parse(ratings);
      if (rats.length) {
        lines.push('## Workout Ratings (' + rats.length + ' sessions)');
        lines.push('');
        rats.slice(-20).reverse().forEach(function(r) {
          var stars = '';
          for (var i = 0; i < (r.rating || 0); i++) stars += '*';
          lines.push('- ' + (r.date ? new Date(r.date).toLocaleDateString() : '?') + ' | ' + stars + ' (' + (r.rating || '?') + '/5)' + (r.name ? ' | ' + r.name : ''));
        });
        lines.push('');
      }
    }
  } catch(e) {}
  var streak = getWorkoutStreak();
  lines.push('## Stats');
  lines.push('- Current Streak: ' + streak.current + ' days');
  lines.push('- Best Streak: ' + streak.best + ' days');
  lines.push('- Total Workout Days: ' + streak.total);
  var md = lines.join('\n');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(md).then(function() { showToast('Training log copied to clipboard'); });
  } else {
    var ta = document.createElement('textarea');
    ta.value = md;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('Training log copied to clipboard');
  }
}

// Batch 336: Exercise Difficulty Stars
var _exerciseDifficulty = {};
function loadDifficulty() {
  try { var d = localStorage.getItem('sms_exercise_difficulty'); if (d) _exerciseDifficulty = JSON.parse(d); } catch(e) {}
}
function saveDifficulty() {
  try { localStorage.setItem('sms_exercise_difficulty', JSON.stringify(_exerciseDifficulty)); } catch(e) {}
}
function setExerciseDifficulty(name, stars) {
  _exerciseDifficulty[name] = stars;
  saveDifficulty();
  showToast(name + ': ' + stars + '/5 difficulty');
}
function showDifficultyRater() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || clip.textContent.trim().split('\n')[0];
  var current = _exerciseDifficulty[name] || 0;
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.9);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;text-align:center;max-width:300px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600;display:block;margin-bottom:12px">' + name + '</span>';
  html += '<span style="color:#64748b;font-size:10px;display:block;margin-bottom:12px">Rate difficulty (1-5)</span>';
  html += '<div style="display:flex;gap:8px;justify-content:center">';
  for (var i = 1; i <= 5; i++) {
    var active = i <= current;
    html += '<button onclick="setExerciseDifficulty(\'' + name.replace(/'/g, "\\'") + '\',' + i + ');this.closest(\'div[style*=fixed]\').remove()" style="width:36px;height:36px;border-radius:50%;border:1px solid ' + (active ? 'rgba(251,191,36,0.5)' : 'rgba(255,255,255,0.1)') + ';background:' + (active ? 'rgba(251,191,36,0.15)' : 'rgba(255,255,255,0.02)') + ';color:' + (active ? '#fbbf24' : '#475569') + ';cursor:pointer;font-family:Sora,sans-serif;font-size:14px;font-weight:700">' + i + '</button>';
  }
  html += '</div></div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function showDifficultyOverview() {
  loadDifficulty();
  var keys = Object.keys(_exerciseDifficulty);
  if (!keys.length) { showToast('No difficulty ratings yet'); return; }
  keys.sort(function(a, b) { return (_exerciseDifficulty[b] || 0) - (_exerciseDifficulty[a] || 0); });
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Difficulty Ratings (' + keys.length + ')</span>';
  keys.forEach(function(name) {
    var stars = _exerciseDifficulty[name];
    var starStr = '';
    for (var i = 0; i < stars; i++) starStr += '*';
    var diffColor = stars >= 4 ? '#f87171' : (stars >= 3 ? '#fbbf24' : '#4ade80');
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03)">';
    html += '<span style="color:#e2e8f0;font-size:11px">' + name + '</span>';
    html += '<span style="color:' + diffColor + ';font-size:11px;font-weight:700;font-variant-numeric:tabular-nums">' + stars + '/5</span></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
loadDifficulty();

// Batch 337: Workout Clone & Modify
function showCloneWorkout() {
  var saved = [];
  try { var d = localStorage.getItem('sms_saved_workouts'); if (d) saved = JSON.parse(d); } catch(e) {}
  if (!saved.length) { showToast('No saved workouts to clone'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:4px">Clone & Modify</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:16px">Load a saved workout, then apply progressive overload</span>';
  saved.forEach(function(s, idx) {
    var clipCount = s.clips ? s.clips.length : (s.data && s.data.clips ? s.data.clips.length : 0);
    html += '<button onclick="cloneAndModify(' + idx + ');this.closest(\'div[style*=fixed]\').remove()" style="width:100%;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin-bottom:4px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:6px;color:#e2e8f0;cursor:pointer;font-family:Sora,sans-serif;text-align:left">';
    html += '<span style="font-size:11px">' + (s.name || 'Untitled') + '</span>';
    html += '<span style="color:#475569;font-size:9px">' + clipCount + ' clips</span></button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function cloneAndModify(idx) {
  var saved = [];
  try { var d = localStorage.getItem('sms_saved_workouts'); if (d) saved = JSON.parse(d); } catch(e) {}
  var workout = saved[idx];
  if (!workout) return;
  if (typeof loadNamedWorkout === 'function') loadNamedWorkout(idx);
  var nameEl = document.getElementById('workout-name') || document.querySelector('.breadcrumb-name');
  if (nameEl) nameEl.textContent = (workout.name || 'Workout') + ' (Clone)';
  showOverloadOptions();
}
function showOverloadOptions() {
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.9);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:320px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600;display:block;margin-bottom:16px">Apply Progressive Overload</span>';
  var options = [
    { label: '+1 Set to All', action: 'addSet' },
    { label: '+2 Reps to All', action: 'addReps' },
    { label: '+1 RPE to All', action: 'addRPE' },
    { label: '-10s Rest to All', action: 'reduceRest' },
    { label: 'Stage Up All', action: 'stageUp' },
    { label: 'Keep As-Is', action: 'none' }
  ];
  options.forEach(function(o) {
    html += '<button onclick="applyOverload(\'' + o.action + '\');this.closest(\'div[style*=fixed]\').remove()" style="width:100%;padding:10px;margin-bottom:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:6px;color:#e2e8f0;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;text-align:left">' + o.label + '</button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function applyOverload(action) {
  if (action === 'none') { showToast('Workout cloned as-is'); return; }
  if (typeof captureUndo === 'function') captureUndo();
  var clips = document.querySelectorAll('.clip:not(.clip-locked)');
  var applied = 0;
  clips.forEach(function(c) {
    if (action === 'addSet') { c.dataset.sets = Math.min(10, (parseInt(c.dataset.sets) || 3) + 1); applied++; }
    else if (action === 'addReps') { c.dataset.reps = Math.min(20, (parseInt(c.dataset.reps) || 8) + 2); applied++; }
    else if (action === 'addRPE') { c.dataset.rpe = Math.min(10, (parseInt(c.dataset.rpe) || 7) + 1); applied++; }
    else if (action === 'reduceRest') { c.dataset.rest = Math.max(15, (parseInt(c.dataset.rest) || 60) - 10); applied++; }
    else if (action === 'stageUp' && typeof EXERCISES !== 'undefined') {
      var ex = c.dataset.exercise;
      var pattern = c.dataset.pattern;
      var stage = parseInt(c.dataset.stage) || 1;
      if (stage < 3) {
        var nextStage = stage + 1;
        var found = EXERCISES.filter(function(e) { return e.pattern === pattern && e.stage === nextStage; });
        if (found.length) { c.dataset.exercise = found[0].name; c.dataset.stage = nextStage; applied++; }
      }
    }
    if (typeof updateClipInfo === 'function') updateClipInfo(c);
  });
  showToast('Overload applied to ' + applied + ' clips');
}

// Batch 338: Exercise Tags System
var _exerciseTags = {};
function loadExTags() {
  try { var d = localStorage.getItem('sms_exercise_tags'); if (d) _exerciseTags = JSON.parse(d); } catch(e) {}
}
function saveExTags() {
  try { localStorage.setItem('sms_exercise_tags', JSON.stringify(_exerciseTags)); } catch(e) {}
}
function showTagEditor() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || clip.textContent.trim().split('\n')[0];
  loadExTags();
  var current = _exerciseTags[name] || [];
  var presetTags = ['Needs Work', 'Mastered', 'Favorite', 'Pain', 'PR Potential', 'Skip', 'New', 'Progression Goal'];
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:400px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600;display:block;margin-bottom:4px">' + name + '</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:12px">Click to toggle tags</span>';
  html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">';
  presetTags.forEach(function(tag) {
    var active = current.indexOf(tag) >= 0;
    html += '<button class="ex-tag-btn" data-tag="' + tag + '" onclick="toggleExTag(\'' + name.replace(/'/g, "\\'") + '\',\'' + tag + '\',this)" style="padding:6px 12px;background:' + (active ? 'rgba(34,211,238,0.15)' : 'rgba(255,255,255,0.02)') + ';border:1px solid ' + (active ? 'rgba(34,211,238,0.4)' : 'rgba(255,255,255,0.08)') + ';border-radius:12px;color:' + (active ? '#22d3ee' : '#64748b') + ';cursor:pointer;font-family:Sora,sans-serif;font-size:10px">' + tag + '</button>';
  });
  html += '</div>';
  html += '<input id="custom-tag-input" placeholder="Add custom tag..." style="width:100%;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;box-sizing:border-box" onkeydown="if(event.key===\'Enter\'){addCustomExTag(\'' + name.replace(/'/g, "\\'") + '\',this.value);this.value=\'\';}">';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function toggleExTag(exercise, tag, btn) {
  loadExTags();
  if (!_exerciseTags[exercise]) _exerciseTags[exercise] = [];
  var idx = _exerciseTags[exercise].indexOf(tag);
  if (idx >= 0) {
    _exerciseTags[exercise].splice(idx, 1);
    if (btn) { btn.style.background = 'rgba(255,255,255,0.02)'; btn.style.borderColor = 'rgba(255,255,255,0.08)'; btn.style.color = '#64748b'; }
  } else {
    _exerciseTags[exercise].push(tag);
    if (btn) { btn.style.background = 'rgba(34,211,238,0.15)'; btn.style.borderColor = 'rgba(34,211,238,0.4)'; btn.style.color = '#22d3ee'; }
  }
  saveExTags();
}
function addCustomExTag(exercise, tag) {
  if (!tag || !tag.trim()) return;
  loadExTags();
  if (!_exerciseTags[exercise]) _exerciseTags[exercise] = [];
  if (_exerciseTags[exercise].indexOf(tag.trim()) < 0) _exerciseTags[exercise].push(tag.trim());
  saveExTags();
  showToast('Tag added: ' + tag.trim());
}
function showAllTags() {
  loadExTags();
  var keys = Object.keys(_exerciseTags).filter(function(k) { return _exerciseTags[k].length > 0; });
  if (!keys.length) { showToast('No exercise tags set'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:480px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Exercise Tags</span>';
  keys.sort().forEach(function(ex) {
    html += '<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">';
    html += '<span style="color:#e2e8f0;font-size:11px;font-weight:600">' + ex + '</span>';
    html += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">';
    _exerciseTags[ex].forEach(function(tag) {
      html += '<span style="padding:2px 8px;border:1px solid rgba(34,211,238,0.2);border-radius:8px;color:#22d3ee;font-size:8px">' + tag + '</span>';
    });
    html += '</div></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
loadExTags();

// Batch 339: Session Goal Setting
var _sessionGoals = [];
function setSessionGoal() {
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:360px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600;display:block;margin-bottom:12px">Set Session Goal</span>';
  var goalTypes = [
    { label: 'Total Sets', key: 'sets', placeholder: '30' },
    { label: 'Total Exercises', key: 'exercises', placeholder: '12' },
    { label: 'Average RPE', key: 'rpe', placeholder: '7' },
    { label: 'Session Time (min)', key: 'time', placeholder: '45' },
    { label: 'Min Families Used', key: 'families', placeholder: '4' }
  ];
  goalTypes.forEach(function(g) {
    var existing = _sessionGoals.find(function(sg) { return sg.key === g.key; });
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
    html += '<label style="color:#94a3b8;font-size:10px;flex:1">' + g.label + '</label>';
    html += '<input class="goal-input" data-key="' + g.key + '" type="number" placeholder="' + g.placeholder + '" value="' + (existing ? existing.target : '') + '" style="width:60px;padding:6px 8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;text-align:center"/></div>';
  });
  html += '<button onclick="saveSessionGoals()" style="width:100%;margin-top:12px;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Set Goals</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function saveSessionGoals() {
  _sessionGoals = [];
  document.querySelectorAll('.goal-input').forEach(function(inp) {
    var val = parseFloat(inp.value);
    if (val > 0) _sessionGoals.push({ key: inp.dataset.key, target: val });
  });
  var modal = document.querySelector('.goal-input');
  if (modal) { var m = modal.closest('div[style*="fixed"]'); if (m) m.remove(); }
  showToast(_sessionGoals.length + ' goals set');
}
function checkSessionGoals() {
  if (!_sessionGoals.length) { showToast('No goals set. Use Set Session Goal first.'); return; }
  var clips = document.querySelectorAll('.clip');
  var totalSets = 0, totalRPE = 0, rpeCount = 0;
  var families = {};
  clips.forEach(function(c) {
    totalSets += parseInt(c.dataset.sets) || 3;
    var rpe = parseInt(c.dataset.rpe);
    if (rpe) { totalRPE += rpe; rpeCount++; }
    var fam = c.dataset.family || 'core';
    families[fam] = true;
  });
  var avgRPE = rpeCount > 0 ? (totalRPE / rpeCount).toFixed(1) : 0;
  var sessionMin = 0;
  var timerEl = document.querySelector('[data-session-timer]') || document.getElementById('session-timer');
  if (timerEl) {
    var parts = timerEl.textContent.split(':');
    if (parts.length >= 2) sessionMin = parseInt(parts[0]) * 60 + parseInt(parts[1]) || 0;
    sessionMin = Math.floor(sessionMin / 60);
  }
  var results = [];
  _sessionGoals.forEach(function(g) {
    var current = 0;
    if (g.key === 'sets') current = totalSets;
    else if (g.key === 'exercises') current = clips.length;
    else if (g.key === 'rpe') current = parseFloat(avgRPE);
    else if (g.key === 'time') current = sessionMin;
    else if (g.key === 'families') current = Object.keys(families).length;
    var met = current >= g.target;
    results.push({ key: g.key, current: current, target: g.target, met: met });
  });
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:360px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Goal Progress</span>';
  var labels = { sets: 'Total Sets', exercises: 'Exercises', rpe: 'Avg RPE', time: 'Session Time', families: 'Families' };
  results.forEach(function(r) {
    var pct = Math.min(100, Math.round((r.current / r.target) * 100));
    var col = r.met ? '#4ade80' : (pct >= 60 ? '#fbbf24' : '#f87171');
    html += '<div style="margin-bottom:12px">';
    html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#94a3b8;font-size:10px">' + (labels[r.key] || r.key) + '</span>';
    html += '<span style="color:' + col + ';font-size:10px;font-weight:600">' + r.current + ' / ' + r.target + (r.met ? ' DONE' : '') + '</span></div>';
    html += '<div style="height:4px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden">';
    html += '<div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:2px;transition:width 0.3s"></div></div></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 340: Workout Template Sharing
function shareWorkoutAsURL() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips to share'); return; }
  var data = [];
  clips.forEach(function(c) {
    data.push({
      e: c.dataset.exercise || '',
      f: c.dataset.family || '',
      t: c.closest('.track-lane') ? c.closest('.track-lane').dataset.track : '0',
      l: c.style.left,
      w: c.style.width,
      s: c.dataset.sets || '3',
      r: c.dataset.reps || '8',
      p: c.dataset.rpe || '7'
    });
  });
  var bpm = typeof _bpm !== 'undefined' ? _bpm : 100;
  var payload = { b: bpm, c: data };
  try {
    var json = JSON.stringify(payload);
    var encoded = btoa(unescape(encodeURIComponent(json)));
    var url = window.location.origin + window.location.pathname + '#template=' + encoded;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(url).then(function() { showToast('Template URL copied! (' + data.length + ' exercises)'); });
    }
  } catch(e) { showToast('Template too large to share'); }
}
function loadWorkoutFromURL() {
  var hash = window.location.hash;
  if (!hash || hash.indexOf('#template=') !== 0) return false;
  try {
    var encoded = hash.replace('#template=', '');
    var json = decodeURIComponent(escape(atob(encoded)));
    var payload = JSON.parse(json);
    if (!payload.c || !payload.c.length) return false;
    if (typeof captureUndo === 'function') captureUndo();
    document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
    if (payload.b && typeof _bpm !== 'undefined') {
      _bpm = payload.b;
      var bpmEl = document.getElementById('bpm-display');
      if (bpmEl) bpmEl.textContent = _bpm;
    }
    payload.c.forEach(function(d) {
      var lane = document.querySelector('.track-lane[data-track="' + d.t + '"]');
      if (!lane) lane = document.querySelector('.track-lane');
      if (lane && typeof createClipElement === 'function') {
        var clip = createClipElement(d.e, d.f);
        clip.style.left = d.l;
        clip.style.width = d.w;
        clip.dataset.sets = d.s;
        clip.dataset.reps = d.r;
        clip.dataset.rpe = d.p;
        if (typeof updateClipInfo === 'function') updateClipInfo(clip);
        lane.appendChild(clip);
      }
    });
    window.location.hash = '';
    showToast('Template loaded: ' + payload.c.length + ' exercises');
    return true;
  } catch(e) { return false; }
}

// Batch 341: Exercise Cooldown Recommendations
function suggestCooldown() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips to analyze'); return; }
  var families = {};
  clips.forEach(function(c) {
    var fam = c.dataset.family || 'core';
    families[fam] = (families[fam] || 0) + 1;
  });
  var cooldownMap = {
    push: ['Chest doorway stretch (30s/side)', 'Shoulder pass-throughs (10 reps)', 'Wrist circles (10 each direction)'],
    pull: ['Lat hang (20s)', 'Bicep wall stretch (30s/side)', 'Cat-cow (10 reps)'],
    legs: ['Quad stretch (30s/side)', 'Hamstring fold (30s)', 'Pigeon pose (30s/side)', 'Calf stretch (20s/side)'],
    core: ['Cobra stretch (20s)', 'Seated twist (20s/side)', 'Child\'s pose (30s)'],
    skills: ['Wrist stretches (30s)', 'Shoulder circles (10 each)', 'Forearm stretch (20s/side)'],
    flow: ['Full body stretch sequence (2 min)', 'Savasana (1 min)', 'Deep breathing (5 breaths)']
  };
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:4px">Cooldown Recommendations</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:16px">Based on your workout (' + clips.length + ' exercises)</span>';
  var famColors = { push: '#f87171', pull: '#60a5fa', core: '#fbbf24', legs: '#4ade80', skills: '#c084fc', flow: '#22d3ee' };
  var sortedFams = Object.keys(families).sort(function(a, b) { return families[b] - families[a]; });
  sortedFams.forEach(function(fam) {
    var stretches = cooldownMap[fam] || cooldownMap.core;
    var col = famColors[fam] || '#94a3b8';
    html += '<div style="margin-bottom:12px">';
    html += '<span style="color:' + col + ';font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.1em">' + fam + ' (' + families[fam] + ' exercises)</span>';
    html += '<ul style="margin:6px 0 0;padding-left:16px">';
    stretches.forEach(function(s) { html += '<li style="color:#cbd5e1;font-size:11px;margin-bottom:4px;line-height:1.4">' + s + '</li>'; });
    html += '</ul></div>';
  });
  html += '<div style="margin-top:12px;padding:12px;background:rgba(34,211,238,0.05);border-radius:8px;border:1px solid rgba(34,211,238,0.1)">';
  html += '<span style="color:#22d3ee;font-size:10px;font-weight:600">General</span>';
  html += '<ul style="margin:4px 0 0;padding-left:16px"><li style="color:#94a3b8;font-size:10px;margin-bottom:2px">Walk for 2-3 minutes</li>';
  html += '<li style="color:#94a3b8;font-size:10px;margin-bottom:2px">Hydrate (300-500ml water)</li>';
  html += '<li style="color:#94a3b8;font-size:10px">5 deep breaths (inhale 4s, hold 4s, exhale 6s)</li></ul></div>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 342: Session Summary Card
function generateSummaryCard() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips for summary card'); return; }
  var workoutName = '';
  var nameEl = document.getElementById('workout-name') || document.querySelector('.breadcrumb-name');
  if (nameEl) workoutName = nameEl.textContent || 'Workout';
  var totalSets = 0, totalReps = 0, totalRPE = 0, rpeCount = 0;
  var families = {};
  var exercises = [];
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var rpe = parseInt(c.dataset.rpe);
    totalSets += sets;
    totalReps += sets * reps;
    if (rpe) { totalRPE += rpe; rpeCount++; }
    var fam = c.dataset.family || 'core';
    families[fam] = (families[fam] || 0) + 1;
    exercises.push(c.dataset.exercise || c.textContent.trim().split('\n')[0]);
  });
  var avgRPE = rpeCount > 0 ? (totalRPE / rpeCount).toFixed(1) : '-';
  var bpm = typeof _bpm !== 'undefined' ? _bpm : 100;
  var uniqueEx = [];
  exercises.forEach(function(e) { if (uniqueEx.indexOf(e) < 0) uniqueEx.push(e); });
  var famKeys = Object.keys(families).sort(function(a, b) { return families[b] - families[a]; });
  var famColors = { push: '#f87171', pull: '#60a5fa', core: '#fbbf24', legs: '#4ade80', skills: '#c084fc', flow: '#22d3ee' };
  var canvas = document.createElement('canvas');
  canvas.width = 600;
  canvas.height = 400;
  var ctx = canvas.getContext('2d');
  ctx.fillStyle = '#050711';
  ctx.fillRect(0, 0, 600, 400);
  ctx.fillStyle = '#0a0f1e';
  ctx.fillRect(16, 16, 568, 368);
  ctx.strokeStyle = 'rgba(34,211,238,0.2)';
  ctx.lineWidth = 1;
  ctx.strokeRect(16, 16, 568, 368);
  ctx.font = '600 18px Sora, sans-serif';
  ctx.fillStyle = '#e2e8f0';
  ctx.fillText(workoutName, 40, 56);
  ctx.font = '400 10px Sora, sans-serif';
  ctx.fillStyle = '#64748b';
  ctx.fillText(new Date().toLocaleDateString() + '  |  ' + bpm + ' BPM', 40, 76);
  var stats = [
    { label: 'Exercises', value: clips.length },
    { label: 'Unique', value: uniqueEx.length },
    { label: 'Total Sets', value: totalSets },
    { label: 'Total Reps', value: totalReps },
    { label: 'Avg RPE', value: avgRPE },
    { label: 'Families', value: famKeys.length }
  ];
  var sx = 40;
  stats.forEach(function(s) {
    ctx.font = '700 20px Sora, sans-serif';
    ctx.fillStyle = '#22d3ee';
    ctx.fillText('' + s.value, sx, 120);
    ctx.font = '400 8px Sora, sans-serif';
    ctx.fillStyle = '#475569';
    ctx.fillText(s.label, sx, 134);
    sx += 90;
  });
  var fy = 164;
  famKeys.forEach(function(f, idx) {
    var col = famColors[f] || '#94a3b8';
    var barWidth = Math.round((families[f] / clips.length) * 400);
    ctx.fillStyle = col + '30';
    ctx.fillRect(40, fy + idx * 24, barWidth, 16);
    ctx.fillStyle = col;
    ctx.font = '600 9px Sora, sans-serif';
    ctx.fillText(f.toUpperCase() + ' ' + families[f], 46, fy + idx * 24 + 12);
  });
  ctx.fillStyle = '#475569';
  ctx.font = '400 8px Sora, sans-serif';
  ctx.fillText('Saturno Movement Studio', 40, 380);
  ctx.fillStyle = '#22d3ee';
  ctx.fillText('saturnomovement.com', 240, 380);
  canvas.toBlob(function(blob) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (workoutName.replace(/[^a-zA-Z0-9]/g, '_') || 'workout') + '_card.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Summary card downloaded');
  }, 'image/png');
}

// Batch 343: Workout Bookmarks
var _workoutBookmarks = [];
function addBookmark() {
  var playhead = 0;
  var ph = document.getElementById('playhead');
  if (ph) playhead = parseFloat(ph.style.left) || 0;
  var label = 'Bookmark ' + (_workoutBookmarks.length + 1);
  _workoutBookmarks.push({ position: playhead, label: label, time: new Date().toLocaleTimeString() });
  showToast('Bookmark added at ' + Math.round(playhead) + 'px');
}
function showBookmarks() {
  if (!_workoutBookmarks.length) { showToast('No bookmarks. Press Cmd+K and add one.'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:400px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Bookmarks (' + _workoutBookmarks.length + ')</span>';
  _workoutBookmarks.forEach(function(bm, idx) {
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">';
    html += '<button onclick="jumpToBookmark(' + idx + ');this.closest(\'div[style*=fixed]\').remove()" style="background:none;border:none;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;text-align:left;flex:1;padding:0">' + bm.label + ' <span style="color:#475569;font-size:9px">(' + bm.time + ')</span></button>';
    html += '<button onclick="removeBookmark(' + idx + ');this.closest(\'div[style*=fixed]\').remove();showBookmarks()" style="background:none;border:none;color:#f87171;cursor:pointer;font-family:Sora,sans-serif;font-size:10px;padding:0 4px">X</button></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function jumpToBookmark(idx) {
  var bm = _workoutBookmarks[idx];
  if (!bm) return;
  var ph = document.getElementById('playhead');
  if (ph) ph.style.left = bm.position + 'px';
  showToast('Jumped to: ' + bm.label);
}
function removeBookmark(idx) {
  _workoutBookmarks.splice(idx, 1);
  showToast('Bookmark removed');
}
function clearAllBookmarks() {
  _workoutBookmarks = [];
  showToast('All bookmarks cleared');
}

// Batch 344: Exercise Pairing Suggestions
function suggestPairings() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('Add exercises first'); return; }
  var families = {};
  clips.forEach(function(c) {
    var fam = c.dataset.family || 'core';
    if (!families[fam]) families[fam] = [];
    families[fam].push(c.dataset.exercise || c.textContent.trim().split('\n')[0]);
  });
  var pairingRules = [
    { a: 'push', b: 'pull', reason: 'Antagonist pairing: balanced push-pull load' },
    { a: 'legs', b: 'core', reason: 'Lower body + stability: functional chain' },
    { a: 'push', b: 'core', reason: 'Upper + stability: core engaged during press' },
    { a: 'pull', b: 'legs', reason: 'Pull + lower: full body distribution' },
    { a: 'skills', b: 'core', reason: 'Skill + stability: balance foundation' }
  ];
  var suggestions = [];
  pairingRules.forEach(function(rule) {
    if (families[rule.a] && families[rule.a].length && families[rule.b] && families[rule.b].length) {
      var exA = families[rule.a][Math.floor(Math.random() * families[rule.a].length)];
      var exB = families[rule.b][Math.floor(Math.random() * families[rule.b].length)];
      suggestions.push({ exA: exA, famA: rule.a, exB: exB, famB: rule.b, reason: rule.reason });
    }
  });
  var missing = [];
  ['push', 'pull', 'core', 'legs'].forEach(function(f) {
    if (!families[f] || !families[f].length) missing.push(f);
  });
  var famColors = { push: '#f87171', pull: '#60a5fa', core: '#fbbf24', legs: '#4ade80', skills: '#c084fc', flow: '#22d3ee' };
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Superset Pairing Suggestions</span>';
  if (!suggestions.length) {
    html += '<p style="color:#94a3b8;font-size:11px">Need exercises from multiple families for pairing suggestions.</p>';
  }
  suggestions.forEach(function(s) {
    html += '<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)">';
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
    html += '<span style="color:' + (famColors[s.famA] || '#94a3b8') + ';font-size:11px;font-weight:600">' + s.exA + '</span>';
    html += '<span style="color:#475569;font-size:10px">+</span>';
    html += '<span style="color:' + (famColors[s.famB] || '#94a3b8') + ';font-size:11px;font-weight:600">' + s.exB + '</span></div>';
    html += '<span style="color:#64748b;font-size:9px">' + s.reason + '</span></div>';
  });
  if (missing.length) {
    html += '<div style="margin-top:12px;padding:10px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.1);border-radius:6px">';
    html += '<span style="color:#fbbf24;font-size:9px;font-weight:600">Missing families: ' + missing.join(', ') + '</span></div>';
  }
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 345: Keyboard Macro Recorder
var _macroRecording = false;
var _macroActions = [];
var _savedMacros = {};
function startMacroRecord() {
  _macroRecording = true;
  _macroActions = [];
  showToast('Macro recording started... execute commands, then stop.');
}
function stopMacroRecord() {
  _macroRecording = false;
  if (!_macroActions.length) { showToast('No actions recorded'); return; }
  var name = 'Macro ' + (Object.keys(_savedMacros).length + 1);
  _savedMacros[name] = _macroActions.slice();
  try { localStorage.setItem('sms_macros', JSON.stringify(_savedMacros)); } catch(e) {}
  showToast('Macro saved: ' + name + ' (' + _macroActions.length + ' actions)');
  _macroActions = [];
}
function recordMacroAction(label, actionFn) {
  if (_macroRecording) {
    _macroActions.push({ label: label, fn: actionFn.toString() });
  }
}
function showMacroList() {
  try { var d = localStorage.getItem('sms_macros'); if (d) _savedMacros = JSON.parse(d); } catch(e) {}
  var keys = Object.keys(_savedMacros);
  if (!keys.length) { showToast('No saved macros. Record one first.'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:400px;width:90%;max-height:70vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Saved Macros</span>';
  keys.forEach(function(k) {
    var actions = _savedMacros[k];
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">';
    html += '<div><span style="color:#e2e8f0;font-size:11px;font-weight:600">' + k + '</span>';
    html += '<div style="color:#64748b;font-size:9px;margin-top:2px">' + actions.length + ' actions: ' + actions.map(function(a) { return a.label; }).join(', ').slice(0, 60) + '</div></div>';
    html += '<button onclick="playMacro(\'' + k.replace(/'/g, "\\'") + '\');this.closest(\'div[style*=fixed]\').remove()" style="padding:4px 12px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.2);border-radius:6px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:9px;flex-shrink:0">Play</button></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function playMacro(name) {
  var macro = _savedMacros[name];
  if (!macro || !macro.length) { showToast('Macro not found'); return; }
  showToast('Playing macro: ' + name + ' (' + macro.length + ' actions)');
  macro.forEach(function(action, idx) {
    setTimeout(function() {
      try { var fn = new Function(action.fn); fn(); } catch(e) {}
    }, idx * 200);
  });
}
function clearMacros() {
  _savedMacros = {};
  try { localStorage.removeItem('sms_macros'); } catch(e) {}
  showToast('All macros cleared');
}

// Batch 346: Workout Preview Animation
var _previewAnimId = null;
function previewWorkout() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (!clips.length) { showToast('No clips to preview'); return; }
  var ph = document.getElementById('playhead');
  if (!ph) return;
  var sorted = clips.sort(function(a, b) { return parseFloat(a.style.left) - parseFloat(b.style.left); });
  var maxRight = 0;
  sorted.forEach(function(c) {
    var r = parseFloat(c.style.left) + parseFloat(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var startPos = 0;
  var endPos = maxRight + 50;
  var speed = 3;
  var currentPos = startPos;
  showToast('Preview starting...');
  function animate() {
    currentPos += speed;
    if (currentPos > endPos) { cancelAnimationFrame(_previewAnimId); ph.style.left = '0px'; showToast('Preview complete'); return; }
    ph.style.left = currentPos + 'px';
    clips.forEach(function(c) {
      var cl = parseFloat(c.style.left);
      var cr = cl + parseFloat(c.style.width);
      if (currentPos >= cl && currentPos <= cr) {
        c.style.outline = '2px solid #22d3ee';
        c.style.filter = 'brightness(1.3)';
      } else {
        c.style.outline = '';
        c.style.filter = '';
      }
    });
    _previewAnimId = requestAnimationFrame(animate);
  }
  _previewAnimId = requestAnimationFrame(animate);
}
function stopPreview() {
  if (_previewAnimId) { cancelAnimationFrame(_previewAnimId); _previewAnimId = null; }
  document.querySelectorAll('.clip').forEach(function(c) { c.style.outline = ''; c.style.filter = ''; });
  showToast('Preview stopped');
}

// Batch 347: Exercise Sort Modes
var _librarySortMode = 'alpha';
function sortLibrary(mode) {
  _librarySortMode = mode;
  var libraryEl = document.querySelector('.panel-left .library-list, .panel-left ul, .panel-left [class*=library]');
  if (!libraryEl) { showToast('Library not found'); return; }
  var items = Array.from(libraryEl.querySelectorAll('.library-item, li'));
  if (!items.length) { showToast('No library items to sort'); return; }
  items.sort(function(a, b) {
    if (mode === 'alpha') {
      return (a.textContent || '').trim().localeCompare((b.textContent || '').trim());
    } else if (mode === 'family') {
      var famA = a.dataset.family || a.getAttribute('data-family') || 'z';
      var famB = b.dataset.family || b.getAttribute('data-family') || 'z';
      return famA.localeCompare(famB);
    } else if (mode === 'difficulty') {
      var exA = a.dataset.exercise || a.textContent.trim();
      var exB = b.dataset.exercise || b.textContent.trim();
      var dA = _exerciseDifficulty[exA] || 0;
      var dB = _exerciseDifficulty[exB] || 0;
      return dB - dA;
    } else if (mode === 'frequency') {
      var eA = a.dataset.exercise || a.textContent.trim();
      var eB = b.dataset.exercise || b.textContent.trim();
      var countA = document.querySelectorAll('.clip[data-exercise="' + eA + '"]').length;
      var countB = document.querySelectorAll('.clip[data-exercise="' + eB + '"]').length;
      return countB - countA;
    }
    return 0;
  });
  items.forEach(function(item) { libraryEl.appendChild(item); });
  showToast('Library sorted: ' + mode);
}

// Batch 348: Session Debrief
function showSessionDebrief() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No workout to debrief'); return; }
  var totalSets = 0, totalReps = 0, totalRPE = 0, rpeCount = 0;
  var families = {};
  clips.forEach(function(c) {
    totalSets += parseInt(c.dataset.sets) || 3;
    totalReps += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8);
    var rpe = parseInt(c.dataset.rpe);
    if (rpe) { totalRPE += rpe; rpeCount++; }
    families[c.dataset.family || 'core'] = true;
  });
  var avgRPE = rpeCount > 0 ? (totalRPE / rpeCount).toFixed(1) : '-';
  var html = '<div id="debrief-overlay" style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.97);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:16px;padding:32px;max-width:420px;width:90%;max-height:85vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:16px;font-weight:700;display:block;margin-bottom:4px">Session Debrief</span>';
  html += '<span style="color:#64748b;font-size:10px;display:block;margin-bottom:20px">' + clips.length + ' exercises | ' + totalSets + ' sets | ' + totalReps + ' reps | RPE ' + avgRPE + '</span>';
  var questions = [
    { id: 'energy', label: 'How was your energy?', options: ['Low', 'Medium', 'High', 'Peak'] },
    { id: 'focus', label: 'Mental focus?', options: ['Scattered', 'Okay', 'Locked In', 'Flow State'] },
    { id: 'execution', label: 'Execution quality?', options: ['Rough', 'Decent', 'Clean', 'Perfect'] },
    { id: 'enjoyment', label: 'Did you enjoy it?', options: ['Hated It', 'Meh', 'Good', 'Loved It'] }
  ];
  questions.forEach(function(q) {
    html += '<div style="margin-bottom:16px">';
    html += '<span style="color:#94a3b8;font-size:10px;display:block;margin-bottom:6px">' + q.label + '</span>';
    html += '<div style="display:flex;gap:4px">';
    q.options.forEach(function(opt, idx) {
      var col = idx === 0 ? '#f87171' : (idx === 1 ? '#fbbf24' : (idx === 2 ? '#4ade80' : '#22d3ee'));
      html += '<button class="debrief-opt" data-q="' + q.id + '" onclick="selectDebriefOption(this,\'' + q.id + '\',\'' + opt + '\')" style="flex:1;padding:8px 4px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:6px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:9px" data-col="' + col + '">' + opt + '</button>';
    });
    html += '</div></div>';
  });
  html += '<textarea id="debrief-notes" placeholder="Any notes for next time?" style="width:100%;height:60px;padding:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;resize:none;box-sizing:border-box;margin-bottom:12px"></textarea>';
  html += '<button onclick="saveDebrief()" style="width:100%;padding:12px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:12px;font-weight:600">Save Debrief</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
var _debriefData = {};
function selectDebriefOption(btn, qid, value) {
  document.querySelectorAll('.debrief-opt[data-q="' + qid + '"]').forEach(function(b) {
    b.style.borderColor = 'rgba(255,255,255,0.06)';
    b.style.color = '#64748b';
    b.style.background = 'rgba(255,255,255,0.02)';
  });
  var col = btn.dataset.col || '#22d3ee';
  btn.style.borderColor = col;
  btn.style.color = col;
  btn.style.background = col + '15';
  _debriefData[qid] = value;
}
function saveDebrief() {
  var notes = document.getElementById('debrief-notes');
  _debriefData.notes = notes ? notes.value : '';
  _debriefData.date = new Date().toISOString();
  _debriefData.clipCount = document.querySelectorAll('.clip').length;
  var debriefs = [];
  try { var d = localStorage.getItem('sms_debriefs'); if (d) debriefs = JSON.parse(d); } catch(e) {}
  debriefs.push(_debriefData);
  if (debriefs.length > 50) debriefs = debriefs.slice(-50);
  try { localStorage.setItem('sms_debriefs', JSON.stringify(debriefs)); } catch(e) {}
  var ov = document.getElementById('debrief-overlay');
  if (ov) ov.remove();
  _debriefData = {};
  showToast('Debrief saved!');
}

// Batch 349: Workout Changelog
var _workoutChangelog = [];
function logChange(action, detail) {
  _workoutChangelog.push({
    time: new Date().toLocaleTimeString(),
    action: action,
    detail: detail || ''
  });
  if (_workoutChangelog.length > 200) _workoutChangelog = _workoutChangelog.slice(-200);
}
function showChangelog() {
  if (!_workoutChangelog.length) { showToast('No changes logged yet'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:460px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Workout Changelog (' + _workoutChangelog.length + ')</span>';
  _workoutChangelog.slice().reverse().forEach(function(entry) {
    html += '<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.02);font-size:10px">';
    html += '<span style="color:#475569;font-variant-numeric:tabular-nums;flex-shrink:0;width:60px">' + entry.time + '</span>';
    html += '<span style="color:#22d3ee;font-weight:600;flex-shrink:0;width:80px">' + entry.action + '</span>';
    html += '<span style="color:#94a3b8">' + entry.detail + '</span></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function clearChangelog() {
  _workoutChangelog = [];
  showToast('Changelog cleared');
}

// Batch 350: Multi-Workout Week Planner
function showWeekPlanner() {
  var days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  var plan = {};
  try { var d = localStorage.getItem('sms_week_plan'); if (d) plan = JSON.parse(d); } catch(e) {}
  var saved = [];
  try { var s = localStorage.getItem('sms_saved_workouts'); if (s) saved = JSON.parse(s); } catch(e) {}
  var html = '<div id="week-planner-overlay" style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:flex-start;justify-content:center;padding-top:40px;font-family:Sora,sans-serif;overflow-y:auto">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:560px;width:95%">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><span style="color:#e2e8f0;font-size:14px;font-weight:600">Training Week Planner</span>';
  html += '<button onclick="document.getElementById(\'week-planner-overlay\').remove()" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:18px;font-family:Sora,sans-serif">X</button></div>';
  days.forEach(function(day) {
    var assigned = plan[day] || '';
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
    html += '<span style="color:#64748b;font-size:10px;font-weight:600;width:80px;flex-shrink:0">' + day.slice(0, 3) + '</span>';
    html += '<select class="week-day-select" data-day="' + day + '" style="flex:1;padding:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:6px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:10px">';
    html += '<option value="">Rest Day</option>';
    html += '<option value="__current__"' + (assigned === '__current__' ? ' selected' : '') + '>Current Workout</option>';
    saved.forEach(function(s, idx) {
      html += '<option value="' + idx + '"' + (assigned === '' + idx ? ' selected' : '') + '>' + (s.name || 'Untitled ' + (idx + 1)) + '</option>';
    });
    html += '</select></div>';
  });
  html += '<button onclick="saveWeekPlan()" style="width:100%;margin-top:12px;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Save Week Plan</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function saveWeekPlan() {
  var plan = {};
  document.querySelectorAll('.week-day-select').forEach(function(sel) {
    plan[sel.dataset.day] = sel.value;
  });
  try { localStorage.setItem('sms_week_plan', JSON.stringify(plan)); } catch(e) {}
  showToast('Week plan saved');
}
function loadTodaysWorkout() {
  var plan = {};
  try { var d = localStorage.getItem('sms_week_plan'); if (d) plan = JSON.parse(d); } catch(e) {}
  var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  var today = days[new Date().getDay()];
  var assigned = plan[today];
  if (!assigned) { showToast('Today (' + today + ') is a rest day!'); return; }
  if (assigned === '__current__') { showToast('Today\'s workout is the current one'); return; }
  var idx = parseInt(assigned);
  if (!isNaN(idx) && typeof loadNamedWorkout === 'function') {
    loadNamedWorkout(idx);
    showToast('Loaded ' + today + '\'s workout');
  }
}

// Batch 351: Workout Complexity Radar
function showComplexityRadar() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips for radar'); return; }
  var metrics = { volume: 0, intensity: 0, variety: 0, balance: 0, complexity: 0 };
  var totalSets = 0, totalRPE = 0, rpeCount = 0;
  var families = {}, patterns = {}, exercises = {};
  clips.forEach(function(c) {
    totalSets += parseInt(c.dataset.sets) || 3;
    var rpe = parseInt(c.dataset.rpe);
    if (rpe) { totalRPE += rpe; rpeCount++; }
    families[c.dataset.family || 'core'] = true;
    patterns[c.dataset.pattern || ''] = true;
    exercises[c.dataset.exercise || ''] = true;
  });
  metrics.volume = Math.min(100, Math.round(totalSets / 0.4));
  metrics.intensity = rpeCount > 0 ? Math.round((totalRPE / rpeCount) * 10) : 50;
  metrics.variety = Math.min(100, Object.keys(exercises).length * 8);
  metrics.balance = Math.min(100, Object.keys(families).length * 20);
  metrics.complexity = Math.min(100, (Object.keys(patterns).length * 15 + Object.keys(exercises).length * 3));
  var labels = ['Volume', 'Intensity', 'Variety', 'Balance', 'Complexity'];
  var values = [metrics.volume, metrics.intensity, metrics.variety, metrics.balance, metrics.complexity];
  var cx = 200, cy = 200, radius = 150;
  var angleStep = (2 * Math.PI) / 5;
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400" style="background:#050711">';
  for (var ring = 1; ring <= 4; ring++) {
    var r = radius * ring / 4;
    var pts = [];
    for (var i = 0; i < 5; i++) {
      var angle = i * angleStep - Math.PI / 2;
      pts.push((cx + Math.cos(angle) * r) + ',' + (cy + Math.sin(angle) * r));
    }
    svg += '<polygon points="' + pts.join(' ') + '" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>';
  }
  for (var i = 0; i < 5; i++) {
    var angle = i * angleStep - Math.PI / 2;
    var lx = cx + Math.cos(angle) * radius;
    var ly = cy + Math.sin(angle) * radius;
    svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + lx + '" y2="' + ly + '" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>';
    var tlx = cx + Math.cos(angle) * (radius + 20);
    var tly = cy + Math.sin(angle) * (radius + 20);
    svg += '<text x="' + tlx + '" y="' + tly + '" text-anchor="middle" fill="#64748b" font-family="Sora,sans-serif" font-size="9">' + labels[i] + '</text>';
    svg += '<text x="' + tlx + '" y="' + (tly + 12) + '" text-anchor="middle" fill="#22d3ee" font-family="Sora,sans-serif" font-size="10" font-weight="700">' + values[i] + '</text>';
  }
  var dataPts = [];
  for (var i = 0; i < 5; i++) {
    var angle = i * angleStep - Math.PI / 2;
    var v = values[i] / 100 * radius;
    dataPts.push((cx + Math.cos(angle) * v) + ',' + (cy + Math.sin(angle) * v));
  }
  svg += '<polygon points="' + dataPts.join(' ') + '" fill="rgba(34,211,238,0.15)" stroke="#22d3ee" stroke-width="2"/>';
  dataPts.forEach(function(p) {
    var parts = p.split(',');
    svg += '<circle cx="' + parts[0] + '" cy="' + parts[1] + '" r="3" fill="#22d3ee"/>';
  });
  svg += '</svg>';
  var tab = window.open('', '_blank');
  if (tab) { tab.document.write('<html><head><title>Complexity Radar</title></head><body style="margin:0;background:#050711;display:flex;align-items:center;justify-content:center;min-height:100vh">' + svg + '</body></html>'); tab.document.close(); }
}

// Batch 352: Workout Challenge Mode
var _challengeTimer = null;
var _challengeOverlay = null;
function startChallenge(type) {
  var challenges = {
    speed: { name: 'Speed Build', desc: 'Build a 12-exercise workout in 2 minutes', target: 12, time: 120 },
    variety: { name: 'Family Blitz', desc: 'Use all 5 families in 90 seconds', target: 5, time: 90 },
    volume: { name: 'Volume King', desc: 'Reach 50 total sets in 3 minutes', target: 50, time: 180 },
    balance: { name: 'Perfect Balance', desc: 'Equal clips per family (4 each) in 2 minutes', target: 4, time: 120 }
  };
  var ch = challenges[type];
  if (!ch) { showToast('Unknown challenge: ' + type); return; }
  if (_challengeTimer) clearInterval(_challengeTimer);
  if (_challengeOverlay) _challengeOverlay.remove();
  var timeLeft = ch.time;
  var ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;top:8px;right:8px;z-index:9998;background:rgba(5,7,17,0.95);border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:12px 20px;font-family:Sora,sans-serif;text-align:center';
  ov.innerHTML = '<div style="color:#fbbf24;font-size:9px;text-transform:uppercase;letter-spacing:0.1em;font-weight:600">' + ch.name + '</div><div id="challenge-timer" style="color:#e2e8f0;font-size:24px;font-weight:300;font-variant-numeric:tabular-nums;margin:4px 0">' + formatTimerSec(timeLeft) + '</div><div id="challenge-progress" style="color:#64748b;font-size:9px">' + ch.desc + '</div><button onclick="endChallenge()" style="margin-top:6px;padding:3px 10px;background:none;border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:8px">Give Up</button>';
  document.body.appendChild(ov);
  _challengeOverlay = ov;
  var timerEl = ov.querySelector('#challenge-timer');
  var progressEl = ov.querySelector('#challenge-progress');
  _challengeTimer = setInterval(function() {
    timeLeft--;
    if (timeLeft <= 0) {
      var result = checkChallengeResult(type, ch);
      endChallenge();
      showToast(result ? ch.name + ' COMPLETE!' : ch.name + ' FAILED. Try again!');
      return;
    }
    timerEl.textContent = formatTimerSec(timeLeft);
    updateChallengeProgress(type, ch, progressEl);
  }, 1000);
  if (navigator.vibrate) navigator.vibrate(200);
  showToast(ch.name + ' started! ' + ch.desc);
}
function updateChallengeProgress(type, ch, el) {
  var clips = document.querySelectorAll('.clip');
  if (type === 'speed') el.textContent = clips.length + '/' + ch.target + ' exercises';
  else if (type === 'variety') {
    var fams = {};
    clips.forEach(function(c) { fams[c.dataset.family || 'core'] = true; });
    el.textContent = Object.keys(fams).length + '/' + ch.target + ' families';
  } else if (type === 'volume') {
    var sets = 0;
    clips.forEach(function(c) { sets += parseInt(c.dataset.sets) || 3; });
    el.textContent = sets + '/' + ch.target + ' sets';
  } else if (type === 'balance') {
    var fams = {};
    clips.forEach(function(c) { var f = c.dataset.family || 'core'; fams[f] = (fams[f] || 0) + 1; });
    var balanced = Object.keys(fams).filter(function(f) { return fams[f] >= ch.target; }).length;
    el.textContent = balanced + '/5 families with ' + ch.target + '+ clips';
  }
}
function checkChallengeResult(type, ch) {
  var clips = document.querySelectorAll('.clip');
  if (type === 'speed') return clips.length >= ch.target;
  if (type === 'variety') {
    var fams = {};
    clips.forEach(function(c) { fams[c.dataset.family || 'core'] = true; });
    return Object.keys(fams).length >= ch.target;
  }
  if (type === 'volume') {
    var sets = 0;
    clips.forEach(function(c) { sets += parseInt(c.dataset.sets) || 3; });
    return sets >= ch.target;
  }
  if (type === 'balance') {
    var fams = {};
    clips.forEach(function(c) { var f = c.dataset.family || 'core'; fams[f] = (fams[f] || 0) + 1; });
    return Object.keys(fams).filter(function(f) { return fams[f] >= ch.target; }).length >= 5;
  }
  return false;
}
function endChallenge() {
  if (_challengeTimer) { clearInterval(_challengeTimer); _challengeTimer = null; }
  if (_challengeOverlay) { _challengeOverlay.remove(); _challengeOverlay = null; }
}

// Batch 353: Exercise Movement Cues
var _movementCues = {};
function loadMovementCues() {
  try { var d = localStorage.getItem('sms_movement_cues'); if (d) _movementCues = JSON.parse(d); } catch(e) {}
}
function saveMovementCues() {
  try { localStorage.setItem('sms_movement_cues', JSON.stringify(_movementCues)); } catch(e) {}
}
function showCueEditor() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || '';
  loadMovementCues();
  var cues = _movementCues[name] || '';
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600;display:block;margin-bottom:4px">' + name + '</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:12px">Coaching cues for proper form</span>';
  html += '<textarea id="cue-editor" placeholder="e.g. Engage lats before pull\nHollow body position\nSlow eccentric 3 seconds..." style="width:100%;height:100px;padding:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;resize:vertical;box-sizing:border-box;line-height:1.6">' + cues + '</textarea>';
  html += '<button onclick="var t=document.getElementById(\'cue-editor\').value;saveCue(\'' + name.replace(/'/g, "\\'") + '\',t);this.closest(\'div[style*=fixed]\').remove()" style="width:100%;margin-top:8px;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Save Cues</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function saveCue(name, text) {
  _movementCues[name] = text;
  saveMovementCues();
  showToast('Cues saved for ' + name);
}
function showCueForClip() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || '';
  loadMovementCues();
  var cues = _movementCues[name];
  if (!cues) { showToast('No cues set for ' + name + '. Use Edit Cues to add them.'); return; }
  showRecoveryToast(name + '\n\n' + cues);
}
loadMovementCues();

// Batch 354: Audio Narration Generator
function generateNarration() {
  if (!('speechSynthesis' in window)) { showToast('Speech not supported in this browser'); return; }
  var clips = Array.from(document.querySelectorAll('.clip')).sort(function(a, b) {
    var tA = a.closest('.track-lane') ? parseInt(a.closest('.track-lane').dataset.track) : 0;
    var tB = b.closest('.track-lane') ? parseInt(b.closest('.track-lane').dataset.track) : 0;
    if (tA !== tB) return tA - tB;
    return parseFloat(a.style.left) - parseFloat(b.style.left);
  });
  if (!clips.length) { showToast('No exercises to narrate'); return; }
  var text = 'Starting workout. ';
  clips.forEach(function(c, idx) {
    var name = c.dataset.exercise || 'exercise';
    var sets = c.dataset.sets || '3';
    var reps = c.dataset.reps || '8';
    var rest = c.dataset.rest || '60';
    text += 'Exercise ' + (idx + 1) + ': ' + name + '. ' + sets + ' sets of ' + reps + ' reps. Rest ' + rest + ' seconds. ';
  });
  text += 'Workout complete. Great job!';
  var utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 0.9;
  utterance.pitch = 1;
  utterance.volume = 0.8;
  var voices = speechSynthesis.getVoices();
  var english = voices.filter(function(v) { return v.lang.indexOf('en') === 0; });
  if (english.length) utterance.voice = english[0];
  speechSynthesis.speak(utterance);
  showToast('Narrating ' + clips.length + ' exercises... Press Stop Narration to cancel.');
}
function stopNarration() {
  if ('speechSynthesis' in window) speechSynthesis.cancel();
  showToast('Narration stopped');
}

// Batch 355: Workout Visual Themes
var _currentTheme = 'default';
var WORKOUT_THEMES = {
  default: { name: 'Cosmic Blue', bg: '#050711', surface: '#0a0f1e', accent: '#22d3ee', text: '#e2e8f0', muted: '#64748b' },
  midnight: { name: 'Midnight', bg: '#0a0a12', surface: '#12121e', accent: '#818cf8', text: '#e0e0e8', muted: '#6b6b8a' },
  ember: { name: 'Ember', bg: '#0f0807', surface: '#1a0f0c', accent: '#f97316', text: '#fde8d0', muted: '#8b6b5a' },
  frost: { name: 'Frost', bg: '#060a0f', surface: '#0c1420', accent: '#38bdf8', text: '#e0ecf8', muted: '#5a7a9b' },
  neon: { name: 'Neon', bg: '#050508', surface: '#0a0a14', accent: '#a3e635', text: '#e8f0d0', muted: '#6a7a5a' }
};
function applyTheme(themeKey) {
  var theme = WORKOUT_THEMES[themeKey];
  if (!theme) return;
  _currentTheme = themeKey;
  var root = document.documentElement;
  root.style.setProperty('--bg', theme.bg);
  root.style.setProperty('--surface', theme.surface);
  root.style.setProperty('--accent', theme.accent);
  root.style.setProperty('--text', theme.text);
  root.style.setProperty('--muted', theme.muted);
  document.body.style.background = theme.bg;
  document.body.style.color = theme.text;
  try { localStorage.setItem('sms_theme', themeKey); } catch(e) {}
  showToast('Theme: ' + theme.name);
}
function showThemePicker() {
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.9);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:400px">';
  Object.keys(WORKOUT_THEMES).forEach(function(key) {
    var t = WORKOUT_THEMES[key];
    var active = key === _currentTheme;
    html += '<button onclick="applyTheme(\'' + key + '\');this.closest(\'div[style*=fixed]\').remove()" style="width:80px;padding:16px 8px;background:' + t.bg + ';border:2px solid ' + (active ? t.accent : 'rgba(255,255,255,0.1)') + ';border-radius:12px;cursor:pointer;text-align:center">';
    html += '<div style="width:24px;height:24px;border-radius:50%;background:' + t.accent + ';margin:0 auto 8px"></div>';
    html += '<span style="color:' + t.text + ';font-family:Sora,sans-serif;font-size:9px;font-weight:600">' + t.name + '</span></button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
(function() {
  try { var t = localStorage.getItem('sms_theme'); if (t && WORKOUT_THEMES[t]) applyTheme(t); } catch(e) {}
})();

// Batch 356: Exercise Progression Tracking
var _progressionState = {};
function loadProgressionState() {
  try { var d = localStorage.getItem('sms_progression_state'); if (d) _progressionState = JSON.parse(d); } catch(e) {}
}
function saveProgressionState() {
  try { localStorage.setItem('sms_progression_state', JSON.stringify(_progressionState)); } catch(e) {}
}
function setProgressionStage(pattern, stage) {
  _progressionState[pattern] = stage;
  saveProgressionState();
  showToast(pattern + ' progression set to Stage ' + stage);
}
function showProgressionTracker() {
  loadProgressionState();
  var patterns = [];
  if (typeof EXERCISES !== 'undefined') {
    var seen = {};
    EXERCISES.forEach(function(ex) {
      if (ex.pattern && !seen[ex.pattern]) {
        seen[ex.pattern] = true;
        patterns.push(ex.pattern);
      }
    });
  }
  if (!patterns.length) patterns = ['Horizontal Push', 'Horizontal Pull', 'Downward Press', 'Vertical Pull', 'Overhead Press', 'Knee-Dominant', 'Hip-Dominant'];
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:460px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Progression Tracker</span>';
  patterns.forEach(function(p) {
    var current = _progressionState[p] || 1;
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">';
    html += '<span style="color:#e2e8f0;font-size:11px;flex:1">' + p + '</span>';
    html += '<div style="display:flex;gap:4px">';
    for (var s = 1; s <= 3; s++) {
      var active = s <= current;
      html += '<button onclick="setProgressionStage(\'' + p.replace(/'/g, "\\'") + '\',' + s + ');this.closest(\'div[style*=fixed]\').remove();showProgressionTracker()" style="width:28px;height:28px;border-radius:6px;border:1px solid ' + (active ? 'rgba(34,211,238,0.5)' : 'rgba(255,255,255,0.1)') + ';background:' + (active ? 'rgba(34,211,238,0.15)' : 'rgba(255,255,255,0.02)') + ';color:' + (active ? '#22d3ee' : '#475569') + ';cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:700">S' + s + '</button>';
    }
    html += '</div></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
loadProgressionState();

// Batch 357: Quick Access Toolbar
var _quickAccessCommands = [];
function loadQuickAccess() {
  try { var d = localStorage.getItem('sms_quick_access'); if (d) _quickAccessCommands = JSON.parse(d); } catch(e) {}
}
function saveQuickAccess() {
  try { localStorage.setItem('sms_quick_access', JSON.stringify(_quickAccessCommands)); } catch(e) {}
}
function pinToQuickAccess(label) {
  loadQuickAccess();
  if (_quickAccessCommands.indexOf(label) >= 0) { showToast('Already pinned'); return; }
  _quickAccessCommands.push(label);
  if (_quickAccessCommands.length > 8) _quickAccessCommands = _quickAccessCommands.slice(-8);
  saveQuickAccess();
  renderQuickAccessBar();
  showToast('Pinned: ' + label);
}
function unpinFromQuickAccess(label) {
  loadQuickAccess();
  _quickAccessCommands = _quickAccessCommands.filter(function(l) { return l !== label; });
  saveQuickAccess();
  renderQuickAccessBar();
  showToast('Unpinned: ' + label);
}
function renderQuickAccessBar() {
  var existing = document.getElementById('quick-access-bar');
  if (existing) existing.remove();
  loadQuickAccess();
  if (!_quickAccessCommands.length) return;
  var bar = document.createElement('div');
  bar.id = 'quick-access-bar';
  bar.style.cssText = 'position:fixed;bottom:40px;left:50%;transform:translateX(-50%);z-index:9000;display:flex;gap:4px;padding:6px 12px;background:rgba(5,7,17,0.95);border:1px solid rgba(34,211,238,0.15);border-radius:12px;font-family:Sora,sans-serif';
  _quickAccessCommands.forEach(function(label) {
    var btn = document.createElement('button');
    btn.style.cssText = 'padding:4px 10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:6px;color:#94a3b8;cursor:pointer;font-family:Sora,sans-serif;font-size:9px;white-space:nowrap';
    btn.textContent = label;
    btn.addEventListener('click', function() {
      if (typeof CMD_ACTIONS !== 'undefined') {
        var found = CMD_ACTIONS.find(function(a) { return a.label === label; });
        if (found) found.action();
      }
    });
    bar.appendChild(btn);
  });
  document.body.appendChild(bar);
}
function showPinPicker() {
  if (typeof CMD_ACTIONS === 'undefined') { showToast('No commands available'); return; }
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:4px">Pin to Quick Access</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:12px">Click a command to pin/unpin</span>';
  loadQuickAccess();
  CMD_ACTIONS.forEach(function(cmd) {
    var pinned = _quickAccessCommands.indexOf(cmd.label) >= 0;
    html += '<button onclick="' + (pinned ? 'unpinFromQuickAccess' : 'pinToQuickAccess') + '(\'' + cmd.label.replace(/'/g, "\\'") + '\');this.closest(\'div[style*=fixed]\').remove()" style="display:block;width:100%;text-align:left;padding:6px 10px;margin-bottom:2px;background:' + (pinned ? 'rgba(34,211,238,0.08)' : 'rgba(255,255,255,0.01)') + ';border:1px solid ' + (pinned ? 'rgba(34,211,238,0.2)' : 'rgba(255,255,255,0.03)') + ';border-radius:4px;color:' + (pinned ? '#22d3ee' : '#94a3b8') + ';cursor:pointer;font-family:Sora,sans-serif;font-size:10px">' + (pinned ? '[-] ' : '[+] ') + cmd.label + '</button>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
loadQuickAccess();
setTimeout(renderQuickAccessBar, 500);

// Batch 358: Workout Stats Dashboard
function showStatsDashboard() {
  var debriefs = [];
  try { var d = localStorage.getItem('sms_debriefs'); if (d) debriefs = JSON.parse(d); } catch(e) {}
  var ratings = [];
  try { var r = localStorage.getItem('sms_workout_ratings'); if (r) ratings = JSON.parse(r); } catch(e) {}
  var journal = [];
  try { var j = localStorage.getItem('sms_movement_journal'); if (j) journal = JSON.parse(j); } catch(e) {}
  var streak = getWorkoutStreak();
  var totalWorkouts = Math.max(debriefs.length, ratings.length, journal.length);
  var avgRating = 0;
  if (ratings.length) {
    var sum = 0;
    ratings.forEach(function(r) { sum += (r.rating || 0); });
    avgRating = (sum / ratings.length).toFixed(1);
  }
  var moodCounts = {};
  journal.forEach(function(j) { if (j.moods) j.moods.forEach(function(m) { moodCounts[m] = (moodCounts[m] || 0) + 1; }); });
  var topMood = '-';
  var topMoodCount = 0;
  Object.keys(moodCounts).forEach(function(m) { if (moodCounts[m] > topMoodCount) { topMoodCount = moodCounts[m]; topMood = m; } });
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.97);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif;overflow-y:auto" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:16px;padding:32px;max-width:520px;width:95%;max-height:85vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:16px;font-weight:700;display:block;margin-bottom:20px">Stats Dashboard</span>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">';
  var statCards = [
    { label: 'Total Workouts', value: totalWorkouts, color: '#22d3ee' },
    { label: 'Current Streak', value: streak.current + 'd', color: '#fbbf24' },
    { label: 'Best Streak', value: streak.best + 'd', color: '#f87171' },
    { label: 'Avg Rating', value: avgRating + '/5', color: '#4ade80' },
    { label: 'Top Mood', value: topMood, color: '#c084fc' },
    { label: 'Journal Entries', value: journal.length, color: '#60a5fa' }
  ];
  statCards.forEach(function(s) {
    html += '<div style="text-align:center;padding:16px 8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-radius:10px">';
    html += '<div style="color:' + s.color + ';font-size:20px;font-weight:700">' + s.value + '</div>';
    html += '<div style="color:#475569;font-size:8px;text-transform:uppercase;letter-spacing:0.1em;margin-top:4px">' + s.label + '</div></div>';
  });
  html += '</div>';
  if (ratings.length > 1) {
    html += '<div style="margin-bottom:16px"><span style="color:#94a3b8;font-size:10px;font-weight:600;display:block;margin-bottom:8px">Rating Trend (last 10)</span>';
    html += '<div style="display:flex;gap:4px;align-items:flex-end;height:60px">';
    ratings.slice(-10).forEach(function(r) {
      var h = Math.max(8, ((r.rating || 0) / 5) * 60);
      var col = (r.rating || 0) >= 4 ? '#4ade80' : ((r.rating || 0) >= 3 ? '#fbbf24' : '#f87171');
      html += '<div style="flex:1;height:' + h + 'px;background:' + col + '40;border-radius:3px 3px 0 0;border-top:2px solid ' + col + '" title="' + (r.rating || '?') + '/5"></div>';
    });
    html += '</div></div>';
  }
  if (Object.keys(moodCounts).length) {
    html += '<div><span style="color:#94a3b8;font-size:10px;font-weight:600;display:block;margin-bottom:8px">Mood Distribution</span>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
    Object.keys(moodCounts).sort(function(a, b) { return moodCounts[b] - moodCounts[a]; }).forEach(function(m) {
      html += '<span style="padding:4px 10px;border:1px solid rgba(34,211,238,0.15);border-radius:12px;color:#94a3b8;font-size:9px">' + m + ' <strong style="color:#22d3ee">' + moodCounts[m] + '</strong></span>';
    });
    html += '</div></div>';
  }
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 359: Exercise Mastery System
var _exerciseMastery = {};
function loadMastery() {
  try { var d = localStorage.getItem('sms_mastery'); if (d) _exerciseMastery = JSON.parse(d); } catch(e) {}
}
function saveMastery() {
  try { localStorage.setItem('sms_mastery', JSON.stringify(_exerciseMastery)); } catch(e) {}
}
function logMastery(exercise, reps, holdTime) {
  loadMastery();
  if (!_exerciseMastery[exercise]) _exerciseMastery[exercise] = { sessions: 0, totalReps: 0, totalHold: 0, dates: [] };
  _exerciseMastery[exercise].sessions++;
  _exerciseMastery[exercise].totalReps += reps || 0;
  _exerciseMastery[exercise].totalHold += holdTime || 0;
  var today = new Date().toISOString().split('T')[0];
  if (_exerciseMastery[exercise].dates.indexOf(today) < 0) _exerciseMastery[exercise].dates.push(today);
  if (_exerciseMastery[exercise].dates.length > 100) _exerciseMastery[exercise].dates = _exerciseMastery[exercise].dates.slice(-100);
  saveMastery();
}
function getMasteryLevel(exercise) {
  var m = _exerciseMastery[exercise];
  if (!m) return { level: 'New', score: 0 };
  var score = m.sessions * 3 + m.dates.length * 5 + Math.floor(m.totalReps / 50);
  if (score >= 100) return { level: 'Master', score: score };
  if (score >= 50) return { level: 'Advanced', score: score };
  if (score >= 20) return { level: 'Intermediate', score: score };
  if (score >= 5) return { level: 'Beginner', score: score };
  return { level: 'New', score: score };
}
function showMasteryOverview() {
  loadMastery();
  var exercises = Object.keys(_exerciseMastery);
  if (!exercises.length) { showToast('No mastery data yet. Log workouts to build mastery.'); return; }
  exercises.sort(function(a, b) { return getMasteryLevel(b).score - getMasteryLevel(a).score; });
  var levelColors = { Master: '#fbbf24', Advanced: '#c084fc', Intermediate: '#4ade80', Beginner: '#60a5fa', New: '#475569' };
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Exercise Mastery (' + exercises.length + ')</span>';
  exercises.forEach(function(ex) {
    var m = _exerciseMastery[ex];
    var lvl = getMasteryLevel(ex);
    var col = levelColors[lvl.level] || '#475569';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">';
    html += '<div><span style="color:#e2e8f0;font-size:11px">' + ex + '</span>';
    html += '<div style="color:#475569;font-size:8px;margin-top:2px">' + m.sessions + ' sessions | ' + m.totalReps + ' reps | ' + m.dates.length + ' days</div></div>';
    html += '<span style="color:' + col + ';font-size:9px;font-weight:700;flex-shrink:0">' + lvl.level + '</span></div>';
  });
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function logCurrentWorkoutMastery() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No clips to log mastery for'); return; }
  var count = 0;
  clips.forEach(function(c) {
    var ex = c.dataset.exercise || '';
    var reps = (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8);
    if (ex) { logMastery(ex, reps, 0); count++; }
  });
  showToast('Mastery logged for ' + count + ' exercises');
}
loadMastery();

// Batch 360: Import from Text
function importFromText() {
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:480px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:4px">Import Workout from Text</span>';
  html += '<span style="color:#64748b;font-size:9px;display:block;margin-bottom:12px">Paste exercise names (one per line, optional sets x reps)</span>';
  html += '<textarea id="import-text" placeholder="Push-ups 3x12\nPull-ups 4x8\nSquats 3x10\nPlank 3x30s\nDips" style="width:100%;height:140px;padding:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e2e8f0;font-family:Sora,sans-serif;font-size:11px;resize:vertical;box-sizing:border-box;line-height:1.6"></textarea>';
  html += '<button onclick="parseTextImport()" style="width:100%;margin-top:8px;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Import</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function parseTextImport() {
  var textarea = document.getElementById('import-text');
  if (!textarea || !textarea.value.trim()) { showToast('Paste workout text first'); return; }
  var lines = textarea.value.trim().split('\n').filter(function(l) { return l.trim(); });
  if (!lines.length) { showToast('No exercises found'); return; }
  if (typeof captureUndo === 'function') captureUndo();
  var added = 0;
  var xPos = 50;
  lines.forEach(function(line) {
    var trimmed = line.trim();
    var match = trimmed.match(/^(.+?)\s+(\d+)\s*x\s*(\d+)/i);
    var exerciseName, sets, reps;
    if (match) { exerciseName = match[1].trim(); sets = parseInt(match[2]); reps = parseInt(match[3]); }
    else { exerciseName = trimmed.replace(/\s*\d+[sx]\d+.*/i, '').trim(); sets = 3; reps = 8; }
    if (!exerciseName) return;
    var bestMatch = null;
    if (typeof EXERCISES !== 'undefined') {
      var lower = exerciseName.toLowerCase();
      EXERCISES.forEach(function(ex) {
        if (ex.name.toLowerCase().indexOf(lower) >= 0 || lower.indexOf(ex.name.toLowerCase()) >= 0) {
          bestMatch = ex;
        }
      });
    }
    var family = bestMatch ? bestMatch.family : 'core';
    var trackMap = { push: '0', pull: '1', core: '2', legs: '3', skills: '4' };
    var trackId = trackMap[family] || '2';
    var lane = document.querySelector('.track-lane[data-track="' + trackId + '"]');
    if (!lane) lane = document.querySelector('.track-lane');
    if (lane && typeof createClipElement === 'function') {
      var clipName = bestMatch ? bestMatch.name : exerciseName;
      var clip = createClipElement(clipName, family);
      clip.style.left = xPos + 'px';
      clip.style.width = '120px';
      clip.dataset.sets = sets;
      clip.dataset.reps = reps;
      if (typeof updateClipInfo === 'function') updateClipInfo(clip);
      lane.appendChild(clip);
      xPos += 130;
      added++;
    }
  });
  var modal = textarea.closest('div[style*="fixed"]');
  if (modal) modal.remove();
  showToast('Imported ' + added + ' exercises from text');
}

// Batch 361: Workout Social Sharing
function shareToSocial() {
  var clips = document.querySelectorAll('.clip');
  if (!clips.length) { showToast('No workout to share'); return; }
  var workoutName = '';
  var nameEl = document.getElementById('workout-name') || document.querySelector('.breadcrumb-name');
  if (nameEl) workoutName = nameEl.textContent || 'Workout';
  var totalSets = 0, families = {};
  var exerciseList = [];
  clips.forEach(function(c) {
    totalSets += parseInt(c.dataset.sets) || 3;
    families[c.dataset.family || 'core'] = true;
    var name = c.dataset.exercise || c.textContent.trim().split('\n')[0];
    var sets = c.dataset.sets || '3';
    var reps = c.dataset.reps || '8';
    exerciseList.push(name + ' ' + sets + 'x' + reps);
  });
  var bpm = typeof _bpm !== 'undefined' ? _bpm : 100;
  var text = workoutName + '\n\n';
  text += clips.length + ' exercises | ' + totalSets + ' sets | ' + Object.keys(families).length + ' families | ' + bpm + ' BPM\n\n';
  exerciseList.forEach(function(e) { text += '- ' + e + '\n'; });
  text += '\nBuilt with Saturno Movement Studio\nsaturnomovement.com';
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:420px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600;display:block;margin-bottom:12px">Share Workout</span>';
  html += '<pre style="color:#cbd5e1;font-size:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:8px;padding:12px;white-space:pre-wrap;max-height:200px;overflow-y:auto;font-family:Sora,sans-serif;line-height:1.5">' + text + '</pre>';
  html += '<button onclick="navigator.clipboard.writeText(document.querySelector(\'pre\').textContent).then(function(){showToast(\'Copied!\')});this.closest(\'div[style*=fixed]\').remove()" style="width:100%;margin-top:8px;padding:10px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:8px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:11px;font-weight:600">Copy to Clipboard</button>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

// Batch 362: Exercise Video Lookup
function lookupExerciseVideo() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || clip.textContent.trim().split('\n')[0];
  var query = encodeURIComponent(name + ' exercise tutorial calisthenics');
  var url = 'https://www.youtube.com/results?search_query=' + query;
  window.open(url, '_blank');
  showToast('Searching YouTube for: ' + name);
}
function lookupExerciseImage() {
  var clip = document.querySelector('.clip.selected');
  if (!clip) { showToast('Select a clip first'); return; }
  var name = clip.dataset.exercise || clip.textContent.trim().split('\n')[0];
  var query = encodeURIComponent(name + ' exercise form calisthenics');
  var url = 'https://www.google.com/search?q=' + query + '&tbm=isch';
  window.open(url, '_blank');
  showToast('Searching images for: ' + name);
}

// Batch 363: Training Cycle Tracker
var _trainingCycle = { week: 1, phase: 'Build', startDate: null, history: [] };
function loadCycle() {
  try { var d = localStorage.getItem('sms_training_cycle'); if (d) _trainingCycle = JSON.parse(d); } catch(e) {}
}
function saveCycle() {
  try { localStorage.setItem('sms_training_cycle', JSON.stringify(_trainingCycle)); } catch(e) {}
}
function showCycleTracker() {
  loadCycle();
  var phases = ['Build', 'Intensify', 'Peak', 'Deload'];
  var phaseColors = { Build: '#4ade80', Intensify: '#fbbf24', Peak: '#f87171', Deload: '#60a5fa' };
  var html = '<div style="position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif" onclick="if(event.target===this)this.remove()">';
  html += '<div style="background:var(--surface,#0a0f1e);border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:24px;max-width:400px;width:90%">';
  html += '<span style="color:#e2e8f0;font-size:14px;font-weight:600;display:block;margin-bottom:16px">Training Cycle</span>';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
  html += '<div><span style="color:#64748b;font-size:9px;text-transform:uppercase;letter-spacing:0.1em">Current Phase</span>';
  html += '<div style="color:' + (phaseColors[_trainingCycle.phase] || '#22d3ee') + ';font-size:24px;font-weight:700">' + _trainingCycle.phase + '</div></div>';
  html += '<div style="text-align:right"><span style="color:#64748b;font-size:9px;text-transform:uppercase;letter-spacing:0.1em">Week</span>';
  html += '<div style="color:#e2e8f0;font-size:24px;font-weight:700">' + _trainingCycle.week + '</div></div></div>';
  html += '<div style="display:flex;gap:4px;margin-bottom:16px">';
  for (var w = 1; w <= 4; w++) {
    var active = w === _trainingCycle.week;
    html += '<div style="flex:1;height:6px;border-radius:3px;background:' + (active ? (phaseColors[_trainingCycle.phase] || '#22d3ee') : 'rgba(255,255,255,0.05)') + '"></div>';
  }
  html += '</div>';
  html += '<span style="color:#94a3b8;font-size:10px;display:block;margin-bottom:8px">Set Phase:</span>';
  html += '<div style="display:flex;gap:6px;margin-bottom:12px">';
  phases.forEach(function(p) {
    var active = p === _trainingCycle.phase;
    var col = phaseColors[p];
    html += '<button onclick="setCyclePhase(\'' + p + '\');this.closest(\'div[style*=fixed]\').remove();showCycleTracker()" style="flex:1;padding:8px 4px;background:' + (active ? col + '20' : 'rgba(255,255,255,0.02)') + ';border:1px solid ' + (active ? col + '60' : 'rgba(255,255,255,0.06)') + ';border-radius:6px;color:' + (active ? col : '#64748b') + ';cursor:pointer;font-family:Sora,sans-serif;font-size:9px;font-weight:600">' + p + '</button>';
  });
  html += '</div>';
  html += '<div style="display:flex;gap:6px">';
  html += '<button onclick="advanceCycleWeek();this.closest(\'div[style*=fixed]\').remove();showCycleTracker()" style="flex:1;padding:8px;background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);border-radius:6px;color:#22d3ee;cursor:pointer;font-family:Sora,sans-serif;font-size:10px;font-weight:600">Next Week</button>';
  html += '<button onclick="resetCycle();this.closest(\'div[style*=fixed]\').remove();showCycleTracker()" style="flex:1;padding:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);border-radius:6px;color:#64748b;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Reset</button></div>';
  html += '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}
function setCyclePhase(phase) {
  loadCycle();
  _trainingCycle.phase = phase;
  saveCycle();
  showToast('Phase: ' + phase);
}
function advanceCycleWeek() {
  loadCycle();
  _trainingCycle.week++;
  if (_trainingCycle.week > 4) {
    _trainingCycle.week = 1;
    var phases = ['Build', 'Intensify', 'Peak', 'Deload'];
    var idx = phases.indexOf(_trainingCycle.phase);
    _trainingCycle.phase = phases[(idx + 1) % phases.length];
    _trainingCycle.history.push({ phase: _trainingCycle.phase, date: new Date().toISOString().split('T')[0] });
  }
  saveCycle();
  showToast('Week ' + _trainingCycle.week + ' (' + _trainingCycle.phase + ')');
}
function resetCycle() {
  _trainingCycle = { week: 1, phase: 'Build', startDate: new Date().toISOString().split('T')[0], history: [] };
  saveCycle();
  showToast('Cycle reset to Week 1 Build');
}
loadCycle();

// Batch 364: Exercise Combo Creator
var _combos = [];
function loadCombos() {
  try { _combos = JSON.parse(localStorage.getItem('sms_combos') || '[]'); } catch(e) { _combos = []; }
}
function saveCombos() {
  try { localStorage.setItem('sms_combos', JSON.stringify(_combos)); } catch(e) {}
}
function createCombo() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length < 2) { showToast('Select 2+ clips to create a combo'); return; }
  var exercises = [];
  sel.forEach(function(c) {
    exercises.push({
      name: c.dataset.exercise || c.querySelector('.clip-name').textContent,
      family: c.dataset.family || '',
      sets: parseInt(c.dataset.sets) || 3,
      reps: parseInt(c.dataset.reps) || 10,
      stage: c.dataset.stage || 'S1'
    });
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:400px;max-height:80vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Create Combo</div>';
  html += '<input id="sms-combo-name" placeholder="Combo name..." style="width:100%;padding:10px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:8px;font-family:Sora,sans-serif;font-size:14px;margin-bottom:12px;box-sizing:border-box">';
  exercises.forEach(function(ex, i) {
    html += '<div style="padding:8px 12px;background:rgba(34,211,238,0.05);border-radius:6px;margin-bottom:6px;color:#94a3b8;font-size:13px">' + (i+1) + '. ' + ex.name + ' <span style="color:#22d3ee">' + ex.sets + 'x' + ex.reps + '</span></div>';
  });
  html += '<div style="display:flex;gap:8px;margin-top:16px">';
  html += '<button onclick="saveNewCombo()" style="flex:1;padding:10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Save Combo</button>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="flex:1;padding:10px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Cancel</button>';
  html += '</div></div>';
  overlay.innerHTML = html;
  overlay.dataset.exercises = JSON.stringify(exercises);
  document.body.appendChild(overlay);
  document.getElementById('sms-combo-name').focus();
}
function saveNewCombo() {
  var nameInput = document.getElementById('sms-combo-name');
  var name = nameInput ? nameInput.value.trim() : '';
  if (!name) { showToast('Enter a combo name'); return; }
  var overlay = nameInput.closest('div[style*="fixed"]');
  var exercises = JSON.parse(overlay.dataset.exercises || '[]');
  loadCombos();
  _combos.push({ name: name, exercises: exercises, created: new Date().toISOString() });
  if (_combos.length > 30) _combos = _combos.slice(-30);
  saveCombos();
  overlay.remove();
  showToast('Combo "' + name + '" saved (' + exercises.length + ' exercises)');
}
function showComboList() {
  loadCombos();
  if (_combos.length === 0) { showToast('No combos saved yet'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:80vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Saved Combos (' + _combos.length + ')</div>';
  _combos.forEach(function(combo, i) {
    html += '<div style="padding:12px;background:rgba(34,211,238,0.05);border-radius:8px;margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
    html += '<span style="color:#22d3ee;font-weight:600;font-size:14px">' + combo.name + '</span>';
    html += '<div style="display:flex;gap:6px">';
    html += '<button onclick="applyCombo(' + i + ')" style="padding:4px 10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Apply</button>';
    html += '<button onclick="deleteCombo(' + i + ')" style="padding:4px 10px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Del</button>';
    html += '</div></div>';
    combo.exercises.forEach(function(ex) {
      html += '<div style="color:#94a3b8;font-size:12px;padding:2px 0">' + ex.name + ' ' + ex.sets + 'x' + ex.reps + ' (' + ex.stage + ')</div>';
    });
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function applyCombo(idx) {
  loadCombos();
  var combo = _combos[idx];
  if (!combo) return;
  var playheadPos = playheadX || 0;
  var trackMap = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills'};
  combo.exercises.forEach(function(ex, i) {
    var found = null;
    EXERCISES.forEach(function(e) { if(e.name === ex.name) found = e; });
    if (!found) return;
    var trackId = trackMap[found.family] || 'push';
    var track = document.querySelector('.track[data-family="' + trackId + '"] .track-clips');
    if (!track) return;
    var clip = document.createElement('div');
    clip.className = 'clip';
    clip.dataset.exercise = found.name;
    clip.dataset.family = found.family;
    clip.dataset.pattern = found.pattern || '';
    clip.dataset.stage = ex.stage || found.stage || 'S1';
    clip.dataset.discipline = found.discipline || '';
    clip.dataset.sets = ex.sets;
    clip.dataset.reps = ex.reps;
    clip.dataset.tempo = found.tempo || 3;
    clip.dataset.rest = found.rest || 60;
    clip.dataset.rpe = found.rpe || 7;
    var w = (ex.sets * 40);
    clip.style.width = w + 'px';
    clip.style.left = (playheadPos + (i * (w + 10))) + 'px';
    clip.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--' + trackId + '-color') || '#22d3ee';
    clip.innerHTML = '<div class="clip-name">' + found.name + '</div><div class="clip-params">' + ex.sets + 'x' + ex.reps + '</div>';
    track.appendChild(clip);
    initClipDrag(clip);
    if (typeof logChange === 'function') logChange('add', found.name + ' (combo: ' + _combos[idx].name + ')');
  });
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  captureUndo();
  showToast('Applied combo: ' + combo.name);
}
function deleteCombo(idx) {
  loadCombos();
  var name = _combos[idx] ? _combos[idx].name : '';
  _combos.splice(idx, 1);
  saveCombos();
  showToast('Deleted combo: ' + name);
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showComboList();
}
loadCombos();

// Batch 365: Workout Comparison Matrix
function showComparisonMatrix() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  if (saved.length < 2) { showToast('Need 2+ saved workouts to compare'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:700px;max-height:85vh;overflow:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Workout Comparison Matrix</div>';
  html += '<table style="width:100%;border-collapse:collapse;font-size:12px">';
  html += '<tr><th style="text-align:left;padding:8px;color:#94a3b8;border-bottom:1px solid rgba(34,211,238,0.1)">Metric</th>';
  var displayWorkouts = saved.slice(0, 5);
  displayWorkouts.forEach(function(w) {
    html += '<th style="text-align:center;padding:8px;color:#22d3ee;border-bottom:1px solid rgba(34,211,238,0.1);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (w.name || 'Untitled') + '</th>';
  });
  html += '</tr>';
  var metrics = ['Clips', 'Exercises', 'Total Sets', 'Total Reps', 'Families', 'Avg RPE', 'BPM'];
  metrics.forEach(function(metric) {
    html += '<tr>';
    html += '<td style="padding:8px;color:#94a3b8;border-bottom:1px solid rgba(34,211,238,0.05)">' + metric + '</td>';
    displayWorkouts.forEach(function(w) {
      var clips = w.clips || [];
      var val = '';
      if (metric === 'Clips') val = clips.length;
      else if (metric === 'Exercises') {
        var names = {};
        clips.forEach(function(c) { names[c.exercise || c.name || ''] = 1; });
        val = Object.keys(names).length;
      }
      else if (metric === 'Total Sets') {
        var s = 0; clips.forEach(function(c) { s += parseInt(c.sets) || 3; }); val = s;
      }
      else if (metric === 'Total Reps') {
        var r = 0; clips.forEach(function(c) { r += (parseInt(c.sets)||3) * (parseInt(c.reps)||10); }); val = r;
      }
      else if (metric === 'Families') {
        var fams = {};
        clips.forEach(function(c) { if(c.family) fams[c.family] = 1; });
        val = Object.keys(fams).length;
      }
      else if (metric === 'Avg RPE') {
        if (clips.length === 0) { val = '-'; }
        else {
          var sum = 0; clips.forEach(function(c) { sum += parseFloat(c.rpe) || 7; });
          val = (sum / clips.length).toFixed(1);
        }
      }
      else if (metric === 'BPM') val = w.bpm || '-';
      var best = false;
      if (typeof val === 'number') {
        var allVals = displayWorkouts.map(function(wk) {
          var cl = wk.clips || [];
          if (metric === 'Clips') return cl.length;
          if (metric === 'Total Sets') { var s=0; cl.forEach(function(c){s+=parseInt(c.sets)||3;}); return s; }
          if (metric === 'Total Reps') { var r=0; cl.forEach(function(c){r+=(parseInt(c.sets)||3)*(parseInt(c.reps)||10);}); return r; }
          return 0;
        });
        best = (val === Math.max.apply(null, allVals) && val > 0);
      }
      html += '<td style="text-align:center;padding:8px;color:' + (best ? '#22d3ee' : '#e2e8f0') + ';font-weight:' + (best ? '700' : '400') + ';border-bottom:1px solid rgba(34,211,238,0.05)">' + val + '</td>';
    });
    html += '</tr>';
  });
  html += '</table>';
  // Family breakdown per workout
  html += '<div style="margin-top:16px;color:#94a3b8;font-size:13px;font-weight:600;margin-bottom:8px">Family Breakdown</div>';
  var allFamilies = ['Push','Pull','Core','Legs','Skills'];
  html += '<table style="width:100%;border-collapse:collapse;font-size:12px">';
  html += '<tr><th style="text-align:left;padding:6px;color:#94a3b8">Family</th>';
  displayWorkouts.forEach(function(w) {
    html += '<th style="text-align:center;padding:6px;color:#22d3ee;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (w.name || 'Untitled') + '</th>';
  });
  html += '</tr>';
  allFamilies.forEach(function(fam) {
    html += '<tr><td style="padding:6px;color:#94a3b8">' + fam + '</td>';
    displayWorkouts.forEach(function(w) {
      var count = 0;
      (w.clips || []).forEach(function(c) { if(c.family === fam) count++; });
      html += '<td style="text-align:center;padding:6px;color:#e2e8f0">' + count + '</td>';
    });
    html += '</tr>';
  });
  html += '</table></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 366: Auto-Periodize (Generate 4-week plan from current workout)
function autoPeriodize() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { showToast('Build a workout first, then auto-periodize'); return; }
  var baseWorkout = [];
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    baseWorkout.push({
      name: c.dataset.exercise || c.querySelector('.clip-name').textContent,
      family: c.dataset.family || '',
      sets: parseInt(c.dataset.sets) || 3,
      reps: parseInt(c.dataset.reps) || 10,
      rpe: parseFloat(c.dataset.rpe) || 7,
      rest: parseInt(c.dataset.rest) || 60,
      stage: c.dataset.stage || 'S1'
    });
  });
  var phases = [
    { name: 'Week 1: Accumulation', setsMulti: 1.0, repsMulti: 1.0, rpeAdj: 0, restAdj: 0, desc: 'Base volume, moderate intensity' },
    { name: 'Week 2: Intensification', setsMulti: 1.0, repsMulti: 0.85, rpeAdj: 1, restAdj: 15, desc: 'Fewer reps, higher RPE, more rest' },
    { name: 'Week 3: Overreach', setsMulti: 1.2, repsMulti: 0.9, rpeAdj: 1.5, restAdj: 10, desc: 'More sets, push limits' },
    { name: 'Week 4: Deload', setsMulti: 0.6, repsMulti: 1.0, rpeAdj: -2, restAdj: -15, desc: 'Reduced volume, recovery focus' }
  ];
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:650px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Auto-Periodize</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">4-week plan based on your current ' + baseWorkout.length + ' exercises</div>';
  phases.forEach(function(phase) {
    html += '<div style="padding:14px;background:rgba(34,211,238,0.05);border-radius:8px;margin-bottom:10px">';
    html += '<div style="color:#22d3ee;font-weight:600;font-size:14px;margin-bottom:2px">' + phase.name + '</div>';
    html += '<div style="color:#64748b;font-size:11px;margin-bottom:10px">' + phase.desc + '</div>';
    html += '<div style="display:grid;grid-template-columns:1fr 60px 50px 40px 50px;gap:4px;font-size:11px;color:#64748b;margin-bottom:6px">';
    html += '<div>Exercise</div><div>Sets x Reps</div><div>RPE</div><div>Rest</div><div>Stage</div></div>';
    baseWorkout.forEach(function(ex) {
      var sets = Math.max(1, Math.round(ex.sets * phase.setsMulti));
      var reps = Math.max(1, Math.round(ex.reps * phase.repsMulti));
      var rpe = Math.min(10, Math.max(1, Math.round((ex.rpe + phase.rpeAdj) * 10) / 10));
      var rest = Math.max(15, ex.rest + phase.restAdj);
      html += '<div style="display:grid;grid-template-columns:1fr 60px 50px 40px 50px;gap:4px;padding:3px 0;color:#e2e8f0;font-size:12px">';
      html += '<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + ex.name + '</div>';
      html += '<div style="color:#22d3ee">' + sets + 'x' + reps + '</div>';
      html += '<div>' + rpe + '</div>';
      html += '<div>' + rest + 's</div>';
      html += '<div style="color:#a78bfa">' + ex.stage + '</div>';
      html += '</div>';
    });
    html += '</div>';
  });
  html += '<div style="display:flex;gap:8px;margin-top:16px">';
  html += '<button onclick="exportPeriodization()" style="flex:1;padding:10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Copy as Text</button>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="flex:1;padding:10px;background:rgba(100,116,139,0.15);color:#94a3b8;border:1px solid rgba(100,116,139,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Close</button>';
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function exportPeriodization() {
  var clips = document.querySelectorAll('.clip');
  var baseWorkout = [];
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    baseWorkout.push({
      name: c.dataset.exercise || c.querySelector('.clip-name').textContent,
      sets: parseInt(c.dataset.sets) || 3,
      reps: parseInt(c.dataset.reps) || 10,
      rpe: parseFloat(c.dataset.rpe) || 7,
      rest: parseInt(c.dataset.rest) || 60,
      stage: c.dataset.stage || 'S1'
    });
  });
  var phases = [
    { name: 'Week 1: Accumulation', setsMulti: 1.0, repsMulti: 1.0, rpeAdj: 0, restAdj: 0 },
    { name: 'Week 2: Intensification', setsMulti: 1.0, repsMulti: 0.85, rpeAdj: 1, restAdj: 15 },
    { name: 'Week 3: Overreach', setsMulti: 1.2, repsMulti: 0.9, rpeAdj: 1.5, restAdj: 10 },
    { name: 'Week 4: Deload', setsMulti: 0.6, repsMulti: 1.0, rpeAdj: -2, restAdj: -15 }
  ];
  var text = 'PERIODIZED TRAINING PLAN\n========================\n\n';
  phases.forEach(function(phase) {
    text += phase.name + '\n' + '-'.repeat(phase.name.length) + '\n';
    baseWorkout.forEach(function(ex) {
      var sets = Math.max(1, Math.round(ex.sets * phase.setsMulti));
      var reps = Math.max(1, Math.round(ex.reps * phase.repsMulti));
      var rpe = Math.min(10, Math.max(1, Math.round((ex.rpe + phase.rpeAdj) * 10) / 10));
      var rest = Math.max(15, ex.rest + phase.restAdj);
      text += '  ' + ex.name + ' - ' + sets + 'x' + reps + ' @ RPE ' + rpe + ' | Rest: ' + rest + 's\n';
    });
    text += '\n';
  });
  text += 'Generated by Saturno Movement Studio';
  try {
    navigator.clipboard.writeText(text);
    showToast('Periodization plan copied to clipboard');
  } catch(e) {
    showToast('Could not copy to clipboard');
  }
}

// Batch 367: Exercise Notes Search
function searchExerciseNotes() {
  var allNotes = {};
  try { allNotes = JSON.parse(localStorage.getItem('sms_coaching_notes') || '{}'); } catch(e) {}
  var entries = Object.keys(allNotes).filter(function(k) { return allNotes[k] && allNotes[k].trim(); });
  if (entries.length === 0) { showToast('No coaching notes saved yet'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:12px">Search Coaching Notes</div>';
  html += '<input id="sms-note-search" placeholder="Search notes..." oninput="filterNoteResults()" style="width:100%;padding:10px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:8px;font-family:Sora,sans-serif;font-size:14px;margin-bottom:12px;box-sizing:border-box">';
  html += '<div id="sms-note-results">';
  entries.forEach(function(name) {
    html += '<div class="note-result-item" style="padding:10px;background:rgba(34,211,238,0.05);border-radius:6px;margin-bottom:6px">';
    html += '<div style="color:#22d3ee;font-weight:600;font-size:13px;margin-bottom:4px">' + name + '</div>';
    html += '<div style="color:#94a3b8;font-size:12px;white-space:pre-wrap;word-break:break-word">' + allNotes[name].replace(/</g, '&lt;') + '</div>';
    html += '</div>';
  });
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
  document.getElementById('sms-note-search').focus();
}
function filterNoteResults() {
  var q = (document.getElementById('sms-note-search').value || '').toLowerCase();
  var items = document.querySelectorAll('.note-result-item');
  items.forEach(function(item) {
    var text = item.textContent.toLowerCase();
    item.style.display = (!q || text.indexOf(q) >= 0) ? '' : 'none';
  });
}

// Batch 368: Workout A/B Variants
function createWorkoutVariant() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { showToast('Build a workout first'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Workout';
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:420px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Create Workout Variant</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Generate an A/B version of "' + workoutName + '"</div>';
  var variants = [
    { id: 'swap-stages', label: 'Stage Swap', desc: 'Swap all exercises to next progression stage' },
    { id: 'volume-up', label: 'Volume Up', desc: '+1 set per exercise, same reps' },
    { id: 'intensity-up', label: 'Intensity Up', desc: '-2 reps, +1 RPE per exercise' },
    { id: 'time-crunch', label: 'Time Crunch', desc: '-1 set, -15s rest per exercise' },
    { id: 'randomize-order', label: 'Random Order', desc: 'Shuffle exercise positions' },
    { id: 'alt-exercises', label: 'Alt Exercises', desc: 'Swap to random same-family exercises' }
  ];
  variants.forEach(function(v) {
    html += '<button onclick="applyVariant(\'' + v.id + '\')" style="display:block;width:100%;padding:12px;margin-bottom:6px;background:rgba(34,211,238,0.05);color:#e2e8f0;border:1px solid rgba(34,211,238,0.15);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;text-align:left">';
    html += '<div style="font-size:13px;font-weight:600;color:#22d3ee">' + v.label + '</div>';
    html += '<div style="font-size:11px;color:#94a3b8">' + v.desc + '</div>';
    html += '</button>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function applyVariant(type) {
  captureUndo();
  var clips = document.querySelectorAll('.clip');
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    if (c.closest('.track[data-family="music"]')) return;
    if (type === 'swap-stages') {
      var stage = c.dataset.stage || 'S1';
      var next = stage === 'S1' ? 'S2' : stage === 'S2' ? 'S3' : 'S1';
      var pattern = c.dataset.pattern || '';
      var found = null;
      EXERCISES.forEach(function(e) { if (e.pattern === pattern && e.stage === next) found = e; });
      if (found) {
        c.dataset.exercise = found.name;
        c.dataset.stage = next;
        var nameEl = c.querySelector('.clip-name');
        if (nameEl) nameEl.textContent = found.name;
      }
    } else if (type === 'volume-up') {
      c.dataset.sets = Math.min(10, (parseInt(c.dataset.sets)||3) + 1);
      if (typeof updateClipInfo === 'function') updateClipInfo(c);
    } else if (type === 'intensity-up') {
      c.dataset.reps = Math.max(1, (parseInt(c.dataset.reps)||10) - 2);
      c.dataset.rpe = Math.min(10, (parseFloat(c.dataset.rpe)||7) + 1);
      if (typeof updateClipInfo === 'function') updateClipInfo(c);
    } else if (type === 'time-crunch') {
      c.dataset.sets = Math.max(1, (parseInt(c.dataset.sets)||3) - 1);
      c.dataset.rest = Math.max(15, (parseInt(c.dataset.rest)||60) - 15);
      if (typeof updateClipInfo === 'function') updateClipInfo(c);
    } else if (type === 'randomize-order') {
      var track = c.closest('.track-clips');
      if (track) {
        var allClips = Array.from(track.querySelectorAll('.clip'));
        var positions = allClips.map(function(cl) { return parseInt(cl.style.left) || 0; });
        for (var i = positions.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var tmp = positions[i]; positions[i] = positions[j]; positions[j] = tmp;
        }
        allClips.forEach(function(cl, idx) { cl.style.left = positions[idx] + 'px'; });
      }
    } else if (type === 'alt-exercises') {
      var fam = c.dataset.family || '';
      var currentName = c.dataset.exercise || '';
      var alternatives = [];
      EXERCISES.forEach(function(e) { if (e.family === fam && e.name !== currentName) alternatives.push(e); });
      if (alternatives.length > 0) {
        var alt = alternatives[Math.floor(Math.random() * alternatives.length)];
        c.dataset.exercise = alt.name;
        c.dataset.pattern = alt.pattern || '';
        c.dataset.stage = alt.stage || 'S1';
        var nameEl = c.querySelector('.clip-name');
        if (nameEl) nameEl.textContent = alt.name;
      }
    }
  });
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showToast('Variant applied: ' + type.replace(/-/g, ' '));
  if (typeof logChange === 'function') logChange('variant', type);
}

// Batch 369: Session Focus Timer (Pomodoro)
var _focusTimer = { active: false, interval: null, remaining: 0, mode: 'work', workMin: 25, breakMin: 5, sessions: 0 };
function showFocusTimer() {
  var overlay = document.createElement('div');
  overlay.id = 'sms-focus-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.97);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  var html = '<div style="text-align:center;max-width:400px">';
  html += '<div style="color:#e2e8f0;font-size:20px;font-weight:700;margin-bottom:8px">Session Focus Timer</div>';
  html += '<div id="focus-mode-label" style="color:' + (_focusTimer.mode === 'work' ? '#22d3ee' : '#4ade80') + ';font-size:14px;margin-bottom:24px;text-transform:uppercase;letter-spacing:2px">' + (_focusTimer.mode === 'work' ? 'Work' : 'Break') + '</div>';
  var min = Math.floor(_focusTimer.remaining / 60);
  var sec = _focusTimer.remaining % 60;
  html += '<div id="focus-time-display" style="color:#e2e8f0;font-size:72px;font-weight:200;letter-spacing:4px;margin-bottom:8px">' + String(min).padStart(2,'0') + ':' + String(sec).padStart(2,'0') + '</div>';
  html += '<div id="focus-sessions" style="color:#94a3b8;font-size:12px;margin-bottom:24px">Sessions: ' + _focusTimer.sessions + '</div>';
  // Progress ring
  var pct = 0;
  var totalSec = (_focusTimer.mode === 'work' ? _focusTimer.workMin : _focusTimer.breakMin) * 60;
  if (totalSec > 0) pct = (1 - _focusTimer.remaining / totalSec) * 100;
  html += '<div style="margin-bottom:24px">';
  html += '<div style="width:200px;height:6px;background:rgba(34,211,238,0.1);border-radius:3px;margin:0 auto;overflow:hidden">';
  html += '<div id="focus-progress" style="height:100%;width:' + pct + '%;background:' + (_focusTimer.mode === 'work' ? '#22d3ee' : '#4ade80') + ';border-radius:3px;transition:width 1s linear"></div>';
  html += '</div></div>';
  html += '<div style="display:flex;gap:8px;justify-content:center">';
  if (!_focusTimer.active) {
    html += '<button onclick="startFocusWork()" style="padding:10px 20px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Start 25 min</button>';
    html += '<button onclick="startFocusWork(50)" style="padding:10px 20px;background:rgba(34,211,238,0.1);color:#22d3ee;border:1px solid rgba(34,211,238,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">50 min</button>';
  } else {
    html += '<button onclick="pauseFocusTimer()" style="padding:10px 20px;background:rgba(251,191,36,0.15);color:#fbbf24;border:1px solid rgba(251,191,36,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Pause</button>';
  }
  html += '<button onclick="resetFocusTimer()" style="padding:10px 20px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Reset</button>';
  html += '<button onclick="closeFocusTimer()" style="padding:10px 20px;background:rgba(100,116,139,0.15);color:#94a3b8;border:1px solid rgba(100,116,139,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Close</button>';
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function startFocusWork(mins) {
  _focusTimer.workMin = mins || 25;
  _focusTimer.breakMin = Math.round(_focusTimer.workMin / 5);
  _focusTimer.mode = 'work';
  _focusTimer.remaining = _focusTimer.workMin * 60;
  _focusTimer.active = true;
  clearInterval(_focusTimer.interval);
  _focusTimer.interval = setInterval(tickFocusTimer, 1000);
  closeFocusTimer();
  showFocusTimer();
}
function tickFocusTimer() {
  if (!_focusTimer.active) return;
  _focusTimer.remaining--;
  if (_focusTimer.remaining <= 0) {
    if (_focusTimer.mode === 'work') {
      _focusTimer.sessions++;
      _focusTimer.mode = 'break';
      _focusTimer.remaining = _focusTimer.breakMin * 60;
      showToast('Work session done! Take a ' + _focusTimer.breakMin + ' min break');
      if (typeof playUISound === 'function') playUISound('success');
    } else {
      _focusTimer.mode = 'work';
      _focusTimer.remaining = _focusTimer.workMin * 60;
      showToast('Break over! Ready for session ' + (_focusTimer.sessions + 1));
      if (typeof playUISound === 'function') playUISound('snap');
    }
  }
  var display = document.getElementById('focus-time-display');
  if (display) {
    var min = Math.floor(_focusTimer.remaining / 60);
    var sec = _focusTimer.remaining % 60;
    display.textContent = String(min).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
  }
  var label = document.getElementById('focus-mode-label');
  if (label) {
    label.textContent = _focusTimer.mode === 'work' ? 'Work' : 'Break';
    label.style.color = _focusTimer.mode === 'work' ? '#22d3ee' : '#4ade80';
  }
  var prog = document.getElementById('focus-progress');
  if (prog) {
    var totalSec = (_focusTimer.mode === 'work' ? _focusTimer.workMin : _focusTimer.breakMin) * 60;
    prog.style.width = ((1 - _focusTimer.remaining / totalSec) * 100) + '%';
    prog.style.background = _focusTimer.mode === 'work' ? '#22d3ee' : '#4ade80';
  }
  var sessEl = document.getElementById('focus-sessions');
  if (sessEl) sessEl.textContent = 'Sessions: ' + _focusTimer.sessions;
}
function pauseFocusTimer() {
  _focusTimer.active = false;
  clearInterval(_focusTimer.interval);
  closeFocusTimer();
  showFocusTimer();
}
function resetFocusTimer() {
  _focusTimer.active = false;
  clearInterval(_focusTimer.interval);
  _focusTimer.remaining = 0;
  _focusTimer.mode = 'work';
  _focusTimer.sessions = 0;
  closeFocusTimer();
  showFocusTimer();
}
function closeFocusTimer() {
  var el = document.getElementById('sms-focus-overlay');
  if (el) el.remove();
}

// Batch 370: Movement Flow Builder
var _flows = [];
function loadFlows() {
  try { _flows = JSON.parse(localStorage.getItem('sms_flows') || '[]'); } catch(e) { _flows = []; }
}
function saveFlows() {
  try { localStorage.setItem('sms_flows', JSON.stringify(_flows)); } catch(e) {}
}
function showFlowBuilder() {
  var sel = document.querySelectorAll('.clip.selected');
  var exercises = [];
  sel.forEach(function(c) {
    exercises.push(c.dataset.exercise || c.querySelector('.clip-name').textContent);
  });
  if (exercises.length < 2) {
    // If not enough selected, use all clips on active track
    var active = document.querySelector('.track.active .track-clips') || document.querySelector('.track-clips');
    if (active) {
      active.querySelectorAll('.clip').forEach(function(c) {
        exercises.push(c.dataset.exercise || c.querySelector('.clip-name').textContent);
      });
    }
  }
  if (exercises.length < 2) { showToast('Need 2+ exercises for a flow'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Movement Flow Builder</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">' + exercises.length + ' exercises in sequence</div>';
  // Visual flow chain
  exercises.forEach(function(ex, i) {
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
    html += '<div style="width:24px;height:24px;border-radius:50%;background:rgba(34,211,238,0.2);color:#22d3ee;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0">' + (i+1) + '</div>';
    html += '<div style="flex:1;padding:8px 12px;background:rgba(34,211,238,0.05);border-radius:6px;color:#e2e8f0;font-size:13px">' + ex + '</div>';
    html += '</div>';
    if (i < exercises.length - 1) {
      html += '<div style="text-align:center;color:#22d3ee;font-size:14px;margin:2px 0;opacity:0.5">\u2193</div>';
    }
  });
  html += '<input id="sms-flow-name" placeholder="Flow name..." style="width:100%;padding:10px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:8px;font-family:Sora,sans-serif;font-size:14px;margin-top:16px;margin-bottom:12px;box-sizing:border-box">';
  html += '<div style="display:flex;gap:8px">';
  html += '<button onclick="saveFlow()" style="flex:1;padding:10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Save Flow</button>';
  html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="flex:1;padding:10px;background:rgba(100,116,139,0.15);color:#94a3b8;border:1px solid rgba(100,116,139,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Cancel</button>';
  html += '</div></div>';
  overlay.innerHTML = html;
  overlay.dataset.exercises = JSON.stringify(exercises);
  document.body.appendChild(overlay);
  document.getElementById('sms-flow-name').focus();
}
function saveFlow() {
  var nameInput = document.getElementById('sms-flow-name');
  var name = nameInput ? nameInput.value.trim() : '';
  if (!name) { showToast('Enter a flow name'); return; }
  var overlay = nameInput.closest('div[style*="fixed"]');
  var exercises = JSON.parse(overlay.dataset.exercises || '[]');
  loadFlows();
  _flows.push({ name: name, exercises: exercises, created: new Date().toISOString() });
  if (_flows.length > 20) _flows = _flows.slice(-20);
  saveFlows();
  overlay.remove();
  showToast('Flow "' + name + '" saved (' + exercises.length + ' exercises)');
}
function showFlowList() {
  loadFlows();
  if (_flows.length === 0) { showToast('No flows saved yet'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Saved Flows (' + _flows.length + ')</div>';
  _flows.forEach(function(flow, i) {
    html += '<div style="padding:12px;background:rgba(34,211,238,0.05);border-radius:8px;margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    html += '<span style="color:#22d3ee;font-weight:600;font-size:14px">' + flow.name + '</span>';
    html += '<button onclick="_flows.splice(' + i + ',1);saveFlows();this.closest(\'div[style*=fixed]\').remove();showFlowList();" style="padding:4px 8px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:4px;cursor:pointer;font-size:10px;font-family:Sora,sans-serif">Del</button>';
    html += '</div>';
    html += '<div style="color:#94a3b8;font-size:12px">' + flow.exercises.join(' \u2192 ') + '</div>';
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
loadFlows();

// Batch 371: Workout Analytics Export
function exportAnalyticsHTML() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { showToast('No clips to analyze'); return; }
  var data = { totalClips: 0, totalSets: 0, totalReps: 0, families: {}, patterns: {}, stages: {}, rpeSum: 0, exercises: {} };
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    data.totalClips++;
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 10;
    data.totalSets += sets;
    data.totalReps += sets * reps;
    data.rpeSum += parseFloat(c.dataset.rpe) || 7;
    var fam = c.dataset.family || 'Unknown';
    data.families[fam] = (data.families[fam] || 0) + 1;
    var pat = c.dataset.pattern || 'Unknown';
    data.patterns[pat] = (data.patterns[pat] || 0) + 1;
    var stage = c.dataset.stage || 'S1';
    data.stages[stage] = (data.stages[stage] || 0) + 1;
    var name = c.dataset.exercise || 'Unknown';
    data.exercises[name] = (data.exercises[name] || 0) + 1;
  });
  var avgRpe = data.totalClips > 0 ? (data.rpeSum / data.totalClips).toFixed(1) : '0';
  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Workout';
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa'};
  var htmlStr = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + workoutName + ' Analytics</title>';
  htmlStr += '<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#050711;color:#e2e8f0;font-family:Sora,system-ui,sans-serif;padding:40px 20px}';
  htmlStr += '.container{max-width:800px;margin:0 auto}.card{background:#0a0f1e;border:1px solid rgba(34,211,238,0.15);border-radius:12px;padding:20px;margin-bottom:16px}';
  htmlStr += 'h1{font-size:24px;font-weight:700;margin-bottom:8px}h2{font-size:16px;font-weight:600;color:#22d3ee;margin-bottom:12px}';
  htmlStr += '.stat{display:inline-block;padding:8px 16px;background:rgba(34,211,238,0.05);border-radius:8px;margin:4px;text-align:center}';
  htmlStr += '.stat-val{font-size:24px;font-weight:700;color:#22d3ee}.stat-label{font-size:11px;color:#94a3b8}';
  htmlStr += '.bar{height:20px;border-radius:4px;margin-bottom:6px;display:flex;align-items:center;padding:0 8px;font-size:11px;font-weight:600}';
  htmlStr += '.exercise-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(34,211,238,0.05);font-size:13px}';
  htmlStr += '</style></head><body><div class="container">';
  htmlStr += '<h1>' + workoutName + '</h1><p style="color:#94a3b8;font-size:12px;margin-bottom:24px">Generated ' + new Date().toLocaleDateString() + ' | Saturno Movement Studio</p>';
  // Stats cards
  htmlStr += '<div class="card"><h2>Overview</h2><div>';
  htmlStr += '<div class="stat"><div class="stat-val">' + data.totalClips + '</div><div class="stat-label">Clips</div></div>';
  htmlStr += '<div class="stat"><div class="stat-val">' + Object.keys(data.exercises).length + '</div><div class="stat-label">Exercises</div></div>';
  htmlStr += '<div class="stat"><div class="stat-val">' + data.totalSets + '</div><div class="stat-label">Total Sets</div></div>';
  htmlStr += '<div class="stat"><div class="stat-val">' + data.totalReps + '</div><div class="stat-label">Total Reps</div></div>';
  htmlStr += '<div class="stat"><div class="stat-val">' + avgRpe + '</div><div class="stat-label">Avg RPE</div></div>';
  htmlStr += '</div></div>';
  // Family distribution
  var maxFam = Math.max.apply(null, Object.values(data.families).concat([1]));
  htmlStr += '<div class="card"><h2>Family Distribution</h2>';
  Object.keys(data.families).forEach(function(fam) {
    var pct = Math.round(data.families[fam] / data.totalClips * 100);
    var w = Math.round(data.families[fam] / maxFam * 100);
    htmlStr += '<div class="bar" style="width:' + w + '%;background:' + (famColors[fam]||'#22d3ee') + '30;color:' + (famColors[fam]||'#22d3ee') + '">' + fam + ' ' + data.families[fam] + ' (' + pct + '%)</div>';
  });
  htmlStr += '</div>';
  // Stage breakdown
  htmlStr += '<div class="card"><h2>Stage Breakdown</h2>';
  ['S1','S2','S3'].forEach(function(s) {
    var count = data.stages[s] || 0;
    var pct = data.totalClips > 0 ? Math.round(count / data.totalClips * 100) : 0;
    htmlStr += '<div class="bar" style="width:' + Math.max(pct, 5) + '%;background:rgba(34,211,238,0.15);color:#22d3ee">' + s + ': ' + count + ' (' + pct + '%)</div>';
  });
  htmlStr += '</div>';
  // Exercise list
  var sorted = Object.keys(data.exercises).sort(function(a,b) { return data.exercises[b] - data.exercises[a]; });
  htmlStr += '<div class="card"><h2>Exercise Frequency</h2>';
  sorted.forEach(function(name) {
    htmlStr += '<div class="exercise-row"><span>' + name + '</span><span style="color:#22d3ee">' + data.exercises[name] + ' clips</span></div>';
  });
  htmlStr += '</div>';
  htmlStr += '<p style="text-align:center;color:#64748b;font-size:11px;margin-top:24px">Saturno Movement Studio | The Ableton of Movement</p>';
  htmlStr += '</div></body></html>';
  var blob = new Blob([htmlStr], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = (workoutName.replace(/[^a-zA-Z0-9]/g,'-') || 'workout') + '-analytics.html';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Analytics report downloaded');
}

// Batch 372: Quick Workout Builder Wizard
function showWorkoutWizard() {
  var overlay = document.createElement('div');
  overlay.id = 'sms-wizard';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:480px;max-height:85vh;overflow-y:auto" onclick="event.stopPropagation()">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Quick Workout Wizard</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:20px">Build a workout in 3 clicks</div>';
  // Step 1: Focus
  html += '<div style="margin-bottom:16px">';
  html += '<div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Step 1: Focus</div>';
  var focuses = [
    { id:'upper', label:'Upper Body', families:['Push','Pull'] },
    { id:'lower', label:'Lower Body', families:['Legs','Core'] },
    { id:'full', label:'Full Body', families:['Push','Pull','Core','Legs','Skills'] },
    { id:'push-pull', label:'Push / Pull', families:['Push','Pull'] },
    { id:'skills', label:'Skills & Flow', families:['Skills','Core'] }
  ];
  html += '<div style="display:flex;flex-wrap:wrap;gap:6px">';
  focuses.forEach(function(f) {
    html += '<button onclick="wizardSetFocus(\'' + f.id + '\')" id="wiz-focus-' + f.id + '" data-families=\'' + JSON.stringify(f.families) + '\' style="padding:8px 14px;background:rgba(34,211,238,0.05);color:#94a3b8;border:1px solid rgba(34,211,238,0.15);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px">' + f.label + '</button>';
  });
  html += '</div></div>';
  // Step 2: Volume
  html += '<div style="margin-bottom:16px">';
  html += '<div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Step 2: Volume</div>';
  var volumes = [
    { id:'quick', label:'Quick (4-6)', count:5 },
    { id:'standard', label:'Standard (8-10)', count:9 },
    { id:'long', label:'Long (12-16)', count:14 }
  ];
  html += '<div style="display:flex;gap:6px">';
  volumes.forEach(function(v) {
    html += '<button onclick="wizardSetVolume(' + v.count + ',\'' + v.id + '\')" id="wiz-vol-' + v.id + '" style="flex:1;padding:8px;background:rgba(34,211,238,0.05);color:#94a3b8;border:1px solid rgba(34,211,238,0.15);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px">' + v.label + '</button>';
  });
  html += '</div></div>';
  // Step 3: Intensity
  html += '<div style="margin-bottom:20px">';
  html += '<div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Step 3: Intensity</div>';
  var intensities = [
    { id:'easy', label:'Easy', sets:2, reps:12, rpe:5 },
    { id:'moderate', label:'Moderate', sets:3, reps:10, rpe:7 },
    { id:'hard', label:'Hard', sets:4, reps:8, rpe:8 },
    { id:'max', label:'Max Effort', sets:5, reps:5, rpe:9 }
  ];
  html += '<div style="display:flex;gap:6px">';
  intensities.forEach(function(v) {
    html += '<button onclick="wizardSetIntensity(' + v.sets + ',' + v.reps + ',' + v.rpe + ',\'' + v.id + '\')" id="wiz-int-' + v.id + '" style="flex:1;padding:8px;background:rgba(34,211,238,0.05);color:#94a3b8;border:1px solid rgba(34,211,238,0.15);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px">' + v.label + '</button>';
  });
  html += '</div></div>';
  html += '<button id="wiz-generate" onclick="wizardGenerate()" style="width:100%;padding:12px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:14px;font-weight:600;opacity:0.3;pointer-events:none">Select all 3 steps to generate</button>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
var _wizardState = { families: null, count: 0, sets: 3, reps: 10, rpe: 7 };
function wizardSetFocus(id) {
  document.querySelectorAll('[id^="wiz-focus-"]').forEach(function(b) {
    b.style.background = 'rgba(34,211,238,0.05)'; b.style.color = '#94a3b8';
  });
  var btn = document.getElementById('wiz-focus-' + id);
  if (btn) {
    btn.style.background = 'rgba(34,211,238,0.2)'; btn.style.color = '#22d3ee';
    _wizardState.families = JSON.parse(btn.dataset.families || '[]');
  }
  wizardCheckReady();
}
function wizardSetVolume(count, id) {
  document.querySelectorAll('[id^="wiz-vol-"]').forEach(function(b) {
    b.style.background = 'rgba(34,211,238,0.05)'; b.style.color = '#94a3b8';
  });
  var btn = document.getElementById('wiz-vol-' + id);
  if (btn) { btn.style.background = 'rgba(34,211,238,0.2)'; btn.style.color = '#22d3ee'; }
  _wizardState.count = count;
  wizardCheckReady();
}
function wizardSetIntensity(sets, reps, rpe, id) {
  document.querySelectorAll('[id^="wiz-int-"]').forEach(function(b) {
    b.style.background = 'rgba(34,211,238,0.05)'; b.style.color = '#94a3b8';
  });
  var btn = document.getElementById('wiz-int-' + id);
  if (btn) { btn.style.background = 'rgba(34,211,238,0.2)'; btn.style.color = '#22d3ee'; }
  _wizardState.sets = sets;
  _wizardState.reps = reps;
  _wizardState.rpe = rpe;
  wizardCheckReady();
}
function wizardCheckReady() {
  var btn = document.getElementById('wiz-generate');
  if (_wizardState.families && _wizardState.count > 0) {
    btn.style.opacity = '1';
    btn.style.pointerEvents = 'auto';
    btn.textContent = 'Generate Workout (' + _wizardState.count + ' exercises)';
  }
}
function wizardGenerate() {
  if (!_wizardState.families || !_wizardState.count) return;
  captureUndo();
  var pool = [];
  EXERCISES.forEach(function(e) {
    if (_wizardState.families.indexOf(e.family) >= 0) pool.push(e);
  });
  // Shuffle pool
  for (var i = pool.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = pool[i]; pool[i] = pool[j]; pool[j] = tmp;
  }
  var selected = pool.slice(0, _wizardState.count);
  var trackMap = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills'};
  var trackOffsets = {};
  selected.forEach(function(ex) {
    var trackId = trackMap[ex.family] || 'push';
    var track = document.querySelector('.track[data-family="' + trackId + '"] .track-clips');
    if (!track) return;
    if (!trackOffsets[trackId]) trackOffsets[trackId] = 10;
    var clip = document.createElement('div');
    clip.className = 'clip';
    clip.dataset.exercise = ex.name;
    clip.dataset.family = ex.family;
    clip.dataset.pattern = ex.pattern || '';
    clip.dataset.stage = ex.stage || 'S1';
    clip.dataset.discipline = ex.discipline || '';
    clip.dataset.sets = _wizardState.sets;
    clip.dataset.reps = _wizardState.reps;
    clip.dataset.tempo = ex.tempo || 3;
    clip.dataset.rest = ex.rest || 60;
    clip.dataset.rpe = _wizardState.rpe;
    var w = (_wizardState.sets * 40);
    clip.style.width = w + 'px';
    clip.style.left = trackOffsets[trackId] + 'px';
    clip.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--' + trackId + '-color') || '#22d3ee';
    clip.innerHTML = '<div class="clip-name">' + ex.name + '</div><div class="clip-params">' + _wizardState.sets + 'x' + _wizardState.reps + '</div>';
    track.appendChild(clip);
    initClipDrag(clip);
    trackOffsets[trackId] += w + 10;
  });
  document.getElementById('sms-wizard').remove();
  showToast('Wizard generated ' + selected.length + ' exercises');
  if (typeof logChange === 'function') logChange('wizard', selected.length + ' exercises');
}

// Batch 373: Exercise Encyclopedia
function showEncyclopedia() {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa',Mobility:'#818cf8'};
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:650px;max-height:85vh;overflow-y:auto" onclick="event.stopPropagation()">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700">Exercise Encyclopedia</div>';
  html += '<div style="color:#94a3b8;font-size:12px">' + EXERCISES.length + ' exercises</div></div>';
  html += '<input id="sms-ency-search" placeholder="Search exercises..." oninput="filterEncyclopedia()" style="width:100%;padding:10px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:8px;font-family:Sora,sans-serif;font-size:14px;margin-bottom:8px;box-sizing:border-box">';
  html += '<div style="display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap">';
  html += '<button onclick="filterEncyFamily(\'all\')" class="ency-fam-btn" style="padding:4px 10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">All</button>';
  ['Push','Pull','Core','Legs','Skills','Mobility'].forEach(function(f) {
    html += '<button onclick="filterEncyFamily(\'' + f + '\')" class="ency-fam-btn" style="padding:4px 10px;background:rgba(34,211,238,0.05);color:#94a3b8;border:1px solid rgba(34,211,238,0.1);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">' + f + '</button>';
  });
  html += '</div>';
  html += '<div id="sms-ency-list">';
  EXERCISES.forEach(function(ex) {
    var notes = '';
    try { var n = JSON.parse(localStorage.getItem('sms_coaching_notes') || '{}'); notes = n[ex.name] || ''; } catch(e) {}
    var difficulty = '';
    try { var d = JSON.parse(localStorage.getItem('sms_difficulty') || '{}'); difficulty = d[ex.name] ? '\u2605'.repeat(d[ex.name]) : ''; } catch(e) {}
    html += '<div class="ency-item" data-family="' + ex.family + '" style="padding:10px;background:rgba(34,211,238,0.03);border-radius:6px;margin-bottom:4px;display:flex;gap:10px;align-items:flex-start">';
    html += '<div style="width:6px;height:100%;min-height:36px;border-radius:3px;background:' + (famColors[ex.family]||'#22d3ee') + ';flex-shrink:0"></div>';
    html += '<div style="flex:1">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center">';
    html += '<span style="color:#e2e8f0;font-weight:600;font-size:13px">' + ex.name + '</span>';
    if (difficulty) html += '<span style="color:#fbbf24;font-size:11px">' + difficulty + '</span>';
    html += '</div>';
    html += '<div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap">';
    html += '<span style="color:' + (famColors[ex.family]||'#22d3ee') + ';font-size:10px">' + ex.family + '</span>';
    html += '<span style="color:#a78bfa;font-size:10px">' + (ex.pattern || '') + '</span>';
    html += '<span style="color:#94a3b8;font-size:10px">' + (ex.stage || 'S1') + '</span>';
    html += '<span style="color:#64748b;font-size:10px">' + (ex.discipline || '') + '</span>';
    html += '</div>';
    if (notes) html += '<div style="color:#64748b;font-size:11px;margin-top:4px;font-style:italic">' + notes.substring(0,80) + (notes.length > 80 ? '...' : '') + '</div>';
    html += '</div></div>';
  });
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
  document.getElementById('sms-ency-search').focus();
}
function filterEncyclopedia() {
  var q = (document.getElementById('sms-ency-search').value || '').toLowerCase();
  document.querySelectorAll('.ency-item').forEach(function(item) {
    item.style.display = (!q || item.textContent.toLowerCase().indexOf(q) >= 0) ? '' : 'none';
  });
}
function filterEncyFamily(fam) {
  document.querySelectorAll('.ency-fam-btn').forEach(function(b) {
    b.style.background = 'rgba(34,211,238,0.05)'; b.style.color = '#94a3b8';
  });
  event.target.style.background = 'rgba(34,211,238,0.15)';
  event.target.style.color = '#22d3ee';
  document.querySelectorAll('.ency-item').forEach(function(item) {
    item.style.display = (fam === 'all' || item.dataset.family === fam) ? '' : 'none';
  });
}

// Batch 374: Extended Workout Heatmap Calendar
function showExtendedCalendar() {
  var dates = {};
  // Collect from ratings
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    ratings.forEach(function(r) {
      if (r.date) {
        var d = r.date.split('T')[0];
        if (!dates[d]) dates[d] = { count: 0, rating: 0, names: [] };
        dates[d].count++;
        dates[d].rating = r.rating || 0;
        if (r.name) dates[d].names.push(r.name);
      }
    });
  } catch(e) {}
  // Collect from journal
  try {
    var journal = JSON.parse(localStorage.getItem('sms_journal') || '[]');
    journal.forEach(function(j) {
      if (j.date) {
        var d = j.date.split('T')[0];
        if (!dates[d]) dates[d] = { count: 0, rating: 0, names: [] };
        dates[d].count++;
      }
    });
  } catch(e) {}
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:700px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Training Calendar</div>';
  // Show last 6 months
  var now = new Date();
  for (var m = 5; m >= 0; m--) {
    var month = new Date(now.getFullYear(), now.getMonth() - m, 1);
    var monthName = month.toLocaleString('default', { month: 'long', year: 'numeric' });
    html += '<div style="margin-bottom:16px">';
    html += '<div style="color:#94a3b8;font-size:12px;font-weight:600;margin-bottom:6px">' + monthName + '</div>';
    html += '<div style="display:flex;gap:3px;flex-wrap:wrap">';
    var daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
    // Day labels
    var firstDay = month.getDay();
    for (var pad = 0; pad < firstDay; pad++) {
      html += '<div style="width:18px;height:18px"></div>';
    }
    for (var d = 1; d <= daysInMonth; d++) {
      var dateStr = month.getFullYear() + '-' + String(month.getMonth() + 1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      var entry = dates[dateStr];
      var bg = 'rgba(34,211,238,0.05)';
      var title = dateStr;
      if (entry) {
        var intensity = Math.min(entry.count, 3);
        bg = intensity >= 3 ? 'rgba(34,211,238,0.6)' : intensity >= 2 ? 'rgba(34,211,238,0.35)' : 'rgba(34,211,238,0.18)';
        title = dateStr + ' - ' + entry.count + ' session(s)';
        if (entry.names.length) title += ': ' + entry.names.join(', ');
      }
      html += '<div title="' + title + '" style="width:18px;height:18px;border-radius:3px;background:' + bg + ';cursor:default"></div>';
    }
    html += '</div></div>';
  }
  // Legend
  html += '<div style="display:flex;gap:8px;align-items:center;margin-top:8px">';
  html += '<span style="color:#64748b;font-size:10px">Less</span>';
  html += '<div style="width:12px;height:12px;border-radius:2px;background:rgba(34,211,238,0.05)"></div>';
  html += '<div style="width:12px;height:12px;border-radius:2px;background:rgba(34,211,238,0.18)"></div>';
  html += '<div style="width:12px;height:12px;border-radius:2px;background:rgba(34,211,238,0.35)"></div>';
  html += '<div style="width:12px;height:12px;border-radius:2px;background:rgba(34,211,238,0.6)"></div>';
  html += '<span style="color:#64748b;font-size:10px">More</span>';
  html += '<span style="color:#94a3b8;font-size:10px;margin-left:12px">' + Object.keys(dates).length + ' training days</span>';
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 375: Custom Countdown Sequences
var _countdownSeqs = [];
function loadCountdownSeqs() {
  try { _countdownSeqs = JSON.parse(localStorage.getItem('sms_countdown_seqs') || '[]'); } catch(e) { _countdownSeqs = []; }
}
function saveCountdownSeqs() {
  try { localStorage.setItem('sms_countdown_seqs', JSON.stringify(_countdownSeqs)); } catch(e) {}
}
function showCountdownBuilder() {
  var overlay = document.createElement('div');
  overlay.id = 'sms-cd-builder';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto" onclick="event.stopPropagation()">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:12px">Custom Countdown Builder</div>';
  html += '<input id="cd-seq-name" placeholder="Sequence name..." style="width:100%;padding:10px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:8px;font-family:Sora,sans-serif;font-size:14px;margin-bottom:12px;box-sizing:border-box">';
  html += '<div id="cd-steps" style="margin-bottom:12px"></div>';
  html += '<div style="display:flex;gap:6px;margin-bottom:12px">';
  html += '<button onclick="addCDStep(\'work\')" style="flex:1;padding:8px;background:rgba(34,211,238,0.1);color:#22d3ee;border:1px solid rgba(34,211,238,0.2);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px">+ Work</button>';
  html += '<button onclick="addCDStep(\'rest\')" style="flex:1;padding:8px;background:rgba(74,222,128,0.1);color:#4ade80;border:1px solid rgba(74,222,128,0.2);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px">+ Rest</button>';
  html += '<button onclick="addCDStep(\'prep\')" style="flex:1;padding:8px;background:rgba(251,191,36,0.1);color:#fbbf24;border:1px solid rgba(251,191,36,0.2);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px">+ Prep</button>';
  html += '</div>';
  html += '<div style="margin-bottom:12px">';
  html += '<label style="color:#94a3b8;font-size:12px;display:block;margin-bottom:4px">Rounds: <input id="cd-rounds" type="number" value="1" min="1" max="20" style="width:50px;padding:4px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:4px;font-family:Sora,sans-serif;font-size:13px;text-align:center"></label>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px">';
  html += '<button onclick="saveCountdownSeq()" style="flex:1;padding:10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Save Sequence</button>';
  html += '<button onclick="showSavedSeqs()" style="flex:1;padding:10px;background:rgba(100,116,139,0.1);color:#94a3b8;border:1px solid rgba(100,116,139,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Saved (' + _countdownSeqs.length + ')</button>';
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
var _cdSteps = [];
function addCDStep(type) {
  var colors = { work: '#22d3ee', rest: '#4ade80', prep: '#fbbf24' };
  _cdSteps.push({ type: type, seconds: type === 'work' ? 30 : type === 'rest' ? 15 : 5 });
  renderCDSteps();
}
function renderCDSteps() {
  var container = document.getElementById('cd-steps');
  if (!container) return;
  var colors = { work: '#22d3ee', rest: '#4ade80', prep: '#fbbf24' };
  var html = '';
  _cdSteps.forEach(function(step, i) {
    html += '<div style="display:flex;gap:6px;align-items:center;margin-bottom:4px">';
    html += '<span style="color:' + colors[step.type] + ';font-size:11px;width:40px;text-transform:uppercase;font-weight:600">' + step.type + '</span>';
    html += '<input type="number" value="' + step.seconds + '" min="1" max="600" onchange="_cdSteps[' + i + '].seconds=parseInt(this.value)||10" style="width:60px;padding:4px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.2);border-radius:4px;font-family:Sora,sans-serif;font-size:12px;text-align:center">';
    html += '<span style="color:#64748b;font-size:11px">sec</span>';
    html += '<button onclick="_cdSteps.splice(' + i + ',1);renderCDSteps()" style="padding:2px 8px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.15);border-radius:4px;cursor:pointer;font-size:11px;font-family:Sora,sans-serif">x</button>';
    html += '</div>';
  });
  container.innerHTML = html;
}
function saveCountdownSeq() {
  var name = document.getElementById('cd-seq-name') ? document.getElementById('cd-seq-name').value.trim() : '';
  if (!name) { showToast('Enter a sequence name'); return; }
  if (_cdSteps.length === 0) { showToast('Add at least one step'); return; }
  var rounds = parseInt(document.getElementById('cd-rounds').value) || 1;
  loadCountdownSeqs();
  _countdownSeqs.push({ name: name, steps: JSON.parse(JSON.stringify(_cdSteps)), rounds: rounds, created: new Date().toISOString() });
  if (_countdownSeqs.length > 20) _countdownSeqs = _countdownSeqs.slice(-20);
  saveCountdownSeqs();
  _cdSteps = [];
  var builder = document.getElementById('sms-cd-builder');
  if (builder) builder.remove();
  showToast('Countdown "' + name + '" saved');
}
function showSavedSeqs() {
  loadCountdownSeqs();
  if (_countdownSeqs.length === 0) { showToast('No saved sequences'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Saved Countdown Sequences</div>';
  _countdownSeqs.forEach(function(seq, i) {
    var totalTime = 0;
    seq.steps.forEach(function(s) { totalTime += s.seconds; });
    totalTime *= seq.rounds;
    html += '<div style="padding:12px;background:rgba(34,211,238,0.05);border-radius:8px;margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    html += '<span style="color:#22d3ee;font-weight:600;font-size:14px">' + seq.name + '</span>';
    html += '<div style="display:flex;gap:4px">';
    html += '<button onclick="runCountdownSeq(' + i + ')" style="padding:4px 10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:4px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Run</button>';
    html += '<button onclick="_countdownSeqs.splice(' + i + ',1);saveCountdownSeqs();this.closest(\'div[style*=fixed]\').remove();showSavedSeqs();" style="padding:4px 8px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:4px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Del</button>';
    html += '</div></div>';
    html += '<div style="color:#94a3b8;font-size:11px">' + seq.steps.length + ' steps x ' + seq.rounds + ' round(s) = ' + Math.round(totalTime/60) + ' min</div>';
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function runCountdownSeq(idx) {
  loadCountdownSeqs();
  var seq = _countdownSeqs[idx];
  if (!seq) return;
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  var allSteps = [];
  for (var r = 0; r < seq.rounds; r++) {
    seq.steps.forEach(function(s) { allSteps.push({ type: s.type, seconds: s.seconds, round: r + 1 }); });
  }
  var stepIdx = 0;
  var remaining = allSteps[0].seconds;
  var colors = { work: '#22d3ee', rest: '#4ade80', prep: '#fbbf24' };
  var overlay = document.createElement('div');
  overlay.id = 'sms-cd-runner';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.97);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  function renderStep() {
    var step = allSteps[stepIdx];
    var col = colors[step.type] || '#22d3ee';
    var min = Math.floor(remaining / 60);
    var sec = remaining % 60;
    overlay.innerHTML = '<div style="text-align:center">' +
      '<div style="color:' + col + ';font-size:14px;text-transform:uppercase;letter-spacing:3px;margin-bottom:8px">' + step.type + '</div>' +
      '<div style="color:#e2e8f0;font-size:80px;font-weight:200;letter-spacing:4px;margin-bottom:8px">' + String(min).padStart(2,'0') + ':' + String(sec).padStart(2,'0') + '</div>' +
      '<div style="color:#94a3b8;font-size:12px;margin-bottom:24px">Step ' + (stepIdx+1) + '/' + allSteps.length + ' | Round ' + step.round + '/' + seq.rounds + '</div>' +
      '<button onclick="document.getElementById(\'sms-cd-runner\').remove();clearInterval(window._cdInterval)" style="padding:10px 24px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Stop</button>' +
      '</div>';
  }
  renderStep();
  document.body.appendChild(overlay);
  window._cdInterval = setInterval(function() {
    remaining--;
    if (remaining <= 0) {
      stepIdx++;
      if (stepIdx >= allSteps.length) {
        clearInterval(window._cdInterval);
        overlay.remove();
        showToast('Countdown sequence complete!');
        if (typeof playUISound === 'function') playUISound('success');
        return;
      }
      remaining = allSteps[stepIdx].seconds;
      if (typeof playUISound === 'function') playUISound('snap');
    }
    if (remaining <= 3 && remaining > 0 && typeof playUISound === 'function') playUISound('place');
    renderStep();
  }, 1000);
}
loadCountdownSeqs();

// Batch 376: Exercise Relationships Map
function showRelationshipsMap() {
  var pairings = {
    'Push': { synergy: ['Core','Legs'], conflict: [], note: 'Pairs well with core for stability' },
    'Pull': { synergy: ['Core','Legs'], conflict: [], note: 'Strong with core, balances push' },
    'Core': { synergy: ['Push','Pull','Legs','Skills'], conflict: [], note: 'Enhances everything' },
    'Legs': { synergy: ['Core','Push','Pull'], conflict: [], note: 'Drives full-body sessions' },
    'Skills': { synergy: ['Core','Mobility'], conflict: [], note: 'Needs fresh CNS, pair with light work' },
    'Mobility': { synergy: ['Skills','Core','Push','Pull','Legs'], conflict: [], note: 'Universal complement' }
  };
  var patternPairs = [
    { a: 'Horizontal Push', b: 'Horizontal Pull', type: 'antagonist', label: 'Classic push-pull superset' },
    { a: 'Vertical Pull', b: 'Overhead Press', type: 'antagonist', label: 'Vertical antagonist pair' },
    { a: 'Knee-Dominant', b: 'Hip-Dominant', type: 'complement', label: 'Quad-hamstring balance' },
    { a: 'Downward Press', b: 'Vertical Pull', type: 'antagonist', label: 'Vertical pressing balance' },
    { a: 'Horizontal Push', b: 'Horizontal Push', type: 'same', label: 'Pre-exhaust or volume block' },
    { a: 'Core', b: 'Skills', type: 'complement', label: 'Stability for skill work' }
  ];
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa',Mobility:'#818cf8'};
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:600px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Exercise Relationship Map</div>';
  // Family synergies
  html += '<div style="color:#94a3b8;font-size:12px;font-weight:600;margin-bottom:10px">Family Synergies</div>';
  Object.keys(pairings).forEach(function(fam) {
    var p = pairings[fam];
    html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">';
    html += '<div style="width:70px;color:' + (famColors[fam]||'#22d3ee') + ';font-size:12px;font-weight:600;flex-shrink:0">' + fam + '</div>';
    html += '<div style="flex:1;display:flex;gap:4px;flex-wrap:wrap">';
    p.synergy.forEach(function(s) {
      html += '<span style="padding:2px 8px;background:' + (famColors[s]||'#22d3ee') + '15;color:' + (famColors[s]||'#22d3ee') + ';border-radius:4px;font-size:10px">' + s + '</span>';
    });
    html += '</div>';
    html += '<div style="color:#64748b;font-size:10px;flex-shrink:0;max-width:200px">' + p.note + '</div>';
    html += '</div>';
  });
  // Pattern pairings
  html += '<div style="color:#94a3b8;font-size:12px;font-weight:600;margin:16px 0 10px">Pattern Pairings</div>';
  patternPairs.forEach(function(pair) {
    var typeColors = { antagonist: '#22d3ee', complement: '#4ade80', same: '#fbbf24' };
    html += '<div style="padding:8px 12px;background:rgba(34,211,238,0.03);border-radius:6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center">';
    html += '<div style="color:#e2e8f0;font-size:12px">' + pair.a + ' <span style="color:' + (typeColors[pair.type]||'#22d3ee') + ';margin:0 4px">\u2194</span> ' + pair.b + '</div>';
    html += '<div style="display:flex;align-items:center;gap:8px">';
    html += '<span style="color:' + (typeColors[pair.type]||'#22d3ee') + ';font-size:10px;text-transform:uppercase">' + pair.type + '</span>';
    html += '</div></div>';
  });
  // Current workout analysis
  var clips = document.querySelectorAll('.clip');
  var famCounts = {};
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    var f = c.dataset.family || '';
    famCounts[f] = (famCounts[f] || 0) + 1;
  });
  if (Object.keys(famCounts).length > 0) {
    html += '<div style="color:#94a3b8;font-size:12px;font-weight:600;margin:16px 0 10px">Your Workout Balance</div>';
    var total = 0;
    Object.values(famCounts).forEach(function(v) { total += v; });
    Object.keys(famCounts).forEach(function(fam) {
      var pct = Math.round(famCounts[fam] / total * 100);
      var ideal = fam === 'Core' ? 15 : fam === 'Skills' ? 10 : 25;
      var diff = pct - ideal;
      var status = Math.abs(diff) <= 10 ? '#4ade80' : diff > 10 ? '#fbbf24' : '#f87171';
      html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
      html += '<span style="width:50px;color:' + (famColors[fam]||'#22d3ee') + ';font-size:11px">' + fam + '</span>';
      html += '<div style="flex:1;height:8px;background:rgba(34,211,238,0.05);border-radius:4px;overflow:hidden">';
      html += '<div style="height:100%;width:' + pct + '%;background:' + (famColors[fam]||'#22d3ee') + ';border-radius:4px"></div>';
      html += '</div>';
      html += '<span style="color:' + status + ';font-size:11px;width:40px;text-align:right">' + pct + '%</span>';
      html += '</div>';
    });
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 377: Workout Scoring System
function showWorkoutScore() {
  var clips = document.querySelectorAll('.clip');
  var data = { clips: 0, families: {}, patterns: {}, stages: {}, rpeSum: 0, setsSum: 0, repsSum: 0, exercises: {} };
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    data.clips++;
    data.rpeSum += parseFloat(c.dataset.rpe) || 7;
    data.setsSum += parseInt(c.dataset.sets) || 3;
    data.repsSum += (parseInt(c.dataset.sets)||3) * (parseInt(c.dataset.reps)||10);
    var f = c.dataset.family || ''; data.families[f] = (data.families[f]||0) + 1;
    var p = c.dataset.pattern || ''; data.patterns[p] = (data.patterns[p]||0) + 1;
    var s = c.dataset.stage || 'S1'; data.stages[s] = (data.stages[s]||0) + 1;
    var n = c.dataset.exercise || ''; data.exercises[n] = 1;
  });
  if (data.clips === 0) { showToast('Add clips to get a score'); return; }
  // Volume score (0-25): clips & sets
  var volumeScore = Math.min(25, Math.round(data.setsSum / 2));
  // Intensity score (0-25): avg RPE
  var avgRpe = data.rpeSum / data.clips;
  var intensityScore = Math.min(25, Math.round(avgRpe * 2.5));
  // Variety score (0-25): exercises + families + stages
  var varietyScore = Math.min(25, Object.keys(data.exercises).length * 2 + Object.keys(data.families).length * 3);
  // Balance score (0-25): family distribution evenness
  var famVals = Object.values(data.families);
  var balanceScore = 0;
  if (famVals.length >= 2) {
    var avg = data.clips / famVals.length;
    var variance = 0;
    famVals.forEach(function(v) { variance += Math.pow(v - avg, 2); });
    variance /= famVals.length;
    balanceScore = Math.min(25, Math.round(25 - variance * 2));
  } else { balanceScore = 5; }
  var total = volumeScore + intensityScore + varietyScore + balanceScore;
  var grade = total >= 90 ? 'S' : total >= 80 ? 'A' : total >= 70 ? 'B' : total >= 60 ? 'C' : total >= 40 ? 'D' : 'F';
  var gradeColors = { S: '#22d3ee', A: '#4ade80', B: '#a78bfa', C: '#fbbf24', D: '#fb923c', F: '#f87171' };
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:32px;width:380px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">Workout Score</div>';
  html += '<div style="font-size:72px;font-weight:700;color:' + (gradeColors[grade]||'#22d3ee') + ';margin-bottom:4px">' + grade + '</div>';
  html += '<div style="color:#e2e8f0;font-size:24px;font-weight:300;margin-bottom:24px">' + total + '/100</div>';
  var cats = [
    { label: 'Volume', score: volumeScore, max: 25, color: '#22d3ee' },
    { label: 'Intensity', score: intensityScore, max: 25, color: '#f87171' },
    { label: 'Variety', score: varietyScore, max: 25, color: '#a78bfa' },
    { label: 'Balance', score: balanceScore, max: 25, color: '#4ade80' }
  ];
  cats.forEach(function(cat) {
    var pct = Math.round(cat.score / cat.max * 100);
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
    html += '<span style="width:60px;text-align:right;color:#94a3b8;font-size:12px">' + cat.label + '</span>';
    html += '<div style="flex:1;height:8px;background:rgba(34,211,238,0.05);border-radius:4px;overflow:hidden">';
    html += '<div style="height:100%;width:' + pct + '%;background:' + cat.color + ';border-radius:4px;transition:width 0.3s"></div>';
    html += '</div>';
    html += '<span style="width:35px;color:' + cat.color + ';font-size:12px;font-weight:600">' + cat.score + '</span>';
    html += '</div>';
  });
  html += '<div style="margin-top:16px;color:#64748b;font-size:11px">';
  html += data.clips + ' clips | ' + Object.keys(data.exercises).length + ' exercises | ' + Object.keys(data.families).length + ' families | Avg RPE ' + avgRpe.toFixed(1);
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 378: Quick Notes Sidebar
var _quickNotesOpen = false;
function toggleQuickNotes() {
  if (_quickNotesOpen) {
    var panel = document.getElementById('sms-quick-notes');
    if (panel) panel.remove();
    _quickNotesOpen = false;
    return;
  }
  _quickNotesOpen = true;
  var savedNotes = '';
  try { savedNotes = localStorage.getItem('sms_quick_notes') || ''; } catch(e) {}
  var panel = document.createElement('div');
  panel.id = 'sms-quick-notes';
  panel.style.cssText = 'position:fixed;top:50px;right:0;width:280px;height:calc(100vh - 50px);background:#0a0f1e;border-left:1px solid rgba(34,211,238,0.15);z-index:999;font-family:Sora,sans-serif;display:flex;flex-direction:column';
  var html = '<div style="padding:12px 16px;border-bottom:1px solid rgba(34,211,238,0.1);display:flex;justify-content:space-between;align-items:center">';
  html += '<span style="color:#e2e8f0;font-size:13px;font-weight:600">Quick Notes</span>';
  html += '<button onclick="toggleQuickNotes()" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:14px;font-family:Sora,sans-serif">x</button>';
  html += '</div>';
  html += '<textarea id="sms-quick-notes-text" placeholder="Type session notes here...\n\nThese persist across page reloads." style="flex:1;width:100%;padding:12px 16px;background:transparent;color:#e2e8f0;border:none;resize:none;font-family:Sora,sans-serif;font-size:13px;line-height:1.6;box-sizing:border-box;outline:none">' + savedNotes.replace(/</g, '&lt;') + '</textarea>';
  html += '<div style="padding:8px 16px;border-top:1px solid rgba(34,211,238,0.1);display:flex;justify-content:space-between;align-items:center">';
  html += '<span id="sms-qn-count" style="color:#64748b;font-size:10px">' + savedNotes.length + ' chars</span>';
  html += '<button onclick="clearQuickNotes()" style="padding:4px 8px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.15);border-radius:4px;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Clear</button>';
  html += '</div>';
  panel.innerHTML = html;
  document.body.appendChild(panel);
  var textarea = document.getElementById('sms-quick-notes-text');
  textarea.oninput = function() {
    try { localStorage.setItem('sms_quick_notes', this.value); } catch(e) {}
    var counter = document.getElementById('sms-qn-count');
    if (counter) counter.textContent = this.value.length + ' chars';
  };
  textarea.focus();
}
function clearQuickNotes() {
  var textarea = document.getElementById('sms-quick-notes-text');
  if (textarea) textarea.value = '';
  try { localStorage.setItem('sms_quick_notes', ''); } catch(e) {}
  var counter = document.getElementById('sms-qn-count');
  if (counter) counter.textContent = '0 chars';
  showToast('Notes cleared');
}

// Batch 379: Workout Playlist Creator
var _workoutPlaylist = [];
function showPlaylistCreator() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  if (saved.length === 0) { showToast('Save some workouts first'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto" onclick="event.stopPropagation()">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Workout Playlist</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Queue multiple workouts for a training session</div>';
  // Current playlist
  if (_workoutPlaylist.length > 0) {
    html += '<div style="margin-bottom:12px">';
    html += '<div style="color:#22d3ee;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Current Playlist</div>';
    _workoutPlaylist.forEach(function(name, i) {
      html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(34,211,238,0.05);border-radius:6px;margin-bottom:4px">';
      html += '<span style="color:#22d3ee;font-size:12px;font-weight:600;width:20px">' + (i+1) + '</span>';
      html += '<span style="flex:1;color:#e2e8f0;font-size:13px">' + name + '</span>';
      html += '<button onclick="_workoutPlaylist.splice(' + i + ',1);this.closest(\'div[style*=fixed]\').remove();showPlaylistCreator()" style="background:none;border:none;color:#f87171;cursor:pointer;font-size:12px;font-family:Sora,sans-serif">x</button>';
      html += '</div>';
    });
    var totalClips = 0;
    _workoutPlaylist.forEach(function(name) {
      saved.forEach(function(w) { if(w.name === name) totalClips += (w.clips||[]).length; });
    });
    html += '<div style="color:#64748b;font-size:11px;margin-top:6px">' + _workoutPlaylist.length + ' workouts, ~' + totalClips + ' total clips</div>';
    html += '</div>';
  }
  // Available workouts
  html += '<div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Add to Playlist</div>';
  saved.forEach(function(w) {
    html += '<button onclick="_workoutPlaylist.push(\'' + (w.name||'').replace(/'/g, "\\'") + '\');this.closest(\'div[style*=fixed]\').remove();showPlaylistCreator()" style="display:block;width:100%;padding:8px 12px;margin-bottom:4px;background:rgba(34,211,238,0.03);color:#e2e8f0;border:1px solid rgba(34,211,238,0.1);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px;text-align:left">';
    html += (w.name || 'Untitled') + ' <span style="color:#64748b">(' + (w.clips||[]).length + ' clips)</span>';
    html += '</button>';
  });
  if (_workoutPlaylist.length > 0) {
    html += '<div style="display:flex;gap:8px;margin-top:16px">';
    html += '<button onclick="loadPlaylistWorkout(0)" style="flex:1;padding:10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600">Start Playlist</button>';
    html += '<button onclick="_workoutPlaylist=[];this.closest(\'div[style*=fixed]\').remove();showPlaylistCreator()" style="flex:1;padding:10px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px">Clear</button>';
    html += '</div>';
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function loadPlaylistWorkout(idx) {
  if (idx >= _workoutPlaylist.length) { showToast('Playlist complete!'); return; }
  var name = _workoutPlaylist[idx];
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  var workout = null;
  saved.forEach(function(w) { if(w.name === name) workout = w; });
  if (!workout) { showToast('Workout "' + name + '" not found'); return; }
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  if (typeof loadWorkoutState === 'function') loadWorkoutState(workout);
  showToast('Playlist ' + (idx+1) + '/' + _workoutPlaylist.length + ': ' + name);
  window._playlistIdx = idx;
}
function nextPlaylistWorkout() {
  if (typeof window._playlistIdx === 'undefined') { showToast('No playlist active'); return; }
  loadPlaylistWorkout(window._playlistIdx + 1);
}

// Batch 380: Exercise Frequency Limiter
function checkExerciseFrequency() {
  var clips = document.querySelectorAll('.clip');
  var freq = {};
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    var name = c.dataset.exercise || '';
    freq[name] = (freq[name] || 0) + 1;
  });
  var warnings = [];
  var maxAllowed = 3;
  Object.keys(freq).forEach(function(name) {
    if (freq[name] > maxAllowed) {
      warnings.push({ name: name, count: freq[name] });
    }
  });
  if (warnings.length === 0) {
    showToast('All exercises within frequency limits (max ' + maxAllowed + ')');
    return;
  }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(248,113,113,0.3);border-radius:12px;padding:24px;width:400px">';
  html += '<div style="color:#f87171;font-size:16px;font-weight:700;margin-bottom:12px">Frequency Warnings</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Exercises appearing more than ' + maxAllowed + ' times may indicate redundancy</div>';
  warnings.forEach(function(w) {
    html += '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:rgba(248,113,113,0.05);border-radius:6px;margin-bottom:4px">';
    html += '<span style="color:#e2e8f0;font-size:13px">' + w.name + '</span>';
    html += '<span style="color:#f87171;font-size:13px;font-weight:600">' + w.count + 'x</span>';
    html += '</div>';
  });
  html += '<div style="color:#64748b;font-size:11px;margin-top:12px">Consider swapping duplicates for variety using Quick Swap or Workout Variant</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 381: Training Split Recommender
function showSplitRecommender() {
  var clips = document.querySelectorAll('.clip');
  var families = {};
  var totalClips = 0;
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    totalClips++;
    var f = c.dataset.family || ''; families[f] = (families[f]||0) + 1;
  });
  if (totalClips === 0) { showToast('Build a workout to get recommendations'); return; }
  // Determine dominant patterns
  var pushPull = (families['Push']||0) + (families['Pull']||0);
  var legs = families['Legs'] || 0;
  var core = families['Core'] || 0;
  var skills = families['Skills'] || 0;
  var splits = [];
  // PPL if good volume
  if (totalClips >= 8) {
    splits.push({
      name: 'Push / Pull / Legs',
      match: pushPull > legs ? 85 : 70,
      desc: '3-day split. Day 1: Push+Core, Day 2: Pull+Core, Day 3: Legs+Skills',
      schedule: ['Push + Core', 'Pull + Core', 'Legs + Skills', 'Rest', 'Push + Core', 'Pull + Core', 'Legs + Skills']
    });
  }
  // Upper/Lower
  splits.push({
    name: 'Upper / Lower',
    match: Math.abs(pushPull - legs) < 5 ? 90 : 65,
    desc: '4-day split alternating upper and lower body focus',
    schedule: ['Upper', 'Lower', 'Rest', 'Upper', 'Lower', 'Rest', 'Rest']
  });
  // Full Body
  splits.push({
    name: 'Full Body',
    match: Object.keys(families).length >= 4 ? 90 : 60,
    desc: '3x/week full body, great for beginners and general fitness',
    schedule: ['Full Body', 'Rest', 'Full Body', 'Rest', 'Full Body', 'Rest', 'Rest']
  });
  // Skills Focus
  if (skills > 0) {
    splits.push({
      name: 'Skills + Strength',
      match: skills >= 3 ? 85 : 55,
      desc: 'Skills on fresh days, strength on separate days',
      schedule: ['Skills', 'Strength', 'Rest', 'Skills', 'Strength', 'Mobility', 'Rest']
    });
  }
  splits.sort(function(a,b) { return b.match - a.match; });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Training Split Recommender</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Based on your ' + totalClips + ' clips across ' + Object.keys(families).length + ' families</div>';
  splits.forEach(function(split) {
    var matchColor = split.match >= 80 ? '#4ade80' : split.match >= 60 ? '#fbbf24' : '#94a3b8';
    html += '<div style="padding:14px;background:rgba(34,211,238,0.03);border:1px solid rgba(34,211,238,0.1);border-radius:8px;margin-bottom:10px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    html += '<span style="color:#e2e8f0;font-weight:600;font-size:14px">' + split.name + '</span>';
    html += '<span style="color:' + matchColor + ';font-size:12px;font-weight:600">' + split.match + '% match</span>';
    html += '</div>';
    html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:8px">' + split.desc + '</div>';
    html += '<div style="display:flex;gap:3px">';
    var days = ['M','T','W','T','F','S','S'];
    split.schedule.forEach(function(day, i) {
      var isRest = day === 'Rest';
      html += '<div style="flex:1;text-align:center;padding:4px 2px;background:' + (isRest ? 'rgba(100,116,139,0.1)' : 'rgba(34,211,238,0.1)') + ';border-radius:4px">';
      html += '<div style="color:#64748b;font-size:9px">' + days[i] + '</div>';
      html += '<div style="color:' + (isRest ? '#64748b' : '#22d3ee') + ';font-size:9px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + day + '</div>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 382: Muscle Fatigue Tracker
function showFatigueTracker() {
  var muscleMap = {
    'Horizontal Push': { primary: ['Chest', 'Triceps'], secondary: ['Shoulders'] },
    'Horizontal Pull': { primary: ['Upper Back', 'Biceps'], secondary: ['Rear Delts'] },
    'Downward Press': { primary: ['Shoulders', 'Triceps'], secondary: ['Chest'] },
    'Vertical Pull': { primary: ['Lats', 'Biceps'], secondary: ['Core'] },
    'Overhead Press': { primary: ['Shoulders', 'Triceps'], secondary: ['Core'] },
    'Knee-Dominant': { primary: ['Quads', 'Glutes'], secondary: ['Core'] },
    'Hip-Dominant': { primary: ['Hamstrings', 'Glutes'], secondary: ['Lower Back'] },
    'Core': { primary: ['Abs', 'Obliques'], secondary: ['Hip Flexors'] },
    'Mobility': { primary: [], secondary: [] }
  };
  var fatigue = {};
  var clips = document.querySelectorAll('.clip');
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    var pattern = c.dataset.pattern || '';
    var sets = parseInt(c.dataset.sets) || 3;
    var rpe = parseFloat(c.dataset.rpe) || 7;
    var load = sets * (rpe / 10);
    var mapping = muscleMap[pattern];
    if (!mapping) return;
    mapping.primary.forEach(function(m) {
      fatigue[m] = (fatigue[m] || 0) + load;
    });
    mapping.secondary.forEach(function(m) {
      fatigue[m] = (fatigue[m] || 0) + load * 0.5;
    });
  });
  if (Object.keys(fatigue).length === 0) { showToast('Add clips to track fatigue'); return; }
  var maxFatigue = Math.max.apply(null, Object.values(fatigue));
  var sorted = Object.keys(fatigue).sort(function(a,b) { return fatigue[b] - fatigue[a]; });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Muscle Fatigue Tracker</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Estimated fatigue from sets x RPE intensity</div>';
  sorted.forEach(function(muscle) {
    var val = fatigue[muscle];
    var pct = Math.round(val / maxFatigue * 100);
    var level = pct >= 80 ? 'High' : pct >= 50 ? 'Moderate' : 'Low';
    var color = pct >= 80 ? '#f87171' : pct >= 50 ? '#fbbf24' : '#4ade80';
    html += '<div style="margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px">';
    html += '<span style="color:#e2e8f0;font-size:12px">' + muscle + '</span>';
    html += '<span style="color:' + color + ';font-size:11px;font-weight:600">' + level + ' (' + val.toFixed(1) + ')</span>';
    html += '</div>';
    html += '<div style="height:8px;background:rgba(34,211,238,0.05);border-radius:4px;overflow:hidden">';
    html += '<div style="height:100%;width:' + pct + '%;background:' + color + ';border-radius:4px"></div>';
    html += '</div></div>';
  });
  html += '<div style="color:#64748b;font-size:10px;margin-top:12px">Formula: sets x (RPE/10) per exercise pattern, primary muscles 100%, secondary 50%</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 383: Exercise Substitution Wizard
function showSubstitutionWizard() {
  var sel = document.querySelector('.clip.selected');
  if (!sel) { showToast('Select a clip to find substitutions'); return; }
  var currentName = sel.dataset.exercise || '';
  var currentPattern = sel.dataset.pattern || '';
  var currentFamily = sel.dataset.family || '';
  var currentStage = sel.dataset.stage || 'S1';
  // Find alternatives: same pattern, same family, similar stage
  var exactMatch = [];
  var patternMatch = [];
  var familyMatch = [];
  EXERCISES.forEach(function(e) {
    if (e.name === currentName) return;
    if (e.pattern === currentPattern) {
      if (e.stage === currentStage) exactMatch.push(e);
      else patternMatch.push(e);
    } else if (e.family === currentFamily) {
      familyMatch.push(e);
    }
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Substitution Wizard</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Replace: <span style="color:#22d3ee">' + currentName + '</span> (' + currentPattern + ', ' + currentStage + ')</div>';
  function renderGroup(title, items, color) {
    if (items.length === 0) return '';
    var out = '<div style="color:' + color + ';font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:12px 0 8px">' + title + ' (' + items.length + ')</div>';
    items.forEach(function(ex) {
      out += '<button onclick="executeSubstitution(\'' + ex.name.replace(/'/g, "\\'") + '\')" style="display:block;width:100%;padding:8px 12px;margin-bottom:3px;background:rgba(34,211,238,0.03);color:#e2e8f0;border:1px solid rgba(34,211,238,0.1);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:12px;text-align:left">';
      out += ex.name + ' <span style="color:#64748b">' + ex.stage + ' | ' + (ex.discipline||'') + '</span>';
      out += '</button>';
    });
    return out;
  }
  html += renderGroup('Same Pattern + Stage', exactMatch, '#4ade80');
  html += renderGroup('Same Pattern (different stage)', patternMatch, '#fbbf24');
  html += renderGroup('Same Family', familyMatch, '#94a3b8');
  if (exactMatch.length === 0 && patternMatch.length === 0 && familyMatch.length === 0) {
    html += '<div style="color:#64748b;font-size:13px;text-align:center;padding:20px">No substitutions found</div>';
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function executeSubstitution(newName) {
  var sel = document.querySelector('.clip.selected');
  if (!sel) return;
  var oldName = sel.dataset.exercise || '';
  var found = null;
  EXERCISES.forEach(function(e) { if(e.name === newName) found = e; });
  if (!found) return;
  captureUndo();
  sel.dataset.exercise = found.name;
  sel.dataset.pattern = found.pattern || '';
  sel.dataset.stage = found.stage || 'S1';
  sel.dataset.discipline = found.discipline || '';
  var nameEl = sel.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = found.name;
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showToast('Swapped: ' + oldName + ' -> ' + found.name);
  if (typeof logChange === 'function') logChange('substitute', oldName + ' -> ' + found.name);
}

// Batch 384: Workout Time Estimator
function showTimeEstimator() {
  var tracks = document.querySelectorAll('.track');
  var trackData = [];
  var grandTotal = 0;
  tracks.forEach(function(track) {
    var family = track.dataset.family || '';
    if (family === 'music') return;
    var clips = track.querySelectorAll('.clip');
    var trackTime = 0;
    var clipCount = 0;
    clips.forEach(function(c) {
      clipCount++;
      var sets = parseInt(c.dataset.sets) || 3;
      var reps = parseInt(c.dataset.reps) || 10;
      var tempo = parseInt(c.dataset.tempo) || 3;
      var rest = parseInt(c.dataset.rest) || 60;
      var exerciseTime = sets * reps * tempo;
      var restTime = (sets - 1) * rest;
      trackTime += exerciseTime + restTime;
    });
    if (clipCount > 0) {
      trackData.push({ family: family, clips: clipCount, seconds: trackTime });
      grandTotal += trackTime;
    }
  });
  if (trackData.length === 0) { showToast('Add clips to estimate time'); return; }
  // Add transition time estimate (30s between exercises)
  var totalClips = 0;
  trackData.forEach(function(t) { totalClips += t.clips; });
  var transitionTime = Math.max(0, (totalClips - 1)) * 30;
  grandTotal += transitionTime;
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {push:'#f87171',pull:'#60a5fa',core:'#fbbf24',legs:'#4ade80',skills:'#a78bfa'};
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:420px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Time Estimator</div>';
  // Grand total
  var totalMin = Math.floor(grandTotal / 60);
  var totalSec = grandTotal % 60;
  html += '<div style="text-align:center;margin-bottom:20px">';
  html += '<div style="color:#22d3ee;font-size:36px;font-weight:200">' + totalMin + '<span style="font-size:18px;color:#94a3b8">min</span> ' + totalSec + '<span style="font-size:18px;color:#94a3b8">sec</span></div>';
  html += '<div style="color:#64748b;font-size:11px">Total estimated duration</div>';
  html += '</div>';
  // Per track breakdown
  trackData.forEach(function(t) {
    var min = Math.floor(t.seconds / 60);
    var sec = t.seconds % 60;
    var pct = grandTotal > 0 ? Math.round(t.seconds / grandTotal * 100) : 0;
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
    html += '<div style="width:50px;color:' + (famColors[t.family]||'#22d3ee') + ';font-size:12px;font-weight:600;text-transform:capitalize">' + t.family + '</div>';
    html += '<div style="flex:1;height:8px;background:rgba(34,211,238,0.05);border-radius:4px;overflow:hidden">';
    html += '<div style="height:100%;width:' + pct + '%;background:' + (famColors[t.family]||'#22d3ee') + ';border-radius:4px"></div></div>';
    html += '<div style="width:80px;text-align:right;color:#e2e8f0;font-size:12px">' + min + 'm ' + sec + 's</div>';
    html += '</div>';
  });
  html += '<div style="display:flex;justify-content:space-between;padding:8px 0;margin-top:8px;border-top:1px solid rgba(34,211,238,0.1);color:#64748b;font-size:11px">';
  html += '<span>Transition time (~30s each)</span>';
  html += '<span>' + Math.floor(transitionTime/60) + 'm ' + (transitionTime%60) + 's</span>';
  html += '</div>';
  html += '<div style="color:#64748b;font-size:10px;margin-top:8px">Time = sets x reps x tempo + (sets-1) x rest + transitions</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 385: Workout Blueprint System
var _blueprints = [];
function loadBlueprints() {
  try { _blueprints = JSON.parse(localStorage.getItem('sms_blueprints') || '[]'); } catch(e) { _blueprints = []; }
}
function saveBlueprints() {
  try { localStorage.setItem('sms_blueprints', JSON.stringify(_blueprints)); } catch(e) {}
}
function createBlueprint() {
  var clips = document.querySelectorAll('.clip');
  var slots = [];
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    slots.push({
      family: c.dataset.family || '',
      pattern: c.dataset.pattern || '',
      sets: parseInt(c.dataset.sets) || 3,
      reps: parseInt(c.dataset.reps) || 10,
      rpe: parseFloat(c.dataset.rpe) || 7,
      rest: parseInt(c.dataset.rest) || 60,
      track: c.closest('.track') ? c.closest('.track').dataset.family : 'push',
      left: parseInt(c.style.left) || 0,
      width: parseInt(c.style.width) || 120
    });
  });
  if (slots.length === 0) { showToast('Build a workout to create a blueprint'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:400px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Create Blueprint</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">' + slots.length + ' slots (exercises stripped, structure kept)</div>';
  html += '<input id="sms-bp-name" placeholder="Blueprint name..." style="width:100%;padding:10px;background:#111827;color:#e2e8f0;border:1px solid rgba(34,211,238,0.3);border-radius:8px;font-family:Sora,sans-serif;font-size:14px;margin-bottom:12px;box-sizing:border-box">';
  slots.forEach(function(s, i) {
    html += '<div style="padding:6px 10px;background:rgba(34,211,238,0.03);border-radius:4px;margin-bottom:3px;color:#94a3b8;font-size:12px;display:flex;justify-content:space-between">';
    html += '<span>' + (i+1) + '. ' + s.family + ' (' + s.pattern + ')</span>';
    html += '<span>' + s.sets + 'x' + s.reps + ' @ RPE ' + s.rpe + '</span>';
    html += '</div>';
  });
  html += '<button onclick="saveBlueprintNow()" style="width:100%;padding:10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:8px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600;margin-top:12px">Save Blueprint</button>';
  html += '</div>';
  overlay.innerHTML = html;
  overlay.dataset.slots = JSON.stringify(slots);
  document.body.appendChild(overlay);
  document.getElementById('sms-bp-name').focus();
}
function saveBlueprintNow() {
  var nameInput = document.getElementById('sms-bp-name');
  var name = nameInput ? nameInput.value.trim() : '';
  if (!name) { showToast('Enter a blueprint name'); return; }
  var overlay = nameInput.closest('div[style*="fixed"]');
  var slots = JSON.parse(overlay.dataset.slots || '[]');
  loadBlueprints();
  _blueprints.push({ name: name, slots: slots, created: new Date().toISOString() });
  if (_blueprints.length > 15) _blueprints = _blueprints.slice(-15);
  saveBlueprints();
  overlay.remove();
  showToast('Blueprint "' + name + '" saved');
}
function showBlueprintList() {
  loadBlueprints();
  if (_blueprints.length === 0) { showToast('No blueprints saved'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Blueprints (' + _blueprints.length + ')</div>';
  _blueprints.forEach(function(bp, i) {
    var families = {};
    bp.slots.forEach(function(s) { families[s.family] = (families[s.family]||0)+1; });
    html += '<div style="padding:12px;background:rgba(34,211,238,0.05);border-radius:8px;margin-bottom:8px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    html += '<span style="color:#22d3ee;font-weight:600;font-size:14px">' + bp.name + '</span>';
    html += '<div style="display:flex;gap:4px">';
    html += '<button onclick="applyBlueprint(' + i + ')" style="padding:4px 10px;background:rgba(34,211,238,0.15);color:#22d3ee;border:1px solid rgba(34,211,238,0.3);border-radius:4px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Apply</button>';
    html += '<button onclick="_blueprints.splice(' + i + ',1);saveBlueprints();this.closest(\'div[style*=fixed]\').remove();showBlueprintList();" style="padding:4px 8px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:4px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Del</button>';
    html += '</div></div>';
    html += '<div style="color:#94a3b8;font-size:11px">' + bp.slots.length + ' slots | ' + Object.keys(families).map(function(f) { return f + ':' + families[f]; }).join(', ') + '</div>';
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function applyBlueprint(idx) {
  loadBlueprints();
  var bp = _blueprints[idx];
  if (!bp) return;
  captureUndo();
  bp.slots.forEach(function(slot) {
    var pool = [];
    EXERCISES.forEach(function(e) {
      if (e.family === slot.family || e.pattern === slot.pattern) pool.push(e);
    });
    if (pool.length === 0) return;
    var ex = pool[Math.floor(Math.random() * pool.length)];
    var trackId = slot.track || 'push';
    var track = document.querySelector('.track[data-family="' + trackId + '"] .track-clips');
    if (!track) return;
    var clip = document.createElement('div');
    clip.className = 'clip';
    clip.dataset.exercise = ex.name;
    clip.dataset.family = ex.family;
    clip.dataset.pattern = ex.pattern || '';
    clip.dataset.stage = ex.stage || 'S1';
    clip.dataset.discipline = ex.discipline || '';
    clip.dataset.sets = slot.sets;
    clip.dataset.reps = slot.reps;
    clip.dataset.tempo = ex.tempo || 3;
    clip.dataset.rest = slot.rest;
    clip.dataset.rpe = slot.rpe;
    clip.style.width = slot.width + 'px';
    clip.style.left = slot.left + 'px';
    clip.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--' + trackId + '-color') || '#22d3ee';
    clip.innerHTML = '<div class="clip-name">' + ex.name + '</div><div class="clip-params">' + slot.sets + 'x' + slot.reps + '</div>';
    track.appendChild(clip);
    initClipDrag(clip);
  });
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showToast('Blueprint "' + bp.name + '" applied with random exercises');
}
loadBlueprints();

// Batch 386: RPE Auto-Suggest
function autoSuggestRPE() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  clips = clips.filter(function(c) { return !c.closest('.track[data-family="music"]') && !c.classList.contains('clip-locked'); });
  if (clips.length === 0) { showToast('No clips to adjust'); return; }
  captureUndo();
  // Sort by position (timeline order)
  clips.sort(function(a, b) { return (parseInt(a.style.left)||0) - (parseInt(b.style.left)||0); });
  var total = clips.length;
  clips.forEach(function(c, i) {
    var stage = c.dataset.stage || 'S1';
    var baseDifficulty = stage === 'S3' ? 8.5 : stage === 'S2' ? 7 : 5.5;
    // Position ramp: start lower, peak at 60-80%, drop for last 15%
    var position = i / total;
    var positionMod = 0;
    if (position < 0.15) positionMod = -1; // warmup
    else if (position < 0.6) positionMod = 0; // main work
    else if (position < 0.85) positionMod = 0.5; // peak
    else positionMod = -1.5; // cooldown
    var suggested = Math.min(10, Math.max(1, Math.round((baseDifficulty + positionMod) * 10) / 10));
    c.dataset.rpe = suggested;
    if (typeof updateClipInfo === 'function') updateClipInfo(c);
    // Update RPE badge if exists
    var badge = c.querySelector('.clip-rpe-badge');
    if (badge) badge.textContent = suggested;
  });
  showToast('RPE auto-suggested for ' + clips.length + ' clips');
}

// Batch 387: Movement Pattern Analyzer
function analyzeMovementPatterns() {
  var allPatterns = {};
  EXERCISES.forEach(function(e) {
    if (e.pattern && !allPatterns[e.pattern]) {
      allPatterns[e.pattern] = { family: e.family, count: 0, exercises: [] };
    }
  });
  var clips = document.querySelectorAll('.clip');
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    var pat = c.dataset.pattern || '';
    if (allPatterns[pat]) {
      allPatterns[pat].count++;
      var name = c.dataset.exercise || '';
      if (allPatterns[pat].exercises.indexOf(name) < 0) allPatterns[pat].exercises.push(name);
    }
  });
  var present = [];
  var missing = [];
  Object.keys(allPatterns).forEach(function(pat) {
    if (allPatterns[pat].count > 0) present.push({ pattern: pat, data: allPatterns[pat] });
    else missing.push({ pattern: pat, data: allPatterns[pat] });
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa',Mobility:'#818cf8'};
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Movement Pattern Analysis</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">' + present.length + ' patterns used, ' + missing.length + ' missing</div>';
  if (present.length > 0) {
    html += '<div style="color:#4ade80;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Present Patterns</div>';
    present.forEach(function(p) {
      html += '<div style="padding:8px 12px;background:rgba(74,222,128,0.05);border-radius:6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center">';
      html += '<div><span style="color:#e2e8f0;font-size:12px">' + p.pattern + '</span> <span style="color:' + (famColors[p.data.family]||'#22d3ee') + ';font-size:10px">' + p.data.family + '</span></div>';
      html += '<span style="color:#4ade80;font-size:12px;font-weight:600">' + p.data.count + ' clips</span>';
      html += '</div>';
    });
  }
  if (missing.length > 0) {
    html += '<div style="color:#f87171;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px">Missing Patterns</div>';
    missing.forEach(function(p) {
      var suggestions = [];
      EXERCISES.forEach(function(e) { if(e.pattern === p.pattern) suggestions.push(e.name); });
      html += '<div style="padding:8px 12px;background:rgba(248,113,113,0.05);border-radius:6px;margin-bottom:4px">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center">';
      html += '<div><span style="color:#e2e8f0;font-size:12px">' + p.pattern + '</span> <span style="color:' + (famColors[p.data.family]||'#22d3ee') + ';font-size:10px">' + p.data.family + '</span></div>';
      html += '<button onclick="addPatternExercise(\'' + p.pattern.replace(/'/g,"\\'") + '\')" style="padding:3px 8px;background:rgba(34,211,238,0.1);color:#22d3ee;border:1px solid rgba(34,211,238,0.2);border-radius:4px;cursor:pointer;font-family:Sora,sans-serif;font-size:10px">Add</button>';
      html += '</div>';
      if (suggestions.length > 0) {
        html += '<div style="color:#64748b;font-size:10px;margin-top:4px">Suggestions: ' + suggestions.slice(0,3).join(', ') + '</div>';
      }
      html += '</div>';
    });
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function addPatternExercise(pattern) {
  var pool = [];
  EXERCISES.forEach(function(e) { if(e.pattern === pattern) pool.push(e); });
  if (pool.length === 0) return;
  var ex = pool[Math.floor(Math.random() * pool.length)];
  var trackMap = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills'};
  var trackId = trackMap[ex.family] || 'push';
  var track = document.querySelector('.track[data-family="' + trackId + '"] .track-clips');
  if (!track) return;
  captureUndo();
  var clip = document.createElement('div');
  clip.className = 'clip';
  clip.dataset.exercise = ex.name;
  clip.dataset.family = ex.family;
  clip.dataset.pattern = ex.pattern || '';
  clip.dataset.stage = ex.stage || 'S1';
  clip.dataset.discipline = ex.discipline || '';
  clip.dataset.sets = 3;
  clip.dataset.reps = 10;
  clip.dataset.tempo = ex.tempo || 3;
  clip.dataset.rest = 60;
  clip.dataset.rpe = 7;
  clip.style.width = '120px';
  clip.style.left = (playheadX || 10) + 'px';
  clip.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--' + trackId + '-color') || '#22d3ee';
  clip.innerHTML = '<div class="clip-name">' + ex.name + '</div><div class="clip-params">3x10</div>';
  track.appendChild(clip);
  initClipDrag(clip);
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showToast('Added: ' + ex.name + ' (' + pattern + ')');
}

// Batch 388: Quick-Build Presets Panel
function showQuickBuildPanel() {
  var categories = {
    'Strength': [
      { name: 'Heavy Compound', desc: '4x5 @ RPE 8-9, 3 exercises', sets: 4, reps: 5, rpe: 8.5, count: 3, families: ['Push','Pull','Legs'] },
      { name: 'Volume Block', desc: '4x10 @ RPE 7, 5 exercises', sets: 4, reps: 10, rpe: 7, count: 5, families: ['Push','Pull','Core','Legs','Skills'] },
      { name: 'Strength Endurance', desc: '3x15 @ RPE 6, 4 exercises', sets: 3, reps: 15, rpe: 6, count: 4, families: ['Push','Pull','Core','Legs'] }
    ],
    'Skills': [
      { name: 'Skill Practice', desc: '5x3 @ RPE 6, focused', sets: 5, reps: 3, rpe: 6, count: 3, families: ['Skills','Core'] },
      { name: 'Handstand Session', desc: '6x5 @ RPE 7, press focus', sets: 6, reps: 5, rpe: 7, count: 2, families: ['Skills'] }
    ],
    'Recovery': [
      { name: 'Active Recovery', desc: '2x12 @ RPE 4, light', sets: 2, reps: 12, rpe: 4, count: 4, families: ['Mobility','Core'] },
      { name: 'Mobility Flow', desc: '2x8 @ RPE 3, all families', sets: 2, reps: 8, rpe: 3, count: 5, families: ['Mobility','Core','Legs'] }
    ],
    'HIIT': [
      { name: 'Tabata Style', desc: '8x4 @ RPE 9, explosive', sets: 8, reps: 4, rpe: 9, count: 4, families: ['Push','Pull','Legs','Core'] },
      { name: 'Circuit Burner', desc: '3x12 @ RPE 8, 6 exercises', sets: 3, reps: 12, rpe: 8, count: 6, families: ['Push','Pull','Core','Legs','Skills'] }
    ]
  };
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Quick-Build Presets</div>';
  Object.keys(categories).forEach(function(cat) {
    html += '<div style="color:#22d3ee;font-size:12px;text-transform:uppercase;letter-spacing:1px;margin:12px 0 8px">' + cat + '</div>';
    categories[cat].forEach(function(preset) {
      html += '<button onclick=\'applyQuickBuild(' + JSON.stringify(preset).replace(/'/g, "&#39;") + ')\' style="display:block;width:100%;padding:10px 12px;margin-bottom:4px;background:rgba(34,211,238,0.03);color:#e2e8f0;border:1px solid rgba(34,211,238,0.1);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;text-align:left">';
      html += '<div style="font-size:13px;font-weight:600">' + preset.name + '</div>';
      html += '<div style="font-size:11px;color:#94a3b8">' + preset.desc + '</div>';
      html += '</button>';
    });
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function applyQuickBuild(preset) {
  captureUndo();
  var trackMap = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Mobility:'core'};
  var pool = [];
  EXERCISES.forEach(function(e) {
    if (preset.families.indexOf(e.family) >= 0) pool.push(e);
  });
  for (var i = pool.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = pool[i]; pool[i] = pool[j]; pool[j] = tmp;
  }
  var selected = pool.slice(0, preset.count);
  var trackOffsets = {};
  selected.forEach(function(ex) {
    var trackId = trackMap[ex.family] || 'push';
    var track = document.querySelector('.track[data-family="' + trackId + '"] .track-clips');
    if (!track) return;
    if (!trackOffsets[trackId]) trackOffsets[trackId] = 10;
    var clip = document.createElement('div');
    clip.className = 'clip';
    clip.dataset.exercise = ex.name;
    clip.dataset.family = ex.family;
    clip.dataset.pattern = ex.pattern || '';
    clip.dataset.stage = ex.stage || 'S1';
    clip.dataset.discipline = ex.discipline || '';
    clip.dataset.sets = preset.sets;
    clip.dataset.reps = preset.reps;
    clip.dataset.tempo = ex.tempo || 3;
    clip.dataset.rest = 60;
    clip.dataset.rpe = preset.rpe;
    var w = preset.sets * 40;
    clip.style.width = w + 'px';
    clip.style.left = trackOffsets[trackId] + 'px';
    clip.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--' + trackId + '-color') || '#22d3ee';
    clip.innerHTML = '<div class="clip-name">' + ex.name + '</div><div class="clip-params">' + preset.sets + 'x' + preset.reps + '</div>';
    track.appendChild(clip);
    initClipDrag(clip);
    trackOffsets[trackId] += w + 10;
  });
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showToast('Applied: ' + preset.name + ' (' + selected.length + ' exercises)');
}

// Batch 389: Session History Log
function logSessionHistory() {
  var clips = document.querySelectorAll('.clip');
  var clipCount = 0;
  clips.forEach(function(c) { if (!c.closest('.track[data-family="music"]')) clipCount++; });
  if (clipCount === 0) { showToast('Nothing to log'); return; }
  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Untitled';
  var entry = {
    date: new Date().toISOString(),
    name: workoutName,
    clips: clipCount,
    exercises: 0,
    duration: 0,
    bpm: typeof bpm !== 'undefined' ? bpm : 100
  };
  var names = {};
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    names[c.dataset.exercise || ''] = 1;
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 10;
    var tempo = parseInt(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    entry.duration += sets * reps * tempo + (sets - 1) * rest;
  });
  entry.exercises = Object.keys(names).length;
  var history = [];
  try { history = JSON.parse(localStorage.getItem('sms_session_history') || '[]'); } catch(e) {}
  history.push(entry);
  if (history.length > 100) history = history.slice(-100);
  try { localStorage.setItem('sms_session_history', JSON.stringify(history)); } catch(e) {}
  showToast('Session logged: ' + workoutName + ' (' + clipCount + ' clips)');
}
function showSessionHistory() {
  var history = [];
  try { history = JSON.parse(localStorage.getItem('sms_session_history') || '[]'); } catch(e) {}
  if (history.length === 0) { showToast('No session history yet (use Log Session to start)'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:550px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Session History</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">' + history.length + ' sessions logged</div>';
  history.slice().reverse().forEach(function(entry) {
    var date = new Date(entry.date);
    var dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    var durMin = Math.round(entry.duration / 60);
    html += '<div style="padding:10px 12px;background:rgba(34,211,238,0.03);border-radius:6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center">';
    html += '<div>';
    html += '<div style="color:#e2e8f0;font-size:13px;font-weight:600">' + (entry.name || 'Untitled') + '</div>';
    html += '<div style="color:#64748b;font-size:10px">' + dateStr + '</div>';
    html += '</div>';
    html += '<div style="text-align:right">';
    html += '<div style="color:#22d3ee;font-size:12px">' + entry.clips + ' clips | ' + entry.exercises + ' exercises</div>';
    html += '<div style="color:#94a3b8;font-size:10px">~' + durMin + ' min | ' + entry.bpm + ' BPM</div>';
    html += '</div></div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 390: Workout Export as PDF-ready HTML
function exportPDFReady() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { showToast('No clips to export'); return; }
  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Workout';
  var tracks = {};
  clips.forEach(function(c) {
    var trackFamily = c.closest('.track') ? c.closest('.track').dataset.family : 'other';
    if (trackFamily === 'music') return;
    if (!tracks[trackFamily]) tracks[trackFamily] = [];
    tracks[trackFamily].push({
      name: c.dataset.exercise || '',
      sets: parseInt(c.dataset.sets) || 3,
      reps: parseInt(c.dataset.reps) || 10,
      rpe: parseFloat(c.dataset.rpe) || 7,
      rest: parseInt(c.dataset.rest) || 60,
      tempo: parseInt(c.dataset.tempo) || 3,
      stage: c.dataset.stage || 'S1',
      pattern: c.dataset.pattern || ''
    });
  });
  var famLabels = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var htmlStr = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + workoutName + '</title>';
  htmlStr += '<style>@page{size:A4;margin:20mm}*{margin:0;padding:0;box-sizing:border-box}';
  htmlStr += 'body{font-family:Sora,Helvetica,Arial,sans-serif;color:#1a1a2e;background:#fff;padding:20px}';
  htmlStr += 'h1{font-size:22px;margin-bottom:4px}h2{font-size:14px;color:#1a1a2e;margin:16px 0 8px;padding-bottom:4px;border-bottom:2px solid #e0e0e0}';
  htmlStr += 'table{width:100%;border-collapse:collapse;margin-bottom:12px;font-size:12px}';
  htmlStr += 'th{background:#f5f5f5;padding:6px 8px;text-align:left;border-bottom:1px solid #ddd;font-weight:600}';
  htmlStr += 'td{padding:6px 8px;border-bottom:1px solid #eee}.meta{color:#666;font-size:11px;margin-bottom:16px}';
  htmlStr += '.notes-box{border:1px dashed #ccc;padding:12px;min-height:60px;margin:16px 0;font-size:11px;color:#999}';
  htmlStr += '.footer{text-align:center;color:#aaa;font-size:10px;margin-top:24px;padding-top:8px;border-top:1px solid #eee}';
  htmlStr += '</style></head><body>';
  htmlStr += '<h1>' + workoutName + '</h1>';
  htmlStr += '<div class="meta">Generated ' + new Date().toLocaleDateString() + ' | Saturno Movement Studio</div>';
  Object.keys(tracks).forEach(function(trackId) {
    htmlStr += '<h2>' + (famLabels[trackId] || trackId) + ' (' + tracks[trackId].length + ' exercises)</h2>';
    htmlStr += '<table><tr><th>#</th><th>Exercise</th><th>Sets x Reps</th><th>Tempo</th><th>Rest</th><th>RPE</th><th>Stage</th></tr>';
    tracks[trackId].forEach(function(ex, i) {
      htmlStr += '<tr><td>' + (i+1) + '</td><td>' + ex.name + '</td><td>' + ex.sets + ' x ' + ex.reps + '</td>';
      htmlStr += '<td>' + ex.tempo + 's</td><td>' + ex.rest + 's</td><td>' + ex.rpe + '</td><td>' + ex.stage + '</td></tr>';
    });
    htmlStr += '</table>';
  });
  htmlStr += '<div class="notes-box">Session Notes:<br><br><br></div>';
  htmlStr += '<div class="footer">Saturno Movement Studio | The Ableton of Movement | saturnomovement.com</div>';
  htmlStr += '</body></html>';
  var blob = new Blob([htmlStr], {type:'text/html'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = (workoutName.replace(/[^a-zA-Z0-9]/g,'-') || 'workout') + '-printable.html';
  a.click();
  URL.revokeObjectURL(url);
  showToast('PDF-ready HTML downloaded');
}

// Batch 391: Workout Fingerprint
function showWorkoutFingerprint() {
  var clips = document.querySelectorAll('.clip');
  var data = [];
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    data.push({
      f: c.dataset.family || '',
      s: parseInt(c.dataset.sets) || 3,
      r: parseInt(c.dataset.reps) || 10,
      rpe: parseFloat(c.dataset.rpe) || 7
    });
  });
  if (data.length === 0) { showToast('Add clips to generate fingerprint'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  // Generate visual fingerprint as SVG
  var size = 200;
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa'};
  var svg = '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">';
  svg += '<circle cx="100" cy="100" r="95" fill="none" stroke="rgba(34,211,238,0.1)" stroke-width="1"/>';
  var cx = size / 2, cy = size / 2;
  data.forEach(function(d, i) {
    var angle = (i / data.length) * Math.PI * 2 - Math.PI / 2;
    var radius = 20 + (d.rpe / 10) * 70;
    var x = cx + Math.cos(angle) * radius;
    var y = cy + Math.sin(angle) * radius;
    var r = 3 + d.s;
    var color = famColors[d.f] || '#22d3ee';
    svg += '<circle cx="' + x.toFixed(1) + '" cy="' + y.toFixed(1) + '" r="' + r + '" fill="' + color + '" opacity="0.7"/>';
    // Connect to next
    if (i < data.length - 1) {
      var nextAngle = ((i+1) / data.length) * Math.PI * 2 - Math.PI / 2;
      var nextR = 20 + (data[i+1].rpe / 10) * 70;
      var nx = cx + Math.cos(nextAngle) * nextR;
      var ny = cy + Math.sin(nextAngle) * nextR;
      svg += '<line x1="' + x.toFixed(1) + '" y1="' + y.toFixed(1) + '" x2="' + nx.toFixed(1) + '" y2="' + ny.toFixed(1) + '" stroke="rgba(34,211,238,0.15)" stroke-width="1"/>';
    }
  });
  svg += '</svg>';
  // Generate hash
  var hash = '';
  data.forEach(function(d) { hash += d.f.charAt(0) + d.s + d.r; });
  var hashCode = 0;
  for (var i = 0; i < hash.length; i++) {
    hashCode = ((hashCode << 5) - hashCode) + hash.charCodeAt(i);
    hashCode |= 0;
  }
  var hexHash = Math.abs(hashCode).toString(16).toUpperCase().padStart(8, '0');
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:32px;text-align:center;width:300px">';
  html += '<div style="color:#e2e8f0;font-size:14px;font-weight:700;margin-bottom:16px">Workout Fingerprint</div>';
  html += '<div style="display:flex;justify-content:center;margin-bottom:16px">' + svg + '</div>';
  html += '<div style="color:#22d3ee;font-size:18px;font-family:monospace;letter-spacing:2px;margin-bottom:8px">#' + hexHash + '</div>';
  html += '<div style="color:#64748b;font-size:11px">' + data.length + ' clips | ' + Object.keys(famColors).filter(function(f) { return data.some(function(d) { return d.f === f; }); }).length + ' families</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 392: Exercise Superset Auto-Pair
function autoSupersetPair() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  clips = clips.filter(function(c) { return !c.closest('.track[data-family="music"]') && !c.classList.contains('clip-locked'); });
  if (clips.length < 2) { showToast('Need 2+ clips to pair'); return; }
  // Group by track position
  clips.sort(function(a, b) { return (parseInt(a.style.left)||0) - (parseInt(b.style.left)||0); });
  // Pairing rules: push+pull, legs+core, any antagonist
  var pairRules = [
    { a: 'Push', b: 'Pull' },
    { a: 'Pull', b: 'Push' },
    { a: 'Legs', b: 'Core' },
    { a: 'Core', b: 'Legs' },
    { a: 'Skills', b: 'Core' }
  ];
  var paired = [];
  var used = {};
  clips.forEach(function(c, i) {
    if (used[i]) return;
    var famA = c.dataset.family || '';
    for (var j = i + 1; j < clips.length; j++) {
      if (used[j]) continue;
      var famB = clips[j].dataset.family || '';
      var match = pairRules.some(function(r) { return r.a === famA && r.b === famB; });
      if (match) {
        paired.push({ a: c, b: clips[j] });
        used[i] = true;
        used[j] = true;
        break;
      }
    }
  });
  if (paired.length === 0) { showToast('No antagonist pairs found (need Push+Pull or Legs+Core)'); return; }
  captureUndo();
  var supersetId = Date.now();
  var colors = ['#a78bfa', '#22d3ee', '#fbbf24', '#4ade80', '#f87171'];
  paired.forEach(function(pair, idx) {
    var color = colors[idx % colors.length];
    var label = String.fromCharCode(65 + idx) + '1';
    [pair.a, pair.b].forEach(function(clip, ci) {
      clip.dataset.superset = supersetId + '-' + idx;
      // Position B clip to overlap with A clip
      if (ci === 1) {
        var aLeft = parseInt(pair.a.style.left) || 0;
        var aWidth = parseInt(pair.a.style.width) || 120;
        clip.style.left = aLeft + 'px';
      }
      // Add visual badge
      var badge = clip.querySelector('.superset-badge');
      if (!badge) {
        badge = document.createElement('div');
        badge.className = 'superset-badge';
        badge.style.cssText = 'position:absolute;top:-6px;left:50%;transform:translateX(-50%);padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;color:#fff;z-index:2;background:' + color;
        clip.appendChild(badge);
        clip.style.position = 'absolute';
      }
      badge.textContent = String.fromCharCode(65 + idx) + (ci + 1);
      badge.style.background = color;
    });
  });
  showToast(paired.length + ' superset pairs created');
}

// Batch 393: Volume Landmark Indicators
function showVolumeLandmarks() {
  // MEV (Minimum Effective Volume), MAV (Maximum Adaptive Volume), MRV (Maximum Recoverable Volume)
  var landmarks = {
    Push: { MEV: 6, MAV: 14, MRV: 20 },
    Pull: { MEV: 6, MAV: 16, MRV: 22 },
    Core: { MEV: 4, MAV: 12, MRV: 18 },
    Legs: { MEV: 6, MAV: 14, MRV: 20 },
    Skills: { MEV: 4, MAV: 10, MRV: 14 }
  };
  var clips = document.querySelectorAll('.clip');
  var familySets = {};
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    var fam = c.dataset.family || '';
    var sets = parseInt(c.dataset.sets) || 3;
    familySets[fam] = (familySets[fam] || 0) + sets;
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa'};
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Volume Landmarks</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Weekly sets per family vs. training volume guidelines</div>';
  Object.keys(landmarks).forEach(function(fam) {
    var lm = landmarks[fam];
    var current = familySets[fam] || 0;
    var maxBar = lm.MRV + 4;
    var status = '';
    var statusColor = '';
    if (current === 0) { status = 'No volume'; statusColor = '#64748b'; }
    else if (current < lm.MEV) { status = 'Below MEV'; statusColor = '#f87171'; }
    else if (current <= lm.MAV) { status = 'Optimal'; statusColor = '#4ade80'; }
    else if (current <= lm.MRV) { status = 'Near MRV'; statusColor = '#fbbf24'; }
    else { status = 'Over MRV!'; statusColor = '#f87171'; }
    html += '<div style="margin-bottom:14px">';
    html += '<div style="display:flex;justify-content:space-between;margin-bottom:4px">';
    html += '<span style="color:' + (famColors[fam]||'#22d3ee') + ';font-size:13px;font-weight:600">' + fam + '</span>';
    html += '<span style="color:' + statusColor + ';font-size:11px;font-weight:600">' + current + ' sets — ' + status + '</span>';
    html += '</div>';
    // Bar with landmarks
    html += '<div style="position:relative;height:20px;background:rgba(34,211,238,0.05);border-radius:4px;overflow:visible">';
    // MEV marker
    html += '<div style="position:absolute;left:' + (lm.MEV/maxBar*100) + '%;top:0;height:100%;width:1px;background:#f87171" title="MEV: ' + lm.MEV + '"></div>';
    // MAV marker
    html += '<div style="position:absolute;left:' + (lm.MAV/maxBar*100) + '%;top:0;height:100%;width:1px;background:#4ade80" title="MAV: ' + lm.MAV + '"></div>';
    // MRV marker
    html += '<div style="position:absolute;left:' + (lm.MRV/maxBar*100) + '%;top:0;height:100%;width:1px;background:#fbbf24" title="MRV: ' + lm.MRV + '"></div>';
    // Current bar
    var currentPct = Math.min(current / maxBar * 100, 100);
    html += '<div style="height:100%;width:' + currentPct + '%;background:' + (famColors[fam]||'#22d3ee') + '40;border-radius:4px"></div>';
    html += '</div>';
    html += '<div style="display:flex;justify-content:space-between;margin-top:2px">';
    html += '<span style="color:#f87171;font-size:9px">MEV ' + lm.MEV + '</span>';
    html += '<span style="color:#4ade80;font-size:9px">MAV ' + lm.MAV + '</span>';
    html += '<span style="color:#fbbf24;font-size:9px">MRV ' + lm.MRV + '</span>';
    html += '</div></div>';
  });
  html += '<div style="color:#64748b;font-size:10px;margin-top:8px">MEV = Minimum Effective Volume | MAV = Maximum Adaptive Volume | MRV = Maximum Recoverable Volume (per week)</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 394: Clip Color Legend
function showColorLegend() {
  var famColors = {
    Push: { color: 'var(--push-color, #f87171)', label: 'Push (Chest, Triceps, Shoulders)' },
    Pull: { color: 'var(--pull-color, #60a5fa)', label: 'Pull (Back, Biceps)' },
    Core: { color: 'var(--core-color, #fbbf24)', label: 'Core (Abs, Obliques)' },
    Legs: { color: 'var(--legs-color, #4ade80)', label: 'Legs (Quads, Hamstrings, Glutes)' },
    Skills: { color: 'var(--skills-color, #a78bfa)', label: 'Skills (Handstands, L-sits, Planches)' }
  };
  var customColors = {
    '#f87171': 'Red', '#fb923c': 'Orange', '#fbbf24': 'Amber',
    '#4ade80': 'Green', '#60a5fa': 'Blue', '#a78bfa': 'Purple', '#f472b6': 'Pink'
  };
  // Count custom colors in use
  var usedCustom = {};
  document.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.customColor) usedCustom[c.dataset.customColor] = (usedCustom[c.dataset.customColor]||0) + 1;
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:380px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Color Legend</div>';
  html += '<div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Family Colors</div>';
  Object.keys(famColors).forEach(function(fam) {
    var fc = famColors[fam];
    var fallback = fc.color.match(/#[0-9a-fA-F]+/) ? fc.color.match(/#[0-9a-fA-F]+/)[0] : '#22d3ee';
    html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
    html += '<div style="width:20px;height:20px;border-radius:4px;background:' + fallback + ';flex-shrink:0"></div>';
    html += '<div style="color:#e2e8f0;font-size:12px">' + fc.label + '</div>';
    html += '</div>';
  });
  if (Object.keys(usedCustom).length > 0) {
    html += '<div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px">Custom Colors in Use</div>';
    Object.keys(usedCustom).forEach(function(col) {
      html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
      html += '<div style="width:20px;height:20px;border-radius:4px;background:' + col + ';flex-shrink:0"></div>';
      html += '<div style="color:#e2e8f0;font-size:12px">' + (customColors[col]||col) + ' (' + usedCustom[col] + ' clips)</div>';
      html += '</div>';
    });
  }
  html += '<div style="color:#64748b;font-size:10px;margin-top:12px">Right-click any clip to change its color. RPE color mode overrides family colors.</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 395: Exercise Pool Manager
function showPoolManager() {
  var disabled = {};
  try { disabled = JSON.parse(localStorage.getItem('sms_disabled_exercises') || '{}'); } catch(e) {}
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa',Mobility:'#818cf8'};
  var enabledCount = 0;
  EXERCISES.forEach(function(e) { if(!disabled[e.name]) enabledCount++; });
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:550px;max-height:85vh;overflow-y:auto" onclick="event.stopPropagation()">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700">Exercise Pool Manager</div>';
  html += '<div style="color:#94a3b8;font-size:12px">' + enabledCount + '/' + EXERCISES.length + ' enabled</div>';
  html += '</div>';
  html += '<div style="display:flex;gap:6px;margin-bottom:12px">';
  html += '<button onclick="poolEnableAll()" style="padding:6px 12px;background:rgba(74,222,128,0.1);color:#4ade80;border:1px solid rgba(74,222,128,0.2);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Enable All</button>';
  html += '<button onclick="poolDisableAll()" style="padding:6px 12px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.2);border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:11px">Disable All</button>';
  html += '</div>';
  var byFamily = {};
  EXERCISES.forEach(function(e) {
    if (!byFamily[e.family]) byFamily[e.family] = [];
    byFamily[e.family].push(e);
  });
  Object.keys(byFamily).forEach(function(fam) {
    html += '<div style="color:' + (famColors[fam]||'#22d3ee') + ';font-size:11px;text-transform:uppercase;letter-spacing:1px;margin:12px 0 6px">' + fam + '</div>';
    byFamily[fam].forEach(function(ex) {
      var isDisabled = disabled[ex.name];
      html += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0">';
      html += '<input type="checkbox" ' + (isDisabled ? '' : 'checked') + ' onchange="togglePoolExercise(\'' + ex.name.replace(/'/g,"\\'") + '\',this.checked)" style="cursor:pointer">';
      html += '<span style="color:' + (isDisabled ? '#64748b' : '#e2e8f0') + ';font-size:12px;' + (isDisabled ? 'text-decoration:line-through' : '') + '">' + ex.name + '</span>';
      html += '<span style="color:#64748b;font-size:10px">' + ex.stage + '</span>';
      html += '</div>';
    });
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function togglePoolExercise(name, enabled) {
  var disabled = {};
  try { disabled = JSON.parse(localStorage.getItem('sms_disabled_exercises') || '{}'); } catch(e) {}
  if (enabled) { delete disabled[name]; }
  else { disabled[name] = true; }
  try { localStorage.setItem('sms_disabled_exercises', JSON.stringify(disabled)); } catch(e) {}
}
function poolEnableAll() {
  try { localStorage.setItem('sms_disabled_exercises', '{}'); } catch(e) {}
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showPoolManager();
  showToast('All exercises enabled');
}
function poolDisableAll() {
  var disabled = {};
  EXERCISES.forEach(function(e) { disabled[e.name] = true; });
  try { localStorage.setItem('sms_disabled_exercises', JSON.stringify(disabled)); } catch(e) {}
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showPoolManager();
  showToast('All exercises disabled');
}

// Batch 396: Session Comparison Timeline
function showSessionComparison() {
  var history = [];
  try { history = JSON.parse(localStorage.getItem('sms_session_history') || '[]'); } catch(e) {}
  if (history.length < 2) { showToast('Need 2+ logged sessions to compare (use Log Session first)'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var last5 = history.slice(-5);
  var maxClips = Math.max.apply(null, last5.map(function(s) { return s.clips || 0; }).concat([1]));
  var maxDur = Math.max.apply(null, last5.map(function(s) { return s.duration || 0; }).concat([1]));
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:600px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Session Comparison (Last ' + last5.length + ')</div>';
  // Timeline bars
  html += '<div style="margin-bottom:16px">';
  html += '<div style="color:#94a3b8;font-size:11px;margin-bottom:8px">Clips per session</div>';
  last5.forEach(function(s) {
    var pct = Math.round((s.clips || 0) / maxClips * 100);
    var date = new Date(s.date).toLocaleDateString();
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
    html += '<span style="width:60px;color:#64748b;font-size:10px;text-align:right;flex-shrink:0">' + date + '</span>';
    html += '<div style="flex:1;height:16px;background:rgba(34,211,238,0.05);border-radius:3px;overflow:hidden">';
    html += '<div style="height:100%;width:' + pct + '%;background:rgba(34,211,238,0.4);border-radius:3px;display:flex;align-items:center;padding:0 6px">';
    html += '<span style="color:#e2e8f0;font-size:9px;font-weight:600">' + s.clips + '</span>';
    html += '</div></div>';
    html += '</div>';
  });
  html += '</div>';
  // Duration bars
  html += '<div style="margin-bottom:16px">';
  html += '<div style="color:#94a3b8;font-size:11px;margin-bottom:8px">Duration (minutes)</div>';
  last5.forEach(function(s) {
    var durMin = Math.round((s.duration || 0) / 60);
    var pct = Math.round((s.duration || 0) / maxDur * 100);
    var date = new Date(s.date).toLocaleDateString();
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">';
    html += '<span style="width:60px;color:#64748b;font-size:10px;text-align:right;flex-shrink:0">' + date + '</span>';
    html += '<div style="flex:1;height:16px;background:rgba(74,222,128,0.05);border-radius:3px;overflow:hidden">';
    html += '<div style="height:100%;width:' + pct + '%;background:rgba(74,222,128,0.3);border-radius:3px;display:flex;align-items:center;padding:0 6px">';
    html += '<span style="color:#e2e8f0;font-size:9px;font-weight:600">' + durMin + 'm</span>';
    html += '</div></div>';
    html += '</div>';
  });
  html += '</div>';
  // Summary trend
  var first = last5[0];
  var last = last5[last5.length - 1];
  var clipTrend = (last.clips || 0) - (first.clips || 0);
  var durTrend = Math.round(((last.duration||0) - (first.duration||0)) / 60);
  html += '<div style="display:flex;gap:16px;padding:12px;background:rgba(34,211,238,0.03);border-radius:8px">';
  html += '<div style="text-align:center;flex:1">';
  html += '<div style="color:' + (clipTrend >= 0 ? '#4ade80' : '#f87171') + ';font-size:16px;font-weight:600">' + (clipTrend >= 0 ? '+' : '') + clipTrend + '</div>';
  html += '<div style="color:#64748b;font-size:10px">Clip trend</div>';
  html += '</div>';
  html += '<div style="text-align:center;flex:1">';
  html += '<div style="color:' + (durTrend >= 0 ? '#4ade80' : '#f87171') + ';font-size:16px;font-weight:600">' + (durTrend >= 0 ? '+' : '') + durTrend + 'm</div>';
  html += '<div style="color:#64748b;font-size:10px">Duration trend</div>';
  html += '</div>';
  html += '</div></div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 397: Workout Insights
function showWorkoutInsights() {
  var clips = document.querySelectorAll('.clip');
  var data = { total: 0, families: {}, patterns: {}, rpeSum: 0, setsSum: 0, repsSum: 0, exercises: {}, stages: {} };
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    data.total++;
    data.rpeSum += parseFloat(c.dataset.rpe) || 7;
    data.setsSum += parseInt(c.dataset.sets) || 3;
    data.repsSum += (parseInt(c.dataset.sets)||3) * (parseInt(c.dataset.reps)||10);
    var f = c.dataset.family || ''; data.families[f] = (data.families[f]||0) + 1;
    var p = c.dataset.pattern || ''; data.patterns[p] = (data.patterns[p]||0) + 1;
    var s = c.dataset.stage || 'S1'; data.stages[s] = (data.stages[s]||0) + 1;
    var n = c.dataset.exercise || ''; data.exercises[n] = (data.exercises[n]||0) + 1;
  });
  if (data.total === 0) { showToast('Add clips to get insights'); return; }
  var insights = [];
  var avgRpe = data.rpeSum / data.total;
  // Volume insight
  if (data.setsSum < 10) insights.push({ type: 'warning', text: 'Low volume workout (' + data.setsSum + ' total sets). Consider adding more exercises for hypertrophy.' });
  else if (data.setsSum > 30) insights.push({ type: 'warning', text: 'High volume (' + data.setsSum + ' sets). Watch for fatigue accumulation.' });
  else insights.push({ type: 'good', text: 'Solid volume: ' + data.setsSum + ' sets across ' + data.total + ' exercises.' });
  // Balance insight
  var famKeys = Object.keys(data.families);
  if (famKeys.length === 1) insights.push({ type: 'warning', text: 'Single-family workout. Consider adding variety for balanced development.' });
  else if (famKeys.length >= 4) insights.push({ type: 'good', text: 'Great diversity with ' + famKeys.length + ' families covered.' });
  // RPE insight
  if (avgRpe >= 8.5) insights.push({ type: 'warning', text: 'Very high average RPE (' + avgRpe.toFixed(1) + '). Ensure adequate recovery.' });
  else if (avgRpe <= 5) insights.push({ type: 'info', text: 'Low intensity session (RPE ' + avgRpe.toFixed(1) + '). Good for active recovery.' });
  else insights.push({ type: 'good', text: 'Well-calibrated intensity at RPE ' + avgRpe.toFixed(1) + '.' });
  // Stage insight
  var s3Count = data.stages['S3'] || 0;
  var s1Count = data.stages['S1'] || 0;
  if (s3Count > data.total * 0.6) insights.push({ type: 'info', text: 'Heavy on S3 exercises (' + s3Count + '/' + data.total + '). Advanced workout.' });
  if (s1Count > data.total * 0.8) insights.push({ type: 'info', text: 'Mostly S1 exercises. Consider progressing to S2 as you improve.' });
  // Push/Pull balance
  var push = data.families['Push'] || 0;
  var pull = data.families['Pull'] || 0;
  if (push > 0 && pull > 0) {
    var ratio = push / pull;
    if (ratio > 1.5) insights.push({ type: 'warning', text: 'Push-heavy workout (Push:Pull = ' + push + ':' + pull + '). Add more pulling.' });
    else if (ratio < 0.67) insights.push({ type: 'warning', text: 'Pull-heavy workout (Push:Pull = ' + push + ':' + pull + '). Balance with more pushing.' });
    else insights.push({ type: 'good', text: 'Good push-pull balance (' + push + ':' + pull + ').' });
  }
  // Duplicate exercises
  var dupes = Object.keys(data.exercises).filter(function(n) { return data.exercises[n] > 2; });
  if (dupes.length > 0) insights.push({ type: 'info', text: dupes.length + ' exercise(s) used 3+ times: consider swapping for variety.' });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var icons = { good: '\u2713', warning: '\u26a0', info: '\u2139' };
  var colors = { good: '#4ade80', warning: '#fbbf24', info: '#60a5fa' };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Workout Insights</div>';
  insights.forEach(function(ins) {
    html += '<div style="display:flex;gap:10px;padding:10px;background:rgba(34,211,238,0.03);border-radius:6px;margin-bottom:6px;align-items:flex-start">';
    html += '<span style="color:' + colors[ins.type] + ';font-size:14px;flex-shrink:0">' + icons[ins.type] + '</span>';
    html += '<span style="color:#e2e8f0;font-size:12px;line-height:1.5">' + ins.text + '</span>';
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 398: Exercise Favorites
function toggleFavorite() {
  var sel = document.querySelector('.clip.selected');
  if (!sel) { showToast('Select a clip to favorite its exercise'); return; }
  var name = sel.dataset.exercise || '';
  if (!name) return;
  var favs = {};
  try { favs = JSON.parse(localStorage.getItem('sms_favorites') || '{}'); } catch(e) {}
  if (favs[name]) {
    delete favs[name];
    showToast(name + ' removed from favorites');
  } else {
    favs[name] = true;
    showToast(name + ' added to favorites');
  }
  try { localStorage.setItem('sms_favorites', JSON.stringify(favs)); } catch(e) {}
}
function showFavorites() {
  var favs = {};
  try { favs = JSON.parse(localStorage.getItem('sms_favorites') || '{}'); } catch(e) {}
  var favNames = Object.keys(favs);
  if (favNames.length === 0) { showToast('No favorites yet (select a clip and use Toggle Favorite)'); return; }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa',Mobility:'#818cf8'};
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:400px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:16px">Favorite Exercises (' + favNames.length + ')</div>';
  favNames.forEach(function(name) {
    var ex = null;
    EXERCISES.forEach(function(e) { if(e.name === name) ex = e; });
    var family = ex ? ex.family : '';
    html += '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(34,211,238,0.03);border-radius:6px;margin-bottom:4px">';
    html += '<span style="color:#fbbf24;font-size:14px">\u2605</span>';
    html += '<span style="flex:1;color:#e2e8f0;font-size:13px">' + name + '</span>';
    if (family) html += '<span style="color:' + (famColors[family]||'#22d3ee') + ';font-size:10px">' + family + '</span>';
    html += '<button onclick="removeFavorite(\'' + name.replace(/'/g,"\\'") + '\')" style="padding:2px 6px;background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.15);border-radius:4px;cursor:pointer;font-size:10px;font-family:Sora,sans-serif">x</button>';
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}
function removeFavorite(name) {
  var favs = {};
  try { favs = JSON.parse(localStorage.getItem('sms_favorites') || '{}'); } catch(e) {}
  delete favs[name];
  try { localStorage.setItem('sms_favorites', JSON.stringify(favs)); } catch(e) {}
  document.querySelectorAll('div[style*="fixed"][style*="9999"]').forEach(function(o) { o.remove(); });
  showFavorites();
}

// Batch 399: About & Credits Modal
function showAbout() {
  var cmdCount = typeof CMD_ACTIONS !== 'undefined' ? CMD_ACTIONS.length : '330+';
  var exCount = typeof EXERCISES !== 'undefined' ? EXERCISES.length : 58;
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:32px;width:420px;text-align:center">';
  html += '<div style="margin-bottom:16px"><img src="assets/planet-logo.svg" onerror="this.src=\'assets/planet-logo.png\'" style="width:48px;height:48px;opacity:0.8"></div>';
  html += '<div style="color:#e2e8f0;font-size:20px;font-weight:700;margin-bottom:4px">Saturno Movement Studio</div>';
  html += '<div style="color:#22d3ee;font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:16px">The Ableton of Movement</div>';
  html += '<div style="color:#94a3b8;font-size:12px;line-height:1.6;margin-bottom:20px;text-align:left">';
  html += 'A DAW-style workout composition tool where exercises are instruments, sets are bars, reps are beats, and BPM controls both music and training tempo.';
  html += '</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px">';
  html += '<div style="padding:8px;background:rgba(34,211,238,0.05);border-radius:6px"><div style="color:#22d3ee;font-size:18px;font-weight:700">' + exCount + '</div><div style="color:#64748b;font-size:10px">Exercises</div></div>';
  html += '<div style="padding:8px;background:rgba(34,211,238,0.05);border-radius:6px"><div style="color:#22d3ee;font-size:18px;font-weight:700">' + cmdCount + '</div><div style="color:#64748b;font-size:10px">Commands</div></div>';
  html += '<div style="padding:8px;background:rgba(34,211,238,0.05);border-radius:6px"><div style="color:#22d3ee;font-size:18px;font-weight:700">6</div><div style="color:#64748b;font-size:10px">Tracks</div></div>';
  html += '</div>';
  html += '<div style="color:#64748b;font-size:10px;line-height:1.6">';
  html += 'Part of the Saturno Movement ecosystem<br>';
  html += 'Built by Gabo Saturno with Claude Code<br>';
  html += 'saturnomovement.com';
  html += '</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 400: Workout DNA Generator
function showWorkoutDNA() {
  var clips = document.querySelectorAll('.clip');
  var data = [];
  var famCounts = {};
  var totalSets = 0;
  var rpeSum = 0;
  clips.forEach(function(c) {
    if (c.closest('.track[data-family="music"]')) return;
    var fam = c.dataset.family || '';
    var rpe = parseFloat(c.dataset.rpe) || 7;
    var sets = parseInt(c.dataset.sets) || 3;
    var stage = c.dataset.stage || 'S1';
    data.push({ fam: fam, rpe: rpe, sets: sets, stage: stage });
    famCounts[fam] = (famCounts[fam] || 0) + 1;
    totalSets += sets;
    rpeSum += rpe;
  });
  if (data.length === 0) { showToast('Build a workout to generate DNA'); return; }
  var avgRpe = rpeSum / data.length;
  var famColors = {Push:'#f87171',Pull:'#60a5fa',Core:'#fbbf24',Legs:'#4ade80',Skills:'#a78bfa'};
  // Generate DNA strip as SVG
  var stripW = 400;
  var stripH = 40;
  var segW = Math.max(2, Math.floor(stripW / data.length));
  var svg = '<svg width="' + stripW + '" height="' + stripH + '" viewBox="0 0 ' + stripW + ' ' + stripH + '">';
  data.forEach(function(d, i) {
    var color = famColors[d.fam] || '#22d3ee';
    var h = 10 + (d.rpe / 10) * 30;
    var y = (stripH - h) / 2;
    svg += '<rect x="' + (i * segW) + '" y="' + y.toFixed(1) + '" width="' + (segW - 1) + '" height="' + h.toFixed(1) + '" rx="1" fill="' + color + '" opacity="' + (0.4 + d.rpe / 15) + '"/>';
  });
  svg += '</svg>';
  // Workout archetype
  var dominant = Object.keys(famCounts).sort(function(a,b) { return famCounts[b] - famCounts[a]; })[0];
  var archetypes = {
    Push: 'The Presser',
    Pull: 'The Puller',
    Core: 'The Foundation',
    Legs: 'The Pillar',
    Skills: 'The Virtuoso'
  };
  var archetype = archetypes[dominant] || 'The Mover';
  // Intensity class
  var intensityClass = avgRpe >= 8.5 ? 'Extreme' : avgRpe >= 7.5 ? 'High' : avgRpe >= 6 ? 'Moderate' : 'Light';
  // Complexity
  var complexity = Object.keys(famCounts).length >= 4 ? 'Complex' : Object.keys(famCounts).length >= 2 ? 'Focused' : 'Specialized';
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var workoutName = document.getElementById('workout-name') ? document.getElementById('workout-name').textContent : 'Workout';
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:32px;width:460px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:10px;text-transform:uppercase;letter-spacing:2px;margin-bottom:4px">Workout DNA</div>';
  html += '<div style="color:#e2e8f0;font-size:22px;font-weight:700;margin-bottom:4px">' + workoutName + '</div>';
  html += '<div style="color:#22d3ee;font-size:14px;font-style:italic;margin-bottom:20px">"' + archetype + '"</div>';
  // DNA strip
  html += '<div style="display:flex;justify-content:center;margin-bottom:20px;border-radius:6px;overflow:hidden;background:rgba(34,211,238,0.03);padding:8px">' + svg + '</div>';
  // Stats grid
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px">';
  html += '<div style="padding:10px;background:rgba(34,211,238,0.05);border-radius:8px"><div style="color:#22d3ee;font-size:20px;font-weight:700">' + data.length + '</div><div style="color:#64748b;font-size:10px">Exercises</div></div>';
  html += '<div style="padding:10px;background:rgba(34,211,238,0.05);border-radius:8px"><div style="color:#22d3ee;font-size:20px;font-weight:700">' + totalSets + '</div><div style="color:#64748b;font-size:10px">Total Sets</div></div>';
  html += '<div style="padding:10px;background:rgba(34,211,238,0.05);border-radius:8px"><div style="color:#22d3ee;font-size:20px;font-weight:700">' + avgRpe.toFixed(1) + '</div><div style="color:#64748b;font-size:10px">Avg RPE</div></div>';
  html += '</div>';
  // Tags
  html += '<div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-bottom:16px">';
  html += '<span style="padding:4px 12px;background:rgba(34,211,238,0.1);color:#22d3ee;border-radius:12px;font-size:11px">' + intensityClass + ' Intensity</span>';
  html += '<span style="padding:4px 12px;background:rgba(34,211,238,0.1);color:#22d3ee;border-radius:12px;font-size:11px">' + complexity + '</span>';
  html += '<span style="padding:4px 12px;background:rgba(34,211,238,0.1);color:#22d3ee;border-radius:12px;font-size:11px">' + Object.keys(famCounts).length + ' Families</span>';
  html += '</div>';
  // Family breakdown bar
  html += '<div style="display:flex;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px">';
  Object.keys(famCounts).forEach(function(fam) {
    var pct = famCounts[fam] / data.length * 100;
    html += '<div style="width:' + pct + '%;background:' + (famColors[fam]||'#22d3ee') + '" title="' + fam + ' ' + Math.round(pct) + '%"></div>';
  });
  html += '</div>';
  html += '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">';
  Object.keys(famCounts).forEach(function(fam) {
    html += '<span style="color:' + (famColors[fam]||'#22d3ee') + ';font-size:10px">' + fam + ' ' + Math.round(famCounts[fam]/data.length*100) + '%</span>';
  });
  html += '</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 401: Exercise History Graph
function showExerciseHistoryGraph() {
  var sel = document.querySelector('.clip.selected');
  var targetName = sel ? (sel.dataset.exercise || '') : '';
  if (!targetName) { showToast('Select a clip to see its exercise history'); return; }
  // Collect from saved workouts
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  var usageData = [];
  saved.forEach(function(w) {
    var count = 0;
    var totalSets = 0;
    (w.clips || []).forEach(function(c) {
      if ((c.exercise || c.name) === targetName) { count++; totalSets += parseInt(c.sets) || 3; }
    });
    if (count > 0) usageData.push({ name: w.name || 'Untitled', count: count, sets: totalSets });
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:450px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Exercise History</div>';
  html += '<div style="color:#22d3ee;font-size:14px;margin-bottom:16px">' + targetName + '</div>';
  if (usageData.length === 0) {
    html += '<div style="color:#64748b;font-size:13px;text-align:center;padding:20px">No saved workouts contain this exercise</div>';
  } else {
    var maxSets = Math.max.apply(null, usageData.map(function(d) { return d.sets; }).concat([1]));
    usageData.forEach(function(d) {
      var pct = Math.round(d.sets / maxSets * 100);
      html += '<div style="margin-bottom:8px">';
      html += '<div style="display:flex;justify-content:space-between;margin-bottom:3px">';
      html += '<span style="color:#e2e8f0;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:250px">' + d.name + '</span>';
      html += '<span style="color:#22d3ee;font-size:12px">' + d.count + 'x (' + d.sets + ' sets)</span>';
      html += '</div>';
      html += '<div style="height:6px;background:rgba(34,211,238,0.05);border-radius:3px;overflow:hidden">';
      html += '<div style="height:100%;width:' + pct + '%;background:rgba(34,211,238,0.4);border-radius:3px"></div>';
      html += '</div></div>';
    });
    html += '<div style="color:#64748b;font-size:11px;margin-top:8px">Found in ' + usageData.length + ' saved workout(s)</div>';
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 402: Workout Remix
function remixWorkout() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  clips = clips.filter(function(c) { return !c.closest('.track[data-family="music"]') && !c.classList.contains('clip-locked'); });
  if (clips.length < 2) { showToast('Need 2+ unlocked clips to remix'); return; }
  captureUndo();
  // Collect all exercises by family
  var byFamily = {};
  clips.forEach(function(c) {
    var fam = c.dataset.family || '';
    if (!byFamily[fam]) byFamily[fam] = [];
    byFamily[fam].push(c);
  });
  // For each family, shuffle exercises among clips (keep positions/sets/reps)
  Object.keys(byFamily).forEach(function(fam) {
    var famClips = byFamily[fam];
    if (famClips.length < 2) return;
    // Collect exercise names
    var names = famClips.map(function(c) { return c.dataset.exercise || ''; });
    // Fisher-Yates shuffle names
    for (var i = names.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = names[i]; names[i] = names[j]; names[j] = tmp;
    }
    // Apply shuffled names back
    famClips.forEach(function(c, idx) {
      var newName = names[idx];
      var found = null;
      EXERCISES.forEach(function(e) { if(e.name === newName) found = e; });
      if (found) {
        c.dataset.exercise = found.name;
        c.dataset.pattern = found.pattern || '';
        c.dataset.stage = found.stage || 'S1';
        c.dataset.discipline = found.discipline || '';
        var nameEl = c.querySelector('.clip-name');
        if (nameEl) nameEl.textContent = found.name;
      }
    });
  });
  showToast('Workout remixed! Same structure, shuffled exercises');
  if (typeof logChange === 'function') logChange('remix', clips.length + ' clips');
}

// Batch 403: Progressive Overload Tracker
function showOverloadTracker() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  if (saved.length < 2) { showToast('Save 2+ workouts to track progressive overload'); return; }
  // Calculate volume per workout
  var volumeHistory = saved.slice(-10).map(function(w) {
    var vol = 0;
    var sets = 0;
    var reps = 0;
    (w.clips || []).forEach(function(c) {
      var s = parseInt(c.sets) || 3;
      var r = parseInt(c.reps) || 10;
      sets += s;
      reps += s * r;
      vol += s * r * (parseFloat(c.rpe) || 7) / 10;
    });
    return { name: w.name || 'Untitled', volume: Math.round(vol), sets: sets, reps: reps, clips: (w.clips || []).length };
  });
  var maxVol = Math.max.apply(null, volumeHistory.map(function(v) { return v.volume; }).concat([1]));
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;font-family:Sora,sans-serif';
  overlay.onclick = function(e) { if(e.target===overlay) overlay.remove(); };
  var html = '<div style="background:#0a0f1e;border:1px solid rgba(34,211,238,0.2);border-radius:12px;padding:24px;width:500px;max-height:85vh;overflow-y:auto">';
  html += '<div style="color:#e2e8f0;font-size:16px;font-weight:700;margin-bottom:4px">Progressive Overload Tracker</div>';
  html += '<div style="color:#94a3b8;font-size:12px;margin-bottom:16px">Volume = sets x reps x (RPE/10) across last ' + volumeHistory.length + ' workouts</div>';
  // Volume graph
  var graphH = 100;
  var barW = Math.floor(360 / volumeHistory.length) - 4;
  html += '<div style="display:flex;align-items:flex-end;gap:4px;height:' + graphH + 'px;margin-bottom:16px;padding:0 20px">';
  volumeHistory.forEach(function(v, i) {
    var h = Math.max(4, Math.round(v.volume / maxVol * graphH));
    var isLast = (i === volumeHistory.length - 1);
    var prev = i > 0 ? volumeHistory[i-1].volume : v.volume;
    var color = v.volume >= prev ? '#4ade80' : '#f87171';
    html += '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">';
    html += '<div style="color:#94a3b8;font-size:8px">' + v.volume + '</div>';
    html += '<div style="width:100%;max-width:' + barW + 'px;height:' + h + 'px;background:' + (isLast ? '#22d3ee' : color) + ';border-radius:3px 3px 0 0;opacity:' + (isLast ? 1 : 0.7) + '"></div>';
    html += '</div>';
  });
  html += '</div>';
  // Detail table
  volumeHistory.slice().reverse().forEach(function(v, i) {
    html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(34,211,238,0.05);font-size:12px">';
    html += '<span style="color:#e2e8f0;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + v.name + '</span>';
    html += '<span style="color:#94a3b8">' + v.clips + ' clips | ' + v.sets + ' sets | ' + v.reps + ' reps</span>';
    html += '</div>';
  });
  // Trend
  if (volumeHistory.length >= 2) {
    var first = volumeHistory[0].volume;
    var last = volumeHistory[volumeHistory.length - 1].volume;
    var trend = last - first;
    var pct = first > 0 ? Math.round((trend / first) * 100) : 0;
    html += '<div style="margin-top:16px;padding:12px;background:rgba(34,211,238,0.03);border-radius:8px;display:flex;justify-content:space-between;align-items:center">';
    html += '<span style="color:#94a3b8;font-size:12px">Volume Trend</span>';
    html += '<span style="color:' + (trend >= 0 ? '#4ade80' : '#f87171') + ';font-size:14px;font-weight:600">' + (trend >= 0 ? '+' : '') + pct + '%</span>';
    html += '</div>';
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 404: Workout Snapshot Diff
function showSnapshotDiff() {
  var backups = [];
  try { backups = JSON.parse(localStorage.getItem('sms_auto_backups') || '[]'); } catch(e) {}
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  var sources = [];
  backups.forEach(function(b, i) {
    sources.push({label: 'Backup ' + (i+1) + ' (' + new Date(b.time).toLocaleTimeString() + ')', clips: b.state && b.state.clips ? b.state.clips : []});
  });
  saved.forEach(function(s) {
    sources.push({label: s.name || 'Saved', clips: s.clips || []});
  });
  if (sources.length === 0) { showToast('No snapshots or saved workouts to compare'); return; }
  var currentClips = [];
  document.querySelectorAll('.clip').forEach(function(c) {
    currentClips.push({exercise: c.dataset.exercise || '', family: c.dataset.family || '', sets: c.dataset.sets || '3', reps: c.dataset.reps || '8'});
  });
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  var html = '<div style="background:#0a0e1a;border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:24px;width:90%;max-width:700px;max-height:85vh;overflow-y:auto;color:#e2e8f0;font-family:Sora,sans-serif;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><span style="font-size:18px;font-weight:600;">Snapshot Diff</span><span onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor:pointer;color:#94a3b8;">X</span></div>';
  html += '<div style="margin-bottom:16px;color:#94a3b8;font-size:13px;">Compare current workout against saved states</div>';
  sources.forEach(function(src, idx) {
    var currentNames = currentClips.map(function(c) { return c.exercise; }).sort();
    var snapNames = src.clips.map(function(c) { return c.exercise || c.dataset && c.dataset.exercise || ''; }).sort();
    var added = [];
    var removed = [];
    var cCopy = currentNames.slice();
    var sCopy = snapNames.slice();
    sCopy.forEach(function(n) { var i = cCopy.indexOf(n); if (i > -1) cCopy.splice(i, 1); else removed.push(n); });
    cCopy.forEach(function(n) { added.push(n); });
    var changed = added.length + removed.length;
    html += '<div style="margin-bottom:12px;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;">';
    html += '<div style="font-weight:600;margin-bottom:8px;">' + src.label + ' <span style="color:#94a3b8;font-size:12px;">(' + changed + ' changes)</span></div>';
    if (added.length > 0) html += '<div style="color:#4ade80;font-size:13px;margin-bottom:4px;">+ Added: ' + added.join(', ') + '</div>';
    if (removed.length > 0) html += '<div style="color:#f87171;font-size:13px;margin-bottom:4px;">- Removed: ' + removed.join(', ') + '</div>';
    if (changed === 0) html += '<div style="color:#94a3b8;font-size:13px;">No differences</div>';
    html += '</div>';
  });
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 405: Exercise Rotation Scheduler
function showRotationScheduler() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  var ratings = [];
  try { ratings = JSON.parse(localStorage.getItem('sms_workout_ratings') || '[]'); } catch(e) {}
  var usageMap = {};
  var allExercises = EXERCISES.map(function(e) { return e.name; });
  allExercises.forEach(function(name) { usageMap[name] = {count: 0, lastUsed: null}; });
  saved.forEach(function(s) {
    var dt = s.date || s.timestamp || null;
    (s.clips || []).forEach(function(c) {
      var name = c.exercise || (c.dataset && c.dataset.exercise) || '';
      if (usageMap[name]) {
        usageMap[name].count++;
        if (dt && (!usageMap[name].lastUsed || dt > usageMap[name].lastUsed)) usageMap[name].lastUsed = dt;
      }
    });
  });
  var entries = allExercises.map(function(name) {
    return {name: name, count: usageMap[name].count, lastUsed: usageMap[name].lastUsed, family: (EXERCISES.find(function(e) { return e.name === name; }) || {}).family || ''};
  });
  entries.sort(function(a, b) { return a.count - b.count; });
  var fresh = entries.filter(function(e) { return e.count === 0; });
  var stale = entries.filter(function(e) { return e.count > 0; }).slice(0, 10);
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  var html = '<div style="background:#0a0e1a;border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:24px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto;color:#e2e8f0;font-family:Sora,sans-serif;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><span style="font-size:18px;font-weight:600;">Exercise Rotation</span><span onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor:pointer;color:#94a3b8;">X</span></div>';
  html += '<div style="margin-bottom:16px;color:#94a3b8;font-size:13px;">Keep variety high by rotating underused exercises</div>';
  if (fresh.length > 0) {
    html += '<div style="font-weight:600;color:#4ade80;margin-bottom:8px;">Never Used (' + fresh.length + ')</div>';
    fresh.forEach(function(e) {
      var fColor = getFamilyColor(e.family);
      html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;margin-bottom:4px;background:rgba(6,182,212,0.05);border-radius:6px;">';
      html += '<span style="font-size:13px;">' + e.name + '</span>';
      html += '<span style="font-size:11px;color:' + fColor + ';">' + e.family + '</span>';
      html += '</div>';
    });
  }
  if (stale.length > 0) {
    html += '<div style="font-weight:600;color:#fbbf24;margin-top:12px;margin-bottom:8px;">Least Used (try these next)</div>';
    stale.forEach(function(e) {
      var fColor = getFamilyColor(e.family);
      var ago = e.lastUsed ? Math.floor((Date.now() - new Date(e.lastUsed).getTime()) / 86400000) + 'd ago' : '';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;margin-bottom:4px;background:rgba(6,182,212,0.05);border-radius:6px;">';
      html += '<span style="font-size:13px;">' + e.name + ' <span style="color:#94a3b8;font-size:11px;">(' + e.count + 'x)</span></span>';
      html += '<span style="font-size:11px;color:' + fColor + ';">' + e.family + (ago ? ' ' + ago : '') + '</span>';
      html += '</div>';
    });
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 406: Training Load Calculator (Acute:Chronic Workload Ratio)
function showTrainingLoad() {
  var saved = [];
  try { saved = JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) {}
  var ratings = [];
  try { ratings = JSON.parse(localStorage.getItem('sms_workout_ratings') || '[]'); } catch(e) {}
  var sessions = saved.map(function(s) {
    var totalLoad = 0;
    (s.clips || []).forEach(function(c) {
      var sets = parseInt(c.sets || c.dataset && c.dataset.sets || 3);
      var reps = parseInt(c.reps || c.dataset && c.dataset.reps || 8);
      var rpe = parseFloat(c.rpe || c.dataset && c.dataset.rpe || 7);
      totalLoad += sets * reps * (rpe / 10);
    });
    return {date: s.date || s.timestamp || new Date().toISOString(), load: Math.round(totalLoad)};
  }).sort(function(a, b) { return new Date(a.date) - new Date(b.date); });
  var currentLoad = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var sets = parseInt(c.dataset.sets || 3);
    var reps = parseInt(c.dataset.reps || 8);
    var rpe = parseFloat(c.dataset.rpe || 7);
    currentLoad += sets * reps * (rpe / 10);
  });
  currentLoad = Math.round(currentLoad);
  sessions.push({date: new Date().toISOString(), load: currentLoad});
  var acute = 0;
  var chronic = 0;
  var last7 = sessions.slice(-7);
  var last28 = sessions.slice(-28);
  last7.forEach(function(s) { acute += s.load; });
  last28.forEach(function(s) { chronic += s.load; });
  acute = last7.length > 0 ? Math.round(acute / last7.length) : 0;
  chronic = last28.length > 0 ? Math.round(chronic / last28.length) : 0;
  var ratio = chronic > 0 ? (acute / chronic).toFixed(2) : 'N/A';
  var zone = 'Optimal';
  var zoneColor = '#4ade80';
  if (ratio !== 'N/A') {
    var r = parseFloat(ratio);
    if (r < 0.8) { zone = 'Under-training'; zoneColor = '#94a3b8'; }
    else if (r > 1.5) { zone = 'Danger Zone'; zoneColor = '#f87171'; }
    else if (r > 1.3) { zone = 'High Risk'; zoneColor = '#fbbf24'; }
    else { zone = 'Optimal (Sweet Spot)'; zoneColor = '#4ade80'; }
  }
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  var html = '<div style="background:#0a0e1a;border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:24px;width:90%;max-width:550px;max-height:85vh;overflow-y:auto;color:#e2e8f0;font-family:Sora,sans-serif;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><span style="font-size:18px;font-weight:600;">Training Load</span><span onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor:pointer;color:#94a3b8;">X</span></div>';
  html += '<div style="text-align:center;margin:20px 0;">';
  html += '<div style="font-size:48px;font-weight:700;color:' + zoneColor + ';">' + ratio + '</div>';
  html += '<div style="font-size:14px;color:' + zoneColor + ';margin-top:4px;">' + zone + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8;margin-top:8px;">Acute:Chronic Workload Ratio</div>';
  html += '</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:20px 0;">';
  html += '<div style="text-align:center;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;">';
  html += '<div style="font-size:24px;font-weight:600;color:#06b6d4;">' + currentLoad + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8;">Today</div></div>';
  html += '<div style="text-align:center;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;">';
  html += '<div style="font-size:24px;font-weight:600;color:#22d3ee;">' + acute + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8;">7-Day Avg</div></div>';
  html += '<div style="text-align:center;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;">';
  html += '<div style="font-size:24px;font-weight:600;color:#67e8f9;">' + chronic + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8;">28-Day Avg</div></div>';
  html += '</div>';
  html += '<div style="margin-top:16px;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;font-size:12px;color:#94a3b8;">';
  html += '<div style="font-weight:600;color:#e2e8f0;margin-bottom:8px;">Zones Guide</div>';
  html += '<div style="margin-bottom:4px;"><span style="color:#94a3b8;">Below 0.8</span> Under-training</div>';
  html += '<div style="margin-bottom:4px;"><span style="color:#4ade80;">0.8 - 1.3</span> Optimal (Sweet Spot)</div>';
  html += '<div style="margin-bottom:4px;"><span style="color:#fbbf24;">1.3 - 1.5</span> High Risk</div>';
  html += '<div><span style="color:#f87171;">Above 1.5</span> Danger Zone</div>';
  html += '</div>';
  html += '<div style="margin-top:12px;font-size:12px;color:#64748b;">Based on ' + sessions.length + ' sessions. Load = sets x reps x (RPE/10)</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 407: Workout Streak Challenges
function showStreakChallenges() {
  var challenges = [];
  try { challenges = JSON.parse(localStorage.getItem('sms_streak_challenges') || '[]'); } catch(e) {}
  var ratings = [];
  try { ratings = JSON.parse(localStorage.getItem('sms_workout_ratings') || '[]'); } catch(e) {}
  var workoutDays = {};
  ratings.forEach(function(r) {
    var d = new Date(r.date || r.timestamp).toISOString().split('T')[0];
    workoutDays[d] = true;
  });
  var currentStreak = 0;
  var d = new Date();
  for (var i = 0; i < 365; i++) {
    var key = d.toISOString().split('T')[0];
    if (workoutDays[key]) { currentStreak++; d.setDate(d.getDate() - 1); }
    else break;
  }
  var presets = [
    {name: '7-Day Warrior', target: 7, desc: 'Train 7 days straight'},
    {name: '14-Day Grinder', target: 14, desc: 'Two weeks of consistency'},
    {name: '30-Day Titan', target: 30, desc: 'A full month of training'},
    {name: '100-Day Legend', target: 100, desc: 'Elite consistency level'}
  ];
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  var html = '<div style="background:#0a0e1a;border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:24px;width:90%;max-width:550px;max-height:85vh;overflow-y:auto;color:#e2e8f0;font-family:Sora,sans-serif;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><span style="font-size:18px;font-weight:600;">Streak Challenges</span><span onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor:pointer;color:#94a3b8;">X</span></div>';
  html += '<div style="text-align:center;margin:16px 0;padding:16px;background:rgba(6,182,212,0.08);border-radius:10px;">';
  html += '<div style="font-size:36px;font-weight:700;color:#06b6d4;">' + currentStreak + '</div>';
  html += '<div style="font-size:13px;color:#94a3b8;">Current Streak (days)</div></div>';
  presets.forEach(function(p) {
    var pct = Math.min(100, Math.round((currentStreak / p.target) * 100));
    var done = currentStreak >= p.target;
    html += '<div style="margin-bottom:12px;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
    html += '<span style="font-weight:600;font-size:14px;color:' + (done ? '#4ade80' : '#e2e8f0') + ';">' + (done ? '* ' : '') + p.name + '</span>';
    html += '<span style="font-size:12px;color:#94a3b8;">' + currentStreak + '/' + p.target + '</span></div>';
    html += '<div style="font-size:12px;color:#94a3b8;margin-bottom:6px;">' + p.desc + '</div>';
    html += '<div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;">';
    html += '<div style="height:100%;width:' + pct + '%;background:' + (done ? '#4ade80' : '#06b6d4') + ';border-radius:3px;"></div></div>';
    html += '</div>';
  });
  html += '<div style="margin-top:12px;font-size:12px;color:#64748b;">Streak counts consecutive days with rated workouts</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

// Batch 408: Exercise Cluster Builder
var smsExerciseClusters = [];
try { smsExerciseClusters = JSON.parse(localStorage.getItem('sms_exercise_clusters') || '[]'); } catch(e) {}
function showClusterBuilder() {
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  var html = '<div style="background:#0a0e1a;border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:24px;width:90%;max-width:650px;max-height:85vh;overflow-y:auto;color:#e2e8f0;font-family:Sora,sans-serif;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><span style="font-size:18px;font-weight:600;">Exercise Clusters</span><span onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor:pointer;color:#94a3b8;">X</span></div>';
  html += '<div style="margin-bottom:16px;color:#94a3b8;font-size:13px;">Group exercises by training goal</div>';
  html += '<div style="margin-bottom:16px;">';
  html += '<button onclick="createNewCluster()" style="background:#06b6d4;color:#050711;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-family:Sora,sans-serif;font-size:13px;font-weight:600;">+ New Cluster</button></div>';
  if (smsExerciseClusters.length === 0) {
    html += '<div style="text-align:center;color:#64748b;padding:24px;font-size:13px;">No clusters yet. Create one to group exercises by goal.</div>';
  } else {
    smsExerciseClusters.forEach(function(cl, idx) {
      html += '<div style="margin-bottom:12px;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
      html += '<span style="font-weight:600;font-size:14px;">' + cl.name + ' <span style="color:#94a3b8;font-size:12px;">(' + cl.exercises.length + ' exercises)</span></span>';
      html += '<div><button onclick="applyClusterToTimeline(' + idx + ')" style="background:rgba(6,182,212,0.15);color:#06b6d4;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:4px;">Apply</button>';
      html += '<button onclick="deleteCluster(' + idx + ')" style="background:rgba(248,113,113,0.15);color:#f87171;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;">Del</button></div>';
      html += '</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
      cl.exercises.forEach(function(name) {
        var ex = EXERCISES.find(function(e) { return e.name === name; });
        var fColor = ex ? getFamilyColor(ex.family) : '#94a3b8';
        html += '<span style="font-size:11px;color:' + fColor + ';padding:2px 6px;background:rgba(255,255,255,0.04);border-radius:4px;">' + name + '</span>';
      });
      html += '</div></div>';
    });
  }
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

function createNewCluster() {
  document.querySelectorAll('[style*="z-index:9999"]').forEach(function(el) { el.remove(); });
  showInlinePrompt('Cluster name:', '', function(name) {
    if (!name) return;
    var exNames = [];
    document.querySelectorAll('.clip').forEach(function(c) {
      var n = c.dataset.exercise;
      if (n && exNames.indexOf(n) === -1) exNames.push(n);
    });
    if (exNames.length === 0) { showToast('Add exercises to timeline first'); return; }
    smsExerciseClusters.push({name: name, exercises: exNames, created: new Date().toISOString()});
    if (smsExerciseClusters.length > 30) smsExerciseClusters = smsExerciseClusters.slice(-30);
    try { localStorage.setItem('sms_exercise_clusters', JSON.stringify(smsExerciseClusters)); } catch(e) {}
    showToast('Cluster "' + name + '" saved with ' + exNames.length + ' exercises');
    showClusterBuilder();
  });
}

function applyClusterToTimeline(idx) {
  var cl = smsExerciseClusters[idx];
  if (!cl) return;
  var pos = playheadPos || 0;
  cl.exercises.forEach(function(name) {
    var ex = EXERCISES.find(function(e) { return e.name === name; });
    if (!ex) return;
    var trackId = ex.family.toLowerCase().replace(/\s/g, '-');
    var track = document.querySelector('.track[data-family="' + trackId + '"] .track-clips') || document.querySelector('.track-clips');
    if (!track) return;
    var clip = createClipElement(ex, pos);
    track.appendChild(clip);
    pos += BEAT_WIDTH * 4;
  });
  saveState();
  updateFooterStats();
  showToast('Applied cluster: ' + cl.name);
}

function deleteCluster(idx) {
  smsExerciseClusters.splice(idx, 1);
  try { localStorage.setItem('sms_exercise_clusters', JSON.stringify(smsExerciseClusters)); } catch(e) {}
  showToast('Cluster deleted');
  showClusterBuilder();
}

// Batch 409: Volume Wave Planner (Undulating Periodization)
function showVolumeWavePlanner() {
  var families = ['Push', 'Pull', 'Core', 'Legs', 'Skills'];
  var currentSets = {};
  families.forEach(function(f) { currentSets[f] = 0; });
  document.querySelectorAll('.clip').forEach(function(c) {
    var fam = c.dataset.family || '';
    var sets = parseInt(c.dataset.sets || 3);
    families.forEach(function(f) { if (fam.toLowerCase().indexOf(f.toLowerCase()) > -1) currentSets[f] += sets; });
  });
  var waves = [
    {name: 'Week 1: High Volume', mult: 1.2, color: '#f87171'},
    {name: 'Week 2: Medium Volume', mult: 1.0, color: '#fbbf24'},
    {name: 'Week 3: Low Volume', mult: 0.7, color: '#4ade80'},
    {name: 'Week 4: Deload', mult: 0.5, color: '#94a3b8'},
    {name: 'Week 5: High Volume', mult: 1.2, color: '#f87171'},
    {name: 'Week 6: Medium Volume', mult: 1.0, color: '#fbbf24'}
  ];
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(5,7,17,0.95);display:flex;align-items:center;justify-content:center;';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
  var html = '<div style="background:#0a0e1a;border:1px solid rgba(6,182,212,0.2);border-radius:12px;padding:24px;width:90%;max-width:700px;max-height:85vh;overflow-y:auto;color:#e2e8f0;font-family:Sora,sans-serif;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><span style="font-size:18px;font-weight:600;">Volume Wave Planner</span><span onclick="this.parentElement.parentElement.parentElement.remove()" style="cursor:pointer;color:#94a3b8;">X</span></div>';
  html += '<div style="margin-bottom:16px;color:#94a3b8;font-size:13px;">Undulating periodization based on current workout volume</div>';
  html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:13px;">';
  html += '<tr><th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);color:#94a3b8;">Week</th>';
  families.forEach(function(f) {
    html += '<th style="text-align:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);color:' + getFamilyColor(f) + ';">' + f + '</th>';
  });
  html += '<th style="text-align:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);color:#94a3b8;">Total</th></tr>';
  waves.forEach(function(w) {
    html += '<tr><td style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);color:' + w.color + ';font-weight:600;">' + w.name + '</td>';
    var weekTotal = 0;
    families.forEach(function(f) {
      var val = Math.round(currentSets[f] * w.mult);
      weekTotal += val;
      html += '<td style="text-align:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);">' + val + '</td>';
    });
    html += '<td style="text-align:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);font-weight:600;">' + weekTotal + '</td></tr>';
  });
  html += '</table></div>';
  html += '<div style="margin-top:16px;padding:12px;background:rgba(6,182,212,0.05);border-radius:8px;font-size:12px;color:#94a3b8;">';
  html += '<div style="font-weight:600;color:#e2e8f0;margin-bottom:4px;">How it works</div>';
  html += 'High weeks push +20% volume, medium stays baseline, low drops -30%, deload at -50%. This wave pattern prevents plateaus while managing fatigue.</div>';
  html += '</div>';
  overlay.innerHTML = html;
  document.body.appendChild(overlay);
}

function selectClipsByStage(stage) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex && ex.stage === stage) { c.classList.add('selected'); count++; }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' Stage ' + stage + ' clip' + (count !== 1 ? 's' : '') + ' selected');
}

function selectClipsByFamily(family) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex && ex.family === family) { c.classList.add('selected'); count++; }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' ' + family + ' clip' + (count !== 1 ? 's' : '') + ' selected');
}

function toggleGridLines() {
  var tracks = document.querySelectorAll('.track-content');
  var hidden = tracks[0] && tracks[0].classList.contains('grid-hidden');
  tracks.forEach(function(t) { t.classList.toggle('grid-hidden', !hidden); });
  toast(hidden ? 'Grid lines shown' : 'Grid lines hidden');
}

function showWorkoutStats() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in workout'); return; }
  var exercises = {};
  var families = {};
  var totalSets = 0;
  var totalReps = 0;
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exercises[ex.name] = true;
      families[ex.family] = (families[ex.family] || 0) + 1;
    }
    totalSets += parseInt(c.dataset.sets) || 3;
    totalReps += parseInt(c.dataset.reps) || 8;
  });
  var exCount = Object.keys(exercises).length;
  var famList = Object.keys(families).sort(function(a, b) { return families[b] - families[a]; });
  toast(clips.length + ' clips, ' + exCount + ' exercises, ' + totalSets + ' sets, ' + totalReps + ' reps | ' + famList.join(', '));
}

function autoNameWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var famCounts = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) famCounts[ex.family] = (famCounts[ex.family] || 0) + 1;
  });
  var dominant = '';
  var maxCount = 0;
  Object.keys(famCounts).forEach(function(f) {
    if (famCounts[f] > maxCount) { maxCount = famCounts[f]; dominant = f; }
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var name = dominant + ' ' + mode + ' (' + clips.length + ' exercises)';
  setWorkoutName(name);
  saveSession();
  toast('Named: ' + name);
}

/* ===== CLIP GROUPS — Cmd+G to group, Cmd+Shift+G to ungroup ===== */
var _groupCounter = 0;
function groupSelectedClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length < 2) { toast('Select 2+ clips to group'); return; }
  pushUndo();
  _groupCounter++;
  var groupId = 'g' + _groupCounter;
  sel.forEach(function(c) {
    c.dataset.group = groupId;
    c.style.outline = '1px dashed rgba(59,130,246,0.3)';
  });
  saveSession();
  sfx('click');
  toast(sel.length + ' clips grouped (' + groupId + ')');
}

function ungroupSelectedClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0 && selectedClip) sel = [selectedClip];
  if (sel.length === 0) { toast('Select a grouped clip first'); return; }
  pushUndo();
  var groups = {};
  sel.forEach(function(c) {
    if (c.dataset.group) groups[c.dataset.group] = true;
  });
  Object.keys(groups).forEach(function(gid) {
    document.querySelectorAll('.clip[data-group="'+gid+'"]').forEach(function(c) {
      delete c.dataset.group;
      c.style.outline = '';
    });
  });
  saveSession();
  sfx('click');
  toast('Ungrouped');
}

function getGroupSiblings(clip) {
  if (!clip.dataset.group) return [];
  return Array.from(document.querySelectorAll('.clip[data-group="'+clip.dataset.group+'"]'));
}

function resetSession() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  bpm = 120;
  document.getElementById('bpm-input').value = 120;
  updateBPMMode(); buildRuler();
  updateStats(); updateEmptyState();
  try { localStorage.removeItem('saturno-studio-session'); } catch(e) {}
  sfx('delete');
  toast('Session reset');
}

/* ===== SHORTCUTS OVERLAY ===== */
function toggleShortcuts() {
  var overlay = document.getElementById('shortcuts-overlay');
  overlay.classList.toggle('open');
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'Escape') {
    if (_timerOverlay) { stopWorkoutTimer(); return; }
    var sum = document.getElementById('summary-overlay');
    if (sum.classList.contains('open')) { closeSummary(); return; }
    var so = document.getElementById('shortcuts-overlay');
    if (so.classList.contains('open')) { so.classList.remove('open'); return; }
    // Deselect all clips first, then stop playback
    var hadSelection = document.querySelectorAll('.clip.selected').length > 0;
    if (hadSelection) {
      document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
      if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
      return;
    }
    stopPlayback();
    closeSavedWorkouts();
  }
  if (e.key === '?' || e.code === 'Slash') {
    toggleShortcuts();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyZ') {
    e.preventDefault();
    if (e.shiftKey) { redo(); } else { undo(); }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyS') {
    e.preventDefault();
    saveSession(true);
    sfx('click');
    toast('Session saved');
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyK') {
    e.preventDefault();
    openCmdPalette();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyD') {
    e.preventDefault();
    duplicateTrackClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyG') {
    e.preventDefault();
    ungroupSelectedClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyG') {
    e.preventDefault();
    groupSelectedClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyC') {
    e.preventDefault();
    copyClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyV') {
    e.preventDefault();
    pasteAtPlayhead();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyV') {
    e.preventDefault();
    pasteClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyD') {
    e.preventDefault();
    duplicateClip();
    return;
  }
  if (e.code === 'KeyB' && !e.metaKey && !e.ctrlKey) {
    splitClipAtPlayhead();
  }
  // Arrow keys to nudge selected clip position or resize
  if ((e.code === 'ArrowLeft' || e.code === 'ArrowRight') && selectedClip && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var pps = 80 / 15;
    var beatSec = 60 / bpm;
    if (e.altKey) {
      // Alt+Arrow: resize clip width
      pushUndo();
      var nudgeW = e.shiftKey ? (beatSec * 4 * pps) : (beatSec * pps);
      var curW = parseInt(selectedClip.style.width) || 80;
      if (e.code === 'ArrowLeft') curW = Math.max(20, curW - nudgeW);
      if (e.code === 'ArrowRight') curW = curW + nudgeW;
      selectedClip.style.width = Math.round(curW) + 'px';
      updateFadeOverlay(selectedClip);
    } else {
      // Arrow: nudge position (Shift = bar, plain = beat)
      pushUndo();
      var nudge = e.shiftKey ? (beatSec * 4 * pps) : (beatSec * pps);
      var allSelected = document.querySelectorAll('.clip.selected');
      if (allSelected.length > 1) {
        allSelected.forEach(function(c) {
          if (c.classList.contains('clip-locked')) return;
          var cl = parseInt(c.style.left) || 0;
          if (e.code === 'ArrowLeft') cl = Math.max(0, cl - nudge);
          else cl = cl + nudge;
          c.style.left = Math.round(cl) + 'px';
        });
      } else {
        var curLeft = parseInt(selectedClip.style.left);
        if (e.code === 'ArrowLeft') curLeft = Math.max(0, curLeft - nudge);
        if (e.code === 'ArrowRight') curLeft = curLeft + nudge;
        selectedClip.style.left = Math.round(curLeft) + 'px';
      }
    }
    saveSession(); updateStats();
  }
  // Left/Right without selected clip: scrub playhead
  if ((e.code === 'ArrowLeft' || e.code === 'ArrowRight') && !selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    var scrubSec = e.shiftKey ? (60 / bpm * 4) : (60 / bpm);
    if (e.code === 'ArrowLeft') currentTime = Math.max(0, currentTime - scrubSec);
    else currentTime = currentTime + scrubSec;
    updateTimeDisplay(); updatePlayheadPosition();
  }
  // Up/Down arrow: move clip between tracks
  // Shift+Up/Down: adjust RPE of selected clip
  if ((e.code === 'ArrowUp' || e.code === 'ArrowDown') && selectedClip && e.shiftKey && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    var curRpe = parseInt(selectedClip.dataset.rpe) || 7;
    var newRpe = e.code === 'ArrowUp' ? Math.min(10, curRpe + 1) : Math.max(1, curRpe - 1);
    selectedClip.dataset.rpe = newRpe;
    document.getElementById('insp-rpe').value = newRpe;
    var rpeBEl = selectedClip.querySelector('.clip-rpe-badge');
    if (rpeBEl) rpeBEl.textContent = newRpe;
    updateStats(); saveSession();
    toast('RPE: ' + newRpe);
    return;
  }
  if ((e.code === 'ArrowUp' || e.code === 'ArrowDown') && selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    e.preventDefault();
    var trackIds = ['push','pull','core','legs','skills'];
    var curTrackId = selectedClip.parentElement.dataset.track;
    var idx = trackIds.indexOf(curTrackId);
    if (idx === -1) return;
    var newIdx = e.code === 'ArrowUp' ? idx - 1 : idx + 1;
    if (newIdx < 0 || newIdx >= trackIds.length) return;
    pushUndo();
    var newTrack = document.querySelector('.track-content[data-track="'+trackIds[newIdx]+'"]');
    if (newTrack) {
      selectedClip.parentElement.removeChild(selectedClip);
      newTrack.appendChild(selectedClip);
      saveSession(); updateStats();
      toast('Moved to ' + trackIds[newIdx].charAt(0).toUpperCase() + trackIds[newIdx].slice(1));
    }
  }
  // Alt+Up/Down: duplicate clip to adjacent track
  if ((e.code === 'ArrowUp' || e.code === 'ArrowDown') && selectedClip && e.altKey && !e.metaKey && !e.ctrlKey && !e.shiftKey) {
    e.preventDefault();
    var trackIds = ['push','pull','core','legs','skills'];
    var curTrackId = selectedClip.parentElement.dataset.track;
    var idx = trackIds.indexOf(curTrackId);
    if (idx === -1) return;
    var newIdx = e.code === 'ArrowUp' ? idx - 1 : idx + 1;
    if (newIdx < 0 || newIdx >= trackIds.length) return;
    var ex = getExercise(selectedClip.dataset.exerciseId);
    if (!ex) return;
    pushUndo();
    var destTrack = document.querySelector('.track-content[data-track="'+trackIds[newIdx]+'"]');
    if (destTrack) {
      var dna = {
        sets: selectedClip.dataset.sets, reps: selectedClip.dataset.reps,
        tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
        rpe: selectedClip.dataset.rpe,
        fadeIn: selectedClip.dataset.fadeIn || '0', fadeOut: selectedClip.dataset.fadeOut || '0'
      };
      var dup = createClipElement(ex, parseInt(selectedClip.style.left), parseInt(selectedClip.style.width), dna);
      if (selectedClip.dataset.notes) dup.dataset.notes = selectedClip.dataset.notes;
      if (selectedClip.dataset.customColor) {
        dup.dataset.customColor = selectedClip.dataset.customColor;
        dup.style.background = selectedClip.style.background;
        dup.style.borderTopColor = selectedClip.style.borderTopColor;
      }
      destTrack.appendChild(dup);
      saveSession(); updateStats();
      toast('Duplicated to ' + trackIds[newIdx].charAt(0).toUpperCase() + trackIds[newIdx].slice(1));
    }
    return;
  }
  // [ and ] to nudge sets (Shift+[ ] for reps)
  if ((e.code === 'BracketLeft' || e.code === 'BracketRight') && selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    if (e.shiftKey) {
      var curReps = parseInt(selectedClip.dataset.reps) || 8;
      var newReps = e.code === 'BracketRight' ? Math.min(50, curReps + 1) : Math.max(1, curReps - 1);
      selectedClip.dataset.reps = newReps;
      var repsInput = document.getElementById('insp-reps');
      if (repsInput) repsInput.value = newReps;
      toast('Reps: ' + newReps);
    } else {
      var curSets = parseInt(selectedClip.dataset.sets) || 3;
      var newSets = e.code === 'BracketRight' ? Math.min(20, curSets + 1) : Math.max(1, curSets - 1);
      selectedClip.dataset.sets = newSets;
      var setsInput = document.getElementById('insp-sets');
      if (setsInput) setsInput.value = newSets;
      toast('Sets: ' + newSets);
    }
    updateClipInfo(selectedClip);
    updateStats(); saveSession();
    return;
  }
  // , and . to nudge tempo (Shift+, . for rest)
  if ((e.code === 'Comma' || e.code === 'Period') && selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    if (e.shiftKey) {
      var curRest = parseInt(selectedClip.dataset.rest) || 60;
      var newRest = e.code === 'Period' ? Math.min(300, curRest + 5) : Math.max(0, curRest - 5);
      selectedClip.dataset.rest = newRest;
      var restInput = document.getElementById('insp-rest');
      if (restInput) restInput.value = newRest;
      toast('Rest: ' + newRest + 's');
    } else {
      var curTempo = parseFloat(selectedClip.dataset.tempo) || 3;
      var newTempo = e.code === 'Period' ? Math.min(10, +(curTempo + 0.5).toFixed(1)) : Math.max(0.5, +(curTempo - 0.5).toFixed(1));
      selectedClip.dataset.tempo = newTempo;
      var tempoInput = document.getElementById('insp-tempo');
      if (tempoInput) tempoInput.value = newTempo;
      toast('Tempo: ' + newTempo + 's');
    }
    updateClipInfo(selectedClip);
    updateStats(); saveSession();
    return;
  }
  if (e.code === 'KeyS' && !e.metaKey && !e.ctrlKey) {
    toggleSnap();
  }
  if (e.code === 'KeyJ' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    selectNextClip();
    return;
  }
  if (e.code === 'KeyK' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    selectPrevClip();
    return;
  }
  if (e.code === 'Slash' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    e.preventDefault();
    var libSearch = document.getElementById('lib-search');
    if (libSearch) libSearch.focus();
    return;
  }
  if (e.code === 'KeyC' && !e.metaKey && !e.ctrlKey && !e.altKey && e.shiftKey) {
    var allCollapsed = true;
    document.querySelectorAll('.track').forEach(function(t) { if (!t.classList.contains('track-collapsed') && t.dataset.track !== 'music') allCollapsed = false; });
    document.querySelectorAll('.track').forEach(function(t) { if (t.dataset.track !== 'music') t.classList.toggle('track-collapsed', !allCollapsed); });
    toast(allCollapsed ? 'All tracks expanded' : 'All tracks collapsed');
  }
  if (e.code === 'KeyC' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    var activeTrack = document.querySelector('.track.track-active');
    if (activeTrack) {
      activeTrack.classList.toggle('track-collapsed');
      toast(activeTrack.classList.contains('track-collapsed') ? 'Track collapsed' : 'Track expanded');
    }
  }
  // PageUp/PageDown: stage up/down selected clip exercise
  if ((e.code === 'PageUp' || e.code === 'PageDown') && selectedClip && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var curEx = getExercise(selectedClip.dataset.exerciseId);
    if (curEx) {
      var targetStage = e.code === 'PageUp' ? curEx.stage + 1 : curEx.stage - 1;
      var sibling = EXERCISES.filter(function(ex) { return ex.pattern === curEx.pattern && ex.stage === targetStage; })[0];
      if (sibling) {
        pushUndo();
        swapClipExercise(sibling.id);
        toast('Stage ' + targetStage + ': ' + sibling.name);
      } else {
        toast('No stage ' + targetStage + ' for this pattern');
      }
    }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyL') {
    e.preventDefault();
    if (selectedClip) {
      selectedClip.classList.toggle('clip-locked');
      selectedClip.dataset.locked = selectedClip.classList.contains('clip-locked') ? '1' : '';
      saveSession();
      toast(selectedClip.classList.contains('clip-locked') ? 'Clip locked' : 'Clip unlocked');
    }
    return;
  }
  if (e.code === 'KeyL' && !e.metaKey && !e.ctrlKey) {
    toggleLoop();
  }
  if (e.code === 'KeyM' && !e.metaKey && !e.ctrlKey) {
    addMarker();
  }
  if (e.code === 'KeyR' && !e.metaKey && !e.ctrlKey) {
    toggleRec();
  }
  if (e.code === 'KeyQ' && !e.metaKey && !e.ctrlKey) {
    quantizeClips();
  }
  if (e.code === 'KeyF' && !e.metaKey && !e.ctrlKey) {
    toggleFocusMode();
  }
  if (e.code === 'KeyT' && !e.metaKey && !e.ctrlKey) {
    tapTempo();
  }
  if (e.code === 'KeyN' && !e.metaKey && !e.ctrlKey) {
    if (markers.length === 0) { toast('No markers'); return; }
    var sorted = markers.slice().sort(function(a, b) { return a.time - b.time; });
    if (e.shiftKey) {
      // Previous marker
      var prev = null;
      for (var mi = sorted.length - 1; mi >= 0; mi--) {
        if (sorted[mi].time < currentTime - 0.1) { prev = sorted[mi]; break; }
      }
      if (prev) {
        currentTime = prev.time;
        updateTimeDisplay(); updatePlayheadPosition();
        toast('Marker: ' + prev.label);
      } else { toast('No previous marker'); }
    } else {
      // Next marker
      var next = null;
      for (var mi = 0; mi < sorted.length; mi++) {
        if (sorted[mi].time > currentTime + 0.1) { next = sorted[mi]; break; }
      }
      if (next) {
        currentTime = next.time;
        updateTimeDisplay(); updatePlayheadPosition();
        toast('Marker: ' + next.label);
      } else { toast('No next marker'); }
    }
    return;
  }
  if (e.code === 'Home' && !e.metaKey && !e.ctrlKey) {
    currentTime = 0;
    updateTimeDisplay(); updatePlayheadPosition();
    toast('Start');
    return;
  }
  if (e.code === 'End' && !e.metaKey && !e.ctrlKey) {
    var maxR = 0;
    document.querySelectorAll('.clip').forEach(function(c) {
      var r = (parseInt(c.style.left) + parseInt(c.style.width) - 100) / (80 / 15);
      if (r > maxR) maxR = r;
    });
    currentTime = Math.max(0, maxR);
    updateTimeDisplay(); updatePlayheadPosition();
    toast('End');
    return;
  }
  if (e.code === 'KeyG' && !e.metaKey && !e.ctrlKey) {
    generateRandom();
  }
  if (e.code === 'KeyP' && !e.metaKey && !e.ctrlKey) {
    togglePresets();
  }
  if (e.code === 'Equal' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomIn(); return;
  }
  if (e.code === 'Minus' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomOut(); return;
  }
  if (e.code === 'Digit0' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomLevel = 100; applyZoom(); toast('Zoom reset: 100%'); return;
  }
  if (e.code === 'Digit0' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    currentTime = 0; updateTimeDisplay(); updatePlayheadPosition(); toast('Playhead: 0:00');
    return;
  }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    deleteSelectedClips();
  }
  // Select all clips with Cmd+A
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyA') {
    e.preventDefault();
    var activeTrack = document.querySelector('.track.track-active .track-content');
    if (activeTrack) {
      document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
      activeTrack.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
      if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
      toast('Track clips selected');
    }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyA') {
    e.preventDefault();
    document.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
    if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
    toast('All clips selected');
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyI') {
    e.preventDefault();
    document.querySelectorAll('.clip').forEach(function(c) { c.classList.toggle('selected'); });
    if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
    toast('Selection inverted');
  }
  // Number keys 1-6 to select track (or record clip in rec mode)
  if (e.key >= '1' && e.key <= '6' && !e.metaKey && !e.ctrlKey && !e.altKey) {
    var trackIds = ['music','push','pull','core','legs','skills'];
    var idx = parseInt(e.key) - 1;
    if (idx < trackIds.length) {
      // Record mode: drop clip at playhead on numbered track
      if (isRecording && idx > 0) {
        var recTrack = document.querySelector('.track-content[data-track="'+trackIds[idx]+'"]');
        var recTrackDef = TRACKS.find(function(t) { return t.id === trackIds[idx]; });
        if (recTrack && recTrackDef) {
          var recEx = null;
          var recentForTrack = recentExercises.filter(function(rid) {
            var re = getExercise(rid);
            return re && re.family === recTrackDef.family;
          });
          if (recentForTrack.length > 0) {
            recEx = getExercise(recentForTrack[0]);
          } else {
            var recExercises = EXERCISES.filter(function(ex) { return ex.family === recTrackDef.family; });
            if (recExercises.length > 0) recEx = recExercises[Math.floor(Math.random() * recExercises.length)];
          }
          if (recEx) {
            var pps = 80 / 15;
            var recLeft = currentTime * pps;
            addClip(recTrack, recEx, recLeft);
            sfx('click');
          }
        }
      } else {
        document.querySelectorAll('.track.track-active').forEach(function(t) { t.classList.remove('track-active'); });
        var target = document.querySelector('.track[data-track="'+trackIds[idx]+'"]');
        if (target) {
          target.classList.add('track-active');
          toast('Track: ' + trackIds[idx].charAt(0).toUpperCase() + trackIds[idx].slice(1));
        }
      }
    }
  }
  // Tab to cycle through clips (sorted by track then left position)
  if (e.code === 'Tab' && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var trackOrder = ['push','pull','core','legs','skills'];
    var allClips = Array.from(document.querySelectorAll('.clip'));
    if (allClips.length === 0) return;
    allClips.sort(function(a, b) {
      var aT = trackOrder.indexOf(a.parentElement.dataset.track);
      var bT = trackOrder.indexOf(b.parentElement.dataset.track);
      if (aT !== bT) return aT - bT;
      return (parseInt(a.style.left) || 0) - (parseInt(b.style.left) || 0);
    });
    var currentIdx = selectedClip ? allClips.indexOf(selectedClip) : -1;
    var nextIdx = e.shiftKey ? (currentIdx - 1 + allClips.length) % allClips.length : (currentIdx + 1) % allClips.length;
    selectClipEl(allClips[nextIdx]);
    sfx('click');
  }
});

/* Autosave every 30 seconds */
setInterval(function() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length > 0) saveSession();
}, 30000);

/* Footer shortcut hints rotation — like Ableton's status bar tips */
var HINT_LIST = [
  'Space = Play/Stop',
  'Cmd+K = Command Palette',
  'R = Toggle Record',
  'S = Toggle Snap',
  'T = Tap Tempo',
  'F = Focus Mode',
  'L = Loop Region',
  '1-6 = Select Track',
  'Tab = Next Clip',
  'Cmd+Z = Undo',
  'Cmd+S = Quick Save',
  'Cmd+E = Export',
  'Drag exercises from the library',
  '? = Keyboard Shortcuts',
  'M = Toggle Metronome',
  'G = Generate Random',
  'P = Load Preset',
  'Scroll wheel = Zoom timeline',
  'Backspace = Delete selected',
  'Cmd+A = Select all clips'
];
var hintIndex = 0;
var _hintOrder = [];
function shuffleHints() {
  _hintOrder = [];
  for (var i = 0; i < HINT_LIST.length; i++) _hintOrder.push(i);
  for (var j = _hintOrder.length - 1; j > 0; j--) {
    var k = Math.floor(Math.random() * (j + 1));
    var tmp = _hintOrder[j]; _hintOrder[j] = _hintOrder[k]; _hintOrder[k] = tmp;
  }
  hintIndex = 0;
}
shuffleHints();
function rotateHint() {
  var el = document.getElementById('footer-hint');
  if (!el) return;
  el.classList.add('fade');
  setTimeout(function() {
    hintIndex++;
    if (hintIndex >= _hintOrder.length) shuffleHints();
    el.textContent = HINT_LIST[_hintOrder[hintIndex]];
    el.classList.remove('fade');
  }, 300);
}
setInterval(rotateHint, 8000);

/* Selection badge — show count when multiple clips selected */
function updateSelectionBadge() {
  var count = document.querySelectorAll('.clip.selected').length;
  var badge = document.getElementById('selection-badge');
  if (badge) {
    if (count > 1) {
      var cntEl = document.getElementById('sel-count');
      var lblEl = document.getElementById('sel-label');
      if (cntEl) cntEl.textContent = count;
      if (lblEl) lblEl.textContent = 'clips';
      badge.classList.add('show');
    } else {
      badge.classList.remove('show');
    }
  }
  var footerSel = document.getElementById('footer-selection');
  if (footerSel) footerSel.textContent = count > 0 ? count + ' sel' : '';
}

/* Mixer section collapse toggle */
function toggleMixerSection(btn) {
  var body = btn.parentElement.querySelector('.mixer-section-body');
  if (!body) return;
  btn.classList.toggle('collapsed');
  body.classList.toggle('hidden');
  sfx('click');
}

/* Auto-scroll toggle — unified: syncs FOLLOW button + settings panel */
var SPEED_STEPS = [0.5, 0.75, 1, 1.25, 1.5, 2];
function cyclePlaybackSpeed() {
  var idx = SPEED_STEPS.indexOf(playbackSpeed);
  idx = (idx + 1) % SPEED_STEPS.length;
  playbackSpeed = SPEED_STEPS[idx];
  var btn = document.getElementById('speed-btn');
  if (btn) btn.textContent = playbackSpeed + 'x';
  if (btn) btn.classList.toggle('active', playbackSpeed !== 1);
  toast('Speed: ' + playbackSpeed + 'x');
}

function toggleAutoScrollFromTransport() {
  autoScrollEnabled = !autoScrollEnabled;
  syncAutoScrollUI();
  toast('Auto-scroll: ' + (autoScrollEnabled ? 'On' : 'Off'));
  sfx('click');
}
function syncAutoScrollUI() {
  var btn = document.getElementById('auto-scroll-btn');
  var stg = document.getElementById('settings-autoscroll');
  if (btn) btn.classList.toggle('active', autoScrollEnabled);
  if (stg) stg.textContent = autoScrollEnabled ? 'ON' : 'OFF';
}
document.addEventListener('DOMContentLoaded', function() {
  syncAutoScrollUI();
});

/* Panel resize — drag left panel border to resize */
document.addEventListener('DOMContentLoaded', function() {
  var handle = document.getElementById('panel-resize-left');
  var panel = document.querySelector('.panel-left');
  if (!handle || !panel) return;
  handle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    handle.classList.add('dragging');
    var startX = e.clientX;
    var startW = panel.offsetWidth;
    function onMove(ev) {
      var newW = Math.max(140, Math.min(400, startW + (ev.clientX - startX)));
      panel.style.width = newW + 'px';
      document.querySelector('.main').style.gridTemplateColumns = newW + 'px 3px 1fr 280px';
    }
    function onUp() {
      handle.classList.remove('dragging');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
});

/* Session elapsed timer — shows how long studio has been open */
var sessionStartTime = Date.now();
setInterval(function() {
  var elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
  var h = Math.floor(elapsed / 3600);
  var m = Math.floor((elapsed % 3600) / 60);
  var s = elapsed % 60;
  var el = document.getElementById('session-timer');
  if (el) {
    el.textContent = h > 0
      ? h + ':' + m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0')
      : m + ':' + s.toString().padStart(2,'0');
  }
}, 1000);

/* Recently used exercises — track last 5 exercises dropped on timeline */
var recentExercises = [];
function addToRecent(exerciseId) {
  recentExercises = recentExercises.filter(function(id) { return id !== exerciseId; });
  recentExercises.unshift(exerciseId);
  if (recentExercises.length > 8) recentExercises.pop();
  updateRecentSection();
}
function updateRecentSection() {
  var container = document.getElementById('recent-exercises');
  if (!container) return;
  if (recentExercises.length === 0) {
    container.parentElement.style.display = 'none';
    return;
  }
  container.parentElement.style.display = '';
  var html = '';
  recentExercises.forEach(function(id) {
    var ex = getExercise(id);
    if (!ex) return;
    var fm = FAMILY_MAP[ex.family] || {color:'#666'};
    html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" style="border-left-color:'+fm.color+'40">';
    html += '<div class="mv-icon" style="background:'+fm.color+'22;color:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
    html += '<span style="font-size:9px;color:var(--text-secondary)">'+ex.name+'</span>';
    html += '</div>';
  });
  container.innerHTML = html;
  // Re-init drag events on recent items
  container.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      if (!ex) return;
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.4';
      sfx('click');
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
}
</script>
</body>
</html>
