<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<title>SATURNO MOVEMENT STUDIO - The Ableton of Movement</title>
<meta name="description" content="The Ableton of Movement. DAW-style workout composition with drag-drop exercises, BPM training modes, and music sync.">
<meta property="og:title" content="Saturno Movement Studio">
<meta property="og:description" content="The Ableton of Movement. Compose workouts like music.">
<meta property="og:type" content="website">
<link rel="icon" href="assets/planet-logo.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* SATURNO FORGE DESIGN LOCK V2.0 — Premiere Pro x CapCut x Logic Pro */
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #050711;
  --bg-deep: #030509;
  --surface: #0a0e1a;
  --surface2: #0d1117;
  --surface3: #111827;
  --border: #1e293b;
  --border-hover: #475569;
  --border-active: #3b82f6;
  --text: #e2e8f0;
  --text-bright: #ffffff;
  --text-secondary: #8b94a5;
  --muted: #64748b;
  --micro: #475569;
  --accent: #d97706;
  --accent-dim: rgba(217, 119, 6, 0.15);
  --blue: #3b82f6;
  --purple: #8b5cf6;
  --success: #22c55e;
  --error: #ef4444;
  --accent-cyan: #06b6d4;
  --accent-blue: #3b82f6;
  --accent-purple: #8b5cf6;
  --accent-green: #22c55e;
  --accent-orange: #f97316;
  --accent-red: #ef4444;
  --accent-pink: #ec4899;
  --gradient-titan: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #6d28d9 100%);
  --gradient-header: linear-gradient(180deg, #0f1219 0%, #0a0e1a 100%);
  --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-purple: 0 0 20px rgba(139, 92, 246, 0.3);
  --glow-subtle: 0 0 1px rgba(59, 130, 246, 0.15);
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
}

/* Layout */
.app { display: grid; grid-template-rows: 40px 1fr 24px; height: 100vh; }

/* ===== HEADER — Premiere Pro Toolbar ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  height: 40px;
  border-bottom: 1px solid var(--border);
  background: var(--gradient-header);
}
.logo { display: flex; align-items: center; gap: 8px; }
.logo-icon {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
}
.logo-icon img { width: 16px; height: 16px; filter: brightness(0) invert(1); opacity: 0.8; }
.logo-text {
  font-size: 11px; font-weight: 700;
  letter-spacing: 0.08em; color: var(--text);
}
.logo-sub {
  font-size: 8px; color: var(--micro); margin-top: 0;
  text-transform: uppercase; letter-spacing: 0.15em;
}
.header-nav { display: flex; gap: 1px; align-items: center; }
.nav-btn {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 5px 10px; font-size: 9px; font-family: 'Sora', sans-serif;
  background: transparent; border: 1px solid transparent;
  color: var(--muted); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.15s, background 0.15s;
  height: 26px;
}
.nav-btn:hover { background: rgba(255,255,255,0.04); color: var(--text); }
.nav-btn.active {
  background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3);
  color: var(--blue); font-weight: 600;
}
.header-nav .nav-sep {
  width: 1px; height: 16px; background: var(--border); margin: 0 4px;
}

/* ===== MAIN 3-PANEL ===== */
.main { display: grid; grid-template-columns: 220px 1fr 280px; overflow: hidden; }

/* ===== LEFT PANEL: MOVEMENT LIBRARY ===== */
.panel-left {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
}
.panel-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro);
  display: flex; justify-content: space-between; align-items: center;
  height: 32px;
  background: var(--surface);
}
.panel-header span:last-child {
  font-size: 8px; color: var(--micro);
  background: var(--bg-deep); padding: 1px 5px;
  border-radius: 2px;
}
.lib-search {
  width: calc(100% - 16px); margin: 6px 8px;
  padding: 5px 8px; font-size: 10px; font-family: 'Sora', sans-serif;
  background: var(--bg-deep); border: 1px solid var(--border); color: var(--text);
  transition: border-color 0.15s;
  border-radius: 2px;
}
.lib-search:focus { outline: none; border-color: var(--border-active); }
.lib-search::placeholder { color: var(--micro); }
.movement-category { border-bottom: 1px solid rgba(30,41,59,0.4); }
.category-header {
  padding: 7px 12px; font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s;
}
.category-header:hover { background: rgba(255,255,255,0.02); }
.category-header .arrow { font-size: 7px; transition: transform 0.15s; color: var(--micro); }
.category-header.collapsed .arrow { transform: rotate(-90deg); }
.category-color { width: 6px; height: 6px; border-radius: 1px; }
.movement-list { padding: 2px 6px 6px; }
.movement-list.hidden { display: none; }
.movement-item {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 8px; margin-bottom: 1px;
  font-size: 10px;
  background: transparent;
  border: none;
  border-left: 2px solid transparent;
  cursor: grab;
  transition: background 0.1s, border-color 0.1s;
  border-radius: 2px;
}
.movement-item:hover {
  background: rgba(255,255,255,0.03);
  border-left-color: var(--muted);
}
.movement-item:active { cursor: grabbing; background: rgba(59,130,246,0.08); }
.movement-item .mv-icon {
  width: 18px; height: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; flex-shrink: 0;
  border-radius: 2px;
}
.movement-item .mv-stage {
  font-size: 7px; color: var(--micro); margin-left: auto;
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* ===== CENTER PANEL ===== */
.panel-center { display: flex; flex-direction: column; overflow: hidden; }

/* Transport Bar — Logic Pro Style */
.transport {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 12px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  height: 44px;
}
.transport-buttons { display: flex; gap: 1px; }
.transport-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-deep); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 12px;
  font-family: 'Sora', sans-serif;
  transition: color 0.1s, background 0.1s, border-color 0.1s;
}
.transport-btn:first-child { border-radius: 3px 0 0 3px; }
.transport-btn:last-child { border-radius: 0 3px 3px 0; }
.transport-btn + .transport-btn { border-left: none; }
.transport-btn:hover { color: var(--text); background: var(--surface3); }
.transport-btn.active { background: var(--blue); border-color: var(--blue); color: #fff; }
.transport-btn.rec.active { background: var(--accent-red); border-color: var(--accent-red); color: #fff; }
.transport-sep { width: 1px; height: 20px; background: var(--border); margin: 0 6px; }
.time-display {
  font-family: 'Sora', sans-serif;
  font-size: 20px; font-weight: 700;
  color: var(--accent-green); padding: 0 12px;
  letter-spacing: 0.02em;
  font-variant-numeric: tabular-nums;
  min-width: 130px;
  text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
}
.bpm-section { display: flex; align-items: center; gap: 4px; margin-left: auto; }
.bpm-label {
  font-size: 8px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.bpm-input {
  width: 48px; padding: 4px 6px; text-align: center;
  font-size: 13px; font-weight: 600; font-family: 'Sora', sans-serif;
  background: var(--bg-deep); border: 1px solid var(--border); color: var(--accent-orange);
  transition: border-color 0.15s;
}
.bpm-input:focus { outline: none; border-color: var(--accent-orange); }
.bpm-mode {
  font-size: 8px; padding: 3px 8px;
  background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.2);
  color: var(--blue);
  text-transform: uppercase; letter-spacing: 0.1em;
  font-family: 'Sora', sans-serif;
}
.tempo-link {
  font-size: 8px; color: var(--muted); cursor: pointer;
  padding: 3px 6px; border: 1px solid transparent;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
}
.tempo-link:hover { color: var(--accent-orange); border-color: rgba(249,115,22,0.3); }
.tempo-link.active { background: rgba(249,115,22,0.15); border-color: var(--accent-orange); color: var(--accent-orange); }

/* Video Section — Premiere Pro Source Monitor */
.video-section {
  background: var(--bg-deep);
  border-bottom: 1px solid var(--border);
  position: relative; min-height: 0; flex-shrink: 1; overflow: hidden;
}
.video-section.collapsed { height: 0; min-height: 0; border: none; }
.video-placeholder {
  display: flex; align-items: center; justify-content: center;
  height: 100%; min-height: 120px;
  color: var(--micro); font-size: 9px;
  flex-direction: column; gap: 6px;
  text-transform: uppercase; letter-spacing: 0.1em;
  border: 1px dashed rgba(30,41,59,0.5);
  margin: 6px;
  border-radius: 2px;
}
.video-placeholder .vp-icon { font-size: 20px; opacity: 0.2; }
.video-toggle {
  position: absolute; top: 4px; right: 4px;
  width: 18px; height: 18px;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer; font-size: 9px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.video-toggle:hover { color: var(--text); }

/* Timeline — Logic Pro Grid */
.timeline-container { flex: 1; overflow: auto; background: var(--bg-deep); }
.timeline-ruler {
  height: 22px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; position: sticky; top: 0; z-index: 10;
}
.ruler-mark {
  flex: 0 0 80px;
  border-right: 1px solid rgba(30,41,59,0.5);
  padding: 3px 8px; font-size: 9px;
  color: var(--micro);
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.05em;
}
.ruler-mark:first-child { flex: 0 0 100px; }
.ruler-mark:nth-child(4n+1) { color: var(--muted); }
.timeline-tracks { min-height: 200px; position: relative; }
.track {
  height: 60px;
  border-bottom: 1px solid rgba(30,41,59,0.4);
  display: flex;
  background: var(--bg-deep);
  transition: background 0.1s;
}
.track:hover { background: rgba(10,14,26,0.8); }
.track:nth-child(even) { background: rgba(10,14,26,0.3); }
.track:nth-child(even):hover { background: rgba(10,14,26,0.6); }
.track-header {
  width: 100px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 6px 8px;
  display: flex; flex-direction: column; justify-content: center;
  flex-shrink: 0;
  position: relative;
}
.track-header::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px;
}
.track[data-track="music"] .track-header::before { background: var(--accent-cyan); }
.track[data-track="push"] .track-header::before { background: var(--accent-blue); }
.track[data-track="pull"] .track-header::before { background: var(--accent-purple); }
.track[data-track="core"] .track-header::before { background: var(--accent-orange); }
.track[data-track="legs"] .track-header::before { background: var(--accent-green); }
.track[data-track="skills"] .track-header::before { background: var(--accent-cyan); }
.track-name {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-info {
  font-size: 7px; color: var(--micro); margin-top: 1px;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-controls { display: flex; gap: 1px; margin-top: 4px; padding-left: 6px; }
.track-btn {
  width: 18px; height: 14px; font-size: 7px; font-weight: 700;
  background: var(--bg-deep); border: 1px solid var(--border);
  color: var(--micro); cursor: pointer; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s, background 0.1s;
}
.track-btn:hover { color: var(--text); background: var(--surface2); }
.track-btn.muted { background: var(--accent-orange); color: var(--bg); border-color: var(--accent-orange); }
.track-btn.soloed { background: var(--accent-cyan); color: var(--bg); border-color: var(--accent-cyan); }
.track-content {
  flex: 1; position: relative; min-width: 800px;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(30,41,59,0.15) 19px, rgba(30,41,59,0.15) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(30,41,59,0.4) 79px, rgba(30,41,59,0.4) 80px);
}
.track-content.drag-over {
  background:
    linear-gradient(90deg, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(30,41,59,0.15) 19px, rgba(30,41,59,0.15) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(30,41,59,0.4) 79px, rgba(30,41,59,0.4) 80px);
}
.track-clip-count {
  font-size: 7px; color: var(--micro);
  background: var(--bg-deep);
  padding: 0 4px; border-radius: 2px;
  margin-top: 2px; display: inline-block;
  padding-left: 6px;
}

/* Clips — Logic Pro Audio Region Style */
.clip {
  position: absolute; height: 44px; top: 8px;
  border: 1px solid rgba(255,255,255,0.06);
  border-top: 2px solid;
  border-radius: 3px;
  cursor: move; display: flex; align-items: flex-start;
  padding: 3px 8px 0; font-size: 9px; font-weight: 600;
  user-select: none; overflow: hidden; white-space: nowrap;
  transition: box-shadow 0.1s;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.clip::after {
  content: '';
  position: absolute; bottom: 3px; left: 6px; right: 6px;
  height: 18px;
  background: repeating-linear-gradient(
    90deg,
    currentColor 0px, currentColor 1px,
    transparent 1px, transparent 3px
  );
  opacity: 0.08;
  mask-image: linear-gradient(0deg, transparent 0%, rgba(0,0,0,0.6) 30%, rgba(0,0,0,0.3) 60%, transparent 100%);
  -webkit-mask-image: linear-gradient(0deg, transparent 0%, rgba(0,0,0,0.6) 30%, rgba(0,0,0,0.3) 60%, transparent 100%);
}
.clip canvas.clip-waveform {
  position: absolute; bottom: 2px; left: 4px; right: 4px;
  height: 20px; width: calc(100% - 8px);
  pointer-events: none;
}
.clip:hover {
  box-shadow: 0 0 0 1px rgba(255,255,255,0.15), var(--glow-subtle);
  border-color: rgba(255,255,255,0.15);
}
.clip.selected {
  border-color: var(--text-bright);
  box-shadow: 0 0 0 1px var(--text-bright), 0 0 12px rgba(255,255,255,0.1);
}
.clip .clip-info {
  font-size: 7px; opacity: 0.5; margin-left: 4px;
  text-transform: uppercase; letter-spacing: 0.05em;
  font-weight: 400;
}
.clip-resize {
  position: absolute; right: 0; top: 0; bottom: 0;
  width: 5px; cursor: ew-resize;
  background: transparent;
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize { opacity: 1; background: rgba(255,255,255,0.15); }
.clip-resize:hover { background: rgba(255,255,255,0.3) !important; }
.playhead {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: var(--text-bright);
  box-shadow: 0 0 8px rgba(255,255,255,0.4);
  z-index: 20; pointer-events: none; left: 100px;
}
.playhead::before {
  content: '';
  position: absolute; top: -2px; left: -4px;
  width: 9px; height: 8px;
  background: var(--text-bright);
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}

/* ===== RIGHT PANEL: MIXER + INSPECTOR ===== */
.panel-right {
  background: var(--surface);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
}
.mixer-section {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
}
.mixer-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro); margin-bottom: 10px;
}

/* Faders — Channel Strip Style */
.fader-group { display: flex; gap: 10px; justify-content: center; }
.fader { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.fader-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--micro);
  text-align: center; max-width: 40px;
}
.fader-track {
  width: 6px; height: 80px;
  background: var(--bg-deep); border: 1px solid rgba(30,41,59,0.6);
  position: relative; cursor: pointer;
  border-radius: 3px;
}
.fader-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--gradient-titan);
  transition: height 0.1s;
  border-radius: 0 0 3px 3px;
}
.fader-handle {
  position: absolute; left: -5px; right: -5px;
  height: 12px;
  background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
  border: 1px solid var(--micro);
  border-radius: 2px;
  cursor: grab;
  transition: background 0.1s, border-color 0.1s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.fader-handle:hover { background: linear-gradient(180deg, #64748b 0%, #475569 100%); border-color: var(--text-secondary); }
.fader-value {
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--muted); font-weight: 500;
  font-variant-numeric: tabular-nums;
}

/* Knobs — Pro Tools Style */
.knob-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.knob { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.knob-dial {
  width: 34px; height: 34px;
  background: conic-gradient(
    from 225deg,
    var(--blue) 0deg,
    var(--accent-purple) calc(var(--knob-value, 0.5) * 270deg),
    rgba(30,41,59,0.3) calc(var(--knob-value, 0.5) * 270deg),
    rgba(30,41,59,0.3) 270deg
  );
  border: 1px solid rgba(30,41,59,0.6);
  border-radius: 50%; position: relative; cursor: pointer;
  transition: border-color 0.15s;
}
.knob-dial:hover { border-color: rgba(59,130,246,0.4); }
.knob-dial::before {
  content: '';
  position: absolute; top: 50%; left: 50%;
  width: 22px; height: 22px;
  background: radial-gradient(circle, var(--surface3) 0%, var(--bg-deep) 100%);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  border: 1px solid rgba(30,41,59,0.4);
}
.knob-indicator {
  position: absolute; width: 2px; height: 9px;
  background: var(--text); top: 3px; left: 50%;
  transform-origin: bottom center; transform: translateX(-50%);
  border-radius: 1px;
}
.knob-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--micro); text-align: center;
}
.knob-value {
  font-size: 8px; color: var(--muted);
  font-variant-numeric: tabular-nums;
}

/* Meters — VU Meter Style */
.meter-group {
  display: flex; gap: 1px; justify-content: center;
  height: 50px; align-items: flex-end;
  background: var(--bg-deep);
  border: 1px solid rgba(30,41,59,0.4);
  border-radius: 2px;
  padding: 3px;
}
.meter-bar {
  width: 3px; background: var(--accent-green);
  transition: height 0.08s;
  border-radius: 1px 1px 0 0;
}

/* Inspector — Properties Panel */
.inspector-section {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--blue);
}
.inspector-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--blue); margin-bottom: 8px;
}
.inspector-field { margin-bottom: 6px; }
.inspector-field label {
  display: block; font-size: 8px;
  color: var(--micro); text-transform: uppercase;
  letter-spacing: 0.15em; margin-bottom: 3px;
}
.inspector-field .value { font-size: 11px; color: var(--text); }
.inspector-field input, .inspector-field select {
  width: 100%; padding: 4px 6px;
  font-size: 11px; font-family: 'Sora', sans-serif;
  background: var(--bg-deep); border: 1px solid var(--border); color: var(--text);
  transition: border-color 0.15s;
}
.inspector-field input:focus, .inspector-field select:focus {
  outline: none; border-color: var(--border-active);
}
.inspector-tags { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 6px; }
.inspector-tag {
  font-size: 8px; padding: 2px 6px;
  background: rgba(30,41,59,0.3); border: 1px solid rgba(30,41,59,0.5);
  color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 0.08em;
  border-radius: 2px;
}

/* Music Player — Minimal Waveform Style */
.music-section {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--accent-green);
}
.music-now-playing {
  font-size: 10px; color: var(--text-secondary);
  margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
}
.music-now-playing .eq { display: flex; gap: 1px; align-items: flex-end; height: 10px; }
.music-now-playing .eq span { width: 2px; background: var(--accent-green); animation: eqBounce 0.8s ease-in-out infinite alternate; }
.music-now-playing .eq span:nth-child(2) { animation-delay: 0.2s; }
.music-now-playing .eq span:nth-child(3) { animation-delay: 0.4s; }
@keyframes eqBounce { 0% { height: 2px; } 100% { height: 10px; } }
.music-controls { display: flex; gap: 2px; align-items: center; }
.music-btn {
  width: 26px; height: 26px;
  background: var(--bg-deep); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Sora', sans-serif;
  transition: color 0.1s, background 0.1s;
}
.music-btn:hover { color: var(--text); background: var(--surface2); }
.music-btn.playing { background: var(--accent-green); color: var(--bg); border-color: var(--accent-green); }
.music-volume {
  width: 60px; height: 2px; margin-left: 4px;
  -webkit-appearance: none; appearance: none;
  background: var(--border); outline: none; cursor: pointer;
}
.music-volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 8px; height: 8px;
  background: var(--accent-green); border-radius: 50%; cursor: pointer;
}

/* Export Button */
.export-btn {
  padding: 6px 12px;
  background: var(--bg-deep); border: 1px solid var(--border);
  color: var(--text-secondary); font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  cursor: pointer; width: 100%;
  transition: color 0.1s, border-color 0.1s, background 0.1s;
}
.export-btn:hover { color: var(--text); border-color: var(--border-hover); background: var(--surface3); }

/* ===== FOOTER — Status Bar ===== */
.footer {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 0 16px;
  display: flex; align-items: center; justify-content: space-between;
  font-size: 9px; color: var(--micro);
  letter-spacing: 0.03em;
  height: 24px;
}
.status-item { display: flex; align-items: center; gap: 4px; }
.status-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--accent-green); }
.footer-quote { font-style: italic; opacity: 0.3; letter-spacing: 0.05em; font-size: 8px; }

/* ===== TOAST — Notification ===== */
.toast {
  position: fixed; bottom: 36px; right: 16px;
  background: var(--surface2); border: 1px solid var(--border);
  border-left: 2px solid var(--blue);
  color: var(--text-secondary); padding: 8px 14px;
  font-size: 10px; z-index: 200;
  text-transform: uppercase; letter-spacing: 0.08em;
  opacity: 0; transition: opacity 0.2s;
  pointer-events: none; font-family: 'Sora', sans-serif;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  border-radius: 2px;
}
.toast.show { opacity: 1; }
@media(prefers-reduced-motion:reduce) {
  .music-now-playing .eq span { animation: none; height: 6px; }
  .preset-card:hover { transform: none; }
}

/* ===== TABLET (768px) ===== */
@media(max-width:768px) {
  .app { grid-template-rows: 36px 1fr 22px; }
  .main { grid-template-columns: 160px 1fr 220px; }
  .header { padding: 0 10px; }
  .logo-text { font-size: 10px; }
  .nav-btn { padding: 4px 8px; font-size: 8px; }
  .nav-sep { display: none; }
  .transport { padding: 4px 10px; height: 40px; }
  .time-display { font-size: 16px; min-width: 100px; }
  .bpm-input { width: 44px; font-size: 12px; }
  .fader-track { height: 60px; }
  .knob-dial { width: 28px; height: 28px; }
  .knob-indicator { height: 7px; }
  .preset-card { min-width: 130px; padding: 8px; }
}

/* ===== MOBILE (480px) ===== */
@media(max-width:480px) {
  .app { grid-template-rows: 36px 1fr 20px; }
  .main { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .panel-left { max-height: 180px; border-right: none; border-bottom: 1px solid var(--border); }
  .panel-right { border-left: none; border-top: 1px solid var(--border); max-height: 240px; }
  .header { padding: 0 8px; }
  .header-nav { gap: 0; overflow-x: auto; }
  .nav-btn { padding: 4px 6px; font-size: 7px; min-height: 32px; white-space: nowrap; }
  .nav-sep { display: none; }
  .logo-text { font-size: 9px; }
  .logo-sub { display: none; }
  .transport { height: auto; padding: 4px 8px; flex-wrap: wrap; }
  .transport-btn { width: 34px; height: 34px; font-size: 13px; min-height: 40px; }
  .music-btn { width: 32px; height: 32px; min-height: 40px; }
  .track-header { width: 70px; padding: 4px 6px; }
  .track-name { font-size: 8px; padding-left: 4px; }
  .track-info { display: none; }
  .fader-group { gap: 6px; }
  .fader-track { height: 50px; }
  .preset-card { min-width: 120px; padding: 8px; }
  .presets-drawer { padding: 8px 10px; }
  .shortcuts-panel { width: 280px; }
}

/* ===== SAVED WORKOUTS MODAL ===== */
.saved-modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(3, 5, 9, 0.9); align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.saved-modal.open { display: flex; }
.saved-modal-content {
  background: var(--surface); border: 1px solid var(--border);
  width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);
  border-radius: 4px;
}
.saved-modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 14px; border-bottom: 1px solid var(--border);
}
.saved-modal-header h3 {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--text-secondary);
}
.saved-modal-close {
  background: transparent; border: 1px solid transparent;
  color: var(--micro); cursor: pointer; font-size: 14px;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.saved-modal-close:hover { color: var(--text); }
.saved-item {
  padding: 10px 14px; cursor: pointer;
  border-bottom: 1px solid rgba(30,41,59,0.4);
  transition: background 0.1s;
}
.saved-item:hover {
  background: rgba(255,255,255,0.03);
}
.saved-item-name { font-size: 11px; font-weight: 600; }
.saved-item-info {
  font-size: 8px; color: var(--micro); margin-top: 3px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.saved-item-delete {
  float: right; font-size: 8px; color: var(--micro);
  cursor: pointer; padding: 2px 6px;
  border: none; background: none;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.1s;
}
.saved-item-delete:hover { color: var(--accent-red); }
.saved-empty {
  text-align: center; padding: 28px; color: var(--micro);
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== PRESETS DRAWER ===== */
.presets-drawer {
  display: none; position: absolute; top: 40px; left: 0; right: 0;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
  z-index: 50; padding: 12px 16px;
}
.presets-drawer.open { display: flex; gap: 8px; flex-wrap: wrap; }
.preset-card {
  flex: 1; min-width: 140px; max-width: 200px;
  padding: 10px;
  background: var(--bg-deep); border: 1px solid var(--border);
  cursor: pointer;
  transition: border-color 0.1s, background 0.1s;
  border-radius: 3px;
}
.preset-card:hover {
  border-color: var(--border-hover);
  background: var(--surface2);
}
.preset-card .pc-name {
  font-size: 11px; font-weight: 600; margin-bottom: 2px;
}
.preset-card .pc-bpm {
  font-size: 9px; color: var(--accent-orange);
  font-variant-numeric: tabular-nums;
}
.preset-card .pc-desc {
  font-size: 8px; color: var(--micro); margin-top: 4px;
  line-height: 1.4;
}
.preset-card .pc-mode {
  font-size: 7px; padding: 1px 6px;
  display: inline-block; margin-top: 6px;
  text-transform: uppercase; letter-spacing: 0.08em;
  border-radius: 2px;
}

/* ===== CONTEXT MENU — Premiere Pro Right-Click ===== */
.clip-context-menu {
  position: fixed; z-index: 250;
  background: var(--surface2); border: 1px solid var(--border);
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);
  min-width: 160px;
  border-radius: 4px;
  padding: 4px 0;
  display: none;
}
.clip-context-menu.open { display: block; }
.ctx-item {
  padding: 6px 14px; font-size: 10px;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.08s, color 0.08s;
}
.ctx-item:hover { background: rgba(59,130,246,0.15); color: var(--text); }
.ctx-item .ctx-key {
  font-size: 8px; color: var(--micro);
  margin-left: 16px;
}
.ctx-sep { height: 1px; background: var(--border); margin: 3px 0; }
.ctx-item.danger:hover { background: rgba(239,68,68,0.15); color: var(--accent-red); }

/* ===== PLAYHEAD GLOW ANIMATION ===== */
@keyframes playheadPulse {
  0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.4); }
  50% { box-shadow: 0 0 14px rgba(255,255,255,0.6); }
}
.playhead.playing {
  animation: playheadPulse 1s ease-in-out infinite;
}

/* ===== RECORDING PULSE ===== */
@keyframes recPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.transport-btn.rec.active {
  animation: recPulse 1s ease-in-out infinite;
}

/* ===== SHORTCUTS OVERLAY — CapCut Style ===== */
.shortcuts-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(3,5,9,0.7);
  align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.shortcuts-overlay.open { display: flex; }
.shortcuts-panel {
  background: var(--surface); border: 1px solid var(--border);
  padding: 16px 20px; width: 320px;
  border-radius: 6px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}
.shortcuts-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 14px;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-secondary);
}
.shortcuts-grid { display: flex; flex-direction: column; gap: 6px; }
.shortcut-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 0;
}
.shortcut-item kbd {
  font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  background: var(--bg-deep); border: 1px solid var(--border);
  padding: 2px 8px; color: var(--text);
  border-radius: 3px;
  min-width: 28px; text-align: center;
}
.shortcut-item span {
  font-size: 10px; color: var(--muted);
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

/* ===== FOCUS / SELECTION ===== */
a:focus-visible, button:focus-visible, input:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.6);
  outline-offset: 2px;
}
::selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
::-moz-selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon"><img src="assets/planet-logo.png" alt="" onerror="this.style.display='none'"></div>
      <div>
        <div class="logo-text">SATURNO MOVEMENT STUDIO</div>
        <div class="logo-sub">The Ableton of Movement</div>
      </div>
    </div>
    <nav class="header-nav">
      <button class="nav-btn" id="btn-presets" onclick="togglePresets()">PRESETS</button>
      <button class="nav-btn" onclick="clearTimeline()">CLEAR</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="saveNamedWorkout()">SAVE</button>
      <button class="nav-btn" onclick="showSavedWorkouts()">LOAD</button>
      <button class="nav-btn" onclick="exportWorkout()">EXPORT</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" id="btn-snap" onclick="toggleSnap()">SNAP</button>
      <button class="nav-btn" id="btn-video" onclick="toggleVideo()">VID</button>
      <button class="nav-btn" onclick="toggleMusic()">MUS</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="undo()" title="Undo (Cmd+Z)" style="font-size:11px">&#8617;</button>
      <button class="nav-btn" onclick="redo()" title="Redo (Cmd+Shift+Z)" style="font-size:11px">&#8618;</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="toggleShortcuts()" title="Keyboard shortcuts (?)" style="font-size:10px;font-weight:700">?</button>
    </nav>
  </header>

  <!-- PRESETS DRAWER -->
  <div class="presets-drawer" id="presets-drawer">
    <div class="preset-card" onclick="loadPreset('monk')">
      <div class="pc-name">Monk Mode</div>
      <div class="pc-bpm">65 BPM</div>
      <div class="pc-desc">Meditative, slow, precise. Breath-led reps.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('beast')">
      <div class="pc-name">Beast Mode</div>
      <div class="pc-bpm">140 BPM</div>
      <div class="pc-desc">High intensity, explosive power.</div>
      <div class="pc-mode" style="background:rgba(239,68,68,0.2);color:#ef4444">Flow / Conditioning</div>
    </div>
    <div class="preset-card" onclick="loadPreset('flow')">
      <div class="pc-name">Flow Ritual</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Continuous movement, fluid transitions.</div>
      <div class="pc-mode" style="background:rgba(139,92,246,0.2);color:#8b5cf6">Standard Tempo</div>
    </div>
    <div class="preset-card" onclick="loadPreset('skill')">
      <div class="pc-name">Skill Ascension</div>
      <div class="pc-bpm">75 BPM</div>
      <div class="pc-desc">Technical practice, isometric holds.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('upper')">
      <div class="pc-name">Upper Day</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Push/Pull balanced upper body split.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('lower')">
      <div class="pc-name">Lower Day</div>
      <div class="pc-bpm">90 BPM</div>
      <div class="pc-desc">Squat patterns, hip hinges, mobility.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('ppl')">
      <div class="pc-name">Push / Pull / Legs</div>
      <div class="pc-bpm">110 BPM</div>
      <div class="pc-desc">Classic 3-way split, all patterns hit.</div>
      <div class="pc-mode" style="background:rgba(249,115,22,0.2);color:#f97316">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('fullbody')">
      <div class="pc-name">Full Body</div>
      <div class="pc-bpm">105 BPM</div>
      <div class="pc-desc">One compound per pattern, total coverage.</div>
      <div class="pc-mode" style="background:rgba(236,72,153,0.2);color:#ec4899">Standard</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Movement Library -->
    <aside class="panel-left">
      <div class="panel-header"><span>Movement Library</span><span id="lib-count">0</span></div>
      <input type="text" class="lib-search" id="lib-search" placeholder="Search movements..." oninput="filterLibrary()">
      <div id="library-container"></div>
    </aside>

    <!-- CENTER: Transport + Video + Timeline -->
    <section class="panel-center">
      <!-- Transport -->
      <div class="transport">
        <div class="transport-buttons">
          <button class="transport-btn" onclick="rewind()" title="Rewind 15s">&#9198;</button>
          <button class="transport-btn" id="play-btn" onclick="togglePlay()" title="Play / Pause">&#9654;</button>
          <button class="transport-btn" onclick="stopPlayback()" title="Stop">&#9632;</button>
          <button class="transport-btn" onclick="forward()" title="Forward 15s">&#9197;</button>
          <button class="transport-btn rec" id="rec-btn" onclick="toggleRec()" title="Record" style="border-radius:0 3px 3px 0">&#9679;</button>
        </div>
        <div class="transport-sep"></div>
        <div class="transport-buttons">
          <button class="transport-btn" id="metro-btn" onclick="toggleMetronome()" title="Metronome" style="font-size:8px;letter-spacing:0.04em;border-radius:3px;width:auto;padding:0 8px">MET</button>
        </div>
        <div class="time-display" id="time-display">00:00:00</div>
        <div class="bpm-section">
          <span class="bpm-label">BPM</span>
          <input type="number" class="bpm-input" id="bpm-input" value="120" min="40" max="200" onchange="updateBPM()">
          <span class="bpm-mode" id="bpm-mode">Standard</span>
          <span class="tempo-link" id="tempo-link" onclick="toggleTempoLink()" title="Link BPM to exercise tempo">LINK</span>
        </div>
      </div>

      <!-- Video (collapsible) -->
      <div class="video-section" id="video-section">
        <div class="video-placeholder" id="video-placeholder">
          <div class="vp-icon">&#9654;</div>
          <span>Drop video here or click to load</span>
          <span style="font-size:9px;opacity:0.5">Landscape video plays in sync with timeline</span>
        </div>
        <video id="studio-video" style="width:100%;height:100%;object-fit:contain;display:none" controls></video>
        <button class="video-toggle" onclick="toggleVideo()" title="Toggle video">&#9660;</button>
      </div>

      <!-- Timeline -->
      <div class="timeline-container" id="timeline-container">
        <div class="timeline-ruler" id="timeline-ruler"></div>
        <div class="timeline-tracks" id="timeline-tracks">
          <div class="playhead" id="playhead"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Mixer + Inspector + Music -->
    <aside class="panel-right">
      <!-- Meter -->
      <div class="mixer-section">
        <div class="mixer-title">Output</div>
        <div class="meter-group" id="meters"></div>
      </div>

      <!-- Faders -->
      <div class="mixer-section">
        <div class="mixer-title">Master Faders</div>
        <div class="fader-group" id="fader-group"></div>
      </div>

      <!-- Knobs -->
      <div class="mixer-section">
        <div class="mixer-title">Blend Controls</div>
        <div class="knob-group" id="knob-group"></div>
      </div>

      <!-- Inspector -->
      <div class="inspector-section" id="inspector" style="display:none">
        <div class="inspector-title">Exercise DNA</div>
        <div class="inspector-field"><label>Movement</label><div class="value" id="insp-name">-</div></div>
        <div class="inspector-field"><label>Pattern</label><div class="value" id="insp-pattern">-</div></div>
        <div class="inspector-field"><label>Stage</label><div class="value" id="insp-stage">-</div></div>
        <div class="inspector-field"><label>Discipline</label><div class="value" id="insp-discipline">-</div></div>
        <div class="inspector-field">
          <label>Sets x Reps</label>
          <div style="display:flex;gap:4px">
            <input type="number" id="insp-sets" value="3" min="1" max="10" style="width:40px" onchange="updateClipDNA()">
            <span style="color:var(--micro);font-size:11px">x</span>
            <input type="number" id="insp-reps" value="8" min="1" max="50" style="width:40px" onchange="updateClipDNA()">
          </div>
        </div>
        <div class="inspector-field"><label>Tempo (seconds per rep)</label><input type="number" id="insp-tempo" value="3" min="1" max="20" step="0.5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>Rest (seconds)</label><input type="number" id="insp-rest" value="60" min="0" max="300" step="5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>RPE (1-10)</label><input type="range" id="insp-rpe" min="1" max="10" value="7" style="width:100%" oninput="updateClipDNA()"></div>
        <div class="inspector-tags" id="insp-tags"></div>
      </div>

      <!-- Music -->
      <div class="music-section" id="music-panel" style="display:none">
        <div class="mixer-title">Music</div>
        <div class="music-now-playing" id="music-np">
          <div class="eq" id="music-eq" style="display:none"><span></span><span></span><span></span></div>
          <span id="music-track-name">No track</span>
        </div>
        <div class="music-controls">
          <button class="music-btn" onclick="musicPrev()" title="Previous">&#9198;</button>
          <button class="music-btn" id="music-play-btn" onclick="musicToggle()" title="Play/Pause">&#9654;</button>
          <button class="music-btn" onclick="musicNext()" title="Next">&#9197;</button>
          <input type="range" class="music-volume" min="0" max="100" value="50" oninput="musicVolume(this.value)">
        </div>
      </div>

      <!-- Workout Summary -->
      <!-- Workout Summary — KPI Style -->
      <div class="mixer-section" id="workout-summary" style="display:none;border-left:2px solid var(--accent-purple)">
        <div class="mixer-title">Session Overview</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="text-align:center;padding:8px 0">
            <div id="sum-sets" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Sets</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-reps" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Reps</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-duration" style="font-size:1.5rem;font-weight:700;color:var(--accent-green)">0:00</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Duration</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-exercises" style="font-size:1.5rem;font-weight:700;color:var(--accent-orange)">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Exercises</div>
          </div>
        </div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:6px">Movement Balance</div>
          <div id="balance-bars" style="display:flex;gap:2px;height:24px;align-items:flex-end"></div>
          <div id="balance-labels" style="display:flex;gap:2px;margin-top:3px"></div>
        </div>
      </div>

      <!-- Export -->
      <div class="mixer-section" style="display:flex;gap:4px;padding:10px 14px">
        <button class="export-btn" onclick="exportWorkout()" style="flex:1">Export JSON</button>
        <button class="export-btn" onclick="printWorkout()" style="flex:1">Print Sheet</button>
      </div>
    </aside>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="status-item"><div class="status-dot"></div><span id="status-text">Ready</span></div>
    <div style="display:flex;gap:16px;font-size:9px">
      <span>Clips: <span id="clip-count" style="color:var(--text-secondary)">0</span></span>
      <span>Duration: <span id="total-duration" style="color:var(--text-secondary)">0:00</span></span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="footer-quote">Saturno Movement Studio</div>
      <a href="https://saturno-bonus-omega.vercel.app/vault" style="font-size:7px;color:var(--micro);text-decoration:none;text-transform:uppercase;letter-spacing:0.08em">Vault</a>
    </div>
  </footer>
</div>

<div class="saved-modal" id="saved-modal">
  <div class="saved-modal-content">
    <div class="saved-modal-header">
      <h3>Saved Workouts</h3>
      <button class="saved-modal-close" onclick="closeSavedWorkouts()">&times;</button>
    </div>
    <div id="saved-list"></div>
  </div>
</div>

<div class="clip-context-menu" id="clip-context-menu">
  <div class="ctx-item" data-action="duplicate">Duplicate<span class="ctx-key">Cmd+D</span></div>
  <div class="ctx-item" data-action="inspect">Inspect</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="snap-start">Snap to Start</div>
  <div class="ctx-item" data-action="snap-next">Snap After Previous</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" data-action="delete">Delete<span class="ctx-key">Del</span></div>
</div>
<div class="shortcuts-overlay" id="shortcuts-overlay">
  <div class="shortcuts-panel">
    <div class="shortcuts-header">
      <span>Keyboard Shortcuts</span>
      <button onclick="toggleShortcuts()" style="background:none;border:none;color:var(--micro);cursor:pointer;font-size:14px">&times;</button>
    </div>
    <div class="shortcuts-grid">
      <div class="shortcut-item"><kbd>Space</kbd><span>Play / Pause</span></div>
      <div class="shortcut-item"><kbd>Esc</kbd><span>Stop</span></div>
      <div class="shortcut-item"><kbd>S</kbd><span>Toggle Snap</span></div>
      <div class="shortcut-item"><kbd>Del</kbd><span>Delete Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Z</kbd><span>Undo</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+Z</kbd><span>Redo</span></div>
      <div class="shortcut-item"><kbd>Cmd+D</kbd><span>Duplicate</span></div>
      <div class="shortcut-item"><kbd>?</kbd><span>This Panel</span></div>
    </div>
    <div style="font-size:8px;color:var(--micro);text-align:center;margin-top:10px;text-transform:uppercase;letter-spacing:0.1em">Drag exercises from library to timeline</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ===== SFX ENGINE — DAW Sound Design ===== */
var sfxCtx = null;
function initSFX() {
  if (sfxCtx) return;
  try { sfxCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
}
function sfx(type) {
  if (!sfxCtx) initSFX();
  if (!sfxCtx) return;
  try {
    if (sfxCtx.state === 'suspended') sfxCtx.resume();
    var now = sfxCtx.currentTime;
    var osc, gain;
    switch(type) {
      case 'click': // UI click — short, crisp
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        osc.frequency.exponentialRampToValueAtTime(800, now + 0.05);
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.06);
        break;
      case 'snap': // Snap to grid
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(2000, now);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.03);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.04);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.04);
        break;
      case 'play': // Transport play — rising tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'stop': // Transport stop — falling tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(660, now);
        osc.frequency.exponentialRampToValueAtTime(220, now + 0.12);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'drop': // Clip dropped — soft thud
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(180, now);
        osc.frequency.exponentialRampToValueAtTime(80, now + 0.08);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'delete': // Clip deleted — descending sweep
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
        gain.gain.setValueAtTime(0.06, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'preset': // Preset loaded — chord
        [440, 554, 659].forEach(function(freq, i) {
          var o = sfxCtx.createOscillator();
          var g = sfxCtx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(freq, now + i * 0.04);
          g.gain.setValueAtTime(0.06, now + i * 0.04);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
          o.connect(g); g.connect(sfxCtx.destination);
          o.start(now + i * 0.04); o.stop(now + 0.3);
        });
        break;
      case 'undo': // Undo — quick reverse
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(300, now + 0.08);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'rec': // Record — pulsing tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.setValueAtTime(0.02, now + 0.05);
        gain.gain.setValueAtTime(0.1, now + 0.1);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.2);
        break;
      case 'metronome': // Metronome tick
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1000, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.02);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.02);
        break;
    }
  } catch(e) {}
}

/* Init SFX on first user interaction */
document.addEventListener('click', function() { initSFX(); }, {once: true});
document.addEventListener('touchstart', function() { initSFX(); }, {once: true});

/* ===== EXERCISE DATABASE (from Victory Belt CC Movement Matrix) ===== */
var EXERCISES = [
  /* Horizontal Push (Pattern 1) */
  {id:'P1-01',name:'Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-02',name:'Diamond Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-03',name:'Wide Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-04',name:'Decline Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-05',name:'Archer Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-06',name:'Pseudo Planche PU',pattern:'Horizontal Push',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-07',name:'Ring Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-08',name:'One Arm Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-09',name:'Planche Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Horizontal Pull (Pattern 2) */
  {id:'P2-01',name:'Inverted Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-02',name:'Ring Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-03',name:'Archer Row',pattern:'Horizontal Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-04',name:'Tuck Front Lever',pattern:'Horizontal Pull',stage:2,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-05',name:'Front Lever Row',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-06',name:'Front Lever',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Downward Press (Pattern 3) */
  {id:'P3-01',name:'Dip',pattern:'Downward Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-02',name:'Ring Dip',pattern:'Downward Press',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-03',name:'Korean Dip',pattern:'Downward Press',stage:2,discipline:'Freestyle',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-04',name:'Weighted Dip',pattern:'Downward Press',stage:2,discipline:'Street Lifting',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-05',name:'Tuck Planche',pattern:'Downward Press',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-06',name:'Full Planche',pattern:'Downward Press',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Vertical Pull (Pattern 4) */
  {id:'P4-01',name:'Dead Hang',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-02',name:'Pull Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-03',name:'Chin Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-04',name:'L-Sit Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-05',name:'Archer Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-06',name:'Muscle Up (Bar)',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-07',name:'Ring Muscle Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-08',name:'Weighted Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Street Lifting',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-09',name:'One Arm Pull Up',pattern:'Vertical Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Overhead Press (Pattern 5) */
  {id:'P5-01',name:'Pike Push Up',pattern:'Overhead Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P5-02',name:'Wall Handstand Hold',pattern:'Overhead Press',stage:1,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-03',name:'Wall HSPU',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-04',name:'Free Handstand',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-05',name:'Handstand Push Up',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-06',name:'Press to Handstand',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  /* Knee-Dominant (Pattern 6) */
  {id:'P6-01',name:'Bodyweight Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-02',name:'Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-03',name:'Bulgarian Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-04',name:'Pistol Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-05',name:'Shrimp Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-06',name:'Cossack Squat',pattern:'Knee-Dominant',stage:2,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-07',name:'Dragon Squat',pattern:'Knee-Dominant',stage:3,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  /* Hip-Dominant (Pattern 7) */
  {id:'P7-01',name:'Glute Bridge',pattern:'Hip-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-02',name:'Nordic Curl',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-03',name:'Wrestler Bridge',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-04',name:'Stand to Bridge',pattern:'Hip-Dominant',stage:3,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  /* Core */
  {id:'C-01',name:'Hollow Body Hold',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-02',name:'Plank',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-03',name:'L-Sit',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-04',name:'V-Sit',pattern:'Core',stage:3,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-05',name:'Dragon Flag',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-06',name:'Ab Wheel Rollout',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  /* Mobility */
  {id:'M-01',name:'Resting Squat',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-02',name:'Pancake Stretch',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-03',name:'Front Split',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-04',name:'Thoracic Bridge',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-05',name:'German Hang',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-06',name:'Hip CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-07',name:'Scapular CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'}
];

/* Movement family -> instrument role (from Composition Engine) */
var FAMILY_MAP = {
  'Push': {instrument:'Percussion',color:'#3b82f6'},
  'Pull': {instrument:'Bass',color:'#8b5cf6'},
  'Legs': {instrument:'Rhythm Guitar',color:'#22c55e'},
  'Core': {instrument:'Harmony',color:'#f97316'},
  'Skills': {instrument:'Lead Melody',color:'#06b6d4'},
  'Flow': {instrument:'Ambient Pad',color:'#ec4899'}
};

/* BPM -> Training Mode (from Composition Engine) */
var BPM_MODES = [
  {min:40,max:80,name:'Slow Strength',desc:'Control, holds, precision'},
  {min:80,max:120,name:'Standard',desc:'Tempo work, sets'},
  {min:120,max:160,name:'Flow State',desc:'Conditioning, flow'},
  {min:160,max:200,name:'Explosive',desc:'Power, speed, intensity'}
];

/* Track definitions */
var TRACKS = [
  {id:'music',name:'Music',family:'_music',info:'Audio',isMusic:true},
  {id:'push',name:'Push',family:'Push',info:'Percussion'},
  {id:'pull',name:'Pull',family:'Pull',info:'Bass'},
  {id:'core',name:'Core',family:'Core',info:'Harmony'},
  {id:'legs',name:'Legs',family:'Legs',info:'Rhythm'},
  {id:'skills',name:'Skills',family:'Skills',info:'Lead'}
];

/* Fader definitions */
var FADERS = [
  {id:'intensity',label:'Intensity',value:70,color:'var(--gradient-titan)'},
  {id:'volume',label:'Volume',value:50,color:'var(--gradient-titan)'},
  {id:'density',label:'Density',value:60,color:'var(--gradient-titan)'},
  {id:'rest',label:'Rest',value:40,color:'var(--gradient-titan)'}
];

/* Knob definitions */
var KNOBS = [
  {id:'str-mob',label:'Str / Mob',value:0.5},
  {id:'pwr-ctrl',label:'Pwr / Ctrl',value:0.5},
  {id:'sta-dyn',label:'Sta / Dyn',value:0.5}
];

/* Preset definitions */
var PRESETS = {
  monk: {
    name:'Monk Mode',bpm:65,
    clips:[
      {track:'core',name:'Hollow Body Hold',x:0,w:120},
      {track:'push',name:'Push Up',x:20,w:100},
      {track:'core',name:'L-Sit',x:140,w:100},
      {track:'pull',name:'Pull Up',x:140,w:100},
      {track:'skills',name:'Free Handstand',x:260,w:120},
      {track:'legs',name:'Resting Squat',x:260,w:80}
    ],
    faders:{intensity:40,volume:30,density:30,rest:70},
    knobs:{'str-mob':0.4,'pwr-ctrl':0.3,'sta-dyn':0.2}
  },
  beast: {
    name:'Beast Mode',bpm:140,
    clips:[
      {track:'push',name:'Diamond Push Up',x:0,w:100},
      {track:'pull',name:'Muscle Up (Bar)',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:120,w:80},
      {track:'push',name:'Dip',x:120,w:80},
      {track:'core',name:'Dragon Flag',x:120,w:80},
      {track:'pull',name:'Weighted Pull Up',x:220,w:100},
      {track:'legs',name:'Shrimp Squat',x:220,w:80},
      {track:'push',name:'Planche Push Up',x:340,w:100}
    ],
    faders:{intensity:90,volume:80,density:85,rest:20},
    knobs:{'str-mob':0.8,'pwr-ctrl':0.7,'sta-dyn':0.9}
  },
  flow: {
    name:'Flow Ritual',bpm:100,
    clips:[
      {track:'legs',name:'Hip CARs',x:0,w:80},
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'core',name:'Hollow Body Hold',x:100,w:80},
      {track:'pull',name:'Ring Row',x:100,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:200,w:100},
      {track:'legs',name:'Cossack Squat',x:200,w:80},
      {track:'core',name:'L-Sit',x:300,w:80},
      {track:'push',name:'Ring Push Up',x:300,w:100}
    ],
    faders:{intensity:55,volume:60,density:65,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.4,'sta-dyn':0.6}
  },
  skill: {
    name:'Skill Ascension',bpm:75,
    clips:[
      {track:'skills',name:'Free Handstand',x:0,w:160},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'pull',name:'Tuck Front Lever',x:180,w:140},
      {track:'push',name:'Tuck Planche',x:180,w:140},
      {track:'core',name:'V-Sit',x:180,w:80},
      {track:'skills',name:'Press to Handstand',x:340,w:160}
    ],
    faders:{intensity:60,volume:40,density:35,rest:80},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.3,'sta-dyn':0.15}
  },
  upper: {
    name:'Upper Day',bpm:100,
    clips:[
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'push',name:'Dip',x:120,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Inverted Row',x:120,w:100},
      {track:'push',name:'Ring Push Up',x:240,w:100},
      {track:'pull',name:'Chin Up',x:240,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'L-Sit',x:120,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:360,w:120}
    ],
    faders:{intensity:65,volume:60,density:55,rest:50},
    knobs:{'str-mob':0.7,'pwr-ctrl':0.5,'sta-dyn':0.4}
  },
  lower: {
    name:'Lower Day',bpm:90,
    clips:[
      {track:'legs',name:'Bodyweight Squat',x:0,w:100},
      {track:'legs',name:'Bulgarian Split Squat',x:120,w:100},
      {track:'legs',name:'Pistol Squat',x:240,w:100},
      {track:'legs',name:'Nordic Curl',x:360,w:100},
      {track:'legs',name:'Cossack Squat',x:480,w:80},
      {track:'core',name:'Dragon Flag',x:0,w:100},
      {track:'core',name:'Ab Wheel Rollout',x:120,w:80},
      {track:'legs',name:'Glute Bridge',x:600,w:80},
      {track:'skills',name:'Resting Squat',x:0,w:120}
    ],
    faders:{intensity:70,volume:55,density:60,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.6,'sta-dyn':0.5}
  },
  ppl: {
    name:'Push / Pull / Legs',bpm:110,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'push',name:'Pseudo Planche PU',x:120,w:100},
      {track:'push',name:'Pike Push Up',x:240,w:80},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Ring Row',x:120,w:80},
      {track:'pull',name:'Tuck Front Lever',x:220,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'legs',name:'Nordic Curl',x:120,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'Dragon Flag',x:100,w:80}
    ],
    faders:{intensity:75,volume:65,density:70,rest:35},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.6,'sta-dyn':0.6}
  },
  fullbody: {
    name:'Full Body',bpm:105,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'skills',name:'Free Handstand',x:0,w:120},
      {track:'push',name:'Ring Push Up',x:140,w:80},
      {track:'pull',name:'Archer Pull Up',x:140,w:80},
      {track:'legs',name:'Bulgarian Split Squat',x:140,w:80},
      {track:'core',name:'Ab Wheel Rollout',x:140,w:80}
    ],
    faders:{intensity:60,volume:55,density:50,rest:50},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.5,'sta-dyn':0.5}
  }
};

/* ===== STATE ===== */
var isPlaying = false, currentTime = 0, bpm = 120, playInterval = null;
var isRecording = false, tempoLinked = false;
var selectedClip = null, musicPlaying = false, musicIndex = 0;
var audioEl = null;
var meterInterval = null;
var undoStack = [], redoStack = [], maxUndo = 30;
var metronomeEnabled = false, lastBeatTime = 0, beatCounter = 0;

/* Music tracks (from Vercel Blob CDN) */
var MUSIC_TRACKS = [
  {name:'Celestial Reverie',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Celestial%20Reverie.mp3'},
  {name:'Blue Phoenix',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Blue%20Phoenix.mp3'},
  {name:'Veil of Truth',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Veil%20of%20Truth.mp3'},
  {name:'Astral Shadows',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Astral%20Shadows.mp3'}
];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', function() {
  buildLibrary();
  buildTracks();
  buildRuler();
  buildFaders();
  buildKnobs();
  buildMeters();
  loadSession();
  updateBPMMode();
});

/* ===== LIBRARY ===== */
function buildLibrary() {
  var container = document.getElementById('library-container');
  var groups = {};
  EXERCISES.forEach(function(ex) {
    var g = ex.pattern;
    if (!groups[g]) groups[g] = [];
    groups[g].push(ex);
  });
  var html = '';
  var patterns = ['Horizontal Push','Horizontal Pull','Downward Press','Vertical Pull','Overhead Press','Knee-Dominant','Hip-Dominant','Core','Mobility'];
  patterns.forEach(function(p) {
    var exs = groups[p];
    if (!exs) return;
    var fam = exs[0].family;
    var fm = FAMILY_MAP[fam] || {color:'#666'};
    html += '<div class="movement-category" data-pattern="'+p+'">';
    html += '<div class="category-header" onclick="toggleCategory(this)"><span>'+p+' ('+exs.length+')</span><div style="display:flex;align-items:center;gap:6px"><div class="category-color" style="background:'+fm.color+'"></div><span class="arrow">&#9660;</span></div></div>';
    html += '<div class="movement-list">';
    exs.forEach(function(ex) {
      html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" data-family="'+ex.family+'">';
      html += '<div class="mv-icon" style="background:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
      html += '<span>'+ex.name+'</span>';
      html += '<span class="mv-stage">S'+ex.stage+'</span>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
  document.getElementById('lib-count').textContent = EXERCISES.length;
  initDragDrop();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  var list = header.nextElementSibling;
  list.classList.toggle('hidden');
}

function filterLibrary() {
  var q = document.getElementById('lib-search').value.toLowerCase();
  var items = document.querySelectorAll('.movement-item');
  var count = 0;
  items.forEach(function(item) {
    var show = item.textContent.toLowerCase().indexOf(q) !== -1;
    item.style.display = show ? '' : 'none';
    if (show) count++;
  });
  document.getElementById('lib-count').textContent = count;
  // Show all categories when searching
  if (q) {
    document.querySelectorAll('.movement-list').forEach(function(l) { l.classList.remove('hidden'); });
    document.querySelectorAll('.category-header').forEach(function(h) { h.classList.remove('collapsed'); });
  }
}

/* ===== TRACKS ===== */
function buildTracks() {
  var container = document.getElementById('timeline-tracks');
  var ph = container.querySelector('.playhead');
  var html = '';
  TRACKS.forEach(function(t) {
    if (t.isMusic) {
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-name" style="color:var(--accent-cyan)">'+t.name+'</div>';
      html += '<select class="track-select" id="music-track-select" onchange="selectMusicTrack(this.value)" style="font-size:8px;padding:2px 4px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text);width:88px;font-family:Sora,sans-serif;border-radius:2px">';
      html += '<option value="">--</option>';
      MUSIC_TRACKS.forEach(function(mt,i) { html += '<option value="'+i+'">'+mt.name+'</option>'; });
      html += '</select></div>';
      html += '<div class="track-content" data-track="'+t.id+'" style="pointer-events:none"><span id="music-timeline-label" style="font-size:8px;color:var(--micro);padding:4px 8px;display:inline-block">Select a track</span></div></div>';
    } else {
      var fm = FAMILY_MAP[t.family] || {color:'#666'};
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-name" style="color:'+fm.color+'">'+t.name+'</div><div class="track-info">'+t.info+'</div>';
      html += '<div class="track-controls"><button class="track-btn" onclick="toggleMute(this)" title="Mute">M</button><button class="track-btn" onclick="toggleSolo(this)" title="Solo">S</button><button class="track-btn" onclick="toggleArm(this)" title="Arm" style="color:var(--micro)">R</button></div>';
      html += '<div class="track-clip-count" id="track-count-'+t.id+'">0 clips</div>';
      html += '</div>';
      html += '<div class="track-content" data-track="'+t.id+'"></div></div>';
    }
  });
  container.innerHTML = html;
  container.insertBefore(ph, container.firstChild);
}

function selectMusicTrack(idx) {
  if (idx === '') {
    document.getElementById('music-timeline-label').textContent = 'Select a track';
    return;
  }
  musicIndex = parseInt(idx);
  var track = MUSIC_TRACKS[musicIndex];
  document.getElementById('music-timeline-label').textContent = track.name;
  document.getElementById('music-track-name').textContent = track.name;
  if (!audioEl) { audioEl = new Audio(); audioEl.volume = 0.5; audioEl.addEventListener('ended', function() { musicNext(); }); }
  audioEl.src = track.url;
  audioEl.load();
  toast('Music: ' + track.name);
}

function buildRuler() {
  var ruler = document.getElementById('timeline-ruler');
  var html = '<div class="ruler-mark" style="flex:0 0 100px">0:00</div>';
  for (var i = 15; i <= 300; i += 15) {
    var m = Math.floor(i / 60);
    var s = i % 60;
    html += '<div class="ruler-mark">'+m+':'+s.toString().padStart(2,'0')+'</div>';
  }
  ruler.innerHTML = html;
}

/* ===== DRAG & DROP ===== */
function initDragDrop() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.4';
      // Custom drag image — looks like a mini clip
      var ghost = document.createElement('div');
      ghost.textContent = ex.name;
      ghost.style.cssText = 'position:absolute;top:-999px;left:-999px;padding:4px 10px;font-size:9px;font-weight:600;font-family:Sora,sans-serif;background:' + (FAMILY_MAP[ex.family] || {color:'#666'}).color + ';color:rgba(255,255,255,0.9);border-radius:3px;white-space:nowrap;border-top:2px solid rgba(255,255,255,0.3)';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 0, 0);
      setTimeout(function() { document.body.removeChild(ghost); }, 0);
      sfx('click');
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
  document.querySelectorAll('.track-content').forEach(function(track) {
    track.addEventListener('dragover', function(e) { e.preventDefault(); track.classList.add('drag-over'); });
    track.addEventListener('dragleave', function() { track.classList.remove('drag-over'); });
    track.addEventListener('drop', function(e) {
      e.preventDefault();
      track.classList.remove('drag-over');
      try {
        var ex = JSON.parse(e.dataTransfer.getData('text/plain'));
        var rect = track.getBoundingClientRect();
        var x = e.clientX - rect.left + track.parentElement.parentElement.scrollLeft;
        addClip(track, ex, x);
      } catch(err) {}
    });
  });
}

function getExercise(id) {
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].id === id) return EXERCISES[i];
  }
  return null;
}

/* ===== CLIPS ===== */
function drawClipWaveform(canvas, color, width) {
  if (!canvas || !canvas.getContext) return;
  var w = parseInt(width) || 80;
  canvas.width = w - 8;
  canvas.height = 20;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.globalAlpha = 0.4;
  var mid = canvas.height / 2;
  var seed = w * 7 + canvas.width;
  ctx.beginPath();
  for (var x = 0; x < canvas.width; x++) {
    var v = Math.sin(x * 0.15 + seed * 0.01) * 0.4 +
            Math.sin(x * 0.08 + seed * 0.02) * 0.3 +
            Math.sin(x * 0.3 + seed * 0.005) * 0.2;
    var amp = (mid - 2) * Math.abs(v);
    if (x === 0) { ctx.moveTo(x, mid - amp); } else { ctx.lineTo(x, mid - amp); }
  }
  ctx.stroke();
  ctx.beginPath();
  for (var x = 0; x < canvas.width; x++) {
    var v = Math.sin(x * 0.15 + seed * 0.01) * 0.4 +
            Math.sin(x * 0.08 + seed * 0.02) * 0.3 +
            Math.sin(x * 0.3 + seed * 0.005) * 0.2;
    var amp = (mid - 2) * Math.abs(v);
    if (x === 0) { ctx.moveTo(x, mid + amp); } else { ctx.lineTo(x, mid + amp); }
  }
  ctx.stroke();
}

function createClipElement(exercise, left, width, dna) {
  var fm = FAMILY_MAP[exercise.family] || {color:'#666'};
  var clip = document.createElement('div');
  clip.className = 'clip';
  var baseColor = fm.color;
  clip.style.background = 'linear-gradient(180deg, ' + baseColor + ' 0%, ' + baseColor + 'cc 100%)';
  clip.style.borderTopColor = baseColor;
  clip.style.left = (typeof left === 'string' ? left : Math.max(0, left) + 'px');
  clip.style.width = (typeof width === 'string' ? width : (width || 80) + 'px');
  clip.style.color = 'rgba(255,255,255,0.9)';
  clip.dataset.exerciseId = exercise.id;
  clip.dataset.sets = (dna && dna.sets) || '3';
  clip.dataset.reps = (dna && dna.reps) || '8';
  clip.dataset.tempo = (dna && dna.tempo) || '3';
  clip.dataset.rest = (dna && dna.rest) || '60';
  clip.dataset.rpe = (dna && dna.rpe) || '7';

  var label = document.createElement('span');
  label.textContent = exercise.name;
  label.style.position = 'relative';
  label.style.zIndex = '1';
  clip.appendChild(label);

  var info = document.createElement('span');
  info.className = 'clip-info';
  info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps;
  info.style.position = 'relative';
  info.style.zIndex = '1';
  clip.appendChild(info);

  var canvas = document.createElement('canvas');
  canvas.className = 'clip-waveform';
  clip.appendChild(canvas);
  setTimeout(function() { drawClipWaveform(canvas, 'rgba(255,255,255,0.6)', clip.style.width); }, 10);

  var resize = document.createElement('div');
  resize.className = 'clip-resize';
  clip.appendChild(resize);

  // Drag clip
  clip.addEventListener('mousedown', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    e.preventDefault();
    selectClipEl(clip);
    var startX = e.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) {
      var newLeft = Math.max(0, startLeft + e.clientX - startX);
      clip.style.left = snapValue(newLeft) + 'px';
    }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Resize clip (stretching shows duration + redraws waveform)
  resize.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      var newW = Math.max(40, startW + e.clientX - startX);
      newW = snapEnabled ? Math.max(40, snapValue(newW)) : newW;
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, 'rgba(255,255,255,0.6)', newW + 'px');
      var durSec = Math.round(newW / 80 * 15);
      var durM = Math.floor(durSec / 60);
      var durS = durSec % 60;
      var durStr = durM > 0 ? durM + ':' + durS.toString().padStart(2,'0') : durSec + 's';
      clip.title = exercise.name + ' - ' + durStr;
      updateStats();
    }
    function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveSession(); updateStats(); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Right-click context menu (Premiere Pro style)
  clip.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    selectClipEl(clip);
    showClipContextMenu(e.clientX, e.clientY, clip, exercise);
  });

  // Touch drag support
  clip.addEventListener('touchstart', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    selectClipEl(clip);
    var touch = e.touches[0];
    var startX = touch.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) { e.preventDefault(); clip.style.left = Math.max(0, startLeft + e.touches[0].clientX - startX) + 'px'; }
    function onEnd() { clip.removeEventListener('touchmove', onMove); clip.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    clip.addEventListener('touchmove', onMove, {passive: false});
    clip.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Touch resize support
  resize.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    var touch = e.touches[0];
    var startX = touch.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      e.preventDefault();
      var newW = Math.max(40, startW + e.touches[0].clientX - startX);
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, 'rgba(255,255,255,0.6)', newW + 'px');
      updateStats();
    }
    function onEnd() { resize.removeEventListener('touchmove', onMove); resize.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    resize.addEventListener('touchmove', onMove, {passive: false});
    resize.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Double click / double tap to delete
  var lastTap = 0;
  clip.addEventListener('touchend', function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      clip.remove();
      if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      toast('Clip removed');
    }
    lastTap = now;
  });
  clip.addEventListener('dblclick', function() {
    pushUndo();
    clip.remove();
    if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
    updateStats(); saveSession();
    sfx('delete');
    toast('Clip removed');
  });

  return clip;
}

function addClip(track, exercise, x) {
  pushUndo();
  var clip = createClipElement(exercise, x, 80);
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  sfx('drop');
  toast(exercise.name + ' added');
}

function selectClipEl(clip) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  clip.classList.add('selected');
  selectedClip = clip;
  var ex = getExercise(clip.dataset.exerciseId);
  if (!ex) return;
  var insp = document.getElementById('inspector');
  insp.style.display = '';
  document.getElementById('insp-name').textContent = ex.name;
  document.getElementById('insp-pattern').textContent = ex.pattern;
  document.getElementById('insp-stage').textContent = 'Stage ' + ex.stage + ' - ' + ex.discipline;
  document.getElementById('insp-discipline').textContent = ex.discipline;
  document.getElementById('insp-sets').value = clip.dataset.sets || 3;
  document.getElementById('insp-reps').value = clip.dataset.reps || 8;
  document.getElementById('insp-tempo').value = clip.dataset.tempo || 3;
  document.getElementById('insp-rest').value = clip.dataset.rest || 60;
  document.getElementById('insp-rpe').value = clip.dataset.rpe || 7;
  var fm = FAMILY_MAP[ex.family] || {};
  document.getElementById('insp-tags').innerHTML =
    '<span class="inspector-tag" style="background:'+((FAMILY_MAP[ex.family]||{}).color||'#666')+'22;color:'+(FAMILY_MAP[ex.family]||{}).color+'">'+ex.family+'</span>' +
    '<span class="inspector-tag">'+(fm.instrument||'')+'</span>' +
    '<span class="inspector-tag">S'+ex.stage+'</span>';
}

function updateClipDNA() {
  if (!selectedClip) return;
  selectedClip.dataset.sets = document.getElementById('insp-sets').value;
  selectedClip.dataset.reps = document.getElementById('insp-reps').value;
  selectedClip.dataset.tempo = document.getElementById('insp-tempo').value;
  selectedClip.dataset.rest = document.getElementById('insp-rest').value;
  selectedClip.dataset.rpe = document.getElementById('insp-rpe').value;
  var info = selectedClip.querySelector('.clip-info');
  if (info) info.textContent = selectedClip.dataset.sets + 'x' + selectedClip.dataset.reps;
  // If tempo linked, update clip width based on exercise duration
  if (tempoLinked) {
    var sets = parseInt(selectedClip.dataset.sets) || 3;
    var reps = parseInt(selectedClip.dataset.reps) || 8;
    var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
    var rest = parseInt(selectedClip.dataset.rest) || 60;
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var pps = 80 / 15;
    selectedClip.style.width = Math.max(40, totalSec * pps) + 'px';
    updateStats();
  }
  saveSession();
}

function updateSummary() {
  var clips = document.querySelectorAll('.clip');
  var panel = document.getElementById('workout-summary');
  if (clips.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = '';
  var totalSets = 0, totalReps = 0, totalDur = 0, exerciseSet = {};
  var familyCounts = {};
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    totalSets += sets;
    totalReps += sets * reps;
    totalDur += (sets * reps * tempo) + ((sets - 1) * rest);
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exerciseSet[ex.id] = true;
      familyCounts[ex.family] = (familyCounts[ex.family] || 0) + 1;
    }
  });
  document.getElementById('sum-sets').textContent = totalSets;
  document.getElementById('sum-reps').textContent = totalReps;
  var durM = Math.floor(totalDur / 60);
  var durS = Math.floor(totalDur % 60);
  document.getElementById('sum-duration').textContent = durM + ':' + durS.toString().padStart(2, '0');
  document.getElementById('sum-exercises').textContent = Object.keys(exerciseSet).length;
  // Balance bars
  var maxCount = 1;
  var families = ['Push','Pull','Core','Legs','Skills','Flow'];
  families.forEach(function(f) { if ((familyCounts[f] || 0) > maxCount) maxCount = familyCounts[f]; });
  var barsHtml = '', labelsHtml = '';
  families.forEach(function(f) {
    var count = familyCounts[f] || 0;
    var fm = FAMILY_MAP[f] || {color:'#666'};
    var h = count > 0 ? Math.max(4, (count / maxCount) * 20) : 2;
    barsHtml += '<div style="flex:1;height:'+h+'px;background:'+fm.color+';border-radius:1px;opacity:'+(count > 0 ? 1 : 0.2)+'"></div>';
    labelsHtml += '<div style="flex:1;font-size:6px;color:var(--micro);text-align:center">'+f.charAt(0)+'</div>';
  });
  document.getElementById('balance-bars').innerHTML = barsHtml;
  document.getElementById('balance-labels').innerHTML = labelsHtml;
}

function updateStats() {
  var clips = document.querySelectorAll('.clip');
  document.getElementById('clip-count').textContent = clips.length;
  var maxRight = 0;
  var trackCounts = {};
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
    var tid = c.parentElement.dataset.track;
    trackCounts[tid] = (trackCounts[tid] || 0) + 1;
  });
  var secs = Math.round(maxRight / 80 * 15);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  document.getElementById('total-duration').textContent = m + ':' + s.toString().padStart(2, '0');
  // Update per-track clip counts
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    var el = document.getElementById('track-count-' + t.id);
    if (el) el.textContent = (trackCounts[t.id] || 0) + ' clips';
  });
  updateSummary();
}

/* ===== TRANSPORT ===== */
function togglePlay() {
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) {
    btn.classList.add('active');
    btn.innerHTML = '&#9616;&#9616;';
    playInterval = setInterval(updatePlayhead, 50);
    startMeters();
    document.getElementById('status-text').textContent = 'Playing';
    updatePlayheadClass();
    sfx('play');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#9654;';
    clearInterval(playInterval);
    stopMeters();
    document.getElementById('status-text').textContent = 'Paused';
    updatePlayheadClass();
    sfx('click');
  }
}

function stopPlayback() {
  isPlaying = false;
  currentTime = 0;
  var btn = document.getElementById('play-btn');
  btn.classList.remove('active');
  btn.innerHTML = '&#9654;';
  clearInterval(playInterval);
  stopMeters();
  updateTimeDisplay();
  updatePlayheadPosition();
  updatePlayheadClass();
  document.getElementById('status-text').textContent = 'Ready';
  sfx('stop');
}

function rewind() { currentTime = Math.max(0, currentTime - 15); updateTimeDisplay(); updatePlayheadPosition(); }
function forward() { currentTime += 15; updateTimeDisplay(); updatePlayheadPosition(); }

function updatePlayhead() {
  currentTime += 0.05;
  updateTimeDisplay();
  updatePlayheadPosition();
  // Metronome tick on the beat
  if (metronomeEnabled) {
    var beatInterval = 60 / bpm;
    var currentBeat = Math.floor(currentTime / beatInterval);
    if (currentBeat > beatCounter) {
      beatCounter = currentBeat;
      sfx('metronome');
    }
  }
}

function updateTimeDisplay() {
  var mins = Math.floor(currentTime / 60);
  var secs = Math.floor(currentTime % 60);
  var ms = Math.floor((currentTime % 1) * 100);
  document.getElementById('time-display').textContent =
    mins.toString().padStart(2, '0') + ':' +
    secs.toString().padStart(2, '0') + ':' +
    ms.toString().padStart(2, '0');
}

function updatePlayheadPosition() {
  var pps = 80 / 15;
  document.getElementById('playhead').style.left = (100 + currentTime * pps) + 'px';
}

function toggleRec() {
  isRecording = !isRecording;
  var btn = document.getElementById('rec-btn');
  btn.classList.toggle('active', isRecording);
  document.getElementById('status-text').textContent = isRecording ? 'Recording' : 'Ready';
  sfx(isRecording ? 'rec' : 'click');
}

/* ===== BPM ===== */
function updateBPM() {
  bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  updateBPMMode();
  saveSession();
  // If tempo-linked, adjust exercise tempos AND music playback rate
  if (tempoLinked) {
    var repTempo = 60 / bpm;
    document.getElementById('insp-tempo').value = repTempo.toFixed(1);
    if (selectedClip) {
      selectedClip.dataset.tempo = repTempo.toFixed(1);
      updateClipDNA();
    }
    // Adjust music playback rate: 120 BPM = 1.0x, scale proportionally
    if (audioEl) {
      var rate = Math.max(0.5, Math.min(2.0, bpm / 120));
      audioEl.playbackRate = rate;
    }
    toast('Tempo linked: ' + repTempo.toFixed(1) + 's/rep, music ' + (bpm / 120).toFixed(2) + 'x');
  } else {
    // Reset music to normal speed when unlinked
    if (audioEl) audioEl.playbackRate = 1.0;
  }
}

function updateBPMMode() {
  var mode = 'Standard';
  for (var i = 0; i < BPM_MODES.length; i++) {
    if (bpm >= BPM_MODES[i].min && bpm < BPM_MODES[i].max) {
      mode = BPM_MODES[i].name;
      break;
    }
  }
  if (bpm >= 200) mode = 'Explosive';
  document.getElementById('bpm-mode').textContent = mode;
}

function toggleTempoLink() {
  tempoLinked = !tempoLinked;
  var el = document.getElementById('tempo-link');
  el.classList.toggle('active', tempoLinked);
  if (tempoLinked) {
    sfx('click');
    toast('BPM linked to exercise tempo');
    updateBPM();
  } else {
    if (audioEl) audioEl.playbackRate = 1.0;
    sfx('click');
    toast('Tempo unlinked');
  }
}

function toggleMetronome() {
  metronomeEnabled = !metronomeEnabled;
  beatCounter = Math.floor(currentTime / (60 / bpm));
  var btn = document.getElementById('metro-btn');
  if (btn) btn.classList.toggle('active', metronomeEnabled);
  sfx(metronomeEnabled ? 'metronome' : 'click');
  toast(metronomeEnabled ? 'Metronome ON' : 'Metronome OFF');
}

/* ===== FADERS ===== */
function buildFaders() {
  var container = document.getElementById('fader-group');
  var html = '';
  FADERS.forEach(function(f) {
    html += '<div class="fader" data-fader="'+f.id+'">';
    html += '<div class="fader-label">'+f.label+'</div>';
    html += '<div class="fader-track" onmousedown="startFaderDrag(event,\''+f.id+'\')" ontouchstart="startFaderDrag(event,\''+f.id+'\')">';
    html += '<div class="fader-fill" style="height:'+f.value+'%;background:'+f.color+'"></div>';
    html += '<div class="fader-handle" style="bottom:'+(f.value-3)+'%"></div>';
    html += '</div>';
    html += '<div class="fader-value" id="fader-val-'+f.id+'">'+(f.value/10).toFixed(0)+'</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startFaderDrag(e, faderId) {
  e.preventDefault();
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  function updatePos(clientY) {
    var y = 1 - ((clientY - rect.top) / rect.height);
    y = Math.max(0, Math.min(1, y));
    var pct = y * 100;
    track.querySelector('.fader-fill').style.height = pct + '%';
    track.querySelector('.fader-handle').style.bottom = (pct - 3) + '%';
    document.getElementById('fader-val-' + faderId).textContent = (pct / 10).toFixed(0);
  }
  function onMouseMove(e) { updatePos(e.clientY); }
  function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updatePos(e.touches[0].clientY); }
  function onTouchEnd() { document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    updatePos(e.touches[0].clientY);
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    updatePos(e.clientY);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== KNOBS ===== */
function buildKnobs() {
  var container = document.getElementById('knob-group');
  var html = '';
  KNOBS.forEach(function(k) {
    var deg = (k.value - 0.5) * 270;
    html += '<div class="knob" data-knob="'+k.id+'">';
    html += '<div class="knob-dial" onmousedown="startKnobDrag(event,\''+k.id+'\')" ontouchstart="startKnobDrag(event,\''+k.id+'\')">';
    html += '<div class="knob-indicator" style="transform:translateX(-50%) rotate('+deg+'deg)"></div>';
    html += '</div>';
    html += '<div class="knob-label">'+k.label+'</div>';
    html += '<div class="knob-value" id="knob-val-'+k.id+'">'+(k.value*100).toFixed(0)+'%</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function startKnobDrag(e, knobId) {
  e.preventDefault();
  var startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  var dial = e.currentTarget;
  var indicator = dial.querySelector('.knob-indicator');
  var startDeg = parseFloat(indicator.style.transform.match(/rotate\(([^)]+)deg\)/)[1]);
  function updateKnob(clientY) {
    var delta = (startY - clientY) * 1.5;
    var deg = Math.max(-135, Math.min(135, startDeg + delta));
    indicator.style.transform = 'translateX(-50%) rotate(' + deg + 'deg)';
    var val = ((deg + 135) / 270);
    document.getElementById('knob-val-' + knobId).textContent = (val * 100).toFixed(0) + '%';
  }
  function onMouseMove(e) { updateKnob(e.clientY); }
  function onMouseUp() { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updateKnob(e.touches[0].clientY); }
  function onTouchEnd() { document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== METERS ===== */
function buildMeters() {
  var container = document.getElementById('meters');
  var html = '';
  for (var i = 0; i < 12; i++) {
    html += '<div class="meter-bar" style="height:' + (10 + Math.random() * 30) + 'px"></div>';
  }
  container.innerHTML = html;
}

function startMeters() {
  if (meterInterval) return;
  meterInterval = setInterval(function() {
    document.querySelectorAll('.meter-bar').forEach(function(bar) {
      bar.style.height = (10 + Math.random() * 50) + 'px';
      var h = parseInt(bar.style.height);
      bar.style.background = h > 45 ? 'var(--accent-red)' : h > 30 ? 'var(--accent-orange)' : 'var(--accent-green)';
    });
  }, 100);
}

function stopMeters() {
  clearInterval(meterInterval);
  meterInterval = null;
  document.querySelectorAll('.meter-bar').forEach(function(bar) {
    bar.style.height = '5px';
    bar.style.background = 'var(--accent-green)';
  });
}

/* ===== TRACK CONTROLS ===== */
function toggleMute(btn) { btn.classList.toggle('muted'); sfx('click'); }
function toggleSolo(btn) { btn.classList.toggle('soloed'); sfx('click'); }
function toggleArm(btn) {
  btn.classList.toggle('armed');
  if (btn.classList.contains('armed')) {
    btn.style.background = 'var(--accent-red)';
    btn.style.color = 'var(--bg)';
    btn.style.borderColor = 'var(--accent-red)';
  } else {
    btn.style.background = '';
    btn.style.color = '';
    btn.style.borderColor = '';
  }
  sfx('click');
}

/* ===== VIDEO ===== */
function toggleVideo() {
  var sec = document.getElementById('video-section');
  sec.classList.toggle('collapsed');
  document.getElementById('btn-video').classList.toggle('active', !sec.classList.contains('collapsed'));
}

/* Video drop zone */
document.addEventListener('DOMContentLoaded', function() {
  var vp = document.getElementById('video-placeholder');
  if (!vp) return;
  vp.addEventListener('click', function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function() { loadVideoFile(input.files[0]); };
    input.click();
  });
  vp.addEventListener('dragover', function(e) { e.preventDefault(); vp.style.background = 'rgba(6,182,212,0.1)'; });
  vp.addEventListener('dragleave', function() { vp.style.background = ''; });
  vp.addEventListener('drop', function(e) {
    e.preventDefault();
    vp.style.background = '';
    if (e.dataTransfer.files.length) loadVideoFile(e.dataTransfer.files[0]);
  });
});

function loadVideoFile(file) {
  if (!file || !file.type.startsWith('video/')) return;
  var video = document.getElementById('studio-video');
  var placeholder = document.getElementById('video-placeholder');
  video.src = URL.createObjectURL(file);
  video.style.display = '';
  placeholder.style.display = 'none';
  toast('Video loaded: ' + file.name);
}

/* ===== MUSIC ===== */
function toggleMusic() {
  var panel = document.getElementById('music-panel');
  var visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : '';
  document.querySelector('[onclick="toggleMusic()"]').classList.toggle('active', !visible);
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.volume = 0.5;
    audioEl.addEventListener('ended', function() { musicNext(); });
  }
}

function musicToggle() {
  if (!audioEl) toggleMusic();
  if (musicPlaying) {
    audioEl.pause();
    musicPlaying = false;
    document.getElementById('music-play-btn').innerHTML = '&#9654;';
    document.getElementById('music-eq').style.display = 'none';
  } else {
    if (!audioEl.src || audioEl.ended) {
      audioEl.src = MUSIC_TRACKS[musicIndex].url;
    }
    audioEl.play().catch(function() {});
    musicPlaying = true;
    document.getElementById('music-play-btn').innerHTML = '&#9616;&#9616;';
    document.getElementById('music-play-btn').classList.add('playing');
    document.getElementById('music-eq').style.display = '';
    document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  }
}

function musicNext() {
  musicIndex = (musicIndex + 1) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicPrev() {
  musicIndex = (musicIndex - 1 + MUSIC_TRACKS.length) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
}

function musicVolume(val) {
  if (audioEl) audioEl.volume = val / 100;
}

/* ===== PRESETS ===== */
function togglePresets() {
  var drawer = document.getElementById('presets-drawer');
  drawer.classList.toggle('open');
  document.getElementById('btn-presets').classList.toggle('active', drawer.classList.contains('open'));
}

function loadPreset(id) {
  var p = PRESETS[id];
  if (!p) return;
  pushUndo();
  // Clear timeline
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Set BPM
  bpm = p.bpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Add clips
  p.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    if (!track) return;
    var ex = null;
    for (var i = 0; i < EXERCISES.length; i++) {
      if (EXERCISES[i].name === c.name) { ex = EXERCISES[i]; break; }
    }
    if (!ex) return;
    var clip = createClipElement(ex, c.x, c.w || 80);
    track.appendChild(clip);
  });
  // Set faders
  if (p.faders) {
    Object.keys(p.faders).forEach(function(key) {
      var fader = document.querySelector('[data-fader="'+key+'"]');
      if (!fader) return;
      var v = p.faders[key];
      fader.querySelector('.fader-fill').style.height = v + '%';
      fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
      fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
    });
  }
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  toast('Preset loaded: ' + p.name);
}

/* ===== CLEAR ===== */
function clearTimeline() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats();
  saveSession();
  sfx('delete');
  toast('Timeline cleared');
}

/* ===== SAVE / LOAD ===== */
function saveSession() {
  try {
    var session = {bpm: bpm, clips: [], faders: {}, knobs: {}};
    document.querySelectorAll('.clip').forEach(function(clip) {
      session.clips.push({
        exerciseId: clip.dataset.exerciseId,
        track: clip.parentElement.dataset.track,
        left: clip.style.left,
        width: clip.style.width,
        sets: clip.dataset.sets,
        reps: clip.dataset.reps,
        tempo: clip.dataset.tempo,
        rest: clip.dataset.rest,
        rpe: clip.dataset.rpe
      });
    });
    document.querySelectorAll('[data-fader]').forEach(function(f) {
      var fill = f.querySelector('.fader-fill');
      session.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
    });
    localStorage.setItem('sms_session', JSON.stringify(session));
  } catch(e) {}
}

function loadSession() {
  try {
    var saved = localStorage.getItem('sms_session');
    if (!saved) return;
    var s = JSON.parse(saved);
    if (s.bpm) { bpm = s.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
    if (s.clips) {
      s.clips.forEach(function(c) {
        var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
        var ex = getExercise(c.exerciseId);
        if (!track || !ex) return;
        var clip = createClipElement(ex, c.left, c.width, {
          sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe
        });
        track.appendChild(clip);
      });
    }
    if (s.faders) {
      Object.keys(s.faders).forEach(function(key) {
        var fader = document.querySelector('[data-fader="'+key+'"]');
        if (!fader) return;
        var v = s.faders[key];
        fader.querySelector('.fader-fill').style.height = v + '%';
        fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
        fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
      });
    }
    updateStats();
  } catch(e) {}
}

/* ===== EXPORT ===== */
function exportWorkout() {
  var workout = {
    name: 'Saturno Movement Studio Export',
    timestamp: new Date().toISOString(),
    bpm: bpm,
    bpmMode: document.getElementById('bpm-mode').textContent,
    tracks: {}
  };
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    workout.tracks[t.id] = [];
  });
  document.querySelectorAll('.clip').forEach(function(clip) {
    var trackId = clip.parentElement.dataset.track;
    var ex = getExercise(clip.dataset.exerciseId);
    workout.tracks[trackId].push({
      movement: ex ? ex.name : clip.textContent,
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      startTime: parseInt(clip.style.left) / 80 * 15,
      duration: parseInt(clip.style.width) / 80 * 15,
      sets: parseInt(clip.dataset.sets) || 3,
      reps: parseInt(clip.dataset.reps) || 8,
      tempo: parseFloat(clip.dataset.tempo) || 3,
      rest: parseInt(clip.dataset.rest) || 60,
      rpe: parseInt(clip.dataset.rpe) || 7
    });
  });
  var blob = new Blob([JSON.stringify(workout, null, 2)], {type: 'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'workout-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('Workout exported');
}

/* ===== PRINT WORKOUT ===== */
function printWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.textContent,
      pattern: ex ? ex.pattern : '',
      sets: c.dataset.sets || 3,
      reps: c.dataset.reps || 8,
      tempo: c.dataset.tempo || 3,
      rest: c.dataset.rest || 60,
      rpe: c.dataset.rpe || 7,
      startTime: parseInt(c.style.left) / 80 * 15
    });
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Workout - Saturno Movement Studio</title>';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:24px;max-width:700px;margin:0 auto}';
  html += 'h1{font-size:18px;margin-bottom:4px}h2{font-size:14px;margin-top:16px;margin-bottom:8px;padding:4px 8px;background:#f0f0f0}';
  html += '.meta{font-size:11px;color:#666;margin-bottom:12px}table{width:100%;border-collapse:collapse;margin-bottom:8px;font-size:12px}';
  html += 'th,td{text-align:left;padding:4px 8px;border-bottom:1px solid #ddd}th{background:#f8f8f8;font-weight:600}';
  html += '.footer{margin-top:24px;font-size:10px;color:#999;text-align:center;border-top:1px solid #ddd;padding-top:8px}';
  html += '@media print{body{padding:12px}}</style></head><body>';
  html += '<h1>Saturno Movement Studio</h1>';
  html += '<div class="meta">' + bpm + ' BPM / ' + mode + ' / ' + new Date().toLocaleDateString() + '</div>';
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  Object.keys(groups).forEach(function(trackId) {
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.startTime - b.startTime; });
    html += '<h2>' + (trackNames[trackId] || trackId) + '</h2>';
    html += '<table><tr><th>#</th><th>Exercise</th><th>Sets</th><th>Reps</th><th>Tempo</th><th>Rest</th><th>RPE</th><th>Notes</th></tr>';
    exercises.forEach(function(ex, i) {
      html += '<tr><td>'+(i+1)+'</td><td>'+ex.name+'</td><td>'+ex.sets+'</td><td>'+ex.reps+'</td><td>'+ex.tempo+'s</td><td>'+ex.rest+'s</td><td>'+ex.rpe+'</td><td></td></tr>';
    });
    html += '</table>';
  });
  html += '<div class="footer">Generated by Saturno Movement Studio / saturnomovement.com</div>';
  html += '</body></html>';
  var win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.print();
}

/* ===== TOAST ===== */
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

/* ===== SAVED WORKOUTS ===== */
function getSavedWorkouts() {
  try { return JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) { return []; }
}

function saveNamedWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var name = prompt('Workout name:');
  if (!name || !name.trim()) return;
  var workout = {
    name: name.trim(),
    created: new Date().toISOString(),
    bpm: bpm,
    clipCount: clips.length,
    state: captureState()
  };
  var saved = getSavedWorkouts();
  saved.unshift(workout);
  if (saved.length > 20) saved = saved.slice(0, 20);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  toast('Saved: ' + name.trim());
}

function showSavedWorkouts() {
  var saved = getSavedWorkouts();
  var list = document.getElementById('saved-list');
  if (saved.length === 0) {
    list.innerHTML = '<div class="saved-empty">No saved workouts yet. Use SAVE AS to save one.</div>';
  } else {
    var html = '';
    saved.forEach(function(w, i) {
      var date = new Date(w.created).toLocaleDateString();
      html += '<div class="saved-item" onclick="loadSavedWorkout('+i+')">';
      html += '<span class="saved-item-delete" onclick="event.stopPropagation();deleteSavedWorkout('+i+')">delete</span>';
      html += '<div class="saved-item-name">'+w.name+'</div>';
      html += '<div class="saved-item-info">'+w.clipCount+' clips / '+w.bpm+' BPM / '+date+'</div>';
      html += '</div>';
    });
    list.innerHTML = html;
  }
  document.getElementById('saved-modal').classList.add('open');
}

function closeSavedWorkouts() {
  document.getElementById('saved-modal').classList.remove('open');
}

function loadSavedWorkout(index) {
  var saved = getSavedWorkouts();
  if (!saved[index]) return;
  pushUndo();
  var state = JSON.parse(saved[index].state);
  restoreState(state);
  closeSavedWorkouts();
  toast('Loaded: ' + saved[index].name);
}

function deleteSavedWorkout(index) {
  var saved = getSavedWorkouts();
  var name = saved[index] ? saved[index].name : '';
  saved.splice(index, 1);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  showSavedWorkouts();
  toast('Deleted: ' + name);
}

/* Close modal on overlay click */
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('saved-modal');
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeSavedWorkouts();
  });
});

/* ===== UNDO / REDO ===== */
function captureState() {
  var state = {bpm: bpm, clips: []};
  document.querySelectorAll('.clip').forEach(function(clip) {
    state.clips.push({
      exerciseId: clip.dataset.exerciseId,
      track: clip.parentElement.dataset.track,
      left: clip.style.left,
      width: clip.style.width,
      sets: clip.dataset.sets,
      reps: clip.dataset.reps,
      tempo: clip.dataset.tempo,
      rest: clip.dataset.rest,
      rpe: clip.dataset.rpe
    });
  });
  return JSON.stringify(state);
}

function pushUndo() {
  var state = captureState();
  if (undoStack.length > 0 && undoStack[undoStack.length - 1] === state) return;
  undoStack.push(state);
  if (undoStack.length > maxUndo) undoStack.shift();
  redoStack = [];
}

function undo() {
  if (undoStack.length === 0) { toast('Nothing to undo'); return; }
  redoStack.push(captureState());
  var state = JSON.parse(undoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Undo');
}

function redo() {
  if (redoStack.length === 0) { toast('Nothing to redo'); return; }
  undoStack.push(captureState());
  var state = JSON.parse(redoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Redo');
}

function restoreState(state) {
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  if (state.bpm) { bpm = state.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
  state.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    var ex = getExercise(c.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, c.left, c.width, {
      sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe
    });
    track.appendChild(clip);
  });
  updateStats();
  saveSession();
}

/* ===== DUPLICATE CLIP ===== */
function duplicateClip() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var track = selectedClip.parentElement;
  var newLeft = parseInt(selectedClip.style.left) + parseInt(selectedClip.style.width) + 4;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe
  });
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  sfx('drop');
  toast('Duplicated: ' + ex.name);
}

/* ===== SNAP TO GRID ===== */
var snapEnabled = false;
var SNAP_SIZE = 80; // pixels per grid unit (15 seconds)

function toggleSnap() {
  snapEnabled = !snapEnabled;
  var btn = document.getElementById('btn-snap');
  if (btn) btn.classList.toggle('active', snapEnabled);
  sfx('snap');
  toast(snapEnabled ? 'Snap ON' : 'Snap OFF');
}

function snapValue(val) {
  if (!snapEnabled) return val;
  return Math.round(val / SNAP_SIZE) * SNAP_SIZE;
}

/* ===== CONTEXT MENU ===== */
var ctxClip = null, ctxExercise = null;
function showClipContextMenu(x, y, clip, exercise) {
  ctxClip = clip;
  ctxExercise = exercise;
  var menu = document.getElementById('clip-context-menu');
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.add('open');
  // Adjust if overflows viewport
  var rect = menu.getBoundingClientRect();
  if (rect.right > window.innerWidth) menu.style.left = (x - rect.width) + 'px';
  if (rect.bottom > window.innerHeight) menu.style.top = (y - rect.height) + 'px';
}

function hideContextMenu() {
  document.getElementById('clip-context-menu').classList.remove('open');
  ctxClip = null;
  ctxExercise = null;
}

document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.clip-context-menu')) hideContextMenu();
  });
  document.getElementById('clip-context-menu').addEventListener('click', function(e) {
    var item = e.target.closest('.ctx-item');
    if (!item || !ctxClip) return;
    var action = item.dataset.action;
    if (action === 'duplicate') {
      selectClipEl(ctxClip);
      duplicateClip();
    } else if (action === 'inspect') {
      selectClipEl(ctxClip);
    } else if (action === 'snap-start') {
      pushUndo();
      ctxClip.style.left = '0px';
      saveSession(); updateStats();
      toast('Snapped to start');
    } else if (action === 'snap-next') {
      pushUndo();
      var track = ctxClip.parentElement;
      var clips = track.querySelectorAll('.clip');
      var maxRight = 0;
      clips.forEach(function(c) {
        if (c === ctxClip) return;
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      ctxClip.style.left = (maxRight + 2) + 'px';
      saveSession(); updateStats();
      toast('Snapped after previous');
    } else if (action === 'delete') {
      pushUndo();
      ctxClip.remove();
      if (selectedClip === ctxClip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      sfx('delete');
      toast('Clip deleted');
    }
    hideContextMenu();
  });
});

/* ===== PLAYHEAD ANIMATION ===== */
function updatePlayheadClass() {
  var ph = document.getElementById('playhead');
  if (isPlaying) { ph.classList.add('playing'); } else { ph.classList.remove('playing'); }
}

/* ===== SHORTCUTS OVERLAY ===== */
function toggleShortcuts() {
  var overlay = document.getElementById('shortcuts-overlay');
  overlay.classList.toggle('open');
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'Escape') {
    stopPlayback();
    closeSavedWorkouts();
    var so = document.getElementById('shortcuts-overlay');
    if (so.classList.contains('open')) so.classList.remove('open');
  }
  if (e.key === '?' || e.code === 'Slash') {
    toggleShortcuts();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyZ') {
    e.preventDefault();
    if (e.shiftKey) { redo(); } else { undo(); }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyD') {
    e.preventDefault();
    duplicateClip();
    return;
  }
  if (e.code === 'KeyS' && !e.metaKey && !e.ctrlKey) {
    toggleSnap();
  }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    if (selectedClip) {
      pushUndo();
      selectedClip.remove();
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
      updateStats(); saveSession();
      sfx('delete');
      toast('Clip deleted');
    }
  }
});
</script>
</body>
</html>
