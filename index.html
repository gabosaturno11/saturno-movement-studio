<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="color-scheme" content="dark">
<title>SATURNO MOVEMENT STUDIO - The Ableton of Movement</title>
<meta name="description" content="The Ableton of Movement. DAW-style workout composition with drag-drop exercises, BPM training modes, and music sync.">
<meta property="og:title" content="Saturno Movement Studio">
<meta property="og:description" content="The Ableton of Movement. Compose workouts like music.">
<meta property="og:type" content="website">
<link rel="icon" href="assets/planet-logo.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* SATURNO FORGE DESIGN LOCK V3.0 — Endel x Craft x Logic Pro */
* { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #050711;
  --bg-deep: #030509;
  --surface: #0a0e1a;
  --surface2: #0d1117;
  --surface3: #111827;
  --border: rgba(255,255,255,0.06);
  --border-hover: rgba(255,255,255,0.12);
  --border-active: #3b82f6;
  --text: #e2e8f0;
  --text-bright: #ffffff;
  --text-secondary: #8b94a5;
  --muted: #64748b;
  --micro: #475569;
  --accent: #d97706;
  --accent-dim: rgba(217, 119, 6, 0.15);
  --blue: #3b82f6;
  --purple: #8b5cf6;
  --success: #22c55e;
  --error: #ef4444;
  --accent-cyan: #06b6d4;
  --accent-blue: #3b82f6;
  --accent-purple: #8b5cf6;
  --accent-green: #22c55e;
  --accent-orange: #f97316;
  --accent-red: #ef4444;
  --accent-pink: #ec4899;
  --gradient-titan: linear-gradient(135deg, #06b6d4 0%, #3b82f6 35%, #8b5cf6 65%, #6d28d9 100%);
  --gradient-header: linear-gradient(180deg, #0f1219 0%, #0a0e1a 100%);
  --gradient-cosmic: radial-gradient(ellipse at 50% 0%, rgba(6,182,212,0.04) 0%, rgba(59,130,246,0.03) 30%, transparent 60%);
  --gradient-cosmic-surface: radial-gradient(ellipse at 50% 0%, rgba(6,182,212,0.03) 0%, transparent 50%);
  --gradient-cosmic-panel: linear-gradient(180deg, rgba(6,182,212,0.02) 0%, transparent 100%);
  --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-purple: 0 0 20px rgba(139, 92, 246, 0.3);
  --glow-cyan: 0 0 20px rgba(6, 182, 212, 0.3);
  --glow-subtle: 0 0 1px rgba(59, 130, 246, 0.15);
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 8px;
  --glass: rgba(255,255,255,0.03);
  --glass-border: rgba(255,255,255,0.05);
  --shadow-soft: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-deep: 0 8px 32px rgba(0,0,0,0.4);
  --transition-fast: 0.12s;
  --transition-normal: 0.2s;
  --transition-slow: 0.3s;
}

body {
  background: var(--bg);
  background-image: var(--gradient-cosmic);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  height: 100vh;
  overflow: hidden;
}

/* Layout */
.app { display: grid; grid-template-rows: 40px 1fr 24px; height: 100vh; }

/* ===== HEADER — Endel/Craft Toolbar ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  height: 40px;
  border-bottom: 1px solid var(--border);
  background: var(--gradient-header);
  position: relative;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.header::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(6,182,212,0.15) 25%, rgba(59,130,246,0.2) 50%, rgba(139,92,246,0.15) 75%, transparent 95%);
}
/* Global progress bar — thin line at bottom of header showing playback position */
.header-progress {
  position: absolute; bottom: 0; left: 0;
  height: 2px; width: 0%;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
  z-index: 5;
  transition: width 0.1s linear;
  opacity: 0;
}
.header-progress.active { opacity: 1; }
.logo { display: flex; align-items: center; gap: 8px; }
.logo-icon {
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
}
.logo-icon img {
  width: 16px; height: 16px; filter: brightness(0) invert(1); opacity: 0.8;
  transition: filter 0.3s, opacity 0.3s;
}
.logo:hover .logo-icon img {
  opacity: 1;
  filter: brightness(0) invert(1) drop-shadow(0 0 4px rgba(59, 130, 246, 0.5));
}
.logo-text {
  font-size: 11px; font-weight: 700;
  letter-spacing: 0.08em; color: var(--text);
}
.logo-sub {
  font-size: 8px; color: var(--micro); margin-top: 0;
  text-transform: uppercase; letter-spacing: 0.15em;
}
.header-nav { display: flex; gap: 1px; align-items: center; }
.nav-btn {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 5px 10px; font-size: 9px; font-family: 'Sora', sans-serif;
  background: transparent; border: none;
  color: var(--muted); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.2s;
  height: 26px;
}
.nav-btn:hover { color: var(--text); }
.nav-btn.active {
  color: var(--text); font-weight: 600;
}
.header-nav .nav-sep {
  width: 1px; height: 16px; background: var(--border); margin: 0 4px;
}

/* ===== MAIN 3-PANEL ===== */
.main { display: grid; grid-template-columns: 220px 3px 1fr 280px; overflow: hidden; }

/* ===== LEFT PANEL: MOVEMENT LIBRARY ===== */
.panel-left {
  background: var(--surface);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.panel-header {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro);
  display: flex; justify-content: space-between; align-items: center;
  height: 32px;
  background: rgba(10,14,26,0.6);
  position: relative;
}
.panel-header::after {
  content: '';
  position: absolute; bottom: 0; left: 10%; right: 10%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
}
.panel-header span:last-child {
  font-size: 8px; color: var(--micro);
  background: rgba(3,5,9,0.4); padding: 1px 5px;
  border-radius: var(--radius-sm);
}
.lib-search {
  width: calc(100% - 16px); margin: 6px 8px;
  padding: 6px 10px; font-size: 10px; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border); color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
  border-radius: var(--radius-md);
}
.lib-search:focus { outline: none; border-color: rgba(59,130,246,0.3); box-shadow: 0 0 12px rgba(59,130,246,0.08); }
.lib-search::placeholder { color: var(--micro); }
.movement-category { border-bottom: 1px solid rgba(255,255,255,0.04); }
.category-header {
  padding: 7px 12px; font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s;
}
.category-header:hover { background: var(--glass); }
.category-header .arrow { font-size: 7px; transition: transform 0.15s; color: var(--micro); }
.category-header.collapsed .arrow { transform: rotate(-90deg); }
.category-color { width: 6px; height: 6px; border-radius: 1px; }
.movement-list { padding: 2px 6px 6px; }
.movement-list.hidden { display: none; }
.movement-item {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 8px; margin-bottom: 1px;
  font-size: 10px;
  background: transparent;
  border: none;
  border-left: 2px solid transparent;
  cursor: grab;
  transition: background 0.15s, border-color 0.15s, transform 0.1s;
  border-radius: var(--radius-sm);
}
.movement-item:hover {
  background: var(--glass);
  border-left-color: rgba(255,255,255,0.15);
}
.movement-item:active {
  cursor: grabbing;
  background: rgba(59,130,246,0.06);
  border-left-color: rgba(59,130,246,0.4);
  transform: scale(0.98);
}
.movement-item .mv-icon {
  width: 18px; height: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; flex-shrink: 0;
  border-radius: 2px;
}
.movement-item .mv-stage {
  font-size: 7px; color: var(--micro); margin-left: auto;
  text-transform: uppercase; letter-spacing: 0.08em;
}
.movement-item .mv-detail {
  display: none; position: absolute; left: 100%; top: 0;
  background: var(--surface2); border: 1px solid var(--border);
  padding: 6px 10px; white-space: nowrap; z-index: 100;
  font-size: 8px; color: var(--text-secondary);
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  border-radius: 2px; pointer-events: none;
}
.movement-item { position: relative; }
.movement-item:hover .mv-detail { display: block; }
/* Clip stage dots */
.clip-rpe-badge {
  position: absolute; bottom: 2px; right: 4px;
  font-size: 7px; font-weight: 600; color: rgba(255,255,255,0.35);
  z-index: 2; pointer-events: none; line-height: 1;
}
.clip-stage-dots {
  position: absolute; top: 3px; right: 6px;
  display: flex; gap: 2px; z-index: 2;
}
.clip-stage-dot {
  width: 3px; height: 3px; border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transition: background 0.15s, box-shadow 0.15s;
}
.clip-stage-dot.filled { background: rgba(255,255,255,0.85); box-shadow: 0 0 4px rgba(255,255,255,0.3); }

/* ===== CENTER PANEL ===== */
.panel-center { display: flex; flex-direction: column; overflow: hidden; }

/* Transport Bar — Endel/Craft Style */
.transport {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  background: linear-gradient(180deg, rgba(15,18,25,0.95) 0%, rgba(10,14,26,0.98) 100%);
  border-bottom: 1px solid var(--border);
  height: 44px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.transport-buttons { display: flex; gap: 1px; }
.transport-btn {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: var(--muted); cursor: pointer; font-size: 12px;
  font-family: 'Sora', sans-serif;
  transition: color 0.2s, background 0.2s, border-color 0.2s, box-shadow 0.2s;
}
.transport-btn:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
.transport-btn:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
.transport-btn + .transport-btn { border-left: none; }
.transport-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }
.transport-btn.active { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); color: var(--blue); box-shadow: 0 0 12px rgba(59,130,246,0.15); }
.transport-btn.rec.active { background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); color: var(--accent-red); box-shadow: 0 0 12px rgba(239,68,68,0.15); }
.transport-sep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }

/* BPM breathing pulse — syncs with current tempo */
@keyframes bpmBreath {
  0%, 100% { opacity: 0; }
  15% { opacity: 1; }
}
.bpm-pulse {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--accent-green);
  box-shadow: 0 0 6px rgba(34,197,94,0.4);
  animation: bpmBreath var(--bpm-duration, 0.5s) ease-out infinite;
  margin-left: 2px;
}
.time-display {
  font-family: 'Sora', sans-serif;
  font-size: 18px; font-weight: 700;
  color: var(--accent-green); padding: 0 10px;
  letter-spacing: 0.02em;
  font-variant-numeric: tabular-nums;
  min-width: 130px;
  display: flex; align-items: center;
  background: rgba(3,5,9,0.6);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  height: 30px;
  padding: 0 8px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
}
.td-seg {
  text-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
}
.td-colon { color: var(--micro); font-size: 14px; margin: 0 1px; }
.td-ms { color: var(--muted); font-size: 14px; }
.bpm-section { display: flex; align-items: center; gap: 4px; margin-left: auto; }
.bpm-label {
  font-size: 8px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.1em;
}
.bpm-input {
  width: 48px; padding: 4px 6px; text-align: center;
  font-size: 13px; font-weight: 600; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.6); border: 1px solid var(--glass-border); color: var(--accent-orange);
  transition: border-color 0.15s;
  border-radius: var(--radius-sm);
}
.bpm-input:focus { outline: none; border-color: var(--accent-orange); box-shadow: 0 0 8px rgba(249,115,22,0.15); }
@keyframes bpmFlash {
  0% { box-shadow: 0 0 12px rgba(249,115,22,0.3), inset 0 0 4px rgba(249,115,22,0.1); }
  100% { box-shadow: none; }
}
.bpm-input.flash { animation: bpmFlash 0.4s ease-out; }
.bpm-mode {
  font-size: 8px; padding: 3px 8px;
  background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.15);
  color: var(--blue);
  text-transform: uppercase; letter-spacing: 0.1em;
  font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm);
}
.tempo-link {
  font-size: 8px; color: var(--muted); cursor: pointer;
  padding: 3px 6px; border: 1px solid transparent;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  border-radius: var(--radius-sm);
}
.tempo-link:hover { color: var(--accent-orange); border-color: rgba(249,115,22,0.2); background: rgba(249,115,22,0.05); }
.tempo-link.active { background: rgba(249,115,22,0.12); border-color: rgba(249,115,22,0.25); color: var(--accent-orange); box-shadow: 0 0 8px rgba(249,115,22,0.1); }

/* Transport state pill — colored indicator for PLAY/STOP/REC */
.transport-state {
  font-size: 7px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.15em;
  min-width: 34px; text-align: center;
  padding: 2px 6px; border-radius: var(--radius-sm);
  transition: color 0.15s, background 0.15s;
}
.transport-state.state-stop { color: var(--micro); background: transparent; }
.transport-state.state-play { color: var(--accent-green); background: rgba(34,197,94,0.08); }
.transport-state.state-rec { color: var(--accent-red); background: rgba(239,68,68,0.08); }

/* Video Section — Premiere Pro Source Monitor */
.video-section {
  background: var(--bg-deep);
  border-bottom: 1px solid var(--border);
  position: relative; min-height: 0; flex-shrink: 1; overflow: hidden;
}
.video-section.collapsed { height: 0; min-height: 0; border: none; }
.video-placeholder {
  display: flex; align-items: center; justify-content: center;
  height: 100%; min-height: 120px;
  color: var(--micro); font-size: 9px;
  flex-direction: column; gap: 6px;
  text-transform: uppercase; letter-spacing: 0.1em;
  border: 1px dashed rgba(255,255,255,0.06);
  margin: 6px;
  border-radius: var(--radius-md);
}
.video-placeholder .vp-icon { font-size: 20px; opacity: 0.2; }
.video-toggle {
  position: absolute; top: 4px; right: 4px;
  width: 18px; height: 18px;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer; font-size: 9px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.video-toggle:hover { color: var(--text); }

/* Mini-map overview */
.timeline-minimap {
  height: 16px;
  background: rgba(3,5,9,0.6);
  border-bottom: 1px solid rgba(255,255,255,0.03);
  position: sticky; top: 22px; z-index: 9;
  overflow: hidden; cursor: pointer;
}
.minimap-viewport {
  position: absolute; top: 0; bottom: 0;
  background: rgba(59, 130, 246, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.2);
  pointer-events: none;
  min-width: 20px;
}
.minimap-clip {
  position: absolute; height: 3px;
  border-radius: 1px; opacity: 0.7;
}

/* Timeline — Logic Pro Grid */
.timeline-container {
  flex: 1; overflow: auto; background: var(--bg-deep);
  position: relative;
}
.timeline-container::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 60px;
  background: var(--gradient-cosmic-panel);
  pointer-events: none; z-index: 0;
}
.timeline-ruler {
  height: 22px;
  background: rgba(10,14,26,0.8);
  border-bottom: 1px solid var(--border);
  display: flex; position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(4px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 1px 0 rgba(255,255,255,0.02);
  -webkit-backdrop-filter: blur(4px);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.ruler-mark {
  flex: 0 0 80px;
  border-right: 1px solid rgba(255,255,255,0.04);
  padding: 3px 8px; font-size: 9px;
  color: var(--micro);
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.05em;
}
.ruler-mark:first-child { flex: 0 0 100px; }
.ruler-mark:nth-child(4n+1) { color: var(--muted); }
.ruler-downbeat {
  border-right-color: rgba(255,255,255,0.08);
  color: var(--text-secondary);
}
.timeline-tracks { min-height: 200px; position: relative; }
.track {
  height: 60px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  display: flex;
  background: var(--bg-deep);
  transition: background 0.15s, height 0.2s ease;
  overflow: hidden;
}
.track.track-collapsed {
  height: 24px;
}
.track.track-collapsed .track-controls,
.track.track-collapsed .track-info,
.track.track-collapsed .track-clip-count { opacity: 0; pointer-events: none; }
.track.track-collapsed .clip { height: 18px; top: 3px; font-size: 7px; padding: 1px 4px 0; }
.track.track-collapsed .clip canvas { display: none; }
.track.track-collapsed .clip .beat-markers { display: none; }
.track.track-collapsed .clip .clip-info { display: none; }
.track.track-collapsed .clip .clip-progress { display: none; }
.track.track-collapsed .clip .clip-fade { display: none; }
.track.track-collapsed .clip .clip-stage-dots { display: none; }
.track.track-collapsed .clip .clip-rpe-badge { display: none; }
.track.track-collapsed .clip .clip-resize,
.track.track-collapsed .clip .clip-resize-left { display: none; }
.track:hover { background: rgba(10,14,26,0.8); }
.track:nth-child(even) { background: rgba(10,14,26,0.3); }
.track:nth-child(even):hover { background: rgba(10,14,26,0.6); }
/* Track grip dots (reorder indicator) — 6-dot matrix like Ableton */
.track-grip {
  display: grid; grid-template-columns: 2px 2px; gap: 2px;
  position: absolute; left: 4px; top: 50%;
  transform: translateY(-50%);
  opacity: 0; transition: opacity 0.15s;
  cursor: grab;
}
.track-header:hover .track-grip { opacity: 0.4; }
.track-grip:active { cursor: grabbing; opacity: 0.7 !important; }
.track-grip-dot {
  width: 2px; height: 2px;
  background: var(--muted);
  border-radius: 50%;
}
.track-header {
  width: 100px;
  background: rgba(10,14,26,0.6);
  border-right: 1px solid rgba(255,255,255,0.04);
  padding: 6px 8px;
  display: flex; flex-direction: column; justify-content: center;
  flex-shrink: 0;
  position: relative;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.track-header::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px;
}
.track[data-track="music"] .track-header::before { background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.3)); }
.track[data-track="push"] .track-header::before { background: linear-gradient(180deg, var(--accent-blue), rgba(59,130,246,0.3)); }
.track[data-track="pull"] .track-header::before { background: linear-gradient(180deg, var(--accent-purple), rgba(139,92,246,0.3)); }
.track[data-track="core"] .track-header::before { background: linear-gradient(180deg, var(--accent-orange), rgba(249,115,22,0.3)); }
.track[data-track="legs"] .track-header::before { background: linear-gradient(180deg, var(--accent-green), rgba(34,197,94,0.3)); }
.track[data-track="skills"] .track-header::before { background: linear-gradient(180deg, var(--accent-cyan), rgba(6,182,212,0.3)); }
.track-name {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-info {
  font-size: 7px; color: var(--micro); margin-top: 1px;
  text-transform: uppercase; letter-spacing: 0.1em;
  padding-left: 6px;
}
.track-controls { display: flex; gap: 1px; margin-top: 4px; padding-left: 6px; }
.track-btn {
  width: 18px; height: 14px; font-size: 7px; font-weight: 700;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.15s;
  border-radius: 0;
}
.track-btn:hover { color: var(--text); }
.track-btn.muted { color: var(--accent-orange); }
.track-btn.soloed { color: var(--accent-cyan); }
.track-content {
  flex: 1; position: relative; min-width: 800px;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
}
/* 16th note grid subdivision — visible at higher zoom */
.track-content.grid-16th {
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 4px, rgba(255,255,255,0.01) 4px, rgba(255,255,255,0.01) 5px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
}
.track-content.grid-hidden { background: none !important; }
.track-content.drag-over {
  background:
    linear-gradient(90deg, rgba(59, 130, 246, 0.06) 0%, transparent 50%),
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(255,255,255,0.02) 19px, rgba(255,255,255,0.02) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(255,255,255,0.04) 79px, rgba(255,255,255,0.04) 80px);
  box-shadow: inset 0 0 20px rgba(59,130,246,0.04);
}
.track-clip-count {
  font-size: 7px; color: var(--micro);
  background: rgba(3,5,9,0.4);
  padding: 0 4px; border-radius: var(--radius-sm);
  margin-top: 2px; display: inline-block;
  padding-left: 6px;
}

/* Track header tiny VU meter — 5 dots showing activity level */
.track-vu {
  display: flex; gap: 1px; position: absolute; right: 6px; top: 50%;
  transform: translateY(-50%);
}
.track-vu-dot {
  width: 2px; height: 6px; border-radius: 1px;
  background: rgba(255,255,255,0.06);
  transition: background 0.08s, height 0.08s;
}
.track-vu-dot.on-low { background: var(--accent-green); }
.track-vu-dot.on-mid { background: var(--accent-orange); }
.track-vu-dot.on-high { background: var(--accent-red); }

/* Clips — Logic Pro Audio Region Style */
@keyframes clipInsert {
  0% { transform: scaleX(0); opacity: 0; }
  100% { transform: scaleX(1); opacity: 1; }
}
.clip {
  position: absolute; height: 44px; top: 8px;
  border: 1px solid rgba(255,255,255,0.06);
  border-top: 2px solid;
  border-radius: var(--radius-sm);
  cursor: move; display: flex; align-items: flex-start;
  padding: 3px 8px 0; font-size: 9px; font-weight: 600;
  user-select: none; overflow: hidden; white-space: nowrap;
  transition: box-shadow 0.2s, opacity 0.15s, border-color 0.15s, transform 0.15s, filter 0.15s;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.04), var(--shadow-soft);
  animation: clipInsert 0.15s ease-out;
  transform-origin: left center;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
}
.clip::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0;
  height: 8px;
  background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.25) 100%);
  pointer-events: none;
}
.clip canvas.clip-waveform {
  position: absolute; bottom: 2px; left: 4px; right: 4px;
  height: 20px; width: calc(100% - 8px);
  pointer-events: none;
}
.clip .beat-markers {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
}
.clip .beat-markers span {
  position: absolute; top: 0; bottom: 0; width: 1px;
  background: rgba(255,255,255,0.06);
}
/* Clip fade handles */
.clip .clip-fade {
  position: absolute; top: 0; width: 0; height: 100%;
  cursor: ew-resize; z-index: 2;
}
.clip .clip-fade-in { left: 0; }
.clip .clip-fade-out { right: 0; }
.clip .clip-fade::after {
  content: '';
  position: absolute; top: 0;
  width: 0; height: 0;
  border-style: solid;
  opacity: 0;
  transition: opacity 0.15s;
}
.clip:hover .clip-fade-in::after {
  opacity: 0.4;
  border-width: 44px 12px 0 0;
  border-color: rgba(0,0,0,0.5) transparent transparent transparent;
  left: 0; top: 0;
}
.clip:hover .clip-fade-out::after {
  opacity: 0.4;
  border-width: 0 0 44px 12px;
  border-color: transparent transparent rgba(0,0,0,0.5) transparent;
  right: 0; bottom: 0; top: auto;
  position: absolute;
}
.clip .clip-fade-in.has-fade::after {
  opacity: 0.5 !important;
}
.clip .clip-fade-out.has-fade::after {
  opacity: 0.5 !important;
}
/* Muted track clips */
.track.track-muted .clip { opacity: 0.3; filter: grayscale(0.6); }
.clip:hover {
  box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 4px 16px rgba(0,0,0,0.3);
  border-color: rgba(255,255,255,0.12);
  transform: translateY(-1px);
  filter: brightness(1.04);
}
.clip.clip-dragging {
  transform: translateY(-2px) scale(1.01);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.15), 0 8px 24px rgba(0,0,0,0.4);
  filter: brightness(1.08);
  z-index: 100;
}
.clip.selected {
  border-color: rgba(255,255,255,0.5);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.3), 0 0 16px rgba(255,255,255,0.08), 0 0 24px rgba(59,130,246,0.06);
  filter: brightness(1.08);
  animation: clip-select-flash 0.3s ease-out;
}
@keyframes clip-select-flash {
  0% { box-shadow: 0 0 0 2px rgba(59,130,246,0.6), 0 0 20px rgba(59,130,246,0.3); }
  100% { box-shadow: 0 0 0 1px rgba(255,255,255,0.3), 0 0 16px rgba(255,255,255,0.08), 0 0 24px rgba(59,130,246,0.06); }
}
.clip .clip-name {
  overflow: hidden; white-space: nowrap;
  max-width: calc(100% - 30px);
  display: inline-block; vertical-align: top;
  -webkit-mask-image: linear-gradient(90deg, #000 70%, transparent 100%);
  mask-image: linear-gradient(90deg, #000 70%, transparent 100%);
}
.clip .clip-info {
  font-size: 7px; opacity: 0.5; margin-left: 4px;
  text-transform: uppercase; letter-spacing: 0.05em;
  font-weight: 400;
}
.clip.clip-playing {
  box-shadow: inset 0 -1px 0 rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.06),
              0 0 12px rgba(255,255,255,0.15), 0 0 4px currentColor;
  border-color: rgba(255,255,255,0.2);
  filter: brightness(1.12);
}
.clip.clip-locked { opacity: 0.7; cursor: default; }
.clip.clip-locked .clip-resize, .clip.clip-locked .clip-resize-left { display: none; }
.clip.clip-locked::before { content: ''; position: absolute; top: 2px; left: 2px; width: 6px; height: 6px; border: 1px solid rgba(255,255,255,0.3); border-radius: 1px; z-index: 3; }
/* Playback progress overlay — subtle fill from left to show elapsed */
.clip-progress-fill {
  position: absolute; top: 0; left: 0; bottom: 0;
  background: rgba(255,255,255,0.02);
  pointer-events: none; z-index: 0;
  width: 0%; transition: width 0.08s linear;
}
.clip-resize {
  position: absolute; right: 0; top: 0; bottom: 0;
  width: 5px; cursor: ew-resize;
  background: transparent;
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize, .clip:hover .clip-resize-left { opacity: 1; background: rgba(255,255,255,0.2); }
.clip-resize:hover, .clip-resize-left:hover { background: rgba(255,255,255,0.4) !important; }
.clip-resize::before {
  content: ''; position: absolute;
  top: 50%; transform: translateY(-50%);
  right: 1px; width: 1px; height: 12px;
  background: rgba(255,255,255,0.4);
  box-shadow: -2px 0 0 rgba(255,255,255,0.4);
  opacity: 0; transition: opacity 0.1s;
}
.clip:hover .clip-resize::before { opacity: 1; }
.playhead {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: var(--text-bright);
  box-shadow: 0 0 8px rgba(255,255,255,0.4), 1px 0 0 rgba(255,255,255,0.08), -1px 0 0 rgba(255,255,255,0.08);
  z-index: 20; pointer-events: none; left: 100px;
}
.playhead.playing {
  box-shadow: 0 0 12px rgba(59,130,246,0.5), 0 0 4px rgba(255,255,255,0.3);
  background: #60a5fa;
  /* Gradient trail behind the playhead */
  border-image: linear-gradient(to right, rgba(59,130,246,0.02), rgba(59,130,246,0.15), transparent) 1;
}
.playhead.playing::after {
  content: '';
  position: absolute;
  width: 60px; left: -60px; height: 100%; bottom: auto; top: 0;
  background: linear-gradient(to right, transparent, rgba(59,130,246,0.06));
  border-radius: 0; opacity: 1;
  pointer-events: none;
}
.playhead::before {
  content: '';
  position: absolute; top: -2px; left: -5px;
  width: 11px; height: 9px;
  background: var(--text-bright);
  clip-path: polygon(50% 100%, 0 0, 100% 0);
}
.playhead.playing::before {
  background: #60a5fa;
}
.playhead::after {
  content: '';
  position: absolute; bottom: 0; left: -2px;
  width: 5px; height: 3px;
  background: var(--text-bright);
  border-radius: 3px 3px 0 0;
  opacity: 0.5;
}

/* Armed track pulsing left border */
@keyframes armPulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}
.track-btn.armed {
  background: var(--error); color: var(--bg); border-color: var(--error);
  animation: armPulse 1.5s ease-in-out infinite;
}
/* Track-level armed glow — entire track gets subtle red tint */
.track:has(.track-btn.armed) .track-header {
  background: rgba(239,68,68,0.04);
  border-left: 2px solid rgba(239,68,68,0.3);
}
.track:has(.track-btn.armed) .track-content {
  background: rgba(239,68,68,0.01);
}

/* Metronome active pulse */
@keyframes metroPulse {
  0%, 100% { background: var(--accent-orange); }
  50% { background: var(--accent-green); }
}
.transport-btn.metro-active {
  background: var(--accent-orange); color: var(--bg); border-color: var(--accent-orange);
}

/* ===== RIGHT PANEL: MIXER + INSPECTOR ===== */
.panel-right {
  background: var(--surface);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  display: flex; flex-direction: column;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.mixer-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.mixer-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
}
.mixer-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--micro); margin-bottom: 10px;
}

/* Faders — Channel Strip Style */
.fader-group { display: flex; gap: 10px; justify-content: center; }
.fader { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.fader-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.12em; color: var(--micro);
  text-align: center; max-width: 40px;
}
.fader-track {
  width: 6px; height: 80px;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border);
  position: relative; cursor: pointer;
  border-radius: var(--radius-sm);
}
.fader-fill {
  position: absolute; bottom: 0; left: 0; right: 0;
  background: var(--gradient-titan);
  transition: height 0.1s;
  border-radius: 0 0 3px 3px;
}
.fader-handle {
  position: absolute; left: -5px; right: -5px;
  height: 12px;
  background: linear-gradient(180deg, rgba(100,116,139,0.6) 0%, rgba(45,55,72,0.6) 100%);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  cursor: grab;
  transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.4);
}
.fader-handle:hover { background: linear-gradient(180deg, rgba(100,116,139,0.8) 0%, rgba(71,85,105,0.7) 100%); border-color: rgba(255,255,255,0.15); box-shadow: 0 2px 8px rgba(0,0,0,0.5); }
.fader-value {
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--muted); font-weight: 500;
  font-variant-numeric: tabular-nums;
}

/* Knobs — Pro Tools Style */
.knob-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.knob { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.knob-dial {
  width: 34px; height: 34px;
  background: conic-gradient(
    from 225deg,
    var(--accent-cyan) 0deg,
    var(--blue) calc(var(--knob-value, 0.5) * 135deg),
    var(--accent-purple) calc(var(--knob-value, 0.5) * 270deg),
    rgba(255,255,255,0.04) calc(var(--knob-value, 0.5) * 270deg),
    rgba(255,255,255,0.04) 270deg
  );
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 50%; position: relative; cursor: pointer;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.knob-dial:hover { border-color: rgba(59,130,246,0.3); box-shadow: 0 0 12px rgba(59,130,246,0.1); }
.knob-dial::before {
  content: '';
  position: absolute; top: 50%; left: 50%;
  width: 22px; height: 22px;
  background: radial-gradient(circle, rgba(17,24,39,0.9) 0%, rgba(3,5,9,0.9) 100%);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  border: 1px solid rgba(255,255,255,0.05);
}
.knob-indicator {
  position: absolute; width: 2px; height: 9px;
  background: var(--text); top: 3px; left: 50%;
  transform-origin: bottom center; transform: translateX(-50%);
  border-radius: 1px;
}
.knob-label {
  font-size: 7px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--micro); text-align: center;
}
.knob-value {
  font-size: 8px; color: var(--muted);
  font-variant-numeric: tabular-nums;
}

/* Meters — VU Meter Style */
.meter-group {
  display: flex; gap: 1px; justify-content: center;
  height: 50px; align-items: flex-end;
  background: rgba(3,5,9,0.5);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  padding: 3px;
}
.meter-bar {
  width: 3px; background: var(--accent-green);
  transition: height 0.08s;
  border-radius: 1px 1px 0 0;
  position: relative;
}
.meter-bar .peak-hold {
  position: absolute; top: -2px; left: 0; right: 0;
  height: 1px; background: var(--text-bright);
  opacity: 0.6;
}

/* Channel Meters — per track mini VU */
.channel-meters {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;
  padding: 4px 0;
}
.channel-meter {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
}
.channel-meter-bar {
  width: 100%; height: 4px;
  background: rgba(3,5,9,0.5);
  border: 1px solid var(--glass-border);
  border-radius: 2px;
  overflow: hidden;
}
.channel-meter-fill {
  height: 100%;
  background: var(--accent-green);
  transition: width 0.08s;
}
.channel-meter-label {
  font-size: 6px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* Clip playback progress overlay */
.clip .clip-progress {
  position: absolute; top: 0; left: 0; bottom: 0;
  background: rgba(255,255,255,0.06);
  pointer-events: none; width: 0;
  border-right: 1px solid rgba(255,255,255,0.15);
}

/* Active track highlight */
.track.track-active {
  background: rgba(59, 130, 246, 0.04) !important;
}
.track.track-active .track-header {
  border-right-color: rgba(59, 130, 246, 0.3);
}
.track.track-active .track-header::before {
  box-shadow: 0 0 8px currentColor;
}

/* Empty Timeline State */
.timeline-empty {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center; pointer-events: none;
  z-index: 5; opacity: 1;
  transition: opacity 0.3s;
}
.timeline-empty.hidden { opacity: 0; pointer-events: none; }
.timeline-empty-icon {
  font-size: 32px; opacity: 0.1; margin-bottom: 12px;
  line-height: 1;
}
.timeline-empty-title {
  font-size: 12px; font-weight: 600; color: var(--text-secondary);
  margin-bottom: 6px; letter-spacing: 0.05em;
}
.timeline-empty-desc {
  font-size: 9px; color: var(--micro); max-width: 280px;
  line-height: 1.6; letter-spacing: 0.03em;
}
.timeline-empty-steps {
  display: flex; gap: 24px; margin-top: 16px; justify-content: center;
}
.timeline-empty-step {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
}
.timeline-empty-step-num {
  width: 22px; height: 22px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; color: var(--muted);
  background: var(--glass);
}
.timeline-empty-step-text {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.1em;
  max-width: 60px; text-align: center;
}
@keyframes emptyPulse {
  0%, 100% { opacity: 0.08; }
  50% { opacity: 0.15; }
}
.timeline-empty-icon { animation: emptyPulse 3s ease-in-out infinite; }

/* Right Panel Tabs */
.panel-tabs {
  display: flex; border-bottom: 1px solid var(--border);
  background: rgba(10,14,26,0.6);
  flex-shrink: 0;
}
.panel-tab {
  flex: 1; padding: 6px 0;
  font-size: 8px; font-weight: 600; font-family: 'Sora', sans-serif;
  text-transform: uppercase; letter-spacing: 0.12em;
  background: none; border: none; border-bottom: 2px solid transparent;
  color: var(--micro); cursor: pointer;
  transition: color 0.2s, border-color 0.2s, background 0.2s;
}
.panel-tab:hover { color: var(--text-secondary); background: var(--glass); }
.panel-tab.active {
  color: var(--text); border-bottom-color: var(--blue);
}
.panel-tab-content { display: none; opacity: 0; }
.panel-tab-content.active { display: block; opacity: 1; animation: panelFadeIn 0.15s ease; }
@keyframes panelFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

/* Custom Clip Tooltip */
.clip-tip {
  position: fixed; z-index: 300;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  padding: 8px 12px;
  font-size: 9px; font-family: 'Sora', sans-serif;
  color: var(--text); pointer-events: none;
  box-shadow: var(--shadow-deep);
  white-space: nowrap;
  opacity: 0; transition: opacity 0.15s;
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.clip-tip.show { opacity: 1; }
.clip-tip-name {
  font-weight: 600; font-size: 10px;
  margin-bottom: 3px; letter-spacing: 0.02em;
}
.clip-tip-detail {
  font-size: 8px; color: var(--text-secondary);
  display: flex; gap: 8px; letter-spacing: 0.03em;
}
.clip-tip-detail span { color: var(--muted); }

/* Track Header Context Menu */
.track-ctx {
  position: fixed; z-index: 200;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  min-width: 140px; padding: 4px 0;
  box-shadow: var(--shadow-deep);
  font-family: 'Sora', sans-serif;
  border-radius: var(--radius-md);
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.track-ctx.open { display: block; }
.track-ctx-item {
  padding: 6px 14px; font-size: 9px;
  color: var(--text-secondary); cursor: pointer;
  text-transform: uppercase; letter-spacing: 0.06em;
  transition: background 0.1s, color 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.track-ctx-item:hover { background: rgba(59,130,246,0.08); color: var(--text); }
.track-ctx-item.danger { color: var(--error); }
.track-ctx-item.danger:hover { background: rgba(239,68,68,0.08); }
.track-ctx-sep { height: 1px; background: rgba(255,255,255,0.04); margin: 3px 4px; }

/* Snap grid indicator */
.snap-indicator {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: rgba(59, 130, 246, 0.3);
  pointer-events: none; z-index: 15;
  opacity: 0; transition: opacity 0.1s;
}
.snap-indicator.visible { opacity: 1; }

/* Inspector — Properties Panel */
.inspector-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--blue);
  position: relative;
}
.inspector-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, rgba(6,182,212,0.08), rgba(59,130,246,0.06), transparent 80%);
}
.inspector-title {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--blue); margin-bottom: 8px;
}
.inspector-field { margin-bottom: 6px; }
.inspector-field label {
  display: block; font-size: 8px;
  color: var(--micro); text-transform: uppercase;
  letter-spacing: 0.15em; margin-bottom: 3px;
}
.inspector-field .value { font-size: 11px; color: var(--text); }
.inspector-field input, .inspector-field select {
  width: 100%; padding: 5px 8px;
  font-size: 11px; font-family: 'Sora', sans-serif;
  background: rgba(3,5,9,0.5); border: 1px solid var(--glass-border); color: var(--text);
  transition: border-color 0.2s, box-shadow 0.2s;
  border-radius: var(--radius-sm);
}
.inspector-field input:focus, .inspector-field select:focus {
  outline: none; border-color: rgba(59,130,246,0.3); box-shadow: 0 0 8px rgba(59,130,246,0.1);
}
.inspector-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 6px; }
.inspector-tag {
  font-size: 8px; padding: 0;
  background: none; border: none;
  color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* Music Player — Minimal Waveform Style */
.music-section {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  border-left: 2px solid var(--accent-green);
  position: relative;
}
.music-section::after {
  content: '';
  position: absolute; bottom: 0; left: 14px; right: 14px;
  height: 1px;
  background: linear-gradient(90deg, rgba(34,197,94,0.1), transparent 80%);
}
.music-now-playing {
  font-size: 10px; color: var(--text-secondary);
  margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
}
.music-now-playing .eq { display: flex; gap: 1px; align-items: flex-end; height: 10px; }
.music-now-playing .eq span { width: 2px; background: var(--accent-green); animation: eqBounce 0.8s ease-in-out infinite alternate; }
.music-now-playing .eq span:nth-child(2) { animation-delay: 0.2s; }
.music-now-playing .eq span:nth-child(3) { animation-delay: 0.4s; }
@keyframes eqBounce { 0% { height: 2px; } 100% { height: 10px; } }
.music-controls { display: flex; gap: 2px; align-items: center; }
.music-btn {
  width: 26px; height: 26px;
  background: rgba(3,5,9,0.4); border: 1px solid var(--glass-border);
  color: var(--muted); cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Sora', sans-serif;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
  border-radius: var(--radius-sm);
}
.music-btn:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.music-btn.playing { background: var(--accent-green); color: var(--bg); border-color: var(--accent-green); }
.music-volume {
  width: 60px; height: 2px; margin-left: 4px;
  -webkit-appearance: none; appearance: none;
  background: var(--border); outline: none; cursor: pointer;
}
.music-volume::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 8px; height: 8px;
  background: var(--accent-green); border-radius: 50%; cursor: pointer;
}

/* Export Button */
.export-btn {
  padding: 7px 12px;
  background: var(--glass); border: 1px solid var(--glass-border);
  color: var(--text-secondary); font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  cursor: pointer; width: 100%;
  transition: color 0.15s, border-color 0.15s, background 0.15s, box-shadow 0.15s;
  border-radius: var(--radius-sm);
}
.export-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); box-shadow: var(--shadow-soft); }

/* ===== FOOTER — Status Bar ===== */
.footer {
  background: rgba(10,14,26,0.8);
  border-top: 1px solid var(--border);
  padding: 0 16px;
  display: flex; align-items: center; justify-content: space-between;
  font-size: 9px; color: var(--micro);
  letter-spacing: 0.03em;
  height: 24px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  position: relative;
}
.footer::before {
  content: '';
  position: absolute; top: 0; left: 5%; right: 5%;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(6,182,212,0.08), rgba(59,130,246,0.06), transparent);
}
.status-item { display: flex; align-items: center; gap: 4px; }
.status-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--accent-green);
  box-shadow: 0 0 4px rgba(34,197,94,0.3);
  transition: background 0.2s, box-shadow 0.2s;
}
.status-dot.playing {
  background: var(--accent-blue);
  box-shadow: 0 0 6px rgba(59,130,246,0.4);
  animation: bpmBreath var(--bpm-duration, 0.5s) ease-out infinite;
}
.status-dot.recording {
  background: var(--accent-red);
  box-shadow: 0 0 6px rgba(239,68,68,0.4);
  animation: recPulse 1s ease-in-out infinite;
}
.footer-quote {
  font-style: italic; opacity: 0.3; letter-spacing: 0.05em; font-size: 8px;
  min-width: 160px; text-align: center;
  transition: opacity 0.3s;
}
.footer-quote.fade { opacity: 0; }

/* Mixer section collapse toggle */
.mixer-collapse {
  position: absolute; top: 10px; right: 10px;
  width: 14px; height: 14px;
  background: transparent; border: none;
  color: var(--micro); cursor: pointer;
  font-size: 7px; font-family: 'Sora', sans-serif;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.15s, transform 0.15s;
  border-radius: 2px;
}
.mixer-collapse:hover { color: var(--text-secondary); }
.mixer-collapse.collapsed { transform: rotate(-90deg); }
.mixer-section-body { transition: max-height 0.2s ease, opacity 0.15s; overflow: hidden; }
.mixer-section-body.hidden { max-height: 0 !important; opacity: 0; padding: 0; margin: 0; }

/* Selection count badge — floating indicator when multiple clips selected */
.selection-badge {
  position: fixed; bottom: 36px; left: 50%;
  transform: translateX(-50%) translateY(8px);
  display: flex; align-items: center; gap: 8px;
  font-size: 9px; font-weight: 600;
  color: var(--text); background: rgba(10,14,26,0.92);
  border: 1px solid rgba(59,130,246,0.25);
  padding: 4px 6px 4px 12px; z-index: 100;
  text-transform: uppercase; letter-spacing: 0.06em;
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  opacity: 0; transition: opacity 0.2s, transform 0.2s;
  pointer-events: none;
}
.selection-badge.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
.selection-badge .sel-count { color: var(--accent-cyan); margin-right: 4px; }
.selection-badge .sel-action {
  font-size: 8px; padding: 3px 8px; border: none; background: rgba(255,255,255,0.05);
  color: var(--muted); cursor: pointer; font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm); text-transform: uppercase; letter-spacing: 0.05em;
  transition: color 0.15s, background 0.15s;
}
.selection-badge .sel-action:hover { color: var(--text); background: rgba(255,255,255,0.08); }
.selection-badge .sel-action.danger:hover { color: var(--accent-red); }

/* Global Range Inputs — Pro DAW sliders */
input[type="range"] {
  -webkit-appearance: none; appearance: none;
  height: 3px; background: var(--border); outline: none;
  cursor: pointer; border-radius: 1px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 10px; height: 10px;
  background: var(--text-secondary);
  border-radius: 50%; cursor: pointer;
  border: 1px solid var(--border);
  transition: background 0.15s, transform 0.1s;
}
input[type="range"]::-webkit-slider-thumb:hover {
  background: var(--text); transform: scale(1.2);
}
input[type="range"]:focus::-webkit-slider-thumb {
  background: var(--blue); border-color: var(--blue);
}

/* Global Number Inputs — DAW Style */
input[type="number"] {
  -moz-appearance: textfield;
  font-variant-numeric: tabular-nums;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  opacity: 0; height: 100%;
}
input[type="number"]:hover::-webkit-inner-spin-button,
input[type="number"]:hover::-webkit-outer-spin-button {
  opacity: 0.4;
}

/* Track solo/mute state indicators */
.track.track-muted .track-header { opacity: 0.4; }
.track.track-muted .track-name { text-decoration: line-through; }

/* Snap indicator in transport */
.snap-badge {
  font-size: 7px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; padding: 2px 6px;
  border-radius: var(--radius-sm); color: var(--micro);
  background: transparent; border: 1px solid transparent;
  transition: color 0.15s, background 0.15s, border-color 0.15s;
}
.snap-badge.active {
  color: var(--accent-cyan); background: transparent;
  border-color: transparent;
}

/* Focus visible for keyboard accessibility */
:focus-visible {
  outline: 1px solid var(--blue);
  outline-offset: 1px;
}
button:focus-visible, .transport-btn:focus-visible {
  outline: 1px solid var(--blue);
  outline-offset: -1px;
}

/* Rubber band selection box */
.select-box {
  position: absolute; z-index: 30;
  border: 1px solid rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  pointer-events: none;
  border-radius: 1px;
}

/* Solo track highlight — non-soloed tracks dim when any is soloed */
.track-btn.soloed ~ .track-btn { opacity: 0.5; }
.track.track-soloed .track-header::before {
  box-shadow: 0 0 10px var(--accent-cyan);
}
.track.track-soloed .track-header {
  background: rgba(6,182,212,0.06);
}
/* Dim non-soloed tracks when solo is active */
.track:not(.track-soloed) { transition: opacity 0.2s, filter 0.2s; }
.timeline-tracks.has-solo .track:not(.track-soloed) {
  opacity: 0.35; filter: saturate(0.4);
}
.timeline-tracks.has-solo .track.track-soloed {
  opacity: 1; filter: none;
}

/* Active track — left accent glow when selected via number key or header click */
.track.track-active .track-header {
  border-left: 2px solid var(--accent-blue);
  background: rgba(59,130,246,0.04);
}
.track.track-active .track-content {
  background: rgba(59,130,246,0.015);
}

/* Marquee rubber-band selection */
.marquee-selection {
  position: absolute;
  border: 1px solid rgba(59,130,246,0.5);
  background: rgba(59,130,246,0.08);
  border-radius: var(--radius-sm);
  pointer-events: none;
  z-index: 20;
}

/* Snap line flash */
@keyframes snapFlash {
  0% { opacity: 0.6; }
  100% { opacity: 0; }
}
.snap-line {
  position: absolute;
  top: 0; bottom: 0;
  width: 1px;
  background: var(--accent-blue);
  pointer-events: none;
  z-index: 15;
  animation: snapFlash 0.3s ease-out forwards;
}

/* Clip overlap warning — pulsing border when clips overlap */
.clip.clip-superset::after {
  content: 'SS'; position: absolute; top: 1px; right: 2px;
  font-size: 6px; font-weight: 700; color: rgba(168,85,247,0.7);
  letter-spacing: 0.04em; pointer-events: none; z-index: 3;
}
.clip.clip-overlap {
  border: 1px solid rgba(239,68,68,0.4);
  box-shadow: inset 0 0 6px rgba(239,68,68,0.1);
}
.clip.clip-overlap-flash {
  animation: overlapPulse 0.6s ease-out;
}
@keyframes overlapPulse {
  0% { box-shadow: inset 0 0 12px rgba(239,68,68,0.3), 0 0 8px rgba(239,68,68,0.2); }
  100% { box-shadow: inset 0 0 6px rgba(239,68,68,0.1); }
}

/* Locate / scroll-to-playhead button in transport */
.locate-btn {
  padding: 0 8px; height: 22px; font-size: 7px;
  font-weight: 700; letter-spacing: 0.06em;
  text-transform: uppercase;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  color: var(--micro); cursor: pointer; font-family: 'Sora', sans-serif;
  border-radius: var(--radius-sm);
  transition: color 0.15s, background 0.15s, border-color 0.15s;
}
.locate-btn:hover { color: var(--text-secondary); background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }

/* Panel section gradient dividers — frosted glass separators */
.panel-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent 5%, rgba(6,182,212,0.06) 25%, rgba(59,130,246,0.08) 50%, rgba(139,92,246,0.06) 75%, transparent 95%);
  margin: 0;
}

/* Track number badge — large watermark number in header */
.track-num {
  position: absolute; right: 6px; bottom: 2px;
  font-size: 18px; font-weight: 800;
  color: rgba(255,255,255,0.025);
  line-height: 1; pointer-events: none;
  font-variant-numeric: tabular-nums;
}

/* Clip RPE velocity strip — thin gradient at top showing intensity */
.clip-velocity {
  position: absolute; top: 0; left: 0; right: 0;
  height: 2px; z-index: 1; pointer-events: none;
  border-radius: 3px 3px 0 0;
}

/* Timeline crosshair cursor */
.track-content { cursor: crosshair; }
.track-content .clip { cursor: move; }

/* Minimap playhead — thin line with glow during playback */
.minimap-playhead {
  position: absolute; top: 0; bottom: 0;
  width: 1px; background: rgba(255,255,255,0.5);
  z-index: 3; pointer-events: none;
  transition: box-shadow 0.2s;
}
.minimap-playhead.playing {
  background: rgba(96,165,250,0.8);
  box-shadow: 0 0 4px rgba(59,130,246,0.6), 0 0 8px rgba(59,130,246,0.3);
}

/* Fader handle active state — glow when dragging */
.fader-handle.dragging {
  background: linear-gradient(180deg, rgba(100,116,139,0.9) 0%, rgba(71,85,105,0.8) 100%);
  border-color: rgba(59,130,246,0.4);
  box-shadow: 0 0 8px rgba(59,130,246,0.3), 0 2px 8px rgba(0,0,0,0.5);
}

/* Knob dial active state */
.knob-dial.dragging {
  border-color: rgba(59,130,246,0.4);
  box-shadow: 0 0 12px rgba(59,130,246,0.2);
}

/* Track header subtle scale on hover */
.track-header {
  transition: background 0.15s;
}
.track-name {
  transition: letter-spacing 0.2s;
}
.track-header:hover .track-name {
  letter-spacing: 0.13em;
}

/* Panel resize divider — draggable border between left panel and timeline */
.panel-resize {
  width: 3px; cursor: col-resize;
  background: transparent;
  position: relative; z-index: 10;
  flex-shrink: 0;
  transition: background 0.15s;
}
.panel-resize:hover, .panel-resize.dragging {
  background: rgba(59,130,246,0.2);
}
.panel-resize::after {
  content: '';
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 1px; height: 20px;
  background: rgba(255,255,255,0.06);
  border-radius: 1px;
  opacity: 0;
  transition: opacity 0.15s;
}
.panel-resize:hover::after { opacity: 1; }

/* Clip dragging state — semi-transparent while being moved */
.clip.clip-dragging {
  opacity: 0.7;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
  z-index: 25;
}

/* Music track special styling — waveform decoration */
.track[data-track="music"] .track-content {
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 19px, rgba(6,182,212,0.015) 19px, rgba(6,182,212,0.015) 20px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 79px, rgba(6,182,212,0.03) 79px, rgba(6,182,212,0.03) 80px);
}
.track[data-track="music"] .track-content::after {
  content: '';
  position: absolute; bottom: 4px; left: 104px; right: 20px;
  height: 16px;
  background: repeating-linear-gradient(90deg,
    rgba(6,182,212,0.04) 0px, rgba(6,182,212,0.02) 2px,
    transparent 2px, transparent 6px
  );
  mask-image: linear-gradient(90deg, transparent, rgba(0,0,0,0.4) 5%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.4) 95%, transparent);
  -webkit-mask-image: linear-gradient(90deg, transparent, rgba(0,0,0,0.4) 5%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.4) 95%, transparent);
  pointer-events: none; opacity: 0.5;
}

/* Clip shimmer — animated gradient sweep on playing clips */
@keyframes clipShimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}
.clip.clip-playing::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
  animation: clipShimmer 2s ease-in-out infinite;
  pointer-events: none; z-index: 1;
}

/* Track resize handle — drag between tracks */
.track-resize-handle {
  height: 3px; cursor: ns-resize;
  background: transparent;
  position: relative; z-index: 5;
  transition: background 0.15s;
}
.track-resize-handle:hover {
  background: rgba(59,130,246,0.15);
}
.track-resize-handle::after {
  content: '';
  position: absolute; left: 50%; top: 50%;
  transform: translate(-50%, -50%);
  width: 20px; height: 1px;
  background: rgba(255,255,255,0.08);
  border-radius: 1px;
  opacity: 0;
  transition: opacity 0.15s;
}
.track-resize-handle:hover::after { opacity: 1; }

/* Focus mode — hide panels for full-width timeline */
.panel-left, .panel-right { transition: width 0.2s, opacity 0.2s, padding 0.2s; }
.main.focus-mode .panel-left { width: 0; overflow: hidden; opacity: 0; padding: 0; border: none; }
.main.focus-mode .panel-right { width: 0; overflow: hidden; opacity: 0; padding: 0; border: none; }
.main.focus-mode { grid-template-columns: 0fr 0fr 1fr 0fr; }
.focus-indicator {
  display: none; position: fixed; top: 44px; right: 8px;
  font-size: 7px; color: var(--accent-cyan); background: rgba(6,182,212,0.1);
  border: 1px solid rgba(6,182,212,0.2); padding: 2px 8px;
  border-radius: var(--radius-sm); z-index: 60;
  text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer;
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
}
.focus-indicator.visible { display: block; }

/* ===== COMMAND PALETTE ===== */
.cmd-palette {
  display: none; position: fixed; inset: 0; z-index: 250;
  background: rgba(3, 5, 9, 0.7); align-items: flex-start;
  justify-content: center; padding-top: 20vh;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.cmd-palette.open { display: flex; }
.cmd-palette-box {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  width: 90%; max-width: 420px;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
  border-radius: var(--radius-lg); overflow: hidden;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.cmd-palette-input {
  width: 100%; padding: 14px 18px;
  background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.06);
  color: var(--text); font-family: 'Sora', sans-serif;
  font-size: 13px; outline: none;
}
.cmd-palette-input::placeholder { color: var(--micro); }
.cmd-palette-results {
  max-height: 280px; overflow-y: auto;
  padding: 4px 0;
}
.cmd-result {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 16px; cursor: pointer;
  transition: background 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.cmd-result:hover, .cmd-result.active {
  background: rgba(59, 130, 246, 0.06);
}
.cmd-result-icon {
  width: 20px; text-align: center;
  font-size: 10px; color: var(--muted);
}
.cmd-result-text {
  font-size: 11px; color: var(--text);
}
.cmd-result-key {
  margin-left: auto; font-size: 8px;
  color: var(--micro); letter-spacing: 0.08em;
}

/* ===== TOAST — Notification ===== */
.toast {
  position: fixed; bottom: 36px; right: 16px;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.06);
  border-left: 2px solid var(--blue);
  color: var(--text-secondary); padding: 8px 14px;
  font-size: 10px; z-index: 200;
  text-transform: uppercase; letter-spacing: 0.08em;
  opacity: 0; transform: translateY(8px);
  transition: opacity 0.2s, transform 0.2s;
  pointer-events: none; font-family: 'Sora', sans-serif;
  box-shadow: var(--shadow-deep);
  border-radius: var(--radius-md);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.toast.show { opacity: 1; transform: translateY(0); }
@media(prefers-reduced-motion:reduce) {
  .music-now-playing .eq span { animation: none; height: 6px; }
  .preset-card:hover { transform: none; }
  .clip { animation: none; transition: opacity 0.15s; }
  .clip:hover, .clip.clip-dragging { transform: none; filter: none; }
  .clip.clip-playing::before { animation: none; }
  .bpm-pulse { animation: none; opacity: 0.5; }
  .track-btn.armed { animation: none; }
  @keyframes emptyPulse { 0%, 100% { opacity: 0.1; } }
  @keyframes panelFadeIn { from, to { opacity: 1; transform: none; } }
  .snap-line { animation: none; }
  .bpm-input.flash { animation: none; }
  .toast { transition: none; }
  .playhead { transition: none; }
  .cmd-palette { backdrop-filter: none; }
  .saved-modal { backdrop-filter: none; }
  .shortcuts-overlay { backdrop-filter: none; }
}

/* ===== TABLET (768px) ===== */
@media(max-width:768px) {
  .app { grid-template-rows: 36px 1fr 22px; }
  .main { grid-template-columns: 160px 3px 1fr 220px; }
  .header { padding: 0 10px; }
  .logo-text { font-size: 10px; }
  .nav-btn { padding: 4px 8px; font-size: 8px; }
  .nav-sep { display: none; }
  .transport { padding: 4px 10px; height: 40px; }
  .time-display { font-size: 16px; min-width: 100px; }
  .bpm-input { width: 44px; font-size: 12px; }
  .fader-track { height: 60px; }
  .knob-dial { width: 28px; height: 28px; }
  .knob-indicator { height: 7px; }
  .preset-card { min-width: 130px; padding: 8px; }
}

/* ===== MOBILE (480px) ===== */
@media(max-width:480px) {
  .app { grid-template-rows: 36px 1fr 20px; }
  .main { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .panel-resize { display: none; }
  .panel-left { max-height: 180px; border-right: none; border-bottom: 1px solid var(--border); }
  .panel-right { border-left: none; border-top: 1px solid var(--border); max-height: 240px; }
  .header { padding: 0 8px; }
  .header-nav { gap: 0; overflow-x: auto; }
  .nav-btn { padding: 4px 6px; font-size: 7px; min-height: 32px; white-space: nowrap; }
  .nav-sep { display: none; }
  .logo-text { font-size: 9px; }
  .logo-sub { display: none; }
  .transport { height: auto; padding: 4px 8px; flex-wrap: wrap; }
  .transport-btn { width: 34px; height: 34px; font-size: 13px; min-height: 40px; }
  .music-btn { width: 32px; height: 32px; min-height: 40px; }
  .track-header { width: 70px; padding: 4px 6px; }
  .track-name { font-size: 8px; padding-left: 4px; }
  .track-info { display: none; }
  .fader-group { gap: 6px; }
  .fader-track { height: 50px; }
  .preset-card { min-width: 120px; padding: 8px; }
  .presets-drawer { padding: 8px 10px; }
  .shortcuts-panel { width: 280px; }
}

/* ===== SAVED WORKOUTS MODAL ===== */
.saved-modal {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(3, 5, 9, 0.7); align-items: center; justify-content: center;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.saved-modal.open { display: flex; }
.saved-modal-content {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  width: 90%; max-width: 400px; max-height: 70vh; overflow-y: auto;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.saved-modal-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 14px; border-bottom: 1px solid var(--border);
}
.saved-modal-header h3 {
  font-size: 9px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--text-secondary);
}
.saved-modal-close {
  background: transparent; border: 1px solid transparent;
  color: var(--micro); cursor: pointer; font-size: 14px;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  transition: color 0.1s;
}
.saved-modal-close:hover { color: var(--text); }
.saved-item {
  padding: 10px 14px; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: background 0.15s;
}
.saved-item:hover {
  background: var(--glass);
}
.saved-item-name { font-size: 11px; font-weight: 600; }
.saved-item-info {
  font-size: 8px; color: var(--micro); margin-top: 3px;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.saved-item-delete {
  float: right; font-size: 8px; color: var(--micro);
  cursor: pointer; padding: 2px 6px;
  border: none; background: none;
  text-transform: uppercase; letter-spacing: 0.08em;
  transition: color 0.1s;
}
.saved-item-delete:hover { color: var(--accent-red); }
.saved-empty {
  text-align: center; padding: 28px; color: var(--micro);
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em;
}

/* ===== PRESETS DRAWER ===== */
.presets-drawer {
  display: none; position: absolute; top: 40px; left: 0; right: 0;
  background: rgba(10,14,26,0.95);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7);
  z-index: 50; padding: 12px 16px;
  opacity: 0; transform: translateY(-8px);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.presets-drawer.open {
  display: flex; gap: 8px; flex-wrap: wrap;
  opacity: 1; transform: translateY(0);
  animation: drawerSlide 0.15s ease-out;
}
@keyframes drawerSlide {
  0% { opacity: 0; transform: translateY(-8px); }
  100% { opacity: 1; transform: translateY(0); }
}
.preset-card {
  flex: 1; min-width: 140px; max-width: 200px;
  padding: 10px 12px;
  background: transparent; border: none;
  border-left: 1px solid rgba(255,255,255,0.04);
  cursor: pointer;
  transition: border-color 0.15s, background 0.15s;
  border-radius: 0;
}
.preset-card:first-child { border-left: none; }
.preset-card:hover {
  border-left-color: rgba(255,255,255,0.08);
  background: rgba(255,255,255,0.02);
}
.preset-card .pc-name {
  font-size: 11px; font-weight: 600; margin-bottom: 2px;
}
.preset-card .pc-bpm {
  font-size: 9px; color: var(--accent-orange);
  font-variant-numeric: tabular-nums;
}
.preset-card .pc-desc {
  font-size: 8px; color: var(--micro); margin-top: 4px;
  line-height: 1.4;
}
.preset-card .pc-mode {
  font-size: 7px; padding: 0;
  display: inline-block; margin-top: 6px;
  text-transform: uppercase; letter-spacing: 0.08em;
}

/* ===== WORKOUT SUMMARY PANEL — Craft/Endel minimalism ===== */
.summary-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(2,4,8,0.85);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  overflow-y: auto; overflow-x: hidden;
  animation: summaryIn 0.2s ease-out;
}
.summary-overlay.open { display: block; }
@keyframes summaryIn {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
.summary-inner {
  max-width: 600px; margin: 0 auto;
  padding: 48px 32px 80px;
}
.summary-close {
  position: fixed; top: 16px; right: 20px;
  font-size: 9px; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.15em;
  cursor: pointer; padding: 8px 16px;
  transition: color 0.15s;
  z-index: 301;
}
.summary-close:hover { color: var(--text); }
.summary-header {
  margin-bottom: 40px;
}
.summary-title {
  font-size: 22px; font-weight: 300; letter-spacing: 0.06em;
  color: var(--text); margin-bottom: 4px;
}
.summary-subtitle {
  font-size: 9px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.summary-meta {
  display: flex; gap: 24px; margin-top: 20px;
  font-size: 10px; color: var(--muted);
  letter-spacing: 0.04em;
}
.summary-meta-val {
  font-weight: 600; color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}
.summary-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
  margin: 32px 0;
}
.summary-group-label {
  font-size: 8px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.2em;
  margin-bottom: 20px;
}
.summary-exercise {
  display: flex; gap: 16px; align-items: flex-start;
  padding: 16px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.summary-exercise:last-child { border-bottom: none; }
.summary-ex-index {
  font-size: 11px; font-weight: 300;
  color: var(--micro); min-width: 28px;
  font-variant-numeric: tabular-nums;
  padding-top: 1px; letter-spacing: 0.04em;
}
.summary-ex-body { flex: 1; }
.summary-ex-name {
  font-size: 14px; font-weight: 500;
  color: var(--text); letter-spacing: 0.02em;
  margin-bottom: 8px; line-height: 1.2;
}
.summary-ex-params {
  display: flex; flex-wrap: wrap; gap: 16px;
  font-size: 11px; color: var(--muted);
  letter-spacing: 0.02em;
}
.summary-ex-param {
  display: flex; align-items: baseline; gap: 4px;
}
.summary-param-val {
  font-weight: 500; font-variant-numeric: tabular-nums;
}
.summary-param-label {
  font-size: 8px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.08em;
}
.summary-ex-prog {
  margin-top: 10px;
  font-size: 8px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.15em;
  cursor: pointer; transition: color 0.15s;
  user-select: none;
}
.summary-ex-prog:hover { color: var(--muted); }
.summary-prog-chain {
  display: none; margin-top: 12px; padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,0.03);
}
.summary-prog-chain.open { display: block; }
.summary-prog-stage {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.15em;
  margin-bottom: 6px; margin-top: 10px;
}
.summary-prog-stage:first-child { margin-top: 0; }
.summary-prog-item {
  font-size: 11px; color: var(--muted);
  padding: 3px 0; display: flex; align-items: center; gap: 8px;
}
.summary-prog-item.current {
  color: var(--text); font-weight: 500;
}
.summary-prog-item .prog-disc {
  font-size: 8px; color: var(--micro);
  font-weight: 300;
}
.summary-footer {
  text-align: center; margin-top: 48px;
  font-size: 8px; color: rgba(255,255,255,0.15);
  text-transform: uppercase; letter-spacing: 0.2em;
}
.summary-stats {
  display: flex; gap: 32px; justify-content: center;
  margin-top: 24px;
}
.summary-stat {
  text-align: center;
}
.summary-stat-val {
  font-size: 28px; font-weight: 200;
  background: linear-gradient(135deg, #06b6d4, #3b82f6, #8b5cf6);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; font-variant-numeric: tabular-nums;
  line-height: 1;
}
.summary-stat-label {
  font-size: 7px; color: var(--micro);
  text-transform: uppercase; letter-spacing: 0.2em;
  margin-top: 4px;
}
@media (max-width: 600px) {
  .summary-inner { padding: 32px 20px 60px; }
  .summary-title { font-size: 18px; }
  .summary-ex-params { gap: 12px; }
  .summary-stats { gap: 20px; }
  .summary-stat-val { font-size: 22px; }
}

/* ===== CONTEXT MENU — Endel/Craft Right-Click ===== */
.clip-context-menu {
  position: fixed; z-index: 250;
  background: rgba(13,17,23,0.95); border: 1px solid rgba(255,255,255,0.08);
  box-shadow: var(--shadow-deep);
  min-width: 160px;
  border-radius: var(--radius-md);
  padding: 4px 0;
  display: none;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}
.clip-context-menu.open { display: block; }
.ctx-item {
  padding: 6px 14px; font-size: 10px;
  color: var(--text-secondary); cursor: pointer;
  display: flex; justify-content: space-between; align-items: center;
  transition: background 0.1s, color 0.1s;
  border-radius: var(--radius-sm);
  margin: 0 4px;
}
.ctx-item:hover { background: rgba(255,255,255,0.03); color: var(--text); }
.ctx-item .ctx-key {
  font-size: 8px; color: var(--micro);
  margin-left: 16px;
}
.ctx-sep { height: 1px; background: rgba(255,255,255,0.04); margin: 3px 4px; }
.ctx-color-swatch {
  width: 10px; height: 10px; border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.15);
  cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
  display: inline-block;
}
.ctx-color-swatch:hover { transform: scale(1.3); box-shadow: 0 0 6px rgba(255,255,255,0.2); }
.ctx-color-swatch[data-color=""] { background: transparent; }
.ctx-item.danger:hover { background: rgba(239,68,68,0.08); color: var(--accent-red); }

/* ===== PLAYHEAD GLOW ANIMATION ===== */
@keyframes playheadPulse {
  0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.4); }
  50% { box-shadow: 0 0 14px rgba(255,255,255,0.6); }
}
.playhead.playing {
  animation: playheadPulse 1s ease-in-out infinite;
}

/* ===== RECORDING PULSE ===== */
@keyframes recPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.transport-btn.rec.active {
  animation: recPulse 1s ease-in-out infinite;
}

/* ===== SHORTCUTS OVERLAY — Endel/Craft Style ===== */
.shortcuts-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(3,5,9,0.6);
  align-items: center; justify-content: center;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}
.shortcuts-overlay.open { display: flex; }
.shortcuts-panel {
  background: rgba(10,14,26,0.95); border: 1px solid rgba(255,255,255,0.08);
  padding: 18px 22px; width: 320px;
  border-radius: var(--radius-lg);
  box-shadow: 0 25px 80px rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
.shortcuts-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 14px;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--text-secondary);
}
.shortcuts-grid { display: flex; flex-direction: column; gap: 6px; }
.shortcut-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 4px 0;
}
.shortcut-item kbd {
  font-family: 'Sora', sans-serif;
  font-size: 9px; font-weight: 600;
  background: rgba(3,5,9,0.5); border: 1px solid rgba(255,255,255,0.08);
  padding: 3px 8px; color: var(--text);
  border-radius: var(--radius-sm);
  min-width: 28px; text-align: center;
}
.shortcut-item span {
  font-size: 10px; color: var(--muted);
}

/* ===== MARKERS ===== */
.marker {
  position: absolute; z-index: 15;
  top: 0; cursor: pointer;
}
.marker-flag {
  width: auto; min-width: 8px; height: 14px;
  background: var(--accent-orange);
  padding: 0 4px;
  font-size: 7px; font-weight: 600;
  color: var(--bg); display: flex; align-items: center;
  white-space: nowrap; border-radius: 0 2px 2px 0;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.marker-line {
  width: 1px; height: 100%;
  background: var(--accent-orange); opacity: 0.3;
  position: absolute; top: 14px; left: 0;
}
.marker:hover .marker-flag { filter: brightness(1.2); }

/* ===== LOOP REGION ===== */
.loop-region {
  position: absolute; top: 0; bottom: 0;
  background: rgba(59, 130, 246, 0.06);
  border-left: 1px solid rgba(59, 130, 246, 0.4);
  border-right: 1px solid rgba(59, 130, 246, 0.4);
  z-index: 5; pointer-events: none;
  display: none;
}
.loop-region.active { display: block; pointer-events: auto; }
.loop-region .loop-handle {
  position: absolute; top: 0; bottom: 0; width: 6px;
  cursor: ew-resize; z-index: 6;
}
.loop-handle-left { left: -3px; }
.loop-handle-right { right: -3px; }
.loop-handle::after {
  content: '';
  position: absolute; top: 0; left: 50%; transform: translateX(-50%);
  width: 6px; height: 8px;
  background: rgba(59, 130, 246, 0.6);
  border-radius: 0 0 2px 2px;
  transition: background 0.15s;
}
.loop-handle:hover::after { background: rgba(59, 130, 246, 0.9); }
.loop-region .loop-body {
  position: absolute; top: 0; bottom: 0; left: 6px; right: 6px;
  cursor: grab;
}
.loop-region .loop-body:active { cursor: grabbing; }

/* ===== INLINE PROMPT — Craft-style modal input ===== */
.inline-prompt {
  display: none; position: fixed; inset: 0; z-index: 350;
  background: rgba(2,4,8,0.7);
  backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  align-items: flex-start; justify-content: center;
  padding-top: 28vh;
}
.inline-prompt.open { display: flex; }
.inline-prompt-box {
  background: rgba(10,14,26,0.95);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-md);
  padding: 16px 20px;
  width: 280px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}
.inline-prompt-label {
  font-size: 9px; color: var(--micro); text-transform: uppercase;
  letter-spacing: 0.1em; margin-bottom: 8px;
}
.inline-prompt-input {
  width: 100%; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-sm); padding: 8px 10px;
  color: var(--text); font-family: 'Sora', sans-serif;
  font-size: 13px; font-weight: 500; outline: none;
}
.inline-prompt-input:focus { border-color: rgba(59,130,246,0.4); }
.inline-prompt-actions {
  display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px;
}
.inline-prompt-actions button {
  font-family: 'Sora', sans-serif; font-size: 9px;
  padding: 4px 12px; border: none; border-radius: var(--radius-sm);
  cursor: pointer; text-transform: uppercase; letter-spacing: 0.06em;
}
.inline-prompt-cancel {
  background: transparent; color: var(--muted);
}
.inline-prompt-cancel:hover { color: var(--text); }
.inline-prompt-ok {
  background: rgba(59,130,246,0.15); color: var(--accent-blue);
}
.inline-prompt-ok:hover { background: rgba(59,130,246,0.25); }

/* ===== TOOLTIP — Craft-style hover tip ===== */
[data-tip] { position: relative; }
[data-tip]::after {
  content: attr(data-tip);
  position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%) translateY(4px);
  background: rgba(13,17,23,0.95);
  color: var(--text-secondary);
  font-size: 9px; font-weight: 400;
  padding: 4px 8px;
  white-space: nowrap;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  opacity: 0; pointer-events: none;
  transition: opacity 0.15s, transform 0.15s;
  z-index: 400;
  letter-spacing: 0.02em;
  font-family: 'Sora', sans-serif;
}
[data-tip]:hover::after {
  opacity: 1; transform: translateX(-50%) translateY(0);
}
@media(prefers-reduced-motion:reduce) {
  [data-tip]::after { transition: none; }
}

/* ===== SCROLLBAR — Craft Style (barely visible) ===== */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.06);
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.12); }
::-webkit-scrollbar-corner { background: transparent; }
.timeline-container::-webkit-scrollbar { height: 6px; }
.timeline-container::-webkit-scrollbar-track { background: transparent; }
.timeline-container::-webkit-scrollbar-thumb {
  background: rgba(6,182,212,0.12);
  border-radius: 3px;
}
.timeline-container::-webkit-scrollbar-thumb:hover {
  background: rgba(6,182,212,0.25);
}
.panel-left::-webkit-scrollbar-track { background: var(--surface); }
.panel-right::-webkit-scrollbar-track { background: var(--surface); }

/* ===== FOCUS / SELECTION ===== */
a:focus-visible, button:focus-visible, input:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.6);
  outline-offset: 2px;
}
::selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
::-moz-selection { background: rgba(59, 130, 246, 0.3); color: #fff; }
</style>
</head>
<body>
<!-- Loading Splash -->
<div id="splash" style="position:fixed;inset:0;z-index:9999;background:#050711;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;transition:opacity 0.4s">
  <img src="assets/planet-logo.png" alt="" style="width:48px;height:48px;opacity:0.8" onerror="this.style.display='none'">
  <div style="font-family:Sora,sans-serif;font-size:11px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:rgba(255,255,255,0.5)">Saturno Movement Studio</div>
  <div style="width:120px;height:2px;background:rgba(255,255,255,0.06);border-radius:1px;overflow:hidden"><div id="splash-bar" style="width:0%;height:100%;background:linear-gradient(90deg,#3b82f6,#06b6d4);transition:width 0.8s ease"></div></div>
</div>
<script>
setTimeout(function(){var b=document.getElementById('splash-bar');if(b)b.style.width='100%'},50);
setTimeout(function(){var s=document.getElementById('splash');if(s){s.style.opacity='0';setTimeout(function(){s.remove()},400)}},1200);
</script>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-progress" id="header-progress"></div>
    <div class="logo">
      <div class="logo-icon"><img src="assets/planet-logo.png" alt="" onerror="this.style.display='none'"></div>
      <div>
        <div class="logo-text">SATURNO MOVEMENT STUDIO</div>
        <div class="logo-sub">The Ableton of Movement</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:4px;margin-left:8px">
      <span style="font-size:8px;color:var(--micro)">/</span>
      <span id="header-workout-name" style="font-size:9px;color:var(--text-secondary);font-weight:500;letter-spacing:0.03em;cursor:pointer;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" onclick="renameWorkout()" data-tip="Click to rename">Untitled</span>
    </div>
    <nav class="header-nav">
      <button class="nav-btn" id="btn-presets" onclick="togglePresets()">PRESETS</button>
      <button class="nav-btn" onclick="clearTimeline()">CLEAR</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="saveNamedWorkout()">SAVE</button>
      <button class="nav-btn" onclick="showSavedWorkouts()">LOAD</button>
      <button class="nav-btn" onclick="exportWorkout()">EXPORT</button>
      <button class="nav-btn" onclick="showSummary()">SUMMARY</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" id="btn-snap" onclick="toggleSnap()">SNAP</button>
      <button class="nav-btn" id="btn-video" onclick="toggleVideo()">VID</button>
      <button class="nav-btn" onclick="toggleMusic()">MUS</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="undo()" data-tip="Undo (Cmd+Z)" style="font-size:11px">&#8617;</button>
      <button class="nav-btn" onclick="redo()" data-tip="Redo (Cmd+Shift+Z)" style="font-size:11px">&#8618;</button>
      <div class="nav-sep"></div>
      <button class="nav-btn" onclick="toggleShortcuts()" data-tip="Shortcuts (?)" style="font-size:10px;font-weight:700">?</button>
    </nav>
  </header>

  <!-- PRESETS DRAWER -->
  <div class="presets-drawer" id="presets-drawer">
    <div class="preset-card" onclick="loadPreset('monk')">
      <div class="pc-name">Monk Mode</div>
      <div class="pc-bpm">65 BPM</div>
      <div class="pc-desc">Meditative, slow, precise. Breath-led reps.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('beast')">
      <div class="pc-name">Beast Mode</div>
      <div class="pc-bpm">140 BPM</div>
      <div class="pc-desc">High intensity, explosive power.</div>
      <div class="pc-mode" style="background:rgba(239,68,68,0.2);color:#ef4444">Flow / Conditioning</div>
    </div>
    <div class="preset-card" onclick="loadPreset('flow')">
      <div class="pc-name">Flow Ritual</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Continuous movement, fluid transitions.</div>
      <div class="pc-mode" style="background:rgba(139,92,246,0.2);color:#8b5cf6">Standard Tempo</div>
    </div>
    <div class="preset-card" onclick="loadPreset('skill')">
      <div class="pc-name">Skill Ascension</div>
      <div class="pc-bpm">75 BPM</div>
      <div class="pc-desc">Technical practice, isometric holds.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Slow Strength</div>
    </div>
    <div class="preset-card" onclick="loadPreset('upper')">
      <div class="pc-name">Upper Day</div>
      <div class="pc-bpm">100 BPM</div>
      <div class="pc-desc">Push/Pull balanced upper body split.</div>
      <div class="pc-mode" style="background:rgba(59,130,246,0.2);color:#3b82f6">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('lower')">
      <div class="pc-name">Lower Day</div>
      <div class="pc-bpm">90 BPM</div>
      <div class="pc-desc">Squat patterns, hip hinges, mobility.</div>
      <div class="pc-mode" style="background:rgba(34,197,94,0.2);color:#22c55e">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('ppl')">
      <div class="pc-name">Push / Pull / Legs</div>
      <div class="pc-bpm">110 BPM</div>
      <div class="pc-desc">Classic 3-way split, all patterns hit.</div>
      <div class="pc-mode" style="background:rgba(249,115,22,0.2);color:#f97316">Standard</div>
    </div>
    <div class="preset-card" onclick="loadPreset('fullbody')">
      <div class="pc-name">Full Body</div>
      <div class="pc-bpm">105 BPM</div>
      <div class="pc-desc">One compound per pattern, total coverage.</div>
      <div class="pc-mode" style="background:rgba(236,72,153,0.2);color:#ec4899">Standard</div>
    </div>
    <div class="preset-card" onclick="generateRandom()" style="border:1px dashed var(--border)">
      <div class="pc-name" style="color:var(--accent-cyan)">Random</div>
      <div class="pc-bpm" style="color:var(--accent-cyan)">? BPM</div>
      <div class="pc-desc">Auto-generate a random balanced workout.</div>
      <div class="pc-mode" style="background:rgba(6,182,212,0.2);color:#06b6d4">Surprise</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <!-- LEFT: Movement Library -->
    <aside class="panel-left">
      <div class="panel-header"><span>Movement Library</span><span id="lib-count">0</span></div>
      <input type="text" class="lib-search" id="lib-search" placeholder="Search movements... (Enter to add)" oninput="filterLibrary()" onkeydown="if(event.key==='Enter')addFirstMatch()">
      <div style="display:flex;gap:3px;padding:4px 10px;align-items:center">
        <span style="font-size:7px;color:var(--micro);text-transform:uppercase;letter-spacing:0.1em;margin-right:2px">Stage</span>
        <button class="lib-stage-btn active" data-stage="all" onclick="filterByStage('all')" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.06);color:var(--text-secondary);font-family:Sora,sans-serif" data-tip="Show all stages">All</button>
        <button class="lib-stage-btn" data-stage="1" onclick="filterByStage(1)" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif" data-tip="Beginner exercises">S1</button>
        <button class="lib-stage-btn" data-stage="2" onclick="filterByStage(2)" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif" data-tip="Intermediate exercises">S2</button>
        <button class="lib-stage-btn" data-stage="3" onclick="filterByStage(3)" style="font-size:7px;padding:1px 6px;border:none;border-radius:2px;cursor:pointer;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif" data-tip="Advanced exercises">S3</button>
        <select id="lib-disc-filter" onchange="filterByDiscipline(this.value)" style="font-size:7px;padding:1px 4px;border:1px solid rgba(255,255,255,0.06);border-radius:2px;background:rgba(255,255,255,0.03);color:var(--muted);font-family:Sora,sans-serif;cursor:pointer;margin-left:auto" data-tip="Filter by discipline">
          <option value="all">All Disc.</option>
          <option value="Calisthenics">Calisthenics</option>
          <option value="Power-Free">Power-Free</option>
          <option value="Bodybuilding">Bodybuilding</option>
          <option value="Street Lifting">Street Lift.</option>
          <option value="Hand-Balancing">Hand-Bal.</option>
          <option value="Freestyle">Freestyle</option>
          <option value="Mobility">Mobility</option>
        </select>
      </div>
      <div class="movement-category" style="display:none">
        <div class="category-header" style="font-size:8px;color:var(--accent-cyan);padding:5px 12px"><span>Recent</span></div>
        <div class="movement-list" id="recent-exercises"></div>
      </div>
      <div id="library-container"></div>
    </aside>

    <!-- Panel resize divider -->
    <div class="panel-resize" id="panel-resize-left"></div>

    <!-- CENTER: Transport + Video + Timeline -->
    <section class="panel-center">
      <!-- Transport -->
      <div class="transport">
        <div class="transport-buttons">
          <button class="transport-btn" onclick="rewind()" data-tip="Rewind 15s">&#9198;</button>
          <button class="transport-btn" id="play-btn" onclick="togglePlay()" data-tip="Play / Pause (Space)">&#9654;</button>
          <button class="transport-btn" onclick="stopPlayback()" data-tip="Stop">&#9632;</button>
          <button class="transport-btn" onclick="forward()" data-tip="Forward 15s">&#9197;</button>
          <button class="transport-btn rec" id="rec-btn" onclick="toggleRec()" data-tip="Record (R)" style="border-radius:0 3px 3px 0">&#9679;</button>
        </div>
        <span id="playback-state" class="transport-state state-stop">STOP</span>
        <span class="snap-badge" id="snap-badge" onclick="toggleSnap()" data-tip="Snap to grid (S)">SNAP</span>
        <div class="transport-sep"></div>
        <div class="transport-buttons">
          <button class="transport-btn" id="metro-btn" onclick="toggleMetronome()" data-tip="Metronome" style="font-size:8px;letter-spacing:0.04em;border-radius:3px 0 0 3px;width:auto;padding:0 8px">MET</button>
          <button class="transport-btn" id="loop-btn" onclick="toggleLoop()" data-tip="Loop (L)" style="font-size:8px;letter-spacing:0.04em;border-radius:0 3px 3px 0;width:auto;padding:0 8px;border-left:none">LOOP</button>
        </div>
        <button class="locate-btn" onclick="scrollToPlayhead()" data-tip="Scroll to playhead">LOC</button>
        <div class="time-display" id="time-display">
          <span class="td-seg" id="td-min">00</span><span class="td-colon">:</span><span class="td-seg" id="td-sec">00</span><span class="td-colon">:</span><span class="td-seg td-ms" id="td-ms">00</span>
        </div>
        <div id="bars-display" style="font-size:10px;font-weight:600;color:var(--muted);padding:0 6px;font-variant-numeric:tabular-nums;min-width:50px;text-align:center">1.1.1</div>
        <div id="remaining-time" style="font-size:8px;color:var(--micro);font-variant-numeric:tabular-nums;min-width:30px;opacity:0" data-tip="Time remaining"></div>
        <div id="beat-indicator" style="display:flex;gap:2px;padding:0 4px" data-tip="Beat position">
          <div class="beat-dot" id="beat-1" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-2" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-3" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
          <div class="beat-dot" id="beat-4" style="width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,0.1)"></div>
        </div>
        <div class="bpm-section">
          <span class="bpm-label">BPM</span>
          <div class="bpm-pulse" id="bpm-pulse" data-tip="Tempo pulse"></div>
          <input type="number" class="bpm-input" id="bpm-input" value="120" min="40" max="200" onchange="updateBPM()">
          <span class="bpm-mode" id="bpm-mode">Standard</span>
          <span class="tempo-link" id="tempo-link" onclick="toggleTempoLink()" data-tip="Link BPM to tempo">LINK</span>
          <span class="tempo-link" id="tap-tempo" onclick="tapTempo()" data-tip="Tap tempo (T)">TAP</span>
          <span id="time-sig" style="font-size:8px;font-weight:700;color:var(--micro);padding:0 4px;letter-spacing:0.04em;cursor:pointer;font-variant-numeric:tabular-nums" onclick="cycleTimeSig()" data-tip="Time signature">4/4</span>
          <div class="transport-sep"></div>
          <span class="bpm-label">Zoom</span>
          <button class="transport-btn" onclick="zoomOut()" data-tip="Zoom out (Cmd+-)" style="width:22px;height:22px;font-size:10px;border-radius:2px">-</button>
          <span id="zoom-level" style="font-size:8px;color:var(--muted);min-width:28px;text-align:center">100%</span>
          <button class="transport-btn" onclick="zoomIn()" data-tip="Zoom in (Cmd+=)" style="width:22px;height:22px;font-size:10px;border-radius:2px">+</button>
          <button class="transport-btn" onclick="zoomToFit()" data-tip="Zoom to fit" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em">FIT</button>
          <div class="transport-sep"></div>
          <button class="transport-btn" id="auto-scroll-btn" onclick="toggleAutoScrollFromTransport()" data-tip="Auto-scroll" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em">FOLLOW</button>
          <div class="transport-sep"></div>
          <button class="transport-btn" id="speed-btn" onclick="cyclePlaybackSpeed()" data-tip="Playback speed" style="width:auto;height:22px;font-size:7px;border-radius:2px;padding:0 6px;letter-spacing:0.05em;font-variant-numeric:tabular-nums">1.0x</button>
        </div>
      </div>

      <!-- Video (collapsible) -->
      <div class="video-section" id="video-section">
        <div class="video-placeholder" id="video-placeholder">
          <div class="vp-icon">&#9654;</div>
          <span>Drop video here or click to load</span>
          <span style="font-size:9px;opacity:0.5">Landscape video plays in sync with timeline</span>
        </div>
        <video id="studio-video" style="width:100%;height:100%;object-fit:contain;display:none" controls></video>
        <button class="video-toggle" onclick="toggleVideo()" data-tip="Toggle video">&#9660;</button>
      </div>

      <!-- Timeline -->
      <div class="timeline-container" id="timeline-container">
        <div class="timeline-ruler" id="timeline-ruler"></div>
        <div class="timeline-minimap" id="timeline-minimap"><div class="minimap-viewport" id="minimap-viewport"></div></div>
        <div class="timeline-tracks" id="timeline-tracks">
          <div class="loop-region" id="loop-region"><div class="loop-handle loop-handle-left" data-side="left"></div><div class="loop-body"></div><div class="loop-handle loop-handle-right" data-side="right"></div></div>
          <div class="playhead" id="playhead"></div>
          <div class="timeline-empty" id="timeline-empty">
            <div class="timeline-empty-icon">&#9835;</div>
            <div class="timeline-empty-title">Compose Your Movement</div>
            <div class="timeline-empty-desc">Drag exercises from the library onto any track to begin building your workout.</div>
            <div class="timeline-empty-steps">
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">1</div><div class="timeline-empty-step-text">Browse the library</div></div>
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">2</div><div class="timeline-empty-step-text">Drag to track or double-click</div></div>
              <div class="timeline-empty-step"><div class="timeline-empty-step-num">3</div><div class="timeline-empty-step-text">Press space to play</div></div>
            </div>
            <div style="margin-top:12px;display:flex;gap:12px;justify-content:center;opacity:0.4">
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">P</kbd> Presets</span>
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">G</kbd> Random</span>
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">Cmd+K</kbd> Commands</span>
              <span style="font-size:7px;color:var(--micro)"><kbd style="padding:1px 4px;border:1px solid var(--border);border-radius:2px;font-size:7px;color:var(--muted)">?</kbd> Shortcuts</span>
            </div>
          </div>
          <div class="snap-indicator" id="snap-indicator"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Mixer + Inspector + Music -->
    <aside class="panel-right">
      <div class="panel-tabs">
        <button class="panel-tab active" data-tab="mixer" onclick="switchPanelTab('mixer')">Mixer</button>
        <button class="panel-tab" data-tab="inspector-tab" onclick="switchPanelTab('inspector-tab')">Inspector</button>
        <button class="panel-tab" data-tab="settings" onclick="switchPanelTab('settings')">Settings</button>
      </div>

      <!-- MIXER TAB -->
      <div class="panel-tab-content active" id="tab-mixer">
        <!-- Meter -->
        <div class="mixer-section">
          <div class="mixer-title">Output</div>
          <button class="mixer-collapse" onclick="toggleMixerSection(this)" data-tip="Collapse section">&#9660;</button>
          <div class="mixer-section-body" style="max-height:200px">
            <div class="meter-group" id="meters"></div>
            <div class="channel-meters" id="channel-meters" style="margin-top:6px"></div>
          </div>
        </div>
        <div class="panel-divider"></div>

        <!-- Faders -->
        <div class="mixer-section">
          <div class="mixer-title">Master Faders</div>
          <button class="mixer-collapse" onclick="toggleMixerSection(this)" data-tip="Collapse section">&#9660;</button>
          <div class="mixer-section-body" style="max-height:200px">
            <div class="fader-group" id="fader-group"></div>
          </div>
        </div>
        <div class="panel-divider"></div>

        <!-- Knobs -->
        <div class="mixer-section">
          <div class="mixer-title">Blend Controls</div>
          <button class="mixer-collapse" onclick="toggleMixerSection(this)" data-tip="Collapse section">&#9660;</button>
          <div class="mixer-section-body" style="max-height:200px">
            <div class="knob-group" id="knob-group"></div>
          </div>
        </div>
      </div>

      <!-- INSPECTOR TAB -->
      <div class="panel-tab-content" id="tab-inspector-tab">
      <!-- Inspector -->
      <div class="inspector-section" id="inspector" style="display:none">
        <div class="inspector-title">Exercise DNA</div>
        <div class="inspector-field"><label>Movement</label><div class="value" id="insp-name" style="cursor:pointer" onclick="searchLibraryForInspected()" data-tip="Click to find in library">-</div></div>
        <div class="inspector-field"><label>Pattern</label><div class="value" id="insp-pattern">-</div></div>
        <div class="inspector-field"><label>Stage</label><div class="value" id="insp-stage">-</div></div>
        <div class="inspector-field"><label>Discipline</label><div class="value" id="insp-discipline">-</div></div>
        <div class="inspector-field">
          <label>Sets x Reps</label>
          <div style="display:flex;gap:4px">
            <input type="number" id="insp-sets" value="3" min="1" max="10" style="width:40px" onchange="updateClipDNA()">
            <span style="color:var(--micro);font-size:11px">x</span>
            <input type="number" id="insp-reps" value="8" min="1" max="50" style="width:40px" onchange="updateClipDNA()">
          </div>
        </div>
        <div class="inspector-field"><label>Tempo (seconds per rep)</label><input type="number" id="insp-tempo" value="3" min="1" max="20" step="0.5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>Rest (seconds)</label><input type="number" id="insp-rest" value="60" min="0" max="300" step="5" onchange="updateClipDNA()"></div>
        <div class="inspector-field"><label>RPE <span id="insp-rpe-val" style="font-weight:500">7</span></label><input type="range" id="insp-rpe" min="1" max="10" value="7" style="width:100%" oninput="updateClipDNA();updateRpeColor()"></div>
        <div class="inspector-tags" id="insp-tags"></div>
        <div id="insp-progression" style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);display:none"></div>
        <div id="insp-time" style="margin-top:8px;padding-top:6px;border-top:1px solid var(--border);font-size:8px;color:var(--muted);display:flex;justify-content:space-between">
          <span>Est. time: <span id="insp-est-time" style="color:var(--text-secondary)">-</span></span>
          <span>TUT: <span id="insp-tut" style="color:var(--accent-cyan)">-</span></span>
        </div>
        <div class="inspector-field" style="margin-top:8px">
          <label>Notes</label>
          <textarea id="insp-notes" placeholder="Cues, focus points, modifications..." rows="2" style="width:100%;padding:5px 8px;font-size:10px;font-family:Sora,sans-serif;background:rgba(3,5,9,0.5);border:1px solid var(--glass-border);color:var(--text);resize:vertical;min-height:32px;border-radius:var(--radius-sm);transition:border-color 0.2s" onfocus="this.style.borderColor='rgba(59,130,246,0.3)'" onblur="this.style.borderColor='';updateClipNotes()"></textarea>
        </div>
        <div style="display:flex;gap:6px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
          <button class="nav-btn" onclick="duplicateClip()" data-tip="Duplicate (Cmd+D)" style="font-size:8px;padding:4px 8px;flex:1">DUP</button>
          <button class="nav-btn" onclick="splitClipAtPlayhead()" data-tip="Split at playhead (B)" style="font-size:8px;padding:4px 8px;flex:1">SPLIT</button>
          <button class="nav-btn" id="insp-lock-btn" onclick="toggleInspectorLock()" data-tip="Lock/Unlock (Cmd+L)" style="font-size:8px;padding:4px 8px;flex:1">LOCK</button>
          <button class="nav-btn" onclick="deleteSelectedClips()" data-tip="Delete (Del)" style="font-size:8px;padding:4px 8px;flex:1;color:var(--accent-red)">DEL</button>
        </div>
      </div>
      <div class="mixer-section" id="inspector-empty" style="padding:30px 14px;text-align:center">
        <div style="font-size:9px;color:var(--micro);text-transform:uppercase;letter-spacing:0.1em">Select a clip to inspect</div>
        <div style="font-size:7px;color:var(--micro);margin-top:4px;opacity:0.5">Click a clip on the timeline or press Tab</div>
      </div>

      <!-- Music -->
      <div class="music-section" id="music-panel" style="display:none">
        <div class="mixer-title">Music</div>
        <div class="music-now-playing" id="music-np">
          <div class="eq" id="music-eq" style="display:none"><span></span><span></span><span></span></div>
          <span id="music-track-name">No track</span>
        </div>
        <div class="music-controls">
          <button class="music-btn" onclick="musicPrev()" data-tip="Previous">&#9198;</button>
          <button class="music-btn" id="music-play-btn" onclick="musicToggle()" data-tip="Play/Pause">&#9654;</button>
          <button class="music-btn" onclick="musicNext()" data-tip="Next">&#9197;</button>
          <input type="range" class="music-volume" min="0" max="100" value="50" oninput="musicVolume(this.value)">
        </div>
        <select id="music-track-select" onchange="musicSelectTrack(this.selectedIndex)" style="width:100%;margin-top:6px;padding:4px 6px;font-size:9px;font-family:Sora,sans-serif;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-secondary);border-radius:var(--radius-sm)">
          <option value="0">Celestial Reverie</option>
          <option value="1">Blue Phoenix</option>
          <option value="2">Veil of Truth</option>
          <option value="3">Astral Shadows</option>
        </select>
        <div style="margin-top:6px;font-size:7px;color:var(--micro);display:flex;justify-content:space-between">
          <span id="music-time">0:00</span>
          <span>ASTRA Collection</span>
        </div>
      </div>

      <!-- Workout Summary — KPI Style -->
      <div class="mixer-section" id="workout-summary" style="display:none;border-left:2px solid var(--accent-purple)">
        <div class="mixer-title">Session Overview</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div style="text-align:center;padding:8px 0">
            <div id="sum-sets" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Sets</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-reps" style="font-size:1.5rem;font-weight:700;background:var(--gradient-titan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Reps</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-duration" style="font-size:1.5rem;font-weight:700;color:var(--accent-green)">0:00</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Duration</div>
          </div>
          <div style="text-align:center;padding:8px 0">
            <div id="sum-exercises" style="font-size:1.5rem;font-weight:700;color:var(--accent-orange)">0</div>
            <div style="font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.2em;margin-top:2px">Exercises</div>
          </div>
        </div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:6px">Movement Balance</div>
          <div id="balance-bars" style="display:flex;gap:2px;height:24px;align-items:flex-end"></div>
          <div id="balance-labels" style="display:flex;gap:2px;margin-top:3px"></div>
        </div>
      </div>
      </div><!-- end tab-inspector-tab -->

      <!-- SETTINGS TAB -->
      <div class="panel-tab-content" id="tab-settings">
        <div class="mixer-section">
          <div class="mixer-title">Timeline</div>
          <div class="inspector-field">
            <label>Snap to Grid</label>
            <div style="display:flex;align-items:center;gap:8px">
              <button id="settings-snap" class="export-btn" onclick="toggleSnap()" style="width:auto;padding:4px 12px">OFF</button>
              <span style="font-size:8px;color:var(--micro)">S key</span>
            </div>
          </div>
          <div class="inspector-field">
            <label>Grid Resolution</label>
            <select id="settings-grid" onchange="setGridRes(this.value)" style="width:100%;padding:4px 6px;font-size:10px;font-family:Sora,sans-serif;background:var(--bg-deep);border:1px solid var(--border);color:var(--text)">
              <option value="1">1 Beat</option>
              <option value="2">2 Beats</option>
              <option value="4" selected>1 Bar (4 Beats)</option>
              <option value="8">2 Bars</option>
            </select>
          </div>
          <div class="inspector-field">
            <label>Auto-scroll during playback</label>
            <button id="settings-autoscroll" class="export-btn" onclick="toggleAutoScrollFromSettings()" style="width:auto;padding:4px 12px">ON</button>
          </div>
        </div>
        <div class="mixer-section">
          <div class="mixer-title">Audio</div>
          <div class="inspector-field">
            <label>UI Sounds</label>
            <button id="settings-sfx" class="export-btn" onclick="toggleSFXSetting()" style="width:auto;padding:4px 12px">ON</button>
          </div>
          <div class="inspector-field">
            <label>Metronome Volume</label>
            <input type="range" id="settings-metro-vol" min="0" max="100" value="50" style="width:100%" oninput="metroVolume=this.value/100">
          </div>
        </div>
        <div class="mixer-section">
          <div class="mixer-title">Session</div>
          <div class="inspector-field">
            <label>Clear All Clips</label>
            <button class="export-btn" onclick="clearAllClips()" style="width:auto;padding:4px 12px;color:var(--error);border-color:rgba(239,68,68,0.3)">Clear</button>
          </div>
          <div class="inspector-field">
            <label>Reset to Default</label>
            <button class="export-btn" onclick="resetSession()" style="width:auto;padding:4px 12px;color:var(--error);border-color:rgba(239,68,68,0.3)">Reset</button>
          </div>
        </div>
      </div>

      <!-- Export / Import (always visible) -->
      <div class="mixer-section" style="display:flex;flex-wrap:wrap;gap:4px;padding:10px 14px;margin-top:auto">
        <button class="export-btn" onclick="exportWorkout()" style="flex:1;min-width:70px">Export</button>
        <button class="export-btn" onclick="printWorkout()" style="flex:1;min-width:70px">Print</button>
        <button class="export-btn" onclick="importWorkout()" style="flex:1;min-width:70px">Import</button>
      </div>
    </aside>
  </main>
  <div class="focus-indicator" id="focus-indicator" onclick="toggleFocusMode()" data-tip="Exit focus mode (F)">FOCUS</div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="status-item"><div class="status-dot"></div><span id="status-text">Ready</span></div>
    <span id="undo-count" style="font-size:7px;color:var(--micro);opacity:0.5;letter-spacing:0.06em" data-tip="Undo / Redo history"></span>
    <div style="display:flex;gap:12px;font-size:9px">
      <span>Clips: <span id="clip-count" style="color:var(--text-secondary)">0</span></span>
      <span style="color:var(--border)">|</span>
      <span>Duration: <span id="total-duration" style="color:var(--text-secondary)">0:00</span></span>
      <span style="color:var(--border)">|</span>
      <span id="footer-bars" style="color:var(--muted)">0 bars</span>
      <span style="color:var(--border)">|</span>
      <span data-tip="Est. workout time (sets x reps x tempo + rest)" style="color:var(--muted)">Est: <span id="footer-est-time" style="color:var(--muted)">0:00</span></span>
      <span style="color:var(--border)">|</span>
      <span data-tip="Workout intensity score (0-100)" style="color:var(--muted)">Int: <span id="footer-intensity" style="font-variant-numeric:tabular-nums">0</span></span>
      <span id="footer-supersets" data-tip="Cross-track supersets" style="color:rgba(168,85,247,0.8);font-size:8px;font-weight:600"></span>
      <span id="footer-difficulty" data-tip="Avg exercise difficulty" style="font-size:7px;font-weight:600;letter-spacing:0.04em"></span>
      <span id="footer-selection" data-tip="Selected clips" style="color:var(--accent-cyan);font-size:8px;font-weight:500"></span>
      <span id="footer-locked" data-tip="Locked clips" style="color:rgba(239,68,68,0.7);font-size:7px;font-weight:500"></span>
      <span id="footer-clipboard" data-tip="Clipboard contents" style="color:rgba(234,179,8,0.7);font-size:7px;font-weight:500"></span>
      <span id="footer-track-state" data-tip="Track mute/solo status" style="font-size:7px;font-weight:500"></span>
      <span style="color:var(--border)">|</span>
      <span id="footer-pos" style="color:var(--muted);cursor:pointer;font-variant-numeric:tabular-nums" onclick="toggleFooterMode()" data-tip="Click to switch format">1.1.1</span>
      <span style="color:var(--border)">|</span>
      <span data-tip="Session elapsed time" style="color:var(--micro);font-variant-numeric:tabular-nums">Session: <span id="session-timer" style="color:var(--muted)">0:00</span></span>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <div id="footer-balance" style="display:flex;gap:1px;height:4px;width:60px;border-radius:2px;overflow:hidden" data-tip="Family balance"></div>
      <span id="save-indicator" style="color:var(--accent-green);opacity:0;transition:opacity 0.3s;font-size:7px;text-transform:uppercase;letter-spacing:0.1em">Saved</span>
      <span id="workout-name" style="font-size:8px;color:var(--text-secondary);font-weight:500;letter-spacing:0.03em;cursor:pointer" onclick="renameWorkout()" data-tip="Click to rename">Untitled</span>
      <span style="color:var(--border)">|</span>
      <div class="footer-quote" id="footer-hint">Saturno Movement Studio</div>
      <input type="range" id="zoom-slider" min="0" max="5" value="2" style="width:60px;height:2px;margin:0 4px" oninput="setZoomFromSlider(this.value)" data-tip="Zoom level">
      <span id="zoom-pct" style="font-size:7px;color:var(--micro);opacity:0.5;min-width:22px;text-align:center;font-variant-numeric:tabular-nums">100%</span>
      <span id="footer-version" data-tip="Workout save version" style="font-size:7px;color:var(--micro);opacity:0.4;font-variant-numeric:tabular-nums">v1</span>
      <span style="font-size:7px;color:var(--micro);opacity:0.5;letter-spacing:0.06em;font-variant-numeric:tabular-nums">v3.0</span>
      <a href="https://saturno-bonus-omega.vercel.app/vault" style="font-size:7px;color:var(--micro);text-decoration:none;text-transform:uppercase;letter-spacing:0.08em">Vault</a>
    </div>
  </footer>
</div>

<div class="selection-badge" id="selection-badge">
  <span class="sel-count" id="sel-count">0</span> <span id="sel-label">clips</span>
  <button class="sel-action" onclick="copyClips()">Copy</button>
  <button class="sel-action" onclick="duplicateClip()">Dup</button>
  <button class="sel-action" onclick="quantizeClips()">Quantize</button>
  <button class="sel-action danger" onclick="deleteSelectedClips()">Delete</button>
</div>

<!-- WORKOUT SUMMARY OVERLAY -->
<div class="summary-overlay" id="summary-overlay">
  <div style="display:flex;justify-content:space-between;padding:0 24px">
    <button onclick="copyWorkoutText()" style="font-size:8px;padding:4px 12px;border:1px solid rgba(255,255,255,0.08);border-radius:3px;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer;font-family:Sora,sans-serif;letter-spacing:0.05em" data-tip="Copy workout as plain text">COPY TEXT</button>
    <div class="summary-close" onclick="closeSummary()">ESC / CLOSE</div>
  </div>
  <div class="summary-inner" id="summary-content"></div>
</div>

<div class="inline-prompt" id="inline-prompt">
  <div class="inline-prompt-box">
    <div class="inline-prompt-label" id="inline-prompt-label">Name</div>
    <input type="text" class="inline-prompt-input" id="inline-prompt-input" maxlength="60" autocomplete="off">
    <div class="inline-prompt-actions">
      <button class="inline-prompt-cancel" onclick="closeInlinePrompt(null)">Cancel</button>
      <button class="inline-prompt-ok" onclick="confirmInlinePrompt()">OK</button>
    </div>
  </div>
</div>

<div class="saved-modal" id="saved-modal">
  <div class="saved-modal-content">
    <div class="saved-modal-header">
      <h3>Saved Workouts</h3>
      <button class="saved-modal-close" onclick="closeSavedWorkouts()">&times;</button>
    </div>
    <div id="saved-list"></div>
  </div>
</div>

<div class="clip-context-menu" id="clip-context-menu">
  <div class="ctx-item" data-action="duplicate">Duplicate<span class="ctx-key">Cmd+D</span></div>
  <div class="ctx-item" data-action="inspect">Inspect</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="split">Split at Playhead<span class="ctx-key">B</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="snap-start">Snap to Start</div>
  <div class="ctx-item" data-action="snap-next">Snap After Previous</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="rpe-up">RPE + 1<span class="ctx-key">&#9650;</span></div>
  <div class="ctx-item" data-action="rpe-down">RPE - 1<span class="ctx-key">&#9660;</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="stage-up">Stage Up</div>
  <div class="ctx-item" data-action="stage-down">Stage Down</div>
  <div class="ctx-item" data-action="reset-fades">Reset Fades</div>
  <div class="ctx-item" data-action="toggle-lock">Lock / Unlock</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="group">Group<span class="ctx-key">Cmd+G</span></div>
  <div class="ctx-item" data-action="ungroup">Ungroup<span class="ctx-key">Cmd+Shift+G</span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item ctx-color-row" data-action="color">Color<span style="display:inline-flex;gap:3px;margin-left:auto"><span class="ctx-color-swatch" data-color="" title="Default"></span><span class="ctx-color-swatch" data-color="#ef4444" style="background:#ef4444"></span><span class="ctx-color-swatch" data-color="#f97316" style="background:#f97316"></span><span class="ctx-color-swatch" data-color="#eab308" style="background:#eab308"></span><span class="ctx-color-swatch" data-color="#22c55e" style="background:#22c55e"></span><span class="ctx-color-swatch" data-color="#06b6d4" style="background:#06b6d4"></span><span class="ctx-color-swatch" data-color="#8b5cf6" style="background:#8b5cf6"></span><span class="ctx-color-swatch" data-color="#ec4899" style="background:#ec4899"></span></span></div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="move-push" style="font-size:8px;color:var(--accent-blue)">Move to Push</div>
  <div class="ctx-item" data-action="move-pull" style="font-size:8px;color:var(--accent-purple)">Move to Pull</div>
  <div class="ctx-item" data-action="move-core" style="font-size:8px;color:var(--accent-orange)">Move to Core</div>
  <div class="ctx-item" data-action="move-legs" style="font-size:8px;color:var(--accent-green)">Move to Legs</div>
  <div class="ctx-item" data-action="move-skills" style="font-size:8px;color:var(--accent-cyan)">Move to Skills</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" data-action="delete">Delete<span class="ctx-key">Del</span></div>
</div>
<div class="shortcuts-overlay" id="shortcuts-overlay">
  <div class="shortcuts-panel">
    <div class="shortcuts-header">
      <span>Keyboard Shortcuts</span>
      <button onclick="toggleShortcuts()" style="background:none;border:none;color:var(--micro);cursor:pointer;font-size:14px">&times;</button>
    </div>
    <div class="shortcuts-grid">
      <div class="shortcut-item"><kbd>Space</kbd><span>Play / Pause</span></div>
      <div class="shortcut-item"><kbd>Esc</kbd><span>Deselect / Stop</span></div>
      <div class="shortcut-item"><kbd>S</kbd><span>Toggle Snap</span></div>
      <div class="shortcut-item"><kbd>Del</kbd><span>Delete Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Z</kbd><span>Undo</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+Z</kbd><span>Redo</span></div>
      <div class="shortcut-item"><kbd>Cmd+C</kbd><span>Copy Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+V</kbd><span>Paste Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+D</kbd><span>Duplicate</span></div>
      <div class="shortcut-item"><kbd>B</kbd><span>Split Clip</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+D</kbd><span>Dup Track</span></div>
      <div class="shortcut-item"><kbd>Cmd+G</kbd><span>Group Clips</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+G</kbd><span>Ungroup</span></div>
      <div class="shortcut-item"><kbd>&#8592; &#8594;</kbd><span>Nudge (beat)</span></div>
      <div class="shortcut-item"><kbd>Shift+&#8592; &#8594;</kbd><span>Nudge (bar)</span></div>
      <div class="shortcut-item"><kbd>Alt+&#8592; &#8594;</kbd><span>Resize (beat)</span></div>
      <div class="shortcut-item"><kbd>Alt+Drag</kbd><span>Dup & Move</span></div>
      <div class="shortcut-item"><kbd>&#8593; &#8595;</kbd><span>Move Track</span></div>
      <div class="shortcut-item"><kbd>Alt+Drag Ruler</kbd><span>Set Loop Region</span></div>
      <div class="shortcut-item"><kbd>Cmd++</kbd><span>Zoom In</span></div>
      <div class="shortcut-item"><kbd>Cmd+-</kbd><span>Zoom Out</span></div>
      <div class="shortcut-item"><kbd>Cmd+0</kbd><span>Zoom Reset</span></div>
      <div class="shortcut-item"><kbd>L</kbd><span>Toggle Loop</span></div>
      <div class="shortcut-item"><kbd>M</kbd><span>Add Marker</span></div>
      <div class="shortcut-item"><kbd>Cmd+A</kbd><span>Select All</span></div>
      <div class="shortcut-item"><kbd>Shift+Click</kbd><span>Multi-Select</span></div>
      <div class="shortcut-item"><kbd>Tab</kbd><span>Cycle Clips</span></div>
      <div class="shortcut-item"><kbd>Enter</kbd><span>Add from Search</span></div>
      <div class="shortcut-item"><kbd>Q</kbd><span>Quantize All</span></div>
      <div class="shortcut-item"><kbd>R</kbd><span>Record Toggle</span></div>
      <div class="shortcut-item"><kbd>F</kbd><span>Focus Mode</span></div>
      <div class="shortcut-item"><kbd>T</kbd><span>Tap Tempo</span></div>
      <div class="shortcut-item"><kbd>G</kbd><span>Generate Random</span></div>
      <div class="shortcut-item"><kbd>P</kbd><span>Presets</span></div>
      <div class="shortcut-item"><kbd>Dbl-Click</kbd><span>Add Random Clip</span></div>
      <div class="shortcut-item"><kbd>Drag</kbd><span>Marquee Select</span></div>
      <div class="shortcut-item"><kbd>Cmd+S</kbd><span>Save Session</span></div>
      <div class="shortcut-item"><kbd>Cmd+K</kbd><span>Command Palette</span></div>
      <div class="shortcut-item"><kbd>1-6</kbd><span>Select Track</span></div>
      <div class="shortcut-item"><kbd>Cmd+L</kbd><span>Lock / Unlock</span></div>
      <div class="shortcut-item"><kbd>Shift+&#8593;&#8595;</kbd><span>Adjust RPE</span></div>
      <div class="shortcut-item"><kbd>[ ]</kbd><span>Nudge Sets</span></div>
      <div class="shortcut-item"><kbd>Shift+[ ]</kbd><span>Nudge Reps</span></div>
      <div class="shortcut-item"><kbd>, .</kbd><span>Nudge Tempo</span></div>
      <div class="shortcut-item"><kbd>Shift+, .</kbd><span>Nudge Rest</span></div>
      <div class="shortcut-item"><kbd>Alt+&#8593;&#8595;</kbd><span>Dup to Track</span></div>
      <div class="shortcut-item"><kbd>C</kbd><span>Collapse Track</span></div>
      <div class="shortcut-item"><kbd>Shift+C</kbd><span>Collapse All</span></div>
      <div class="shortcut-item"><kbd>N</kbd><span>Next Marker</span></div>
      <div class="shortcut-item"><kbd>Shift+N</kbd><span>Prev Marker</span></div>
      <div class="shortcut-item"><kbd>Home</kbd><span>Jump to Start</span></div>
      <div class="shortcut-item"><kbd>End</kbd><span>Jump to End</span></div>
      <div class="shortcut-item"><kbd>PgUp</kbd><span>Stage Up</span></div>
      <div class="shortcut-item"><kbd>PgDn</kbd><span>Stage Down</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+V</kbd><span>Paste @ Head</span></div>
      <div class="shortcut-item"><kbd>Cmd+I</kbd><span>Invert Select</span></div>
      <div class="shortcut-item"><kbd>Cmd+Shift+A</kbd><span>Track Clips</span></div>
      <div class="shortcut-item"><kbd>0</kbd><span>Playhead Zero</span></div>
      <div class="shortcut-item"><kbd>/</kbd><span>Search Library</span></div>
      <div class="shortcut-item"><kbd>?</kbd><span>This Panel</span></div>
      <div class="shortcut-item"><kbd>J</kbd><span>Next Clip</span></div>
      <div class="shortcut-item"><kbd>K</kbd><span>Prev Clip</span></div>
    </div>
    <div style="font-size:8px;color:var(--micro);text-align:center;margin-top:10px;text-transform:uppercase;letter-spacing:0.1em">Drag exercises from library to timeline</div>
  </div>
</div>
<div class="cmd-palette" id="cmd-palette">
  <div class="cmd-palette-box">
    <input type="text" class="cmd-palette-input" id="cmd-input" placeholder="Type a command..." oninput="filterCommands()">
    <div id="cmd-count" style="font-size:7px;color:var(--micro);padding:2px 16px 4px;letter-spacing:0.06em"></div>
    <div class="cmd-palette-results" id="cmd-results"></div>
  </div>
</div>
<div class="clip-tip" id="clip-tip">
  <div class="clip-tip-name" id="tip-name"></div>
  <div class="clip-tip-detail">
    <span id="tip-pattern"></span>
    <span id="tip-stage"></span>
    <span id="tip-discipline" style="font-style:italic"></span>
  </div>
  <div class="clip-tip-detail" style="margin-top:2px">
    <span id="tip-dna"></span>
    <span id="tip-instrument" style="opacity:0.5"></span>
  </div>
  <div class="clip-tip-detail" style="margin-top:2px;color:var(--micro);font-size:7px">
    <span id="tip-time"></span>
    <span id="tip-tut" style="color:var(--accent-cyan)"></span>
  </div>
</div>
<div class="track-ctx" id="track-ctx">
  <div class="track-ctx-item" data-action="solo">Solo Track</div>
  <div class="track-ctx-item" data-action="mute">Mute Track</div>
  <div class="track-ctx-sep"></div>
  <div class="track-ctx-item" data-action="select-all">Select All Clips</div>
  <div class="track-ctx-item" data-action="collapse">Toggle Collapse</div>
  <div class="track-ctx-item" data-action="collapse-all">Collapse All Tracks</div>
  <div class="track-ctx-sep"></div>
  <div class="track-ctx-item danger" data-action="clear">Clear Track</div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ===== SFX ENGINE — DAW Sound Design ===== */
var sfxCtx = null;
function initSFX() {
  if (sfxCtx) return;
  try { sfxCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
}
function sfx(type) {
  if (typeof sfxEnabled !== 'undefined' && !sfxEnabled) return;
  if (!sfxCtx) initSFX();
  if (!sfxCtx) return;
  try {
    if (sfxCtx.state === 'suspended') sfxCtx.resume();
    var now = sfxCtx.currentTime;
    var osc, gain;
    switch(type) {
      case 'click': // UI click — short, crisp
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1200, now);
        osc.frequency.exponentialRampToValueAtTime(800, now + 0.05);
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.06);
        break;
      case 'snap': // Snap to grid
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(2000, now);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.03);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.04);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.04);
        break;
      case 'play': // Transport play — rising tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'stop': // Transport stop — falling tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(660, now);
        osc.frequency.exponentialRampToValueAtTime(220, now + 0.12);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'drop': // Clip dropped — soft thud
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(180, now);
        osc.frequency.exponentialRampToValueAtTime(80, now + 0.08);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'delete': // Clip deleted — descending sweep
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
        gain.gain.setValueAtTime(0.06, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.15);
        break;
      case 'preset': // Preset loaded — chord
        [440, 554, 659].forEach(function(freq, i) {
          var o = sfxCtx.createOscillator();
          var g = sfxCtx.createGain();
          o.type = 'sine';
          o.frequency.setValueAtTime(freq, now + i * 0.04);
          g.gain.setValueAtTime(0.06, now + i * 0.04);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
          o.connect(g); g.connect(sfxCtx.destination);
          o.start(now + i * 0.04); o.stop(now + 0.3);
        });
        break;
      case 'undo': // Undo — quick reverse
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(300, now + 0.08);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.1);
        break;
      case 'rec': // Record — pulsing tone
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.setValueAtTime(0.02, now + 0.05);
        gain.gain.setValueAtTime(0.1, now + 0.1);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.2);
        break;
      case 'metronome': // Metronome tick — downbeat accent
        osc = sfxCtx.createOscillator();
        gain = sfxCtx.createGain();
        osc.type = 'sine';
        var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
        var isDownbeat = (beatCounter % bpb === 0);
        osc.frequency.setValueAtTime(isDownbeat ? 1500 : 1000, now);
        var vol = (typeof metroVolume !== 'undefined' ? metroVolume : 0.5) * (isDownbeat ? 0.15 : 0.08);
        gain.gain.setValueAtTime(vol, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
        osc.connect(gain); gain.connect(sfxCtx.destination);
        osc.start(now); osc.stop(now + 0.03);
        break;
    }
  } catch(e) {}
}

/* Init SFX on first user interaction */
document.addEventListener('click', function() { initSFX(); }, {once: true});
document.addEventListener('touchstart', function() { initSFX(); }, {once: true});

/* ===== EXERCISE DATABASE (from Victory Belt CC Movement Matrix) ===== */
var EXERCISES = [
  /* Horizontal Push (Pattern 1) */
  {id:'P1-01',name:'Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-02',name:'Diamond Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-03',name:'Wide Push Up',pattern:'Horizontal Push',stage:1,discipline:'Bodybuilding',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-04',name:'Decline Push Up',pattern:'Horizontal Push',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-05',name:'Archer Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-06',name:'Pseudo Planche PU',pattern:'Horizontal Push',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-07',name:'Ring Push Up',pattern:'Horizontal Push',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-08',name:'One Arm Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P1-09',name:'Planche Push Up',pattern:'Horizontal Push',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Horizontal Pull (Pattern 2) */
  {id:'P2-01',name:'Inverted Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-02',name:'Ring Row',pattern:'Horizontal Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-03',name:'Archer Row',pattern:'Horizontal Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-04',name:'Tuck Front Lever',pattern:'Horizontal Pull',stage:2,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-05',name:'Front Lever Row',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  {id:'P2-06',name:'Front Lever',pattern:'Horizontal Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Downward Press (Pattern 3) */
  {id:'P3-01',name:'Dip',pattern:'Downward Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-02',name:'Ring Dip',pattern:'Downward Press',stage:2,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-03',name:'Korean Dip',pattern:'Downward Press',stage:2,discipline:'Freestyle',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-04',name:'Weighted Dip',pattern:'Downward Press',stage:2,discipline:'Street Lifting',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-05',name:'Tuck Planche',pattern:'Downward Press',stage:2,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  {id:'P3-06',name:'Full Planche',pattern:'Downward Press',stage:3,discipline:'Power-Free',family:'Push',color:'var(--accent-blue)'},
  /* Vertical Pull (Pattern 4) */
  {id:'P4-01',name:'Dead Hang',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-02',name:'Pull Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-03',name:'Chin Up',pattern:'Vertical Pull',stage:1,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-04',name:'L-Sit Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-05',name:'Archer Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-06',name:'Muscle Up (Bar)',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-07',name:'Ring Muscle Up',pattern:'Vertical Pull',stage:2,discipline:'Calisthenics',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-08',name:'Weighted Pull Up',pattern:'Vertical Pull',stage:2,discipline:'Street Lifting',family:'Pull',color:'var(--accent-purple)'},
  {id:'P4-09',name:'One Arm Pull Up',pattern:'Vertical Pull',stage:3,discipline:'Power-Free',family:'Pull',color:'var(--accent-purple)'},
  /* Overhead Press (Pattern 5) */
  {id:'P5-01',name:'Pike Push Up',pattern:'Overhead Press',stage:1,discipline:'Calisthenics',family:'Push',color:'var(--accent-blue)'},
  {id:'P5-02',name:'Wall Handstand Hold',pattern:'Overhead Press',stage:1,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-03',name:'Wall HSPU',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-04',name:'Free Handstand',pattern:'Overhead Press',stage:2,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-05',name:'Handstand Push Up',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  {id:'P5-06',name:'Press to Handstand',pattern:'Overhead Press',stage:3,discipline:'Hand-Balancing',family:'Skills',color:'var(--accent-cyan)'},
  /* Knee-Dominant (Pattern 6) */
  {id:'P6-01',name:'Bodyweight Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-02',name:'Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-03',name:'Bulgarian Split Squat',pattern:'Knee-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-04',name:'Pistol Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-05',name:'Shrimp Squat',pattern:'Knee-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-06',name:'Cossack Squat',pattern:'Knee-Dominant',stage:2,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  {id:'P6-07',name:'Dragon Squat',pattern:'Knee-Dominant',stage:3,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  /* Hip-Dominant (Pattern 7) */
  {id:'P7-01',name:'Glute Bridge',pattern:'Hip-Dominant',stage:1,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-02',name:'Nordic Curl',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-03',name:'Wrestler Bridge',pattern:'Hip-Dominant',stage:2,discipline:'Calisthenics',family:'Legs',color:'var(--accent-green)'},
  {id:'P7-04',name:'Stand to Bridge',pattern:'Hip-Dominant',stage:3,discipline:'Mobility',family:'Legs',color:'var(--accent-green)'},
  /* Core */
  {id:'C-01',name:'Hollow Body Hold',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-02',name:'Plank',pattern:'Core',stage:1,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-03',name:'L-Sit',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-04',name:'V-Sit',pattern:'Core',stage:3,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-05',name:'Dragon Flag',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  {id:'C-06',name:'Ab Wheel Rollout',pattern:'Core',stage:2,discipline:'Calisthenics',family:'Core',color:'var(--accent-orange)'},
  /* Mobility */
  {id:'M-01',name:'Resting Squat',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-02',name:'Pancake Stretch',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-03',name:'Front Split',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-04',name:'Thoracic Bridge',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-05',name:'German Hang',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-06',name:'Hip CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'},
  {id:'M-07',name:'Scapular CARs',pattern:'Mobility',stage:0,discipline:'Mobility',family:'Flow',color:'var(--accent-pink)'}
];

/* Movement family -> instrument role (from Composition Engine) */
var FAMILY_MAP = {
  'Push': {instrument:'Percussion',color:'#3b82f6'},
  'Pull': {instrument:'Bass',color:'#8b5cf6'},
  'Legs': {instrument:'Rhythm Guitar',color:'#22c55e'},
  'Core': {instrument:'Harmony',color:'#f97316'},
  'Skills': {instrument:'Lead Melody',color:'#06b6d4'},
  'Flow': {instrument:'Ambient Pad',color:'#ec4899'}
};

/* BPM -> Training Mode (from Composition Engine) */
var BPM_MODES = [
  {min:40,max:80,name:'Slow Strength',desc:'Control, holds, precision'},
  {min:80,max:120,name:'Standard',desc:'Tempo work, sets'},
  {min:120,max:160,name:'Flow State',desc:'Conditioning, flow'},
  {min:160,max:200,name:'Explosive',desc:'Power, speed, intensity'}
];

/* Track definitions */
var TRACKS = [
  {id:'music',name:'Music',family:'_music',info:'Audio',isMusic:true},
  {id:'push',name:'Push',family:'Push',info:'Percussion'},
  {id:'pull',name:'Pull',family:'Pull',info:'Bass'},
  {id:'core',name:'Core',family:'Core',info:'Harmony'},
  {id:'legs',name:'Legs',family:'Legs',info:'Rhythm'},
  {id:'skills',name:'Skills',family:'Skills',info:'Lead'}
];

/* Fader definitions */
var FADERS = [
  {id:'intensity',label:'Intensity',value:70,color:'var(--gradient-titan)'},
  {id:'volume',label:'Volume',value:50,color:'var(--gradient-titan)'},
  {id:'density',label:'Density',value:60,color:'var(--gradient-titan)'},
  {id:'rest',label:'Rest',value:40,color:'var(--gradient-titan)'}
];

/* Knob definitions */
var KNOBS = [
  {id:'str-mob',label:'Str / Mob',value:0.5},
  {id:'pwr-ctrl',label:'Pwr / Ctrl',value:0.5},
  {id:'sta-dyn',label:'Sta / Dyn',value:0.5}
];

/* Preset definitions */
var PRESETS = {
  monk: {
    name:'Monk Mode',bpm:65,
    clips:[
      {track:'core',name:'Hollow Body Hold',x:0,w:120},
      {track:'push',name:'Push Up',x:20,w:100},
      {track:'core',name:'L-Sit',x:140,w:100},
      {track:'pull',name:'Pull Up',x:140,w:100},
      {track:'skills',name:'Free Handstand',x:260,w:120},
      {track:'legs',name:'Resting Squat',x:260,w:80}
    ],
    faders:{intensity:40,volume:30,density:30,rest:70},
    knobs:{'str-mob':0.4,'pwr-ctrl':0.3,'sta-dyn':0.2}
  },
  beast: {
    name:'Beast Mode',bpm:140,
    clips:[
      {track:'push',name:'Diamond Push Up',x:0,w:100},
      {track:'pull',name:'Muscle Up (Bar)',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:120,w:80},
      {track:'push',name:'Dip',x:120,w:80},
      {track:'core',name:'Dragon Flag',x:120,w:80},
      {track:'pull',name:'Weighted Pull Up',x:220,w:100},
      {track:'legs',name:'Shrimp Squat',x:220,w:80},
      {track:'push',name:'Planche Push Up',x:340,w:100}
    ],
    faders:{intensity:90,volume:80,density:85,rest:20},
    knobs:{'str-mob':0.8,'pwr-ctrl':0.7,'sta-dyn':0.9}
  },
  flow: {
    name:'Flow Ritual',bpm:100,
    clips:[
      {track:'legs',name:'Hip CARs',x:0,w:80},
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'core',name:'Hollow Body Hold',x:100,w:80},
      {track:'pull',name:'Ring Row',x:100,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:200,w:100},
      {track:'legs',name:'Cossack Squat',x:200,w:80},
      {track:'core',name:'L-Sit',x:300,w:80},
      {track:'push',name:'Ring Push Up',x:300,w:100}
    ],
    faders:{intensity:55,volume:60,density:65,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.4,'sta-dyn':0.6}
  },
  skill: {
    name:'Skill Ascension',bpm:75,
    clips:[
      {track:'skills',name:'Free Handstand',x:0,w:160},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'pull',name:'Tuck Front Lever',x:180,w:140},
      {track:'push',name:'Tuck Planche',x:180,w:140},
      {track:'core',name:'V-Sit',x:180,w:80},
      {track:'skills',name:'Press to Handstand',x:340,w:160}
    ],
    faders:{intensity:60,volume:40,density:35,rest:80},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.3,'sta-dyn':0.15}
  },
  upper: {
    name:'Upper Day',bpm:100,
    clips:[
      {track:'push',name:'Push Up',x:0,w:100},
      {track:'push',name:'Dip',x:120,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Inverted Row',x:120,w:100},
      {track:'push',name:'Ring Push Up',x:240,w:100},
      {track:'pull',name:'Chin Up',x:240,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'L-Sit',x:120,w:80},
      {track:'skills',name:'Wall Handstand Hold',x:360,w:120}
    ],
    faders:{intensity:65,volume:60,density:55,rest:50},
    knobs:{'str-mob':0.7,'pwr-ctrl':0.5,'sta-dyn':0.4}
  },
  lower: {
    name:'Lower Day',bpm:90,
    clips:[
      {track:'legs',name:'Bodyweight Squat',x:0,w:100},
      {track:'legs',name:'Bulgarian Split Squat',x:120,w:100},
      {track:'legs',name:'Pistol Squat',x:240,w:100},
      {track:'legs',name:'Nordic Curl',x:360,w:100},
      {track:'legs',name:'Cossack Squat',x:480,w:80},
      {track:'core',name:'Dragon Flag',x:0,w:100},
      {track:'core',name:'Ab Wheel Rollout',x:120,w:80},
      {track:'legs',name:'Glute Bridge',x:600,w:80},
      {track:'skills',name:'Resting Squat',x:0,w:120}
    ],
    faders:{intensity:70,volume:55,density:60,rest:45},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.6,'sta-dyn':0.5}
  },
  ppl: {
    name:'Push / Pull / Legs',bpm:110,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'push',name:'Pseudo Planche PU',x:120,w:100},
      {track:'push',name:'Pike Push Up',x:240,w:80},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'pull',name:'Ring Row',x:120,w:80},
      {track:'pull',name:'Tuck Front Lever',x:220,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'legs',name:'Nordic Curl',x:120,w:100},
      {track:'core',name:'Hollow Body Hold',x:0,w:80},
      {track:'core',name:'Dragon Flag',x:100,w:80}
    ],
    faders:{intensity:75,volume:65,density:70,rest:35},
    knobs:{'str-mob':0.6,'pwr-ctrl':0.6,'sta-dyn':0.6}
  },
  fullbody: {
    name:'Full Body',bpm:105,
    clips:[
      {track:'push',name:'Dip',x:0,w:100},
      {track:'pull',name:'Pull Up',x:0,w:100},
      {track:'legs',name:'Pistol Squat',x:0,w:100},
      {track:'core',name:'L-Sit',x:0,w:80},
      {track:'skills',name:'Free Handstand',x:0,w:120},
      {track:'push',name:'Ring Push Up',x:140,w:80},
      {track:'pull',name:'Archer Pull Up',x:140,w:80},
      {track:'legs',name:'Bulgarian Split Squat',x:140,w:80},
      {track:'core',name:'Ab Wheel Rollout',x:140,w:80}
    ],
    faders:{intensity:60,volume:55,density:50,rest:50},
    knobs:{'str-mob':0.5,'pwr-ctrl':0.5,'sta-dyn':0.5}
  }
};

/* ===== STATE ===== */
var isPlaying = false, currentTime = 0, bpm = 120, playInterval = null;
var isRecording = false, tempoLinked = false, playbackSpeed = 1, _userSelectedDuringPlayback = false;
var selectedClip = null, musicPlaying = false, musicIndex = 0;
var audioEl = null;
var meterInterval = null;
var undoStack = [], redoStack = [], maxUndo = 30;
var metronomeEnabled = false, lastBeatTime = 0, beatCounter = 0;
var loopEnabled = false, loopStart = 0, loopEnd = 60;
var markers = [], markerCounter = 0;

/* Music tracks (from Vercel Blob CDN) */
var MUSIC_TRACKS = [
  {name:'Celestial Reverie',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Celestial%20Reverie.mp3'},
  {name:'Blue Phoenix',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Blue%20Phoenix.mp3'},
  {name:'Veil of Truth',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Veil%20of%20Truth.mp3'},
  {name:'Astral Shadows',url:'https://3ckkexkrejur8qsy.public.blob.vercel-storage.com/audio/Astral%20Shadows.mp3'}
];

/* ===== INIT ===== */
document.addEventListener('DOMContentLoaded', function() {
  buildLibrary();
  restoreCategoryState();
  buildTracks();
  buildRuler();
  buildFaders();
  buildKnobs();
  buildMeters();
  loadSession();
  loadFromHash();
  updateBPMMode();
  updateEmptyState();
});

/* ===== LIBRARY ===== */
function buildLibrary() {
  var container = document.getElementById('library-container');
  var groups = {};
  EXERCISES.forEach(function(ex) {
    var g = ex.pattern;
    if (!groups[g]) groups[g] = [];
    groups[g].push(ex);
  });
  var html = '';
  var patterns = ['Horizontal Push','Horizontal Pull','Downward Press','Vertical Pull','Overhead Press','Knee-Dominant','Hip-Dominant','Core','Mobility'];
  patterns.forEach(function(p) {
    var exs = groups[p];
    if (!exs) return;
    var fam = exs[0].family;
    var fm = FAMILY_MAP[fam] || {color:'#666'};
    html += '<div class="movement-category" data-pattern="'+p+'">';
    html += '<div class="category-header" onclick="toggleCategory(this)"><span>'+p+' ('+exs.length+')</span><div style="display:flex;align-items:center;gap:6px"><div class="category-color" style="background:'+fm.color+'"></div><span class="arrow">&#9660;</span></div></div>';
    html += '<div class="movement-list">';
    exs.forEach(function(ex) {
      html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" data-family="'+ex.family+'">';
      html += '<div class="mv-icon" style="background:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
      html += '<span>'+ex.name+'</span>';
      html += '<span class="mv-stage">S'+ex.stage+'</span>';
      html += '<div class="mv-detail">'+ex.discipline+' | '+ex.family+' | Stage '+ex.stage+'</div>';
      html += '</div>';
    });
    html += '</div></div>';
  });
  container.innerHTML = html;
  document.getElementById('lib-count').textContent = EXERCISES.length;
  initDragDrop();
}

function toggleCategory(header) {
  header.classList.toggle('collapsed');
  var list = header.nextElementSibling;
  list.classList.toggle('hidden');
  saveCategoryState();
}

function saveCategoryState() {
  try {
    var state = {};
    document.querySelectorAll('.movement-category[data-pattern]').forEach(function(cat) {
      var h = cat.querySelector('.category-header');
      if (h && h.classList.contains('collapsed')) {
        state[cat.dataset.pattern] = true;
      }
    });
    localStorage.setItem('sms_lib_collapsed', JSON.stringify(state));
  } catch(e) {}
}

function restoreCategoryState() {
  try {
    var saved = localStorage.getItem('sms_lib_collapsed');
    if (!saved) return;
    var state = JSON.parse(saved);
    document.querySelectorAll('.movement-category[data-pattern]').forEach(function(cat) {
      if (state[cat.dataset.pattern]) {
        var h = cat.querySelector('.category-header');
        var l = cat.querySelector('.movement-list');
        if (h) h.classList.add('collapsed');
        if (l) l.classList.add('hidden');
      }
    });
  } catch(e) {}
}

var _libStageFilter = 'all';
var _libDiscFilter = 'all';
function filterByStage(stage) {
  _libStageFilter = stage;
  document.querySelectorAll('.lib-stage-btn').forEach(function(btn) {
    var isActive = btn.dataset.stage === String(stage);
    btn.style.background = isActive ? 'rgba(255,255,255,0.06)' : 'rgba(255,255,255,0.03)';
    btn.style.color = isActive ? 'var(--text-secondary)' : 'var(--muted)';
  });
  filterLibrary();
}
function filterByDiscipline(disc) {
  _libDiscFilter = disc;
  filterLibrary();
}
function filterLibrary() {
  var q = document.getElementById('lib-search').value.toLowerCase();
  var items = document.querySelectorAll('.movement-item');
  var count = 0;
  items.forEach(function(item) {
    var ex = getExercise(item.dataset.id);
    var matchText = item.textContent.toLowerCase().indexOf(q) !== -1;
    var matchStage = _libStageFilter === 'all' || (ex && ex.stage === _libStageFilter);
    var matchDisc = _libDiscFilter === 'all' || (ex && ex.discipline === _libDiscFilter);
    var show = matchText && matchStage && matchDisc;
    item.style.display = show ? '' : 'none';
    if (show) count++;
  });
  document.getElementById('lib-count').textContent = count;
  if (q || _libStageFilter !== 'all' || _libDiscFilter !== 'all') {
    document.querySelectorAll('.movement-list').forEach(function(l) { l.classList.remove('hidden'); });
    document.querySelectorAll('.category-header').forEach(function(h) { h.classList.remove('collapsed'); });
  }
}

function addFirstMatch() {
  var q = document.getElementById('lib-search').value.toLowerCase().trim();
  if (!q) return;
  // Find first matching exercise
  var match = null;
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].name.toLowerCase().indexOf(q) !== -1) {
      match = EXERCISES[i]; break;
    }
  }
  if (!match) { toast('No match found'); return; }
  // Find active track or matching family track
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) {
    // Find track by family
    var familyToTrack = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
    var trackId = familyToTrack[match.family] || 'push';
    activeTrack = document.querySelector('.track-content[data-track="'+trackId+'"]');
  }
  if (!activeTrack || activeTrack.dataset.track === 'music') {
    var familyToTrack = {Push:'push',Pull:'pull',Core:'core',Legs:'legs',Skills:'skills',Flow:'skills'};
    activeTrack = document.querySelector('.track-content[data-track="'+(familyToTrack[match.family] || 'push')+'"]');
  }
  // Place after last clip in that track
  var clips = activeTrack.querySelectorAll('.clip');
  var x = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > x) x = r;
  });
  addClip(activeTrack, match, x + 4);
  document.getElementById('lib-search').value = '';
  filterLibrary();
}

/* ===== TRACKS ===== */
function buildTracks() {
  var container = document.getElementById('timeline-tracks');
  var ph = container.querySelector('.playhead');
  var html = '';
  TRACKS.forEach(function(t, ti) {
    if (t.isMusic) {
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-num">1</div><div class="track-name" style="color:var(--accent-cyan)">'+t.name+'</div>';
      html += '<select class="track-select" id="music-track-select" onchange="selectMusicTrack(this.value)" style="font-size:8px;padding:2px 4px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text);width:88px;font-family:Sora,sans-serif;border-radius:2px">';
      html += '<option value="">--</option>';
      MUSIC_TRACKS.forEach(function(mt,i) { html += '<option value="'+i+'">'+mt.name+'</option>'; });
      html += '</select></div>';
      html += '<div class="track-content" data-track="'+t.id+'" style="pointer-events:none;position:relative"><canvas id="music-waveform-canvas" style="position:absolute;top:8px;left:100px;right:0;height:44px;opacity:0.3"></canvas><span id="music-timeline-label" style="font-size:8px;color:var(--micro);padding:4px 8px;display:inline-block;position:relative;z-index:1">Select a track</span></div></div>';
    } else {
      var fm = FAMILY_MAP[t.family] || {color:'#666'};
      html += '<div class="track" data-track="'+t.id+'">';
      html += '<div class="track-header"><div class="track-num">'+(ti+1)+'</div><div class="track-grip"><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div><div class="track-grip-dot"></div></div><div class="track-name" style="color:'+fm.color+'">'+t.name+'</div><div class="track-info">'+t.info+' <span style="color:'+fm.color+';opacity:0.5">| '+(fm.instrument||'')+'</span></div>';
      html += '<div class="track-controls"><button class="track-btn" onclick="toggleMute(this)" data-tip="Mute">M</button><button class="track-btn" onclick="toggleSolo(this)" data-tip="Solo">S</button><button class="track-btn" onclick="toggleArm(this)" data-tip="Arm" style="color:var(--micro)">R</button></div>';
      html += '<div class="track-clip-count" id="track-count-'+t.id+'">0 clips</div>';
      html += '<div class="track-vu" id="vu-'+t.id+'"><div class="track-vu-dot"></div><div class="track-vu-dot"></div><div class="track-vu-dot"></div><div class="track-vu-dot"></div><div class="track-vu-dot"></div></div>';
      html += '</div>';
      html += '<div class="track-content" data-track="'+t.id+'"></div></div>';
    }
  });
  container.innerHTML = html;
  container.insertBefore(ph, container.firstChild);
}

function selectMusicTrack(idx) {
  if (idx === '') {
    document.getElementById('music-timeline-label').textContent = 'Select a track';
    return;
  }
  musicIndex = parseInt(idx);
  var track = MUSIC_TRACKS[musicIndex];
  document.getElementById('music-timeline-label').textContent = track.name;
  document.getElementById('music-track-name').textContent = track.name;
  if (!audioEl) { audioEl = new Audio(); audioEl.volume = 0.5; audioEl.addEventListener('ended', function() { musicNext(); }); }
  audioEl.src = track.url;
  audioEl.load();
  drawMusicWaveform(track.name);
  toast('Music: ' + track.name);
}

function buildRuler() {
  var ruler = document.getElementById('timeline-ruler');
  var beatDuration = 60 / bpm;
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barDuration = beatDuration * bpb;
  var html = '<div class="ruler-mark" style="flex:0 0 100px"><span style="color:var(--muted)">1</span></div>';
  for (var i = 15; i <= 300; i += 15) {
    var m = Math.floor(i / 60);
    var s = i % 60;
    var barNum = Math.floor(i / barDuration) + 1;
    var isDownbeat = barNum % 4 === 1;
    var barColor = isDownbeat ? 'var(--text-secondary)' : 'var(--micro)';
    var barWeight = isDownbeat ? 'font-weight:600' : '';
    html += '<div class="ruler-mark'+(isDownbeat?' ruler-downbeat':'')+'">'+m+':'+s.toString().padStart(2,'0')+' <span style="color:'+barColor+';font-size:7px;'+barWeight+'">|'+barNum+'</span></div>';
  }
  ruler.innerHTML = html;
}

/* ===== DRAG & DROP ===== */
function initDragDrop() {
  document.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.4';
      // Custom drag image — looks like a mini clip
      var ghost = document.createElement('div');
      ghost.textContent = ex.name;
      ghost.style.cssText = 'position:absolute;top:-999px;left:-999px;padding:4px 10px;font-size:9px;font-weight:600;font-family:Sora,sans-serif;background:' + (FAMILY_MAP[ex.family] || {color:'#666'}).color + ';color:rgba(255,255,255,0.9);border-radius:3px;white-space:nowrap;border-top:2px solid rgba(255,255,255,0.3)';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 0, 0);
      setTimeout(function() { document.body.removeChild(ghost); }, 0);
      sfx('click');
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
  document.querySelectorAll('.track-content').forEach(function(track) {
    var ghostPreview = null;
    track.addEventListener('dragover', function(e) {
      e.preventDefault();
      track.classList.add('drag-over');
      // Show ghost clip preview at cursor position
      if (!ghostPreview) {
        ghostPreview = document.createElement('div');
        ghostPreview.className = 'clip';
        ghostPreview.style.cssText = 'width:80px;opacity:0.3;pointer-events:none;z-index:10;border:1px dashed rgba(255,255,255,0.2);background:rgba(255,255,255,0.03)';
        track.appendChild(ghostPreview);
      }
      var rect = track.getBoundingClientRect();
      var x = e.clientX - rect.left + (track.parentElement.parentElement ? track.parentElement.parentElement.scrollLeft : 0);
      ghostPreview.style.left = snapValue(x) + 'px';
    });
    track.addEventListener('dragleave', function() {
      track.classList.remove('drag-over');
      if (ghostPreview && ghostPreview.parentNode) { ghostPreview.remove(); ghostPreview = null; }
    });
    track.addEventListener('drop', function(e) {
      e.preventDefault();
      track.classList.remove('drag-over');
      if (ghostPreview && ghostPreview.parentNode) { ghostPreview.remove(); ghostPreview = null; }
      try {
        var ex = JSON.parse(e.dataTransfer.getData('text/plain'));
        var rect = track.getBoundingClientRect();
        var x = e.clientX - rect.left + track.parentElement.parentElement.scrollLeft;
        addClip(track, ex, x);
      } catch(err) {}
    });
    // Double-click empty area to add random exercise matching this track's family
    track.addEventListener('dblclick', function(e) {
      if (e.target.closest('.clip')) return; // ignore clicks on existing clips
      var trackId = track.dataset.track;
      if (trackId === 'music') return;
      var trackDef = TRACKS.find(function(t) { return t.id === trackId; });
      if (!trackDef) return;
      var familyExercises = EXERCISES.filter(function(ex) { return ex.family === trackDef.family; });
      if (familyExercises.length === 0) return;
      var ex = familyExercises[Math.floor(Math.random() * familyExercises.length)];
      var rect = track.getBoundingClientRect();
      var x = e.clientX - rect.left + (track.parentElement.parentElement ? track.parentElement.parentElement.scrollLeft : 0);
      addClip(track, ex, snapValue(x));
    });
    // Marquee rubber-band selection on empty area
    track.addEventListener('mousedown', function(e) {
      if (e.target.closest('.clip') || e.button !== 0) return;
      var trackId = track.dataset.track;
      if (trackId === 'music') return;
      var rect = track.getBoundingClientRect();
      var startX = e.clientX - rect.left;
      var startY = e.clientY - rect.top;
      var marquee = document.createElement('div');
      marquee.className = 'marquee-selection';
      track.style.position = 'relative';
      track.appendChild(marquee);
      function onMove(ev) {
        var curX = ev.clientX - rect.left;
        var curY = ev.clientY - rect.top;
        var left = Math.min(startX, curX);
        var top = Math.min(startY, curY);
        var w = Math.abs(curX - startX);
        var h = Math.abs(curY - startY);
        marquee.style.left = left + 'px';
        marquee.style.top = top + 'px';
        marquee.style.width = w + 'px';
        marquee.style.height = h + 'px';
        // Highlight clips that intersect marquee
        var mLeft = left; var mRight = left + w;
        track.querySelectorAll('.clip').forEach(function(c) {
          var cLeft = parseInt(c.style.left) || 0;
          var cRight = cLeft + (parseInt(c.style.width) || 80);
          if (cRight > mLeft && cLeft < mRight) {
            c.classList.add('selected');
          } else if (!ev.shiftKey) {
            c.classList.remove('selected');
          }
        });
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        if (marquee.parentNode) marquee.remove();
        var sel = track.querySelectorAll('.clip.selected');
        if (sel.length === 1) selectClipEl(sel[0]);
        else if (sel.length > 1) toast(sel.length + ' clips selected');
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
}

function getExercise(id) {
  for (var i = 0; i < EXERCISES.length; i++) {
    if (EXERCISES[i].id === id) return EXERCISES[i];
  }
  return null;
}

/* ===== CLIPS ===== */
function drawClipWaveform(canvas, color, width, opacity, rpeScale) {
  if (!canvas || !canvas.getContext) return;
  var w = parseInt(width) || 80;
  canvas.width = w - 8;
  canvas.height = 20;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = color;
  ctx.globalAlpha = opacity || 0.35;
  var mid = canvas.height / 2;
  var seed = w * 7 + canvas.width;
  var intensityScale = rpeScale ? (0.5 + (rpeScale / 10) * 0.5) : 1;
  for (var x = 0; x < canvas.width; x += 1) {
    var v = Math.sin(x * 0.15 + seed * 0.01) * 0.4 +
            Math.sin(x * 0.08 + seed * 0.02) * 0.3 +
            Math.sin(x * 0.3 + seed * 0.005) * 0.2 +
            Math.sin(x * 0.5 + seed * 0.03) * 0.1;
    var amp = (mid - 2) * Math.abs(v) * intensityScale;
    ctx.fillRect(x, mid - amp, 1, amp * 2);
  }
}

/* Add beat marker dividers inside clips based on BPM */
function addBeatMarkers(clipEl, widthPx) {
  var existing = clipEl.querySelector('.beat-markers');
  if (existing) existing.remove();
  var w = parseInt(widthPx) || parseInt(clipEl.style.width) || 80;
  var pps = 80 / 15; // pixels per second
  var beatSec = 60 / bpm;
  var beatPx = beatSec * pps;
  if (beatPx < 8) return; // Too dense to show
  var container = document.createElement('div');
  container.className = 'beat-markers';
  for (var px = beatPx; px < w; px += beatPx) {
    var marker = document.createElement('span');
    marker.style.left = px + 'px';
    container.appendChild(marker);
  }
  clipEl.appendChild(container);
}

function createClipElement(exercise, left, width, dna) {
  var fm = FAMILY_MAP[exercise.family] || {color:'#666'};
  var clip = document.createElement('div');
  clip.className = 'clip';
  var baseColor = fm.color;
  // Stage-based opacity + RPE intensity for visual differentiation
  var rpeVal = parseInt((dna && dna.rpe) || '7');
  var stageBase = exercise.stage === 1 ? 170 : exercise.stage === 2 ? 200 : 230;
  var rpeBoost = Math.round((rpeVal / 10) * 25);
  var alphaTop = Math.min(255, stageBase + rpeBoost).toString(16).padStart(2, '0');
  var alphaBot = Math.min(255, 130 + rpeBoost).toString(16).padStart(2, '0');
  clip.style.background = 'linear-gradient(180deg, ' + baseColor + alphaTop + ' 0%, ' + baseColor + alphaBot + ' 100%)';
  clip.style.borderTopColor = baseColor;
  // Discipline bottom-border accent (subtle visual coding)
  var discColors = {'Calisthenics':'#3b82f6','Power-Free':'#f97316','Bodybuilding':'#ef4444','Street Lifting':'#a855f7','Hand-Balancing':'#06b6d4','Freestyle':'#ec4899','Mobility':'#22c55e'};
  var discColor = discColors[exercise.discipline] || baseColor;
  clip.style.borderBottom = '1px solid ' + discColor + '40';
  clip.setAttribute('data-tip', exercise.name + ' | ' + exercise.family + ' | S' + exercise.stage + ' | ' + exercise.discipline);
  clip.style.left = (typeof left === 'string' ? left : Math.max(0, left) + 'px');
  clip.style.width = (typeof width === 'string' ? width : (width || 80) + 'px');
  clip.style.color = 'rgba(255,255,255,0.9)';
  clip.dataset.exerciseId = exercise.id;
  clip.dataset.sets = (dna && dna.sets) || '3';
  clip.dataset.reps = (dna && dna.reps) || '8';
  clip.dataset.tempo = (dna && dna.tempo) || '3';
  clip.dataset.rest = (dna && dna.rest) || '60';
  clip.dataset.rpe = (dna && dna.rpe) || '7';

  // RPE velocity strip — color-coded intensity bar at top
  var velocity = document.createElement('div');
  velocity.className = 'clip-velocity';
  var rpeN = parseInt(clip.dataset.rpe);
  var velColor = rpeN >= 9 ? '#ef4444' : rpeN >= 7 ? '#f97316' : rpeN >= 5 ? '#eab308' : '#22c55e';
  var velAlpha = 0.3 + (rpeN / 10) * 0.5;
  velocity.style.background = 'linear-gradient(90deg, ' + velColor + Math.round(velAlpha * 255).toString(16).padStart(2,'0') + ', transparent)';
  clip.appendChild(velocity);

  var label = document.createElement('span');
  label.className = 'clip-name';
  label.textContent = exercise.name;
  label.style.position = 'relative';
  label.style.zIndex = '1';
  clip.appendChild(label);

  var info = document.createElement('span');
  info.className = 'clip-info';
  var clipSec = Math.round(parseInt(clip.style.width) / 80 * 15);
  info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps + ' ' + clipSec + 's';
  info.style.position = 'relative';
  info.style.zIndex = '1';
  clip.appendChild(info);

  // Stage dots (S1=1dot, S2=2dots, S3=3dots)
  var dotsEl = document.createElement('div');
  dotsEl.className = 'clip-stage-dots';
  for (var di = 0; di < 3; di++) {
    var dot = document.createElement('div');
    dot.className = 'clip-stage-dot' + (di < exercise.stage ? ' filled' : '');
    dotsEl.appendChild(dot);
  }
  clip.appendChild(dotsEl);

  var rpeBadge = document.createElement('div');
  rpeBadge.className = 'clip-rpe-badge';
  rpeBadge.textContent = clip.dataset.rpe || 7;
  clip.appendChild(rpeBadge);

  var canvas = document.createElement('canvas');
  canvas.className = 'clip-waveform';
  clip.appendChild(canvas);
  // Waveform: family color + stage-based density
  var waveOpacity = exercise.stage === 1 ? 0.35 : exercise.stage === 2 ? 0.5 : 0.65;
  var waveColor = baseColor || '#fff';
  var waveRpe = parseInt(clip.dataset.rpe) || 7;
  setTimeout(function() {
    drawClipWaveform(canvas, waveColor, clip.style.width, waveOpacity, waveRpe);
    addBeatMarkers(clip, clip.style.width);
  }, 10);

  var progress = document.createElement('div');
  progress.className = 'clip-progress';
  clip.appendChild(progress);

  var progressFill = document.createElement('div');
  progressFill.className = 'clip-progress-fill';
  clip.appendChild(progressFill);

  var fadeIn = document.createElement('div');
  fadeIn.className = 'clip-fade clip-fade-in';
  clip.appendChild(fadeIn);
  var fadeOut = document.createElement('div');
  fadeOut.className = 'clip-fade clip-fade-out';
  clip.appendChild(fadeOut);

  // Fade handle drag — visual fade overlay + persist width
  function setupFadeDrag(fadeEl, isIn) {
    fadeEl.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      var startX = e.clientX;
      function onMove(e) {
        var delta = Math.abs(e.clientX - startX);
        var maxFade = parseInt(clip.style.width) / 2;
        var w = Math.min(Math.max(0, delta), maxFade);
        fadeEl.style.width = w + 'px';
        fadeEl.classList.toggle('has-fade', w > 2);
        clip.dataset[isIn ? 'fadeIn' : 'fadeOut'] = Math.round(w);
        updateFadeOverlay(clip);
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        saveSession();
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  }
  setupFadeDrag(fadeIn, true);
  setupFadeDrag(fadeOut, false);
  // Restore fade widths from DNA
  if (dna && dna.fadeIn && parseInt(dna.fadeIn) > 0) {
    fadeIn.style.width = dna.fadeIn + 'px';
    fadeIn.classList.add('has-fade');
    clip.dataset.fadeIn = dna.fadeIn;
  }
  if (dna && dna.fadeOut && parseInt(dna.fadeOut) > 0) {
    fadeOut.style.width = dna.fadeOut + 'px';
    fadeOut.classList.add('has-fade');
    clip.dataset.fadeOut = dna.fadeOut;
  }
  if (dna && (dna.fadeIn || dna.fadeOut)) updateFadeOverlay(clip);

  var resize = document.createElement('div');
  resize.className = 'clip-resize';
  clip.appendChild(resize);

  // Left resize handle
  var resizeL = document.createElement('div');
  resizeL.className = 'clip-resize-left';
  resizeL.style.cssText = 'position:absolute;left:0;top:0;bottom:0;width:5px;cursor:ew-resize;background:transparent;opacity:0;transition:opacity 0.1s;z-index:3';
  clip.appendChild(resizeL);
  resizeL.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startLeft = parseInt(clip.style.left), startW = parseInt(clip.style.width);
    function onMove(e) {
      var delta = e.clientX - startX;
      var newLeft = Math.max(0, startLeft + delta);
      var newW = Math.max(40, startW - delta);
      clip.style.left = newLeft + 'px';
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, waveColor, newW + 'px', waveOpacity, parseInt(clip.dataset.rpe) || 7);
      addBeatMarkers(clip, newW);
      updateStats();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      var rSec = Math.round(parseInt(clip.style.width) / 80 * 15);
      var rInfo = clip.querySelector('.clip-info');
      if (rInfo) rInfo.textContent = clip.dataset.sets + 'x' + clip.dataset.reps + ' ' + rSec + 's';
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Drag clip (with group support + Alt to duplicate)
  clip.addEventListener('mousedown', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize') || e.target === resizeL || e.target.classList.contains('clip-resize-left')) return;
    e.preventDefault();
    if (clip.classList.contains('clip-locked')) { selectClipEl(clip, e.shiftKey); return; }
    if (isPlaying) _userSelectedDuringPlayback = true;
    var altDup = e.altKey;
    var dragClip = clip;
    if (altDup) {
      pushUndo();
      var ex = getExercise(clip.dataset.exerciseId);
      if (ex) {
        var clone = createClipElement(ex, clip.style.left, clip.style.width, {
          sets: clip.dataset.sets, reps: clip.dataset.reps, tempo: clip.dataset.tempo,
          rest: clip.dataset.rest, rpe: clip.dataset.rpe,
          fadeIn: clip.dataset.fadeIn || '0', fadeOut: clip.dataset.fadeOut || '0'
        });
        if (clip.dataset.notes) clone.dataset.notes = clip.dataset.notes;
        if (clip.dataset.customColor) {
          clone.dataset.customColor = clip.dataset.customColor;
          clone.style.background = 'linear-gradient(180deg, ' + clip.dataset.customColor + '44 0%, ' + clip.dataset.customColor + '22 100%)';
          clone.style.borderTopColor = clip.dataset.customColor;
        }
        clip.parentElement.appendChild(clone);
        dragClip = clone;
        selectClipEl(clone, false);
      }
    } else {
      selectClipEl(clip, e.shiftKey);
    }
    var startX = e.clientX, startLeft = parseInt(dragClip.style.left);
    var groupSibs = altDup ? [] : getGroupSiblings(dragClip);
    var sibStarts = groupSibs.map(function(s) { return {el: s, left: parseInt(s.style.left) || 0}; });
    dragClip.classList.add('clip-dragging');
    function onMove(e) {
      var delta = e.clientX - startX;
      var newLeft = Math.max(0, startLeft + delta);
      newLeft = snapValue(newLeft);
      if (snapEnabled) {
        var clipW = parseInt(dragClip.style.width) || 80;
        var rightEdge = newLeft + clipW;
        var threshold = 6;
        var neighbors = dragClip.parentElement.querySelectorAll('.clip');
        for (var si = 0; si < neighbors.length; si++) {
          if (neighbors[si] === dragClip || groupSibs.indexOf(neighbors[si]) !== -1) continue;
          var sL = parseInt(neighbors[si].style.left) || 0;
          var sR = sL + (parseInt(neighbors[si].style.width) || 80);
          if (Math.abs(newLeft - sR) < threshold) { newLeft = sR; break; }
          if (Math.abs(rightEdge - sL) < threshold) { newLeft = sL - clipW; break; }
          if (Math.abs(newLeft - sL) < threshold) { newLeft = sL; break; }
          if (Math.abs(rightEdge - sR) < threshold) { newLeft = sR - clipW; break; }
        }
      }
      dragClip.style.left = Math.max(0, newLeft) + 'px';
      var actualDelta = (parseInt(dragClip.style.left) || 0) - startLeft;
      sibStarts.forEach(function(s) {
        if (s.el === dragClip) return;
        s.el.style.left = Math.max(0, s.left + actualDelta) + 'px';
      });
    }
    function onUp() {
      dragClip.classList.remove('clip-dragging');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      if (altDup) toast('Duplicated');
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Resize clip (stretching shows duration + redraws waveform)
  resize.addEventListener('mousedown', function(e) {
    e.stopPropagation();
    var startX = e.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      var newW = Math.max(40, startW + e.clientX - startX);
      newW = snapEnabled ? Math.max(40, snapValue(newW)) : newW;
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, waveColor, newW + 'px', waveOpacity, parseInt(clip.dataset.rpe) || 7);
      addBeatMarkers(clip, newW);
      var durSec = Math.round(newW / 80 * 15);
      var durM = Math.floor(durSec / 60);
      var durS = durSec % 60;
      var durStr = durM > 0 ? durM + ':' + durS.toString().padStart(2,'0') : durSec + 's';
      clip.title = exercise.name + ' - ' + durStr;
      info.textContent = durStr;
      updateStats();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      var finSec = Math.round(parseInt(clip.style.width) / 80 * 15);
      info.textContent = clip.dataset.sets + 'x' + clip.dataset.reps + ' ' + finSec + 's';
      saveSession(); updateStats();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Right-click context menu (Premiere Pro style)
  clip.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    selectClipEl(clip);
    showClipContextMenu(e.clientX, e.clientY, clip, exercise);
  });

  // Touch drag support
  clip.addEventListener('touchstart', function(e) {
    if (e.target === resize || e.target.classList.contains('clip-resize')) return;
    selectClipEl(clip);
    var touch = e.touches[0];
    var startX = touch.clientX, startLeft = parseInt(clip.style.left);
    function onMove(e) { e.preventDefault(); clip.style.left = Math.max(0, startLeft + e.touches[0].clientX - startX) + 'px'; }
    function onEnd() { clip.removeEventListener('touchmove', onMove); clip.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    clip.addEventListener('touchmove', onMove, {passive: false});
    clip.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Touch resize support
  resize.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    var touch = e.touches[0];
    var startX = touch.clientX, startW = parseInt(clip.style.width);
    function onMove(e) {
      e.preventDefault();
      var newW = Math.max(40, startW + e.touches[0].clientX - startX);
      clip.style.width = newW + 'px';
      drawClipWaveform(canvas, waveColor, newW + 'px', waveOpacity, parseInt(clip.dataset.rpe) || 7);
      addBeatMarkers(clip, newW);
      updateStats();
    }
    function onEnd() { resize.removeEventListener('touchmove', onMove); resize.removeEventListener('touchend', onEnd); saveSession(); updateStats(); }
    resize.addEventListener('touchmove', onMove, {passive: false});
    resize.addEventListener('touchend', onEnd);
  }, {passive: true});

  // Double click / double tap to delete
  var lastTap = 0;
  clip.addEventListener('touchend', function(e) {
    var now = Date.now();
    if (now - lastTap < 300) {
      clip.remove();
      if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      toast('Clip removed');
    }
    lastTap = now;
  });
  clip.addEventListener('dblclick', function() {
    pushUndo();
    clip.remove();
    if (selectedClip === clip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
    updateStats(); saveSession();
    sfx('delete');
    toast('Clip removed');
  });

  if (typeof showClipDetail === 'function') showClipDetail(clip);
  return clip;
}

function addClip(track, exercise, x) {
  pushUndo();
  var clip = createClipElement(exercise, x, 80);
  track.appendChild(clip);
  selectClipEl(clip);
  if (typeof addToRecent === 'function') addToRecent(exercise.id);
  updateStats();
  saveSession();
  sfx('drop');
  toast(exercise.name + ' added');
}

function selectClipEl(clip, addToSelection) {
  if (!addToSelection) {
    document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  }
  clip.classList.add('selected');
  selectedClip = clip;
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  var ex = getExercise(clip.dataset.exerciseId);
  if (!ex) return;
  var insp = document.getElementById('inspector');
  insp.style.display = '';
  // Auto-switch to inspector tab
  switchPanelTab('inspector-tab');
  document.getElementById('insp-name').textContent = ex.name;
  document.getElementById('insp-pattern').textContent = ex.pattern;
  document.getElementById('insp-stage').textContent = 'Stage ' + ex.stage + ' - ' + ex.discipline;
  document.getElementById('insp-discipline').textContent = ex.discipline;
  document.getElementById('insp-sets').value = clip.dataset.sets || 3;
  document.getElementById('insp-reps').value = clip.dataset.reps || 8;
  document.getElementById('insp-tempo').value = clip.dataset.tempo || 3;
  document.getElementById('insp-rest').value = clip.dataset.rest || 60;
  document.getElementById('insp-rpe').value = clip.dataset.rpe || 7;
  var fm = FAMILY_MAP[ex.family] || {};
  var tagHtml =
    '<span class="inspector-tag" style="background:'+((FAMILY_MAP[ex.family]||{}).color||'#666')+'22;color:'+(FAMILY_MAP[ex.family]||{}).color+'">'+ex.family+'</span>' +
    '<span class="inspector-tag">'+(fm.instrument||'')+'</span>' +
    '<span class="inspector-tag">S'+ex.stage+'</span>' +
    (ex.discipline ? '<span class="inspector-tag" style="background:rgba(59,130,246,0.1);color:rgba(147,197,253,0.8)">'+ex.discipline+'</span>' : '') +
    (ex.pattern ? '<span class="inspector-tag" style="background:rgba(168,85,247,0.1);color:rgba(196,181,253,0.7)">'+ex.pattern+'</span>' : '');
  if (clip.classList.contains('clip-locked')) {
    tagHtml += '<span class="inspector-tag" style="background:rgba(239,68,68,0.12);color:#ef4444">LOCKED</span>';
  }
  document.getElementById('insp-tags').innerHTML = tagHtml;
  document.getElementById('insp-notes').value = clip.dataset.notes || '';
  updateInspectorTime();
  updateProgressionChain(ex);
  syncInspectorLockBtn();
  updateRpeColor();
  // Auto-scroll timeline to show selected clip
  scrollToClip(clip);
}

function scrollToClip(clip) {
  var container = document.getElementById('timeline-container');
  if (!container) return;
  var clipLeft = parseInt(clip.style.left) || 0;
  var clipW = parseInt(clip.style.width) || 80;
  var scale = zoomLevel / 100;
  var clipMid = clipLeft * scale;
  var vpLeft = container.scrollLeft;
  var vpW = container.clientWidth;
  // Only scroll if clip is out of view
  if (clipMid < vpLeft + 120 || clipMid + clipW * scale > vpLeft + vpW - 20) {
    container.scrollLeft = Math.max(0, clipMid - vpW / 3);
  }
}

function updateProgressionChain(exercise) {
  var container = document.getElementById('insp-progression');
  if (!container) return;
  // Find same pattern, different stages
  var siblings = EXERCISES.filter(function(e) {
    return e.pattern === exercise.pattern && e.name !== exercise.name;
  });
  if (siblings.length === 0) { container.style.display = 'none'; return; }
  container.style.display = '';
  var all = [exercise].concat(siblings).sort(function(a, b) { return a.stage - b.stage; });
  var html = '<div style="font-size:7px;color:var(--micro);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px">Progression</div>';
  html += '<div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">';
  all.forEach(function(e, i) {
    var isCurrent = (e.id === exercise.id);
    var fm = FAMILY_MAP[e.family] || {color:'#666'};
    html += '<div style="font-size:8px;padding:2px 6px;border-radius:3px;cursor:'+(isCurrent?'default':'pointer')+';' +
      'background:'+(isCurrent ? fm.color+'33' : 'rgba(255,255,255,0.03)')+';' +
      'color:'+(isCurrent ? fm.color : 'var(--muted)')+';' +
      'border:1px solid '+(isCurrent ? fm.color+'44' : 'var(--border)')+';' +
      'font-weight:'+(isCurrent ? '600' : '400')+'"' +
      (isCurrent ? '' : ' onclick="swapClipExercise(\''+e.id+'\')"') +
      ' data-tip="'+e.name+' (S'+e.stage+')">' +
      'S' + e.stage + '</div>';
    if (i < all.length - 1) html += '<span style="font-size:7px;color:var(--micro)">&rarr;</span>';
  });
  html += '</div>';
  container.innerHTML = html;
}

function swapClipExercise(newExId) {
  if (!selectedClip) return;
  var ex = getExercise(newExId);
  if (!ex) return;
  pushUndo();
  selectedClip.dataset.exerciseId = ex.id;
  var label = selectedClip.querySelector('.clip-name');
  if (label) label.textContent = ex.name;
  var fm = FAMILY_MAP[ex.family] || {color:'#666'};
  selectedClip.style.borderTopColor = fm.color;
  // Update background unless custom color
  if (!selectedClip.dataset.customColor) {
    var rpeVal = parseInt(selectedClip.dataset.rpe || '7');
    var stageBase = ex.stage === 1 ? 170 : ex.stage === 2 ? 200 : 230;
    var rpeBoost = Math.round((rpeVal / 10) * 25);
    var alphaTop = Math.min(255, stageBase + rpeBoost).toString(16).padStart(2, '0');
    var alphaBot = Math.min(255, 130 + rpeBoost).toString(16).padStart(2, '0');
    selectedClip.style.background = 'linear-gradient(180deg, ' + fm.color + alphaTop + ' 0%, ' + fm.color + alphaBot + ' 100%)';
  }
  // Update stage dots
  var dotsEl = selectedClip.querySelector('.clip-stage-dots');
  if (dotsEl) {
    var dots = dotsEl.querySelectorAll('.clip-stage-dot');
    dots.forEach(function(d, i) { d.classList.toggle('filled', i < ex.stage); });
  }
  // Re-draw waveform
  var canvas = selectedClip.querySelector('.clip-waveform');
  if (canvas) {
    var waveOpacity = ex.stage === 1 ? 0.35 : ex.stage === 2 ? 0.5 : 0.65;
    drawClipWaveform(canvas, fm.color, selectedClip.style.width, waveOpacity, parseInt(selectedClip.dataset.rpe) || 7);
  }
  // Update velocity strip
  updateClipVisuals(selectedClip, parseInt(selectedClip.dataset.rpe) || 7);
  // Re-populate inspector
  selectClipEl(selectedClip);
  saveSession();
  sfx('click');
  toast('Swapped to ' + ex.name + ' (S' + ex.stage + ')');
}

function updateInspectorTime() {
  if (!selectedClip) return;
  var sets = parseInt(selectedClip.dataset.sets) || 3;
  var reps = parseInt(selectedClip.dataset.reps) || 8;
  var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
  var rest = parseInt(selectedClip.dataset.rest) || 60;
  var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
  var tut = sets * reps * tempo;
  var m = Math.floor(totalSec / 60);
  var s = Math.floor(totalSec % 60);
  var etEl = document.getElementById('insp-est-time');
  if (etEl) etEl.textContent = m + ':' + s.toString().padStart(2, '0');
  var tutEl = document.getElementById('insp-tut');
  if (tutEl) tutEl.textContent = tut + 's';
}

function updateClipDNA() {
  if (!selectedClip) return;
  selectedClip.dataset.sets = document.getElementById('insp-sets').value;
  selectedClip.dataset.reps = document.getElementById('insp-reps').value;
  selectedClip.dataset.tempo = document.getElementById('insp-tempo').value;
  selectedClip.dataset.rest = document.getElementById('insp-rest').value;
  selectedClip.dataset.rpe = document.getElementById('insp-rpe').value;
  var info = selectedClip.querySelector('.clip-info');
  if (info) {
    var infoSec = Math.round(parseInt(selectedClip.style.width) / 80 * 15);
    info.textContent = selectedClip.dataset.sets + 'x' + selectedClip.dataset.reps + ' ' + infoSec + 's';
  }
  // If tempo linked, update clip width based on exercise duration
  if (tempoLinked) {
    var sets = parseInt(selectedClip.dataset.sets) || 3;
    var reps = parseInt(selectedClip.dataset.reps) || 8;
    var tempo = parseFloat(selectedClip.dataset.tempo) || 3;
    var rest = parseInt(selectedClip.dataset.rest) || 60;
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var pps = 80 / 15;
    selectedClip.style.width = Math.max(40, totalSec * pps) + 'px';
    updateStats();
  }
  var rpeBadge = selectedClip.querySelector('.clip-rpe-badge');
  if (rpeBadge) rpeBadge.textContent = selectedClip.dataset.rpe;
  updateInspectorTime();
  saveSession();
}

function updateClipNotes() {
  if (!selectedClip) return;
  selectedClip.dataset.notes = document.getElementById('insp-notes').value;
  saveSession();
}

function updateRpeColor() {
  var rpe = parseInt(document.getElementById('insp-rpe').value) || 7;
  var valEl = document.getElementById('insp-rpe-val');
  if (valEl) {
    valEl.textContent = rpe;
    var colors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
    valEl.style.color = colors[rpe - 1] || '#eab308';
  }
}

function toggleInspectorLock() {
  if (!selectedClip) return;
  pushUndo();
  selectedClip.classList.toggle('clip-locked');
  selectedClip.dataset.locked = selectedClip.classList.contains('clip-locked') ? '1' : '';
  saveSession();
  syncInspectorLockBtn();
  toast(selectedClip.classList.contains('clip-locked') ? 'Clip locked' : 'Clip unlocked');
}

function syncInspectorLockBtn() {
  var btn = document.getElementById('insp-lock-btn');
  if (!btn || !selectedClip) return;
  var locked = selectedClip.classList.contains('clip-locked');
  btn.textContent = locked ? 'UNLOCK' : 'LOCK';
  btn.style.color = locked ? 'var(--accent-red)' : '';
}

function updateSummary() {
  var clips = document.querySelectorAll('.clip');
  var panel = document.getElementById('workout-summary');
  if (clips.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = '';
  var totalSets = 0, totalReps = 0, totalDur = 0, exerciseSet = {};
  var familyCounts = {};
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    totalSets += sets;
    totalReps += sets * reps;
    totalDur += (sets * reps * tempo) + ((sets - 1) * rest);
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exerciseSet[ex.id] = true;
      familyCounts[ex.family] = (familyCounts[ex.family] || 0) + 1;
    }
  });
  document.getElementById('sum-sets').textContent = totalSets;
  document.getElementById('sum-reps').textContent = totalReps;
  var durM = Math.floor(totalDur / 60);
  var durS = Math.floor(totalDur % 60);
  document.getElementById('sum-duration').textContent = durM + ':' + durS.toString().padStart(2, '0');
  document.getElementById('sum-exercises').textContent = Object.keys(exerciseSet).length;
  // Balance bars
  var maxCount = 1;
  var families = ['Push','Pull','Core','Legs','Skills','Flow'];
  families.forEach(function(f) { if ((familyCounts[f] || 0) > maxCount) maxCount = familyCounts[f]; });
  var barsHtml = '', labelsHtml = '';
  families.forEach(function(f) {
    var count = familyCounts[f] || 0;
    var fm = FAMILY_MAP[f] || {color:'#666'};
    var h = count > 0 ? Math.max(4, (count / maxCount) * 20) : 2;
    barsHtml += '<div style="flex:1;height:'+h+'px;background:'+fm.color+';border-radius:1px;opacity:'+(count > 0 ? 1 : 0.2)+'"></div>';
    labelsHtml += '<div style="flex:1;font-size:6px;color:var(--micro);text-align:center">'+f.charAt(0)+'</div>';
  });
  document.getElementById('balance-bars').innerHTML = barsHtml;
  document.getElementById('balance-labels').innerHTML = labelsHtml;
  // Footer family balance minibar
  var footerBar = document.getElementById('footer-balance');
  if (footerBar) {
    var total = clips.length || 1;
    var fbHtml = '';
    families.forEach(function(f) {
      var count = familyCounts[f] || 0;
      var pct = (count / total) * 100;
      if (pct > 0) {
        fbHtml += '<div style="flex:' + pct + ';background:' + (FAMILY_MAP[f] || {color:'#666'}).color + '"></div>';
      }
    });
    footerBar.innerHTML = fbHtml || '<div style="flex:1;background:var(--border)"></div>';
  }
}

function updateClipInfo(clip) {
  if (!clip) return;
  var infoEl = clip.querySelector('.clip-info');
  if (!infoEl) return;
  var sets = clip.dataset.sets || 3;
  var reps = clip.dataset.reps || 8;
  var clipSec = Math.round(parseInt(clip.style.width) / 80 * 15);
  infoEl.textContent = sets + 'x' + reps + ' ' + clipSec + 's';
}

function updateStats() {
  var clips = document.querySelectorAll('.clip');
  document.getElementById('clip-count').textContent = clips.length;
  var maxRight = 0;
  var trackCounts = {};
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
    var tid = c.parentElement.dataset.track;
    trackCounts[tid] = (trackCounts[tid] || 0) + 1;
  });
  var secs = Math.round(maxRight / 80 * 15);
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  document.getElementById('total-duration').textContent = m + ':' + s.toString().padStart(2, '0');
  // Estimated workout time (sets x reps x tempo + rest between sets)
  var estTotalSec = 0;
  clips.forEach(function(c) {
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    estTotalSec += sets * (reps * tempo + rest) - rest;
  });
  var estMin = Math.floor(estTotalSec / 60);
  var estSec = Math.round(estTotalSec % 60);
  document.getElementById('footer-est-time').textContent = estMin + ':' + estSec.toString().padStart(2, '0');
  // Workout intensity score (0-100)
  var intensityEl = document.getElementById('footer-intensity');
  if (clips.length > 0 && intensityEl) {
    var avgRpe = 0; var totalVolume = 0;
    clips.forEach(function(c) {
      avgRpe += parseInt(c.dataset.rpe) || 7;
      totalVolume += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8);
    });
    avgRpe = avgRpe / clips.length;
    var volScore = Math.min(40, totalVolume / 8);
    var rpeScore = (avgRpe / 10) * 40;
    var familyCount = 0;
    var fams = {};
    clips.forEach(function(c) { var ex = getExercise(c.dataset.exerciseId); if (ex) fams[ex.family] = true; });
    familyCount = Object.keys(fams).length;
    var diversityScore = Math.min(20, familyCount * 4);
    var score = Math.min(100, Math.round(volScore + rpeScore + diversityScore));
    intensityEl.textContent = score;
    intensityEl.style.color = score >= 80 ? '#ef4444' : score >= 60 ? '#f97316' : score >= 40 ? '#eab308' : '#22c55e';
  } else if (intensityEl) {
    intensityEl.textContent = '0';
    intensityEl.style.color = 'var(--muted)';
  }
  // Update total bars in footer
  var bpbF = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var totalBars = Math.ceil(secs / (60 / bpm * bpbF));
  var barsEl = document.getElementById('footer-bars');
  if (barsEl) barsEl.textContent = totalBars + ' bar' + (totalBars !== 1 ? 's' : '');
  // Workout difficulty badge
  var diffEl = document.getElementById('footer-difficulty');
  if (diffEl) {
    if (clips.length > 0) {
      var avgStage = 0;
      clips.forEach(function(c) { var ex = getExercise(c.dataset.exerciseId); avgStage += ex ? ex.stage : 1; });
      avgStage = avgStage / clips.length;
      var diffLabel = avgStage < 1.5 ? 'BEGINNER' : avgStage < 2.5 ? 'INTERMEDIATE' : 'ADVANCED';
      var diffColor = avgStage < 1.5 ? '#22c55e' : avgStage < 2.5 ? '#eab308' : '#ef4444';
      diffEl.textContent = diffLabel;
      diffEl.style.color = diffColor;
    } else {
      diffEl.textContent = '';
    }
  }
  // Locked clips count
  var lockedEl = document.getElementById('footer-locked');
  if (lockedEl) {
    var lockedCount = document.querySelectorAll('.clip.clip-locked').length;
    lockedEl.textContent = lockedCount > 0 ? lockedCount + ' locked' : '';
  }
  // Track mute/solo indicator
  var tsEl = document.getElementById('footer-track-state');
  if (tsEl) {
    var mutedTracks = document.querySelectorAll('.track.track-muted').length;
    var soloedTracks = document.querySelectorAll('.track.track-soloed').length;
    var parts = [];
    if (soloedTracks > 0) parts.push(soloedTracks + ' solo');
    if (mutedTracks > 0) parts.push(mutedTracks + ' muted');
    tsEl.textContent = parts.join(' ');
    tsEl.style.color = soloedTracks > 0 ? 'rgba(234,179,8,0.8)' : mutedTracks > 0 ? 'rgba(239,68,68,0.6)' : '';
  }
  // Update per-track clip counts
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    var el = document.getElementById('track-count-' + t.id);
    var count = trackCounts[t.id] || 0;
    if (el) {
      el.textContent = count + ' clip' + (count !== 1 ? 's' : '');
      el.style.color = count === 0 ? 'var(--micro)' : count >= 3 ? 'var(--text-secondary)' : 'var(--muted)';
    }
  });
  // Detect clip overlaps per track
  var prevOverlapCount = document.querySelectorAll('.clip.clip-overlap').length;
  document.querySelectorAll('.track-content').forEach(function(tc) {
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    trackClips.forEach(function(c) { c.classList.remove('clip-overlap'); c.classList.remove('clip-overlap-flash'); });
    for (var i = 0; i < trackClips.length; i++) {
      var aL = parseInt(trackClips[i].style.left) || 0;
      var aR = aL + (parseInt(trackClips[i].style.width) || 80);
      for (var j = i + 1; j < trackClips.length; j++) {
        var bL = parseInt(trackClips[j].style.left) || 0;
        var bR = bL + (parseInt(trackClips[j].style.width) || 80);
        if (aR > bL && bR > aL) {
          trackClips[i].classList.add('clip-overlap');
          trackClips[j].classList.add('clip-overlap');
        }
      }
    }
  });
  var newOverlapCount = document.querySelectorAll('.clip.clip-overlap').length;
  if (newOverlapCount > 0 && newOverlapCount > prevOverlapCount) {
    document.querySelectorAll('.clip.clip-overlap').forEach(function(c) { c.classList.add('clip-overlap-flash'); });
    toast('Overlapping clips detected (' + newOverlapCount + ')');
  }
  // Cross-track superset detection
  var allClipEls = Array.from(document.querySelectorAll('.clip'));
  allClipEls.forEach(function(c) { c.classList.remove('clip-superset'); });
  var supersetCount = 0;
  for (var si = 0; si < allClipEls.length; si++) {
    var aTrack = allClipEls[si].parentElement.dataset.track;
    var aL = parseInt(allClipEls[si].style.left) || 0;
    var aR = aL + (parseInt(allClipEls[si].style.width) || 80);
    for (var sj = si + 1; sj < allClipEls.length; sj++) {
      var bTrack = allClipEls[sj].parentElement.dataset.track;
      if (bTrack === aTrack) continue;
      var bL = parseInt(allClipEls[sj].style.left) || 0;
      var bR = bL + (parseInt(allClipEls[sj].style.width) || 80);
      if (aR > bL && bR > aL) {
        allClipEls[si].classList.add('clip-superset');
        allClipEls[sj].classList.add('clip-superset');
        supersetCount++;
      }
    }
  }
  var ssEl = document.getElementById('footer-supersets');
  if (ssEl) ssEl.textContent = supersetCount > 0 ? supersetCount + ' SS' : '';
  updateSummary();
  updateMinimap();
  updateEmptyState();
  if (typeof updateTrackVolumeBars === 'function') updateTrackVolumeBars();
}

/* ===== MINI-MAP ===== */
function updateMinimap() {
  var minimap = document.getElementById('timeline-minimap');
  var mapW = minimap.clientWidth;
  if (mapW === 0) return;
  // Calculate total timeline width from clips
  var maxRight = 600; // minimum extent
  var clips = document.querySelectorAll('.clip');
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var totalW = maxRight + 200; // padding
  var scale = mapW / totalW;
  // Draw mini clips
  var trackOffsets = {push:0,pull:1,core:2,legs:3,skills:4};
  var trackH = 3;
  var html = '';
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    var row = trackOffsets[tid];
    if (row === undefined) return;
    var x = parseInt(c.style.left) * scale;
    var w = Math.max(2, parseInt(c.style.width) * scale);
    var top = 1 + row * (trackH + 1);
    var ex = getExercise(c.dataset.exerciseId);
    var color = ex ? (FAMILY_MAP[ex.family] || {color:'#666'}).color : '#666';
    html += '<div class="minimap-clip" style="left:'+x+'px;width:'+w+'px;top:'+top+'px;background:'+color+'"></div>';
  });
  // Loop region overlay on minimap
  if (loopEnabled) {
    var ppsM = 80 / 15;
    var lLeft = (100 + loopStart * ppsM) * scale;
    var lWidth = (loopEnd - loopStart) * ppsM * scale;
    html += '<div style="position:absolute;top:0;bottom:0;left:'+lLeft+'px;width:'+lWidth+'px;background:rgba(59,130,246,0.12);border-left:1px solid rgba(59,130,246,0.4);border-right:1px solid rgba(59,130,246,0.4);pointer-events:none;z-index:1"></div>';
  }
  // Marker dots on minimap
  markers.forEach(function(m) {
    var mX = (100 + m.time * (80 / 15)) * scale;
    html += '<div style="position:absolute;top:0;width:1px;height:100%;background:rgba(249,115,22,0.5);left:'+mX+'px;pointer-events:none;z-index:2"></div>';
  });
  // Keep viewport indicator
  var container = document.getElementById('timeline-container');
  var vpLeft = container.scrollLeft * scale;
  var vpW = container.clientWidth * scale;
  html += '<div class="minimap-viewport" style="left:'+vpLeft+'px;width:'+vpW+'px"></div>';
  // Minimap playhead with glow during playback
  var pps = 80 / 15;
  var phX = (100 + currentTime * pps) * scale;
  html += '<div class="minimap-playhead'+(isPlaying?' playing':'')+'" style="left:'+phX+'px"></div>';
  // Remove old viewport element since we're regenerating
  var oldVp = document.getElementById('minimap-viewport');
  if (oldVp) oldVp.remove();
  minimap.innerHTML = html;
}

/* Click/drag on minimap to scroll */
document.addEventListener('DOMContentLoaded', function() {
  var minimap = document.getElementById('timeline-minimap');
  function minimapScrollTo(clientX) {
    var rect = minimap.getBoundingClientRect();
    var clickX = clientX - rect.left;
    var ratio = Math.max(0, Math.min(1, clickX / rect.width));
    var maxRight = 600;
    document.querySelectorAll('.clip').forEach(function(c) {
      var r = parseInt(c.style.left) + parseInt(c.style.width);
      if (r > maxRight) maxRight = r;
    });
    var totalW = maxRight + 200;
    var container = document.getElementById('timeline-container');
    container.scrollLeft = ratio * totalW - container.clientWidth / 2;
    // Also seek playhead to this position
    var pps = 80 / 15;
    currentTime = Math.max(0, (ratio * totalW) / pps);
    updateTimeDisplay();
    updatePlayheadPosition();
    updateMinimap();
  }
  minimap.addEventListener('mousedown', function(e) {
    e.preventDefault();
    minimap.style.cursor = 'grabbing';
    minimapScrollTo(e.clientX);
    function onMove(ev) { minimapScrollTo(ev.clientX); }
    function onUp() {
      minimap.style.cursor = '';
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Update minimap on scroll */
  document.getElementById('timeline-container').addEventListener('scroll', function() {
    updateMinimap();
  });
});

/* ===== TRANSPORT ===== */
var playStartTime = 0; /* Where playback began, for return-to-start */
function togglePlay() {
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) {
    playStartTime = currentTime;
    _userSelectedDuringPlayback = false;
    btn.classList.add('active');
    btn.innerHTML = '&#9616;&#9616;';
    playInterval = setInterval(updatePlayhead, 50);
    startMeters();
    document.getElementById('status-text').textContent = 'Playing';
    var psEl = document.getElementById('playback-state');
    psEl.textContent = 'PLAY';
    psEl.className = 'transport-state state-play';
    updatePlayheadClass();
    updateStatusDot();
    sfx('play');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '&#9654;';
    clearInterval(playInterval);
    stopMeters();
    document.getElementById('status-text').textContent = 'Paused';
    var psEl2 = document.getElementById('playback-state');
    psEl2.textContent = 'PAUSE';
    psEl2.className = 'transport-state state-stop';
    updatePlayheadClass();
    updateStatusDot();
    sfx('click');
  }
}

var _lastStopTime = 0;
function stopPlayback() {
  isPlaying = false;
  var now = Date.now();
  // Double-stop: if stopped within 400ms and already at start, go to 0
  if (currentTime === (playStartTime || 0) && now - _lastStopTime < 400) {
    currentTime = 0;
    playStartTime = 0;
  } else {
    currentTime = playStartTime || 0;
  }
  _lastStopTime = now;
  var btn = document.getElementById('play-btn');
  btn.classList.remove('active');
  btn.innerHTML = '&#9654;';
  clearInterval(playInterval);
  stopMeters();
  updateTimeDisplay();
  updatePlayheadPosition();
  updatePlayheadClass();
  // Clear all clip playing states and progress
  document.querySelectorAll('.clip').forEach(function(c) {
    c.classList.remove('clip-playing');
    var p = c.querySelector('.clip-progress');
    if (p) p.style.width = '0';
    var pf = c.querySelector('.clip-progress-fill');
    if (pf) pf.style.width = '0';
  });
  document.getElementById('status-text').textContent = 'Ready';
  var psStop = document.getElementById('playback-state');
  psStop.textContent = 'STOP';
  psStop.className = 'transport-state state-stop';
  updateStatusDot();
  // Reset beat dots
  for (var d = 1; d <= 4; d++) {
    var dot = document.getElementById('beat-' + d);
    if (dot) dot.style.background = 'rgba(255,255,255,0.1)';
  }
  sfx('stop');
}

function rewind() { currentTime = Math.max(0, currentTime - 15); updateTimeDisplay(); updatePlayheadPosition(); }
function forward() { currentTime += 15; updateTimeDisplay(); updatePlayheadPosition(); }

function updatePlayhead() {
  currentTime += 0.05 * playbackSpeed;
  // Loop boundary check
  if (loopEnabled && currentTime >= loopEnd) {
    currentTime = loopStart;
    beatCounter = Math.floor(currentTime / (60 / bpm));
  }
  updateTimeDisplay();
  updatePlayheadPosition();
  // Beat tracking — visual dots + metronome
  var beatInterval = 60 / bpm;
  var currentBeat = Math.floor(currentTime / beatInterval);
  if (currentBeat > beatCounter) {
    beatCounter = currentBeat;
    if (metronomeEnabled) sfx('metronome');
    // Animate beat dots (1-4, wraps with time sig)
    var bpbDots = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
    var dotIdx = (beatCounter % bpbDots) + 1;
    for (var d = 1; d <= 4; d++) {
      var dot = document.getElementById('beat-' + d);
      if (dot) {
        if (d <= bpbDots) {
          dot.style.background = (d === dotIdx) ? 'var(--accent-cyan)' : 'rgba(255,255,255,0.1)';
          dot.style.display = '';
        } else {
          dot.style.display = 'none';
        }
      }
    }
  }
}

function updateTimeDisplay() {
  var mins = Math.floor(currentTime / 60);
  var secs = Math.floor(currentTime % 60);
  var ms = Math.floor((currentTime % 1) * 100);
  document.getElementById('td-min').textContent = mins.toString().padStart(2, '0');
  document.getElementById('td-sec').textContent = secs.toString().padStart(2, '0');
  document.getElementById('td-ms').textContent = ms.toString().padStart(2, '0');
  // Update bars:beats:ticks in footer and transport
  var beatDuration = 60 / bpm;
  var totalBeats = currentTime / beatDuration;
  var bar = Math.floor(totalBeats / 4) + 1;
  var beat = Math.floor(totalBeats % 4) + 1;
  var tick = Math.floor((totalBeats % 1) * 4) + 1;
  var bbStr = bar + '.' + beat + '.' + tick;
  var posEl = document.getElementById('footer-pos');
  if (posEl) {
    if (typeof footerMode !== 'undefined' && footerMode === 'time') {
      var tm = Math.floor(currentTime / 60);
      var ts = Math.floor(currentTime % 60);
      var tms = Math.floor((currentTime % 1) * 100);
      posEl.textContent = tm + ':' + ts.toString().padStart(2,'0') + '.' + tms.toString().padStart(2,'0');
    } else {
      posEl.textContent = bbStr;
    }
  }
  var barsDisp = document.getElementById('bars-display');
  if (barsDisp) barsDisp.textContent = bbStr;
  // Update beat indicator dots (1-4)
  for (var bi = 1; bi <= 4; bi++) {
    var dot = document.getElementById('beat-' + bi);
    if (dot) {
      if (bi === beat && isPlaying) {
        dot.style.background = bi === 1 ? 'var(--accent-green)' : 'var(--accent-blue)';
        dot.style.boxShadow = '0 0 4px ' + (bi === 1 ? 'rgba(34,197,94,0.4)' : 'rgba(59,130,246,0.4)');
      } else {
        dot.style.background = 'rgba(255,255,255,0.1)';
        dot.style.boxShadow = 'none';
      }
    }
  }
  // Remaining time display (shows during playback)
  var remEl = document.getElementById('remaining-time');
  if (remEl) {
    if (isPlaying) {
      var maxR = 0;
      document.querySelectorAll('.clip').forEach(function(c) {
        var r = (parseInt(c.style.left) + parseInt(c.style.width) - 100) / (80 / 15);
        if (r > maxR) maxR = r;
      });
      var remaining = Math.max(0, maxR - currentTime);
      var rm = Math.floor(remaining / 60);
      var rs = Math.floor(remaining % 60);
      remEl.textContent = '-' + rm + ':' + rs.toString().padStart(2, '0');
      remEl.style.opacity = '0.6';
    } else {
      remEl.style.opacity = '0';
    }
  }
}

function updatePlayheadPosition() {
  var pps = 80 / 15;
  var pos = 100 + currentTime * pps;
  document.getElementById('playhead').style.left = pos + 'px';
  // Auto-scroll timeline during playback (respects settings)
  if (isPlaying) {
    if (typeof autoScrollEnabled === 'undefined' || autoScrollEnabled) {
      var container = document.getElementById('timeline-container');
      var visibleRight = container.scrollLeft + container.clientWidth;
      if (pos > visibleRight - 60) {
        container.scrollLeft = pos - 200;
      }
    }
    // Update clip progress overlays and playing state (mute/solo aware)
    var hasSoloTrack = !!document.querySelector('.track-btn.soloed');
    document.querySelectorAll('.clip').forEach(function(clip) {
      var track = clip.closest('.track');
      var isMuted = track && track.classList.contains('track-muted');
      var isSoloed = track && track.classList.contains('track-soloed');
      var isActive = hasSoloTrack ? isSoloed : !isMuted;
      var clipLeft = parseInt(clip.style.left) + 100;
      var clipW = parseInt(clip.style.width);
      var clipRight = clipLeft + clipW;
      var progressEl = clip.querySelector('.clip-progress');
      var fillEl = clip.querySelector('.clip-progress-fill');
      if (isActive && pos >= clipLeft && pos <= clipRight) {
        var pct = ((pos - clipLeft) / clipW) * 100;
        if (progressEl) progressEl.style.width = pct + '%';
        if (fillEl) fillEl.style.width = pct + '%';
        if (!clip.classList.contains('clip-playing')) {
          clip.classList.add('clip-playing');
          if (!_userSelectedDuringPlayback) selectClipEl(clip, false);
        }
      } else {
        var done = isActive && pos > clipRight;
        if (progressEl) progressEl.style.width = done ? '100%' : '0';
        if (fillEl) fillEl.style.width = done ? '100%' : '0';
        clip.classList.remove('clip-playing');
      }
    });
  }
  // Update header progress bar
  var hpBar = document.getElementById('header-progress');
  if (hpBar) {
    if (isPlaying) {
      var maxRight = 600;
      document.querySelectorAll('.clip').forEach(function(c) {
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      var pct = Math.min(100, ((pos - 100) / maxRight) * 100);
      hpBar.style.width = pct + '%';
      hpBar.classList.add('active');
    } else {
      hpBar.classList.remove('active');
    }
  }
}

function toggleRec() {
  isRecording = !isRecording;
  var btn = document.getElementById('rec-btn');
  btn.classList.toggle('active', isRecording);
  document.getElementById('status-text').textContent = isRecording ? 'Recording' : 'Ready';
  var psRec = document.getElementById('playback-state');
  if (isRecording) {
    psRec.textContent = 'REC';
    psRec.className = 'transport-state state-rec';
  } else {
    psRec.textContent = isPlaying ? 'PLAY' : 'STOP';
    psRec.className = 'transport-state ' + (isPlaying ? 'state-play' : 'state-stop');
  }
  updateStatusDot();
  sfx(isRecording ? 'rec' : 'click');
}

/* ===== BPM ===== */
function updateBPM() {
  bpm = parseInt(document.getElementById('bpm-input').value) || 120;
  updateBPMMode();
  buildRuler();
  saveSession();
  // Flash BPM input on change
  var bpmEl = document.getElementById('bpm-input');
  bpmEl.classList.remove('flash');
  void bpmEl.offsetWidth; // force reflow
  bpmEl.classList.add('flash');
  // Update BPM pulse animation speed
  var pulseDuration = (60 / bpm).toFixed(3);
  var pulse = document.getElementById('bpm-pulse');
  if (pulse) pulse.style.setProperty('--bpm-duration', pulseDuration + 's');
  // If tempo-linked, adjust exercise tempos AND music playback rate
  if (tempoLinked) {
    var repTempo = 60 / bpm;
    document.getElementById('insp-tempo').value = repTempo.toFixed(1);
    if (selectedClip) {
      selectedClip.dataset.tempo = repTempo.toFixed(1);
      updateClipDNA();
    }
    // Adjust music playback rate: 120 BPM = 1.0x, scale proportionally
    if (audioEl) {
      var rate = Math.max(0.5, Math.min(2.0, bpm / 120));
      audioEl.playbackRate = rate;
    }
    toast('Tempo linked: ' + repTempo.toFixed(1) + 's/rep, music ' + (bpm / 120).toFixed(2) + 'x');
  } else {
    // Reset music to normal speed when unlinked
    if (audioEl) audioEl.playbackRate = 1.0;
  }
}

function updateBPMMode() {
  var mode = 'Standard';
  for (var i = 0; i < BPM_MODES.length; i++) {
    if (bpm >= BPM_MODES[i].min && bpm < BPM_MODES[i].max) {
      mode = BPM_MODES[i].name;
      break;
    }
  }
  if (bpm >= 200) mode = 'Explosive';
  var el = document.getElementById('bpm-mode');
  el.textContent = mode;
  // Dynamic color by mode
  var modeColors = {'Slow Strength':['59,130,246','#3b82f6'],'Standard':['139,92,246','#8b5cf6'],'Flow State':['249,115,22','#f97316'],'Explosive':['239,68,68','#ef4444']};
  var mc = modeColors[mode] || ['139,92,246','#8b5cf6'];
  el.style.background = 'rgba(' + mc[0] + ',0.08)';
  el.style.borderColor = 'rgba(' + mc[0] + ',0.15)';
  el.style.color = mc[1];
  // Subtle ambient tint on timeline based on mode
  var timeline = document.getElementById('timeline-tracks');
  if (timeline) timeline.style.boxShadow = 'inset 0 0 80px rgba(' + mc[0] + ',0.015)';
}

function toggleTempoLink() {
  tempoLinked = !tempoLinked;
  var el = document.getElementById('tempo-link');
  el.classList.toggle('active', tempoLinked);
  if (tempoLinked) {
    sfx('click');
    toast('BPM linked to exercise tempo');
    updateBPM();
  } else {
    if (audioEl) audioEl.playbackRate = 1.0;
    sfx('click');
    toast('Tempo unlinked');
  }
}

/* Tap Tempo — tap rhythm to set BPM */
var tapTimes = [];
function tapTempo() {
  var now = Date.now();
  tapTimes.push(now);
  // Keep only last 8 taps (last 3 seconds)
  tapTimes = tapTimes.filter(function(t) { return now - t < 3000; });
  if (tapTimes.length >= 2) {
    var intervals = [];
    for (var i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    var avg = intervals.reduce(function(a, b) { return a + b; }, 0) / intervals.length;
    var tapBpm = Math.round(60000 / avg);
    tapBpm = Math.max(40, Math.min(200, tapBpm));
    bpm = tapBpm;
    document.getElementById('bpm-input').value = bpm;
    updateBPM();
    toast('Tap: ' + bpm + ' BPM (' + tapTimes.length + ' taps)');
  } else {
    toast('Tap... (keep tapping)');
  }
  sfx('metronome');
  // Visual feedback on tap button
  var btn = document.getElementById('tap-tempo');
  if (btn) {
    btn.classList.add('active');
    setTimeout(function() { btn.classList.remove('active'); }, 100);
  }
}

var timeSigOptions = ['4/4', '3/4', '6/8', '5/4', '7/8'];
var timeSigIdx = 0;
function getBeatsPerBar() {
  var ts = timeSigOptions[timeSigIdx];
  return parseInt(ts.split('/')[0]) || 4;
}
function cycleTimeSig() {
  timeSigIdx = (timeSigIdx + 1) % timeSigOptions.length;
  document.getElementById('time-sig').textContent = timeSigOptions[timeSigIdx];
  sfx('click');
  buildRuler();
  toast('Time signature: ' + timeSigOptions[timeSigIdx]);
}

function toggleMetronome() {
  metronomeEnabled = !metronomeEnabled;
  beatCounter = Math.floor(currentTime / (60 / bpm));
  var btn = document.getElementById('metro-btn');
  if (btn) {
    btn.classList.toggle('active', metronomeEnabled);
    btn.classList.toggle('metro-active', metronomeEnabled);
  }
  sfx(metronomeEnabled ? 'metronome' : 'click');
  toast(metronomeEnabled ? 'Metronome ON' : 'Metronome OFF');
}

function toggleLoop() {
  loopEnabled = !loopEnabled;
  var btn = document.getElementById('loop-btn');
  if (btn) btn.classList.toggle('active', loopEnabled);
  var region = document.getElementById('loop-region');
  region.classList.toggle('active', loopEnabled);
  if (loopEnabled) {
    updateLoopRegion();
    sfx('click');
    toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
  } else {
    sfx('click');
    toast('Loop OFF');
  }
}

function updateLoopRegion() {
  var pps = 80 / 15;
  var scale = zoomLevel / 100;
  var region = document.getElementById('loop-region');
  region.style.left = (100 * scale + loopStart * pps * scale) + 'px';
  region.style.width = ((loopEnd - loopStart) * pps * scale) + 'px';
}

/* ===== LOOP REGION INTERACTION ===== */
function initLoopDrag() {
  var region = document.getElementById('loop-region');
  var pps = function() { return (80 / 15) * (zoomLevel / 100); };
  var headerOffset = function() { return 100 * (zoomLevel / 100); };
  /* Handle drag (resize loop start/end) */
  region.querySelectorAll('.loop-handle').forEach(function(handle) {
    handle.addEventListener('mousedown', function(e) {
      e.stopPropagation();
      e.preventDefault();
      var side = handle.dataset.side;
      var container = document.getElementById('timeline-container');
      function onMove(e) {
        var rect = document.getElementById('timeline-tracks').getBoundingClientRect();
        var x = e.clientX - rect.left + container.scrollLeft;
        var timeSec = Math.max(0, (x - headerOffset()) / pps());
        if (snapEnabled) {
          var snapSz = getSnapSize();
          var snapPx = Math.round((timeSec * pps()) / snapSz) * snapSz;
          timeSec = snapPx / pps();
        }
        if (side === 'left') {
          loopStart = Math.max(0, Math.min(timeSec, loopEnd - 1));
        } else {
          loopEnd = Math.max(loopStart + 1, timeSec);
        }
        updateLoopRegion();
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
        saveSession();
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
  /* Body drag (move entire loop region) */
  region.querySelector('.loop-body').addEventListener('mousedown', function(e) {
    e.stopPropagation();
    e.preventDefault();
    var container = document.getElementById('timeline-container');
    var startX = e.clientX;
    var origStart = loopStart;
    var origEnd = loopEnd;
    var duration = loopEnd - loopStart;
    function onMove(e) {
      var deltaPx = e.clientX - startX;
      var deltaSec = deltaPx / pps();
      var newStart = Math.max(0, origStart + deltaSec);
      loopStart = newStart;
      loopEnd = newStart + duration;
      updateLoopRegion();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      toast('Loop: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
      saveSession();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

/* Option+drag on ruler to create loop region */
function initRulerLoopDrag() {
  var ruler = document.getElementById('timeline-ruler');
  ruler.addEventListener('mousedown', function(e) {
    if (!e.altKey) return;
    e.preventDefault();
    e.stopPropagation();
    var container = document.getElementById('timeline-container');
    var pps = (80 / 15) * (zoomLevel / 100);
    var ho = 100 * (zoomLevel / 100);
    var rect = ruler.getBoundingClientRect();
    var startX = e.clientX - rect.left + container.scrollLeft;
    var startSec = Math.max(0, (startX - ho) / pps);
    loopStart = startSec;
    loopEnd = startSec;
    loopEnabled = true;
    var btn = document.getElementById('loop-btn');
    if (btn) btn.classList.add('active');
    var region = document.getElementById('loop-region');
    region.classList.add('active');
    updateLoopRegion();
    function onMove(e) {
      var curX = e.clientX - rect.left + container.scrollLeft;
      var curSec = Math.max(0, (curX - ho) / pps);
      if (curSec >= startSec) {
        loopStart = startSec;
        loopEnd = Math.max(startSec + 1, curSec);
      } else {
        loopStart = curSec;
        loopEnd = startSec;
      }
      updateLoopRegion();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      if (loopEnd - loopStart < 1) {
        loopEnd = loopStart + 15;
      }
      updateLoopRegion();
      sfx('click');
      toast('Loop set: ' + formatTime(loopStart) + ' - ' + formatTime(loopEnd));
      saveSession();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

function formatTime(sec) {
  var m = Math.floor(sec / 60);
  var s = Math.floor(sec % 60);
  return m + ':' + s.toString().padStart(2, '0');
}

/* ===== FADERS ===== */
function buildFaders() {
  var container = document.getElementById('fader-group');
  var html = '';
  FADERS.forEach(function(f) {
    html += '<div class="fader" data-fader="'+f.id+'">';
    html += '<div class="fader-label">'+f.label+'</div>';
    html += '<div class="fader-track" onmousedown="startFaderDrag(event,\''+f.id+'\')" ontouchstart="startFaderDrag(event,\''+f.id+'\')" ondblclick="resetFader(\''+f.id+'\')">';
    html += '<div class="fader-fill" style="height:'+f.value+'%;background:'+f.color+'"></div>';
    html += '<div class="fader-handle" style="bottom:'+(f.value-3)+'%"></div>';
    html += '</div>';
    html += '<div class="fader-value" id="fader-val-'+f.id+'">'+(f.value/10).toFixed(0)+'</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function resetFader(faderId) {
  var fader = document.querySelector('[data-fader="'+faderId+'"]');
  if (!fader) return;
  fader.querySelector('.fader-fill').style.height = '50%';
  fader.querySelector('.fader-handle').style.bottom = '47%';
  fader.querySelector('.fader-value').textContent = '5';
  saveSession();
  toast('Fader reset: 50%');
}

function startFaderDrag(e, faderId) {
  e.preventDefault();
  var track = e.currentTarget;
  var rect = track.getBoundingClientRect();
  function updatePos(clientY) {
    var y = 1 - ((clientY - rect.top) / rect.height);
    y = Math.max(0, Math.min(1, y));
    var pct = y * 100;
    track.querySelector('.fader-fill').style.height = pct + '%';
    track.querySelector('.fader-handle').style.bottom = (pct - 3) + '%';
    document.getElementById('fader-val-' + faderId).textContent = (pct / 10).toFixed(0);
  }
  var handle = track.querySelector('.fader-handle');
  handle.classList.add('dragging');
  function onMouseMove(e) { updatePos(e.clientY); }
  function onMouseUp() { handle.classList.remove('dragging'); document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updatePos(e.touches[0].clientY); }
  function onTouchEnd() { handle.classList.remove('dragging'); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    updatePos(e.touches[0].clientY);
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    updatePos(e.clientY);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== KNOBS ===== */
function buildKnobs() {
  var container = document.getElementById('knob-group');
  var html = '';
  KNOBS.forEach(function(k) {
    var deg = (k.value - 0.5) * 270;
    html += '<div class="knob" data-knob="'+k.id+'">';
    html += '<div class="knob-dial" onmousedown="startKnobDrag(event,\''+k.id+'\')" ontouchstart="startKnobDrag(event,\''+k.id+'\')" ondblclick="resetKnob(\''+k.id+'\')">';
    html += '<div class="knob-indicator" style="transform:translateX(-50%) rotate('+deg+'deg)"></div>';
    html += '</div>';
    html += '<div class="knob-label">'+k.label+'</div>';
    html += '<div class="knob-value" id="knob-val-'+k.id+'">'+(k.value*100).toFixed(0)+'%</div>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function resetKnob(knobId) {
  var knob = document.querySelector('[data-knob="'+knobId+'"]');
  if (!knob) return;
  var indicator = knob.querySelector('.knob-indicator');
  if (indicator) indicator.style.transform = 'translateX(-50%) rotate(0deg)';
  var valEl = document.getElementById('knob-val-' + knobId);
  if (valEl) valEl.textContent = '50%';
  saveSession();
  toast('Knob reset: 50%');
}

function startKnobDrag(e, knobId) {
  e.preventDefault();
  var startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  var dial = e.currentTarget;
  var indicator = dial.querySelector('.knob-indicator');
  var startDeg = parseFloat(indicator.style.transform.match(/rotate\(([^)]+)deg\)/)[1]);
  dial.classList.add('dragging');
  function updateKnob(clientY) {
    var delta = (startY - clientY) * 1.5;
    var deg = Math.max(-135, Math.min(135, startDeg + delta));
    indicator.style.transform = 'translateX(-50%) rotate(' + deg + 'deg)';
    var val = ((deg + 135) / 270);
    document.getElementById('knob-val-' + knobId).textContent = (val * 100).toFixed(0) + '%';
  }
  function onMouseMove(e) { updateKnob(e.clientY); }
  function onMouseUp() { dial.classList.remove('dragging'); document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); saveSession(); }
  function onTouchMove(e) { e.preventDefault(); updateKnob(e.touches[0].clientY); }
  function onTouchEnd() { dial.classList.remove('dragging'); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); saveSession(); }
  if (e.type === 'touchstart') {
    document.addEventListener('touchmove', onTouchMove, {passive: false});
    document.addEventListener('touchend', onTouchEnd);
  } else {
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  }
}

/* ===== METERS ===== */
function buildMeters() {
  var container = document.getElementById('meters');
  var html = '';
  for (var i = 0; i < 12; i++) {
    html += '<div class="meter-bar" style="height:' + (10 + Math.random() * 30) + 'px"><div class="peak-hold"></div></div>';
  }
  container.innerHTML = html;
  // Build per-channel meters
  var chContainer = document.getElementById('channel-meters');
  var chHtml = '';
  var trackColors = {push:'var(--accent-blue)',pull:'var(--accent-purple)',core:'var(--accent-orange)',legs:'var(--accent-green)',skills:'var(--accent-cyan)'};
  var trackNames = {push:'P',pull:'PL',core:'C',legs:'L',skills:'SK'};
  Object.keys(trackColors).forEach(function(tid) {
    chHtml += '<div class="channel-meter"><div class="channel-meter-bar"><div class="channel-meter-fill" id="ch-meter-'+tid+'" style="width:0%;background:'+trackColors[tid]+'"></div></div><div class="channel-meter-label">'+trackNames[tid]+'</div></div>';
  });
  chContainer.innerHTML = chHtml;
}

function startMeters() {
  if (meterInterval) return;
  meterInterval = setInterval(function() {
    document.querySelectorAll('.meter-bar').forEach(function(bar) {
      var newH = 10 + Math.random() * 50;
      bar.style.height = newH + 'px';
      bar.style.background = newH > 45 ? 'var(--accent-red)' : newH > 30 ? 'var(--accent-orange)' : 'var(--accent-green)';
    });
    // Animate channel meters + track header VU dots
    ['push','pull','core','legs','skills'].forEach(function(tid) {
      var el = document.getElementById('ch-meter-' + tid);
      var trackClips = document.querySelectorAll('.track-content[data-track="'+tid+'"] .clip');
      var level = trackClips.length > 0 ? (30 + Math.random() * 70) : 0;
      if (el) el.style.width = level + '%';
      // Update track header VU dots
      var vu = document.getElementById('vu-' + tid);
      if (vu) {
        var dots = vu.children;
        var litCount = Math.floor(level / 20);
        for (var d = 0; d < dots.length; d++) {
          dots[d].className = 'track-vu-dot';
          if (d < litCount) {
            dots[d].classList.add(d < 3 ? 'on-low' : d < 4 ? 'on-mid' : 'on-high');
          }
        }
      }
    });
  }, 100);
}

function stopMeters() {
  clearInterval(meterInterval);
  meterInterval = null;
  document.querySelectorAll('.meter-bar').forEach(function(bar) {
    bar.style.height = '5px';
    bar.style.background = 'var(--accent-green)';
  });
  // Clear track header VU dots
  document.querySelectorAll('.track-vu-dot').forEach(function(d) {
    d.className = 'track-vu-dot';
  });
}

/* ===== TRACK CONTROLS ===== */
function toggleMute(btn) {
  btn.classList.toggle('muted');
  var track = btn.closest('.track');
  track.classList.toggle('track-muted', btn.classList.contains('muted'));
  sfx('click');
}
function toggleSolo(btn) {
  btn.classList.toggle('soloed');
  sfx('click');
  // Solo logic: if any track is soloed, mute all others visually
  var anysoloed = document.querySelector('.track-btn.soloed');
  document.querySelectorAll('.track').forEach(function(t) {
    if (t.dataset.track === 'music') return;
    var hasSolo = t.querySelector('.track-btn.soloed');
    var hasMute = t.querySelector('.track-btn.muted');
    if (anysoloed && !hasSolo && !hasMute) {
      t.classList.add('track-muted');
    } else if (!anysoloed && !hasMute) {
      t.classList.remove('track-muted');
    }
    t.classList.toggle('track-soloed', !!hasSolo);
  });
  // Toggle has-solo class on timeline-tracks for CSS dimming
  var tl = document.getElementById('timeline-tracks');
  if (tl) tl.classList.toggle('has-solo', !!anysoloed);
}
function toggleArm(btn) {
  btn.classList.toggle('armed');
  sfx('click');
}

/* ===== VIDEO ===== */
function toggleVideo() {
  var sec = document.getElementById('video-section');
  sec.classList.toggle('collapsed');
  document.getElementById('btn-video').classList.toggle('active', !sec.classList.contains('collapsed'));
}

/* Video drop zone */
document.addEventListener('DOMContentLoaded', function() {
  var vp = document.getElementById('video-placeholder');
  if (!vp) return;
  vp.addEventListener('click', function() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.onchange = function() { loadVideoFile(input.files[0]); };
    input.click();
  });
  vp.addEventListener('dragover', function(e) { e.preventDefault(); vp.style.background = 'rgba(6,182,212,0.1)'; });
  vp.addEventListener('dragleave', function() { vp.style.background = ''; });
  vp.addEventListener('drop', function(e) {
    e.preventDefault();
    vp.style.background = '';
    if (e.dataTransfer.files.length) loadVideoFile(e.dataTransfer.files[0]);
  });
});

function loadVideoFile(file) {
  if (!file || !file.type.startsWith('video/')) return;
  var video = document.getElementById('studio-video');
  var placeholder = document.getElementById('video-placeholder');
  video.src = URL.createObjectURL(file);
  video.style.display = '';
  placeholder.style.display = 'none';
  toast('Video loaded: ' + file.name);
}

/* ===== MUSIC ===== */
function toggleMusic() {
  var panel = document.getElementById('music-panel');
  var visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : '';
  document.querySelector('[onclick="toggleMusic()"]').classList.toggle('active', !visible);
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.volume = 0.5;
    audioEl.addEventListener('ended', function() { musicNext(); });
  }
}

function musicToggle() {
  if (!audioEl) toggleMusic();
  if (musicPlaying) {
    audioEl.pause();
    musicPlaying = false;
    document.getElementById('music-play-btn').innerHTML = '&#9654;';
    document.getElementById('music-eq').style.display = 'none';
  } else {
    if (!audioEl.src || audioEl.ended) {
      audioEl.src = MUSIC_TRACKS[musicIndex].url;
    }
    audioEl.play().catch(function() {});
    musicPlaying = true;
    document.getElementById('music-play-btn').innerHTML = '&#9616;&#9616;';
    document.getElementById('music-play-btn').classList.add('playing');
    document.getElementById('music-eq').style.display = '';
    document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  }
}

function musicNext() {
  musicIndex = (musicIndex + 1) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  var sel = document.getElementById('music-track-select');
  if (sel) sel.selectedIndex = musicIndex;
}

function musicPrev() {
  musicIndex = (musicIndex - 1 + MUSIC_TRACKS.length) % MUSIC_TRACKS.length;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  var sel = document.getElementById('music-track-select');
  if (sel) sel.selectedIndex = musicIndex;
}

function musicVolume(val) {
  if (audioEl) audioEl.volume = val / 100;
}

function musicSelectTrack(index) {
  musicIndex = index;
  if (audioEl) {
    audioEl.src = MUSIC_TRACKS[musicIndex].url;
    if (musicPlaying) audioEl.play().catch(function() {});
  }
  document.getElementById('music-track-name').textContent = MUSIC_TRACKS[musicIndex].name;
  drawMusicWaveform(MUSIC_TRACKS[musicIndex].name);
}

// Update music time display
setInterval(function() {
  if (!audioEl || !musicPlaying) return;
  var t = audioEl.currentTime || 0;
  var m = Math.floor(t / 60);
  var s = Math.floor(t % 60);
  var el = document.getElementById('music-time');
  if (el) el.textContent = m + ':' + s.toString().padStart(2, '0');
}, 500);

/* Draw static waveform in music track when a song is selected */
function drawMusicWaveform(trackName) {
  var canvas = document.getElementById('music-waveform-canvas');
  if (!canvas || !canvas.getContext) return;
  var parent = canvas.parentElement;
  canvas.width = parent.clientWidth - 100;
  canvas.height = 44;
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#06b6d4';
  var mid = canvas.height / 2;
  var seed = 0;
  for (var i = 0; i < trackName.length; i++) seed += trackName.charCodeAt(i);
  for (var x = 0; x < canvas.width; x += 2) {
    var v = Math.sin(x * 0.02 + seed * 0.1) * 0.5 +
            Math.sin(x * 0.07 + seed * 0.05) * 0.3 +
            Math.sin(x * 0.15 + seed * 0.02) * 0.15 +
            Math.random() * 0.05;
    var amp = (mid - 4) * Math.abs(v);
    ctx.fillRect(x, mid - amp, 1, amp * 2);
  }
}

/* ===== PRESETS ===== */
function togglePresets() {
  var drawer = document.getElementById('presets-drawer');
  drawer.classList.toggle('open');
  document.getElementById('btn-presets').classList.toggle('active', drawer.classList.contains('open'));
}

function loadPreset(id) {
  var p = PRESETS[id];
  if (!p) return;
  pushUndo();
  // Clear timeline
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Set BPM
  bpm = p.bpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Add clips
  p.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    if (!track) return;
    var ex = null;
    for (var i = 0; i < EXERCISES.length; i++) {
      if (EXERCISES[i].name === c.name) { ex = EXERCISES[i]; break; }
    }
    if (!ex) return;
    var clip = createClipElement(ex, c.x, c.w || 80);
    track.appendChild(clip);
  });
  // Set faders
  if (p.faders) {
    Object.keys(p.faders).forEach(function(key) {
      var fader = document.querySelector('[data-fader="'+key+'"]');
      if (!fader) return;
      var v = p.faders[key];
      fader.querySelector('.fader-fill').style.height = v + '%';
      fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
      fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
    });
  }
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  setWorkoutName(p.name);
  toast('Preset loaded: ' + p.name);
}

/* ===== RANDOM WORKOUT ===== */
function generateRandom() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  // Random BPM between 70-130
  bpm = 70 + Math.floor(Math.random() * 60);
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  // Pick random exercises per family track
  var families = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackIds = Object.keys(families);
  trackIds.forEach(function(tid) {
    var fam = families[tid];
    var familyExs = EXERCISES.filter(function(ex) { return ex.family === fam || (fam === 'Skills' && ex.family === 'Skills') || (fam === 'Legs' && ex.family === 'Flow'); });
    if (familyExs.length === 0) return;
    // 1-3 clips per track
    var numClips = 1 + Math.floor(Math.random() * 3);
    var track = document.querySelector('.track-content[data-track="'+tid+'"]');
    if (!track) return;
    var xPos = 0;
    for (var i = 0; i < numClips; i++) {
      var ex = familyExs[Math.floor(Math.random() * familyExs.length)];
      var w = 60 + Math.floor(Math.random() * 80);
      var clip = createClipElement(ex, xPos, w);
      track.appendChild(clip);
      xPos += w + Math.floor(Math.random() * 40);
    }
  });
  updateStats();
  saveSession();
  togglePresets();
  sfx('preset');
  setWorkoutName('Random ' + bpm + ' BPM');
  toast('Random workout generated at ' + bpm + ' BPM');
}

/* Fade overlay — draws gradient overlay showing fade in/out on clip */
function updateFadeOverlay(clip) {
  var existing = clip.querySelector('.clip-fade-overlay');
  if (existing) existing.remove();
  var fi = parseInt(clip.dataset.fadeIn) || 0;
  var fo = parseInt(clip.dataset.fadeOut) || 0;
  if (fi === 0 && fo === 0) return;
  var ov = document.createElement('div');
  ov.className = 'clip-fade-overlay';
  ov.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:1';
  var clipW = parseInt(clip.style.width) || 80;
  var fiPct = Math.min(50, (fi / clipW) * 100);
  var foPct = Math.min(50, (fo / clipW) * 100);
  var grad = 'linear-gradient(90deg, rgba(5,7,17,0.6) 0%, transparent ' + fiPct + '%, transparent ' + (100 - foPct) + '%, rgba(5,7,17,0.6) 100%)';
  ov.style.background = grad;
  clip.appendChild(ov);
}

/* ===== CLEAR ===== */
function clearTimeline() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats();
  saveSession();
  sfx('delete');
  toast('Timeline cleared');
}

/* ===== SAVE / LOAD ===== */
/* Debounced auto-save — coalesces rapid saveSession() calls into one write */
var _saveTimer = null;
var _saveImmediate = false;
function saveSession(immediate) {
  if (immediate) {
    _saveImmediate = true;
  }
  if (_saveTimer) clearTimeout(_saveTimer);
  if (_saveImmediate) {
    _saveImmediate = false;
    _doSaveSession();
  } else {
    _saveTimer = setTimeout(_doSaveSession, 300);
  }
}
function _doSaveSession() {
  _saveTimer = null;
  try {
    var session = {bpm: bpm, clips: [], faders: {}, knobs: {}};
    document.querySelectorAll('.clip').forEach(function(clip) {
      session.clips.push({
        exerciseId: clip.dataset.exerciseId,
        track: clip.parentElement.dataset.track,
        left: clip.style.left,
        width: clip.style.width,
        sets: clip.dataset.sets,
        reps: clip.dataset.reps,
        tempo: clip.dataset.tempo,
        rest: clip.dataset.rest,
        rpe: clip.dataset.rpe,
        notes: clip.dataset.notes || '',
        customColor: clip.dataset.customColor || '',
        fadeIn: clip.dataset.fadeIn || '0',
        fadeOut: clip.dataset.fadeOut || '0',
        group: clip.dataset.group || '',
        locked: clip.dataset.locked || ''
      });
    });
    document.querySelectorAll('[data-fader]').forEach(function(f) {
      var fill = f.querySelector('.fader-fill');
      session.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
    });
    // Knobs
    document.querySelectorAll('[data-knob]').forEach(function(k) {
      var indicator = k.querySelector('.knob-indicator');
      if (indicator) {
        var m = indicator.style.transform.match(/rotate\(([^)]+)deg\)/);
        var deg = m ? parseFloat(m[1]) : 0;
        session.knobs[k.dataset.knob] = deg;
      }
    });
    // Markers
    session.markers = markers.map(function(m) { return {id: m.id, time: m.time, label: m.label}; });
    session.markerCounter = markerCounter;
    // Workout name + creation date
    session.workoutName = workoutName || '';
    session.workoutNotes = workoutNotes || '';
    session.createdAt = _sessionCreatedAt || new Date().toISOString();
    // Recently used exercises
    if (typeof recentExercises !== 'undefined') session.recentExercises = recentExercises.slice(0);
    // Loop region
    session.loopEnabled = loopEnabled;
    session.loopStart = loopStart;
    session.loopEnd = loopEnd;
    session.groupCounter = _groupCounter;
    // Playhead time
    session.currentTime = currentTime;
    // Session timer cumulative seconds
    session.sessionElapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
    // Settings persistence
    session.settings = {
      snapEnabled: snapEnabled,
      gridRes: gridRes,
      sfxEnabled: sfxEnabled,
      metroVolume: metroVolume,
      autoScrollEnabled: autoScrollEnabled,
      playbackSpeed: playbackSpeed,
      zoomLevel: zoomLevel,
      timeSigIdx: timeSigIdx
    };
    // Track states (solo/mute/armed)
    session.trackStates = {};
    document.querySelectorAll('.track').forEach(function(t) {
      var tid = t.dataset.track;
      if (!tid) return;
      session.trackStates[tid] = {
        muted: t.classList.contains('track-muted'),
        soloed: t.classList.contains('track-soloed'),
        collapsed: t.classList.contains('track-collapsed')
      };
    });
    // Version tracking
    if (typeof _workoutVersion !== 'undefined') {
      _workoutVersion++;
      session.workoutVersion = _workoutVersion;
      updateVersionDisplay();
    }
    localStorage.setItem('sms_session', JSON.stringify(session));
    // Flash save indicator
    var si = document.getElementById('save-indicator');
    if (si) {
      si.style.opacity = '1';
      setTimeout(function() { si.style.opacity = '0'; }, 1200);
    }
  } catch(e) {}
}

function loadSession() {
  try {
    var saved = localStorage.getItem('sms_session');
    if (!saved) return;
    var s = JSON.parse(saved);
    if (s.bpm) { bpm = s.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
    // Restore playhead position
    if (typeof s.currentTime === 'number') {
      currentTime = s.currentTime;
      updateTimeDisplay();
      updatePlayheadPosition();
    }
    // Restore session timer cumulative
    if (typeof s.sessionElapsed === 'number') {
      sessionStartTime = Date.now() - (s.sessionElapsed * 1000);
    }
    if (s.clips) {
      s.clips.forEach(function(c) {
        var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
        var ex = getExercise(c.exerciseId);
        if (!track || !ex) return;
        var clip = createClipElement(ex, c.left, c.width, {
          sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe,
          fadeIn: c.fadeIn || '0', fadeOut: c.fadeOut || '0'
        });
        if (c.notes) clip.dataset.notes = c.notes;
        if (c.customColor) {
          clip.dataset.customColor = c.customColor;
          clip.style.background = 'linear-gradient(180deg, ' + c.customColor + '44 0%, ' + c.customColor + '22 100%)';
          clip.style.borderTopColor = c.customColor;
        }
        if (c.group) {
          clip.dataset.group = c.group;
          clip.style.outline = '1px dashed rgba(59,130,246,0.3)';
        }
        if (c.locked) {
          clip.dataset.locked = '1';
          clip.classList.add('clip-locked');
        }
        track.appendChild(clip);
      });
    }
    // Restore group counter
    if (s.groupCounter) _groupCounter = s.groupCounter;
    if (s.faders) {
      Object.keys(s.faders).forEach(function(key) {
        var fader = document.querySelector('[data-fader="'+key+'"]');
        if (!fader) return;
        var v = s.faders[key];
        fader.querySelector('.fader-fill').style.height = v + '%';
        fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
        fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
      });
    }
    // Restore knobs
    if (s.knobs) {
      Object.keys(s.knobs).forEach(function(key) {
        var knob = document.querySelector('[data-knob="'+key+'"]');
        if (!knob) return;
        var deg = s.knobs[key];
        var indicator = knob.querySelector('.knob-indicator');
        if (indicator) indicator.style.transform = 'translateX(-50%) rotate('+deg+'deg)';
        var val = ((deg + 135) / 270);
        var valEl = document.getElementById('knob-val-' + key);
        if (valEl) valEl.textContent = (val * 100).toFixed(0) + '%';
      });
    }
    // Restore markers
    if (s.markers && s.markers.length) {
      markers = s.markers;
      markerCounter = s.markerCounter || markers.length;
      renderAllMarkers();
    }
    // Restore workout name
    if (s.workoutName) {
      workoutName = s.workoutName;
      var wn = document.getElementById('workout-name');
      if (wn) wn.textContent = workoutName;
      var hn = document.getElementById('header-workout-name');
      if (hn) hn.textContent = workoutName;
    }
    if (s.createdAt) _sessionCreatedAt = s.createdAt;
    if (s.workoutNotes) workoutNotes = s.workoutNotes;
    // Restore workout version
    if (s.workoutVersion) { _workoutVersion = s.workoutVersion; updateVersionDisplay(); }
    // Restore recently used exercises
    if (s.recentExercises && s.recentExercises.length) {
      recentExercises = s.recentExercises;
      if (typeof updateRecentSection === 'function') updateRecentSection();
    }
    // Restore loop region
    if (typeof s.loopEnabled !== 'undefined') {
      loopEnabled = s.loopEnabled;
      loopStart = s.loopStart || 0;
      loopEnd = s.loopEnd || 60;
      var btn = document.getElementById('loop-btn');
      if (btn) btn.classList.toggle('active', loopEnabled);
      var region = document.getElementById('loop-region');
      region.classList.toggle('active', loopEnabled);
      if (loopEnabled) updateLoopRegion();
    }
    // Restore track states
    if (s.trackStates) {
      Object.keys(s.trackStates).forEach(function(tid) {
        var ts = s.trackStates[tid];
        var track = document.querySelector('.track[data-track="'+tid+'"]');
        if (!track) return;
        track.classList.toggle('track-muted', !!ts.muted);
        track.classList.toggle('track-soloed', !!ts.soloed);
        track.classList.toggle('track-collapsed', !!ts.collapsed);
        var muteBtn = track.querySelector('.track-btn[data-action="mute"]');
        var soloBtn = track.querySelector('.track-btn[data-action="solo"]');
        if (muteBtn) muteBtn.classList.toggle('muted', !!ts.muted);
        if (soloBtn) soloBtn.classList.toggle('soloed', !!ts.soloed);
      });
      var hasSolo = !!document.querySelector('.track-btn.soloed');
      var tracksEl = document.getElementById('timeline-tracks');
      if (tracksEl) tracksEl.classList.toggle('has-solo', hasSolo);
    }
    // Restore settings
    if (s.settings) {
      var st = s.settings;
      if (typeof st.snapEnabled !== 'undefined') {
        snapEnabled = st.snapEnabled;
        var snapBtn = document.getElementById('snap-badge');
        if (snapBtn) { snapBtn.classList.toggle('active', snapEnabled); snapBtn.textContent = snapEnabled ? 'SNAP ' + (st.gridRes || 4) + 'B' : 'SNAP'; }
        var settingsSnapBtn = document.getElementById('settings-snap');
        if (settingsSnapBtn) settingsSnapBtn.textContent = snapEnabled ? 'ON' : 'OFF';
      }
      if (st.gridRes) {
        gridRes = st.gridRes;
        var gridSel = document.getElementById('settings-grid');
        if (gridSel) gridSel.value = gridRes;
      }
      if (typeof st.sfxEnabled !== 'undefined') {
        sfxEnabled = st.sfxEnabled;
        var sfxBtn = document.getElementById('settings-sfx');
        if (sfxBtn) sfxBtn.textContent = sfxEnabled ? 'ON' : 'OFF';
      }
      if (typeof st.metroVolume !== 'undefined') {
        metroVolume = st.metroVolume;
        var metroSlider = document.getElementById('settings-metro-vol');
        if (metroSlider) metroSlider.value = metroVolume * 100;
      }
      if (typeof st.autoScrollEnabled !== 'undefined') {
        autoScrollEnabled = st.autoScrollEnabled;
        var asBtn = document.getElementById('auto-scroll-btn');
        if (asBtn) asBtn.classList.toggle('active', autoScrollEnabled);
        var asSettings = document.getElementById('settings-autoscroll');
        if (asSettings) asSettings.textContent = autoScrollEnabled ? 'ON' : 'OFF';
      }
      if (st.playbackSpeed) {
        playbackSpeed = st.playbackSpeed;
        var speedBtn = document.getElementById('speed-btn');
        if (speedBtn) speedBtn.textContent = playbackSpeed + 'x';
      }
      if (st.zoomLevel) {
        zoomLevel = st.zoomLevel;
        applyZoom();
      }
      if (typeof st.timeSigIdx === 'number') {
        timeSigIdx = st.timeSigIdx;
        var tsEl = document.getElementById('time-sig');
        if (tsEl && timeSigOptions[timeSigIdx]) tsEl.textContent = timeSigOptions[timeSigIdx];
      }
    }
    updateStats();
  } catch(e) {}
}

/* ===== EXPORT ===== */
function exportWorkout() {
  var workout = {
    version: 2,
    name: workoutName || 'Saturno Movement Studio Export',
    timestamp: new Date().toISOString(),
    createdAt: _sessionCreatedAt,
    workoutNotes: workoutNotes || '',
    bpm: bpm,
    bpmMode: document.getElementById('bpm-mode').textContent,
    tracks: {}
  };
  TRACKS.forEach(function(t) {
    if (t.isMusic) return;
    workout.tracks[t.id] = [];
  });
  document.querySelectorAll('.clip').forEach(function(clip) {
    var trackId = clip.parentElement.dataset.track;
    var ex = getExercise(clip.dataset.exerciseId);
    workout.tracks[trackId].push({
      movement: ex ? ex.name : clip.textContent,
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      discipline: ex ? ex.discipline : '',
      stage: ex ? ex.stage : 1,
      startTime: parseInt(clip.style.left) / 80 * 15,
      duration: parseInt(clip.style.width) / 80 * 15,
      sets: parseInt(clip.dataset.sets) || 3,
      reps: parseInt(clip.dataset.reps) || 8,
      tempo: parseFloat(clip.dataset.tempo) || 3,
      rest: parseInt(clip.dataset.rest) || 60,
      rpe: parseInt(clip.dataset.rpe) || 7,
      notes: clip.dataset.notes || '',
      fadeIn: parseInt(clip.dataset.fadeIn) || 0,
      fadeOut: parseInt(clip.dataset.fadeOut) || 0,
      customColor: clip.dataset.customColor || '',
      group: clip.dataset.group || '',
      locked: clip.dataset.locked || ''
    });
  });
  workout.groupCounter = _groupCounter;
  workout.markers = markers.map(function(m) { return {id: m.id, time: m.time, label: m.label}; });
  workout.loop = {enabled: loopEnabled, start: loopStart, end: loopEnd};
  workout.workoutVersion = _workoutVersion;
  // Faders
  workout.faders = {};
  document.querySelectorAll('[data-fader]').forEach(function(f) {
    var fill = f.querySelector('.fader-fill');
    workout.faders[f.dataset.fader] = parseFloat(fill.style.height) || 50;
  });
  // Knobs
  workout.knobs = {};
  document.querySelectorAll('[data-knob]').forEach(function(k) {
    var indicator = k.querySelector('.knob-indicator');
    if (indicator) {
      var m = indicator.style.transform.match(/rotate\(([^)]+)deg\)/);
      workout.knobs[k.dataset.knob] = m ? parseFloat(m[1]) : 0;
    }
  });
  var blob = new Blob([JSON.stringify(workout, null, 2)], {type: 'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  toast('Workout exported');
}

function exportCSV() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var rows = [['Track','Exercise','Pattern','Family','Discipline','Stage','Sets','Reps','Tempo','Rest','RPE','Color','Locked','Notes']];
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    var track = c.parentElement.dataset.track;
    rows.push([
      track, ex ? ex.name : '', ex ? ex.pattern : '', ex ? ex.family : '',
      ex ? ex.discipline : '', ex ? ex.stage : '',
      c.dataset.sets || '3', c.dataset.reps || '8', c.dataset.tempo || '3',
      c.dataset.rest || '60', c.dataset.rpe || '7',
      c.dataset.customColor || '',
      c.dataset.locked ? 'Yes' : '',
      (c.dataset.notes || '').replace(/"/g, '""')
    ]);
  });
  var csv = rows.map(function(r) { return r.map(function(v) { return '"' + v + '"'; }).join(','); }).join('\n');
  var blob = new Blob([csv], {type: 'text/csv'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  toast('CSV exported');
}

function shareWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var data = {n: workoutName || 'Workout', b: bpm, c: []};
  clips.forEach(function(clip) {
    data.c.push({
      e: clip.dataset.exerciseId,
      t: clip.parentElement.dataset.track,
      l: parseInt(clip.style.left) || 0,
      w: parseInt(clip.style.width) || 80,
      s: clip.dataset.sets, r: clip.dataset.reps,
      p: clip.dataset.rpe
    });
  });
  var json = JSON.stringify(data);
  var encoded = btoa(unescape(encodeURIComponent(json)));
  var url = window.location.origin + window.location.pathname + '#share=' + encoded;
  try {
    navigator.clipboard.writeText(url).then(function() {
      toast('Share URL copied to clipboard');
      sfx('click');
    });
  } catch(e) {
    toast('URL generated (check console)');
  }
}

function loadFromHash() {
  try {
    var hash = window.location.hash;
    if (!hash || hash.indexOf('#share=') !== 0) return;
    var encoded = hash.substring(7);
    var json = decodeURIComponent(escape(atob(encoded)));
    var data = JSON.parse(json);
    if (!data.c || !data.c.length) return;
    pushUndo();
    document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
    selectedClip = null;
    document.getElementById('inspector').style.display = 'none';
    if (data.b) { bpm = data.b; document.getElementById('bpm-input').value = bpm; updateBPMMode(); buildRuler(); }
    data.c.forEach(function(item) {
      var track = document.querySelector('.track-content[data-track="'+item.t+'"]');
      var ex = getExercise(item.e);
      if (!track || !ex) return;
      var clip = createClipElement(ex, item.l, item.w, {
        sets: item.s, reps: item.r, rpe: item.p
      });
      track.appendChild(clip);
    });
    updateStats(); saveSession();
    setWorkoutName(data.n || 'Shared Workout');
    toast('Loaded shared workout: ' + (data.n || 'Workout'));
    window.location.hash = '';
  } catch(e) {}
}

/* ===== IMPORT WORKOUT ===== */
function importWorkout() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function() {
    if (!input.files[0]) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var workout = JSON.parse(e.target.result);
        if (!workout.tracks) { toast('Invalid workout file'); return; }
        pushUndo();
        document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
        selectedClip = null;
        document.getElementById('inspector').style.display = 'none';
        if (workout.bpm) {
          bpm = workout.bpm;
          document.getElementById('bpm-input').value = bpm;
          updateBPMMode();
          buildRuler();
        }
        var pps = 80 / 15;
        Object.keys(workout.tracks).forEach(function(trackId) {
          var track = document.querySelector('.track-content[data-track="'+trackId+'"]');
          if (!track) return;
          workout.tracks[trackId].forEach(function(item) {
            var ex = null;
            for (var i = 0; i < EXERCISES.length; i++) {
              if (EXERCISES[i].name === item.movement) { ex = EXERCISES[i]; break; }
            }
            if (!ex) return;
            var left = (item.startTime || 0) * pps;
            var width = (item.duration || 15) * pps;
            var clip = createClipElement(ex, left, width, {
              sets: item.sets, reps: item.reps, tempo: item.tempo,
              rest: item.rest, rpe: item.rpe,
              fadeIn: (item.fadeIn || 0).toString(),
              fadeOut: (item.fadeOut || 0).toString()
            });
            if (item.notes) clip.dataset.notes = item.notes;
            if (item.customColor) {
              clip.dataset.customColor = item.customColor;
              clip.style.background = 'linear-gradient(180deg, ' + item.customColor + '44 0%, ' + item.customColor + '22 100%)';
              clip.style.borderTopColor = item.customColor;
            }
            if (item.group) {
              clip.dataset.group = item.group;
              clip.style.outline = '1px dashed rgba(59,130,246,0.3)';
            }
            if (item.locked) {
              clip.dataset.locked = '1';
              clip.classList.add('clip-locked');
            }
            track.appendChild(clip);
          });
        });
        if (workout.groupCounter) _groupCounter = workout.groupCounter;
        // Import markers
        if (workout.markers && workout.markers.length) {
          markers = workout.markers;
          markerCounter = markers.reduce(function(max, m) { return Math.max(max, m.id); }, 0);
          renderAllMarkers();
        }
        // Import faders
        if (workout.faders) {
          Object.keys(workout.faders).forEach(function(key) {
            var fader = document.querySelector('[data-fader="'+key+'"]');
            if (!fader) return;
            var v = workout.faders[key];
            fader.querySelector('.fader-fill').style.height = v + '%';
            fader.querySelector('.fader-handle').style.bottom = (v - 3) + '%';
            fader.querySelector('.fader-value').textContent = (v / 10).toFixed(0);
          });
        }
        // Import knobs
        if (workout.knobs) {
          Object.keys(workout.knobs).forEach(function(key) {
            var knob = document.querySelector('[data-knob="'+key+'"]');
            if (!knob) return;
            var deg = workout.knobs[key];
            var indicator = knob.querySelector('.knob-indicator');
            if (indicator) indicator.style.transform = 'translateX(-50%) rotate('+deg+'deg)';
            var val = ((deg + 135) / 270);
            var valEl = document.getElementById('knob-val-' + key);
            if (valEl) valEl.textContent = (val * 100).toFixed(0) + '%';
          });
        }
        // Import loop
        if (workout.loop) {
          loopEnabled = workout.loop.enabled || false;
          loopStart = workout.loop.start || 0;
          loopEnd = workout.loop.end || 60;
          var lBtn = document.getElementById('loop-btn');
          if (lBtn) lBtn.classList.toggle('active', loopEnabled);
          var lReg = document.getElementById('loop-region');
          lReg.classList.toggle('active', loopEnabled);
          if (loopEnabled) updateLoopRegion();
        }
        if (workout.createdAt) _sessionCreatedAt = workout.createdAt;
        if (workout.workoutNotes) workoutNotes = workout.workoutNotes;
        updateStats();
        saveSession();
        sfx('preset');
        setWorkoutName(workout.name || 'Imported Workout');
        toast('Imported: ' + (workout.name || 'workout'));
      } catch(err) {
        toast('Error importing file');
      }
    };
    reader.readAsText(input.files[0]);
  };
  input.click();
}

/* ===== PRINT WORKOUT ===== */
function printWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.textContent,
      pattern: ex ? ex.pattern : '',
      discipline: ex ? ex.discipline : '',
      stage: ex ? ex.stage : 1,
      sets: c.dataset.sets || 3,
      reps: c.dataset.reps || 8,
      tempo: c.dataset.tempo || 3,
      rest: c.dataset.rest || 60,
      rpe: c.dataset.rpe || 7,
      notes: c.dataset.notes || '',
      startTime: parseInt(c.style.left) / 80 * 15
    });
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var totalClips = clips.length;
  var totalSets = 0, totalReps = 0;
  clips.forEach(function(c) { totalSets += parseInt(c.dataset.sets) || 3; totalReps += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8); });
  var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var letterIdx = 0;
  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Workout - Saturno Movement Studio</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=Sora:wght@200;300;400;500;600&display=swap" rel="stylesheet">';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}';
  html += 'body{font-family:Sora,sans-serif;padding:48px 32px 80px;max-width:600px;margin:0 auto;background:#050711;color:#e2e8f0}';
  html += 'h1{font-size:22px;font-weight:300;letter-spacing:0.06em;margin-bottom:4px}';
  html += '.subtitle{font-size:9px;color:#475569;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:20px}';
  html += '.meta{font-size:10px;color:#64748b;display:flex;gap:24px;margin-bottom:32px;letter-spacing:0.04em}';
  html += '.meta b{font-weight:500;color:#94a3b8}';
  html += '.stats{display:flex;gap:32px;justify-content:center;margin-bottom:32px}';
  html += '.stat{text-align:center}';
  html += '.stat-val{font-size:28px;font-weight:200;background:linear-gradient(135deg,#06b6d4,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}';
  html += '.stat-label{font-size:7px;color:#475569;text-transform:uppercase;letter-spacing:0.2em;margin-top:4px}';
  html += '.divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);margin:32px 0}';
  html += '.group-label{font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:20px}';
  html += '.exercise{display:flex;gap:16px;align-items:flex-start;padding:16px 0;border-bottom:1px solid rgba(255,255,255,0.03)}';
  html += '.exercise:last-child{border-bottom:none}';
  html += '.ex-idx{font-size:11px;font-weight:300;color:#475569;min-width:28px;letter-spacing:0.04em;padding-top:1px}';
  html += '.ex-body{flex:1}';
  html += '.ex-name{font-size:14px;font-weight:500;color:#e2e8f0;letter-spacing:0.02em;margin-bottom:8px;line-height:1.2}';
  html += '.ex-params{display:flex;flex-wrap:wrap;gap:16px;font-size:11px;color:#64748b}';
  html += '.param{display:flex;align-items:baseline;gap:4px}';
  html += '.param-val{font-weight:500}';
  html += '.param-label{font-size:8px;color:#475569;text-transform:uppercase;letter-spacing:0.08em}';
  html += '.footer{text-align:center;margin-top:48px;font-size:8px;color:rgba(255,255,255,0.12);text-transform:uppercase;letter-spacing:0.2em}';
  html += '@media print{body{padding:24px;background:#fff;color:#111}';
  html += '.stat-val{background:none;-webkit-text-fill-color:#111;color:#111}';
  html += '.ex-name{color:#111}.ex-params{color:#555}.param-label{color:#888}';
  html += '.group-label{color:#888}.ex-idx{color:#888}.meta{color:#888}.meta b{color:#555}';
  html += '.divider{background:#e0e0e0}.exercise{border-bottom-color:#eee}';
  html += '.subtitle{color:#888}.footer{color:#ccc}}';
  html += '</style></head><body>';
  html += '<h1>' + (workoutName && workoutName !== 'Untitled' ? workoutName : 'Saturno Movement Studio') + '</h1>';
  html += '<div class="subtitle">' + (workoutName && workoutName !== 'Untitled' ? 'Saturno Movement Studio' : 'The Ableton of Movement') + '</div>';
  var printCreated = _sessionCreatedAt ? new Date(_sessionCreatedAt).toLocaleDateString('en-US', {month:'short',day:'numeric'}) : '';
  var modeDesc = '';
  for (var mi = 0; mi < BPM_MODES.length; mi++) {
    if (mode === BPM_MODES[mi].name) { modeDesc = BPM_MODES[mi].desc; break; }
  }
  html += '<div class="meta"><span><b>' + bpm + '</b> BPM</span><span>' + mode + (modeDesc ? ' - ' + modeDesc : '') + '</span><span>' + new Date().toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + '</span>';
  if (printCreated) html += '<span>Created ' + printCreated + '</span>';
  html += '</div>';
  if (workoutNotes) {
    html += '<div style="font-size:10px;color:#64748b;margin-bottom:16px;font-style:italic;line-height:1.5">' + workoutNotes.replace(/</g, '&lt;') + '</div>';
  }
  var totalDur = 0;
  clips.forEach(function(c) {
    var st = parseInt(c.dataset.sets) || 3;
    var rp = parseInt(c.dataset.reps) || 8;
    var tp = parseFloat(c.dataset.tempo) || 3;
    var rs = parseInt(c.dataset.rest) || 60;
    totalDur += (st * rp * tp) + ((st - 1) * rs);
  });
  var durMin = Math.floor(totalDur / 60);
  html += '<div class="stats"><div class="stat"><div class="stat-val">' + totalClips + '</div><div class="stat-label">Exercises</div></div>';
  html += '<div class="stat"><div class="stat-val">' + totalSets + '</div><div class="stat-label">Total Sets</div></div>';
  html += '<div class="stat"><div class="stat-val">' + totalReps + '</div><div class="stat-label">Total Reps</div></div>';
  html += '<div class="stat"><div class="stat-val">' + durMin + '</div><div class="stat-label">Est. Minutes</div></div></div>';
  var printFams = {};
  clips.forEach(function(c) { var ex = getExercise(c.dataset.exerciseId); if (ex) printFams[ex.family] = (printFams[ex.family] || 0) + 1; });
  var pfKeys = Object.keys(printFams);
  if (pfKeys.length > 0) {
    html += '<div style="text-align:center;font-size:9px;color:#64748b;margin-bottom:24px;letter-spacing:0.04em">';
    html += pfKeys.sort(function(a,b){ return printFams[b]-printFams[a]; }).map(function(f){ return f + ' (' + printFams[f] + ')'; }).join(' / ');
    html += '</div>';
  }
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackColors = {push:'#3b82f6',pull:'#8b5cf6',core:'#f97316',legs:'#22c55e',skills:'#06b6d4'};
  var trackOrder = ['push','pull','legs','core','skills'];
  trackOrder.forEach(function(trackId) {
    if (!groups[trackId] || groups[trackId].length === 0) return;
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.startTime - b.startTime; });
    var letter = letters[letterIdx] || 'Z';
    letterIdx++;
    html += '<div class="divider"></div>';
    html += '<div class="group-label" style="color:' + (trackColors[trackId] || '#64748b') + '">' + (trackNames[trackId] || trackId) + ' <span style="font-weight:300;opacity:0.6">(' + exercises.length + ')</span></div>';
    exercises.forEach(function(ex, i) {
      var idx = letter + (i + 1);
      html += '<div class="exercise">';
      html += '<div class="ex-idx" style="color:' + (trackColors[trackId] || '#64748b') + '">' + idx + '</div>';
      html += '<div class="ex-body">';
      html += '<div class="ex-name">' + ex.name + '</div>';
      if (ex.discipline || ex.stage) {
        html += '<div style="font-size:9px;color:#475569;margin-bottom:6px;letter-spacing:0.04em">';
        if (ex.discipline) html += ex.discipline;
        if (ex.discipline && ex.stage) html += ' &middot; ';
        if (ex.stage) html += 'Stage ' + ex.stage;
        html += '</div>';
      }
      html += '<div class="ex-params">';
      html += '<div class="param"><span class="param-val" style="color:#eab308">' + ex.reps + '</span> <span class="param-label">reps</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#3b82f6">' + ex.sets + '</span> <span class="param-label">sets</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#22c55e">' + ex.rest + 's</span> <span class="param-label">rest</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#8b5cf6">' + ex.tempo + 's</span> <span class="param-label">tempo</span></div>';
      html += '<div class="param"><span class="param-val" style="color:#ef4444">' + ex.rpe + '</span> <span class="param-label">rpe</span></div>';
      html += '</div>';
      if (ex.notes) {
        html += '<div style="margin-top:6px;font-size:10px;color:#64748b;font-style:italic;line-height:1.4">' + ex.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      } else {
        html += '<div style="margin-top:8px;border-bottom:1px dashed rgba(255,255,255,0.06);height:1px"></div>';
      }
      html += '</div></div>';
    });
  });
  html += '<div class="footer">Generated by Saturno Movement Studio</div>';
  html += '</body></html>';
  var win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.print();
}

/* ===== WORKOUT SUMMARY ===== */
function showSummary() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add exercises to view summary'); return; }

  // Group clips by track, sorted by position
  var groups = {};
  clips.forEach(function(c) {
    var trackId = c.parentElement.dataset.track;
    if (!groups[trackId]) groups[trackId] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[trackId].push({
      name: ex ? ex.name : c.querySelector('.clip-name') ? c.querySelector('.clip-name').textContent : 'Exercise',
      pattern: ex ? ex.pattern : '',
      family: ex ? ex.family : '',
      discipline: ex ? ex.discipline : '',
      stage: ex ? ex.stage : 1,
      sets: c.dataset.sets || '3',
      reps: c.dataset.reps || '8',
      tempo: c.dataset.tempo || '3',
      rest: c.dataset.rest || '60',
      rpe: c.dataset.rpe || '7',
      notes: c.dataset.notes || '',
      left: parseInt(c.style.left) || 0
    });
  });

  // Totals
  var totalEx = clips.length;
  var totalSets = 0;
  var totalReps = 0;
  clips.forEach(function(c) {
    var s = parseInt(c.dataset.sets) || 3;
    var r = parseInt(c.dataset.reps) || 8;
    totalSets += s;
    totalReps += s * r;
  });

  var mode = document.getElementById('bpm-mode').textContent;
  var name = workoutName && workoutName !== 'Untitled' ? workoutName : 'Workout';
  var trackNames = {push:'Push',pull:'Pull',core:'Core',legs:'Legs',skills:'Skills'};
  var trackColors = {push:'#3b82f6',pull:'#8b5cf6',core:'#f97316',legs:'#22c55e',skills:'#06b6d4'};
  var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var letterIdx = 0;

  var html = '';
  html += '<div class="summary-header">';
  html += '<div class="summary-title">' + name + '</div>';
  html += '<div class="summary-subtitle">Saturno Movement Studio</div>';
  html += '<div class="summary-meta">';
  html += '<span><span class="summary-meta-val">' + bpm + '</span> BPM</span>';
  html += '<span>' + mode + '</span>';
  html += '<span>' + new Date().toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + '</span>';
  html += '</div>';
  html += '</div>';
  if (workoutNotes) {
    html += '<div style="font-size:10px;color:var(--muted);margin-bottom:12px;font-style:italic;text-align:center;line-height:1.5">' + workoutNotes.replace(/</g, '&lt;') + '</div>';
  }

  // Estimated workout time
  var estSec = 0;
  clips.forEach(function(c) {
    var st = parseInt(c.dataset.sets) || 3;
    var rp = parseInt(c.dataset.reps) || 8;
    var tp = parseFloat(c.dataset.tempo) || 3;
    var rs = parseInt(c.dataset.rest) || 60;
    estSec += st * (rp * tp + rs) - rs;
  });
  var estMin = Math.floor(estSec / 60);
  // Unique disciplines
  var disciplines = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex && ex.discipline) disciplines[ex.discipline] = true;
  });
  var discCount = Object.keys(disciplines).length;

  html += '<div class="summary-stats">';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + totalEx + '</div><div class="summary-stat-label">Exercises</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + totalSets + '</div><div class="summary-stat-label">Total Sets</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + totalReps + '</div><div class="summary-stat-label">Total Reps</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + estMin + '</div><div class="summary-stat-label">Est. Minutes</div></div>';
  html += '<div class="summary-stat"><div class="summary-stat-val">' + getSessionElapsed() + '</div><div class="summary-stat-label">Session Time</div></div>';
  html += '</div>';
  // Family breakdown
  var famBreak = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) famBreak[ex.family] = (famBreak[ex.family] || 0) + 1;
  });
  var famHtml = '';
  Object.keys(famBreak).sort(function(a, b) { return famBreak[b] - famBreak[a]; }).forEach(function(f) {
    var fc = (FAMILY_MAP[f] || {}).color || '#666';
    famHtml += '<span style="color:' + fc + ';font-weight:500">' + f + ' ' + famBreak[f] + '</span>';
  });
  if (famHtml) {
    html += '<div style="text-align:center;font-size:8px;color:var(--micro);margin-bottom:8px;display:flex;justify-content:center;gap:12px;letter-spacing:0.04em">' + famHtml + '</div>';
  }
  if (discCount > 0) {
    html += '<div style="text-align:center;font-size:9px;color:var(--micro);margin-bottom:16px;letter-spacing:0.06em">' + Object.keys(disciplines).join(' / ') + '</div>';
  }

  var trackOrder = ['push','pull','legs','core','skills'];
  trackOrder.forEach(function(trackId) {
    if (!groups[trackId] || groups[trackId].length === 0) return;
    var exercises = groups[trackId];
    exercises.sort(function(a,b) { return a.left - b.left; });
    var letter = letters[letterIdx] || 'Z';
    letterIdx++;

    html += '<div class="summary-divider"></div>';
    html += '<div class="summary-group-label" style="color:' + (trackColors[trackId] || '#64748b') + '">' + (trackNames[trackId] || trackId) + '</div>';

    exercises.forEach(function(ex, i) {
      var idx = letter + (i + 1);
      var tempoStr = ex.tempo + 's';
      var restMin = parseInt(ex.rest);
      var restStr = restMin >= 60 ? Math.floor(restMin / 60) + '-' + Math.ceil(restMin / 60 + 0.5) + ' min' : restMin + 's';

      html += '<div class="summary-exercise">';
      html += '<div class="summary-ex-index" style="color:' + (trackColors[trackId] || '#64748b') + '">' + idx + '</div>';
      html += '<div class="summary-ex-body">';
      html += '<div class="summary-ex-name">' + ex.name;
      if (ex.discipline && ex.discipline !== 'Calisthenics') html += ' <span style="font-size:10px;color:var(--micro);font-weight:300">(' + ex.discipline + ')</span>';
      html += '</div>';
      html += '<div class="summary-ex-params">';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#eab308">' + ex.reps + '</span> <span class="summary-param-label">reps</span></div>';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#3b82f6">' + ex.sets + '</span> <span class="summary-param-label">sets</span></div>';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#22c55e">' + restStr + '</span> <span class="summary-param-label">rest</span></div>';
      html += '<div class="summary-ex-param"><span class="summary-param-val" style="color:#8b5cf6">' + tempoStr + '</span> <span class="summary-param-label">tempo</span></div>';
      html += '</div>';
      if (ex.notes) {
        html += '<div style="margin-top:8px;font-size:10px;color:var(--text-secondary);font-style:italic;line-height:1.5;opacity:0.8">' + ex.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>';
      }
      // Build progression chain for this exercise's pattern
      var chainId = 'prog-' + trackId + '-' + i;
      html += '<div class="summary-ex-prog" onclick="toggleProgChain(\'' + chainId + '\')">Progressions &amp; Alternatives</div>';
      html += '<div class="summary-prog-chain" id="' + chainId + '">';
      var siblings = EXERCISES.filter(function(e) { return e.pattern === ex.pattern; });
      var stages = [1, 2, 3];
      var stageLabels = {0:'Foundation', 1:'Stage 1', 2:'Stage 2', 3:'Stage 3'};
      stages.forEach(function(s) {
        var stageExs = siblings.filter(function(e) { return e.stage === s; });
        if (stageExs.length === 0) return;
        html += '<div class="summary-prog-stage">' + (stageLabels[s] || 'Stage ' + s) + '</div>';
        stageExs.forEach(function(se) {
          var isCurrent = se.name === ex.name;
          html += '<div class="summary-prog-item' + (isCurrent ? ' current' : '') + '">';
          html += (isCurrent ? '> ' : '') + se.name;
          if (se.discipline !== 'Calisthenics') html += ' <span class="prog-disc">' + se.discipline + '</span>';
          html += '</div>';
        });
      });
      html += '</div>';
      html += '</div>';
      html += '</div>';
    });
  });

  html += '<div class="summary-footer">Generated by Saturno Movement Studio</div>';

  document.getElementById('summary-content').innerHTML = html;
  document.getElementById('summary-overlay').classList.add('open');
  sfx('open');
}

function closeSummary() {
  document.getElementById('summary-overlay').classList.remove('open');
}

function copyWorkoutText() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No exercises to copy'); return; }
  var lines = [];
  var name = workoutName && workoutName !== 'Untitled' ? workoutName : 'Workout';
  var txtEstSec = 0;
  clips.forEach(function(c) {
    var st = parseInt(c.dataset.sets) || 3;
    var rp = parseInt(c.dataset.reps) || 8;
    var tp = parseFloat(c.dataset.tempo) || 3;
    var rs = parseInt(c.dataset.rest) || 60;
    txtEstSec += st * (rp * tp + rs) - rs;
  });
  var txtEstMin = Math.floor(txtEstSec / 60);
  lines.push(name + ' | ' + bpm + ' BPM | ' + document.getElementById('bpm-mode').textContent);
  lines.push(clips.length + ' exercises | ~' + txtEstMin + ' min');
  if (workoutNotes) { lines.push('Notes: ' + workoutNotes); }
  lines.push('');
  var trackNames = {push:'PUSH',pull:'PULL',core:'CORE',legs:'LEGS',skills:'SKILLS'};
  var trackOrder = ['push','pull','legs','core','skills'];
  var groups = {};
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!groups[tid]) groups[tid] = [];
    var ex = getExercise(c.dataset.exerciseId);
    groups[tid].push({
      name: ex ? ex.name : 'Exercise',
      sets: c.dataset.sets || '3',
      reps: c.dataset.reps || '8',
      tempo: c.dataset.tempo || '3',
      rest: c.dataset.rest || '60',
      rpe: c.dataset.rpe || '7',
      notes: c.dataset.notes || '',
      left: parseInt(c.style.left) || 0
    });
  });
  trackOrder.forEach(function(tid) {
    if (!groups[tid] || groups[tid].length === 0) return;
    groups[tid].sort(function(a, b) { return a.left - b.left; });
    lines.push('--- ' + (trackNames[tid] || tid) + ' ---');
    groups[tid].forEach(function(ex, i) {
      var line = (i+1) + '. ' + ex.name + ' - ' + ex.sets + 'x' + ex.reps + ' @' + ex.tempo + 's | Rest ' + ex.rest + 's | RPE ' + ex.rpe;
      if (ex.notes) line += ' | Note: ' + ex.notes;
      lines.push(line);
    });
    lines.push('');
  });
  lines.push('Made with Saturno Movement Studio');
  var text = lines.join('\n');
  try {
    navigator.clipboard.writeText(text).then(function() {
      toast('Workout copied to clipboard');
      sfx('click');
    });
  } catch(e) {
    toast('Could not copy');
  }
}

// Click overlay background to close summary
document.getElementById('summary-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeSummary();
});

function toggleProgChain(id) {
  var el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}



/* ===== TOAST ===== */
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2000);
}

/* ===== SAVED WORKOUTS ===== */
function getSavedWorkouts() {
  try { return JSON.parse(localStorage.getItem('sms_saved_workouts') || '[]'); } catch(e) { return []; }
}

function saveNamedWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  showInlinePrompt('Save workout as', workoutName !== 'Untitled' ? workoutName : '', function(name) {
    if (!name) return;
    var workout = {
      name: name,
      created: new Date().toISOString(),
      bpm: bpm,
      clipCount: clips.length,
      state: captureState()
    };
    var saved = getSavedWorkouts();
    saved.unshift(workout);
    if (saved.length > 20) saved = saved.slice(0, 20);
    try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
    setWorkoutName(name);
    toast('Saved: ' + name);
  });
}

function showSavedWorkouts() {
  var saved = getSavedWorkouts();
  var list = document.getElementById('saved-list');
  if (saved.length === 0) {
    list.innerHTML = '<div class="saved-empty">No saved workouts yet. Use SAVE AS to save one.</div>';
  } else {
    var html = '';
    saved.forEach(function(w, i) {
      var date = new Date(w.created).toLocaleDateString();
      var timeAgo = '';
      var diff = Date.now() - new Date(w.created).getTime();
      var hours = Math.floor(diff / 3600000);
      var days = Math.floor(diff / 86400000);
      if (days > 0) timeAgo = days + 'd ago';
      else if (hours > 0) timeAgo = hours + 'h ago';
      else timeAgo = 'just now';
      html += '<div class="saved-item" onclick="loadSavedWorkout('+i+')">';
      html += '<span class="saved-item-delete" onclick="event.stopPropagation();deleteSavedWorkout('+i+')">delete</span>';
      html += '<div class="saved-item-name">'+w.name+'</div>';
      html += '<div class="saved-item-info" style="display:flex;gap:8px;flex-wrap:wrap">';
      html += '<span>'+w.clipCount+' clips</span>';
      html += '<span style="color:var(--accent-orange)">'+w.bpm+' BPM</span>';
      html += '<span>'+timeAgo+'</span>';
      html += '</div></div>';
    });
    list.innerHTML = html;
  }
  document.getElementById('saved-modal').classList.add('open');
}

function closeSavedWorkouts() {
  document.getElementById('saved-modal').classList.remove('open');
}

function loadSavedWorkout(index) {
  var saved = getSavedWorkouts();
  if (!saved[index]) return;
  pushUndo();
  var state = JSON.parse(saved[index].state);
  restoreState(state);
  closeSavedWorkouts();
  setWorkoutName(saved[index].name);
  toast('Loaded: ' + saved[index].name);
}

function deleteSavedWorkout(index) {
  var saved = getSavedWorkouts();
  var name = saved[index] ? saved[index].name : '';
  saved.splice(index, 1);
  try { localStorage.setItem('sms_saved_workouts', JSON.stringify(saved)); } catch(e) {}
  showSavedWorkouts();
  toast('Deleted: ' + name);
}

/* Close modal on overlay click */
document.addEventListener('DOMContentLoaded', function() {
  var modal = document.getElementById('saved-modal');
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeSavedWorkouts();
  });
});

/* ===== UNDO / REDO ===== */
function captureState() {
  var state = {bpm: bpm, clips: []};
  document.querySelectorAll('.clip').forEach(function(clip) {
    state.clips.push({
      exerciseId: clip.dataset.exerciseId,
      track: clip.parentElement.dataset.track,
      left: clip.style.left,
      width: clip.style.width,
      sets: clip.dataset.sets,
      reps: clip.dataset.reps,
      tempo: clip.dataset.tempo,
      rest: clip.dataset.rest,
      rpe: clip.dataset.rpe,
      notes: clip.dataset.notes || '',
      customColor: clip.dataset.customColor || '',
      fadeIn: clip.dataset.fadeIn || '0',
      fadeOut: clip.dataset.fadeOut || '0',
      group: clip.dataset.group || '',
      locked: clip.dataset.locked || ''
    });
  });
  state.markers = markers.map(function(m) { return {id: m.id, time: m.time, label: m.label}; });
  state.markerCounter = markerCounter;
  state.groupCounter = _groupCounter;
  state.loopEnabled = loopEnabled;
  state.loopStart = loopStart;
  state.loopEnd = loopEnd;
  return JSON.stringify(state);
}

function updateUndoCount() {
  var el = document.getElementById('undo-count');
  if (el) el.textContent = undoStack.length > 0 || redoStack.length > 0 ? 'U:' + undoStack.length + ' R:' + redoStack.length : '';
}

function pushUndo() {
  var state = captureState();
  if (undoStack.length > 0 && undoStack[undoStack.length - 1] === state) return;
  undoStack.push(state);
  if (undoStack.length > maxUndo) undoStack.shift();
  redoStack = [];
  updateUndoCount();
}

function undo() {
  if (undoStack.length === 0) { toast('Nothing to undo'); return; }
  redoStack.push(captureState());
  var state = JSON.parse(undoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Undo (' + undoStack.length + ' left)');
  updateUndoCount();
}

function redo() {
  if (redoStack.length === 0) { toast('Nothing to redo'); return; }
  undoStack.push(captureState());
  var state = JSON.parse(redoStack.pop());
  restoreState(state);
  sfx('undo');
  toast('Redo (' + redoStack.length + ' left)');
  updateUndoCount();
}

function restoreState(state) {
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  if (state.bpm) { bpm = state.bpm; document.getElementById('bpm-input').value = bpm; updateBPMMode(); }
  state.clips.forEach(function(c) {
    var track = document.querySelector('.track-content[data-track="'+c.track+'"]');
    var ex = getExercise(c.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, c.left, c.width, {
      sets: c.sets, reps: c.reps, tempo: c.tempo, rest: c.rest, rpe: c.rpe,
      fadeIn: c.fadeIn || '0', fadeOut: c.fadeOut || '0'
    });
    if (c.notes) clip.dataset.notes = c.notes;
    if (c.customColor) {
      clip.dataset.customColor = c.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + c.customColor + '44 0%, ' + c.customColor + '22 100%)';
      clip.style.borderTopColor = c.customColor;
    }
    if (c.group) {
      clip.dataset.group = c.group;
      clip.style.outline = '1px dashed rgba(59,130,246,0.3)';
    }
    if (c.locked) {
      clip.dataset.locked = '1';
      clip.classList.add('clip-locked');
    }
    track.appendChild(clip);
  });
  // Restore group counter
  if (state.groupCounter) _groupCounter = state.groupCounter;
  // Restore markers
  if (state.markers) {
    markers = state.markers;
    markerCounter = state.markerCounter || markers.length;
    renderAllMarkers();
  }
  // Restore loop state
  if (typeof state.loopEnabled !== 'undefined') {
    loopEnabled = state.loopEnabled;
    loopStart = state.loopStart || 0;
    loopEnd = state.loopEnd || 60;
    var lBtn = document.getElementById('loop-btn');
    if (lBtn) lBtn.classList.toggle('active', loopEnabled);
    var lRegion = document.getElementById('loop-region');
    lRegion.classList.toggle('active', loopEnabled);
    if (loopEnabled) updateLoopRegion();
  }
  updateStats();
  saveSession();
}

/* ===== DELETE SELECTED CLIPS ===== */
function deleteSelectedClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('No clips selected'); return; }
  pushUndo();
  var count = 0;
  sel.forEach(function(c) { if (!c.classList.contains('clip-locked')) { c.remove(); count++; } });
  if (count === 0) { toast('All selected clips are locked'); return; }
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession();
  sfx('delete');
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clip' + (count > 1 ? 's' : '') + ' deleted');
}

/* ===== DUPLICATE CLIP ===== */
function duplicateClip() {
  var allSelected = document.querySelectorAll('.clip.selected');
  if (allSelected.length > 1) {
    pushUndo();
    var duped = 0;
    allSelected.forEach(function(src) {
      if (src.classList.contains('clip-locked')) return;
      var ex = getExercise(src.dataset.exerciseId);
      if (!ex) return;
      var track = src.parentElement;
      var newLeft = parseInt(src.style.left) + parseInt(src.style.width) + 4;
      var clip = createClipElement(ex, newLeft, parseInt(src.style.width), {
        sets: src.dataset.sets, reps: src.dataset.reps,
        tempo: src.dataset.tempo, rest: src.dataset.rest,
        rpe: src.dataset.rpe,
        fadeIn: src.dataset.fadeIn || '0', fadeOut: src.dataset.fadeOut || '0'
      });
      if (src.dataset.notes) clip.dataset.notes = src.dataset.notes;
      if (src.dataset.customColor) {
        clip.dataset.customColor = src.dataset.customColor;
        clip.style.background = 'linear-gradient(180deg, ' + src.dataset.customColor + '44 0%, ' + src.dataset.customColor + '22 100%)';
        clip.style.borderTopColor = src.dataset.customColor;
      }
      track.appendChild(clip);
      duped++;
    });
    updateStats(); saveSession(); sfx('drop');
    toast(duped + ' clips duplicated');
    return;
  }
  if (!selectedClip) { toast('Select a clip first'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var track = selectedClip.parentElement;
  var newLeft = parseInt(selectedClip.style.left) + parseInt(selectedClip.style.width) + 4;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: selectedClip.dataset.fadeIn || '0',
    fadeOut: selectedClip.dataset.fadeOut || '0'
  });
  if (selectedClip.dataset.notes) clip.dataset.notes = selectedClip.dataset.notes;
  if (selectedClip.dataset.customColor) {
    clip.dataset.customColor = selectedClip.dataset.customColor;
    clip.style.background = 'linear-gradient(180deg, ' + selectedClip.dataset.customColor + '44 0%, ' + selectedClip.dataset.customColor + '22 100%)';
    clip.style.borderTopColor = selectedClip.dataset.customColor;
  }
  track.appendChild(clip);
  selectClipEl(clip);
  updateStats();
  saveSession();
  sfx('drop');
  toast('Duplicated: ' + ex.name);
}

/* ===== SNAP TO GRID ===== */
var snapEnabled = false;

function getSnapSize() {
  // gridRes = beats per snap unit, pps = 80px / 15sec, beatSec = 60/bpm
  var pps = 80 / 15;
  var beatSec = 60 / bpm;
  return Math.round(gridRes * beatSec * pps);
}

function toggleSnap() {
  snapEnabled = !snapEnabled;
  var btn = document.getElementById('btn-snap');
  if (btn) btn.classList.toggle('active', snapEnabled);
  var settingsBtn = document.getElementById('settings-snap');
  if (settingsBtn) settingsBtn.textContent = snapEnabled ? 'ON' : 'OFF';
  var snapBadge = document.getElementById('snap-badge');
  if (snapBadge) {
    snapBadge.classList.toggle('active', snapEnabled);
    snapBadge.textContent = snapEnabled ? 'SNAP ' + gridRes + 'B' : 'SNAP';
  }
  sfx('snap');
  toast(snapEnabled ? 'Snap ON (' + gridRes + ' beat' + (gridRes > 1 ? 's' : '') + ')' : 'Snap OFF');
}

function snapValue(val) {
  if (!snapEnabled) return val;
  var sz = getSnapSize();
  if (sz < 4) sz = 4; // minimum 4px snap to avoid 0-division
  var snapped = Math.round(val / sz) * sz;
  if (snapped !== val) showSnapLine(snapped);
  return snapped;
}
function showSnapLine(x) {
  var container = document.getElementById('timeline-tracks');
  if (!container) return;
  var line = document.createElement('div');
  line.className = 'snap-line';
  line.style.left = x + 'px';
  container.appendChild(line);
  setTimeout(function() { if (line.parentNode) line.remove(); }, 300);
}

/* ===== ZOOM ===== */
var zoomLevel = 100;
var ZOOM_STEPS = [50, 75, 100, 125, 150, 200];

function zoomIn() {
  var idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx < ZOOM_STEPS.length - 1) {
    zoomLevel = ZOOM_STEPS[idx + 1];
    applyZoom();
    toast('Zoom: ' + zoomLevel + '%');
  }
}

function zoomOut() {
  var idx = ZOOM_STEPS.indexOf(zoomLevel);
  if (idx > 0) {
    zoomLevel = ZOOM_STEPS[idx - 1];
    applyZoom();
    toast('Zoom: ' + zoomLevel + '%');
  }
}

function zoomToFit() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to fit'); return; }
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  maxRight += 120; // padding for track headers + margin
  var containerW = document.getElementById('timeline-container').clientWidth;
  var targetZoom = Math.round(containerW / maxRight * 100);
  // Clamp to zoom steps
  var bestStep = ZOOM_STEPS[0];
  for (var i = 0; i < ZOOM_STEPS.length; i++) {
    if (ZOOM_STEPS[i] <= targetZoom) bestStep = ZOOM_STEPS[i];
  }
  zoomLevel = bestStep;
  applyZoom();
  document.getElementById('timeline-container').scrollLeft = 0;
  toast('Zoom to fit: ' + zoomLevel + '%');
}

function applyZoom() {
  var scale = zoomLevel / 100;
  var tracks = document.getElementById('timeline-tracks');
  var ruler = document.getElementById('timeline-ruler');
  tracks.style.transform = 'scaleX(' + scale + ')';
  tracks.style.transformOrigin = 'left top';
  ruler.style.transform = 'scaleX(' + scale + ')';
  ruler.style.transformOrigin = 'left top';
  document.getElementById('zoom-level').textContent = zoomLevel + '%';
  // Sync footer zoom slider
  var sliderIdx = ZOOM_STEPS.indexOf(zoomLevel);
  if (sliderIdx >= 0) {
    var slider = document.getElementById('zoom-slider');
    if (slider) slider.value = sliderIdx;
  }
  var pct = document.getElementById('zoom-pct');
  if (pct) pct.textContent = zoomLevel + '%';
  // Toggle 16th note grid at higher zoom levels
  var trackContents = document.querySelectorAll('.track-content');
  trackContents.forEach(function(tc) {
    if (zoomLevel >= 125) {
      tc.classList.add('grid-16th');
    } else {
      tc.classList.remove('grid-16th');
    }
  });
  sfx('click');
}

function setZoomFromSlider(val) {
  var idx = parseInt(val);
  if (idx >= 0 && idx < ZOOM_STEPS.length) {
    zoomLevel = ZOOM_STEPS[idx];
    applyZoom();
  }
}

/* ===== SCROLL TO PLAYHEAD (Locate) ===== */
function scrollToPlayhead() {
  var container = document.getElementById('timeline-container');
  var playhead = document.getElementById('playhead');
  if (!container || !playhead) return;
  var phLeft = parseInt(playhead.style.left) || 100;
  var scale = zoomLevel / 100;
  var viewCenter = container.clientWidth / 2;
  container.scrollLeft = (phLeft * scale) - viewCenter;
  sfx('click');
  toast('Locate: playhead');
}

/* ===== CONTEXT MENU ===== */
var ctxClip = null, ctxExercise = null;
function showClipContextMenu(x, y, clip, exercise) {
  ctxClip = clip;
  ctxExercise = exercise;
  var menu = document.getElementById('clip-context-menu');
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.classList.add('open');
  // Adjust if overflows viewport
  var rect = menu.getBoundingClientRect();
  if (rect.right > window.innerWidth) menu.style.left = (x - rect.width) + 'px';
  if (rect.bottom > window.innerHeight) menu.style.top = (y - rect.height) + 'px';
}

function hideContextMenu() {
  document.getElementById('clip-context-menu').classList.remove('open');
  ctxClip = null;
  ctxExercise = null;
}

document.addEventListener('DOMContentLoaded', function() {
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.clip-context-menu')) hideContextMenu();
  });
  document.getElementById('clip-context-menu').addEventListener('click', function(e) {
    var item = e.target.closest('.ctx-item');
    if (!item || !ctxClip) return;
    var action = item.dataset.action;
    if (action === 'duplicate') {
      selectClipEl(ctxClip);
      duplicateClip();
    } else if (action === 'inspect') {
      selectClipEl(ctxClip);
    } else if (action === 'split') {
      selectClipEl(ctxClip);
      splitClipAtPlayhead();
    } else if (action === 'snap-start') {
      pushUndo();
      ctxClip.style.left = '0px';
      saveSession(); updateStats();
      toast('Snapped to start');
    } else if (action === 'snap-next') {
      pushUndo();
      var track = ctxClip.parentElement;
      var clips = track.querySelectorAll('.clip');
      var maxRight = 0;
      clips.forEach(function(c) {
        if (c === ctxClip) return;
        var r = parseInt(c.style.left) + parseInt(c.style.width);
        if (r > maxRight) maxRight = r;
      });
      ctxClip.style.left = (maxRight + 2) + 'px';
      saveSession(); updateStats();
      toast('Snapped after previous');
    } else if (action === 'rpe-up' || action === 'rpe-down') {
      var rpe = parseInt(ctxClip.dataset.rpe) || 7;
      rpe = action === 'rpe-up' ? Math.min(10, rpe + 1) : Math.max(1, rpe - 1);
      ctxClip.dataset.rpe = rpe;
      if (typeof updateClipVisuals === 'function') updateClipVisuals(ctxClip, rpe);
      saveSession();
      toast('RPE: ' + rpe);
    } else if (action.indexOf('move-') === 0) {
      var targetTrackId = action.replace('move-', '');
      var targetTrack = document.querySelector('.track-content[data-track="'+targetTrackId+'"]');
      if (targetTrack && ctxClip.parentElement !== targetTrack) {
        pushUndo();
        targetTrack.appendChild(ctxClip);
        updateStats(); saveSession();
        sfx('drop');
        toast('Moved to ' + targetTrackId);
      }
    } else if (action === 'color') {
      var swatch = e.target.closest('.ctx-color-swatch');
      if (swatch) {
        var newColor = swatch.dataset.color;
        pushUndo();
        if (newColor) {
          ctxClip.dataset.customColor = newColor;
          ctxClip.style.background = 'linear-gradient(180deg, ' + newColor + '44 0%, ' + newColor + '22 100%)';
          ctxClip.style.borderTopColor = newColor;
        } else {
          delete ctxClip.dataset.customColor;
          var ex = getExercise(ctxClip.dataset.exerciseId);
          if (ex) {
            var fm = FAMILY_MAP[ex.family] || {};
            var baseColor = fm.color || '#3b82f6';
            ctxClip.style.background = 'linear-gradient(180deg, ' + baseColor + '44 0%, ' + baseColor + '22 100%)';
            ctxClip.style.borderTopColor = baseColor;
          }
        }
        saveSession();
        toast(newColor ? 'Color set' : 'Color reset');
      }
    } else if (action === 'stage-up' || action === 'stage-down') {
      var curEx = getExercise(ctxClip.dataset.exerciseId);
      if (curEx) {
        var targetStage = action === 'stage-up' ? curEx.stage + 1 : curEx.stage - 1;
        var sibling = EXERCISES.filter(function(e) { return e.pattern === curEx.pattern && e.stage === targetStage; })[0];
        if (sibling) {
          selectClipEl(ctxClip);
          swapClipExercise(sibling.id);
        } else {
          toast('No stage ' + targetStage + ' for this pattern');
        }
      }
    } else if (action === 'group') {
      groupSelectedClips();
    } else if (action === 'ungroup') {
      ungroupSelectedClips();
    } else if (action === 'reset-fades') {
      ctxClip.dataset.fadeIn = '0';
      ctxClip.dataset.fadeOut = '0';
      var fadeInEl = ctxClip.querySelector('.clip-fade-in');
      var fadeOutEl = ctxClip.querySelector('.clip-fade-out');
      if (fadeInEl) { fadeInEl.style.width = '0px'; fadeInEl.classList.remove('has-fade'); }
      if (fadeOutEl) { fadeOutEl.style.width = '0px'; fadeOutEl.classList.remove('has-fade'); }
      updateFadeOverlay(ctxClip);
      saveSession();
      toast('Fades reset');
    } else if (action === 'toggle-lock') {
      ctxClip.classList.toggle('clip-locked');
      ctxClip.dataset.locked = ctxClip.classList.contains('clip-locked') ? '1' : '';
      saveSession();
      toast(ctxClip.classList.contains('clip-locked') ? 'Clip locked' : 'Clip unlocked');
    } else if (action === 'delete') {
      pushUndo();
      ctxClip.remove();
      if (selectedClip === ctxClip) { selectedClip = null; document.getElementById('inspector').style.display = 'none'; }
      updateStats(); saveSession();
      sfx('delete');
      toast('Clip deleted');
    }
    hideContextMenu();
  });
});

/* ===== CLICK-TO-SEEK + DRAG-TO-SCRUB ON RULER ===== */
document.addEventListener('DOMContentLoaded', function() {
  var ruler = document.getElementById('timeline-ruler');
  ruler.style.cursor = 'pointer';
  var _rulerScrubbing = false;
  function rulerSeek(e) {
    var rect = ruler.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = (80 / 15) * (zoomLevel / 100);
    var ho = 100 * (zoomLevel / 100);
    currentTime = Math.max(0, (x - ho) / pps);
    if (snapEnabled) {
      var beatSec = 60 / bpm;
      currentTime = Math.round(currentTime / beatSec) * beatSec;
    }
    updateTimeDisplay();
    updatePlayheadPosition();
  }
  ruler.addEventListener('mousedown', function(e) {
    if (e.altKey) return; /* Alt+click handled by loop drag */
    if (e.button !== 0) return;
    e.preventDefault();
    _rulerScrubbing = true;
    rulerSeek(e);
    sfx('click');
    function onMove(e) { if (_rulerScrubbing) rulerSeek(e); }
    function onUp() {
      _rulerScrubbing = false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Double-click ruler to add marker at that position */
  ruler.addEventListener('dblclick', function(e) {
    if (e.altKey) return;
    var rect = ruler.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = (80 / 15) * (zoomLevel / 100);
    var ho = 100 * (zoomLevel / 100);
    var timeSec = Math.max(0, (x - ho) / pps);
    addMarkerAt(timeSec);
  });
  /* Click track header to highlight active track, double-click to collapse */
  document.querySelectorAll('.track-header').forEach(function(header) {
    header.addEventListener('click', function() {
      document.querySelectorAll('.track.track-active').forEach(function(t) { t.classList.remove('track-active'); });
      header.closest('.track').classList.add('track-active');
    });
    header.addEventListener('dblclick', function() {
      header.closest('.track').classList.toggle('track-collapsed');
    });
    header.addEventListener('contextmenu', function(e) {
      showTrackCtx(e, header.closest('.track'));
    });
  });
  /* Timecode scrub — drag on time display to scrub */
  var timeDisp = document.getElementById('time-display');
  timeDisp.style.cursor = 'ew-resize';
  timeDisp.addEventListener('mousedown', function(e) {
    e.preventDefault();
    var startX = e.clientX;
    var startTime = currentTime;
    function onMove(e) {
      var delta = (e.clientX - startX) * 0.5; // 0.5s per pixel
      currentTime = Math.max(0, startTime + delta);
      updateTimeDisplay();
      updatePlayheadPosition();
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Click on empty timeline area to seek */
  var tracks = document.getElementById('timeline-tracks');
  tracks.addEventListener('click', function(e) {
    if (e.target.closest('.clip') || e.target.closest('.track-header')) return;
    var rect = tracks.getBoundingClientRect();
    var x = e.clientX - rect.left + document.getElementById('timeline-container').scrollLeft;
    var pps = 80 / 15;
    var scale = zoomLevel / 100;
    currentTime = Math.max(0, (x / scale - 100) / pps);
    updateTimeDisplay();
    updatePlayheadPosition();
  });
  /* Rubber band selection on timeline */
  tracks.addEventListener('mousedown', function(e) {
    if (e.target.closest('.clip') || e.target.closest('.track-header') || e.button !== 0) return;
    var container = document.getElementById('timeline-container');
    var rect = tracks.getBoundingClientRect();
    var startX = e.clientX - rect.left + container.scrollLeft;
    var startY = e.clientY - rect.top + container.scrollTop;
    var box = document.createElement('div');
    box.className = 'select-box';
    tracks.appendChild(box);
    function onMove(e) {
      var curX = e.clientX - rect.left + container.scrollLeft;
      var curY = e.clientY - rect.top + container.scrollTop;
      var x1 = Math.min(startX, curX), x2 = Math.max(startX, curX);
      var y1 = Math.min(startY, curY), y2 = Math.max(startY, curY);
      box.style.left = x1 + 'px';
      box.style.top = y1 + 'px';
      box.style.width = (x2 - x1) + 'px';
      box.style.height = (y2 - y1) + 'px';
      // Highlight clips inside selection box
      document.querySelectorAll('.clip').forEach(function(c) {
        var cl = parseInt(c.style.left) || 0;
        var cw = parseInt(c.style.width) || 0;
        var ct = c.closest('.track');
        var tOff = ct ? ct.offsetTop : 0;
        var ch = ct ? ct.offsetHeight : 60;
        var inX = cl + cw > x1 && cl < x2;
        var inY = tOff + ch > y1 && tOff < y2;
        if (inX && inY) {
          c.classList.add('selected');
        } else if (!e.shiftKey) {
          c.classList.remove('selected');
        }
      });
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      box.remove();
      var sel = document.querySelectorAll('.clip.selected');
      if (sel.length > 0) {
        selectedClip = sel[sel.length - 1];
        toast(sel.length + ' clip' + (sel.length > 1 ? 's' : '') + ' selected');
      }
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
  /* Init loop region drag interaction */
  initLoopDrag();
  initRulerLoopDrag();
});

/* ===== MOUSE WHEEL ZOOM on Timeline ===== */
document.addEventListener('DOMContentLoaded', function() {
  var container = document.getElementById('timeline-container');
  container.addEventListener('wheel', function(e) {
    if (e.metaKey || e.ctrlKey) {
      e.preventDefault();
      var rect = container.getBoundingClientRect();
      var mouseX = e.clientX - rect.left;
      var scrollBefore = container.scrollLeft;
      var oldZoom = zoomLevel;
      if (e.deltaY < 0) { zoomIn(); } else { zoomOut(); }
      if (zoomLevel !== oldZoom) {
        var ratio = zoomLevel / oldZoom;
        container.scrollLeft = (scrollBefore + mouseX) * ratio - mouseX;
      }
    }
  }, { passive: false });
});

/* ===== TRACK RESIZE HANDLES ===== */
document.addEventListener('DOMContentLoaded', function() {
  var allTracks = document.querySelectorAll('.track');
  allTracks.forEach(function(track, i) {
    if (i === allTracks.length - 1) return; // no handle on last track
    var handle = document.createElement('div');
    handle.className = 'track-resize-handle';
    track.parentElement.insertBefore(handle, track.nextSibling);
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      var startY = e.clientY;
      var startH = track.offsetHeight;
      function onMove(e) {
        var newH = Math.max(24, Math.min(200, startH + (e.clientY - startY)));
        track.style.height = newH + 'px';
      }
      function onUp() {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
});

/* ===== PLAYHEAD ANIMATION ===== */
function updatePlayheadClass() {
  var ph = document.getElementById('playhead');
  if (isPlaying) { ph.classList.add('playing'); } else { ph.classList.remove('playing'); }
}

var focusMode = false;
function toggleFocusMode() {
  focusMode = !focusMode;
  var main = document.querySelector('.main');
  var indicator = document.getElementById('focus-indicator');
  if (focusMode) {
    main.classList.add('focus-mode');
    indicator.classList.add('visible');
    toast('Focus mode — press F to exit');
  } else {
    main.classList.remove('focus-mode');
    indicator.classList.remove('visible');
    toast('Focus mode off');
  }
  sfx('click');
}

function updateStatusDot() {
  var dot = document.querySelector('.status-dot');
  if (!dot) return;
  dot.classList.remove('playing', 'recording');
  if (isRecording) { dot.classList.add('recording'); }
  else if (isPlaying) { dot.classList.add('playing'); }
  // Sync BPM pulse timing
  var d = (60 / bpm).toFixed(3);
  dot.style.setProperty('--bpm-duration', d + 's');
}

/* ===== MARKERS ===== */
function addMarker() {
  addMarkerAt(currentTime);
}

function addMarkerAt(timeSec) {
  markerCounter++;
  var marker = {id: markerCounter, time: timeSec, label: 'M' + markerCounter};
  markers.push(marker);
  renderMarker(marker);
  saveSession();
  sfx('click');
  toast('Marker ' + markerCounter + ' at ' + formatTime(timeSec));
}

function renderMarker(marker) {
  var pps = 80 / 15;
  var pos = 100 + marker.time * pps;
  var el = document.createElement('div');
  el.className = 'marker';
  el.dataset.markerId = marker.id;
  el.style.left = pos + 'px';
  el.innerHTML = '<div class="marker-flag">' + marker.label + '</div><div class="marker-line"></div>';
  el.addEventListener('click', function(e) {
    e.stopPropagation();
    currentTime = marker.time;
    updateTimeDisplay();
    updatePlayheadPosition();
    sfx('click');
  });
  el.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    el.remove();
    markers = markers.filter(function(m) { return m.id !== marker.id; });
    sfx('delete');
    toast('Marker removed');
  });
  document.getElementById('timeline-tracks').appendChild(el);
}

function renderAllMarkers() {
  document.querySelectorAll('.marker').forEach(function(m) { m.remove(); });
  markers.forEach(function(m) { renderMarker(m); });
}
function clearAllMarkers() {
  if (markers.length === 0) { toast('No markers to clear'); return; }
  pushUndo();
  markers = [];
  markerCounter = 0;
  document.querySelectorAll('.marker').forEach(function(m) { m.remove(); });
  saveSession();
  toast('All markers cleared');
}

/* ===== FOOTER MODE TOGGLE ===== */
var footerMode = 'bars'; // 'bars' or 'time'
function toggleFooterMode() {
  footerMode = footerMode === 'bars' ? 'time' : 'bars';
  updateTimeDisplay();
  toast('Position: ' + (footerMode === 'bars' ? 'Bars.Beats.Ticks' : 'Time'));
}

/* ===== COMMAND PALETTE ===== */
var CMD_ACTIONS = [
  {label:'Play / Pause', key:'Space', icon:'\u25B6', action: function() { togglePlay(); }},
  {label:'Stop', key:'Esc', icon:'\u25A0', action: function() { stopPlayback(); }},
  {label:'Toggle Snap', key:'S', icon:'\u2593', action: function() { toggleSnap(); }},
  {label:'Toggle Loop', key:'L', icon:'\u21BB', action: function() { toggleLoop(); }},
  {label:'Toggle Metronome', key:'', icon:'\u266A', action: function() { toggleMetronome(); }},
  {label:'Add Marker', key:'M', icon:'\u2691', action: function() { addMarker(); }},
  {label:'Clear All Markers', key:'', icon:'\u2691', action: function() { clearAllMarkers(); }},
  {label:'Split Clip', key:'B', icon:'\u2702', action: function() { splitClipAtPlayhead(); }},
  {label:'Copy Clips', key:'Cmd+C', icon:'\u2398', action: function() { copyClips(); }},
  {label:'Paste Clips', key:'Cmd+V', icon:'\u2398', action: function() { pasteClips(); }},
  {label:'Duplicate Clip', key:'Cmd+D', icon:'\u2398', action: function() { duplicateClip(); }},
  {label:'Duplicate Track', key:'Cmd+Shift+D', icon:'\u2398', action: function() { duplicateTrackClips(); }},
  {label:'Zoom to Fit', key:'', icon:'\u2922', action: function() { zoomToFit(); }},
  {label:'Zoom In', key:'Cmd++', icon:'+', action: function() { zoomIn(); }},
  {label:'Zoom Out', key:'Cmd+-', icon:'-', action: function() { zoomOut(); }},
  {label:'Zoom Reset (100%)', key:'Cmd+0', icon:'1:1', action: function() { zoomLevel = 100; applyZoom(); toast('Zoom reset: 100%'); }},
  {label:'Toggle Focus Mode', key:'F', icon:'\u2B1C', action: function() { toggleFocusMode(); }},
  {label:'Tap Tempo', key:'T', icon:'\u266A', action: function() { tapTempo(); }},
  {label:'Select All Clips', key:'Cmd+A', icon:'\u2610', action: function() { document.querySelectorAll('.clip').forEach(function(c){c.classList.add('selected')}); toast('All selected'); }},
  {label:'Quantize All Clips', key:'Q', icon:'\u2593', action: function() { quantizeClips(); }},
  {label:'Auto-Arrange Clips', key:'', icon:'\u21F6', action: function() { autoArrange(); }},
  {label:'Humanize Clips', key:'', icon:'\u223F', action: function() { humanizeClips(); }},
  {label:'Spread Clips Evenly', key:'', icon:'\u21F6', action: function() { spreadClipsEvenly(); }},
  {label:'Select Track Clips', key:'Cmd+Shift+A', icon:'\u2610', action: function() { var at=document.querySelector('.track.track-active .track-content'); if(at){document.querySelectorAll('.clip.selected').forEach(function(c){c.classList.remove('selected')});at.querySelectorAll('.clip').forEach(function(c){c.classList.add('selected')});if(typeof updateSelectionBadge==='function')updateSelectionBadge();toast('Track clips selected');} }},
  {label:'Invert Selection', key:'Cmd+I', icon:'\u21C4', action: function() { document.querySelectorAll('.clip').forEach(function(c){c.classList.toggle('selected')}); if(typeof updateSelectionBadge==='function')updateSelectionBadge(); toast('Selection inverted'); }},
  {label:'Clear All Clips', key:'', icon:'\u2716', action: function() { clearAllClips(); }},
  {label:'Save Session', key:'Cmd+S', icon:'\u2913', action: function() { saveSession(); sfx('click'); toast('Session saved'); }},
  {label:'Save as Named Workout', key:'', icon:'\u2913', action: function() { saveNamedWorkout(); }},
  {label:'Load Workout', key:'', icon:'\u2912', action: function() { showSavedWorkouts(); }},
  {label:'Export JSON', key:'', icon:'\u21A6', action: function() { exportWorkout(); }},
  {label:'Import Workout', key:'', icon:'\u21A4', action: function() { importWorkout(); }},
  {label:'Export CSV', key:'', icon:'\u21A6', action: function() { exportCSV(); }},
  {label:'Print Sheet', key:'', icon:'\u2399', action: function() { printWorkout(); }},
  {label:'Workout Summary', key:'', icon:'\u2261', action: function() { showSummary(); }},
  {label:'Generate Random', key:'G', icon:'\u2684', action: function() { generateRandom(); }},
  {label:'Rename Workout', key:'', icon:'\u270E', action: function() { renameWorkout(); }},
  {label:'Toggle Presets', key:'P', icon:'\u2630', action: function() { togglePresets(); }},
  {label:'Keyboard Shortcuts', key:'?', icon:'\u2328', action: function() { toggleShortcuts(); }},
  {label:'Reset Session', key:'', icon:'\u21BA', action: function() { resetSession(); }},
  {label:'Scroll to Playhead', key:'', icon:'\u25B8', action: function() { scrollToPlayhead(); }},
  {label:'Toggle Auto-Scroll', key:'', icon:'\u21C5', action: function() { toggleAutoScrollFromTransport(); }},
  {label:'Deselect All', key:'Esc', icon:'\u2610', action: function() { document.querySelectorAll('.clip.selected').forEach(function(c){c.classList.remove('selected')}); selectedClip=null; document.getElementById('inspector').style.display='none'; if(typeof updateSelectionBadge==='function')updateSelectionBadge(); toast('Deselected'); }},
  {label:'Toggle Record Mode', key:'R', icon:'\u23FA', action: function() { toggleRec(); }},
  {label:'Cycle Time Signature', key:'', icon:'4/4', action: function() { cycleTimeSig(); }},
  {label:'Collapse All Tracks', key:'Shift+C', icon:'\u25BC', action: function() { document.querySelectorAll('.track').forEach(function(t){if(t.dataset.track!=='music')t.classList.add('track-collapsed')}); toast('Tracks collapsed'); }},
  {label:'Expand All Tracks', key:'', icon:'\u25B2', action: function() { document.querySelectorAll('.track').forEach(function(t){t.classList.remove('track-collapsed')}); toast('Tracks expanded'); }},
  {label:'Move Clip Up', key:'\u2191', icon:'\u2191', action: function() { if(!selectedClip)return; var tids=['push','pull','core','legs','skills']; var ci=tids.indexOf(selectedClip.parentElement.dataset.track); if(ci>0){pushUndo();var nt=document.querySelector('.track-content[data-track="'+tids[ci-1]+'"]');selectedClip.parentElement.removeChild(selectedClip);nt.appendChild(selectedClip);saveSession();updateStats();toast('Moved up');} }},
  {label:'Move Clip Down', key:'\u2193', icon:'\u2193', action: function() { if(!selectedClip)return; var tids=['push','pull','core','legs','skills']; var ci=tids.indexOf(selectedClip.parentElement.dataset.track); if(ci>=0&&ci<tids.length-1){pushUndo();var nt=document.querySelector('.track-content[data-track="'+tids[ci+1]+'"]');selectedClip.parentElement.removeChild(selectedClip);nt.appendChild(selectedClip);saveSession();updateStats();toast('Moved down');} }},
  {label:'Delete Selected Clips', key:'Del', icon:'\u2716', action: function() { deleteSelectedClips(); }},
  {label:'Group Selected Clips', key:'Cmd+G', icon:'\u2B1C', action: function() { groupSelectedClips(); }},
  {label:'Ungroup Selected Clips', key:'Cmd+Shift+G', icon:'\u2B1C', action: function() { ungroupSelectedClips(); }},
  {label:'Share Workout (URL)', key:'', icon:'\u21A6', action: function() { shareWorkout(); }},
  {label:'Copy Workout as Text', key:'', icon:'\u2398', action: function() { copyWorkoutText(); }},
  {label:'Cycle Playback Speed', key:'', icon:'\u25B6', action: function() { cyclePlaybackSpeed(); }},
  {label:'Playback 0.5x', key:'', icon:'\u25B6', action: function() { playbackSpeed=0.5; document.getElementById('speed-btn').textContent='0.5x'; toast('Speed: 0.5x'); }},
  {label:'Playback 1x (Normal)', key:'', icon:'\u25B6', action: function() { playbackSpeed=1; document.getElementById('speed-btn').textContent='1x'; toast('Speed: 1x'); }},
  {label:'Playback 2x', key:'', icon:'\u25B6', action: function() { playbackSpeed=2; document.getElementById('speed-btn').textContent='2x'; toast('Speed: 2x'); }},
  {label:'Reverse Track Order', key:'', icon:'\u21C4', action: function() { reverseTrackClips(); }},
  {label:'Lock / Unlock Clip', key:'Cmd+L', icon:'\u2693', action: function() { if(!selectedClip)return; selectedClip.classList.toggle('clip-locked'); selectedClip.dataset.locked=selectedClip.classList.contains('clip-locked')?'1':''; saveSession(); toast(selectedClip.classList.contains('clip-locked')?'Locked':'Unlocked'); }},
  {label:'Reset All Faders', key:'', icon:'\u21BA', action: function() { FADERS.forEach(function(f){resetFader(f.id);}); toast('All faders reset'); }},
  {label:'Reset All Knobs', key:'', icon:'\u21BA', action: function() { KNOBS.forEach(function(k){resetKnob(k.id);}); toast('All knobs reset'); }},
  {label:'Next Marker', key:'N', icon:'\u25B8', action: function() { var e={code:'KeyN',shiftKey:false,metaKey:false,ctrlKey:false,preventDefault:function(){}}; if(markers.length===0){toast('No markers');return;} var sorted=markers.slice().sort(function(a,b){return a.time-b.time;}); var next=null; for(var i=0;i<sorted.length;i++){if(sorted[i].time>currentTime+0.1){next=sorted[i];break;}} if(next){currentTime=next.time;updateTimeDisplay();updatePlayheadPosition();toast('Marker: '+next.label);}else{toast('No next marker');} }},
  {label:'Previous Marker', key:'Shift+N', icon:'\u25C2', action: function() { if(markers.length===0){toast('No markers');return;} var sorted=markers.slice().sort(function(a,b){return a.time-b.time;}); var prev=null; for(var i=sorted.length-1;i>=0;i--){if(sorted[i].time<currentTime-0.1){prev=sorted[i];break;}} if(prev){currentTime=prev.time;updateTimeDisplay();updatePlayheadPosition();toast('Marker: '+prev.label);}else{toast('No previous marker');} }},
  {label:'Jump to Start', key:'Home', icon:'\u25C0', action: function() { currentTime=0; updateTimeDisplay(); updatePlayheadPosition(); toast('Start'); }},
  {label:'Jump to End', key:'End', icon:'\u25B6', action: function() { var maxR=0; document.querySelectorAll('.clip').forEach(function(c){var r=(parseInt(c.style.left)+parseInt(c.style.width)-100)/(80/15); if(r>maxR)maxR=r;}); currentTime=Math.max(0,maxR); updateTimeDisplay(); updatePlayheadPosition(); toast('End'); }},
  {label:'Collapse Active Track', key:'C', icon:'\u25BC', action: function() { var t=document.querySelector('.track.track-active'); if(t){t.classList.toggle('track-collapsed');toast(t.classList.contains('track-collapsed')?'Collapsed':'Expanded');} }},
  {label:'Clear Track Clips', key:'', icon:'\u2716', action: function() { clearTrackClips(); }},
  {label:'Stage Up', key:'PgUp', icon:'\u25B2', action: function() { if(!selectedClip)return; var ex=getExercise(selectedClip.dataset.exerciseId); if(!ex)return; var sib=EXERCISES.filter(function(e){return e.pattern===ex.pattern&&e.stage===ex.stage+1;})[0]; if(sib){pushUndo();swapClipExercise(sib.id);toast('Stage '+(ex.stage+1)+': '+sib.name);}else{toast('Max stage');} }},
  {label:'Stage Down', key:'PgDn', icon:'\u25BC', action: function() { if(!selectedClip)return; var ex=getExercise(selectedClip.dataset.exerciseId); if(!ex)return; var sib=EXERCISES.filter(function(e){return e.pattern===ex.pattern&&e.stage===ex.stage-1;})[0]; if(sib){pushUndo();swapClipExercise(sib.id);toast('Stage '+(ex.stage-1)+': '+sib.name);}else{toast('Min stage');} }},
  {label:'Auto-Name Workout', key:'', icon:'\u270E', action: function() { autoNameWorkout(); }},
  {label:'Paste at Playhead', key:'Cmd+Shift+V', icon:'\u2398', action: function() { pasteAtPlayhead(); }},
  {label:'Select Push Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Push'); }},
  {label:'Select Pull Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Pull'); }},
  {label:'Select Core Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Core'); }},
  {label:'Select Legs Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Legs'); }},
  {label:'Select Skills Clips', key:'', icon:'\u25C9', action: function() { selectClipsByFamily('Skills'); }},
  {label:'Set BPM 60', key:'', icon:'\u266A', action: function() { bpm=60; document.getElementById('bpm-input').value=60; updateBPM(); toast('BPM: 60'); }},
  {label:'Set BPM 80', key:'', icon:'\u266A', action: function() { bpm=80; document.getElementById('bpm-input').value=80; updateBPM(); toast('BPM: 80'); }},
  {label:'Set BPM 100', key:'', icon:'\u266A', action: function() { bpm=100; document.getElementById('bpm-input').value=100; updateBPM(); toast('BPM: 100'); }},
  {label:'Set BPM 120', key:'', icon:'\u266A', action: function() { bpm=120; document.getElementById('bpm-input').value=120; updateBPM(); toast('BPM: 120'); }},
  {label:'Set BPM 140', key:'', icon:'\u266A', action: function() { bpm=140; document.getElementById('bpm-input').value=140; updateBPM(); toast('BPM: 140'); }},
  {label:'Set BPM 160', key:'', icon:'\u266A', action: function() { bpm=160; document.getElementById('bpm-input').value=160; updateBPM(); toast('BPM: 160'); }},
  {label:'Workout Stats', key:'', icon:'\u2139', action: function() { showWorkoutStats(); }},
  {label:'Toggle Grid Lines', key:'', icon:'\u2591', action: function() { toggleGridLines(); }},
  {label:'Clear Recent Exercises', key:'', icon:'\u2716', action: function() { recentExercises=[]; updateRecentSection(); toast('Recent exercises cleared'); }},
  {label:'Reset All Clip Colors', key:'', icon:'\u25A0', action: function() { pushUndo(); document.querySelectorAll('.clip').forEach(function(c){ if(c.dataset.customColor){ delete c.dataset.customColor; var ex=getExercise(c.dataset.exerciseId); var fc=(ex&&FAMILY_MAP[ex.family])?FAMILY_MAP[ex.family].color:'#666'; c.style.background='linear-gradient(180deg, '+fc+'22 0%, '+fc+'11 100%)'; c.style.borderTopColor=fc+'44'; }}); saveSession(); toast('Clip colors reset to family defaults'); }},
  {label:'Copy Clip Info', key:'', icon:'\u2398', action: function() { if(!selectedClip){toast('Select a clip');return;} var ex=getExercise(selectedClip.dataset.exerciseId); var txt=(ex?ex.name:'Clip')+' | '+selectedClip.dataset.sets+'x'+selectedClip.dataset.reps+' @ '+selectedClip.dataset.tempo+'s | Rest: '+selectedClip.dataset.rest+'s | RPE: '+selectedClip.dataset.rpe+(ex?' | '+ex.family+' S'+ex.stage:''); navigator.clipboard.writeText(txt).then(function(){toast('Clip info copied');}); }},
  {label:'Shift All RPE +1', key:'', icon:'\u25B2', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip').forEach(function(cl){ var r=parseInt(cl.dataset.rpe)||7; if(r<10){cl.dataset.rpe=r+1; var b=cl.querySelector('.clip-rpe-badge'); if(b)b.textContent=r+1; c++;} }); saveSession(); toast(c+' clips RPE +1'); }},
  {label:'Shift All RPE -1', key:'', icon:'\u25BC', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip').forEach(function(cl){ var r=parseInt(cl.dataset.rpe)||7; if(r>1){cl.dataset.rpe=r-1; var b=cl.querySelector('.clip-rpe-badge'); if(b)b.textContent=r-1; c++;} }); saveSession(); toast(c+' clips RPE -1'); }},
  {label:'Select Stage 1 Clips', key:'', icon:'S1', action: function() { selectClipsByStage(1); }},
  {label:'Select Stage 2 Clips', key:'', icon:'S2', action: function() { selectClipsByStage(2); }},
  {label:'Select Stage 3 Clips', key:'', icon:'S3', action: function() { selectClipsByStage(3); }},
  {label:'Set All to Stage 1', key:'', icon:'S1', action: function() { setAllStage(1); }},
  {label:'Set All to Stage 2', key:'', icon:'S2', action: function() { setAllStage(2); }},
  {label:'Set All to Stage 3', key:'', icon:'S3', action: function() { setAllStage(3); }},
  {label:'Set All Rest 30s', key:'', icon:'\u23F1', action: function() { setAllRest(30); }},
  {label:'Set All Rest 60s', key:'', icon:'\u23F1', action: function() { setAllRest(60); }},
  {label:'Set All Rest 90s', key:'', icon:'\u23F1', action: function() { setAllRest(90); }},
  {label:'Set All Rest 120s', key:'', icon:'\u23F1', action: function() { setAllRest(120); }},
  {label:'Set All Tempo 2s', key:'', icon:'\u23F1', action: function() { setAllTempo(2); }},
  {label:'Set All Tempo 3s', key:'', icon:'\u23F1', action: function() { setAllTempo(3); }},
  {label:'Set All Tempo 4s', key:'', icon:'\u23F1', action: function() { setAllTempo(4); }},
  {label:'Set All Tempo 5s', key:'', icon:'\u23F1', action: function() { setAllTempo(5); }},
  {label:'Complexity Score', key:'', icon:'\u2139', action: function() { showComplexityScore(); }},
  {label:'Edit Workout Notes', key:'', icon:'\u270E', action: function() { showInlinePrompt('Workout Notes', workoutNotes, function(v){ workoutNotes=v; saveSession(); toast('Notes saved'); }); }},
  {label:'Lock All Clips', key:'', icon:'\u2693', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip').forEach(function(cl){if(!cl.classList.contains('clip-locked')){cl.classList.add('clip-locked');cl.dataset.locked='1';c++;}}); saveSession(); toast(c+' clips locked'); }},
  {label:'Unlock All Clips', key:'', icon:'\u2693', action: function() { pushUndo(); var c=0; document.querySelectorAll('.clip.clip-locked').forEach(function(cl){cl.classList.remove('clip-locked');cl.dataset.locked='';c++;}); saveSession(); toast(c+' clips unlocked'); }},
  {label:'Duplicate to Next Bar', key:'', icon:'\u25B8', action: function() { duplicateToNextBar(); }},
  {label:'Fill Track with Exercise', key:'', icon:'\u2593', action: function() { fillTrackWithExercise(); }},
  {label:'Mirror Workout', key:'', icon:'\u21C4', action: function() { mirrorWorkout(); }},
  {label:'Swap Two Clips', key:'', icon:'\u21C4', action: function() { swapTwoClips(); }},
  {label:'Align Clips to Playhead', key:'', icon:'\u25B8', action: function() { alignClipsToPlayhead(); }},
  {label:'Trim Clip to Loop Region', key:'', icon:'\u2702', action: function() { trimClipToLoop(); }},
  {label:'Apply Inspector to Selected', key:'', icon:'\u2913', action: function() { applyInspectorToSelected(); }},
  {label:'Collect to Active Track', key:'', icon:'\u21B3', action: function() { collectToTrack(); }},
  {label:'Stagger Clips (2-beat offset)', key:'', icon:'\u21F6', action: function() { staggerClips(); }},
  {label:'Random Exercise Swap', key:'', icon:'\u2684', action: function() { randomSwapExercise(); }},
  {label:'Randomize All Exercises', key:'', icon:'\u2684', action: function() { randomizeAllExercises(); }},
  {label:'Consolidate Adjacent Clips', key:'', icon:'\u25A0', action: function() { consolidateClips(); }},
  {label:'Exercise Frequency', key:'', icon:'\u2139', action: function() { showExerciseFrequency(); }},
  {label:'Balance Report', key:'', icon:'\u2261', action: function() { showBalanceReport(); }},
  {label:'Scale Durations 0.5x (Half)', key:'', icon:'\u21F6', action: function() { scaleClipDurations(0.5); }},
  {label:'Scale Durations 2x (Double)', key:'', icon:'\u21F6', action: function() { scaleClipDurations(2); }},
  {label:'Quantize Selected Clips', key:'', icon:'\u2593', action: function() { quantizeSelected(); }},
  {label:'Export as Markdown', key:'', icon:'\u21A6', action: function() { exportMarkdown(); }},
  {label:'Compare with Saved Session', key:'', icon:'\u21C4', action: function() { compareWithSaved(); }},
  {label:'Select Clips in Loop Range', key:'', icon:'\u2610', action: function() { selectClipsInLoopRange(); }},
  {label:'Sort Track Alphabetically', key:'', icon:'\u2193', action: function() { sortTrackByName(); }},
  {label:'Compact Track (Remove Gaps)', key:'', icon:'\u25A0', action: function() { compactTrack(); }},
  {label:'Distribute Across Tracks', key:'', icon:'\u21F6', action: function() { distributeAcrossTracks(); }},
  {label:'Cycle Exercise in Pattern', key:'', icon:'\u21BB', action: function() { cycleExerciseInPattern(); }},
  {label:'Compact All Tracks', key:'', icon:'\u25A0', action: function() { compactAllTracks(); }},
  {label:'Select Overlapping Clips', key:'', icon:'\u25C9', action: function() { selectOverlappingClips(); }},
  {label:'Select Superset Clips', key:'', icon:'\u25C9', action: function() { selectSupersetClips(); }},
  {label:'Shift All Clips Right 1 Bar', key:'', icon:'\u25B6', action: function() { shiftAllClips(1); }},
  {label:'Shift All Clips Left 1 Bar', key:'', icon:'\u25C0', action: function() { shiftAllClips(-1); }},
  {label:'Insert Silence at Playhead', key:'', icon:'\u25B8', action: function() { insertSilenceAtPlayhead(); }},
  {label:'Remove Silence at Playhead', key:'', icon:'\u25C2', action: function() { removeSilenceAtPlayhead(); }},
  {label:'Clone Track to Push', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('push'); }},
  {label:'Clone Track to Pull', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('pull'); }},
  {label:'Clone Track to Core', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('core'); }},
  {label:'Clone Track to Legs', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('legs'); }},
  {label:'Clone Track to Skills', key:'', icon:'\u2398', action: function() { cloneTrackToTarget('skills'); }},
  {label:'Export Session Stats', key:'', icon:'\u2139', action: function() { exportSessionStats(); }},
  {label:'Toggle RPE Color Mode', key:'', icon:'\u25A0', action: function() { toggleRpeColorMode(); }},
  {label:'Select Next Clip', key:'J', icon:'\u25B6', action: function() { selectNextClip(); }},
  {label:'Select Previous Clip', key:'K', icon:'\u25C0', action: function() { selectPrevClip(); }},
  {label:'Select Duplicate Exercises', key:'', icon:'\u25C9', action: function() { selectDuplicateExercises(); }},
  {label:'Repeat Last Command', key:'', icon:'\u21BB', action: function() { repeatLastCommand(); }},
  {label:'Select First 30s', key:'', icon:'\u2610', action: function() { selectClipsInTimeRange(0, 30); }},
  {label:'Select First 60s', key:'', icon:'\u2610', action: function() { selectClipsInTimeRange(0, 60); }},
  {label:'Save as Template', key:'', icon:'\u2913', action: function() { saveWorkoutTemplate(); }},
  {label:'Load Template', key:'', icon:'\u2912', action: function() { loadWorkoutTemplate(); }},
  {label:'Half-Time BPM', key:'', icon:'\u00BD', action: function() { halfTimeBPM(); }},
  {label:'Double-Time BPM', key:'', icon:'\u00D7', action: function() { doubleTimeBPM(); }},
  {label:'Export HTML Report', key:'', icon:'\u2B1A', action: function() { exportHTMLReport(); }},
  {label:'Suggest Harder Exercise', key:'', icon:'\u2191', action: function() { suggestProgression('up'); }},
  {label:'Suggest Easier Exercise', key:'', icon:'\u2193', action: function() { suggestProgression('down'); }},
  {label:'Insert Rest Between Clips', key:'', icon:'\u23F8', action: function() { insertRestBetweenClips(); }},
  {label:'Workout Diff vs Saved', key:'', icon:'\u2260', action: function() { workoutDiff(); }},
  {label:'Generate Warmup', key:'', icon:'\u2600', action: function() { generateWarmup(); }},
  {label:'Generate Cooldown', key:'', icon:'\u2744', action: function() { generateCooldown(); }},
  {label:'Split Clip in 2', key:'', icon:'\u2702', action: function() { splitClipEqual(2); }},
  {label:'Split Clip in 3', key:'', icon:'\u2702', action: function() { splitClipEqual(3); }},
  {label:'Split Clip in 4', key:'', icon:'\u2702', action: function() { splitClipEqual(4); }},
  {label:'Start Workout Timer', key:'', icon:'\u23F1', action: function() { startWorkoutTimer(); }},
  {label:'Add Phase Markers', key:'', icon:'\u2691', action: function() { addPhaseMarkers(); }},
  {label:'Show RPE Curve', key:'', icon:'\u2197', action: function() { showRPECurve(); }},
  {label:'Name Superset Groups', key:'', icon:'\u2387', action: function() { nameSupersetGroups(); }},
  {label:'Density Heatmap', key:'', icon:'\u2593', action: function() { showDensityHeatmap(); }},
  {label:'Search & Replace Exercise', key:'', icon:'\u21C4', action: function() { searchReplaceExercise(); }},
  {label:'Progressive RPE (Ascending)', key:'', icon:'\u2197', action: function() { progressiveRPE('ascending'); }},
  {label:'Progressive RPE (Descending)', key:'', icon:'\u2198', action: function() { progressiveRPE('descending'); }},
  {label:'Arrange as Circuit', key:'', icon:'\u21C6', action: function() { arrangeAsCircuit(); }},
  {label:'Time Under Tension', key:'', icon:'\u23F1', action: function() { showTUT(); }},
  {label:'Rate Workout', key:'', icon:'\u2605', action: function() { rateWorkout(); }},
  {label:'Rating History', key:'', icon:'\u2606', action: function() { showRatingHistory(); }},
  {label:'Show Substitutions', key:'', icon:'\u21C4', action: function() { showSubstitutions(); }},
  {label:'Undo History', key:'', icon:'\u238C', action: function() { showUndoHistory(); }},
];

function openCmdPalette() {
  var pal = document.getElementById('cmd-palette');
  pal.classList.add('open');
  var input = document.getElementById('cmd-input');
  input.value = '';
  input.focus();
  renderCommands('');
}

function closeCmdPalette() {
  document.getElementById('cmd-palette').classList.remove('open');
}

function filterCommands() {
  renderCommands(document.getElementById('cmd-input').value.toLowerCase());
}

function renderCommands(q) {
  var results = document.getElementById('cmd-results');
  var filtered = CMD_ACTIONS.filter(function(a) {
    return !q || a.label.toLowerCase().indexOf(q) !== -1;
  });
  var html = '';
  filtered.forEach(function(a, i) {
    html += '<div class="cmd-result' + (i === 0 ? ' active' : '') + '" data-idx="' + CMD_ACTIONS.indexOf(a) + '">';
    html += '<span class="cmd-result-icon">' + a.icon + '</span>';
    html += '<span class="cmd-result-text">' + a.label + '</span>';
    if (a.key) html += '<span class="cmd-result-key">' + a.key + '</span>';
    html += '</div>';
  });
  var countEl = document.getElementById('cmd-count');
  if (countEl) countEl.textContent = filtered.length + ' / ' + CMD_ACTIONS.length + ' commands';
  results.innerHTML = html || '<div style="padding:12px 16px;font-size:10px;color:var(--micro)">No commands found</div>';
  // Click handlers
  results.querySelectorAll('.cmd-result').forEach(function(el) {
    el.addEventListener('click', function() {
      var idx = parseInt(el.dataset.idx);
      closeCmdPalette();
      _lastCommand = CMD_ACTIONS[idx].action;
      CMD_ACTIONS[idx].action();
    });
  });
}

// Cmd+K to open, Escape to close
document.getElementById('cmd-palette').addEventListener('click', function(e) {
  if (e.target === document.getElementById('cmd-palette')) closeCmdPalette();
});
document.getElementById('cmd-input').addEventListener('keydown', function(e) {
  if (e.code === 'Escape') { closeCmdPalette(); e.stopPropagation(); return; }
  if (e.code === 'Enter') {
    var active = document.querySelector('.cmd-result.active');
    if (active) {
      closeCmdPalette();
      var idx = parseInt(active.dataset.idx);
      _lastCommand = CMD_ACTIONS[idx].action;
      CMD_ACTIONS[idx].action();
    }
    return;
  }
  if (e.code === 'ArrowDown' || e.code === 'ArrowUp') {
    e.preventDefault();
    var items = Array.from(document.querySelectorAll('.cmd-result'));
    var cur = items.findIndex(function(el) { return el.classList.contains('active'); });
    items.forEach(function(el) { el.classList.remove('active'); });
    if (e.code === 'ArrowDown') cur = (cur + 1) % items.length;
    else cur = (cur - 1 + items.length) % items.length;
    if (items[cur]) { items[cur].classList.add('active'); items[cur].scrollIntoView({block:'nearest'}); }
  }
});

/* ===== INLINE PROMPT — Craft-style replacement for native prompt() ===== */
var inlinePromptCallback = null;
function showInlinePrompt(label, defaultVal, callback) {
  inlinePromptCallback = callback;
  var overlay = document.getElementById('inline-prompt');
  var lbl = document.getElementById('inline-prompt-label');
  var inp = document.getElementById('inline-prompt-input');
  lbl.textContent = label;
  inp.value = defaultVal || '';
  overlay.classList.add('open');
  setTimeout(function() { inp.focus(); inp.select(); }, 50);
}
function closeInlinePrompt(value) {
  document.getElementById('inline-prompt').classList.remove('open');
  if (inlinePromptCallback) {
    var cb = inlinePromptCallback;
    inlinePromptCallback = null;
    cb(value);
  }
}
function confirmInlinePrompt() {
  var val = document.getElementById('inline-prompt-input').value.trim();
  closeInlinePrompt(val || null);
}
// Enter confirms, Escape cancels
document.addEventListener('keydown', function(e) {
  var overlay = document.getElementById('inline-prompt');
  if (!overlay || !overlay.classList.contains('open')) return;
  if (e.key === 'Enter') { e.preventDefault(); confirmInlinePrompt(); }
  if (e.key === 'Escape') { e.preventDefault(); closeInlinePrompt(null); }
});

/* ===== WORKOUT NAME ===== */
var workoutName = 'Untitled';
var workoutNotes = '';
var _sessionCreatedAt = new Date().toISOString();
function setWorkoutName(name) {
  workoutName = name;
  document.getElementById('workout-name').textContent = name;
  var headerName = document.getElementById('header-workout-name');
  if (headerName) headerName.textContent = name;
  document.title = (name || 'Untitled') + ' - Saturno Movement Studio';
}
function renameWorkout() {
  showInlinePrompt('Workout name', workoutName, function(name) {
    if (name) {
      setWorkoutName(name);
      saveSession();
      toast('Renamed: ' + workoutName);
    }
  });
}

/* ===== CLIP SPLIT ===== */
function splitClipAtPlayhead() {
  if (!selectedClip) { toast('Select a clip to split'); return; }
  var pps = 80 / 15;
  var clipLeft = parseInt(selectedClip.style.left);
  var clipW = parseInt(selectedClip.style.width);
  var splitPos = 100 + currentTime * pps;
  // Check if playhead is within the clip
  if (splitPos <= clipLeft || splitPos >= clipLeft + clipW) {
    toast('Move playhead inside clip to split');
    return;
  }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var leftW = splitPos - clipLeft;
  var rightW = clipW - leftW;
  // Resize current clip to left portion
  selectedClip.style.width = leftW + 'px';
  var canvas = selectedClip.querySelector('.clip-waveform');
  var splitFm = FAMILY_MAP[ex.family] || {color:'#fff'};
  if (canvas) drawClipWaveform(canvas, splitFm.color, leftW + 'px', 0.5, parseInt(selectedClip.dataset.rpe) || 7);
  addBeatMarkers(selectedClip, leftW);
  // Create right portion
  var dna = {
    sets: selectedClip.dataset.sets,
    reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo,
    rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: '0',
    fadeOut: selectedClip.dataset.fadeOut || '0'
  };
  // Left clip keeps fadeIn, loses fadeOut
  selectedClip.dataset.fadeOut = '0';
  var foEl = selectedClip.querySelector('.clip-fade-out');
  if (foEl) { foEl.style.width = '0px'; foEl.classList.remove('has-fade'); }
  updateFadeOverlay(selectedClip);
  var rightClip = createClipElement(ex, splitPos, rightW, dna);
  if (selectedClip.dataset.notes) rightClip.dataset.notes = selectedClip.dataset.notes;
  if (selectedClip.dataset.customColor) {
    rightClip.dataset.customColor = selectedClip.dataset.customColor;
    rightClip.style.background = selectedClip.style.background;
    rightClip.style.borderTopColor = selectedClip.style.borderTopColor;
  }
  selectedClip.parentElement.appendChild(rightClip);
  updateStats(); saveSession();
  sfx('click');
  toast('Clip split at ' + formatTime(currentTime));
}

/* ===== DUPLICATE TRACK CLIPS ===== */
function duplicateTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = activeTrack.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in track'); return; }
  pushUndo();
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var offset = maxRight + 8;
  var count = 0;
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var newLeft = parseInt(c.style.left) + offset;
    var dna = {
      sets: c.dataset.sets, reps: c.dataset.reps,
      tempo: c.dataset.tempo, rest: c.dataset.rest, rpe: c.dataset.rpe,
      fadeIn: c.dataset.fadeIn || '0', fadeOut: c.dataset.fadeOut || '0'
    };
    var dup = createClipElement(ex, newLeft, parseInt(c.style.width), dna);
    if (c.dataset.notes) dup.dataset.notes = c.dataset.notes;
    if (c.dataset.customColor) {
      dup.dataset.customColor = c.dataset.customColor;
      dup.style.background = c.style.background;
      dup.style.borderTopColor = c.style.borderTopColor;
    }
    activeTrack.appendChild(dup);
    count++;
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(count + ' clips duplicated');
}

function reverseTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip')).filter(function(c) {
    return !c.classList.contains('clip-locked');
  });
  if (clips.length < 2) { toast('Need 2+ unlocked clips to reverse'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var positions = clips.map(function(c) { return parseInt(c.style.left); });
  var widths = clips.map(function(c) { return parseInt(c.style.width); });
  var reversed = clips.slice().reverse();
  var curLeft = positions[0];
  for (var ri = 0; ri < reversed.length; ri++) {
    reversed[ri].style.left = curLeft + 'px';
    if (ri < reversed.length - 1) {
      var origGap = positions[ri + 1] - (positions[ri] + widths[ri]);
      curLeft += parseInt(reversed[ri].style.width) + Math.max(0, origGap);
    }
  }
  updateStats(); saveSession();
  toast('Track clips reversed');
}

/* ===== CUSTOM CLIP TOOLTIP ===== */
var tipTimer = null;
document.addEventListener('mouseover', function(e) {
  var clipEl = e.target.closest('.clip');
  if (!clipEl) return;
  clearTimeout(tipTimer);
  tipTimer = setTimeout(function() {
    var ex = getExercise(clipEl.dataset.exerciseId);
    if (!ex) return;
    var tip = document.getElementById('clip-tip');
    document.getElementById('tip-name').textContent = ex.name;
    document.getElementById('tip-pattern').textContent = ex.pattern;
    document.getElementById('tip-stage').textContent = 'Stage ' + ex.stage;
    document.getElementById('tip-discipline').textContent = ex.discipline;
    var sets = parseInt(clipEl.dataset.sets) || 3;
    var reps = parseInt(clipEl.dataset.reps) || 8;
    var tempo = parseFloat(clipEl.dataset.tempo) || 3;
    var rest = parseInt(clipEl.dataset.rest) || 60;
    document.getElementById('tip-dna').textContent = sets + 'x' + reps + ' @ RPE ' + clipEl.dataset.rpe;
    var fm = FAMILY_MAP[ex.family] || {};
    document.getElementById('tip-instrument').textContent = fm.instrument || '';
    var totalSec = (sets * reps * tempo) + ((sets - 1) * rest);
    var tut = sets * reps * tempo;
    var m = Math.floor(totalSec / 60);
    var s = Math.floor(totalSec % 60);
    document.getElementById('tip-time').textContent = m + ':' + s.toString().padStart(2, '0') + ' total';
    document.getElementById('tip-tut').textContent = 'TUT ' + tut + 's';
    var rect = clipEl.getBoundingClientRect();
    tip.style.left = (rect.left + rect.width / 2) + 'px';
    tip.style.top = (rect.top - 40) + 'px';
    tip.style.transform = 'translateX(-50%)';
    tip.classList.add('show');
  }, 400);
});
document.addEventListener('mouseout', function(e) {
  if (e.target.closest('.clip')) {
    clearTimeout(tipTimer);
    document.getElementById('clip-tip').classList.remove('show');
  }
});

/* ===== TRACK HEADER CONTEXT MENU ===== */
var trackCtxTarget = null;
function showTrackCtx(e, trackEl) {
  e.preventDefault();
  trackCtxTarget = trackEl;
  var ctx = document.getElementById('track-ctx');
  ctx.style.left = e.clientX + 'px';
  ctx.style.top = e.clientY + 'px';
  ctx.classList.add('open');
}
function hideTrackCtx() {
  document.getElementById('track-ctx').classList.remove('open');
  trackCtxTarget = null;
}
document.addEventListener('click', function() { hideTrackCtx(); });
document.getElementById('track-ctx').addEventListener('click', function(e) {
  var item = e.target.closest('.track-ctx-item');
  if (!item || !trackCtxTarget) return;
  var action = item.dataset.action;
  var content = trackCtxTarget.querySelector('.track-content');
  if (action === 'solo') {
    var btn = trackCtxTarget.querySelector('.track-btn:nth-child(2)');
    if (btn) toggleSolo(btn);
  } else if (action === 'mute') {
    var btn = trackCtxTarget.querySelector('.track-btn:nth-child(1)');
    if (btn) toggleMute(btn);
  } else if (action === 'select-all') {
    if (content) content.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
    toast('Track clips selected');
  } else if (action === 'collapse') {
    trackCtxTarget.classList.toggle('track-collapsed');
  } else if (action === 'collapse-all') {
    var allCollapsed = true;
    document.querySelectorAll('.track').forEach(function(t) { if (!t.classList.contains('track-collapsed') && t.dataset.track !== 'music') allCollapsed = false; });
    document.querySelectorAll('.track').forEach(function(t) { if (t.dataset.track !== 'music') t.classList.toggle('track-collapsed', !allCollapsed); });
    toast(allCollapsed ? 'Tracks expanded' : 'Tracks collapsed');
  } else if (action === 'clear') {
    if (content) {
      var clips = content.querySelectorAll('.clip');
      if (clips.length === 0) { toast('Track is empty'); hideTrackCtx(); return; }
      pushUndo();
      clips.forEach(function(c) { c.remove(); });
      updateStats(); saveSession();
      sfx('delete');
      toast(clips.length + ' clips cleared');
    }
  }
  hideTrackCtx();
});

/* RPE visual updater — updates velocity strip when RPE changes via context menu */
function updateClipVisuals(clip, rpe) {
  var velocity = clip.querySelector('.clip-velocity');
  if (velocity) {
    var velColor = rpe >= 9 ? '#ef4444' : rpe >= 7 ? '#f97316' : rpe >= 5 ? '#eab308' : '#22c55e';
    var velAlpha = 0.3 + (rpe / 10) * 0.5;
    velocity.style.background = 'linear-gradient(90deg, ' + velColor + Math.round(velAlpha * 255).toString(16).padStart(2,'0') + ', transparent)';
  }
}

/* ===== RIGHT PANEL TABS ===== */
function switchPanelTab(tabId) {
  document.querySelectorAll('.panel-tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.panel-tab-content').forEach(function(c) { c.classList.remove('active'); });
  document.querySelector('.panel-tab[data-tab="'+tabId+'"]').classList.add('active');
  document.getElementById('tab-'+tabId).classList.add('active');
}

/* ===== EMPTY TIMELINE STATE ===== */
function updateEmptyState() {
  var clips = document.querySelectorAll('.clip');
  var el = document.getElementById('timeline-empty');
  if (!el) return;
  if (clips.length > 0) {
    el.classList.add('hidden');
  } else {
    el.classList.remove('hidden');
  }
}

/* ===== SETTINGS FUNCTIONS ===== */
var gridRes = 4;
var autoScrollEnabled = true;
var sfxEnabled = true;
var metroVolume = 0.5;

function setGridRes(val) {
  gridRes = parseInt(val);
  var snapBadge = document.getElementById('snap-badge');
  if (snapBadge && snapEnabled) snapBadge.textContent = 'SNAP ' + gridRes + 'B';
  toast('Grid: ' + gridRes + ' beat' + (gridRes > 1 ? 's' : '') + (snapEnabled ? ' (snap active)' : ''));
}

function toggleAutoScrollFromSettings() {
  autoScrollEnabled = !autoScrollEnabled;
  syncAutoScrollUI();
  toast('Auto-scroll ' + (autoScrollEnabled ? 'on' : 'off'));
}

function toggleSFXSetting() {
  sfxEnabled = !sfxEnabled;
  document.getElementById('settings-sfx').textContent = sfxEnabled ? 'ON' : 'OFF';
  toast('UI sounds ' + (sfxEnabled ? 'on' : 'off'));
}

/* ===== QUANTIZE — Snap All Clips to Grid ===== */
function quantizeClips() {
  var selected = document.querySelectorAll('.clip.selected');
  var clips = selected.length > 0 ? selected : document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to quantize'); return; }
  pushUndo();
  var snapPx = (typeof getSnapSize === 'function') ? getSnapSize() : (80 / 4);
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left) || 0;
    c.style.left = Math.round(left / snapPx) * snapPx + 'px';
    count++;
  });
  saveSession();
  sfx('snap');
  toast(count + ' clip' + (count !== 1 ? 's' : '') + ' quantized');
}

/* ===== CLIPBOARD — Copy/Paste Clips ===== */
var clipboardData = [];

function updateClipboardIndicator() {
  var el = document.getElementById('footer-clipboard');
  if (!el) return;
  el.textContent = clipboardData.length > 0 ? 'CLIP: ' + clipboardData.length : '';
}

function copyClips() {
  var selected = document.querySelectorAll('.clip.selected');
  if (selected.length === 0) { toast('No clips selected'); return; }
  clipboardData = [];
  selected.forEach(function(c) {
    clipboardData.push({
      exerciseId: c.dataset.exerciseId,
      left: parseInt(c.style.left),
      width: parseInt(c.style.width),
      track: c.parentElement.dataset.track,
      sets: c.dataset.sets,
      reps: c.dataset.reps,
      tempo: c.dataset.tempo,
      rest: c.dataset.rest,
      rpe: c.dataset.rpe,
      notes: c.dataset.notes || '',
      customColor: c.dataset.customColor || '',
      fadeIn: c.dataset.fadeIn || '0',
      fadeOut: c.dataset.fadeOut || '0'
    });
  });
  sfx('click');
  updateClipboardIndicator();
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' copied');
}

function pasteClips() {
  if (clipboardData.length === 0) { toast('Nothing to paste'); return; }
  pushUndo();
  var offset = 40; // paste slightly offset from original
  clipboardData.forEach(function(cd) {
    var track = document.querySelector('.track-content[data-track="'+cd.track+'"]');
    var ex = getExercise(cd.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, cd.left + offset, cd.width, {
      sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe,
      fadeIn: cd.fadeIn || '0', fadeOut: cd.fadeOut || '0'
    });
    if (cd.notes) clip.dataset.notes = cd.notes;
    if (cd.customColor) {
      clip.dataset.customColor = cd.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + cd.customColor + '44 0%, ' + cd.customColor + '22 100%)';
      clip.style.borderTopColor = cd.customColor;
    }
    track.appendChild(clip);
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' pasted');
}

function pasteAtPlayhead() {
  if (clipboardData.length === 0) { toast('Nothing to paste'); return; }
  pushUndo();
  var pps = 80 / 15;
  var targetLeft = 100 + currentTime * pps;
  var minLeft = Infinity;
  clipboardData.forEach(function(cd) { if (cd.left < minLeft) minLeft = cd.left; });
  var offsetAmt = targetLeft - minLeft;
  clipboardData.forEach(function(cd) {
    var track = document.querySelector('.track-content[data-track="'+cd.track+'"]');
    var ex = getExercise(cd.exerciseId);
    if (!track || !ex) return;
    var clip = createClipElement(ex, cd.left + offsetAmt, cd.width, {
      sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe,
      fadeIn: cd.fadeIn || '0', fadeOut: cd.fadeOut || '0'
    });
    if (cd.notes) clip.dataset.notes = cd.notes;
    if (cd.customColor) {
      clip.dataset.customColor = cd.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + cd.customColor + '44 0%, ' + cd.customColor + '22 100%)';
      clip.style.borderTopColor = cd.customColor;
    }
    track.appendChild(clip);
  });
  updateStats(); saveSession();
  sfx('drop');
  toast(clipboardData.length + ' clip' + (clipboardData.length > 1 ? 's' : '') + ' pasted at playhead');
}

/* ===== AUTO-ARRANGE — Lay Out Clips Sequentially ===== */
function autoArrange() {
  var tracks = document.querySelectorAll('.track-content');
  var totalMoved = 0;
  pushUndo();
  tracks.forEach(function(track) {
    if (track.dataset.track === 'music') return;
    var clips = Array.from(track.querySelectorAll('.clip'));
    if (clips.length === 0) return;
    clips.sort(function(a, b) { return (parseInt(a.style.left) || 0) - (parseInt(b.style.left) || 0); });
    var pos = 0;
    var gap = 2;
    clips.forEach(function(c) {
      if (c.classList.contains('clip-locked')) {
        pos = (parseInt(c.style.left) || 0) + (parseInt(c.style.width) || 80) + gap;
        return;
      }
      var old = parseInt(c.style.left) || 0;
      c.style.left = pos + 'px';
      if (old !== pos) totalMoved++;
      pos += (parseInt(c.style.width) || 80) + gap;
    });
  });
  saveSession(); updateStats();
  sfx('snap');
  toast(totalMoved + ' clips arranged');
}

function spreadClipsEvenly() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips to spread'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var totalClipWidth = 0;
  clips.forEach(function(c) { totalClipWidth += parseInt(c.style.width) || 80; });
  var maxRight = parseInt(clips[clips.length - 1].style.left) + (parseInt(clips[clips.length - 1].style.width) || 80);
  var availableSpace = maxRight - totalClipWidth;
  var gap = clips.length > 1 ? availableSpace / (clips.length - 1) : 0;
  var curLeft = parseInt(clips[0].style.left) || 0;
  clips.forEach(function(c, i) {
    if (!c.classList.contains('clip-locked')) {
      c.style.left = Math.round(curLeft) + 'px';
    }
    curLeft += (parseInt(c.style.width) || 80) + gap;
  });
  updateStats(); saveSession();
  toast('Clips spread evenly');
}

function humanizeClips() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to humanize'); return; }
  pushUndo();
  var pps = 80 / 15;
  var maxJitter = pps * 0.3; // +/- 0.3 seconds
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var cur = parseInt(c.style.left) || 0;
    var offset = (Math.random() - 0.5) * 2 * maxJitter;
    c.style.left = Math.max(0, Math.round(cur + offset)) + 'px';
    count++;
  });
  saveSession(); updateStats();
  toast(count + ' clips humanized');
}

function clearAllClips() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to clear'); return; }
  pushUndo();
  clips.forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession(); updateEmptyState();
  sfx('delete');
  toast(clips.length + ' clips cleared');
}

function clearTrackClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('Select a track first'); return; }
  var clips = activeTrack.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in track'); return; }
  pushUndo();
  var count = clips.length;
  clips.forEach(function(c) {
    if (c === selectedClip) {
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
    }
    c.remove();
  });
  updateStats(); saveSession();
  sfx('delete');
  toast(count + ' track clips cleared');
}

function setAllRest(seconds) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    c.dataset.rest = seconds;
    count++;
  });
  if (selectedClip) {
    document.getElementById('insp-rest').value = seconds;
    updateInspectorTime();
  }
  saveSession(); updateStats();
  toast(count + ' clips rest set to ' + seconds + 's');
}

function showComplexityScore() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var patterns = {};
  var families = {};
  var stages = {};
  var disciplines = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      patterns[ex.pattern] = true;
      families[ex.family] = true;
      stages[ex.stage] = true;
      if (ex.discipline) disciplines[ex.discipline] = true;
    }
  });
  var pCount = Object.keys(patterns).length;
  var fCount = Object.keys(families).length;
  var sCount = Object.keys(stages).length;
  var dCount = Object.keys(disciplines).length;
  var score = Math.min(100, Math.round((pCount * 8 + fCount * 15 + sCount * 10 + dCount * 12)));
  toast('Complexity: ' + score + '/100 | ' + pCount + ' patterns, ' + fCount + ' families, ' + sCount + ' stages, ' + dCount + ' disciplines');
}

function setAllTempo(seconds) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    c.dataset.tempo = seconds;
    count++;
  });
  if (selectedClip) {
    document.getElementById('insp-tempo').value = seconds;
    updateInspectorTime();
  }
  saveSession(); updateStats();
  toast(count + ' clips tempo set to ' + seconds + 's');
}

function duplicateToNextBar() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  pushUndo();
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * (80 / 15));
  var newLeft = parseInt(selectedClip.style.left) + barPx;
  var clip = createClipElement(ex, newLeft, parseInt(selectedClip.style.width), {
    sets: selectedClip.dataset.sets, reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: selectedClip.dataset.fadeIn || '0', fadeOut: selectedClip.dataset.fadeOut || '0'
  });
  if (selectedClip.dataset.notes) clip.dataset.notes = selectedClip.dataset.notes;
  if (selectedClip.dataset.customColor) {
    clip.dataset.customColor = selectedClip.dataset.customColor;
    clip.style.background = 'linear-gradient(180deg, ' + selectedClip.dataset.customColor + '44 0%, ' + selectedClip.dataset.customColor + '22 100%)';
    clip.style.borderTopColor = selectedClip.dataset.customColor;
  }
  selectedClip.parentElement.appendChild(clip);
  updateStats(); saveSession(); sfx('drop');
  toast('Duplicated to next bar');
}

function fillTrackWithExercise() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  var track = selectedClip.parentElement;
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  pushUndo();
  var clipW = parseInt(selectedClip.style.width) || 80;
  var gap = 4;
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * (80 / 15));
  var startLeft = parseInt(selectedClip.style.left) + clipW + gap;
  var maxPx = 100 + Math.round(300 * (60 / bpm) * (80 / 15));
  var existing = Array.from(track.querySelectorAll('.clip'));
  var maxExisting = 0;
  existing.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxExisting) maxExisting = r;
  });
  if (maxExisting > maxPx) maxPx = maxExisting + barPx * 2;
  var filled = 0;
  var pos = startLeft;
  while (pos + clipW <= maxPx && filled < 32) {
    var overlaps = false;
    existing.forEach(function(c) {
      var cL = parseInt(c.style.left);
      var cR = cL + parseInt(c.style.width);
      if (pos + clipW > cL && pos < cR) overlaps = true;
    });
    if (!overlaps) {
      var clip = createClipElement(ex, pos, clipW, {
        sets: selectedClip.dataset.sets, reps: selectedClip.dataset.reps,
        tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
        rpe: selectedClip.dataset.rpe
      });
      track.appendChild(clip);
      existing.push(clip);
      filled++;
    }
    pos += clipW + gap;
  }
  updateStats(); saveSession(); sfx('drop');
  toast(filled + ' clips added to track');
}

function searchLibraryForInspected() {
  if (!selectedClip) return;
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var searchInput = document.getElementById('lib-search');
  if (searchInput) {
    searchInput.value = ex.name;
    filterLibrary();
    searchInput.focus();
    toast('Searching: ' + ex.name);
  }
}

function setAllStage(targetStage) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var swapped = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var curEx = getExercise(c.dataset.exerciseId);
    if (!curEx || curEx.stage === targetStage) return;
    var sibling = EXERCISES.filter(function(ex) { return ex.pattern === curEx.pattern && ex.stage === targetStage; })[0];
    if (sibling) {
      c.dataset.exerciseId = sibling.id;
      var nameEl = c.querySelector('.clip-name');
      if (nameEl) nameEl.textContent = sibling.name;
      var dotsEl = c.querySelector('.clip-stage-dots');
      if (dotsEl) {
        var dots = dotsEl.querySelectorAll('.clip-stage-dot');
        dots.forEach(function(d, i) {
          d.className = 'clip-stage-dot' + (i < targetStage ? ' filled' : '');
        });
      }
      swapped++;
    }
  });
  saveSession(); updateStats();
  toast(swapped + ' clips set to Stage ' + targetStage);
}

function mirrorWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to mirror'); return; }
  pushUndo();
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var ho = 100;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var origLeft = parseInt(c.style.left);
    var w = parseInt(c.style.width);
    var newLeft = ho + (maxRight - ho) - (origLeft - ho) - w;
    c.style.left = Math.max(ho, newLeft) + 'px';
  });
  updateStats(); saveSession();
  sfx('click');
  toast('Workout mirrored');
}

function swapTwoClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length !== 2) { toast('Select exactly 2 clips to swap'); return; }
  if (sel[0].classList.contains('clip-locked') || sel[1].classList.contains('clip-locked')) {
    toast('Cannot swap locked clips'); return;
  }
  pushUndo();
  var leftA = sel[0].style.left;
  var leftB = sel[1].style.left;
  sel[0].style.left = leftB;
  sel[1].style.left = leftA;
  updateStats(); saveSession(); sfx('click');
  toast('Clips swapped');
}

function alignClipsToPlayhead() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('Select clips first'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var targetPx = ho + Math.round(currentTime * pps);
  var count = 0;
  var sorted = Array.from(sel).sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var offset = targetPx;
  sorted.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var w = parseInt(c.style.width) || 80;
    c.style.left = offset + 'px';
    offset += w + 4;
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips aligned to playhead');
}

function trimClipToLoop() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (!loopEnabled) { toast('Enable loop region first'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var loopLeftPx = ho + Math.round(loopStart * pps);
  var loopRightPx = ho + Math.round(loopEnd * pps);
  var clipLeft = parseInt(selectedClip.style.left);
  var clipWidth = parseInt(selectedClip.style.width);
  var clipRight = clipLeft + clipWidth;
  var newLeft = Math.max(clipLeft, loopLeftPx);
  var newRight = Math.min(clipRight, loopRightPx);
  if (newRight <= newLeft) { toast('Clip outside loop region'); return; }
  selectedClip.style.left = newLeft + 'px';
  selectedClip.style.width = (newRight - newLeft) + 'px';
  updateStats(); saveSession(); sfx('click');
  toast('Clip trimmed to loop region');
}

function applyInspectorToSelected() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length < 2) { toast('Select 2+ clips to batch-set params'); return; }
  var sets = document.getElementById('insp-sets').value;
  var reps = document.getElementById('insp-reps').value;
  var tempo = document.getElementById('insp-tempo').value;
  var rest = document.getElementById('insp-rest').value;
  var rpe = document.getElementById('insp-rpe').value;
  pushUndo();
  var count = 0;
  sel.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    c.dataset.sets = sets;
    c.dataset.reps = reps;
    c.dataset.tempo = tempo;
    c.dataset.rest = rest;
    c.dataset.rpe = rpe;
    var rpeBadge = c.querySelector('.clip-rpe-badge');
    if (rpeBadge) rpeBadge.textContent = rpe;
    updateClipDNA(c);
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips updated with inspector values');
}

function staggerClips() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) { toast('Select 2+ clips to stagger'); return; }
  pushUndo();
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var staggerAmount = beatPx * 2;
  sel.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var baseLeft = parseInt(sel[0].style.left);
  var count = 0;
  sel.forEach(function(c, i) {
    if (c.classList.contains('clip-locked')) return;
    c.style.left = (baseLeft + i * staggerAmount) + 'px';
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips staggered by 2 beats');
}

function collectToTrack() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('Select clips first'); return; }
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  pushUndo();
  var count = 0;
  sel.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    if (c.parentElement !== activeTrack) {
      c.parentElement.removeChild(c);
      activeTrack.appendChild(c);
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips moved to active track');
}

function randomSwapExercise() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var sameFamily = EXERCISES.filter(function(e) { return e.family === ex.family && e.id !== ex.id; });
  if (sameFamily.length === 0) { toast('No other exercises in ' + ex.family); return; }
  pushUndo();
  var rand = sameFamily[Math.floor(Math.random() * sameFamily.length)];
  selectedClip.dataset.exerciseId = rand.id;
  var nameEl = selectedClip.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = rand.name;
  var dotsEl = selectedClip.querySelector('.clip-stage-dots');
  if (dotsEl) {
    var dots = dotsEl.querySelectorAll('.clip-stage-dot');
    dots.forEach(function(d, i) { d.className = 'clip-stage-dot' + (i < rand.stage ? ' filled' : ''); });
  }
  selectClipEl(selectedClip);
  saveSession(); sfx('click');
  toast('Swapped to: ' + rand.name + ' (S' + rand.stage + ')');
}

function randomizeAllExercises() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var swapped = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var sameFamily = EXERCISES.filter(function(e) { return e.family === ex.family && e.id !== ex.id; });
    if (sameFamily.length === 0) return;
    var rand = sameFamily[Math.floor(Math.random() * sameFamily.length)];
    c.dataset.exerciseId = rand.id;
    var nameEl = c.querySelector('.clip-name');
    if (nameEl) nameEl.textContent = rand.name;
    var dotsEl = c.querySelector('.clip-stage-dots');
    if (dotsEl) {
      var dots = dotsEl.querySelectorAll('.clip-stage-dot');
      dots.forEach(function(d, i) { d.className = 'clip-stage-dot' + (i < rand.stage ? ' filled' : ''); });
    }
    swapped++;
  });
  saveSession(); updateStats(); sfx('click');
  toast(swapped + ' exercises randomized within families');
}

function quickAddExercise(exerciseId) {
  var ex = getExercise(exerciseId);
  if (!ex) return;
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) {
    var fam = ex.family.toLowerCase();
    activeTrack = document.querySelector('.track-content[data-track="' + fam + '"]');
  }
  if (!activeTrack) activeTrack = document.querySelector('.track-content[data-track="push"]');
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var left = ho + Math.round(currentTime * pps);
  var clip = createClipElement(ex, left, 80);
  activeTrack.appendChild(clip);
  addToRecent(ex.id);
  updateStats(); saveSession(); sfx('drop');
  toast('Added: ' + ex.name);
}

function consolidateClips() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips to consolidate'); return; }
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  pushUndo();
  var merged = 0;
  var i = 0;
  while (i < clips.length - 1) {
    if (clips[i].classList.contains('clip-locked') || clips[i + 1].classList.contains('clip-locked')) { i++; continue; }
    var aR = parseInt(clips[i].style.left) + parseInt(clips[i].style.width);
    var bL = parseInt(clips[i + 1].style.left);
    if (Math.abs(aR - bL) <= 8) {
      var newWidth = parseInt(clips[i].style.width) + parseInt(clips[i + 1].style.width) + (bL - aR);
      clips[i].style.width = newWidth + 'px';
      var totalSets = (parseInt(clips[i].dataset.sets) || 3) + (parseInt(clips[i + 1].dataset.sets) || 3);
      clips[i].dataset.sets = totalSets;
      updateClipInfo(clips[i]);
      clips[i + 1].remove();
      clips.splice(i + 1, 1);
      merged++;
    } else {
      i++;
    }
  }
  updateStats(); saveSession(); sfx('click');
  toast(merged + ' clip' + (merged !== 1 ? 's' : '') + ' consolidated');
}

function showExerciseFrequency() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var freq = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) freq[ex.name] = (freq[ex.name] || 0) + 1;
  });
  var sorted = Object.keys(freq).sort(function(a, b) { return freq[b] - freq[a]; });
  var top5 = sorted.slice(0, 5).map(function(name) { return name + ' (' + freq[name] + ')'; });
  toast('Top exercises: ' + top5.join(', ') + (sorted.length > 5 ? ' +' + (sorted.length - 5) + ' more' : ''));
}

function showBalanceReport() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var famSets = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      var sets = parseInt(c.dataset.sets) || 3;
      famSets[ex.family] = (famSets[ex.family] || 0) + sets;
    }
  });
  var total = 0;
  Object.keys(famSets).forEach(function(f) { total += famSets[f]; });
  var report = Object.keys(famSets).sort(function(a, b) { return famSets[b] - famSets[a]; }).map(function(f) {
    var pct = Math.round(famSets[f] / total * 100);
    return f + ': ' + pct + '%';
  });
  var pushPull = (famSets['Push'] || 0) + '/' + (famSets['Pull'] || 0);
  toast('Balance: ' + report.join(' | ') + ' (Push/Pull: ' + pushPull + ')');
}

function scaleClipDurations(factor) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var count = 0;
  var ho = 100;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    var w = parseInt(c.style.width);
    var relLeft = left - ho;
    c.style.left = Math.round(ho + relLeft * factor) + 'px';
    c.style.width = Math.max(20, Math.round(w * factor)) + 'px';
    updateClipInfo(c);
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips scaled ' + factor + 'x');
}

function quantizeSelected() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0) { toast('Select clips to quantize'); return; }
  pushUndo();
  var snapSz = (typeof getSnapSize === 'function') ? getSnapSize() : 20;
  if (snapSz < 4) snapSz = 4;
  var count = 0;
  sel.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    var ho = 100;
    var rel = left - ho;
    var snapped = Math.round(rel / snapSz) * snapSz;
    c.style.left = (ho + snapped) + 'px';
    count++;
  });
  updateStats(); saveSession(); sfx('snap');
  toast(count + ' clips quantized to grid');
}

function exportMarkdown() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var name = document.getElementById('workout-name').textContent || 'Untitled';
  var md = '# ' + name + '\n\n';
  md += '**BPM:** ' + bpm + ' | **Mode:** ' + (document.getElementById('bpm-mode').textContent || '') + '\n\n';
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var trackLabels = {push:'Push', pull:'Pull', core:'Core', legs:'Legs', skills:'Skills'};
  trackOrder.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    if (trackClips.length === 0) return;
    trackClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    md += '## ' + trackLabels[tid] + '\n\n';
    md += '| # | Exercise | Sets | Reps | Tempo | Rest | RPE |\n';
    md += '|---|----------|------|------|-------|------|-----|\n';
    trackClips.forEach(function(c, i) {
      var ex = getExercise(c.dataset.exerciseId);
      md += '| ' + (i + 1) + ' | ' + (ex ? ex.name : '?') + ' | ' + (c.dataset.sets || 3) + ' | ' + (c.dataset.reps || 8) + ' | ' + (c.dataset.tempo || 3) + 's | ' + (c.dataset.rest || 60) + 's | ' + (c.dataset.rpe || 7) + ' |\n';
    });
    md += '\n';
  });
  if (workoutNotes) md += '## Notes\n\n' + workoutNotes + '\n';
  md += '\n---\n*Generated by Saturno Movement Studio*\n';
  navigator.clipboard.writeText(md).then(function() { toast('Markdown copied to clipboard'); });
}

function compareWithSaved() {
  var saved = null;
  try { saved = JSON.parse(localStorage.getItem('sms-session')); } catch(e) {}
  if (!saved || !saved.tracks) { toast('No saved session to compare'); return; }
  var savedClipCount = 0;
  var savedFamilies = {};
  saved.tracks.forEach(function(t) {
    if (t.clips) {
      savedClipCount += t.clips.length;
      t.clips.forEach(function(c) {
        if (c.family) savedFamilies[c.family] = (savedFamilies[c.family] || 0) + 1;
      });
    }
  });
  var curClips = document.querySelectorAll('.clip').length;
  var curFamilies = {};
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) curFamilies[ex.family] = (curFamilies[ex.family] || 0) + 1;
  });
  var diff = curClips - savedClipCount;
  var diffStr = diff > 0 ? '+' + diff : diff === 0 ? '0' : '' + diff;
  toast('Saved: ' + savedClipCount + ' clips | Current: ' + curClips + ' clips (' + diffStr + ')');
}

function selectClipsInLoopRange() {
  if (!loopEnabled) { toast('Enable loop region first'); return; }
  var pps = 80 / 15;
  var ho = 100;
  var loopLeftPx = ho + Math.round(loopStart * pps);
  var loopRightPx = ho + Math.round(loopEnd * pps);
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var cL = parseInt(c.style.left);
    var cR = cL + parseInt(c.style.width);
    if (cR > loopLeftPx && cL < loopRightPx) {
      c.classList.add('selected');
      count++;
    }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clips in loop range selected');
}

function sortTrackByName() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips to sort'); return; }
  pushUndo();
  clips.sort(function(a, b) {
    var exA = getExercise(a.dataset.exerciseId);
    var exB = getExercise(b.dataset.exerciseId);
    var nameA = exA ? exA.name : '';
    var nameB = exB ? exB.name : '';
    return nameA.localeCompare(nameB);
  });
  var ho = 100;
  var gap = 4;
  var pos = ho;
  clips.forEach(function(c) {
    if (!c.classList.contains('clip-locked')) {
      c.style.left = pos + 'px';
    }
    pos = parseInt(c.style.left) + parseInt(c.style.width) + gap;
  });
  updateStats(); saveSession(); sfx('click');
  toast('Track sorted alphabetically');
}

function compactTrack() {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips on track'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var ho = 100;
  var gap = 4;
  var pos = ho;
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) {
      pos = parseInt(c.style.left) + parseInt(c.style.width) + gap;
      return;
    }
    if (parseInt(c.style.left) !== pos) count++;
    c.style.left = pos + 'px';
    pos += parseInt(c.style.width) + gap;
  });
  updateStats(); saveSession(); sfx('click');
  toast('Track compacted (' + count + ' clips moved)');
}

function distributeAcrossTracks() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) { toast('Select 2+ clips to distribute'); return; }
  var trackIds = ['push', 'pull', 'core', 'legs', 'skills'];
  pushUndo();
  var count = 0;
  sel.forEach(function(c, i) {
    if (c.classList.contains('clip-locked')) return;
    var targetTrack = document.querySelector('.track-content[data-track="' + trackIds[i % trackIds.length] + '"]');
    if (targetTrack && c.parentElement !== targetTrack) {
      c.parentElement.removeChild(c);
      targetTrack.appendChild(c);
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips distributed across tracks');
}

function cycleExerciseInPattern() {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var samePattern = EXERCISES.filter(function(e) { return e.pattern === ex.pattern; });
  samePattern.sort(function(a, b) { return a.stage - b.stage; });
  var curIdx = -1;
  for (var i = 0; i < samePattern.length; i++) {
    if (samePattern[i].id === ex.id) { curIdx = i; break; }
  }
  var nextIdx = (curIdx + 1) % samePattern.length;
  var next = samePattern[nextIdx];
  pushUndo();
  selectedClip.dataset.exerciseId = next.id;
  var nameEl = selectedClip.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = next.name;
  var dotsEl = selectedClip.querySelector('.clip-stage-dots');
  if (dotsEl) {
    var dots = dotsEl.querySelectorAll('.clip-stage-dot');
    dots.forEach(function(d, i) { d.className = 'clip-stage-dot' + (i < next.stage ? ' filled' : ''); });
  }
  selectClipEl(selectedClip);
  saveSession(); sfx('click');
  toast(next.name + ' (S' + next.stage + ')');
}

function compactAllTracks() {
  pushUndo();
  var total = 0;
  var trackIds = ['push', 'pull', 'core', 'legs', 'skills'];
  trackIds.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var clips = Array.from(tc.querySelectorAll('.clip'));
    if (clips.length === 0) return;
    clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    var ho = 100;
    var gap = 4;
    var pos = ho;
    clips.forEach(function(c) {
      if (c.classList.contains('clip-locked')) {
        pos = parseInt(c.style.left) + parseInt(c.style.width) + gap;
        return;
      }
      if (parseInt(c.style.left) !== pos) total++;
      c.style.left = pos + 'px';
      pos += parseInt(c.style.width) + gap;
    });
  });
  updateStats(); saveSession(); sfx('click');
  toast('All tracks compacted (' + total + ' clips moved)');
}

function selectOverlappingClips() {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip.clip-overlap').forEach(function(c) {
    c.classList.add('selected');
    count++;
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' overlapping clip' + (count !== 1 ? 's' : '') + ' selected');
}

function selectSupersetClips() {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip.clip-superset').forEach(function(c) {
    c.classList.add('selected');
    count++;
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' superset clip' + (count !== 1 ? 's' : '') + ' selected');
}

function shiftAllClips(direction) {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * (80 / 15));
  var ho = 100;
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    var newLeft = left + (direction * barPx);
    if (newLeft >= ho) {
      c.style.left = newLeft + 'px';
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips shifted ' + (direction > 0 ? 'right' : 'left') + ' 1 bar');
}

function insertSilenceAtPlayhead() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var playheadPx = ho + Math.round(currentTime * pps);
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * pps);
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    if (left >= playheadPx) {
      c.style.left = (left + barPx) + 'px';
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast('Inserted 1 bar silence (' + count + ' clips shifted)');
}

function removeSilenceAtPlayhead() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  pushUndo();
  var pps = 80 / 15;
  var ho = 100;
  var playheadPx = ho + Math.round(currentTime * pps);
  var bpb = (typeof getBeatsPerBar === 'function') ? getBeatsPerBar() : 4;
  var barPx = Math.round(bpb * (60 / bpm) * pps);
  var count = 0;
  clips.forEach(function(c) {
    if (c.classList.contains('clip-locked')) return;
    var left = parseInt(c.style.left);
    if (left >= playheadPx + barPx) {
      c.style.left = Math.max(ho, left - barPx) + 'px';
      count++;
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast('Removed 1 bar silence (' + count + ' clips shifted)');
}

function cloneTrackToTarget(targetId) {
  var activeTrack = document.querySelector('.track.track-active .track-content');
  if (!activeTrack) { toast('No active track'); return; }
  var target = document.querySelector('.track-content[data-track="' + targetId + '"]');
  if (!target) { toast('Target track not found'); return; }
  if (activeTrack === target) { toast('Cannot clone to same track'); return; }
  var clips = Array.from(activeTrack.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips to clone'); return; }
  pushUndo();
  var count = 0;
  clips.forEach(function(src) {
    var ex = getExercise(src.dataset.exerciseId);
    if (!ex) return;
    var clip = createClipElement(ex, parseInt(src.style.left), parseInt(src.style.width), {
      sets: src.dataset.sets, reps: src.dataset.reps,
      tempo: src.dataset.tempo, rest: src.dataset.rest,
      rpe: src.dataset.rpe,
      fadeIn: src.dataset.fadeIn || '0', fadeOut: src.dataset.fadeOut || '0'
    });
    if (src.dataset.notes) clip.dataset.notes = src.dataset.notes;
    if (src.dataset.customColor) {
      clip.dataset.customColor = src.dataset.customColor;
      clip.style.background = 'linear-gradient(180deg, ' + src.dataset.customColor + '44 0%, ' + src.dataset.customColor + '22 100%)';
      clip.style.borderTopColor = src.dataset.customColor;
    }
    target.appendChild(clip);
    count++;
  });
  updateStats(); saveSession(); sfx('drop');
  toast(count + ' clips cloned to ' + targetId);
}

function getSessionElapsed() {
  var elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
  var h = Math.floor(elapsed / 3600);
  var m = Math.floor((elapsed % 3600) / 60);
  if (h > 0) return h + 'h ' + m + 'm';
  return m + ' min';
}

function exportSessionStats() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var name = document.getElementById('workout-name').textContent || 'Untitled';
  var lines = [];
  lines.push('=== ' + name + ' ===');
  lines.push('BPM: ' + bpm + ' | Mode: ' + (document.getElementById('bpm-mode').textContent || ''));
  lines.push('Clips: ' + clips.length);
  var totalSets = 0, totalReps = 0, totalRpe = 0;
  var families = {}, exercises = {}, disciplines = {};
  clips.forEach(function(c) {
    totalSets += parseInt(c.dataset.sets) || 3;
    totalReps += (parseInt(c.dataset.sets) || 3) * (parseInt(c.dataset.reps) || 8);
    totalRpe += parseInt(c.dataset.rpe) || 7;
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      families[ex.family] = (families[ex.family] || 0) + 1;
      exercises[ex.name] = (exercises[ex.name] || 0) + 1;
      if (ex.discipline) disciplines[ex.discipline] = true;
    }
  });
  lines.push('Total Sets: ' + totalSets + ' | Total Reps: ' + totalReps);
  lines.push('Avg RPE: ' + (totalRpe / clips.length).toFixed(1));
  lines.push('Disciplines: ' + Object.keys(disciplines).join(', '));
  lines.push('Families: ' + Object.keys(families).map(function(f) { return f + ' (' + families[f] + ')'; }).join(', '));
  lines.push('Session: ' + getSessionElapsed());
  if (workoutNotes) lines.push('Notes: ' + workoutNotes);
  navigator.clipboard.writeText(lines.join('\n')).then(function() { toast('Session stats copied'); });
}

var rpeColorMode = false;
function toggleRpeColorMode() {
  rpeColorMode = !rpeColorMode;
  var rpeColors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
  document.querySelectorAll('.clip').forEach(function(c) {
    if (rpeColorMode) {
      var rpe = parseInt(c.dataset.rpe) || 7;
      var color = rpeColors[rpe - 1] || '#eab308';
      c.style.borderTopColor = color + '88';
      c.style.background = 'linear-gradient(180deg, ' + color + '22 0%, ' + color + '11 100%)';
    } else {
      if (c.dataset.customColor) {
        c.style.background = 'linear-gradient(180deg, ' + c.dataset.customColor + '44 0%, ' + c.dataset.customColor + '22 100%)';
        c.style.borderTopColor = c.dataset.customColor;
      } else {
        var ex = getExercise(c.dataset.exerciseId);
        var fc = (ex && FAMILY_MAP[ex.family]) ? FAMILY_MAP[ex.family].color : '#666';
        c.style.background = 'linear-gradient(180deg, ' + fc + '22 0%, ' + fc + '11 100%)';
        c.style.borderTopColor = fc + '44';
      }
    }
  });
  toast('RPE Color Mode: ' + (rpeColorMode ? 'ON' : 'OFF'));
}

var _lastCommand = null;
function repeatLastCommand() {
  if (!_lastCommand) { toast('No command to repeat'); return; }
  _lastCommand();
}

function selectNextClip() {
  var allClips = getSortedClips();
  if (allClips.length === 0) return;
  var curIdx = -1;
  if (selectedClip) {
    for (var i = 0; i < allClips.length; i++) {
      if (allClips[i] === selectedClip) { curIdx = i; break; }
    }
  }
  var nextIdx = (curIdx + 1) % allClips.length;
  selectClipEl(allClips[nextIdx]);
  sfx('click');
}

function selectPrevClip() {
  var allClips = getSortedClips();
  if (allClips.length === 0) return;
  var curIdx = 0;
  if (selectedClip) {
    for (var i = 0; i < allClips.length; i++) {
      if (allClips[i] === selectedClip) { curIdx = i; break; }
    }
  }
  var prevIdx = (curIdx - 1 + allClips.length) % allClips.length;
  selectClipEl(allClips[prevIdx]);
  sfx('click');
}

function getSortedClips() {
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var result = [];
  trackOrder.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var trackClips = Array.from(tc.querySelectorAll('.clip'));
    trackClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    result = result.concat(trackClips);
  });
  return result;
}

function selectDuplicateExercises() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.exerciseId === ex.id) {
      c.classList.add('selected');
      count++;
    }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clip' + (count !== 1 ? 's' : '') + ' with ' + ex.name + ' selected');
}

function selectClipsInTimeRange(startSec, endSec) {
  var pps = 80 / 15;
  var ho = 100;
  var startPx = ho + Math.round(startSec * pps);
  var endPx = ho + Math.round(endSec * pps);
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var cL = parseInt(c.style.left);
    var cR = cL + parseInt(c.style.width);
    if (cR > startPx && cL < endPx) {
      c.classList.add('selected');
      count++;
    }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' clips in ' + startSec + '-' + endSec + 's selected');
}

function saveWorkoutTemplate() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to save as template'); return; }
  var name = document.getElementById('workout-name').textContent || 'Untitled';
  showInlinePrompt('Template Name', name + ' Template', function(templateName) {
    if (!templateName) return;
    var template = {
      name: templateName,
      bpm: bpm,
      tracks: []
    };
    var trackIds = ['push', 'pull', 'core', 'legs', 'skills'];
    trackIds.forEach(function(tid) {
      var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
      if (!tc) return;
      var trackClips = [];
      tc.querySelectorAll('.clip').forEach(function(c) {
        trackClips.push({
          exerciseId: c.dataset.exerciseId,
          left: parseInt(c.style.left),
          width: parseInt(c.style.width),
          sets: c.dataset.sets, reps: c.dataset.reps,
          tempo: c.dataset.tempo, rest: c.dataset.rest,
          rpe: c.dataset.rpe
        });
      });
      if (trackClips.length > 0) template.tracks.push({id: tid, clips: trackClips});
    });
    var templates = [];
    try { templates = JSON.parse(localStorage.getItem('sms-templates') || '[]'); } catch(e) {}
    templates.unshift(template);
    if (templates.length > 10) templates.pop();
    try { localStorage.setItem('sms-templates', JSON.stringify(templates)); } catch(e) {}
    toast('Template saved: ' + templateName);
  });
}

function loadWorkoutTemplate() {
  var templates = [];
  try { templates = JSON.parse(localStorage.getItem('sms-templates') || '[]'); } catch(e) {}
  if (templates.length === 0) { toast('No templates saved'); return; }
  var items = templates.map(function(t, i) { return (i + 1) + '. ' + t.name + ' (' + t.bpm + ' BPM)'; });
  showInlinePrompt('Load Template (number)', items.join('\n'), function(val) {
    var idx = parseInt(val) - 1;
    if (isNaN(idx) || idx < 0 || idx >= templates.length) { toast('Invalid template number'); return; }
    var template = templates[idx];
    pushUndo();
    document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
    selectedClip = null;
    document.getElementById('inspector').style.display = 'none';
    bpm = template.bpm;
    document.getElementById('bpm-input').value = bpm;
    updateBPMMode();
    template.tracks.forEach(function(t) {
      var tc = document.querySelector('.track-content[data-track="' + t.id + '"]');
      if (!tc) return;
      t.clips.forEach(function(cd) {
        var ex = getExercise(cd.exerciseId);
        if (!ex) return;
        var clip = createClipElement(ex, cd.left, cd.width, {
          sets: cd.sets, reps: cd.reps, tempo: cd.tempo, rest: cd.rest, rpe: cd.rpe
        });
        tc.appendChild(clip);
      });
    });
    updateStats(); saveSession(); sfx('drop');
    toast('Loaded: ' + template.name);
  });
}

/* ===== BATCH 250: WORKOUT VERSION TRACKING ===== */
var _workoutVersion = 1;
function bumpVersion() {
  _workoutVersion++;
  updateVersionDisplay();
}
function updateVersionDisplay() {
  var el = document.getElementById('footer-version');
  if (el) el.textContent = 'v' + _workoutVersion;
}

/* ===== BATCH 251: HALF-TIME / DOUBLE-TIME BPM ===== */
function halfTimeBPM() {
  var newBpm = Math.max(30, Math.round(bpm / 2));
  bpm = newBpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  saveSession();
  sfx('click');
  toast('Half-time: ' + bpm + ' BPM');
}
function doubleTimeBPM() {
  var newBpm = Math.min(300, bpm * 2);
  bpm = newBpm;
  document.getElementById('bpm-input').value = bpm;
  updateBPMMode();
  saveSession();
  sfx('click');
  toast('Double-time: ' + bpm + ' BPM');
}

/* ===== BATCH 252: EXPORT AS HTML REPORT ===== */
function exportHTMLReport() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips to export'); return; }
  var name = workoutName || 'Untitled Workout';
  var modeName = document.getElementById('bpm-mode') ? document.getElementById('bpm-mode').textContent : '';
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var trackLabels = {push:'Push', pull:'Pull', core:'Core', legs:'Legs', skills:'Skills'};
  var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
  var totalSets = 0; var totalReps = 0; var exerciseSet = {};
  var trackData = {};
  trackOrder.forEach(function(tid) { trackData[tid] = []; });
  clips.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex || !trackData[tid]) return;
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    totalSets += sets; totalReps += sets * reps;
    exerciseSet[ex.id] = true;
    trackData[tid].push({
      name: ex.name, stage: ex.stage, discipline: ex.discipline,
      sets: sets, reps: reps, tempo: c.dataset.tempo || '3',
      rest: c.dataset.rest || '60', rpe: c.dataset.rpe || '7',
      notes: c.dataset.notes || ''
    });
  });
  var estTime = 0;
  clips.forEach(function(c) {
    var s = parseInt(c.dataset.sets) || 3;
    var r = parseInt(c.dataset.reps) || 8;
    var t = parseFloat(c.dataset.tempo) || 3;
    var rest = parseInt(c.dataset.rest) || 60;
    estTime += s * r * t + (s - 1) * rest;
  });
  var estMin = Math.round(estTime / 60);
  var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>' + name + ' - SMS Report</title>';
  html += '<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#050711;color:#e2e8f0;font-family:Sora,system-ui,sans-serif;padding:40px 20px;max-width:800px;margin:0 auto}';
  html += 'h1{font-size:24px;font-weight:700;margin-bottom:4px}h2{font-size:14px;font-weight:600;margin:24px 0 8px;text-transform:uppercase;letter-spacing:0.08em}';
  html += '.meta{font-size:11px;color:#64748b;margin-bottom:20px;display:flex;gap:16px;flex-wrap:wrap}.meta span{white-space:nowrap}';
  html += '.track-section{margin-bottom:20px}.track-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;padding:6px 0;border-bottom:1px solid #1e293b;margin-bottom:8px}';
  html += 'table{width:100%;border-collapse:collapse;font-size:11px;margin-bottom:8px}th{text-align:left;padding:4px 8px;color:#64748b;font-weight:500;border-bottom:1px solid #1e293b;font-size:10px}';
  html += 'td{padding:4px 8px;border-bottom:1px solid #0f172a}.notes-cell{font-size:9px;color:#94a3b8;font-style:italic}';
  html += '.rpe-badge{display:inline-block;width:18px;height:14px;border-radius:3px;text-align:center;font-size:9px;font-weight:600;line-height:14px}';
  html += '.footer-bar{margin-top:32px;padding-top:12px;border-top:1px solid #1e293b;font-size:9px;color:#475569;text-align:center}';
  html += '@media print{body{background:#fff;color:#1e293b}td,th{border-bottom-color:#e2e8f0}.track-label{border-bottom-color:#e2e8f0}.footer-bar{border-top-color:#e2e8f0}}</style></head><body>';
  html += '<h1>' + name + '</h1>';
  html += '<div class="meta"><span>' + bpm + ' BPM ' + modeName + '</span><span>' + clips.length + ' clips</span><span>' + Object.keys(exerciseSet).length + ' exercises</span>';
  html += '<span>' + totalSets + ' total sets</span><span>~' + estMin + ' min</span>';
  if (_sessionCreatedAt) html += '<span>Created: ' + new Date(_sessionCreatedAt).toLocaleDateString() + '</span>';
  html += '<span>Exported: ' + new Date().toLocaleDateString() + '</span></div>';
  if (workoutNotes) html += '<p style="font-size:11px;color:#94a3b8;margin-bottom:16px;padding:8px;background:#0f172a;border-radius:4px">' + workoutNotes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>';
  trackOrder.forEach(function(tid) {
    if (trackData[tid].length === 0) return;
    html += '<div class="track-section"><div class="track-label" style="color:' + familyColors[tid] + '">' + trackLabels[tid] + ' (' + trackData[tid].length + ')</div>';
    html += '<table><tr><th>#</th><th>Exercise</th><th>S</th><th>Sets</th><th>Reps</th><th>Tempo</th><th>Rest</th><th>RPE</th></tr>';
    trackData[tid].forEach(function(item, idx) {
      var rpeVal = parseInt(item.rpe) || 7;
      var rpeColors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
      var rpeColor = rpeColors[rpeVal - 1] || '#eab308';
      html += '<tr><td>' + (idx + 1) + '</td><td>' + item.name + '</td><td>S' + item.stage + '</td>';
      html += '<td>' + item.sets + '</td><td>' + item.reps + '</td><td>' + item.tempo + 's</td><td>' + item.rest + 's</td>';
      html += '<td><span class="rpe-badge" style="background:' + rpeColor + '22;color:' + rpeColor + '">' + rpeVal + '</span></td></tr>';
      if (item.notes) html += '<tr><td></td><td colspan="7" class="notes-cell">' + item.notes.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</td></tr>';
    });
    html += '</table></div>';
  });
  html += '<div class="footer-bar">Generated by Saturno Movement Studio | saturnomovement.com</div>';
  html += '</body></html>';
  var blob = new Blob([html], {type: 'text/html'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  var safeName = (workoutName || 'workout').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/,'');
  a.download = safeName + '-report.html';
  a.click();
  toast('HTML report exported');
}

/* ===== BATCH 253: SUGGEST PROGRESSION ===== */
function suggestProgression(direction) {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var targetStage = direction === 'up' ? ex.stage + 1 : ex.stage - 1;
  if (targetStage < 1 || targetStage > 3) { toast('No ' + (direction === 'up' ? 'harder' : 'easier') + ' progression'); return; }
  var candidates = EXERCISES.filter(function(e) { return e.pattern === ex.pattern && e.stage === targetStage; });
  if (candidates.length === 0) { toast('No stage ' + targetStage + ' for ' + ex.pattern); return; }
  pushUndo();
  var replacement = candidates[Math.floor(Math.random() * candidates.length)];
  selectedClip.dataset.exerciseId = replacement.id;
  var nameEl = selectedClip.querySelector('.clip-name');
  if (nameEl) nameEl.textContent = replacement.name;
  var dots = selectedClip.querySelector('.clip-stage-dots');
  if (dots) {
    dots.innerHTML = '';
    for (var d = 1; d <= 3; d++) {
      var dot = document.createElement('span');
      dot.style.cssText = 'width:3px;height:3px;border-radius:50%;background:' + (d <= replacement.stage ? 'var(--accent-cyan)' : 'rgba(255,255,255,0.15)');
      dots.appendChild(dot);
    }
  }
  selectClipEl(selectedClip);
  saveSession(); sfx('click');
  toast((direction === 'up' ? 'Harder' : 'Easier') + ': ' + replacement.name + ' (S' + replacement.stage + ')');
}

/* ===== BATCH 254: TRACK COLOR THEME ===== */
var trackColorOverrides = {};
function setTrackColor(trackId, color) {
  trackColorOverrides[trackId] = color;
  var tc = document.querySelector('.track-content[data-track="' + trackId + '"]');
  if (!tc) return;
  tc.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.customColor) return;
    c.style.borderTopColor = color;
    c.style.background = 'linear-gradient(180deg, ' + color + '22 0%, ' + color + '11 100%)';
  });
  saveSession();
  toast(trackId + ' track color set');
}
function resetTrackColor(trackId) {
  delete trackColorOverrides[trackId];
  var tc = document.querySelector('.track-content[data-track="' + trackId + '"]');
  if (!tc) return;
  tc.querySelectorAll('.clip').forEach(function(c) {
    if (c.dataset.customColor) return;
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
    var fc = familyColors[ex.family] || '#06b6d4';
    c.style.borderTopColor = fc;
    c.style.background = 'linear-gradient(180deg, ' + fc + '22 0%, ' + fc + '11 100%)';
  });
  saveSession();
  toast(trackId + ' track color reset');
}

/* ===== BATCH 255: INSERT REST BETWEEN CLIPS ===== */
function insertRestBetweenClips() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) { toast('Select 2+ clips to insert rest gaps'); return; }
  pushUndo();
  var byTrack = {};
  sel.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!byTrack[tid]) byTrack[tid] = [];
    byTrack[tid].push(c);
  });
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var restGap = beatPx * 4;
  var count = 0;
  Object.keys(byTrack).forEach(function(tid) {
    var trackClips = byTrack[tid];
    trackClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    for (var i = trackClips.length - 1; i > 0; i--) {
      if (trackClips[i].classList.contains('clip-locked')) continue;
      var prevRight = parseInt(trackClips[i - 1].style.left) + parseInt(trackClips[i - 1].style.width);
      var curLeft = parseInt(trackClips[i].style.left);
      var gap = curLeft - prevRight;
      if (gap < restGap) {
        var shift = restGap - gap;
        for (var j = i; j < trackClips.length; j++) {
          if (trackClips[j].classList.contains('clip-locked')) continue;
          trackClips[j].style.left = (parseInt(trackClips[j].style.left) + shift) + 'px';
          count++;
        }
      }
    }
  });
  updateStats(); saveSession(); sfx('click');
  toast('Rest gaps inserted (' + count + ' clips shifted)');
}

/* ===== BATCH 256: WORKOUT COMPARISON DIFF ===== */
function workoutDiff() {
  var saved = null;
  try { saved = JSON.parse(localStorage.getItem('sms_session')); } catch(e) {}
  if (!saved || !saved.clips) { toast('No saved state to compare'); return; }
  var currentClips = [];
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    currentClips.push({
      name: ex ? ex.name : '?',
      track: c.parentElement.dataset.track,
      sets: c.dataset.sets, reps: c.dataset.reps,
      rpe: c.dataset.rpe
    });
  });
  var savedExNames = {};
  saved.clips.forEach(function(c) {
    var ex = getExercise(c.exerciseId);
    var key = (ex ? ex.name : '?') + ':' + c.track;
    savedExNames[key] = (savedExNames[key] || 0) + 1;
  });
  var currentExNames = {};
  currentClips.forEach(function(c) {
    var key = c.name + ':' + c.track;
    currentExNames[key] = (currentExNames[key] || 0) + 1;
  });
  var added = [];
  var removed = [];
  Object.keys(currentExNames).forEach(function(k) {
    var diff = currentExNames[k] - (savedExNames[k] || 0);
    if (diff > 0) added.push(k.split(':')[0] + ' x' + diff);
  });
  Object.keys(savedExNames).forEach(function(k) {
    var diff = savedExNames[k] - (currentExNames[k] || 0);
    if (diff > 0) removed.push(k.split(':')[0] + ' x' + diff);
  });
  var msg = 'Diff vs saved:\n';
  if (added.length) msg += 'Added: ' + added.join(', ') + '\n';
  if (removed.length) msg += 'Removed: ' + removed.join(', ') + '\n';
  if (!added.length && !removed.length) msg += 'No differences';
  msg += '\nClips: ' + saved.clips.length + ' -> ' + currentClips.length;
  toast(msg);
}

/* ===== BATCH 257: AUTO-GENERATE WARMUP ===== */
function generateWarmup() {
  var mobilityExercises = EXERCISES.filter(function(e) { return e.discipline === 'Mobility'; });
  if (mobilityExercises.length === 0) { toast('No mobility exercises available'); return; }
  pushUndo();
  var ho = 100;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 4;
  var gap = 4;
  var shuffled = mobilityExercises.slice().sort(function() { return Math.random() - 0.5; });
  var warmupCount = Math.min(4, shuffled.length);
  var targetTrack = document.querySelector('.track-content[data-track="skills"]');
  if (!targetTrack) { toast('No skills track'); return; }
  var minLeft = Infinity;
  document.querySelectorAll('.clip').forEach(function(c) {
    var l = parseInt(c.style.left);
    if (l < minLeft) minLeft = l;
  });
  if (minLeft === Infinity) minLeft = ho + clipW * warmupCount + gap * warmupCount + beatPx * 2;
  var warmupStart = ho;
  if (minLeft > ho) {
    var neededSpace = warmupCount * (clipW + gap) + beatPx * 2;
    if (minLeft - ho < neededSpace) {
      var shift = neededSpace - (minLeft - ho);
      document.querySelectorAll('.clip').forEach(function(c) {
        if (c.classList.contains('clip-locked')) return;
        c.style.left = (parseInt(c.style.left) + shift) + 'px';
      });
    }
  }
  var xPos = warmupStart;
  for (var i = 0; i < warmupCount; i++) {
    var ex = shuffled[i];
    var clip = createClipElement(ex, xPos, clipW, {
      sets: '2', reps: '10', tempo: '3', rest: '30', rpe: '3'
    });
    targetTrack.appendChild(clip);
    xPos += clipW + gap;
  }
  updateStats(); saveSession(); sfx('drop');
  toast(warmupCount + ' warmup exercises added to Skills track');
}

/* ===== BATCH 258: AUTO-GENERATE COOLDOWN ===== */
function generateCooldown() {
  var mobilityExercises = EXERCISES.filter(function(e) { return e.discipline === 'Mobility'; });
  if (mobilityExercises.length === 0) { toast('No mobility exercises available'); return; }
  pushUndo();
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 6;
  var gap = 4;
  var shuffled = mobilityExercises.slice().sort(function() { return Math.random() - 0.5; });
  var cooldownCount = Math.min(4, shuffled.length);
  var targetTrack = document.querySelector('.track-content[data-track="skills"]');
  if (!targetTrack) { toast('No skills track'); return; }
  var maxRight = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var cooldownStart = maxRight + beatPx * 2;
  var xPos = cooldownStart;
  for (var i = 0; i < cooldownCount; i++) {
    var ex = shuffled[i];
    var clip = createClipElement(ex, xPos, clipW, {
      sets: '1', reps: '1', tempo: '30', rest: '10', rpe: '2'
    });
    targetTrack.appendChild(clip);
    xPos += clipW + gap;
  }
  updateStats(); saveSession(); sfx('drop');
  toast(cooldownCount + ' cooldown stretches added after workout');
}

/* ===== BATCH 259: SPLIT CLIP INTO N EQUAL PARTS ===== */
function splitClipEqual(n) {
  if (!selectedClip) { toast('Select a clip'); return; }
  if (selectedClip.classList.contains('clip-locked')) { toast('Clip is locked'); return; }
  if (n < 2 || n > 8) { toast('Split into 2-8 parts'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  pushUndo();
  var origLeft = parseInt(selectedClip.style.left);
  var origWidth = parseInt(selectedClip.style.width);
  var partWidth = Math.floor(origWidth / n);
  if (partWidth < 10) { toast('Clip too small to split ' + n + ' ways'); return; }
  var track = selectedClip.parentElement;
  var origSets = Math.max(1, Math.floor((parseInt(selectedClip.dataset.sets) || 3) / n));
  var props = {
    sets: String(origSets), reps: selectedClip.dataset.reps,
    tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
    rpe: selectedClip.dataset.rpe,
    fadeIn: '0', fadeOut: '0'
  };
  if (selectedClip.dataset.notes) props.notes = selectedClip.dataset.notes;
  selectedClip.remove();
  selectedClip = null;
  for (var i = 0; i < n; i++) {
    var clip = createClipElement(ex, origLeft + i * partWidth, partWidth, props);
    if (props.notes) clip.dataset.notes = props.notes;
    track.appendChild(clip);
  }
  document.getElementById('inspector').style.display = 'none';
  updateStats(); saveSession(); sfx('click');
  toast('Clip split into ' + n + ' equal parts');
}

/* ===== BATCH 260: WORKOUT TIMER COUNTDOWN ===== */
var _timerInterval = null;
var _timerOverlay = null;
function startWorkoutTimer() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips for timer'); return; }
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var exercises = [];
  trackOrder.forEach(function(tid) {
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (!tc) return;
    var tClips = Array.from(tc.querySelectorAll('.clip'));
    tClips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
    tClips.forEach(function(c) {
      var ex = getExercise(c.dataset.exerciseId);
      if (!ex) return;
      exercises.push({
        name: ex.name, sets: parseInt(c.dataset.sets) || 3,
        reps: parseInt(c.dataset.reps) || 8, tempo: parseFloat(c.dataset.tempo) || 3,
        rest: parseInt(c.dataset.rest) || 60
      });
    });
  });
  if (exercises.length === 0) { toast('No exercises found'); return; }
  var ov = document.createElement('div');
  ov.id = 'timer-overlay';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(5,7,17,0.97);z-index:10000;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Sora,system-ui,sans-serif;color:#e2e8f0';
  var html = '<div style="text-align:center;max-width:500px;padding:20px">';
  html += '<div style="font-size:10px;color:#64748b;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px">Workout Timer</div>';
  html += '<div id="timer-exercise" style="font-size:28px;font-weight:700;margin-bottom:4px">Ready</div>';
  html += '<div id="timer-detail" style="font-size:13px;color:#94a3b8;margin-bottom:24px"></div>';
  html += '<div id="timer-countdown" style="font-size:72px;font-weight:700;font-variant-numeric:tabular-nums;color:var(--accent-cyan,#22d3ee);margin-bottom:24px">0</div>';
  html += '<div id="timer-progress" style="font-size:11px;color:#64748b;margin-bottom:32px"></div>';
  html += '<button id="timer-close" style="padding:8px 24px;background:transparent;border:1px solid #334155;color:#94a3b8;border-radius:4px;cursor:pointer;font-family:Sora,system-ui,sans-serif;font-size:11px">ESC to close</button>';
  html += '</div>';
  ov.innerHTML = html;
  document.body.appendChild(ov);
  _timerOverlay = ov;
  ov.querySelector('#timer-close').addEventListener('click', stopWorkoutTimer);
  var exIdx = 0; var setIdx = 0; var phase = 'work'; var countdown = 0;
  function showState() {
    var exerciseEl = ov.querySelector('#timer-exercise');
    var detailEl = ov.querySelector('#timer-detail');
    var countEl = ov.querySelector('#timer-countdown');
    var progEl = ov.querySelector('#timer-progress');
    if (exIdx >= exercises.length) {
      exerciseEl.textContent = 'Workout Complete!';
      detailEl.textContent = '';
      countEl.textContent = '';
      countEl.style.color = '#22c55e';
      progEl.textContent = exercises.length + '/' + exercises.length + ' exercises done';
      clearInterval(_timerInterval); _timerInterval = null;
      return;
    }
    var cur = exercises[exIdx];
    exerciseEl.textContent = cur.name;
    if (phase === 'work') {
      detailEl.textContent = 'Set ' + (setIdx + 1) + '/' + cur.sets + ' | ' + cur.reps + ' reps @ ' + cur.tempo + 's';
      countEl.textContent = countdown;
      countEl.style.color = '#22d3ee';
    } else {
      detailEl.textContent = 'Rest';
      countEl.textContent = countdown;
      countEl.style.color = '#eab308';
    }
    progEl.textContent = (exIdx + 1) + '/' + exercises.length + ' exercises';
  }
  function nextPhase() {
    var cur = exercises[exIdx];
    if (phase === 'work') {
      countdown = Math.round(cur.reps * cur.tempo);
      phase = 'work';
      showState();
      _timerInterval = setInterval(function() {
        countdown--;
        showState();
        if (countdown <= 0) {
          clearInterval(_timerInterval);
          setIdx++;
          if (setIdx >= cur.sets) {
            exIdx++; setIdx = 0;
            if (exIdx >= exercises.length) { showState(); return; }
            phase = 'rest'; countdown = exercises[exIdx - 1].rest;
          } else {
            phase = 'rest'; countdown = cur.rest;
          }
          nextPhase();
        }
      }, 1000);
    } else {
      showState();
      _timerInterval = setInterval(function() {
        countdown--;
        showState();
        if (countdown <= 0) {
          clearInterval(_timerInterval);
          phase = 'work';
          nextPhase();
        }
      }, 1000);
    }
  }
  phase = 'work';
  countdown = Math.round(exercises[0].reps * exercises[0].tempo);
  nextPhase();
}
function stopWorkoutTimer() {
  if (_timerInterval) { clearInterval(_timerInterval); _timerInterval = null; }
  if (_timerOverlay) { _timerOverlay.remove(); _timerOverlay = null; }
}

/* ===== BATCH 261: TRACK VOLUME BARS ===== */
function updateTrackVolumeBars() {
  var trackOrder = ['push', 'pull', 'core', 'legs', 'skills'];
  var maxSets = 0;
  var trackSets = {};
  trackOrder.forEach(function(tid) {
    var total = 0;
    var tc = document.querySelector('.track-content[data-track="' + tid + '"]');
    if (tc) {
      tc.querySelectorAll('.clip').forEach(function(c) {
        total += parseInt(c.dataset.sets) || 3;
      });
    }
    trackSets[tid] = total;
    if (total > maxSets) maxSets = total;
  });
  trackOrder.forEach(function(tid) {
    var bar = document.getElementById('track-vol-' + tid);
    if (!bar) {
      var header = document.querySelector('.track[data-track="' + tid + '"] .track-header');
      if (!header) return;
      bar = document.createElement('div');
      bar.id = 'track-vol-' + tid;
      bar.style.cssText = 'position:absolute;bottom:2px;left:4px;right:4px;height:2px;border-radius:1px;background:rgba(255,255,255,0.05);overflow:hidden';
      var fill = document.createElement('div');
      fill.className = 'track-vol-fill';
      fill.style.cssText = 'height:100%;border-radius:1px;transition:width 0.3s';
      bar.appendChild(fill);
      header.style.position = 'relative';
      header.appendChild(bar);
    }
    var fill = bar.querySelector('.track-vol-fill');
    var pct = maxSets > 0 ? (trackSets[tid] / maxSets) * 100 : 0;
    var familyColors = {push:'#ef4444', pull:'#3b82f6', core:'#eab308', legs:'#22c55e', skills:'#a855f7'};
    fill.style.width = pct + '%';
    fill.style.background = familyColors[tid] || '#06b6d4';
  });
}

/* ===== BATCH 262: AUTO PHASE MARKERS ===== */
function addPhaseMarkers() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips for phase markers'); return; }
  var pps = 80 / 15;
  var ho = 100;
  var sortedByLeft = clips.slice().sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var firstTime = (parseInt(sortedByLeft[0].style.left) - ho) / pps;
  var lastRight = 0;
  sortedByLeft.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > lastRight) lastRight = r;
  });
  var endTime = (lastRight - ho) / pps;
  var totalDuration = endTime - firstTime;
  if (totalDuration < 60) { toast('Workout too short for phases'); return; }
  var warmupEnd = firstTime + totalDuration * 0.15;
  var cooldownStart = firstTime + totalDuration * 0.85;
  markers.push({id: ++markerCounter, time: firstTime, label: 'WARMUP'});
  markers.push({id: ++markerCounter, time: warmupEnd, label: 'MAIN'});
  markers.push({id: ++markerCounter, time: cooldownStart, label: 'COOLDOWN'});
  markers.push({id: ++markerCounter, time: endTime, label: 'END'});
  if (typeof renderAllMarkers === 'function') renderAllMarkers();
  saveSession(); sfx('click');
  toast('Phase markers added (Warmup / Main / Cooldown / End)');
}

/* ===== BATCH 263: RPE CURVE DISPLAY ===== */
function showRPECurve() {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length === 0) { toast('No clips'); return; }
  var sorted = clips.slice().sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var rpeValues = sorted.map(function(c) { return parseInt(c.dataset.rpe) || 7; });
  var names = sorted.map(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    return ex ? ex.name.substring(0, 12) : '?';
  });
  var maxRpe = 10;
  var barWidth = 24;
  var height = 100;
  var rpeColors = ['#22c55e','#22c55e','#84cc16','#a3e635','#eab308','#f59e0b','#f97316','#ef4444','#dc2626','#991b1b'];
  var svgWidth = Math.max(300, rpeValues.length * (barWidth + 4) + 40);
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + svgWidth + '" height="' + (height + 40) + '" style="background:#0f172a;border-radius:8px;padding:8px">';
  svg += '<text x="' + (svgWidth / 2) + '" y="14" text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Sora,sans-serif">RPE Curve</text>';
  rpeValues.forEach(function(rpe, i) {
    var x = 20 + i * (barWidth + 4);
    var barH = (rpe / maxRpe) * height * 0.8;
    var y = 24 + (height * 0.8 - barH);
    var color = rpeColors[rpe - 1] || '#eab308';
    svg += '<rect x="' + x + '" y="' + y + '" width="' + barWidth + '" height="' + barH + '" fill="' + color + '44" stroke="' + color + '" stroke-width="1" rx="2"/>';
    svg += '<text x="' + (x + barWidth / 2) + '" y="' + (y - 4) + '" text-anchor="middle" fill="' + color + '" font-size="9" font-family="Sora,sans-serif">' + rpe + '</text>';
    svg += '<text x="' + (x + barWidth / 2) + '" y="' + (24 + height * 0.8 + 12) + '" text-anchor="middle" fill="#475569" font-size="7" font-family="Sora,sans-serif" transform="rotate(-45,' + (x + barWidth / 2) + ',' + (24 + height * 0.8 + 12) + ')">' + names[i] + '</text>';
  });
  svg += '</svg>';
  var blob = new Blob([svg], {type: 'image/svg+xml'});
  var url = URL.createObjectURL(blob);
  window.open(url, '_blank');
  toast('RPE curve opened in new tab');
}

/* ===== BATCH 264: SUPERSET GROUP NAMING ===== */
function nameSupersetGroups() {
  var clips = document.querySelectorAll('.clip');
  var groups = {};
  clips.forEach(function(c) {
    var left = parseInt(c.style.left);
    var right = left + parseInt(c.style.width);
    var tid = c.parentElement.dataset.track;
    clips.forEach(function(c2) {
      if (c === c2) return;
      var tid2 = c2.parentElement.dataset.track;
      if (tid === tid2) return;
      var l2 = parseInt(c2.style.left);
      var r2 = l2 + parseInt(c2.style.width);
      if (left < r2 && right > l2) {
        var key = Math.min(left, l2) + '-' + Math.max(right, r2);
        if (!groups[key]) groups[key] = [];
        if (groups[key].indexOf(c) === -1) groups[key].push(c);
        if (groups[key].indexOf(c2) === -1) groups[key].push(c2);
      }
    });
  });
  var keys = Object.keys(groups);
  if (keys.length === 0) { toast('No supersets found'); return; }
  var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var count = 0;
  keys.forEach(function(k, idx) {
    var label = labels[idx % 26] + '1';
    groups[k].forEach(function(c) {
      c.dataset.supersetLabel = label;
      var badge = c.querySelector('.clip-ss-label');
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'clip-ss-label';
        badge.style.cssText = 'position:absolute;top:1px;right:14px;font-size:7px;font-weight:700;color:rgba(168,85,247,0.9);letter-spacing:0.04em;z-index:2';
        c.appendChild(badge);
      }
      badge.textContent = label;
    });
    count++;
  });
  saveSession(); sfx('click');
  toast(count + ' superset group' + (count !== 1 ? 's' : '') + ' labeled');
}

/* ===== BATCH 265: DENSITY HEATMAP ===== */
function showDensityHeatmap() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var ho = 100; var pps = 80 / 15;
  var maxRight = 0;
  clips.forEach(function(c) {
    var r = parseInt(c.style.left) + parseInt(c.style.width);
    if (r > maxRight) maxRight = r;
  });
  var totalSec = Math.ceil((maxRight - ho) / pps);
  var bucketSize = 15;
  var buckets = [];
  for (var b = 0; b < Math.ceil(totalSec / bucketSize); b++) buckets.push(0);
  clips.forEach(function(c) {
    var startSec = (parseInt(c.style.left) - ho) / pps;
    var endSec = startSec + parseInt(c.style.width) / pps;
    for (var b = 0; b < buckets.length; b++) {
      var bStart = b * bucketSize;
      var bEnd = (b + 1) * bucketSize;
      if (startSec < bEnd && endSec > bStart) buckets[b]++;
    }
  });
  var maxDensity = Math.max.apply(null, buckets) || 1;
  var barW = 20; var barH = 80;
  var svgW = buckets.length * (barW + 2) + 40;
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + svgW + '" height="' + (barH + 50) + '" style="background:#0f172a;border-radius:8px;padding:8px">';
  svg += '<text x="' + (svgW / 2) + '" y="14" text-anchor="middle" fill="#94a3b8" font-size="10" font-family="Sora,sans-serif">Timeline Density (' + bucketSize + 's buckets)</text>';
  buckets.forEach(function(count, i) {
    var x = 20 + i * (barW + 2);
    var h = (count / maxDensity) * barH * 0.8;
    var y = 24 + barH * 0.8 - h;
    var intensity = count / maxDensity;
    var r = Math.round(34 + intensity * 205);
    var g = Math.round(211 - intensity * 143);
    var b = Math.round(238 - intensity * 170);
    var color = 'rgb(' + r + ',' + g + ',' + b + ')';
    svg += '<rect x="' + x + '" y="' + y + '" width="' + barW + '" height="' + Math.max(2, h) + '" fill="' + color + '44" stroke="' + color + '" stroke-width="1" rx="2"/>';
    svg += '<text x="' + (x + barW / 2) + '" y="' + (y - 3) + '" text-anchor="middle" fill="' + color + '" font-size="8" font-family="Sora,sans-serif">' + count + '</text>';
    var label = Math.floor(i * bucketSize / 60) + ':' + (String(Math.floor(i * bucketSize % 60))).padStart(2, '0');
    svg += '<text x="' + (x + barW / 2) + '" y="' + (24 + barH * 0.8 + 12) + '" text-anchor="middle" fill="#475569" font-size="7" font-family="Sora,sans-serif">' + label + '</text>';
  });
  svg += '</svg>';
  var blob = new Blob([svg], {type: 'image/svg+xml'});
  window.open(URL.createObjectURL(blob), '_blank');
  toast('Density heatmap opened');
}

/* ===== BATCH 266: EXERCISE SEARCH AND REPLACE ===== */
function searchReplaceExercise() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var exerciseMap = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) exerciseMap[ex.id] = ex.name;
  });
  var exList = Object.keys(exerciseMap);
  if (exList.length === 0) { toast('No exercises found'); return; }
  var promptText = 'Exercises in workout:\n';
  exList.forEach(function(id, i) { promptText += (i + 1) + '. ' + exerciseMap[id] + '\n'; });
  promptText += '\nEnter number to replace:';
  showInlinePrompt(promptText, function(val) {
    var idx = parseInt(val) - 1;
    if (isNaN(idx) || idx < 0 || idx >= exList.length) { toast('Invalid selection'); return; }
    var oldId = exList[idx];
    var oldEx = getExercise(oldId);
    var samePattern = EXERCISES.filter(function(e) { return e.pattern === oldEx.pattern && e.id !== oldId; });
    if (samePattern.length === 0) { toast('No alternatives for ' + oldEx.pattern); return; }
    var replaceText = 'Replace ' + oldEx.name + ' with:\n';
    samePattern.forEach(function(e, i) { replaceText += (i + 1) + '. ' + e.name + ' (S' + e.stage + ')\n'; });
    showInlinePrompt(replaceText, function(val2) {
      var rIdx = parseInt(val2) - 1;
      if (isNaN(rIdx) || rIdx < 0 || rIdx >= samePattern.length) { toast('Invalid selection'); return; }
      var newEx = samePattern[rIdx];
      pushUndo();
      var count = 0;
      clips.forEach(function(c) {
        if (c.dataset.exerciseId === oldId) {
          if (c.classList.contains('clip-locked')) return;
          c.dataset.exerciseId = newEx.id;
          var nameEl = c.querySelector('.clip-name');
          if (nameEl) nameEl.textContent = newEx.name;
          var dots = c.querySelector('.clip-stage-dots');
          if (dots) {
            dots.innerHTML = '';
            for (var d = 1; d <= 3; d++) {
              var dot = document.createElement('span');
              dot.style.cssText = 'width:3px;height:3px;border-radius:50%;background:' + (d <= newEx.stage ? 'var(--accent-cyan)' : 'rgba(255,255,255,0.15)');
              dots.appendChild(dot);
            }
          }
          count++;
        }
      });
      updateStats(); saveSession(); sfx('click');
      toast('Replaced ' + count + ' clips: ' + oldEx.name + ' -> ' + newEx.name);
    });
  });
}

/* ===== BATCH 267: PROGRESSIVE RPE ===== */
function progressiveRPE(direction) {
  var clips = Array.from(document.querySelectorAll('.clip'));
  if (clips.length < 2) { toast('Need 2+ clips'); return; }
  pushUndo();
  clips.sort(function(a, b) { return parseInt(a.style.left) - parseInt(b.style.left); });
  var startRPE = direction === 'ascending' ? 4 : 9;
  var endRPE = direction === 'ascending' ? 9 : 4;
  var count = 0;
  clips.forEach(function(c, i) {
    if (c.classList.contains('clip-locked')) return;
    var rpe = Math.round(startRPE + (endRPE - startRPE) * (i / Math.max(1, clips.length - 1)));
    c.dataset.rpe = String(rpe);
    var badge = c.querySelector('.clip-rpe-badge');
    if (badge) badge.textContent = rpe;
    updateClipDNA(c);
    count++;
  });
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips set to ' + direction + ' RPE (' + startRPE + '->' + endRPE + ')');
}

/* ===== BATCH 268: CIRCUIT MODE ===== */
function arrangeAsCircuit() {
  var sel = Array.from(document.querySelectorAll('.clip.selected'));
  if (sel.length < 2) {
    sel = Array.from(document.querySelectorAll('.clip'));
  }
  if (sel.length < 2) { toast('Need 2+ clips for circuit'); return; }
  pushUndo();
  var ho = 100;
  var beatPx = Math.round((60 / bpm) * (80 / 15));
  var clipW = beatPx * 4;
  var gap = 4;
  var byTrack = {};
  sel.forEach(function(c) {
    var tid = c.parentElement.dataset.track;
    if (!byTrack[tid]) byTrack[tid] = [];
    byTrack[tid].push(c);
  });
  var trackIds = Object.keys(byTrack);
  if (trackIds.length < 2) { toast('Need clips on 2+ tracks for circuit'); return; }
  var maxRounds = 0;
  trackIds.forEach(function(tid) {
    if (byTrack[tid].length > maxRounds) maxRounds = byTrack[tid].length;
  });
  var xPos = ho;
  var count = 0;
  for (var round = 0; round < maxRounds; round++) {
    trackIds.forEach(function(tid) {
      if (round < byTrack[tid].length) {
        var c = byTrack[tid][round];
        if (c.classList.contains('clip-locked')) return;
        c.style.left = xPos + 'px';
        c.style.width = clipW + 'px';
        xPos += clipW + gap;
        count++;
      }
    });
    xPos += beatPx * 2;
  }
  updateStats(); saveSession(); sfx('click');
  toast(count + ' clips arranged in circuit (' + maxRounds + ' rounds)');
}

/* ===== BATCH 269: TIME UNDER TENSION CALCULATOR ===== */
function showTUT() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips'); return; }
  var totalTUT = 0;
  var perExercise = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (!ex) return;
    var sets = parseInt(c.dataset.sets) || 3;
    var reps = parseInt(c.dataset.reps) || 8;
    var tempo = parseFloat(c.dataset.tempo) || 3;
    var tut = sets * reps * tempo;
    totalTUT += tut;
    if (!perExercise[ex.name]) perExercise[ex.name] = 0;
    perExercise[ex.name] += tut;
  });
  var sorted = Object.keys(perExercise).sort(function(a, b) { return perExercise[b] - perExercise[a]; });
  var msg = 'Time Under Tension\n';
  msg += 'Total: ' + Math.round(totalTUT) + 's (' + (totalTUT / 60).toFixed(1) + ' min)\n\n';
  sorted.forEach(function(name, i) {
    msg += (i + 1) + '. ' + name + ': ' + Math.round(perExercise[name]) + 's\n';
  });
  toast(msg);
}

/* ===== BATCH 270: ENHANCED CLIP INFO TOOLTIP ===== */
function showClipDetail(clipEl) {
  var ex = getExercise(clipEl.dataset.exerciseId);
  if (!ex) return;
  var sets = clipEl.dataset.sets || '3';
  var reps = clipEl.dataset.reps || '8';
  var tempo = clipEl.dataset.tempo || '3';
  var rest = clipEl.dataset.rest || '60';
  var rpe = clipEl.dataset.rpe || '7';
  var tut = parseInt(sets) * parseInt(reps) * parseFloat(tempo);
  var info = ex.name + ' (S' + ex.stage + ')';
  info += '\n' + ex.pattern + ' | ' + ex.discipline;
  info += '\n' + sets + 'x' + reps + ' @ ' + tempo + 's | Rest ' + rest + 's | RPE ' + rpe;
  info += '\nTUT: ' + Math.round(tut) + 's';
  if (clipEl.dataset.notes) info += '\nNote: ' + clipEl.dataset.notes.substring(0, 50);
  if (clipEl.dataset.locked === '1') info += '\n[LOCKED]';
  clipEl.title = info;
}

/* ===== BATCH 271: WORKOUT RATING ===== */
var _workoutRating = 0;
function rateWorkout() {
  showInlinePrompt('Rate this workout (1-5 stars):', function(val) {
    var rating = parseInt(val);
    if (isNaN(rating) || rating < 1 || rating > 5) { toast('Enter 1-5'); return; }
    _workoutRating = rating;
    var stars = '';
    for (var i = 0; i < 5; i++) stars += i < rating ? '\u2605' : '\u2606';
    try {
      var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
      ratings.push({
        name: workoutName || 'Untitled',
        rating: rating,
        date: new Date().toISOString(),
        clips: document.querySelectorAll('.clip').length,
        bpm: bpm
      });
      if (ratings.length > 50) ratings = ratings.slice(-50);
      localStorage.setItem('sms_ratings', JSON.stringify(ratings));
    } catch(e) {}
    toast(stars + ' (' + rating + '/5) rated');
  });
}
function showRatingHistory() {
  try {
    var ratings = JSON.parse(localStorage.getItem('sms_ratings') || '[]');
    if (ratings.length === 0) { toast('No ratings yet'); return; }
    var msg = 'Workout Ratings:\n';
    ratings.slice(-10).reverse().forEach(function(r, i) {
      var stars = '';
      for (var s = 0; s < 5; s++) stars += s < r.rating ? '\u2605' : '\u2606';
      msg += (i + 1) + '. ' + stars + ' ' + r.name + ' (' + new Date(r.date).toLocaleDateString() + ')\n';
    });
    toast(msg);
  } catch(e) { toast('Error loading ratings'); }
}

/* ===== BATCH 272: EXERCISE SUBSTITUTION TABLE ===== */
function showSubstitutions() {
  if (!selectedClip) { toast('Select a clip first'); return; }
  var ex = getExercise(selectedClip.dataset.exerciseId);
  if (!ex) return;
  var samePattern = EXERCISES.filter(function(e) { return e.pattern === ex.pattern && e.id !== ex.id; });
  var sameFamily = EXERCISES.filter(function(e) { return e.family === ex.family && e.id !== ex.id && e.pattern !== ex.pattern; });
  var msg = 'Substitutions for ' + ex.name + ' (S' + ex.stage + ', ' + ex.pattern + ')\n\n';
  if (samePattern.length > 0) {
    msg += 'Same Pattern (' + ex.pattern + '):\n';
    samePattern.forEach(function(e) { msg += '  S' + e.stage + ' ' + e.name + ' [' + e.discipline + ']\n'; });
  }
  if (sameFamily.length > 0) {
    msg += '\nSame Family (' + ex.family + '):\n';
    sameFamily.slice(0, 8).forEach(function(e) { msg += '  S' + e.stage + ' ' + e.name + ' [' + e.pattern + ']\n'; });
  }
  if (samePattern.length === 0 && sameFamily.length === 0) msg += 'No substitutions available';
  toast(msg);
}

/* ===== BATCH 273: UNDO HISTORY VIEWER ===== */
function showUndoHistory() {
  var msg = 'Undo Stack: ' + undoStack.length + '/' + maxUndo + ' states\n';
  msg += 'Redo Stack: ' + redoStack.length + ' states\n\n';
  if (undoStack.length > 0) {
    msg += 'Recent undo states:\n';
    var recent = undoStack.slice(-5);
    recent.forEach(function(stateStr, i) {
      try {
        var state = JSON.parse(stateStr);
        msg += (undoStack.length - recent.length + i + 1) + '. ' + state.clips.length + ' clips, BPM ' + state.bpm + '\n';
      } catch(e) { msg += (i + 1) + '. [parse error]\n'; }
    });
  } else {
    msg += 'No undo states available';
  }
  toast(msg);
}

function selectClipsByStage(stage) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex && ex.stage === stage) { c.classList.add('selected'); count++; }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' Stage ' + stage + ' clip' + (count !== 1 ? 's' : '') + ' selected');
}

function selectClipsByFamily(family) {
  document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
  var count = 0;
  document.querySelectorAll('.clip').forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex && ex.family === family) { c.classList.add('selected'); count++; }
  });
  if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
  toast(count + ' ' + family + ' clip' + (count !== 1 ? 's' : '') + ' selected');
}

function toggleGridLines() {
  var tracks = document.querySelectorAll('.track-content');
  var hidden = tracks[0] && tracks[0].classList.contains('grid-hidden');
  tracks.forEach(function(t) { t.classList.toggle('grid-hidden', !hidden); });
  toast(hidden ? 'Grid lines shown' : 'Grid lines hidden');
}

function showWorkoutStats() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('No clips in workout'); return; }
  var exercises = {};
  var families = {};
  var totalSets = 0;
  var totalReps = 0;
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) {
      exercises[ex.name] = true;
      families[ex.family] = (families[ex.family] || 0) + 1;
    }
    totalSets += parseInt(c.dataset.sets) || 3;
    totalReps += parseInt(c.dataset.reps) || 8;
  });
  var exCount = Object.keys(exercises).length;
  var famList = Object.keys(families).sort(function(a, b) { return families[b] - families[a]; });
  toast(clips.length + ' clips, ' + exCount + ' exercises, ' + totalSets + ' sets, ' + totalReps + ' reps | ' + famList.join(', '));
}

function autoNameWorkout() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length === 0) { toast('Add clips first'); return; }
  var famCounts = {};
  clips.forEach(function(c) {
    var ex = getExercise(c.dataset.exerciseId);
    if (ex) famCounts[ex.family] = (famCounts[ex.family] || 0) + 1;
  });
  var dominant = '';
  var maxCount = 0;
  Object.keys(famCounts).forEach(function(f) {
    if (famCounts[f] > maxCount) { maxCount = famCounts[f]; dominant = f; }
  });
  var mode = document.getElementById('bpm-mode').textContent;
  var name = dominant + ' ' + mode + ' (' + clips.length + ' exercises)';
  setWorkoutName(name);
  saveSession();
  toast('Named: ' + name);
}

/* ===== CLIP GROUPS — Cmd+G to group, Cmd+Shift+G to ungroup ===== */
var _groupCounter = 0;
function groupSelectedClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length < 2) { toast('Select 2+ clips to group'); return; }
  pushUndo();
  _groupCounter++;
  var groupId = 'g' + _groupCounter;
  sel.forEach(function(c) {
    c.dataset.group = groupId;
    c.style.outline = '1px dashed rgba(59,130,246,0.3)';
  });
  saveSession();
  sfx('click');
  toast(sel.length + ' clips grouped (' + groupId + ')');
}

function ungroupSelectedClips() {
  var sel = document.querySelectorAll('.clip.selected');
  if (sel.length === 0 && selectedClip) sel = [selectedClip];
  if (sel.length === 0) { toast('Select a grouped clip first'); return; }
  pushUndo();
  var groups = {};
  sel.forEach(function(c) {
    if (c.dataset.group) groups[c.dataset.group] = true;
  });
  Object.keys(groups).forEach(function(gid) {
    document.querySelectorAll('.clip[data-group="'+gid+'"]').forEach(function(c) {
      delete c.dataset.group;
      c.style.outline = '';
    });
  });
  saveSession();
  sfx('click');
  toast('Ungrouped');
}

function getGroupSiblings(clip) {
  if (!clip.dataset.group) return [];
  return Array.from(document.querySelectorAll('.clip[data-group="'+clip.dataset.group+'"]'));
}

function resetSession() {
  pushUndo();
  document.querySelectorAll('.clip').forEach(function(c) { c.remove(); });
  selectedClip = null;
  document.getElementById('inspector').style.display = 'none';
  bpm = 120;
  document.getElementById('bpm-input').value = 120;
  updateBPMMode(); buildRuler();
  updateStats(); updateEmptyState();
  try { localStorage.removeItem('saturno-studio-session'); } catch(e) {}
  sfx('delete');
  toast('Session reset');
}

/* ===== SHORTCUTS OVERLAY ===== */
function toggleShortcuts() {
  var overlay = document.getElementById('shortcuts-overlay');
  overlay.classList.toggle('open');
}

/* ===== KEYBOARD SHORTCUTS ===== */
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
  if (e.code === 'Escape') {
    if (_timerOverlay) { stopWorkoutTimer(); return; }
    var sum = document.getElementById('summary-overlay');
    if (sum.classList.contains('open')) { closeSummary(); return; }
    var so = document.getElementById('shortcuts-overlay');
    if (so.classList.contains('open')) { so.classList.remove('open'); return; }
    // Deselect all clips first, then stop playback
    var hadSelection = document.querySelectorAll('.clip.selected').length > 0;
    if (hadSelection) {
      document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
      selectedClip = null;
      document.getElementById('inspector').style.display = 'none';
      if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
      return;
    }
    stopPlayback();
    closeSavedWorkouts();
  }
  if (e.key === '?' || e.code === 'Slash') {
    toggleShortcuts();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyZ') {
    e.preventDefault();
    if (e.shiftKey) { redo(); } else { undo(); }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyS') {
    e.preventDefault();
    saveSession(true);
    sfx('click');
    toast('Session saved');
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyK') {
    e.preventDefault();
    openCmdPalette();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyD') {
    e.preventDefault();
    duplicateTrackClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyG') {
    e.preventDefault();
    ungroupSelectedClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyG') {
    e.preventDefault();
    groupSelectedClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyC') {
    e.preventDefault();
    copyClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyV') {
    e.preventDefault();
    pasteAtPlayhead();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyV') {
    e.preventDefault();
    pasteClips();
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyD') {
    e.preventDefault();
    duplicateClip();
    return;
  }
  if (e.code === 'KeyB' && !e.metaKey && !e.ctrlKey) {
    splitClipAtPlayhead();
  }
  // Arrow keys to nudge selected clip position or resize
  if ((e.code === 'ArrowLeft' || e.code === 'ArrowRight') && selectedClip && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var pps = 80 / 15;
    var beatSec = 60 / bpm;
    if (e.altKey) {
      // Alt+Arrow: resize clip width
      pushUndo();
      var nudgeW = e.shiftKey ? (beatSec * 4 * pps) : (beatSec * pps);
      var curW = parseInt(selectedClip.style.width) || 80;
      if (e.code === 'ArrowLeft') curW = Math.max(20, curW - nudgeW);
      if (e.code === 'ArrowRight') curW = curW + nudgeW;
      selectedClip.style.width = Math.round(curW) + 'px';
      updateFadeOverlay(selectedClip);
    } else {
      // Arrow: nudge position (Shift = bar, plain = beat)
      pushUndo();
      var nudge = e.shiftKey ? (beatSec * 4 * pps) : (beatSec * pps);
      var allSelected = document.querySelectorAll('.clip.selected');
      if (allSelected.length > 1) {
        allSelected.forEach(function(c) {
          if (c.classList.contains('clip-locked')) return;
          var cl = parseInt(c.style.left) || 0;
          if (e.code === 'ArrowLeft') cl = Math.max(0, cl - nudge);
          else cl = cl + nudge;
          c.style.left = Math.round(cl) + 'px';
        });
      } else {
        var curLeft = parseInt(selectedClip.style.left);
        if (e.code === 'ArrowLeft') curLeft = Math.max(0, curLeft - nudge);
        if (e.code === 'ArrowRight') curLeft = curLeft + nudge;
        selectedClip.style.left = Math.round(curLeft) + 'px';
      }
    }
    saveSession(); updateStats();
  }
  // Left/Right without selected clip: scrub playhead
  if ((e.code === 'ArrowLeft' || e.code === 'ArrowRight') && !selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    var scrubSec = e.shiftKey ? (60 / bpm * 4) : (60 / bpm);
    if (e.code === 'ArrowLeft') currentTime = Math.max(0, currentTime - scrubSec);
    else currentTime = currentTime + scrubSec;
    updateTimeDisplay(); updatePlayheadPosition();
  }
  // Up/Down arrow: move clip between tracks
  // Shift+Up/Down: adjust RPE of selected clip
  if ((e.code === 'ArrowUp' || e.code === 'ArrowDown') && selectedClip && e.shiftKey && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    var curRpe = parseInt(selectedClip.dataset.rpe) || 7;
    var newRpe = e.code === 'ArrowUp' ? Math.min(10, curRpe + 1) : Math.max(1, curRpe - 1);
    selectedClip.dataset.rpe = newRpe;
    document.getElementById('insp-rpe').value = newRpe;
    var rpeBEl = selectedClip.querySelector('.clip-rpe-badge');
    if (rpeBEl) rpeBEl.textContent = newRpe;
    updateStats(); saveSession();
    toast('RPE: ' + newRpe);
    return;
  }
  if ((e.code === 'ArrowUp' || e.code === 'ArrowDown') && selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    e.preventDefault();
    var trackIds = ['push','pull','core','legs','skills'];
    var curTrackId = selectedClip.parentElement.dataset.track;
    var idx = trackIds.indexOf(curTrackId);
    if (idx === -1) return;
    var newIdx = e.code === 'ArrowUp' ? idx - 1 : idx + 1;
    if (newIdx < 0 || newIdx >= trackIds.length) return;
    pushUndo();
    var newTrack = document.querySelector('.track-content[data-track="'+trackIds[newIdx]+'"]');
    if (newTrack) {
      selectedClip.parentElement.removeChild(selectedClip);
      newTrack.appendChild(selectedClip);
      saveSession(); updateStats();
      toast('Moved to ' + trackIds[newIdx].charAt(0).toUpperCase() + trackIds[newIdx].slice(1));
    }
  }
  // Alt+Up/Down: duplicate clip to adjacent track
  if ((e.code === 'ArrowUp' || e.code === 'ArrowDown') && selectedClip && e.altKey && !e.metaKey && !e.ctrlKey && !e.shiftKey) {
    e.preventDefault();
    var trackIds = ['push','pull','core','legs','skills'];
    var curTrackId = selectedClip.parentElement.dataset.track;
    var idx = trackIds.indexOf(curTrackId);
    if (idx === -1) return;
    var newIdx = e.code === 'ArrowUp' ? idx - 1 : idx + 1;
    if (newIdx < 0 || newIdx >= trackIds.length) return;
    var ex = getExercise(selectedClip.dataset.exerciseId);
    if (!ex) return;
    pushUndo();
    var destTrack = document.querySelector('.track-content[data-track="'+trackIds[newIdx]+'"]');
    if (destTrack) {
      var dna = {
        sets: selectedClip.dataset.sets, reps: selectedClip.dataset.reps,
        tempo: selectedClip.dataset.tempo, rest: selectedClip.dataset.rest,
        rpe: selectedClip.dataset.rpe,
        fadeIn: selectedClip.dataset.fadeIn || '0', fadeOut: selectedClip.dataset.fadeOut || '0'
      };
      var dup = createClipElement(ex, parseInt(selectedClip.style.left), parseInt(selectedClip.style.width), dna);
      if (selectedClip.dataset.notes) dup.dataset.notes = selectedClip.dataset.notes;
      if (selectedClip.dataset.customColor) {
        dup.dataset.customColor = selectedClip.dataset.customColor;
        dup.style.background = selectedClip.style.background;
        dup.style.borderTopColor = selectedClip.style.borderTopColor;
      }
      destTrack.appendChild(dup);
      saveSession(); updateStats();
      toast('Duplicated to ' + trackIds[newIdx].charAt(0).toUpperCase() + trackIds[newIdx].slice(1));
    }
    return;
  }
  // [ and ] to nudge sets (Shift+[ ] for reps)
  if ((e.code === 'BracketLeft' || e.code === 'BracketRight') && selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    if (e.shiftKey) {
      var curReps = parseInt(selectedClip.dataset.reps) || 8;
      var newReps = e.code === 'BracketRight' ? Math.min(50, curReps + 1) : Math.max(1, curReps - 1);
      selectedClip.dataset.reps = newReps;
      var repsInput = document.getElementById('insp-reps');
      if (repsInput) repsInput.value = newReps;
      toast('Reps: ' + newReps);
    } else {
      var curSets = parseInt(selectedClip.dataset.sets) || 3;
      var newSets = e.code === 'BracketRight' ? Math.min(20, curSets + 1) : Math.max(1, curSets - 1);
      selectedClip.dataset.sets = newSets;
      var setsInput = document.getElementById('insp-sets');
      if (setsInput) setsInput.value = newSets;
      toast('Sets: ' + newSets);
    }
    updateClipInfo(selectedClip);
    updateStats(); saveSession();
    return;
  }
  // , and . to nudge tempo (Shift+, . for rest)
  if ((e.code === 'Comma' || e.code === 'Period') && selectedClip && !e.metaKey && !e.ctrlKey && !e.altKey) {
    e.preventDefault();
    if (e.shiftKey) {
      var curRest = parseInt(selectedClip.dataset.rest) || 60;
      var newRest = e.code === 'Period' ? Math.min(300, curRest + 5) : Math.max(0, curRest - 5);
      selectedClip.dataset.rest = newRest;
      var restInput = document.getElementById('insp-rest');
      if (restInput) restInput.value = newRest;
      toast('Rest: ' + newRest + 's');
    } else {
      var curTempo = parseFloat(selectedClip.dataset.tempo) || 3;
      var newTempo = e.code === 'Period' ? Math.min(10, +(curTempo + 0.5).toFixed(1)) : Math.max(0.5, +(curTempo - 0.5).toFixed(1));
      selectedClip.dataset.tempo = newTempo;
      var tempoInput = document.getElementById('insp-tempo');
      if (tempoInput) tempoInput.value = newTempo;
      toast('Tempo: ' + newTempo + 's');
    }
    updateClipInfo(selectedClip);
    updateStats(); saveSession();
    return;
  }
  if (e.code === 'KeyS' && !e.metaKey && !e.ctrlKey) {
    toggleSnap();
  }
  if (e.code === 'KeyJ' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    selectNextClip();
    return;
  }
  if (e.code === 'KeyK' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    selectPrevClip();
    return;
  }
  if (e.code === 'Slash' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    e.preventDefault();
    var libSearch = document.getElementById('lib-search');
    if (libSearch) libSearch.focus();
    return;
  }
  if (e.code === 'KeyC' && !e.metaKey && !e.ctrlKey && !e.altKey && e.shiftKey) {
    var allCollapsed = true;
    document.querySelectorAll('.track').forEach(function(t) { if (!t.classList.contains('track-collapsed') && t.dataset.track !== 'music') allCollapsed = false; });
    document.querySelectorAll('.track').forEach(function(t) { if (t.dataset.track !== 'music') t.classList.toggle('track-collapsed', !allCollapsed); });
    toast(allCollapsed ? 'All tracks expanded' : 'All tracks collapsed');
  }
  if (e.code === 'KeyC' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    var activeTrack = document.querySelector('.track.track-active');
    if (activeTrack) {
      activeTrack.classList.toggle('track-collapsed');
      toast(activeTrack.classList.contains('track-collapsed') ? 'Track collapsed' : 'Track expanded');
    }
  }
  // PageUp/PageDown: stage up/down selected clip exercise
  if ((e.code === 'PageUp' || e.code === 'PageDown') && selectedClip && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var curEx = getExercise(selectedClip.dataset.exerciseId);
    if (curEx) {
      var targetStage = e.code === 'PageUp' ? curEx.stage + 1 : curEx.stage - 1;
      var sibling = EXERCISES.filter(function(ex) { return ex.pattern === curEx.pattern && ex.stage === targetStage; })[0];
      if (sibling) {
        pushUndo();
        swapClipExercise(sibling.id);
        toast('Stage ' + targetStage + ': ' + sibling.name);
      } else {
        toast('No stage ' + targetStage + ' for this pattern');
      }
    }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyL') {
    e.preventDefault();
    if (selectedClip) {
      selectedClip.classList.toggle('clip-locked');
      selectedClip.dataset.locked = selectedClip.classList.contains('clip-locked') ? '1' : '';
      saveSession();
      toast(selectedClip.classList.contains('clip-locked') ? 'Clip locked' : 'Clip unlocked');
    }
    return;
  }
  if (e.code === 'KeyL' && !e.metaKey && !e.ctrlKey) {
    toggleLoop();
  }
  if (e.code === 'KeyM' && !e.metaKey && !e.ctrlKey) {
    addMarker();
  }
  if (e.code === 'KeyR' && !e.metaKey && !e.ctrlKey) {
    toggleRec();
  }
  if (e.code === 'KeyQ' && !e.metaKey && !e.ctrlKey) {
    quantizeClips();
  }
  if (e.code === 'KeyF' && !e.metaKey && !e.ctrlKey) {
    toggleFocusMode();
  }
  if (e.code === 'KeyT' && !e.metaKey && !e.ctrlKey) {
    tapTempo();
  }
  if (e.code === 'KeyN' && !e.metaKey && !e.ctrlKey) {
    if (markers.length === 0) { toast('No markers'); return; }
    var sorted = markers.slice().sort(function(a, b) { return a.time - b.time; });
    if (e.shiftKey) {
      // Previous marker
      var prev = null;
      for (var mi = sorted.length - 1; mi >= 0; mi--) {
        if (sorted[mi].time < currentTime - 0.1) { prev = sorted[mi]; break; }
      }
      if (prev) {
        currentTime = prev.time;
        updateTimeDisplay(); updatePlayheadPosition();
        toast('Marker: ' + prev.label);
      } else { toast('No previous marker'); }
    } else {
      // Next marker
      var next = null;
      for (var mi = 0; mi < sorted.length; mi++) {
        if (sorted[mi].time > currentTime + 0.1) { next = sorted[mi]; break; }
      }
      if (next) {
        currentTime = next.time;
        updateTimeDisplay(); updatePlayheadPosition();
        toast('Marker: ' + next.label);
      } else { toast('No next marker'); }
    }
    return;
  }
  if (e.code === 'Home' && !e.metaKey && !e.ctrlKey) {
    currentTime = 0;
    updateTimeDisplay(); updatePlayheadPosition();
    toast('Start');
    return;
  }
  if (e.code === 'End' && !e.metaKey && !e.ctrlKey) {
    var maxR = 0;
    document.querySelectorAll('.clip').forEach(function(c) {
      var r = (parseInt(c.style.left) + parseInt(c.style.width) - 100) / (80 / 15);
      if (r > maxR) maxR = r;
    });
    currentTime = Math.max(0, maxR);
    updateTimeDisplay(); updatePlayheadPosition();
    toast('End');
    return;
  }
  if (e.code === 'KeyG' && !e.metaKey && !e.ctrlKey) {
    generateRandom();
  }
  if (e.code === 'KeyP' && !e.metaKey && !e.ctrlKey) {
    togglePresets();
  }
  if (e.code === 'Equal' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomIn(); return;
  }
  if (e.code === 'Minus' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomOut(); return;
  }
  if (e.code === 'Digit0' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault(); zoomLevel = 100; applyZoom(); toast('Zoom reset: 100%'); return;
  }
  if (e.code === 'Digit0' && !e.metaKey && !e.ctrlKey && !e.altKey && !e.shiftKey) {
    currentTime = 0; updateTimeDisplay(); updatePlayheadPosition(); toast('Playhead: 0:00');
    return;
  }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    deleteSelectedClips();
  }
  // Select all clips with Cmd+A
  if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.code === 'KeyA') {
    e.preventDefault();
    var activeTrack = document.querySelector('.track.track-active .track-content');
    if (activeTrack) {
      document.querySelectorAll('.clip.selected').forEach(function(c) { c.classList.remove('selected'); });
      activeTrack.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
      if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
      toast('Track clips selected');
    }
    return;
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyA') {
    e.preventDefault();
    document.querySelectorAll('.clip').forEach(function(c) { c.classList.add('selected'); });
    if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
    toast('All clips selected');
  }
  if ((e.metaKey || e.ctrlKey) && e.code === 'KeyI') {
    e.preventDefault();
    document.querySelectorAll('.clip').forEach(function(c) { c.classList.toggle('selected'); });
    if (typeof updateSelectionBadge === 'function') updateSelectionBadge();
    toast('Selection inverted');
  }
  // Number keys 1-6 to select track (or record clip in rec mode)
  if (e.key >= '1' && e.key <= '6' && !e.metaKey && !e.ctrlKey && !e.altKey) {
    var trackIds = ['music','push','pull','core','legs','skills'];
    var idx = parseInt(e.key) - 1;
    if (idx < trackIds.length) {
      // Record mode: drop clip at playhead on numbered track
      if (isRecording && idx > 0) {
        var recTrack = document.querySelector('.track-content[data-track="'+trackIds[idx]+'"]');
        var recTrackDef = TRACKS.find(function(t) { return t.id === trackIds[idx]; });
        if (recTrack && recTrackDef) {
          var recEx = null;
          var recentForTrack = recentExercises.filter(function(rid) {
            var re = getExercise(rid);
            return re && re.family === recTrackDef.family;
          });
          if (recentForTrack.length > 0) {
            recEx = getExercise(recentForTrack[0]);
          } else {
            var recExercises = EXERCISES.filter(function(ex) { return ex.family === recTrackDef.family; });
            if (recExercises.length > 0) recEx = recExercises[Math.floor(Math.random() * recExercises.length)];
          }
          if (recEx) {
            var pps = 80 / 15;
            var recLeft = currentTime * pps;
            addClip(recTrack, recEx, recLeft);
            sfx('click');
          }
        }
      } else {
        document.querySelectorAll('.track.track-active').forEach(function(t) { t.classList.remove('track-active'); });
        var target = document.querySelector('.track[data-track="'+trackIds[idx]+'"]');
        if (target) {
          target.classList.add('track-active');
          toast('Track: ' + trackIds[idx].charAt(0).toUpperCase() + trackIds[idx].slice(1));
        }
      }
    }
  }
  // Tab to cycle through clips (sorted by track then left position)
  if (e.code === 'Tab' && !e.metaKey && !e.ctrlKey) {
    e.preventDefault();
    var trackOrder = ['push','pull','core','legs','skills'];
    var allClips = Array.from(document.querySelectorAll('.clip'));
    if (allClips.length === 0) return;
    allClips.sort(function(a, b) {
      var aT = trackOrder.indexOf(a.parentElement.dataset.track);
      var bT = trackOrder.indexOf(b.parentElement.dataset.track);
      if (aT !== bT) return aT - bT;
      return (parseInt(a.style.left) || 0) - (parseInt(b.style.left) || 0);
    });
    var currentIdx = selectedClip ? allClips.indexOf(selectedClip) : -1;
    var nextIdx = e.shiftKey ? (currentIdx - 1 + allClips.length) % allClips.length : (currentIdx + 1) % allClips.length;
    selectClipEl(allClips[nextIdx]);
    sfx('click');
  }
});

/* Autosave every 30 seconds */
setInterval(function() {
  var clips = document.querySelectorAll('.clip');
  if (clips.length > 0) saveSession();
}, 30000);

/* Footer shortcut hints rotation — like Ableton's status bar tips */
var HINT_LIST = [
  'Space = Play/Stop',
  'Cmd+K = Command Palette',
  'R = Toggle Record',
  'S = Toggle Snap',
  'T = Tap Tempo',
  'F = Focus Mode',
  'L = Loop Region',
  '1-6 = Select Track',
  'Tab = Next Clip',
  'Cmd+Z = Undo',
  'Cmd+S = Quick Save',
  'Cmd+E = Export',
  'Drag exercises from the library',
  '? = Keyboard Shortcuts',
  'M = Toggle Metronome',
  'G = Generate Random',
  'P = Load Preset',
  'Scroll wheel = Zoom timeline',
  'Backspace = Delete selected',
  'Cmd+A = Select all clips'
];
var hintIndex = 0;
var _hintOrder = [];
function shuffleHints() {
  _hintOrder = [];
  for (var i = 0; i < HINT_LIST.length; i++) _hintOrder.push(i);
  for (var j = _hintOrder.length - 1; j > 0; j--) {
    var k = Math.floor(Math.random() * (j + 1));
    var tmp = _hintOrder[j]; _hintOrder[j] = _hintOrder[k]; _hintOrder[k] = tmp;
  }
  hintIndex = 0;
}
shuffleHints();
function rotateHint() {
  var el = document.getElementById('footer-hint');
  if (!el) return;
  el.classList.add('fade');
  setTimeout(function() {
    hintIndex++;
    if (hintIndex >= _hintOrder.length) shuffleHints();
    el.textContent = HINT_LIST[_hintOrder[hintIndex]];
    el.classList.remove('fade');
  }, 300);
}
setInterval(rotateHint, 8000);

/* Selection badge — show count when multiple clips selected */
function updateSelectionBadge() {
  var count = document.querySelectorAll('.clip.selected').length;
  var badge = document.getElementById('selection-badge');
  if (badge) {
    if (count > 1) {
      var cntEl = document.getElementById('sel-count');
      var lblEl = document.getElementById('sel-label');
      if (cntEl) cntEl.textContent = count;
      if (lblEl) lblEl.textContent = 'clips';
      badge.classList.add('show');
    } else {
      badge.classList.remove('show');
    }
  }
  var footerSel = document.getElementById('footer-selection');
  if (footerSel) footerSel.textContent = count > 0 ? count + ' sel' : '';
}

/* Mixer section collapse toggle */
function toggleMixerSection(btn) {
  var body = btn.parentElement.querySelector('.mixer-section-body');
  if (!body) return;
  btn.classList.toggle('collapsed');
  body.classList.toggle('hidden');
  sfx('click');
}

/* Auto-scroll toggle — unified: syncs FOLLOW button + settings panel */
var SPEED_STEPS = [0.5, 0.75, 1, 1.25, 1.5, 2];
function cyclePlaybackSpeed() {
  var idx = SPEED_STEPS.indexOf(playbackSpeed);
  idx = (idx + 1) % SPEED_STEPS.length;
  playbackSpeed = SPEED_STEPS[idx];
  var btn = document.getElementById('speed-btn');
  if (btn) btn.textContent = playbackSpeed + 'x';
  if (btn) btn.classList.toggle('active', playbackSpeed !== 1);
  toast('Speed: ' + playbackSpeed + 'x');
}

function toggleAutoScrollFromTransport() {
  autoScrollEnabled = !autoScrollEnabled;
  syncAutoScrollUI();
  toast('Auto-scroll: ' + (autoScrollEnabled ? 'On' : 'Off'));
  sfx('click');
}
function syncAutoScrollUI() {
  var btn = document.getElementById('auto-scroll-btn');
  var stg = document.getElementById('settings-autoscroll');
  if (btn) btn.classList.toggle('active', autoScrollEnabled);
  if (stg) stg.textContent = autoScrollEnabled ? 'ON' : 'OFF';
}
document.addEventListener('DOMContentLoaded', function() {
  syncAutoScrollUI();
});

/* Panel resize — drag left panel border to resize */
document.addEventListener('DOMContentLoaded', function() {
  var handle = document.getElementById('panel-resize-left');
  var panel = document.querySelector('.panel-left');
  if (!handle || !panel) return;
  handle.addEventListener('mousedown', function(e) {
    e.preventDefault();
    handle.classList.add('dragging');
    var startX = e.clientX;
    var startW = panel.offsetWidth;
    function onMove(ev) {
      var newW = Math.max(140, Math.min(400, startW + (ev.clientX - startX)));
      panel.style.width = newW + 'px';
      document.querySelector('.main').style.gridTemplateColumns = newW + 'px 3px 1fr 280px';
    }
    function onUp() {
      handle.classList.remove('dragging');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
});

/* Session elapsed timer — shows how long studio has been open */
var sessionStartTime = Date.now();
setInterval(function() {
  var elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
  var h = Math.floor(elapsed / 3600);
  var m = Math.floor((elapsed % 3600) / 60);
  var s = elapsed % 60;
  var el = document.getElementById('session-timer');
  if (el) {
    el.textContent = h > 0
      ? h + ':' + m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0')
      : m + ':' + s.toString().padStart(2,'0');
  }
}, 1000);

/* Recently used exercises — track last 5 exercises dropped on timeline */
var recentExercises = [];
function addToRecent(exerciseId) {
  recentExercises = recentExercises.filter(function(id) { return id !== exerciseId; });
  recentExercises.unshift(exerciseId);
  if (recentExercises.length > 8) recentExercises.pop();
  updateRecentSection();
}
function updateRecentSection() {
  var container = document.getElementById('recent-exercises');
  if (!container) return;
  if (recentExercises.length === 0) {
    container.parentElement.style.display = 'none';
    return;
  }
  container.parentElement.style.display = '';
  var html = '';
  recentExercises.forEach(function(id) {
    var ex = getExercise(id);
    if (!ex) return;
    var fm = FAMILY_MAP[ex.family] || {color:'#666'};
    html += '<div class="movement-item" draggable="true" data-id="'+ex.id+'" style="border-left-color:'+fm.color+'40">';
    html += '<div class="mv-icon" style="background:'+fm.color+'22;color:'+fm.color+'">'+ex.name.charAt(0)+'</div>';
    html += '<span style="font-size:9px;color:var(--text-secondary)">'+ex.name+'</span>';
    html += '</div>';
  });
  container.innerHTML = html;
  // Re-init drag events on recent items
  container.querySelectorAll('.movement-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
      var ex = getExercise(item.dataset.id);
      if (!ex) return;
      e.dataTransfer.setData('text/plain', JSON.stringify(ex));
      item.style.opacity = '0.4';
      sfx('click');
    });
    item.addEventListener('dragend', function() { item.style.opacity = '1'; });
  });
}
</script>
</body>
</html>
